Alfred Workflow Collections
[AlfredWorkflow.com](http://AlfredWorkflow.com 'Alfred 2 Workflows List')
====
#### Search, Install and Share, No Need to Reinvent the Wheel.  -- (450+ added)
 ([Alfred 2] powerpack required)  
 
 **Now you can use [Workflow Searcher] to search workflows.**

[![Get Workflow Searcher](https://raw.github.com/hzlzh/AlfredWorkflow.com/master/index/css/images/downlaod-btn.png)](https://raw.github.com/hzlzh/Alfred-Workflows/master/Downloads/Workflow-Searcher.alfredworkflow)
 
Also you can `Fork` or `Star`this repo(`/Sources`) to get some inspiration in coding new workflows yourself.

## Workflows' JSON API (updated 2014.1.5) 

* **(Recommended)** API on Github:  
* [https://raw.github.com/hzlzh/AlfredWorkflow.com/master/workflow_api.json](https://raw.github.com/hzlzh/AlfredWorkflow.com/master/workflow_api.json)  
* *(for debug use)*API backup: [http://www.alfredworkflow.com/workflows-api/](http://www.alfredworkflow.com/workflows-api/)

-- API info --  

* Download Link by Author **=** `workflow_download_link`   
* **(Important!)** Backup download link on Github **=** `https://raw.github.com/hzlzh/AlfredWorkflow.com/master/Downloads/Workflows/` **+** `workflow_file`

*[PHP]demo:*

```php
<?php
    $json = file_get_contents( 'https://raw.github.com/hzlzh/AlfredWorkflow.com/master/workflow_api.json');
    $obj=json_decode($json);
    // var_dump($obj);
    foreach( $obj as $key => $item ){
        echo $item -> workflow_name;
    }
?>
```

## Repo path

    --- 
     |---- Downloads/             .alfredworkflow files for download mirror   
     |---- Sources/               source code(Learn from others' code)                 
     |---- index/                 part of index page

## Submit & Update your workflows

* Submit Alfred 2 Workflows -> [here](http://www.alfredworkflow.com/submit-alfred-workflow/)
* Update Your Workflows version -> [Github pull request](https://github.com/hzlzh/AlfredWorkflow.com/issues/6)
* Submit Alfred 2 Themes -> Commmming soon!

## Tips 

* You can share a workflow with link like this:  
`http://www.alfredworkflow.com/#Translation`  
`http://www.alfredworkflow.com/#Dev%20Doctor`

* If you want to update a workflow under `/Downloads`, just make a `pull request`
* More wiki on [submit page](http://www.alfredworkflow.com/submit-alfred-workflow/)

## License

Released under [MIT](http://rem.mit-license.org/)  LICENSE

[Alfred 2]: http://www.alfredapp.com/
[Workflow Searcher]: https://github.com/hzlzh/Alfred-Workflows/
 
PyAl: A Python Module for Alfred v2 Workflows
=============================================
PyAl is a Python module designed to automate a number of common and repetitive tasks in creating workflows for Alfred v2. In addition to handling the creation of feedback, the creation of cache files or folders, and similar tasks, PyAl bundles a number of handy modules that can be seamlessly and independently integrated into your workflow through PyAl. Though this project's pace of change is currently a little breakneck, demanding some attention from developers interested in integrating it into their own workflows, it is intended that the completed version will be virtually invisible, able to speed the development of workflows, improve their performance, and scale tall buildings in a single bound.

**Because this project is changing so quickly, please do not copy versions of PyAl from other developers' workflows.** You will only create more work for yourself---and less flow. The latest version of the module is available at <http://github.com/phyllisstein/PyAl>.


Features
--------
* A feedback class to which items can be added with a single line of code.
* A class providing easy access to the OS X Keychain.
* A simple, cached HTTP request class.
* Methods to return your bundle ID, the path to your cache folder, and the path to your storage folder.
* Spotlight search.
* A settings class to store and retrieve variables across sessions.


Usage
-----
To start using PyAl, simply paste the PyAl folder into your workflow's folder and add this line to the top of your code:

    import PyAl

### Methods
* `PyAl.bundle()`
    
    Reads your extension's bundle ID from its info.plist file and returns it.

* `PyAl.local([join=None])`

    Returns an absolute path to the current file's directory---usually your extension's absolute path.

* `PyAl.timestamp([format=None])`

    Returns a string with an alphabetically-sortable timestamp, or, optionally, a timestamp formatted with the format string
    passed as `format`.

* `PyAl.volatile([join=None])`

    Returns the path to the volatile (cache) folder for your extension, creating the directory if it does
    not already exist. If an argument is passed, returns the path to whatever is specified in the argument underneath
    the volatile folder; **however, it does not create this file or folder**. Once you have the joined path, you
    must do something with it.

* `PyAl.nonvolatile([join=None])`

    Returns the path to the nonvolatile (storage) folder for your extension, creating the directory if it does not
    already exist. If an argument is passed, returns the path to whatever is specified in the argument underneath the
    nonvolatile folder; **however, it does not create this file or folder**. Once you have the joined path, you must
    do something with it.

* `PyAl.readPlist(path)`

    Returns the unpacked root object, usually a dictionary, for the plist file at `path`. If `path` is not an absolute
    path (for instance, if you just pass a filename), tries to read from a file called `path` in the workflow's nonvolatile
    folder.

* `PyAl.writePlist(obj, path)`

    Writes an object to the plist file at `path`. If `path` is not an absolute path (for instance, if you just pass a
    filename), tries to write to a file called `path` in the workflow's nonvolatile folder.

* `PyAl.jsonLoad(path)`

    Returns the dictionary created by loading the JSON file at `path`. If `path` is not an absolute path (for instance, if
    you just pass a filename), tries to read from a file called `path` in the workflow's nonvolatile folder. If `path` does
    not exist, it is created with an empty dictionary which is then returned.

* `PyAl.jsonDump(obj, path)`

    Writes the object `obj` to the JSON file at `path`. If `path` is not an absolute path (for instance, if you just pass a
    filename), tries to write to a file called `path` in the workflow's nonvolatile folder.

* `PyAl.find(query)`

    Returns a list containing the results of a Spotlight search for `query`.


### Classes
#### Feedback
The `PyAl.Feedback` class simplifies and indeed largely automates the creation of feedback XML for Alfred. It has been largely rewritten after PyAl v0.1 to make creating feedback XML even more simple and Pythonic. Note that this has involved splitting the feedback design into two classes, `PyAl.Feedback` and `PyAl.Item`, the latter of which is described below.

* `PyAl.Feedback([items=None[, fixedOrder=False]])`

    Initializes the object. `items` can be either a single `Item` or a list of `Item`s, and will initialize the object with
    it or them already in place. If `fixedOrder` is set to `True`, the Feedback class will attempt to force Alfred to
    arrange your items in the order that they're created.

* `Feedback.add(items)`

    Adds a single `Item` or a list of `Item`s to the feedback object.

* `Feedback.get([index=None[, search=None]])`

    If `get()` is called without any arguments, returns the entire list of `Item`s currently stored in the object. Passing
    `index` will return the `Item` at `index`, and passing a string to `search` will look for `Item`s whose contents match
    the string and return any matches.

* `Feedback.pop([index=None[, search=None]])`

    Behaves just like `get()`, but removes the `Item`s it finds from the object's list. Useful if you want to modify an
    `Item` without generating duplicates.

* `Feedback.list(item, length)`

    Populates the object with `length` copies of the given `item`. **Caveat User:** It's not yet clear whether
    this will be of any use.

To return your feedback to Alfred, just pass your instance to `print` and he'll get the message.


### Item
This class makes creating items for feeding back to Alfred ludicrously simple. There are two ways to generate feedback items with this class. The first is to simply initialize it, passing values for the arguments you intend to use:

* `PyAl.Item(**kwargs)`

    Given a list of keywords and values for `**kwargs`, creates and returns an `Item` suitable for use with the `Feedback`
    class. Currently, the following keywords are understood:

    - `title`. A string setting the feedback item's `<title>` tag. Defaults to blank.
    - `subtitle`. A string setting the feedback item's `<subtitle>` tag. Defaults to blank.
    - `uid`. A string setting the feedback item's UID attribute. The bundle's ID will automatically be prepended. Defaults to the bundle ID.
    - `valid`. Sets the feedback item's "valid" attribute. Can be `True`, `False`, or a string (use `"yes"` or `"no"`).
    - `arg`. A string setting the feedback item's argument attribute, to be passed to the next stage of the workflow for valid items. Excluded from item attributes by default.
    - `autocomplete`. A string to which the feedback item will autocomplete on Tab (for valid items) or "Return" (for invalid items). Excluded from item attributes by default.
    - `icon`. A string setting the item's `<icon>` tag. By default, uses the `icon.png` in every workflow.
    - `fileIcon`. Setting this to `True` will cause Alfred to treat the value of `<icon>` as a path to a file or folder and use that file or folder's icon. Note the camel case.
    - `fileType`. Setting this to `True` will cause Alfred to treat the value of `<icon>` as a UTI (for example, `public.jpeg`) and use the icon assigned to it. Note the camel case.
    - `order`. If this is set to a number the feedback object was initialized with `fixedOrder=True`, an earnest attempt will be made to assign the feedback item to the specified position _among your feedback items_.

However, because this could potentially become cumbersome, the class has a second method to set up a feedback item: `Item.fromDictionary()`:

* `Item.fromDictionary(dictionary)`

    Behaves precisely like the initialization method. All of the keywords understood by `PyAl.Item()` can be used as
    keys in a dict whose values will be passed to the `Item` instance. Particularly useful when processing results in bulk:
    simply parse your results as a dictionary with some or all of the keys above and the values you intend to use.

`fromDictionary()` could be especially useful for quickly creating many items in a row: just set up a default dictionary in your code, change its values as needed, and keep passing it to the method.

Since creating many items in a row is a common task with Alfred feedback, this class has another method to simplify the process:

* `Item.copy()`

    Returns a copy of the instance of `Item`, which can then be modified as needed and passed back to a `Feedback` object.

There are also accessor methods to modify or check an `Item` instance's values. Except for `Item.icon()`, each takes one optional argument, which should be set to the intended value; if no argument is passed, each returns the current value for the variable.

* `Item.title([setTitle=None])`
* `Item.subtitle([setSubtitle=None])`
* `Item.uid([setUID=None])`
* `Item.valid([setValid=None])`
* `Item.autocomplete([setAutocomplete=None])`
* `Item.order([setOrder=None])`

The accessor method for the icon is similar, but takes two additional optional arguments: `fileIcon` and `fileType`. Setting either of these to `True` will cause Alfred to treat the icon value as a file from which to extract an icon or a UTI whose icon he should use.

* `Item.icon([setIcon=None[, fileIcon=False[, fileType=False]]])`

Finally, to get the entire contents of an `Item`, use the `Item.get()` method. It returns a dictionary formatted as follows:

    {
        "content":
        {
            "title": self._title,
            "subtitle": self._subtitle,
            "icon": self._icon,
            "fileIcon": self._fileIcon,
            "fileType": self._fileType
        }
        "attrib":
        {
            "uid": self._uid,
            "valid": self._valid
        }
    }

The `"attrib"` dictionary may also contain keys for `"autocomplete"` and `"arg"`, if set, and the root object may contain a key for `"order"`, if set. All of this is mostly useful for the internal interaction between `Item`s and `Feedback`s, but could have other uses as well.


### Request
The `PyAl.Request` class aims at similar simplification and automation, but this time of HTTP requests (via the `requests` module). It sets up an HTTP requests cache (with the `requests_cache` module) and passes the returned data to BeautifulSoup for your searching and parsing convenience (see [the BeautifulSoup docs](http://www.crummy.com/software/BeautifulSoup/bs4/doc/) for more information).

* `PyAl.Request(url[, payload=None[, post=False]])`

    Initializes the object by getting the data at `url`. `payload` may be set to a dictionary of keys and values to be
    passed as GET arguments to the URL, or, if `post` is set to `True`, as POST data. You can interact with the request by
    using the instance variable `myInstance.request`, and do anything with it
    [that `requests` allows](http://docs.pythonrequests.org/en/latest/user/quickstart/).

* `Request.souper()`

    Checks to see that the request was successful; if not, it raises an exception; if so, it returns a BeautifulSoup object
    for the request's text.

Note that if you do not need to make an HTTP request, you can delete the folder `PyAl/Request` and it will be transparently disabled without affecting the other classes or methods. This is in the interest of maintaining a svelte workflow bundle.


### Settings
`PyAl.Settings` smoothly and transparently loads and saves information to a stable settings file that will persist across instances of the script. It takes no arguments to instantiate, and defines three instance methods:

* `Settings.set(**kwargs)`

    Taking `kwargs`, which must be a list of `key=value` arguments, saves the key and value in memory and to a JSON-encoded
    settings file in the extension's nonvolatile folder.

* `Settings.get(k[, default=None])`

    Returns the currently-loaded value for the setting with key `k`. Returns `default` if no value is found for `k`.

* `Settings.delete(k)`

    Removes the setting with key `k` from memory and from the settings JSON file.


### Keychain
This class provides a simple interface to the OS X keychain. It is currently able to store, retrieve, modify, and delete password data. To use it, simply instantiate and use the methods below to manipulate the data.

* `PyAl.Keychain([service=None])`

    Instantiates a keychain object to access data for the service `service`---or, if nothing is passed for `service`, your
    extension's bundle ID.

* `Keychain.storePassword(account, password)`

    Stores a `password` for username `account` under the predefined service in the main keychain.

* `Keychain.retrievePassword(account)`

    Returns the password for the predefined service's `account`. Returns `None` if no password is found.

* `Keychain.modifyPassword(account, newPassword)`

    Changes the password for the predefined service's `account` to `newPassword`.

* `Keychain.deletePassword(account)`

    Deletes the saved password for the predefined service's `account`.


Help and Support
----------------
The [Alfred v2 forums](http://www.alfredforum.com) are a good place to look for answers, but you can also reach this package's maintenance man, [Daniel](http://daniel.sh), at d atsign daniel dot sh or on Twitter at [@phyllisstein](http://twitter.com/phyllisstein/).
botoworkflow
============

Boto Workflow for Alfred 2

# [Discount][] instructions #

This folder holds the files generated by discount's `configure.sh` script that are used by QLMarkdown.

## Upgrading discount ##

To upgrade discount run `./discount-config/update-discount.sh`
This script automates the steps oulined below:

1. Upgrade the discount repo
2. Generate dynamic configuration infotmation

## Manually upgrading discount ##

Discount is included as a [fake submodule][]. To upgrade or test other versions of discount, delete the files in the `discount` directory and clone a new local repository into it:

	rm -rf discount/
	git clone git://github.com/Orc/discount.git discount

The discount folder will contain a .git folder following the clone however this folder is not included in the enclosing repository and will not be propagated by a push or clone. 

## Config files ##

When discount is changed, regenerate the config files. The included `update.sh` script should do this automatically.

If you want to update the files by hand, remove the "configuration for markdown, generated" comments at the head of `config.h` to avoid adding needless patches to the git history.

[discount]:https://github.com/Orc/discount
[fake submodule]:http://debuggable.com/posts/git-fake-submodules:4b563ee4-f3cc-4061-967e-0e48cbdd56cb

Alfred 2 Workflow for Dropbox
=============================

Uses the Alfred 2 Ruby Framework


License
=======

CCBY - Creative Commons Attribution 2.0 Generic
http://creativecommons.org/licenses/by/2.0/
=======

Dropbox::API - Dropbox Ruby API client
=========

A Ruby client for the DropBox REST API.

Goal:

To deliver a more Rubyesque experience when using the DropBox API.

Current state:

First release, whole API covered.

Important!!!
------------

From version 0.2.0, Dropbox::API::File#delete and Dropbox::API::Dir#delete *are gone*!!

The reason is that it's based on Hashie::Mash and was screwing Hash#delete.

It is replaced with Dropbox::API::File#destroy and Dropbox::API::Dir#destroy.

Installation
------------

Dropbox::API is available on RubyGems, so:

```
gem install dropbox-api
```

Or in your Gemfile:

```ruby
gem "dropbox-api"
```

Configuration
-------------

In order to use this client, you need to have an app created on https://www.dropbox.com/developers/apps.

Once you have it, put this configuration somewhere in your code, before you start working with the client.

```ruby
Dropbox::API::Config.app_key    = YOUR_APP_TOKEN
Dropbox::API::Config.app_secret = YOUR_APP_SECRET
Dropbox::API::Config.mode       = "sandbox" # if you have a single-directory app or "dropbox" if it has access to the whole dropbox
```

Dropbox::API::Client
--------------------

The client is the base for all communication with the API and wraps around almost all calls
available in the API.

In order to create a Dropbox::API::Client object, you need to have the configuration set up for OAuth.
Second thing you need is to have the user authorize your app using OAuth. Here's a short intro
on how to do this:

```ruby
consumer = Dropbox::API::OAuth.consumer(:authorize)
request_token = consumer.get_request_token
request_token.authorize_url(:oauth_callback => 'http://yoursite.com/callback')
# Here the user goes to Dropbox, authorizes the app and is redirected
# The oauth_token will be available in the params
request_token.get_access_token(:oauth_verifier => oauth_token)
```

Now that you have the oauth token and secret, you can create a new instance of the Dropbox::API::Client, like this:

```ruby
client = Dropbox::API::Client.new :token => token, :secret => secret
```

Rake-based authorization
------------------------

Dropbox::API supplies you with a helper rake which will authorize a single client. This is useful for development and testing.

In order to have this rake available, put this on your Rakefile:

```ruby
require "dropbox-api/tasks"
Dropbox::API::Tasks.install
```

You will notice that you have a new rake task - dropbox:authorize

When you call this Rake task, it will ask you to provide the consumer key and secret. Afterwards it will present you with an authorize url on Dropbox.

Simply go to that url, authorize the app, then press enter in the console.

The rake task will output valid ruby code which you can use to create a client.

What differs this from the DropBox Ruby SDK?
--------------------------------------------

A few things:

* It's using the ruby oauth gem, instead of reinventing the wheel and implementing OAuth communication
* It treats files and directories as Ruby objects with appropriate classes, on which you can perform operations

Consider the following example which takes all files with names like 'test.txt' and copies them with a suffix '.old'

This is how it would look using the SDK:

```ruby
# Because you need the session with the right access token, you need to create one instance per user
@session = DropboxSession.new(APP_TOKEN, APP_SECRET)
@session.set_access_token(ACCESS_TOKEN, ACCESS_SECRET)
@client = DropboxClient.new(@session, :app_folder)
# The result is a hash, so we need to call a method on the client, supplying the right key from the hash
@client.search('/', 'test.txt').each do |hash|
  @client.file_copy(hash['path'], hash['path'] + ".old")
end
```

With Dropbox::API, you can clean it up, first you put the app token and secret in a config or initializer file:

```ruby
Dropbox::API::Config.app_key    = APP_TOKEN
Dropbox::API::Config.app_secret = APP_SECRET
```

And when you want to use it, just create a new client object with a specific access token and secret:

```ruby
# The app token and secret are read from config, that's all you need to have a client ready for one user
@client = Dropbox::API::Client.new(:token  => ACCESS_TOKEN, :secret => ACCESS_SECRET)
# The file is a Dropbox::API::File object, so you can call methods on it!
@client.search('test.txt').each do |file|
  file.copy(file.path + ".old2")
end
```

What differs this from the dropbox gem?
--------------------------------------

Dropbox::API does not extend the Ruby primitives, like the dropbox gem:

https://github.com/RISCfuture/dropbox/tree/master/lib/dropbox/extensions

Dropbox::API::Client methods
----------------------------

### Dropbox::API::Client#account

Returns a simple object with information about the account:

```ruby
client.account # => #<Dropbox::API::Object>
```

For more info, see [https://www.dropbox.com/developers/reference/api#account-info](https://www.dropbox.com/developers/reference/api#account-info)

### Dropbox::API::Client#find

When provided a path, returns a single file or directory

```ruby
client.find 'file.txt' # => #<Dropbox::API::File>
```

### Dropbox::API::Client#ls

When provided a path, returns a list of files or directories within that path

By default it's the root path:

```ruby
client.ls # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

But you can provide your own path:

```ruby
client.ls 'somedir' # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

### Dropbox::API::Client#mkdir

Creates a new directory and returns a Dropbox::API::Dir object

```ruby
client.mkdir 'new_dir' # => #<Dropbox::API::Dir>
```

### Dropbox::API::Client#upload

Stores a file with a provided body under a provided name and returns a Dropbox::API::File object

```ruby
client.upload 'file.txt', 'file body' # => #<Dropbox::API::File>
```

### Dropbox::API::Client#download

Downloads a file with a provided name and returns it's content

```ruby
client.download 'file.txt' # => 'file body'
```

### Dropbox::API::Client#search

When provided a pattern, returns a list of files or directories within that path

Be default is searches the root path:

```ruby
client.search 'pattern' # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

However, you can specify your own path:

```ruby
client.search 'pattern', :path => 'somedir' # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

### Dropbox::API::Client#delta

Returns a cursor and a list of files that have changed since the cursor was generated.

```ruby
delta = client.delta 'abc123'
delta.cursor # => 'def456'
delta.entries # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

When called without a cursor, it returns all the files.

```ruby
delta = client.delta 'abc123'
delta.cursor # => 'abc123'
delta.entries # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

Dropbox::API::File and Dropbox::API::Dir methods
----------------------------

These methods are shared by Dropbox::API::File and Dropbox::API::Dir

### Dropbox::API::File#copy | Dropbox::API::Dir#copy

Copies a file/directory to a new specified filename

```ruby
file.copy 'newfilename.txt' # => #<Dropbox::API::File>
```

### Dropbox::API::File#move | Dropbox::API::Dir#move

Moves a file/directory to a new specified filename

```ruby
file.move 'newfilename.txt' # => #<Dropbox::API::File>
```

### Dropbox::API::File#destroy | Dropbox::API::Dir#destroy

Deletes a file/directory

```ruby
file.destroy 'newfilename.txt' # => #<Dropbox::API::File>
```


Dropbox::API::File methods
----------------------------

### Dropbox::API::File#revisions

Returns an Array of Dropbox::API::File objects with appropriate rev attribute

For more info, see [https://www.dropbox.com/developers/reference/api#revisions](https://www.dropbox.com/developers/reference/api#revisions)

### Dropbox::API::File#restore

Restores a file to a specific revision

For more info, see [https://www.dropbox.com/developers/reference/api#restore](https://www.dropbox.com/developers/reference/api#restore)

### Dropbox::API::File#share_url

Returns the link to a file page in Dropbox

For more info, see [https://www.dropbox.com/developers/reference/api#shares](https://www.dropbox.com/developers/reference/api#shares)

### Dropbox::API::File#direct_url

Returns the link to a file in Dropbox

For more info, see [https://www.dropbox.com/developers/reference/api#media](https://www.dropbox.com/developers/reference/api#media)

### Dropbox::API::File#thumbnail

Returns the thumbnail for an image

For more info, see [https://www.dropbox.com/developers/reference/api#thumbnail](https://www.dropbox.com/developers/reference/api#thumbnail)

### Dropbox::API::File#download

Downloads a file and returns it's content

```ruby
file.download # => 'file body'
```

Dropbox::API::Dir methods
----------------------------

### Dropbox::API::Dir#ls

Returns a list of files or directorys within that directory

```ruby
dir.ls # => [#<Dropbox::API::File>, #<Dropbox::API::Dir>]
```

Testing
---------

In order to run tests, you need to have an application created and authorized. Put all tokens in spec/connection.yml and you're good to go.

Check out spec/connection.sample.yml for an example.

Copyright
---------

Copyright (c) 2011 Marcin Bunsch, Future Simple Inc. See LICENSE for details.

= Hashie

Hashie is a growing collection of tools that extend Hashes and make
them more useful.

== Installation

Hashie is available as a RubyGem:

    gem install hashie

== Mash

Mash is an extended Hash that gives simple pseudo-object functionality
that can be built from hashes and easily extended. It is designed to
be used in RESTful API libraries to provide easy object-like access
to JSON and XML parsed hashes.

=== Example:

    mash = Hashie::Mash.new
    mash.name? # => false
    mash.name # => nil
    mash.name = "My Mash"
    mash.name # => "My Mash"
    mash.name? # => true
    mash.inspect # => <Hashie::Mash name="My Mash">

    mash = Mash.new
    # use bang methods for multi-level assignment
    mash.author!.name = "Michael Bleigh"
    mash.author # => <Hashie::Mash name="Michael Bleigh">

<b>Note:</b> The <tt>?</tt> method will return false if a key has been set
to false or nil. In order to check if a key has been set at all, use the
<tt>mash.key?('some_key')</tt> method instead.

== Dash

Dash is an extended Hash that has a discrete set of defined properties
and only those properties may be set on the hash. Additionally, you
can set defaults for each property. You can also flag a property as
required. Required properties will raise an execption if unset.

=== Example:

    class Person < Hashie::Dash
      property :name, :required => true
      property :email
      property :occupation, :default => 'Rubyist'
    end

    p = Person.new # => ArgumentError: The property 'name' is required for this Dash.

    p = Person.new(:name => "Bob")
    p.name # => 'Bob'
    p.name = nil # => ArgumentError: The property 'name' is required for this Dash.
    p.email = 'abc@def.com'
    p.occupation   # => 'Rubyist'
    p.email        # => 'abc@def.com'
    p[:awesome]    # => NoMethodError
    p[:occupation] # => 'Rubyist'

== Trash

A Trash is a Dash that allows you to translate keys on initialization.
It is used like so:

    class Person < Hashie::Trash
      property :first_name, :from => :firstName
    end

This will automatically translate the <tt>firstName</tt> key to <tt>first_name</tt>
when it is initialized using a hash such as through:

    Person.new(:firstName => 'Bob')

== Clash

Clash is a Chainable Lazy Hash that allows you to easily construct
complex hashes using method notation chaining. This will allow you
to use a more action-oriented approach to building options hashes.

Essentially, a Clash is a generalized way to provide much of the same
kind of "chainability" that libraries like Arel or Rails 2.x's named_scopes
provide.

=== Example

    c = Hashie::Clash.new
    c.where(:abc => 'def').order(:created_at)
    c # => {:where => {:abc => 'def}, :order => :created_at}

    # You can also use bang notation to chain into sub-hashes,
    # jumping back up the chain with _end!
    c = Hashie::Clash.new
    c.where!.abc('def').ghi(123)._end!.order(:created_at)
    c # => {:where => {:abc => 'def', :ghi => 123}, :order => :created_at}

    # Multiple hashes are merged automatically
    c = Hashie::Clash.new
    c.where(:abc => 'def').where(:hgi => 123)
    c # => {:where => {:abc => 'def', :hgi => 123}}


== Note on Patches/Pull Requests

* Fork the project.
* Make your feature addition or bug fix.
* Add tests for it. This is important so I don't break it in a future version unintentionally.
* Commit, do not mess with rakefile, version, or history. (if you want to have your own version, that is fine but bump version in a commit by itself I can ignore when I pull)
* Send me a pull request. Bonus points for topic branches.

== Authors

* Michael Bleigh

== Copyright

Copyright (c) 2009 Intridea, Inc (http://intridea.com/). See LICENSE for details.

JSON-JRuby
==========

JSON-JRuby is a port of Florian Frank's native
[`json` library](http://json.rubyforge.org/) to JRuby.
It aims to be a perfect drop-in replacement for `json_pure`.


Development version
===================

The latest version is available from the
[Git repository](http://github.com/mernen/json-jruby/tree):

    git clone git://github.com/mernen/json-jruby.git


Compiling
=========

You'll need JRuby version 1.2 or greater to build JSON-JRuby.
Its path must be set on the `jruby.dir` property of
`nbproject/project.properties` (defaults to `../jruby`).

Additionally, you'll need [Ant](http://ant.apache.org/), and
[Ragel](http://www.cs.queensu.ca/~thurston/ragel/) 6.4 or greater.

Then, from the folder where the sources are located, type:

    ant clean jar

to clean any leftovers from previous builds and generate the `.jar` files.
To generate a RubyGem, specify the `gem` action rather than `jar`.

= JSON implementation for Ruby {<img src="https://secure.travis-ci.org/flori/json.png" />}[http://travis-ci.org/flori/json]

== Description

This is a implementation of the JSON specification according to RFC 4627
http://www.ietf.org/rfc/rfc4627.txt . Starting from version 1.0.0 on there
will be two variants available:

* A pure ruby variant, that relies on the iconv and the stringscan
  extensions, which are both part of the ruby standard library.
* The quite a bit faster C extension variant, which is in parts implemented
  in C and comes with its own unicode conversion functions and a parser
  generated by the ragel state machine compiler
  http://www.cs.queensu.ca/~thurston/ragel .

Both variants of the JSON generator generate UTF-8 character sequences by
default. If an :ascii_only option with a true value is given, they escape all
non-ASCII and control characters with \uXXXX escape sequences, and support
UTF-16 surrogate pairs in order to be able to generate the whole range of
unicode code points.

All strings, that are to be encoded as JSON strings, should be UTF-8 byte
sequences on the Ruby side. To encode raw binary strings, that aren't UTF-8
encoded, please use the to_json_raw_object method of String (which produces
an object, that contains a byte array) and decode the result on the receiving
endpoint.

The JSON parsers can parse UTF-8, UTF-16BE, UTF-16LE, UTF-32BE, and UTF-32LE
JSON documents under Ruby 1.8. Under Ruby 1.9 they take advantage of Ruby's
M17n features and can parse all documents which have the correct
String#encoding set. If a document string has ASCII-8BIT as an encoding the
parser attempts to figure out which of the UTF encodings from above it is and
trys to parse it.

== Installation

It's recommended to use the extension variant of JSON, because it's faster than
the pure ruby variant. If you cannot build it on your system, you can settle
for the latter.

Just type into the command line as root:

  # rake install

The above command will build the extensions and install them on your system.

  # rake install_pure

or

  # ruby install.rb

will just install the pure ruby implementation of JSON.

If you use Rubygems you can type

  # gem install json

instead, to install the newest JSON version.

There is also a pure ruby json only variant of the gem, that can be installed
with:

  # gem install json_pure

== Compiling the extensions yourself

If you want to build the extensions yourself you need rake:

  You can get it from rubyforge:
    http://rubyforge.org/projects/rake

  or just type

  # gem install rake

  for the installation via rubygems.

If you want to create the parser.c file from its parser.rl file or draw nice
graphviz images of the state machines, you need ragel from: http://www.cs.queensu.ca/~thurston/ragel


== Usage

To use JSON you can
  require 'json'
to load the installed variant (either the extension 'json' or the pure
variant 'json_pure'). If you have installed the extension variant, you can
pick either the extension variant or the pure variant by typing
  require 'json/ext'
or
  require 'json/pure'

Now you can parse a JSON document into a ruby data structure by calling

  JSON.parse(document)

If you want to generate a JSON document from a ruby data structure call
  JSON.generate(data)

You can also use the pretty_generate method (which formats the output more
verbosely and nicely) or fast_generate (which doesn't do any of the security
checks generate performs, e. g. nesting deepness checks).

To create a valid JSON document you have to make sure, that the output is
embedded in either a JSON array [] or a JSON object {}. The easiest way to do
this, is by putting your values in a Ruby Array or Hash instance.

There are also the JSON and JSON[] methods which use parse on a String or
generate a JSON document from an array or hash:

  document = JSON 'test'  => 23 # => "{\"test\":23}"
  document = JSON['test'] => 23 # => "{\"test\":23}"

and

  data = JSON '{"test":23}'  # => {"test"=>23}
  data = JSON['{"test":23}'] # => {"test"=>23}

You can choose to load a set of common additions to ruby core's objects if
you
  require 'json/add/core'

After requiring this you can, e. g., serialise/deserialise Ruby ranges:

  JSON JSON(1..10) # => 1..10

To find out how to add JSON support to other or your own classes, read the
section "More Examples" below.

To get the best compatibility to rails' JSON implementation, you can
  require 'json/add/rails'

Both of the additions attempt to require 'json' (like above) first, if it has
not been required yet.

== More Examples

To create a JSON document from a ruby data structure, you can call
JSON.generate like that:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,\"4..10\"]"

To get back a ruby data structure from a JSON document, you have to call
JSON.parse on it:

 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, "4..10"]

Note, that the range from the original data structure is a simple
string now. The reason for this is, that JSON doesn't support ranges
or arbitrary classes. In this case the json library falls back to call
Object#to_json, which is the same as #to_s.to_json.

It's possible to add JSON support serialization to arbitrary classes by
simply implementing a more specialized version of the #to_json method, that
should return a JSON object (a hash converted to JSON with #to_json) like
this (don't forget the *a for all the arguments):

 class Range
   def to_json(*a)
     {
       'json_class'   => self.class.name, # = 'Range'
       'data'         => [ first, last, exclude_end? ]
     }.to_json(*a)
   end
 end

The hash key 'json_class' is the class, that will be asked to deserialise the
JSON representation later. In this case it's 'Range', but any namespace of
the form 'A::B' or '::A::B' will do. All other keys are arbitrary and can be
used to store the necessary data to configure the object to be deserialised.

If a the key 'json_class' is found in a JSON object, the JSON parser checks
if the given class responds to the json_create class method. If so, it is
called with the JSON object converted to a Ruby hash. So a range can
be deserialised by implementing Range.json_create like this:

 class Range
   def self.json_create(o)
     new(*o['data'])
   end
 end

Now it possible to serialise/deserialise ranges as well:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,{\"json_class\":\"Range\",\"data\":[4,10,false]}]"
 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, 4..10]

JSON.generate always creates the shortest possible string representation of a
ruby data structure in one line. This is good for data storage or network
protocols, but not so good for humans to read. Fortunately there's also
JSON.pretty_generate (or JSON.pretty_generate) that creates a more readable
output:

 puts JSON.pretty_generate([1, 2, {"a"=>3.141}, false, true, nil, 4..10])
 [
   1,
   2,
   {
     "a": 3.141
   },
   false,
   true,
   null,
   {
     "json_class": "Range",
     "data": [
       4,
       10,
       false
     ]
   }
 ]

There are also the methods Kernel#j for generate, and Kernel#jj for
pretty_generate output to the console, that work analogous to Core Ruby's p and
the pp library's pp methods.

The script tools/server.rb contains a small example if you want to test, how
receiving a JSON object from a webrick server in your browser with the
javasript prototype library http://www.prototypejs.org works.

== Speed Comparisons

I have created some benchmark results (see the benchmarks/data-p4-3Ghz
subdir of the package) for the JSON-parser to estimate the speed up in the C
extension:

 Comparing times (call_time_mean):
  1 ParserBenchmarkExt#parser   900 repeats:
        553.922304770 (  real) ->   21.500x 
          0.001805307
  2 ParserBenchmarkYAML#parser  1000 repeats:
        224.513358139 (  real) ->    8.714x 
          0.004454078
  3 ParserBenchmarkPure#parser  1000 repeats:
         26.755020642 (  real) ->    1.038x 
          0.037376163
  4 ParserBenchmarkRails#parser 1000 repeats:
         25.763381731 (  real) ->    1.000x 
          0.038814780
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1 is JSON::Ext::Parser, 2 is YAML.load with YAML
compatbile JSON document, 3 is is JSON::Pure::Parser, and 4 is
ActiveSupport::JSON.decode. The ActiveSupport JSON-decoder converts the
input first to YAML and then uses the YAML-parser, the conversion seems to
slow it down so much that it is only as fast as the JSON::Pure::Parser!

If you look at the benchmark data you can see that this is mostly caused by
the frequent high outliers - the median of the Rails-parser runs is still
overall smaller than the median of the JSON::Pure::Parser runs:

 Comparing times (call_time_median):
  1 ParserBenchmarkExt#parser   900 repeats:
        800.592479481 (  real) ->   26.936x 
          0.001249075
  2 ParserBenchmarkYAML#parser  1000 repeats:
        271.002390644 (  real) ->    9.118x 
          0.003690004
  3 ParserBenchmarkRails#parser 1000 repeats:
         30.227910865 (  real) ->    1.017x 
          0.033082008
  4 ParserBenchmarkPure#parser  1000 repeats:
         29.722384421 (  real) ->    1.000x 
          0.033644676
            calls/sec (  time) ->    speed  covers
            secs/call

I have benchmarked the JSON-Generator as well. This generated a few more
values, because there are different modes that also influence the achieved
speed:

 Comparing times (call_time_mean):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        547.354332608 (  real) ->   15.090x 
          0.001826970
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        443.968212317 (  real) ->   12.240x 
          0.002252414
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        375.104545883 (  real) ->   10.341x 
          0.002665923
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         49.978706968 (  real) ->    1.378x 
          0.020008521
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         38.531868759 (  real) ->    1.062x 
          0.025952543
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         36.927649925 (  real) ->    1.018x 7 (>=3859)
          0.027079979
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         36.272134441 (  real) ->    1.000x 6 (>=3859)
          0.027569373
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1-3 are JSON::Ext::Generator methods. 4, 6, and 7 are
JSON::Pure::Generator methods and 5 is the Rails JSON generator. It is now a
bit faster than the generator_safe and generator_pretty methods of the pure
variant but slower than the others.

To achieve the fastest JSON document output, you can use the fast_generate
method. Beware, that this will disable the checking for circular Ruby data
structures, which may cause JSON to go into an infinite loop.

Here are the median comparisons for completeness' sake:

 Comparing times (call_time_median):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        708.258020939 (  real) ->   16.547x 
          0.001411915
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        569.105020353 (  real) ->   13.296x 
          0.001757145
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        482.825371244 (  real) ->   11.280x 
          0.002071142
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         62.717626652 (  real) ->    1.465x 
          0.015944481
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         43.965681162 (  real) ->    1.027x 
          0.022745013
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         43.929073409 (  real) ->    1.026x 7 (>=3859)
          0.022763968
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         42.802514491 (  real) ->    1.000x 6 (>=3859)
          0.023363113
            calls/sec (  time) ->    speed  covers
            secs/call

== Author

Florian Frank <mailto:flori@ping.de>

== License

Ruby License, see the COPYING file included in the source distribution. The
Ruby License includes the GNU General Public License (GPL), Version 2, so see
the file GPL as well.

== Download

The latest version of this library can be downloaded at

* http://rubyforge.org/frs?group_id=953

Online Documentation should be located at

* http://json.rubyforge.org

Copyright (c) 2010 Michael Bleigh, Josh Kalderimis, Erik Michaels-Ober, and Intridea, Inc.

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# MultiJSON [![Build Status](https://secure.travis-ci.org/intridea/multi_json.png?branch=master)][travis] [![Dependency Status](https://gemnasium.com/intridea/multi_json.png?travis)][gemnasium]

[travis]: http://travis-ci.org/intridea/multi_json
[gemnasium]: https://gemnasium.com/intridea/multi_json

Lots of Ruby libraries parse JSON and everyone has their favorite JSON coder.
Instead of choosing a single JSON coder and forcing users of your library to be
stuck with it, you can use MultiJSON instead, which will simply choose the
fastest available JSON coder. Here's how to use it:

    require 'multi_json'

    MultiJson.load('{"abc":"def"}') #=> {"abc" => "def"}
    MultiJson.load('{"abc":"def"}', :symbolize_keys => true) #=> {:abc => "def"}
    MultiJson.dump({:abc => 'def'}) # convert Ruby back to JSON
    MultiJson.dump({:abc => 'def'}, :pretty => true) # encoded in a pretty form (if supported by the coder)

The `use` method, which sets the MultiJson adapter, takes either a symbol or a
class (to allow for custom JSON parsers) that responds to both `.load` and `.dump`
at the class level.

MultiJSON tries to have intelligent defaulting. That is, if you have any of the
supported engines already loaded, it will utilize them before attempting to
load any. When loading, libraries are ordered by speed. First Oj, then Yajl,
then the JSON gem, then JSON pure. If no other JSON library is available,
MultiJSON falls back to [OkJson][], a simple, vendorable JSON parser.

[okjson]: https://github.com/kr/okjson

## Supported JSON Engines

* [Oj](https://github.com/ohler55/oj) Optimized JSON by Peter Ohler
* [Yajl](https://github.com/brianmario/yajl-ruby) Yet Another JSON Library by Brian Lopez
* [JSON](https://github.com/flori/json) The default JSON gem with C-extensions (ships with Ruby 1.9)
* [JSON Pure](https://github.com/flori/json) A Ruby variant of the JSON gem
* [NSJSONSerialization](https://developer.apple.com/library/ios/#documentation/Foundation/Reference/NSJSONSerialization_Class/Reference/Reference.html) Wrapper for Apple's NSJSONSerialization in the Cocoa Framework (MacRuby only)
* [OkJson][okjson] A simple, vendorable JSON parser

## Supported Ruby Versions
This library aims to support and is [tested against][travis] the following Ruby
implementations:

* Ruby 1.8.7
* Ruby 1.9.2
* Ruby 1.9.3
* [JRuby][]
* [Rubinius][]
* [MacRuby][] (not tested on Travis CI)

[jruby]: http://www.jruby.org/
[rubinius]: http://rubini.us/
[macruby]: http://www.macruby.org/

If something doesn't work on one of these interpreters, it should be considered
a bug.

This library may inadvertently work (or seem to work) on other Ruby
implementations, however support will only be provided for the versions listed
above.

If you would like this library to support another Ruby version, you may
volunteer to be a maintainer. Being a maintainer entails making sure all tests
run and pass on that implementation. When something breaks on your
implementation, you will be personally responsible for providing patches in a
timely fashion. If critical issues for a particular implementation exist at the
time of a major release, support for that Ruby version may be dropped.

## Versioning

This library aims to adhere to [Semantic Versioning 2.0.0][semver]. Violations
of this scheme should be reported as bugs. Specifically, if a minor or patch
version is released that breaks backward compatibility, that version should be
immediately yanked and/or a new version should be immediately released that
restores compatibility. Breaking changes to the public API will only be
introduced with new major versions. As a result of this policy, you can (and
should) specify a dependency on this gem using the [Pessimistic Version
Constraint][pvc] with two digits of precision. For example:

    spec.add_dependency 'multi_json', '~> 1.0'

[semver]: http://semver.org/
[pvc]: http://docs.rubygems.org/read/chapter/16#page74

## Copyright
Copyright (c) 2010 Michael Bleigh, Josh Kalderimis, Erik Michaels-Ober, and Intridea, Inc.
See [LICENSE][] for details.

[license]: https://github.com/intridea/multi_json/blob/master/LICENSE.md

= Ruby OAuth

== What

This is a RubyGem for implementing both OAuth clients and servers in Ruby applications.

See the OAuth specs http://oauth.net/core/1.0/

== Installing

  sudo gem install oauth

The source code is now hosted on the OAuth GitHub Project http://github.com/oauth/oauth-ruby

== The basics

This is a ruby library which is intended to be used in creating Ruby Consumer and Service Provider applications. It is NOT a Rails plugin, but could easily be used for the foundation for such a Rails plugin.

As a matter of fact it has been pulled out from an OAuth Rails Plugin http://code.google.com/p/oauth-plugin/ which now requires this GEM.

== Demonstration of usage

We need to specify the oauth_callback url explicitly, otherwise it defaults to "oob" (Out of Band)

  @callback_url = "http://127.0.0.1:3000/oauth/callback"

Create a new consumer instance by passing it a configuration hash:

  @consumer = OAuth::Consumer.new("key","secret", :site => "https://agree2")

Start the process by requesting a token

  @request_token = @consumer.get_request_token(:oauth_callback => @callback_url)
  session[:request_token] = @request_token
  redirect_to @request_token.authorize_url(:oauth_callback => @callback_url)

When user returns create an access_token

  @access_token = @request_token.get_access_token
  @photos = @access_token.get('/photos.xml')

Now that you have an access token, you can use Typhoeus to interact with the OAuth provider if you choose.

  require 'oauth/request_proxy/typhoeus_request'
  oauth_params = {:consumer => oauth_consumer, :token => access_token}
  hydra = Typhoeus::Hydra.new
  req = Typhoeus::Request.new(uri, options) 
  oauth_helper = OAuth::Client::Helper.new(req, oauth_params.merge(:request_uri => uri))
  req.headers.merge!({"Authorization" => oauth_helper.header}) # Signs the request
  hydra.queue(req)
  hydra.run
  @response = req.response


== More Information

* RDoc: http://rdoc.info/projects/oauth/oauth-ruby/
* Mailing List/Google Group: http://groups.google.com/group/oauth-ruby

== How to submit patches

The source code is now hosted on the OAuth GitHub Project http://github.com/oauth/oauth-ruby

To submit a patch, please fork the oauth project and create a patch with tests. Once you're happy with it send a pull request and post a message to the google group.

== License

This code is free to use under the terms of the MIT license. 

== Contact

OAuth Ruby has been created and maintained by a large number of talented individuals. 
The current maintainer is Aaron Quint (quirkey).

Comments are welcome. Send an email to via the OAuth Ruby mailing list http://groups.google.com/group/oauth-ruby
= All-purpose Property List manipulation library

Plist is a library to manipulate Property List files, also known as plists.  It can parse plist files into native Ruby data structures as well as generating new plist files from your Ruby objects.

== Usage

=== Parsing

  result = Plist::parse_xml('path/to/example.plist')

  result.class
  => Hash

  "#{result['FirstName']} #{result['LastName']}"
  => "John Public"

  result['ZipPostal']
  => "12345"

==== Example Property List

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
          <key>FirstName</key>
          <string>John</string>

          <key>LastName</key>
          <string>Public</string>

          <key>StreetAddr1</key>
          <string>123 Anywhere St.</string>

          <key>StateProv</key>
          <string>CA</string>

          <key>City</key>
          <string>Some Town</string>

          <key>CountryName</key>
          <string>United States</string>

          <key>AreaCode</key>
          <string>555</string>

          <key>LocalPhoneNumber</key>
          <string>5551212</string>

          <key>ZipPostal</key>
          <string>12345</string>
  </dict>
  </plist>

=== Generation

plist also provides the ability to generate plists from Ruby objects.  The following Ruby classes are converted into native plist types:
  Array, Bignum, Date, DateTime, Fixnum, Float, Hash, Integer, String, Symbol, Time, true, false

* +Array+ and +Hash+ are both recursive; their elements will be converted into plist nodes inside the <array> and <dict> containers (respectively).
* +IO+ (and its descendants) and +StringIO+ objects are read from and their contents placed in a <data> element.
* User classes may implement +to_plist_node+ to dictate how they should be serialized; otherwise the object will be passed to <tt>Marshal.dump</tt> and the result placed in a <data> element.  See below for more details.

==== Creating a plist

There are two ways to generate complete plists.  Given an object:

  obj = [1, :two, {'c' => 0xd}]

If you've mixed in <tt>Plist::Emit</tt> (which is already done for +Array+ and +Hash+), you can simply call +to_plist+:

  obj.to_plist

This is equivalent to calling <tt>Plist::Emit.dump(obj)</tt>.  Either one will yield:

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <array>
      <integer>1</integer>
      <string>two</string>
      <dict>
        <key>c</key>
        <integer>13</integer>
      </dict>
  </array>
  </plist>

You can also dump plist fragments by passing +false+ as the second parameter:

  Plist::Emit.dump('holy cow!', false)
  => "<string>holy cow!</string>"

==== Custom serialization

If your class can be safely coerced into a native plist datatype, you can implement +to_plist_node+.  Upon encountering an object of a class it doesn't recognize, the plist library will check to see if it responds to +to_plist_node+, and if so, insert the result of that call into the plist output.

An example:

  class MyFancyString
    ...

    def to_plist_node
      return "<string>#{self.defancify}</string>"
    end
  end

When you attempt to serialize a +MyFancyString+ object, the +to_plist_node+ method will be called and the object's contents will be defancified and placed in the plist.

If for whatever reason you can't add this method, your object will be serialized with <tt>Marshal.dump</tt> instead.

== Links

[Project Page]  http://plist.rubyforge.org
[GitHub]        http://github.com/bleything/plist
[RDoc]          http://plist.rubyforge.org

== Credits

plist is maintained by Ben Bleything <mailto:ben@bleything.net> and Patrick May <mailto:patrick@hexane.org>.  Patrick wrote most of the code; Ben is a recent addition to the project, having merged in his plist generation library.

Other folks who have helped along the way:

[<b>Martin Dittus</b>] who pointed out that +Time+ wasn't enough for plist <tt>Dates</tt>, especially those in <tt>~/Library/Cookies/Cookies.plist</tt>
[<b>Chuck Remes</b>] who pushed Patrick towards implementing <tt>#to_plist</tt>
[<b>Mat Schaffer</b>] who supplied code and test cases for <tt><data></tt> elements
[<b>Michael Granger</b>] for encouragement and help
[<b>Carsten Bormann, Chris Hoffman, Dana Contreras, Hongli Lai, Johan Srensen</b>] for contributing Ruby 1.9.x compatibility fixes

== License and Copyright

plist is released under the MIT License.

Portions of the code (notably the Rakefile) contain code pulled and/or adapted from other projects.  These files contain a comment at the top describing what was used.

=== MIT License

Copyright (c) 2006-2010, Ben Bleything <ben@bleything.net> and Patrick May <patrick@hexane.org>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY
KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


= Rack, a modular Ruby webserver interface {<img src="https://secure.travis-ci.org/rack/rack.png" alt="Build Status" />}[http://travis-ci.org/rack/rack] {<img src="https://gemnasium.com/rack/rack.png" alt="Dependency Status" />}[https://gemnasium.com/rack/rack]

Rack provides a minimal, modular and adaptable interface for developing
web applications in Ruby.  By wrapping HTTP requests and responses in
the simplest way possible, it unifies and distills the API for web
servers, web frameworks, and software in between (the so-called
middleware) into a single method call.

The exact details of this are described in the Rack specification,
which all Rack applications should conform to.

== Supported web servers

The included *handlers* connect all kinds of web servers to Rack:
* Mongrel
* EventedMongrel
* SwiftipliedMongrel
* WEBrick
* FCGI
* CGI
* SCGI
* LiteSpeed
* Thin

These web servers include Rack handlers in their distributions:
* Ebb
* Fuzed
* Glassfish v3
* Phusion Passenger (which is mod_rack for Apache and for nginx)
* Puma
* Rainbows!
* Reel
* Unicorn
* unixrack
* uWSGI
* Zbatery

Any valid Rack app will run the same on all these handlers, without
changing anything.

== Supported web frameworks

These frameworks include Rack adapters in their distributions:
* Camping
* Coset
* Espresso
* Halcyon
* Mack
* Maveric
* Merb
* Racktools::SimpleApplication
* Ramaze
* Ruby on Rails
* Rum
* Sinatra
* Sin
* Vintage
* Waves
* Wee
* ... and many others.

== Available middleware

Between the server and the framework, Rack can be customized to your
applications needs using middleware, for example:
* Rack::URLMap, to route to multiple applications inside the same process.
* Rack::CommonLogger, for creating Apache-style logfiles.
* Rack::ShowException, for catching unhandled exceptions and
  presenting them in a nice and helpful way with clickable backtrace.
* Rack::File, for serving static files.
* ...many others!

All these components use the same interface, which is described in
detail in the Rack specification.  These optional components can be
used in any way you wish.

== Convenience

If you want to develop outside of existing frameworks, implement your
own ones, or develop middleware, Rack provides many helpers to create
Rack applications quickly and without doing the same web stuff all
over:
* Rack::Request, which also provides query string parsing and
  multipart handling.
* Rack::Response, for convenient generation of HTTP replies and
  cookie handling.
* Rack::MockRequest and Rack::MockResponse for efficient and quick
  testing of Rack application without real HTTP round-trips.

== rack-contrib

The plethora of useful middleware created the need for a project that
collects fresh Rack middleware.  rack-contrib includes a variety of
add-on components for Rack and it is easy to contribute new modules.

* http://github.com/rack/rack-contrib

== rackup

rackup is a useful tool for running Rack applications, which uses the
Rack::Builder DSL to configure middleware and build up applications
easily.

rackup automatically figures out the environment it is run in, and
runs your application as FastCGI, CGI, or standalone with Mongrel or
WEBrick---all from the same configuration.

== Quick start

Try the lobster!

Either with the embedded WEBrick starter:

    ruby -Ilib lib/rack/lobster.rb

Or with rackup:

    bin/rackup -Ilib example/lobster.ru

By default, the lobster is found at http://localhost:9292.

== Installing with RubyGems

A Gem of Rack is available at rubygems.org.  You can install it with:

    gem install rack

I also provide a local mirror of the gems (and development snapshots)
at my site:

    gem install rack --source http://chneukirchen.org/releases/gems/

== Running the tests

Testing Rack requires the bacon testing framework:

    bundle install --without extra # to be able to run the fast tests

Or:

    bundle install # this assumes that you have installed native extensions!

There are two rake-based test tasks:

    rake test       tests all the fast tests (no Handlers or Adapters)
    rake fulltest   runs all the tests

The fast testsuite has no dependencies outside of the core Ruby
installation and bacon.

To run the test suite completely, you need:

  * fcgi
  * memcache-client
  * mongrel
  * thin

The full set of tests test FCGI access with lighttpd (on port
9203) so you will need lighttpd installed as well as the FCGI
libraries and the fcgi gem:

Download and install lighttpd:

    http://www.lighttpd.net/download

Installing the FCGI libraries:

    curl -O http://www.fastcgi.com/dist/fcgi-2.4.0.tar.gz
    tar xzvf fcgi-2.4.0.tar.gz
    cd fcgi-2.4.0
    ./configure --prefix=/usr/local
    make
    sudo make install
    cd ..

Installing the Ruby fcgi gem:

    gem install fcgi

Furthermore, to test Memcache sessions, you need memcached (will be
run on port 11211) and memcache-client installed.

== History

* March 3rd, 2007: First public release 0.1.

* May 16th, 2007: Second public release 0.2.
  * HTTP Basic authentication.
  * Cookie Sessions.
  * Static file handler.
  * Improved Rack::Request.
  * Improved Rack::Response.
  * Added Rack::ShowStatus, for better default error messages.
  * Bug fixes in the Camping adapter.
  * Removed Rails adapter, was too alpha.

* February 26th, 2008: Third public release 0.3.
  * LiteSpeed handler, by Adrian Madrid.
  * SCGI handler, by Jeremy Evans.
  * Pool sessions, by blink.
  * OpenID authentication, by blink.
  * :Port and :File options for opening FastCGI sockets, by blink.
  * Last-Modified HTTP header for Rack::File, by blink.
  * Rack::Builder#use now accepts blocks, by Corey Jewett.
    (See example/protectedlobster.ru)
  * HTTP status 201 can contain a Content-Type and a body now.
  * Many bugfixes, especially related to Cookie handling.

* August 21st, 2008: Fourth public release 0.4.
  * New middleware, Rack::Deflater, by Christoffer Sawicki.
  * OpenID authentication now needs ruby-openid 2.
  * New Memcache sessions, by blink.
  * Explicit EventedMongrel handler, by Joshua Peek <josh@joshpeek.com>
  * Rack::Reloader is not loaded in rackup development mode.
  * rackup can daemonize with -D.
  * Many bugfixes, especially for pool sessions, URLMap, thread safety
    and tempfile handling.
  * Improved tests.
  * Rack moved to Git.

* January 6th, 2009: Fifth public release 0.9.
  * Rack is now managed by the Rack Core Team.
  * Rack::Lint is stricter and follows the HTTP RFCs more closely.
  * Added ConditionalGet middleware.
  * Added ContentLength middleware.
  * Added Deflater middleware.
  * Added Head middleware.
  * Added MethodOverride middleware.
  * Rack::Mime now provides popular MIME-types and their extension.
  * Mongrel Header now streams.
  * Added Thin handler.
  * Official support for swiftiplied Mongrel.
  * Secure cookies.
  * Made HeaderHash case-preserving.
  * Many bugfixes and small improvements.

* January 9th, 2009: Sixth public release 0.9.1.
  * Fix directory traversal exploits in Rack::File and Rack::Directory.

* April 25th, 2009: Seventh public release 1.0.0.
  * SPEC change: Rack::VERSION has been pushed to [1,0].
  * SPEC change: header values must be Strings now, split on "\n".
  * SPEC change: Content-Length can be missing, in this case chunked transfer
    encoding is used.
  * SPEC change: rack.input must be rewindable and support reading into
    a buffer, wrap with Rack::RewindableInput if it isn't.
  * SPEC change: rack.session is now specified.
  * SPEC change: Bodies can now additionally respond to #to_path with
    a filename to be served.
  * NOTE: String bodies break in 1.9, use an Array consisting of a
    single String instead.
  * New middleware Rack::Lock.
  * New middleware Rack::ContentType.
  * Rack::Reloader has been rewritten.
  * Major update to Rack::Auth::OpenID.
  * Support for nested parameter parsing in Rack::Response.
  * Support for redirects in Rack::Response.
  * HttpOnly cookie support in Rack::Response.
  * The Rakefile has been rewritten.
  * Many bugfixes and small improvements.

* October 18th, 2009: Eighth public release 1.0.1.
  * Bump remainder of rack.versions.
  * Support the pure Ruby FCGI implementation.
  * Fix for form names containing "=": split first then unescape components
  * Fixes the handling of the filename parameter with semicolons in names.
  * Add anchor to nested params parsing regexp to prevent stack overflows
  * Use more compatible gzip write api instead of "<<".
  * Make sure that Reloader doesn't break when executed via ruby -e
  * Make sure WEBrick respects the :Host option
  * Many Ruby 1.9 fixes.

* January 3rd, 2010: Ninth public release 1.1.0.
  * Moved Auth::OpenID to rack-contrib.
  * SPEC change that relaxes Lint slightly to allow subclasses of the
    required types
  * SPEC change to document rack.input binary mode in greator detail
  * SPEC define optional rack.logger specification
  * File servers support X-Cascade header
  * Imported Config middleware
  * Imported ETag middleware
  * Imported Runtime middleware
  * Imported Sendfile middleware
  * New Logger and NullLogger middlewares
  * Added mime type for .ogv and .manifest.
  * Don't squeeze PATH_INFO slashes
  * Use Content-Type to determine POST params parsing
  * Update Rack::Utils::HTTP_STATUS_CODES hash
  * Add status code lookup utility
  * Response should call #to_i on the status
  * Add Request#user_agent
  * Request#host knows about forwared host
  * Return an empty string for Request#host if HTTP_HOST and
    SERVER_NAME are both missing
  * Allow MockRequest to accept hash params
  * Optimizations to HeaderHash
  * Refactored rackup into Rack::Server
  * Added Utils.build_nested_query to complement Utils.parse_nested_query
  * Added Utils::Multipart.build_multipart to complement
    Utils::Multipart.parse_multipart
  * Extracted set and delete cookie helpers into Utils so they can be
    used outside Response
  * Extract parse_query and parse_multipart in Request so subclasses
    can change their behavior
  * Enforce binary encoding in RewindableInput
  * Set correct external_encoding for handlers that don't use RewindableInput

* June 13th, 2010: Tenth public release 1.2.0.
  * Removed Camping adapter: Camping 2.0 supports Rack as-is
  * Removed parsing of quoted values
  * Add Request.trace? and Request.options?
  * Add mime-type for .webm and .htc
  * Fix HTTP_X_FORWARDED_FOR
  * Various multipart fixes
  * Switch test suite to bacon

* June 15th, 2010: Eleventh public release 1.2.1.
  * Make CGI handler rewindable
  * Rename spec/ to test/ to not conflict with SPEC on lesser
    operating systems

* March 13th, 2011: Twelfth public release 1.2.2/1.1.2.
  * Security fix in Rack::Auth::Digest::MD5: when authenticator
    returned nil, permission was granted on empty password.

* May 22nd, 2011: Thirteenth public release 1.3.0
  * Various performance optimizations
  * Various multipart fixes
  * Various multipart refactors
  * Infinite loop fix for multipart
  * Test coverage for Rack::Server returns
  * Allow files with '..', but not path components that are '..'
  * rackup accepts handler-specific options on the command line
  * Request#params no longer merges POST into GET (but returns the same)
  * Use URI.encode_www_form_component instead. Use core methods for escaping.
  * Allow multi-line comments in the config file
  * Bug L#94 reported by Nikolai Lugovoi, query parameter unescaping.
  * Rack::Response now deletes Content-Length when appropriate
  * Rack::Deflater now supports streaming
  * Improved Rack::Handler loading and searching
  * Support for the PATCH verb
  * env['rack.session.options'] now contains session options
  * Cookies respect renew
  * Session middleware uses SecureRandom.hex

* May 22nd, 2011: Fourteenth public release 1.2.3
  * Pulled in relevant bug fixes from 1.3
  * Fixed 1.8.6 support

* July 13, 2011: Fifteenth public release 1.3.1
  * Fix 1.9.1 support
  * Fix JRuby support
  * Properly handle $KCODE in Rack::Utils.escape
  * Make method_missing/respond_to behavior consistent for Rack::Lock,
    Rack::Auth::Digest::Request and Rack::Multipart::UploadedFile
  * Reenable passing rack.session to session middleware
  * Rack::CommonLogger handles streaming responses correctly
  * Rack::MockResponse calls close on the body object
  * Fix a DOS vector from MRI stdlib backport

* July 16, 2011: Sixteenth public release 1.3.2
  * Fix for Rails and rack-test, Rack::Utils#escape calls to_s

* September 16, 2011: Seventeenth public release 1.3.3
  * Fix bug with broken query parameters in Rack::ShowExceptions
  * Rack::Request#cookies no longer swallows exceptions on broken input
  * Prevents XSS attacks enabled by bug in Ruby 1.8's regexp engine
  * Rack::ConditionalGet handles broken If-Modified-Since helpers

* September 16, 2011: Eighteenth public release 1.2.4
  * Fix a bug with MRI regex engine to prevent XSS by malformed unicode

* October 1, 2011: Nineteenth public release 1.3.4
  * Backport security fix from 1.9.3, also fixes some roundtrip issues in URI
  * Small documentation update
  * Fix an issue where BodyProxy could cause an infinite recursion
  * Add some supporting files for travis-ci

* October 17, 2011: Twentieth public release 1.3.5
  * Fix annoying warnings caused by the backport in 1.3.4

* December 28th, 2011: Twenty first public release: 1.1.3.
  * Security fix. http://www.ocert.org/advisories/ocert-2011-003.html
    Further information here: http://jruby.org/2011/12/27/jruby-1-6-5-1

* December 28th, 2011: Twenty fourth public release 1.4.0
  * Ruby 1.8.6 support has officially been dropped. Not all tests pass.
  * Raise sane error messages for broken config.ru
  * Allow combining run and map in a config.ru
  * Rack::ContentType will not set Content-Type for responses without a body
  * Status code 205 does not send a response body
  * Rack::Response::Helpers will not rely on instance variables
  * Rack::Utils.build_query no longer outputs '=' for nil query values
  * Various mime types added
  * Rack::MockRequest now supports HEAD
  * Rack::Directory now supports files that contain RFC3986 reserved chars
  * Rack::File now only supports GET and HEAD requests
  * Rack::Server#start now passes the block to Rack::Handler::<h>#run
  * Rack::Static now supports an index option
  * Added the Teapot status code
  * rackup now defaults to Thin instead of Mongrel (if installed)
  * Support added for HTTP_X_FORWARDED_SCHEME
  * Numerous bug fixes, including many fixes for new and alternate rubies

* January 22nd, 2012: Twenty fifth public release 1.4.1
  * Alter the keyspace limit calculations to reduce issues with nested params
  * Add a workaround for multipart parsing where files contain unescaped "%"
  * Added Rack::Response::Helpers#method_not_allowed? (code 405)
  * Rack::File now returns 404 for illegal directory traversals
  * Rack::File now returns 405 for illegal methods (non HEAD/GET)
  * Rack::Cascade now catches 405 by default, as well as 404
  * Cookies missing '--' no longer cause an exception to be raised
  * Various style changes and documentation spelling errors
  * Rack::BodyProxy always ensures to execute its block
  * Additional test coverage around cookies and secrets
  * Rack::Session::Cookie can now be supplied either secret or old_secret
  * Tests are no longer dependent on set order
  * Rack::Static no longer defaults to serving index files
  * Rack.release was fixed

* January 6th, 2013: Twenty sixth public release 1.1.4
  * Add warnings when users do not provide a session secret

* January 6th, 2013: Twenty seventh public release 1.2.6
  * Add warnings when users do not provide a session secret
  * Fix parsing performance for unquoted filenames

* January 6th, 2013: Twenty eighth public release 1.3.7
  * Add warnings when users do not provide a session secret
  * Fix parsing performance for unquoted filenames
  * Updated URI backports
  * Fix URI backport version matching, and silence constant warnings
  * Correct parameter parsing with empty values
  * Correct rackup '-I' flag, to allow multiple uses
  * Correct rackup pidfile handling
  * Report rackup line numbers correctly
  * Fix request loops caused by non-stale nonces with time limits
  * Fix reloader on Windows
  * Prevent infinite recursions from Response#to_ary
  * Various middleware better conforms to the body close specification
  * Updated language for the body close specification
  * Additional notes regarding ECMA escape compatibility issues
  * Fix the parsing of multiple ranges in range headers

* January 6th, 2013: Twenty ninth public release 1.4.2
  * Add warnings when users do not provide a session secret
  * Fix parsing performance for unquoted filenames
  * Updated URI backports
  * Fix URI backport version matching, and silence constant warnings
  * Correct parameter parsing with empty values
  * Correct rackup '-I' flag, to allow multiple uses
  * Correct rackup pidfile handling
  * Report rackup line numbers correctly
  * Fix request loops caused by non-stale nonces with time limits
  * Fix reloader on Windows
  * Prevent infinite recursions from Response#to_ary
  * Various middleware better conforms to the body close specification
  * Updated language for the body close specification
  * Additional notes regarding ECMA escape compatibility issues
  * Fix the parsing of multiple ranges in range headers
  * Prevent errors from empty parameter keys
  * Added PATCH verb to Rack::Request
  * Various documentation updates
  * Fix session merge semantics (fixes rack-test)
  * Rack::Static :index can now handle multiple directories
  * All tests now utilize Rack::Lint (special thanks to Lars Gierth)
  * Rack::File cache_control parameter is now deprecated, and removed by 1.5
  * Correct Rack::Directory script name escaping
  * Rack::Static supports header rules for sophisticated configurations
  * Multipart parsing now works without a Content-Length header
  * New logos courtesy of Zachary Scott!
  * Rack::BodyProxy now explicitly defines #each, useful for C extensions
  * Cookies that are not URI escaped no longer cause exceptions

* January 7th, 2013: Thirtieth public release 1.3.8
  * Security: Prevent unbounded reads in large multipart boundaries

* January 7th, 2013: Thirty first public release 1.4.3
  * Security: Prevent unbounded reads in large multipart boundaries

* January 13th, 2013: Thirty second public release 1.4.4, 1.3.9, 1.2.7, 1.1.5
  * [SEC] Rack::Auth::AbstractRequest no longer symbolizes arbitrary strings
  * Fixed erroneous test case in the 1.3.x series

* January 21st, 2013: Thirty third public release 1.5.0
  * Introduced hijack SPEC, for before-response and after-response hijacking
  * SessionHash is no longer a Hash subclass
  * Rack::File cache_control parameter is removed, in place of headers options
  * Rack::Auth::AbstractRequest#scheme now yields strings, not symbols
  * Rack::Utils cookie functions now format expires in RFC 2822 format
  * Rack::File now has a default mime type
  * rackup -b 'run Rack::File.new(".")', option provides command line configs
  * Rack::Deflater will no longer double encode bodies
  * Rack::Mime#match? provides convenience for Accept header matching
  * Rack::Utils#q_values provides splitting for Accept headers
  * Rack::Utils#best_q_match provides a helper for Accept headers
  * Rack::Handler.pick provides convenience for finding available servers
  * Puma added to the list of default servers (preferred over Webrick)
  * Various middleware now correctly close body when replacing it
  * Rack::Request#params is no longer persistent with only GET params
  * Rack::Request#update_param and #delete_param provide persistent operations
  * Rack::Request#trusted_proxy? now returns true for local unix sockets
  * Rack::Response no longer forces Content-Types
  * Rack::Sendfile provides local mapping configuration options
  * Rack::Utils#rfc2109 provides old netscape style time output
  * Updated HTTP status codes
  * Ruby 1.8.6 likely no longer passes tests, and is no longer fully supported

* January 28th, 2013: Thirty fourth public release 1.5.1
  * Rack::Lint check_hijack now conforms to other parts of SPEC
  * Added hash-like methods to Abstract::ID::SessionHash for compatibility
  * Various documentation corrections

== Contact

Please post bugs, suggestions and patches to
the bug tracker at <http://github.com/rack/rack/issues>.

Please post security related bugs and suggestions to the core team at
<https://groups.google.com/group/rack-core> or rack-core@googlegroups.com. This
list is not public. Due to wide usage of the library, it is strongly preferred
that we manage timing in order to provide viable patches at the time of
disclosure. Your assistance in this matter is greatly appreciated.

Mailing list archives are available at
<http://groups.google.com/group/rack-devel>.

Git repository (send Git patches to the mailing list):
* http://github.com/rack/rack
* http://git.vuxu.org/cgi-bin/gitweb.cgi?p=rack-github.git

You are also welcome to join the #rack channel on irc.freenode.net.

== Thanks

The Rack Core Team, consisting of

* Christian Neukirchen (chneukirchen)
* James Tucker (raggi)
* Josh Peek (josh)
* Michael Fellinger (manveru)
* Ryan Tomayko (rtomayko)
* Scytrin dai Kinthra (scytrin)
* Aaron Patterson (tenderlove)
* Konstantin Haase (rkh)

would like to thank:

* Adrian Madrid, for the LiteSpeed handler.
* Christoffer Sawicki, for the first Rails adapter and Rack::Deflater.
* Tim Fletcher, for the HTTP authentication code.
* Luc Heinrich for the Cookie sessions, the static file handler and bugfixes.
* Armin Ronacher, for the logo and racktools.
* Alex Beregszaszi, Alexander Kahn, Anil Wadghule, Aredridel, Ben
  Alpert, Dan Kubb, Daniel Roethlisberger, Matt Todd, Tom Robinson,
  Phil Hagelberg, S. Brent Faulkner, Bosko Milekic, Daniel Rodrguez
  Troitio, Genki Takiuchi, Geoffrey Grosenbach, Julien Sanchez, Kamal
  Fariz Mahyuddin, Masayoshi Takahashi, Patrick Aljordm, Mig, Kazuhiro
  Nishiyama, Jon Bardin, Konstantin Haase, Larry Siden, Matias
  Korhonen, Sam Ruby, Simon Chiang, Tim Connor, Timur Batyrshin, and
  Zach Brock for bug fixing and other improvements.
* Eric Wong, Hongli Lai, Jeremy Kemper for their continuous support
  and API improvements.
* Yehuda Katz and Carl Lerche for refactoring rackup.
* Brian Candler, for Rack::ContentType.
* Graham Batty, for improved handler loading.
* Stephen Bannasch, for bug reports and documentation.
* Gary Wright, for proposing a better Rack::Response interface.
* Jonathan Buch, for improvements regarding Rack::Response.
* Armin Rhrl, for tracking down bugs in the Cookie generator.
* Alexander Kellett for testing the Gem and reviewing the announcement.
* Marcus Rckert, for help with configuring and debugging lighttpd.
* The WSGI team for the well-done and documented work they've done and
  Rack builds up on.
* All bug reporters and patch contributors not mentioned above.

== Copyright

Copyright (C) 2007, 2008, 2009, 2010 Christian Neukirchen <http://purl.org/net/chneukirchen>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to
deal in the Software without restriction, including without limitation the
rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
sell copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

== Links

Rack:: <http://rack.github.com/>
Official Rack repositories:: <http://github.com/rack>
Rack Bug Tracking:: <http://github.com/rack/rack/issues>
rack-devel mailing list:: <http://groups.google.com/group/rack-devel>
Rack's Rubyforge project:: <http://rubyforge.org/projects/rack>

Christian Neukirchen:: <http://chneukirchen.org/>


You should use protection!

This gem protects against typical web attacks.
Should work for all Rack apps, including Rails.

# Usage

Use all protections you probably want to use:

``` ruby
# config.ru
require 'rack/protection'
use Rack::Protection
run MyApp
```

Skip a single protection middleware:

``` ruby
# config.ru
require 'rack/protection'
use Rack::Protection, :except => :path_traversal
run MyApp
```

Use a single protection middleware:

``` ruby
# config.ru
require 'rack/protection'
use Rack::Protection::AuthenticityToken
run MyApp
```

# Prevented Attacks

## Cross Site Request Forgery

Prevented by:

* `Rack::Protection::AuthenticityToken` (not included by `use Rack::Protection`)
* `Rack::Protection::FormToken` (not included by `use Rack::Protection`)
* `Rack::Protection::JsonCsrf`
* `Rack::Protection::RemoteReferrer` (not included by `use Rack::Protection`)
* `Rack::Protection::RemoteToken`
* `Rack::Protection::HttpOrigin`

## Cross Site Scripting

Prevented by:

* `Rack::Protection::EscapedParams` (not included by `use Rack::Protection`)
* `Rack::Protection::XssHeader` (Internet Explorer only)

## Clickjacking

Prevented by:

* `Rack::Protection::FrameOptions`

## Directory Traversal

Prevented by:

* `Rack::Protection::PathTraversal`

## Session Hijacking

Prevented by:

* `Rack::Protection::SessionHijacking`

## IP Spoofing

Prevented by:

* `Rack::Protection::IPSpoofing`

# Installation

    gem install rack-protection


= Sinatra

<i>Wichtig: Dieses Dokument ist eine bersetzung aus dem Englischen und unter
Umstnden nicht auf dem aktuellen Stand.</i>

Sinatra ist eine DSL, die das schnelle Erstellen von Webanwendungen in Ruby
mit minimalem Aufwand ermglicht:

  # myapp.rb
  require 'sinatra'
  get '/' do
    'Hallo Welt!'
  end

Einfach via +rubygems+ installieren und starten:

  gem install sinatra
  ruby -rubygems myapp.rb

Die Seite kann nun unter http://localhost:4567 betrachtet werden.

Es wird empfohlen, den Thin-Server via <tt>gem install thin</tt> zu
installieren, den Sinatra dann, soweit vorhanden, automatisch verwendet.

== Routen

In Sinatra wird eine Route durch eine HTTP-Methode und ein URL-Muster
definiert. Jeder dieser Routen wird ein Ruby-Block zugeordnet:

  get '/' do
    .. zeige etwas ..
  end

  post '/' do
    .. erstelle etwas ..
  end

  put '/' do
    .. update etwas ..
  end

  delete '/' do
    .. entferne etwas ..
  end

  options '/' do
    .. zeige, was wir knnen ..
  end

Die Routen werden in der Reihenfolge durchlaufen, in der sie definiert wurden.
Das erste Routen-Muster, das mit dem Request bereinstimmt, wird ausgefhrt.

Die Muster der Routen knnen benannte Parameter beinhalten, die ber den
<tt>params</tt>-Hash zugnglich gemacht werden:

  get '/hallo/:name' do
    # passt auf "GET /hallo/foo" und "GET /hallo/bar"
    # params[:name] ist 'foo' oder 'bar'
    "Hallo #{params[:name]}!"
  end

Man kann auf diese auch mit Block-Parametern zugreifen:

  get '/hallo/:name' do |n|
    "Hallo #{n}!"
  end

Routen-Muster knnen auch mit Splat- oder Wildcard-Parametern ber das
<tt>params[:splat]</tt>-Array angesprochen werden:

  get '/sag/*/zu/*' do
    # passt auf /sag/hallo/zu/welt
    params[:splat] # => ["hallo", "welt"]
  end

  get '/download/*.*' do
    # passt auf /download/pfad/zu/datei.xml
    params[:splat] # => ["pfad/zu/datei", "xml"]
  end

Oder mit Block-Parametern:

  get '/download/*.*' do |pfad, endung|
    [pfad, endung] # => ["Pfad/zu/Datei", "xml"]
  end

Routen mit regulren Ausdrcken sind auch mglich:

  get %r{/hallo/([\w]+)} do
    "Hallo, #{params[:captures].first}!"
  end

Und auch hier knnen Block-Parameter genutzt werden:

  get %r{/hallo/([\w]+)} do |c|
    "Hallo, #{c}!"
  end

Routen-Muster knnen auch mit optionalen Parametern ausgestattet werden:

  get '/posts.?:format?' do
    # passt auf "GET /posts" sowie jegliche Erweiterung
    # wie "GET /posts.json", "GET /posts.xml" etc.
  end

Anmerkung: Solange man den sog. Path Traversal Attack-Schutz nicht deaktiviert
(siehe weiter unten), kann es sein, dass der Request-Pfad noch vor dem Abgleich
mit den Routen modifiziert wird.

=== Bedingungen

An Routen knnen eine Vielzahl von Bedingungen angehngt werden, die erfllt
sein mssen, damit der Block ausgefhrt wird. Mglich wre etwa eine
Einschrnkung des User-Agents:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Du verwendest Songbird Version #{params[:agent][0]}"
  end

  get '/foo' do
    # passt auf andere Browser
  end

Andere mitgelieferte Bedingungen sind +host_name+ und +provides+:

  get '/', :host_name => /^admin\./ do
    "Adminbereich, Zugriff verweigert!"
  end

  get '/', :provides => 'html' do
    haml :index
  end

  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

Es knnen auch andere Bedingungen relativ einfach hinzugefgt werden:

  set(:probability) { |value| condition { rand <= value } }

  get '/auto_gewinnen', :probability => 0.1 do
    "Du hast gewonnen!"
  end

  get '/auto_gewinnen' do
    "Tut mir leid, verloren."
  end

Bei Bedingungen, die mehrere Werte annehmen knnen, sollte ein Splat verwendet
werden:

  set(:auth) do |*roles|   # <- hier kommt der Splat ins Spiel
    condition do
      unless logged_in? && roles.any? {|role| current_user.in_role? role }
        redirect "/login/", 303
      end
    end
  end

  get "/mein/account/", :auth => [:user, :admin] do
    "Mein Account"
  end

  get "/nur/admin/", :auth => :admin do
    "Nur Admins drfen hier rein!"
  end

=== Rckgabewerte

Durch den Rckgabewert eines Routen-Blocks wird mindestens der Response-Body
festgelegt, der an den HTTP-Client, bzw. die nchste Rack-Middleware,
weitergegeben wird. Im Normalfall handelt es sich hierbei, wie in den
vorangehenden Beispielen zu sehen war, um einen String. Es werden allerdings
auch andere Werte akzeptiert.

Es kann jedes gltige Objekt zurckgegeben werden, bei dem es sich entweder um
einen Rack-Rckgabewert, einen Rack-Body oder einen HTTP-Status-Code handelt:

* Ein Array mit drei Elementen: <tt>[Status (Fixnum), Headers (Hash),
  Response-Body (antwortet auf #each)]</tt>.
* Ein Array mit zwei Elementen: <tt>[Status (Fixnum), Response-Body (antwortet
  auf #each)]</tt>.
* Ein Objekt, das auf <tt>#each</tt> antwortet und den an diese Methode
  bergebenen Block nur mit Strings als bergabewerte aufruft.
* Ein Fixnum, das den Status-Code festlegt.

Damit lsst sich relativ einfach Streaming implementieren:

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

Ebenso kann die +stream+-Helfer-Methode (s.u.) verwendet werden, die Streaming
direkt in die Route integriert.

=== Eigene Routen-Muster

Wie oben schon beschrieben, ist Sinatra von Haus aus mit Untersttzung fr
String-Muster und Regulre Ausdrcke zum Abgleichen von Routen ausgestattet.
Das muss aber noch nicht alles sein, es knnen ohne groen Aufwand eigene
Routen-Muster erstellt werden:

  class AllButPattern
    Match = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Match.new([])
    end

    def match(str)
      @captures unless @except === str
    end
  end

  def all_but(pattern)
    AllButPattern.new(pattern)
  end

  get all_but("/index") do
    # ...
  end

Beachte, dass das obige Beispiel etwas bertrieben wirkt. Es geht auch
einfacher:

  get // do
    pass if request.path_info == "/index"
    # ...
  end

Oder unter Verwendung eines negativen look ahead:

  get %r{^(?!/index$)} do
    # ...
  end

== Statische Dateien

Statische Dateien werden aus dem <tt>./public</tt>-Ordner ausgeliefert. Es ist
mglich, einen anderen Ort zu definieren, indem man die
<tt>:public_folder</tt>-Option setzt:

  set :public_folder, File.dirname(__FILE__) + '/static'

Zu beachten ist, dass der Ordnername public nicht Teil der URL ist. Die Datei
<tt>./public/css/style.css</tt> ist unter
<tt>http://example.com/css/style.css</tt> zu finden.

Um den <tt>Cache-Control</tt>-Header mit Informationen zu versorgen, verwendet
man die <tt>:static_cache_control</tt>-Einstellung (s.u.).

== Views/Templates

Alle Templatesprachen verwenden ihre eigene Renderingmethode, die jeweils
einen String zurckgibt:

  get '/' do
    erb :index
  end

Dieses Beispiel rendert <tt>views/index.erb</tt>.

Anstelle eines Templatenamens kann man auch direkt die Templatesprache
verwenden:

  get '/' do
    code = "<%= Time.now %>"
    erb code
  end

Templates nehmen ein zweite Argument an, den Options-Hash:

  get '/' do
    erb :index, :layout => :post
  end

Dieses Beispiel rendert <tt>views/index.erb</tt> eingebettet in
<tt>views/post.erb</tt> (Voreinstellung ist <tt>views/layout.erb</tt>, sofern
es vorhanden ist.)

Optionen, die Sinatra nicht versteht, werden an das Template weitergereicht:

  get '/' do
    haml :index, :format => :html5
  end

Fr alle Templates knnen auch generelle Einstellungen festgelegt werden:

  set :haml, :format => :html5

  get '/' do
    haml :index
  end

Optionen, die an die Rendermethode weitergegeben werden, berschreiben die
Einstellungen, die mit +set+ festgelegt wurden.

Mgliche Einstellungen:

[locals]
  Liste von lokalen Variablen, die and das Dokument weitergegeben werden.
  Praktisch fr Partials.
  Beispiel: <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>

[default_encoding]
  Gibt die Stringkodierung an, die verwendet werden soll. Voreingestellt auf
  <tt>settings.default_encoding</tt>.

[views]
  Ordner, aus dem die Templates heraus geladen werden. Voreingestellt auf
  <tt>settings.views</tt>.

[layout]
  Legt fest, ob ein Layouttemplate verwendet werden soll oder nicht (+true+
  oder +false+). Ist es ein Symbol, dass legt es fest, welches Template als
  Layout verwendet wird. Beispiel:
   <tt>erb :index, :layout => !request.xhr?</tt>

[content_type]
  Content-Type den das Template ausgibt. Voreinstellung hngt von der
  Templatesprache ab.

[scope]
  Scope, in dem das Template gerendert wird. Liegt standardmig innerhalb der
  App-Instanz. Wird Scope gendert, sind Instanzvariablen und Helfermethoden
  nicht verfgbar.

[layout_engine]
  Legt fest, welcher Renderer fr das Layout verantwortlich ist.
  Hilfreich fr Sprachen, die sonst keine Templates untersttzen.
  Voreingestellt auf den Renderer, der fr das Template verwendet wird.
  Beispiel: <tt>set :rdoc, :layout_engine => :erb</tt>

Sinatra geht davon aus, dass die Templates sich im <tt>./views</tt> Verzeichnis
befinden. Es kann jedoch ein anderer Ordner festgelegt werden:

  set :views, settings.root + '/templates'

Es ist zu beachten, dass immer mit Symbolen auf Templates verwiesen werden
muss, auch dann, wenn sie sich in einem Unterordner befinden:

  haml :'unterverzeichnis/template'

Rendering-Methoden rendern jeden String direkt.

=== Verfgbare Templatesprachen

Einige Sprachen haben mehrere Implementierungen. Um festzulegen, welche
verwendet wird (und dann auch Thread-sicher ist), verwendet man am besten zu
Beginn ein 'require':

  require 'rdiscount' # oder require 'bluecloth'
  get('/') { markdown :index }

=== Haml Templates

Abhngigkeit::        {haml}[http://haml.info/]
Dateierweiterungs::   <tt>.haml</tt>
Beispiel::           <tt>haml :index, :format => :html5</tt>

=== Erb Templates

Abhngigkeit::        {erubis}[http://www.kuwata-lab.com/erubis/] oder
                    erb (included in Ruby)
Dateierweiterungs::   <tt>.erb</tt>, <tt>.rhtml</tt> oder <tt>.erubis</tt>
                    (nur Erubis)
Beispiel::           <tt>erb :index</tt>

=== Builder Templates

Abhngigkeit::        {builder}[http://builder.rubyforge.org/]
Dateierweiterungs::   <tt>.builder</tt>
Beispiel::           <tt>builder { |xml| xml.em "Hallo" }</tt>

Nimmt ebenso einen Block fr Inline-Templates entgegen (siehe Beispiel).

=== Nokogiri Templates

Abhngigkeit::        {nokogiri}[http://nokogiri.org/]
Dateierweiterungs::   <tt>.nokogiri</tt>
Beispiel::           <tt>nokogiri { |xml| xml.em "Hallo" }</tt>

Nimmt ebenso einen Block fr Inline-Templates entgegen (siehe Beispiel).

=== Sass Templates

Abhngigkeit::        {sass}[http://sass-lang.com/]
Dateierweiterungs::   <tt>.sass</tt>
Beispiel::           <tt>sass :stylesheet, :style => :expanded</tt>

=== SCSS Templates

Abhngigkeit::        {sass}[http://sass-lang.com/]
Dateierweiterungs::   <tt>.scss</tt>
Beispiel::           <tt>scss :stylesheet, :style => :expanded</tt>

=== Less Templates

Abhngigkeit::        {less}[http://www.lesscss.org/]
Dateierweiterungs::   <tt>.less</tt>
Beispiel::           <tt>less :stylesheet</tt>

=== Liquid Templates

Abhngigkeit::        {liquid}[http://www.liquidmarkup.org/]
Dateierweiterungs::   <tt>.liquid</tt>
Beispiel::           <tt>liquid :index, :locals => { :key => 'Wert' }</tt>

Da man aus dem Liquid-Template heraus keine Ruby-Methoden aufrufen kann
(ausgenommen +yield+), wird man blicherweise locals verwenden wollen, mit
denen man Variablen weitergibt.

=== Markdown Templates

Abhngigkeit::        {rdiscount}[https://github.com/rtomayko/rdiscount],
                    {redcarpet}[https://github.com/tanoku/redcarpet],
                    {bluecloth}[http://deveiate.org/projects/BlueCloth],
                    {kramdown}[http://kramdown.rubyforge.org/] *oder*
                    {maruku}[http://maruku.rubyforge.org/]
Dateierweiterungs::   <tt>.markdown</tt>, <tt>.mkd</tt> und <tt>.md</tt>
Beispiel::           <tt>markdown :index, :layout_engine => :erb</tt>

Da man aus den Markdown-Templates heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Markdown blicherweise in Kombination mit
anderen Renderern verwenden wollen:

  erb :overview, :locals => { :text => markdown(:einfuehrung) }

Beachte, dass man die +markdown+-Methode auch aus anderen Templates heraus
aufrufen kann:

  %h1 Gru von Haml!
  %p= markdown(:Gre)

Da man Ruby nicht von Markdown heraus aufrufen kann, knnen auch Layouts nicht
in Markdown geschrieben werden. Es ist aber mglich, einen Renderer fr die
Templates zu verwenden und einen anderen fr das Layout, indem die
<tt>:layout_engine</tt>-Option verwendet wird.

=== Textile Templates

Abhngigkeit::        {RedCloth}[http://redcloth.org/]
Dateierweiterungs::   <tt>.textile</tt>
Beispiel::           <tt>textile :index, :layout_engine => :erb</tt>

Da man aus dem Textile-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Textile blicherweise in Kombination mit
anderen Renderern verwenden wollen:

  erb :overview, :locals => { :text => textile(:einfuehrung) }

Beachte, dass man die +textile+-Methode auch aus anderen Templates heraus
aufrufen kann:

  %h1 Gru von Haml!
  %p= textile(:Gre)

Da man Ruby nicht von Textile heraus aufrufen kann, knnen auch Layouts nicht
in Textile geschrieben werden. Es ist aber mglich, einen Renderer fr die
Templates zu verwenden und einen anderen fr das Layout, indem die
<tt>:layout_engine</tt>-Option verwendet wird.

=== RDoc Templates

Abhngigkeit::        {rdoc}[http://rdoc.rubyforge.org/]
Dateierweiterungs::   <tt>.rdoc</tt>
Beispiel::           <tt>textile :README, :layout_engine => :erb</tt>

Da man aus dem RDoc-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man RDoc blicherweise in Kombination mit
anderen Renderern verwenden wollen:

  erb :overview, :locals => { :text => rdoc(:einfuehrung) }

Beachte, dass man die +rdoc+-Methode auch aus anderen Templates heraus
aufrufen kann:

  %h1 Gru von Haml!
  %p= rdoc(:Gre)

Da man Ruby nicht von RDoc heraus aufrufen kann, knnen auch Layouts nicht
in RDoc geschrieben werden. Es ist aber mglich, einen Renderer fr die
Templates zu verwenden und einen anderen fr das Layout, indem die
<tt>:layout_engine</tt>-Option verwendet wird.

=== Radius Templates

Abhngigkeit::        {radius}[http://radius.rubyforge.org/]
Dateierweiterungs::   <tt>.radius</tt>
Beispiel::           <tt>radius :index, :locals => { :key => 'Wert' }</tt>

Da man aus dem Radius-Template heraus keine Ruby-Methoden aufrufen kann, wird
man blicherweise locals verwenden wollen, mit denen man Variablen weitergibt.

=== Markaby Templates

Abhngigkeit::        {markaby}[http://markaby.github.com/]
Dateierweiterungs::   <tt>.mab</tt>
Beispiel::           <tt>markaby { h1 "Willkommen!" }</tt>

Nimmt ebenso einen Block fr Inline-Templates entgegen (siehe Beispiel).

=== Slim Templates

Abhngigkeit::        {slim}[http://slim-lang.com/]
Dateierweiterungs::   <tt>.slim</tt>
Beispiel::           <tt>slim :index</tt>

=== Creole Templates

Abhngigkeit::        {creole}[https://github.com/minad/creole]
Dateierweiterungs::   <tt>.creole</tt>
Beispiel::           <tt>creole :wiki, :layout_engine => :erb</tt>

Da man aus dem Creole-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Creole blicherweise in Kombination mit
anderen Renderern verwenden wollen:

  erb :overview, :locals => { :text => creole(:einfuehrung) }

Beachte, dass man die +creole+-Methode auch aus anderen Templates heraus
aufrufen kann:

  %h1 Gru von Haml!
  %p= creole(:Gre)

Da man Ruby nicht von Creole heraus aufrufen kann, knnen auch Layouts nicht
in Creole geschrieben werden. Es ist aber mglich, einen Renderer fr die
Templates zu verwenden und einen anderen fr das Layout, indem die
<tt>:layout_engine</tt>-Option verwendet wird.

=== CoffeeScript Templates

Abhngigkeit::        {coffee-script}[https://github.com/josh/ruby-coffee-script]
                      und eine {Mglichkeit JavaScript auszufhren}[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
Dateierweiterungs::   <tt>.coffee</tt>
Beispiel::            <tt>coffee :index</tt>

=== Eingebettete Templates

  get '/' do
    haml '%div.title Hallo Welt'
  end

Rendert den eingebetteten Template-String.

=== Auf Variablen in Templates zugreifen

Templates werden in demselben Kontext ausgefhrt wie Routen. Instanzvariablen
in Routen sind auch direkt im Template verfgbar:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end

Oder durch einen expliziten Hash von lokalen Variablen:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= bar.name', :locals => { :bar => foo }
  end

Dies wird typischerweise bei Verwendung von Subtemplates (partials) in anderen
Templates eingesetzt.

=== Inline-Templates

Templates knnen auch am Ende der Datei definiert werden:

  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hallo Welt!!!!!

Anmerkung: Inline-Templates, die in der Datei definiert sind, die <tt>require
'sinatra'</tt> aufruft, werden automatisch geladen. Um andere Inline-Templates
in anderen Dateien aufzurufen, muss explizit <tt>enable :inline_templates</tt>
verwendet werden.

=== Benannte Templates

Templates knnen auch mit der Top-Level <tt>template</tt>-Methode definiert
werden:

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hallo Welt!'
  end

  get '/' do
    haml :index
  end

Wenn ein Template mit dem Namen "layout" existiert, wird es bei jedem Aufruf
verwendet. Durch <tt>:layout => false</tt> kann das Ausfhren verhindert
werden:

  get '/' do
    haml :index, :layout => request.xhr?
  end

=== Dateiendungen zuordnen

Um eine Dateiendung einer Template-Engine zuzuordnen, kann
<tt>Tilt.register</tt> genutzt werden. Wenn etwa die Dateiendung +tt+ fr
Textile-Templates genutzt werden soll, lsst sich dies wie folgt
bewerkstelligen:

  Tilt.register :tt, Tilt[:textile]

=== Eine eigene Template-Engine hinzufgen

Zu allererst muss die Engine bei Tilt registriert und danach eine
Rendering-Methode erstellt werden:

  Tilt.register :mtt, MeineTolleTemplateEngine

  helpers do
    def mtt(*args) render(:mtt, *args) end
  end

  get '/' do
    mtt :index
  end

Dieser Code rendert <tt>./views/application.mtt</tt>. Siehe
github.com/rtomayko/tilt[https://github.com/rtomayko/tilt], um mehr ber Tilt
zu lernen.

== Filter

Before-Filter werden vor jedem Request in demselben Kontext, wie danach die
Routen, ausgefhrt. So knnen etwa Request und Antwort gendert werden.
Gesetzte Instanzvariablen in Filtern knnen in Routen und Templates verwendet
werden:

  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end

After-Filter werden nach jedem Request in demselben Kontext ausgefhrt und
knnen ebenfalls Request und Antwort ndern. In Before-Filtern gesetzte
Instanzvariablen knnen in After-Filtern verwendet werden:

  after do
    puts response.status
  end

Filter knnen optional auch mit einem Muster ausgestattet werden, welches auf
den Request-Pfad passen muss, damit der Filter ausgefhrt wird:

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

hnlich wie Routen knnen Filter auch mit weiteren Bedingungen eingeschrnkt
werden:

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== Helfer

Durch die Top-Level <tt>helpers</tt>-Methode werden sogenannte Helfer-Methoden
definiert, die in Routen und Templates verwendet werden knnen:

  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

=== Sessions verwenden
Sessions werden verwendet, um Zustnde zwischen den Requests zu speichern.
Sind sie aktiviert, kann ein Session-Hash je Benutzer-Session verwendet werden.

  enable :sessions

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

Beachte, dass <tt>enable :sessions</tt> alle Daten in einem Cookie speichert.
Unter Umstnden kann dies negative Effekte haben, z.B. verursachen viele Daten
hheren, teilweise berflssigen Traffic. Um das zu vermeiden, kann eine Rack-
Session-Middleware verwendet werden. Dabei wird auf <tt>enable :sessions</tt>
verzichtet und die Middleware wie blich im Programm eingebunden:

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

Um die Sicherheit zu erhhen, werden Cookies, die Session-Daten fhren, mit
einem sogenannten Session-Secret signiert. Da sich dieses Geheimwort bei jedem
Neustart der Applikation automatisch ndert, ist es sinnvoll, ein eigenes zu
whlen, damit sich alle Instanzen der Applikation dasselbe Session-Secret
teilen:

  set :session_secret, 'super secret'

Zur weiteren Konfiguration kann man einen Hash mit Optionen in den +sessions+
Einstellungen ablegen.

  set :sessions, :domain => 'foo.com'

== Anhalten

Zum sofortigen Stoppen eines Request in einem Filter oder einer Route:

  halt

Der Status kann beim Stoppen auch angegeben werden:

  halt 410

Oder auch den Response-Body:

  halt 'Hier steht der Body'

Oder beides:

  halt 401, 'verschwinde!'

Sogar mit Headern:

  halt 402, {'Content-Type' => 'text/plain'}, 'Rache'

Natrlich ist es auch mglich, ein Template mit +halt+ zu verwenden:

  halt erb(:error)

== Weiterspringen

Eine Route kann mittels <tt>pass</tt> zu der nchsten passenden Route springen:

  get '/raten/:wer' do
    pass unless params[:wer] == 'Frank'
    'Du hast mich!'
  end

  get '/raten/*' do
    'Du hast mich nicht!'
  end

Der Block wird sofort verlassen und es wird nach der nchsten treffenden Route
gesucht. Ein 404-Fehler wird zurckgegeben, wenn kein treffendes Routen-Muster
gefunden wird.

=== Eine andere Route ansteuern

Manchmal entspricht +pass+ nicht den Anforderungen, wenn das Ergebnis einer
anderen Route gefordert wird. Um das zu erreichen, lsst sich +call+ nutzen:

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

Beachte, dass in dem oben angegeben Beispiel die Performance erheblich erhht
werden kann, wenn <tt>"bar"</tt> in eine Helfer-Methode umgewandelt wird, auf
die <tt>/foo</tt> und <tt>/bar</tt> zugreifen knnen.

Wenn der Request innerhalb derselben Applikations-Instanz aufgerufen und keine
Kopie der Instanz erzeugt werden soll, kann <tt>call!</tt> anstelle von
+call+ verwendet werden.

Die Rack-Spezifikationen enthalten weitere Informationen zu +call+.

=== Body, Status-Code und Header setzen

Es ist mglich und empfohlen, den Status-Code sowie den Response-Body mit einem
Returnwert in der Route zu setzen. In manchen Situationen kann es jedoch sein,
dass der Body an irgendeiner anderen Stelle whrend der Ausfhrung gesetzt
wird. Das lsst sich mit der Helfer-Methode +body+ bewerkstelligen. Wird +body+
verwendet, lsst sich der Body jederzeit ber diese Methode aufrufen:

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

Ebenso ist es mglich, einen Block an +body+ weiterzureichen, der dann vom
Rack-Handler ausgefhrt wird (lsst sich z.B. zur Umsetzung von Streaming
einsetzen, siehe auch "Rckgabewerte").

Vergleichbar mit +body+ lassen sich auch Status-Code und Header setzen:

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    halt "Ich bin ein Teekesselchen"
  end

Genau wie bei +body+ liest ein Aufrufen von +headers+ oder +status+ ohne
Argumente den aktuellen Wert aus.

=== Response-Streams

In manchen Situationen sollen Daten bereits an den Client zurckgeschickt
werden, bevor ein vollstndiger Response bereit steht. Manchmal will man die
Verbindung auch erst dann beenden und Daten so lange an den Client
zurckschicken, bis er die Verbindung abbricht. Fr diese Flle gibt es die
+stream+-Helfer-Methode, die es einem erspart eigene Lsungen zu schreiben:

  get '/' do
    stream do |out|
      out << "Das ist ja mal wieder fanta -\n"
      sleep 0.5
      out << " (bitte warten) \n"
      sleep 1
      out << "- stisch!\n"
    end
  end

Damit lassen sich Streaming-APIs realisieren, sog.
{Server Sent Events}[http://dev.w3.org/html5/eventsource/] die als Basis fr
{WebSockets}[http://en.wikipedia.org/wiki/WebSocket] dienen. Ebenso knnen sie
verwendet werden, um den Durchsatz zu erhhen, wenn ein Teil der Daten von
langsamen Ressourcen abhngig ist.

Es ist zu beachten, dass das Verhalten beim Streaming, insbesondere die Anzahl
nebenlufiger Anfragen, stark davon abhngt, welcher Webserver fr die
Applikation verwendet wird. Einige Server, z.B. WEBRick, untersttzen Streaming
nicht oder nur teilweise. Sollte der Server Streaming nicht untersttzen, wird
ein vollstndiger Response-Body zurckgeschickt, sobald der an +stream+
weitergegebene Block abgearbeitet ist. Mit Shotgun funktioniert Streaming z.B.
berhaupt nicht.

Ist der optionale Parameter +keep_open+ aktiviert, wird beim gestreamten Objekt
+close+ nicht aufgerufen und es ist einem berlassen dies an einem beliebigen
spteren Zeitpunkt nachholen. Die Funktion ist jedoch nur bei Event-gesteuerten 
Serven wie Thin oder Rainbows mglich, andere Server werden trotzdem den Stream 
beenden:

  set :server, :thin
  connections = []

  get '/' do
    # Den Stream offen halten
    stream(:keep_open) { |out| connections << out }
  end

  post '/' do
    # In alle offenen Streams schreiben
    connections.each { |out| out << params[:message] << "\n" }
    "Nachricht verschickt"
  end

=== Logger

Im Geltungsbereich eines Request stellt die +logger+ Helfer-Methode eine
+Logger+ Instanz zur Verfgung:

  get '/' do
    logger.info "es passiert gerade etwas"
    # ...
  end

Der Logger bernimmt dabei automatisch alle im Rack-Handler eingestellten Log-
Vorgaben. Ist Loggen ausgeschaltet, gibt die Methode ein Leerobjekt zurck.
In den Routen und Filtern muss man sich also nicht weiter darum kmmern.

Beachte, dass das Loggen standardmig nur fr <tt>Sinatra::Application</tt>
voreingestellt ist. Wird ber <tt>Sinatra::Base</tt> vererbt, muss es erst
aktiviert werden:

  class MyApp < Sinatra::Base
    configure :production, :development  do
      enable :logging
    end
  end

Damit auch keine Middleware das Logging aktivieren kann, muss die +logging+
Einstellung auf +nil+ gesetzt werden. Das heit aber auch, dass +logger+ in
diesem Fall +nil+ zurckgeben wird. blicherweise wird das eingesetzt, wenn ein
eigener Logger eingerichtet werden soll. Sinatra wird dann verwenden, was in
<tt>env['rack.logger']</tt> eingetragen ist.

== Mime-Types

Wenn <tt>send_file</tt> oder statische Dateien verwendet werden, kann es
vorkommen, dass Sinatra den Mime-Typ nicht kennt. Registriert wird dieser mit
+mime_type+ per Dateiendung:

  configure do
    mime_type :foo, 'text/foo'
  end

Es kann aber auch der +content_type+-Helfer verwendet werden:

  get '/' do
    content_type :foo
    "foo foo foo"
  end

=== URLs generieren

Zum Generieren von URLs sollte die +url+-Helfer-Methode genutzen werden, so
z.B. beim Einsatz von Haml:

  %a{:href => url('/foo')} foo

Soweit vorhanden, wird Rcksicht auf Proxys und Rack-Router genommen.

Diese Methode ist ebenso ber das Alias +to+ zu erreichen (siehe Beispiel
unten).

=== Browser-Umleitung

Eine Browser-Umleitung kann mithilfe der +redirect+-Helfer-Methode erreicht
werden:

  get '/foo' do
    redirect to('/bar')
  end

Weitere Parameter werden wie Argumente der +halt+-Methode behandelt:

  redirect to('/bar'), 303
  redirect 'http://google.com', 'Hier bist du falsch'

Ebenso leicht lsst sich ein Schritt zurck mit dem Alias
<tt>redirect back</tt> erreichen:

  get '/foo' do
    "<a href='/bar'>mach was</a>"
  end

  get '/bar' do
    mach_was
    redirect back
  end

Um Argumente an ein Redirect weiterzugeben, knnen sie entweder dem Query
bergeben:

  redirect to('/bar?summe=42')

oder eine Session verwendet werden:

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end


=== Cache einsetzen

Ein sinnvolles Einstellen von Header-Daten ist die Grundlage fr ein
ordentliches HTTP-Caching.

Der Cache-Control-Header lsst sich ganz einfach einstellen:

  get '/' do
    cache_control :public
    "schon gecached!"
  end

Profitipp: Caching im before-Filter aktivieren

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

Bei Verwendung der +expires+-Helfermethode zum Setzen des gleichnamigen
Headers, wird <tt>Cache-Control</tt> automatisch eigestellt:

  before do
    expires 500, :public, :must_revalidate
  end

Um alles richtig zu machen, sollten auch +etag+ oder +last_modified+ verwendet
werden. Es wird empfohlen, dass diese Helfer aufgerufen werden *bevor* die
eigentliche Arbeit anfngt, da sie sofort eine Antwort senden, wenn der
Client eine aktuelle Version im Cache vorhlt:

  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end

ebenso ist es mglich einen
{schwachen ETag}[http://de.wikipedia.org/wiki/HTTP_ETag] zu verwenden:

  etag @article.sha1, :weak

Diese Helfer fhren nicht das eigentliche Caching aus, sondern geben die dafr
notwendigen Informationen an den Cache weiter. Fr schnelle Reverse-Proxy
Cache-Lsungen bietet sich z.B.
{rack-cache}[http://rtomayko.github.com/rack-cache/] an:

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

Um den <tt>Cache-Control</tt>-Header mit Informationen zu versorgen, verwendet
man die <tt>:static_cache_control</tt>-Einstellung (s.u.).

Nach RFC 2616 sollte sich die Anwendung anders verhalten, wenn ein
If-Match oder ein If-None_match Header auf <tt>*</tt> gesetzt wird in
Abhngigkeit davon, ob die Resource bereits existiert. Sinatra geht
davon aus, dass Ressourcen bei sicheren Anfragen (z.B. bei get oder Idempotenten
Anfragen wie put) bereits existieren, wobei anderen Ressourcen
(besipielsweise bei post), als neue Ressourcen behandelt werden. Dieses
Verhalten lsst sich mit der <tt>:new_resource</tt> Option ndern:

  get '/create' do
    etag '', :new_resource => true
    Article.create
    erb :new_article
  end

Soll das schwache ETag trotzdem verwendet werden, verwendet man die
<tt>:kind</tt> Option:

  etag '', :new_resource => true, :kind => :weak

=== Dateien versenden

Zum Versenden von Dateien kann die <tt>send_file</tt>-Helfer-Methode verwendet
werden:

  get '/' do
    send_file 'foo.png'
  end

Fr <tt>send_file</tt> stehen einige Hash-Optionen zur Verfgung:

  send_file 'foo.png', :type => :jpg

[filename]
  Dateiname als Response. Standardwert ist der eigentliche Dateiname.

[last_modified]
  Wert fr den Last-Modified-Header, Standardwert ist +mtime+ der Datei.

[type]
  Content-Type, der verwendet werden soll. Wird, wenn nicht angegeben, von der
  Dateiendung abgeleitet.

[disposition]
  Verwendet fr Content-Disposition. Mgliche Werte sind: +nil+ (Standard),
  <tt>:attachment</tt> und <tt>:inline</tt>.

[length]
  Content-Length-Header. Standardwert ist die Dateigre.

Soweit vom Rack-Handler untersttzt, werden neben der bertragung ber den
Ruby-Prozess auch andere Mglichkeiten genutzt. Bei Verwendung der
<tt>send_file</tt>-Helfer-Methode kmmert sich Sinatra selbststndig um die
Range-Requests.

== Das Request-Objekt

Auf das +request+-Objekt der eigehenden Anfrage kann vom Anfrage-Scope aus
zugegriffen werden:

  # App luft unter http://example.com/example
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                # Request-Body des Client (siehe unten)
    request.scheme              # "http"
    request.script_name         # "/example"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      # Lnge des request.body
    request.media_type          # Medientypus von request.body
    request.host                # "example.com"
    request.get?                # true (hnliche Methoden fr andere Verben)
    request.form_data?          # false
    request["IRGENDEIN_HEADER"] # Wert von IRGENDEIN_HEADER header
    request.referrer            # Der Referrer des Clients oder '/'
    request.user_agent          # User-Agent (verwendet in der :agent Bedingung)
    request.cookies             # Hash des Browser-Cookies
    request.xhr?                # Ist das hier ein Ajax-Request?
    request.url                 # "http://example.com/example/foo"
    request.path                # "/example/foo"
    request.ip                  # IP-Adresse des Clients
    request.secure?             # false (true wenn SSL)
    request.forwarded?          # true (Wenn es hinter einem Reverse-Proxy verwendet wird)
    request.env                 # vollstndiger env-Hash von Rack bergeben
  end

Manche Optionen, wie etwa <tt>script_name</tt> oder <tt>path_info</tt>, sind
auch schreibbar:

  before { request.path_info = "/" }

  get "/" do
    "Alle Anfragen kommen hier an!"
  end

Der <tt>request.body</tt> ist ein IO- oder StringIO-Objekt:

  post "/api" do
    request.body.rewind # falls schon jemand davon gelesen hat
    daten = JSON.parse request.body.read
    "Hallo #{daten['name']}!"
  end

=== Anhnge

Damit der Browser erkennt, dass ein Response gespeichert und nicht im Browser
angezeigt werden soll, kann der +attachment+-Helfer verwendet werden:

  get '/' do
    attachment
    "Speichern!"
  end

Ebenso kann eine Dateiname als Parameter hinzugefgt werden:

  get '/' do
    attachment "info.txt"
    "Speichern!"
  end

=== Umgang mit Datum und Zeit

Sinatra bietet eine <tt>time_for</tt>-Helfer-Methode, die aus einem gegebenen
Wert ein Time-Objekt generiert. Ebenso kann sie nach +DateTime+, +Date+ und
hnliche Klassen konvertieren:

  get '/' do
    pass if Time.now > time_for('Dec 23, 2012')
    "noch Zeit"
  end

Diese Methode wird intern fr +expires, +last_modiefied+ und Freunde verwendet.
Mit ein paar Handgriffen lsst sich diese Methode also in ihrem Verhalten
erweitern, indem man +time_for+ in der eigenen Applikation berschreibt:

  helpers do
    def time_for(value)
      case value
      when :yesterday then Time.now - 24*60*60
      when :tomorrow  then Time.now + 24*60*60
      else super
      end
    end
  end

  get '/' do
    last_modified :yesterday
    expires :tomorrow
    "Hallo"
  end

=== Nachschlagen von Template-Dateien

Die <tt>find_template</tt>-Helfer-Methode wird genutzt, um Template-Dateien zum
Rendern aufzufinden:

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "knnte diese hier sein: #{file}"
  end

Das ist zwar nicht wirklich brauchbar, aber wenn man sie berschreibt, kann sie
ntzlich werden, um eigene Nachschlage-Mechanismen einzubauen. Zum Beispiel
dann, wenn mehr als nur ein view-Verzeichnis verwendet werden soll:

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

Ein anderes Beispiel wre, verschiedene Vereichnisse fr verschiedene Engines
zu verwenden:

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end

Ebensogut knnte eine Extension aber auch geschrieben und mit anderen geteilt
werden!

Beachte, dass <tt>find_template</tt> nicht prft, ob eine Datei tatschlich
existiert. Es wird lediglich der angegebene Block aufgerufen und nach allen
mglichen Pfaden gesucht. Das ergibt kein Performance-Problem, da +render+
+block+ verwendet, sobald eine Datei gefunden wurde. Ebenso werden
Template-Pfade samt Inhalt gecached, solange nicht im Entwicklungsmodus
gearbeitet wird. Das sollte im Hinterkopf behalten werden, wenn irgendwelche
verrckten Methoden zusammenbastelt werden.

== Konfiguration

Wird einmal beim Starten in jedweder Umgebung ausgefhrt:

  configure do
    # setze eine Option
    set :option, 'wert'

    # setze mehrere Optionen
    set :a => 1, :b => 2

    # das gleiche wie `set :option, true`
    enable :option

    # das gleiche wie `set :option, false`
    disable :option

    # dynamische Einstellungen mit Blcken
    set(:css_dir) { File.join(views, 'css') }
  end

Luft nur, wenn die Umgebung (RACK_ENV-Umgebungsvariable) auf
<tt>:production</tt> gesetzt ist:

  configure :production do
    ...
  end

Luft nur, wenn die Umgebung auf <tt>:production</tt> oder auf <tt>:test</tt>
gesetzt ist:

  configure :production, :test do
    ...
  end

Diese Einstellungen sind ber +settings+ erreichbar:

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

=== Einstellung des Angriffsschutzes

Sinatra verwendet
{Rack::Protection}[https://github.com/rkh/rack-protection#readme], um die
Anwendung vor hufig vorkommenden Angriffen zu schtzen. Diese Voreinstellung
lsst sich selbstverstndlich auch deaktivieren, z.B. um
Geschwindigkeitsvorteile zu gewinnen:

  disable :protection

Um einen bestimmten Schutzmechanismus zu deaktivieren, fgt man +protection+
einen Hash mit Optionen hinzu:

  set :protection, :except => :path_traversal

Neben Strings akzeptiert <tt>:except</tt> auch Arrays, um gleich mehrere
Schutzmechanismen zu deaktivieren:

  set :protection, :except => [:path_traversal, :session_hijacking]

=== Mgliche Einstellungen

[absolute_redirects]    Wenn ausgeschaltet, wird Sinatra relative Redirects
                        zulassen. Jedoch ist Sinatra dann nicht mehr mit RFC
                        2616 (HTTP 1.1) konform, das nur absolute Redirects
                        zulsst.

                        Sollte eingeschaltet werden, wenn die Applikation
                        hinter einem Reverse-Proxy liegt, der nicht ordentlich
                        eingerichtet ist. Beachte, dass die
                        +url+-Helfer-Methode nach wie vor absolute URLs
                        erstellen wird, es sei denn, es wird als zweiter
                        Parameter +false+ angegeben.

                        Standardmig nicht aktiviert.

[add_charsets]          Mime-Types werden hier automatisch der Helfer-Methode
                        <tt>content_type</tt> zugeordnet.

                        Es empfielt sich, Werte hinzuzufgen statt sie zu
                        berschreiben:

                          settings.add_charsets << "application/foobar"

[app_file]              Pfad zur Hauptdatei der Applikation. Wird verwendet, um
                        das Wurzel-, Inline-, View- und ffentliche Verzeichnis
                        des Projekts festzustellen.

[bind]                  IP-Address, an die gebunden wird
                        (Standardwert: 0.0.0.0). Wird nur fr den eingebauten
                        Server verwendet.

[default_encoding]      Das Encoding, falls keines angegeben wurde.
                        Standardwert ist <tt>"utf-8"</tt>.

[dump_errors]           Fehler im Log anzeigen.

[environment]           Momentane Umgebung. Standardmig auf
                        <tt>content_type</tt> oder <tt>"development"</tt>
                        eingestellt, soweit ersteres nicht vorhanden.

[logging]               Den Logger verwenden.

[lock]                  Jeder Request wird gelocked. Es kann nur ein Request
                        pro Ruby-Prozess gleichzeitig verarbeitet werden.

                        Eingeschaltet, wenn die Applikation threadsicher ist.
                        Standardmig nicht aktiviert.

[method_override]       Verwende <tt>_method</tt>, um put/delete-Formulardaten
                        in Browsern zu verwenden, die dies normalerweise nicht
                        untersttzen.

[port]                  Port fr die Applikation. Wird nur im internen Server
                        verwendet.

[prefixed_redirects]    Entscheidet, ob <tt>request.script_name</tt> in
                        Redirects eingefgt wird oder nicht, wenn kein
                        absoluter Pfad angegeben ist. Auf diese Weise verhlt
                        sich <tt>redirect '/foo'</tt> so, als wre es ein
                        <tt>redirect to('/foo')</tt>. Standardmig nicht
                        aktiviert.

[protection]            Legt fest, ob der Schutzmechanismus fr hufig
                        Vorkommende Webangriffe auf Webapplikationen aktiviert
                        wird oder nicht. Weitere Informationen im vorhergehenden
                        Abschnitt.

[public_folder]         Das ffentliche Verzeichnis, aus dem Daten zur
                        Verfgung gestellt werden knnen. Wird nur dann
                        verwendet, wenn statische Daten zur Verfgung
                        gestellt werden knnen (s.u. <tt>static</tt>
                        Option). Leitet sich von der <tt>app_file</tt>
                        Einstellung ab, wenn nicht gesetzt.

[reload_templates]      Im development-Modus aktiviert.

[root]                  Wurzelverzeichnis des Projekts. Leitet sich von der
                        <tt>app_file</tt> Einstellung ab, wenn nicht gesetzt.

[raise_errors]          Einen Ausnahmezustand aufrufen. Beendet die
                        Applikation. Ist automatisch aktiviert, wenn die
                        Umgebung auf <tt>"test"</tt> eingestellt ist.
                        Ansonsten ist diese Option deaktiviert.

[run]                   Wenn aktiviert, wird Sinatra versuchen, den Webserver
                        zu starten. Nicht verwenden, wenn Rackup oder anderes
                        verwendet werden soll.

[running]               Luft der eingebaute Server? Diese Einstellung nicht
                        ndern!

[server]                Server oder Liste von Servern, die als eingebaute
                        Server zur Verfgung stehen.
                        Standardmig auf ['thin', 'mongrel', 'webrick']
                        voreingestellt. Die Anordnung gibt die Prioritt vor.

[sessions]              Sessions auf Cookiebasis mittels
                        <tt>Rack::Session::Cookie</tt>aktivieren. Fr
                        weitere Infos bitte in der Sektion 'Sessions
                        verwenden' nachschauen.

[show_exceptions]       Bei Fehlern einen Stacktrace im Browseranzeigen. Ist
                        automatisch aktiviert, wenn die Umgebung auf
                        <tt>"development"</tt> eingestellt ist. Ansonsten ist
                        diese Option deaktiviert.


[static]                Entscheidet, ob Sinatra statische Dateien zur Verfgung
                        stellen soll oder nicht.
                        Sollte nicht aktiviert werden, wenn ein Server
                        verwendet wird, der dies auch selbststndig erledigen
                        kann. Deaktivieren wird die Performance erhhen.
                        Standardmig aktiviert.

[static_cache_control]  Wenn Sinatra statische Daten zur Verfgung stellt,
                        knnen mit dieser Einstellung die +Cache-Control+
                        Header zu den Responses hinzugefgt werden. Die
                        Einstellung verwendet dazu die +cache_control+
                        Helfer-Methode. Standardmig deaktiviert.
                        Ein Array wird verwendet, um mehrere Werte gleichzeitig
                        zu bergeben:
                        <tt>set :static_cache_control, [:public, :max_age => 300]</tt>

[views]                 Verzeichnis der Views. Leitet sich von der
                        <tt>app_file</tt> Einstellung ab, wenn nicht gesetzt.

== Umgebungen

Es gibt drei voreingestellte Umgebungen in Sinatra: <tt>"development"</tt>,
<tt>"production"</tt> und <tt>"test"</tt>. Umgebungen knnen ber die
+RACK_ENV+ Umgebungsvariable gesetzt werden. Die Standardeinstellung ist
<tt>"development"</tt>. In diesem Modus werden alle Templates zwischen
Requests neu geladen. Dazu gibt es besondere Fehlerseiten fr 404 Stati
und Fehlermeldungen. In <tt>"production"</tt> und <tt>"test"</tt> werden
Templates automatisch gecached.

Um die Anwendung in einer anderen Umgebung auszufhren kann man die
<tt>-e</tt> Option verwenden:

  ruby my_app.rb -e [ENVIRONMENT]

In der Anwendung kann man die die Methoden  +development?+, +test?+ und
+production?+ verwenden, um die aktuelle Umgebung zu erfahren.

== Fehlerbehandlung

Error-Handler laufen in demselben Kontext wie Routen und Filter, was bedeutet,
dass alle Goodies wie <tt>haml</tt>, <tt>erb</tt>, <tt>halt</tt>, etc.
verwendet werden knnen.

=== Nicht gefunden

Wenn eine <tt>Sinatra::NotFound</tt>-Exception geworfen wird oder der
Statuscode 404 ist, wird der <tt>not_found</tt>-Handler ausgefhrt:

  not_found do
    'Seite kann nirgendwo gefunden werden.'
  end

=== Fehler

Der +error+-Handler wird immer ausgefhrt, wenn eine Exception in einem
Routen-Block oder in einem Filter geworfen wurde. Die Exception kann ber die
<tt>sinatra.error</tt>-Rack-Variable angesprochen werden:

  error do
    'Entschuldige, es gab einen hsslichen Fehler - ' + env['sinatra.error'].name
  end

Benutzerdefinierte Fehler:

  error MeinFehler do
    'Au weia, ' + env['sinatra.error'].message
  end

Dann, wenn das passiert:

  get '/' do
    raise MeinFehler, 'etwas Schlimmes ist passiert'
  end

bekommt man dieses:

  Au weia, etwas Schlimmes ist passiert

Alternativ kann ein Error-Handler auch fr einen Status-Code definiert werden:

  error 403 do
    'Zugriff verboten'
  end

  get '/geheim' do
    403
  end

Oder ein Status-Code-Bereich:

  error 400..510 do
    'Hallo?'
  end

Sinatra setzt verschiedene <tt>not_found</tt>- und <tt>error</tt>-Handler in
der Development-Umgebung.

== Rack-Middleware

Sinatra baut auf Rack[http://rack.rubyforge.org/], einem minimalistischen
Standard-Interface fr Ruby-Webframeworks. Eines der interessantesten
Features fr Entwickler ist der Support von Middlewares, die zwischen den
Server und die Anwendung geschaltet werden und so HTTP-Request und/oder Antwort
berwachen und/oder manipulieren knnen.

Sinatra macht das Erstellen von Middleware-Verkettungen mit der
Top-Level-Methode +use+ zu einem Kinderspiel:

  require 'sinatra'
  require 'meine_middleware'

  use Rack::Lint
  use MeineMiddleware

  get '/hallo' do
    'Hallo Welt'
  end

Die Semantik von +use+ entspricht der gleichnamigen Methode der
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html]-DSL
(meist verwendet in Rackup-Dateien). Ein Beispiel dafr ist, dass die
+use+-Methode mehrere/verschiedene Argumente und auch Blcke entgegennimmt:

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'geheim'
  end

Rack bietet eine Vielzahl von Standard-Middlewares fr Logging, Debugging,
URL-Routing, Authentifizierung und Session-Verarbeitung. Sinatra verwendet
viele von diesen Komponenten automatisch, abhngig von der Konfiguration. So
muss +use+ hufig nicht explizit verwendet werden.

Hilfreiche Middleware gibt es z.B. hier:
{rack}[https://github.com/rack/rack/tree/master/lib/rack],
{rack-contrib}[https://github.com/rack/rack-contrib#readme],
mit {CodeRack}[http://coderack.org/] oder im
{Rack wiki}[https://github.com/rack/rack/wiki/List-of-Middleware].

== Testen

Sinatra-Tests knnen mit jedem auf Rack aufbauendem Test-Framework geschrieben
werden. {Rack::Test}[http://rdoc.info/github/brynary/rack-test/master/frames]
wird empfohlen:

  require 'my_sinatra_app'
  require 'test/unit'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hallo Welt!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hallo Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Du verwendest Songbird!", last_response.body
    end
  end

== Sinatra::Base - Middleware, Bibliotheken und modulare Anwendungen

Das Definieren einer Top-Level-Anwendung funktioniert gut fr
Mikro-Anwendungen, hat aber Nachteile, wenn wiederverwendbare Komponenten wie
Middleware, Rails Metal, einfache Bibliotheken mit Server-Komponenten oder auch
Sinatra-Erweiterungen geschrieben werden sollen.

Das Top-Level geht von einer Konfiguration fr eine Mikro-Anwendung aus
(wie sie z.B. bei einer einzelnen Anwendungsdatei, <tt>./public</tt>
und <tt>./views</tt> Ordner, Logging, Exception-Detail-Seite, usw.). Genau
hier kommt <tt>Sinatra::Base</tt> ins Spiel:

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hallo Welt!'
    end
  end

Die MyApp-Klasse ist eine unabhngige Rack-Komponente, die als Middleware,
Endpunkt oder via Rails Metal verwendet werden kann. Verwendet wird sie durch
+use+ oder +run+ von einer Rackup-<tt>config.ru</tt>-Datei oder als
Server-Komponente einer Bibliothek:

   MyApp.run! :host => 'localhost', :port => 9090

Die Methoden der <tt>Sinatra::Base</tt>-Subklasse sind genau dieselben wie die
der Top-Level-DSL. Die meisten Top-Level-Anwendungen knnen mit nur zwei
Vernderungen zu <tt>Sinatra::Base</tt> konvertiert werden:

* Die Datei sollte <tt>require 'sinatra/base'</tt> anstelle von
  <tt>require 'sinatra/base'</tt> aufrufen, ansonsten werden alle von
  Sinatras DSL-Methoden in den Top-Level-Namespace importiert.
* Alle Routen, Error-Handler, Filter und Optionen der Applikation mssen in
  einer Subklasse von <tt>Sinatra::Base</tt> definiert werden.

<tt>Sinatra::Base</tt> ist ein unbeschriebenes Blatt. Die meisten Optionen sind
per Standard deaktiviert. Das betrifft auch den eingebauten Server. Siehe
{Optionen und Konfiguration}[http://sinatra.github.com/configuration.html] fr
Details ber mgliche Optionen.

=== Modularer vs. klassischer Stil

Entgegen hufiger Meinungen gibt es nichts gegen den klassischen Stil
einzuwenden. Solange es die Applikation nicht beeintrchtigt, besteht kein
Grund, eine modulare Applikation zu erstellen.

Der grte Nachteil der klassischen Sinatra Anwendung gegenber einer modularen
ist die Einschrnkung auf eine Sinatra Anwendung pro Ruby-Prozess. Sollen
mehrere zum Einsatz kommen, muss auf den modularen Stil umgestiegen werden.
Dabei ist es kein Problem klassische und modulare Anwendungen miteinander zu
vermischen.

Bei einem Umstieg, sollten einige Unterschiede in den Einstellungen beachtet
werden:

  Szenario            Classic                 Modular

  app_file            sinatra ladende Datei   Sinatra::Base subklassierende Datei
  run                 $0 == app_file          false
  logging             true                    false
  method_override     true                    false
  inline_templates    true                    false

=== Eine modulare Applikation bereitstellen

Es gibt zwei bliche Wege, eine modulare Anwendung zu starten. Zum einen ber
<tt>run!</tt>:

  # mein_app.rb
  require 'sinatra/base'

  class MeinApp < Sinatra::Base
    # ... Anwendungscode hierhin ...

    # starte den Server, wenn die Ruby-Datei direkt ausgefhrt wird
    run! if app_file == $0
  end

Starte mit:

  ruby mein_app.rb

Oder ber eine <tt>config.ru</tt>-Datei, die es erlaubt, einen beliebigen
Rack-Handler zu verwenden:

  # config.ru
  require './mein_app'
  run MeineApp

Starte:

  rackup -p 4567

=== Eine klassische Anwendung mit einer config.ru verwenden

Schreibe eine Anwendungsdatei:

  # app.rb
  require 'sinatra'

  get '/' do
    'Hallo Welt!'
  end

sowie eine dazugehrige <tt>config.ru</tt>-Datei:

  require './app'
  run Sinatra::Application

=== Wann sollte eine config.ru-Datei verwendet werden?

Anzeichen dafr, dass eine <tt>config.ru</tt>-Datei gebraucht wird:

* Es soll ein anderer Rack-Handler verwendet werden (Passenger, Unicorn,
  Heroku, ...).
* Es gibt mehr als nur eine Subklasse von <tt>Sinatra::Base</tt>.
* Sinatra soll als Middleware verwendet werden, nicht als Endpunkt.

<b>Es gibt keinen Grund, eine <tt>config.ru</tt>-Datei zu verwenden, nur weil
eine Anwendung im modularen Stil betrieben werden soll. Ebenso wird keine
Anwendung mit modularem Stil bentigt, um eine <tt>config.ru</tt>-Datei zu
verwenden.</b>

=== Sinatra als Middleware nutzen

Es ist nicht nur mglich, andere Rack-Middleware mit Sinatra zu nutzen, es kann
auerdem jede Sinatra-Anwendung selbst als Middleware vor jeden beliebigen
Rack-Endpunkt gehangen werden. Bei diesem Endpunkt muss es sich nicht um eine
andere Sinatra-Anwendung handeln, es kann jede andere Rack-Anwendung sein
(Rails/Ramaze/Camping/...):

  require 'sinatra/base'

  class LoginScreen < Sinatra::Base
    enable :sessions

    get('/login') { haml :login }

    post('/login') do
      if params[:name] == 'admin' && params[:password] == 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end

  class MyApp < Sinatra::Base
    # Middleware wird vor Filtern ausgefhrt
    use LoginScreen

    before do
      unless session['user_name']
        halt "Zugriff verweigert, bitte <a href='/login'>einloggen</a>."
      end
    end

    get('/') { "Hallo #{session['user_name']}." }
  end

=== Dynamische Applikationserstellung

Manche Situationen erfordern die Erstellung neuer Applikationen zur Laufzeit,
ohne dass sie einer Konstanten zugeordnet werden. Dies lsst sich mit
<tt>Sinatra.new</tt> erreichen:

  require 'sinatra/base'
  my_app = Sinatra.new { get('/') { "hallo" } }
  my_app.run!

Die Applikation kann mit Hilfe eines optionalen Parameters erstellt werden:

  # config.ru
  require 'sinatra/base'

  controller = Sinatra.new do
    enable :logging
    helpers MyHelpers
  end

  map('/a') do
    run Sinatra.new(controller) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controller) { get('/') { 'b' } }
  end

Das ist besonders dann interessant, wenn Sinatra-Erweiterungen getestet werden
oder Sinatra in einer Bibliothek Verwendung findet.

Ebenso lassen sich damit hervorragend Sinatra-Middlewares erstellen:

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run RailsProject::Application

== Geltungsbereich und Bindung

Der Geltungsbereich (Scope) legt fest, welche Methoden und Variablen zur
Verfgung stehen.

=== Anwendungs- oder Klassen-Scope

Jede Sinatra-Anwendung entspricht einer <tt>Sinatra::Base</tt>-Subklasse. Falls
die Top- Level-DSL verwendet wird (<tt>require 'sinatra'</tt>), handelt es sich
um <tt>Sinatra::Application</tt>, andernfalls ist es jene Subklasse, die
explizit angelegt wurde. Auf Klassenebene stehen Methoden wie +get+ oder
+before+ zur Verfgung, es gibt aber keinen Zugriff auf das +request+-Object
oder die +session+, da nur eine einzige Klasse fr alle eingehenden Anfragen
genutzt wird.

Optionen, die via +set+ gesetzt werden, sind Methoden auf Klassenebene:

  class MyApp < Sinatra::Base
    # Hey, ich bin im Anwendungsscope!
    set :foo, 42
    foo # => 42

    get '/foo' do
      # Hey, ich bin nicht mehr im Anwendungs-Scope!
    end
  end

Im Anwendungs-Scope befindet man sich:

* In der Anwendungs-Klasse.
* In Methoden, die von Erweiterungen definiert werden.
* Im Block, der an +helpers+ bergeben wird.
* In Procs und Blcken, die an +set+ bergeben werden.
* Der an <tt>Sinatra.new</tt> bergebene Block

Auf das Scope-Objekt (die Klasse) kann wie folgt zugegriffen werden:

* ber das Objekt, das an den +configure+-Block bergeben wird (<tt>configure
  { |c| ... }</tt>).
* +settings+ aus den anderen Scopes heraus.

=== Anfrage- oder Instanz-Scope

Fr jede eingehende Anfrage wird eine neue Instanz der Anwendungs-Klasse
erstellt und alle Handler in diesem Scope ausgefhrt. Aus diesem Scope
heraus kann auf +request+ oder +session+ zugegriffen und Methoden wie +erb+
oder +haml+ aufgerufen werden. Auerdem kann mit der +settings+-Method auf den
Anwendungs-Scope zugegriffen werden:

  class MyApp < Sinatra::Base
    # Hey, ich bin im Anwendungs-Scope!
    get '/neue_route/:name' do
      # Anfrage-Scope fr '/neue_route/:name'
      @value = 42

      settings.get "/#{params[:name]}" do
        # Anfrage-Scope fr "/#{params[:name]}"
        @value # => nil (nicht dieselbe Anfrage)
      end

      "Route definiert!"
    end
  end

Im Anfrage-Scope befindet man sich:

* In get/head/post/put/delete-Blcken
* In before/after-Filtern
* In Helfer-Methoden
* In Templates

=== Delegation-Scope

Vom Delegation-Scope aus werden Methoden einfach an den Klassen-Scope
weitergeleitet. Dieser verhlt sich jedoch nicht 100%ig wie der Klassen-Scope,
da man nicht die Bindung der Klasse besitzt: Nur Methoden, die explizit als
delegierbar markiert wurden, stehen hier zur Verfgung und es kann nicht auf
die Variablen des Klassenscopes zugegriffen werden (mit anderen Worten: es gibt
ein anderes +self+). Weitere Delegationen knnen mit
<tt>Sinatra::Delegator.delegate :methoden_name</tt> hinzugefgt werden.

Im Delegation-Scop befindet man sich:

* Im Top-Level, wenn <tt>require 'sinatra'</tt> aufgerufen wurde.
* In einem Objekt, das mit dem <tt>Sinatra::Delegator</tt>-Mixin erweitert
  wurde.

Schau am besten im Code nach: Hier ist
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb#L1064]
definiert und wird in den
{globalen Namespace eingebunden}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/main.rb#L25].

== Kommandozeile

Sinatra-Anwendungen knnen direkt von der Kommandozeile aus gestartet werden:

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-h HOST] [-s HANDLER]

Die Optionen sind:

  -h # Hilfe
  -p # Port setzen (Standard ist 4567)
  -h # Host setzen (Standard ist 0.0.0.0)
  -e # Umgebung setzen (Standard ist development)
  -s # Rack-Server/Handler setzen (Standard ist thin)
  -x # Mutex-Lock einschalten (Standard ist off)

== Systemanforderungen

Die folgenden Versionen werden offiziell untersttzt:

[ Ruby 1.8.7 ]
  1.8.7 wird vollstndig untersttzt, aber solange nichts dagegen spricht,
  wird ein Update auf 1.9.2 oder ein Umstieg auf JRuby/Rubinius empfohlen.
  Untersttzung fr 1.8.7 wird es mindestens bis Sinatra 2.0 und Ruby 2.0 geben,
  es sei denn, dass der unwahrscheinliche Fall eintritt und 1.8.8 rauskommt.
  Doch selbst dann ist es eher wahrscheinlich, dass 1.8.7 weiterhin untersttzt
  wird. <b>Ruby 1.8.6 wird nicht mehr untersttzt.</b> Soll Sinatra unter 1.8.6
  eingesetzt werden, muss Sinatra 1.2 verwendet werden, dass noch bis zum
  Release von Sinatra 1.4.0 fortgefhrt wird.

[ Ruby 1.9.2 ]
  1.9.2 wird voll untersttzt und empfohlen. Beachte, dass Markaby und Radius
  momentan noch nicht kompatibel mit 1.9 sind. Version 1.9.2p0 sollte nicht
  verwendet werden, da unter Sinatra immer wieder Segfaults auftreten.
  Untersttzung wird es mindestens bis zum Release von Ruby 1.9.4/2.0 geben und
  das letzte Sinatra Release fr 1.9 wird so lange untersttzt, wie das Ruby
  Core-Team 1.9 pflegt.

[ Ruby 1.9.3 ]
  1.9.3 wird vollstndig untersttzt. Momentan wird empfohlen auf einen
  hheren Pachtlevel zu warten, bevor Sinatra in der Produktion
  eingesetzt wird (aktueller Patchlevel ist p0). Bei einem Wechsel zu
  1.9.3 werden alle Sessions ungltig.
  Obwohl Tests bereits auf 1.9.3 laufen, sind bisher keine Applikationen auf
  1.9.3 in Produktion bekannt. Ebenso wie bei 1.9.2 besteht die gleiche Warnung 
  zum Patchlevel 0.

[ Rubinius ]
  Rubinius (rbx >= 1.2.4) wird offiziell unter Einbezug aller Templates
  untersttzt. Die kommende 2.0 Version wird ebenfalls untersttzt.

[ JRuby ]
  JRuby wird offiziell untersttzt (JRuby >= 1.6.5). Probleme mit Template-
  Bibliotheken Dritter sind nicht bekannt. Falls JRuby zum Einsatz kommt,
  sollte aber darauf geachtet werden, dass ein JRuby-Rack-Handler zum Einsatz
  kommt  der Thin-Web-Server wird bisher nicht untersttz. JRubys
  Untersttzung fr C-Erweiterungen sind zur Zeit noch experimenteller Natur,
  betrifft im Moment aber nur RDiscount, Redcarpet und RedCloth.


Weiterhin werden wir auf kommende Ruby-Versionen ein Auge haben.

Die nachfolgend aufgefhrten Ruby-Implementierungen werden offiziell nicht von
Sinatra untersttzt, funktionieren aber normalerweise:

* Ruby Enterprise Edition
* ltere Versionen von JRuby und Rubinius
* MacRuby, Maglev, IronRuby
* Ruby 1.9.0 und 1.9.1 (wird jedoch nicht empfohlen, s.o.)

Nicht offiziell untersttzt bedeutet, dass wenn Sachen nicht funktionieren,
wir davon ausgehen, dass es nicht an Sinatra sondern an der jeweiligen
Implentierung liegt.

Im Rahmen unserer CI (Kontinuierlichen Integration) wird bereits ruby-head
(das kommende Ruby 2.0.0) und 1.9.4 mit eingebunden. Da noch alles im Fluss ist,
kann zur Zeit fr nichts garantiert werden. Es kann aber erwartet werden, dass
Ruby 2.0.0p0 und 1.9.4p0 von Sinatra untersttzt werden wird.

Sinatra sollte auf jedem Betriebssystem laufen, dass den gewhlten Ruby-
Interpreter untersttzt.

Sinatra wird aktuell nicht unter Cardinal, SmallRuby, BleuRuby oder irgendeiner 
Version von Ruby vor 1.8.7 laufen.

== Der neuste Stand (The Bleeding Edge)

Um auf dem neusten Stand zu bleiben, kann der Master-Branch verwendet werden.
Er sollte recht stabil sein. Ebenso gibt es von Zeit zu Zeit prerelease Gems,
die so installiert werden:

  gem install sinatra --pre

=== Mit Bundler

Wenn die Applikation mit der neuesten Version von Sinatra und
{Bundler}[http://gembundler.com/] genutzt werden soll, empfehlen wir den
nachfolgenden Weg.

Soweit Bundler noch nicht installiert ist:

  gem install bundler

Anschlieend wird eine +Gemfile+-Datei im Projektverzeichnis mit folgendem
Inhalt erstellt:

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  # evtl. andere Abhngigkeiten
  gem 'haml'                    # z.B. wenn du Haml verwendest...
  gem 'activerecord', '~> 3.0'  # ...oder ActiveRecord 3.x

Beachte: Hier sollten alle Abhngigkeiten eingetragen werden. Sinatras eigene,
direkte Abhngigkeiten (Tilt und Rack) werden von Bundler automatisch aus dem
Gemfile von Sinatra hinzugefgt.

Jetzt kannst du deine Applikation starten:

  bundle exec ruby myapp.rb

=== Eigenes Repository
Um auf dem neuesten Stand von Sinatras Code zu sein, kann eine lokale Kopie
angelegt werden. Gestartet wird in der Anwendung mit dem <tt>sinatra/lib</tt>-
Ordner im <tt>LOAD_PATH</tt>:

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

Alternativ kann der <tt>sinatra/lib</tt>-Ordner zum <tt>LOAD_PATH</tt> in
der Anwendung hinzugefgt werden:

  $LOAD_PATH.unshift File.dirname(__FILE__) + '/sinatra/lib'
  require 'rubygems'
  require 'sinatra'

  get '/ueber' do
    "Ich laufe auf Version " + Sinatra::VERSION
  end

Um Sinatra-Code von Zeit zu Zeit zu aktualisieren:

  cd myproject/sinatra
  git pull

=== Gem erstellen

Aus der eigenen lokalen Kopie kann nun auch ein globales Gem gebaut werden:

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

Falls Gems als Root installiert werden sollen, sollte die letzte Zeile
folgendermaen lauten:

  sudo rake install

== Versions-Verfahren

Sinatra folgt dem sogenannten {Semantic Versioning}[http://semver.org/], d.h.
SemVer und SemVerTag.

== Mehr

* {Projekt-Website}[http://sinatra.github.com/] - Ergnzende Dokumentation,
  News und Links zu anderen Ressourcen.
* {Mitmachen}[http://sinatra.github.com/contributing.html] - Einen
  Fehler gefunden? Brauchst du Hilfe? Hast du einen Patch?
* {Issue-Tracker}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Mailing-Liste}[http://groups.google.com/group/sinatrarb]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] auf http://freenode.net
* {Sinatra Book}[http://sinatra-book.gittr.com] Kochbuch Tutorial
* {Sinatra Recipes}[http://recipes.sinatrarb.com/] Sinatra-Rezepte aus
  der Community
* API Dokumentation fr die {aktuelle Version}[http://rubydoc.info/gems/sinatra]
  oder fr {HEAD}[http://rubydoc.info/github/sinatra/sinatra] auf
  http://rubydoc.info
* {CI Server}[http://ci.rkh.im/view/Sinatra/]


= Sinatra
<i>Atencin: Este documento es una traduccin de la versin en ingls y puede estar desactualizado.</i>

Sinatra es un DSL para crear aplicaciones web rpidamente en Ruby con un mnimo
esfuerzo:

  # miapp.rb
  require 'sinatra'

  get '/' do
    'Hola mundo!'
  end

Instal la gem y ejecut la aplicacin con:

  gem install sinatra
  ruby -rubygems miapp.rb

Pods verla en: http://localhost:4567

Es recomendable adems ejecutar <tt>gem install thin</tt>, ya que Sinatra lo va
a utilizar cuando est disponible.

== Rutas

En Sinatra, una ruta est compuesta por un mtodo HTTP y un patrn de una URL.
Cada ruta se asocia con un bloque:

  get '/' do
    .. mostrar algo ..
  end

  post '/' do
    .. crear algo ..
  end

  put '/' do
    .. reemplazar algo ..
  end

  patch '/' do
    .. modificar algo ..
  end

  delete '/' do
    .. aniquilar algo ..
  end

  options '/' do
    .. informar algo ..
  end


Las rutas son comparadas en el orden en el que son definidas. La primer ruta
que coincide con la peticin es invocada.

Los patrones de las rutas pueden incluir parmetros nombrados, accesibles a
travs de el hash <tt>params</tt>:

  get '/hola/:nombre' do
    # coincide con "GET /hola/foo" y "GET /hola/bar"
    # params[:nombre] es 'foo' o 'bar'
    "Hola #{params[:nombre]}!"
  end

Tambin pods acceder a los parmetros nombrados usando parmetros de bloque:

  get '/hola/:nombre' do |n|
    "Hola #{n}!"
  end

Los patrones de ruta tambin pueden incluir parmetros splat (o wildcard),
accesibles a travs del arreglo <tt>params[:splat]</tt>:

  get '/decir/*/al/*' do
    # coincide con /decir/hola/al/mundo
    params[:splat] # => ["hola", "mundo"]
  end

  get '/descargar/*.*' do
    # coincide con /descargar/path/al/archivo.xml
    params[:splat] # => ["path/al/archivo", "xml"]
  end

O, con parmetros de bloque:

  get '/descargar/*.*' do |path, ext|
    [path, ext] # => ["path/al/archivo", "xml"]
  end

Rutas con Expresiones Regulares:

  get %r{/hola/([\w]+)} do
    "Hola, #{params[:captures].first}!"
  end

O con un parmetro de bloque:

  get %r{/hola/([\w]+)} do |c|
    "Hola, #{c}!"
  end

Los patrones de ruta pueden contener parmetros opcionales:

  get '/posts.?:formato?' do
    # coincide con "GET /posts" y adems admite cualquier extensin, por
    # ejemplo, "GET /posts.json", "GET /posts.xml", etc.
  end

A propsito, a menos que desactivs la proteccin para el ataque <em>path
traversal</em> (ver ms abajo), el path de la peticin puede ser modificado
antes de que se compare con los de tus rutas.

=== Condiciones

Las rutas pueden incluir una variedad de condiciones de seleccin, como por
ejemplo el user agent:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Ests usando la versin de Songbird #{params[:agent][0]}"
  end

  get '/foo' do
    # Coincide con browsers que no sean songbird
  end

Otras condiciones disponibles son +host_name+ y +provides+:

  get '/', :host_name => /^admin\./ do
    "rea de Administracin, Acceso denegado!"
  end

  get '/', :provides => 'html' do
    haml :index
  end

  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

Pods definir tus propias condiciones fcilmente:

  set(:probabilidad) { |valor| condition { rand <= valor } }

  get '/gana_un_auto', :probabilidad => 0.1 do
    "Ganaste!"
  end

  get '/gana_un_auto' do
    "Lo siento, perdiste."
  end

Si tu condicin acepta ms de un argumento, pods pasarle un arreglo.  Al
definir la condicin puede resultarte conveniente utilizar el operador splat en
la lista de parmetros:

  set(:autorizar) do |*roles|   # <- mir el splat
    condition do
      unless sesion_iniciada? && roles.any? {|rol| usuario_actual.tiene_rol? rol }
        redirect "/iniciar_sesion/", 303
      end
    end
  end

  get "/mi/cuenta/", :autorizar => [:usuario, :administrador] do
    "Detalles de mi cuenta"
  end

  get "/solo/administradores/", :autorizar => :administrador do
    "nicamente para administradores!"
  end

=== Valores de Retorno

El valor de retorno de un bloque de ruta determina al menos el cuerpo de la
respuesta que se le pasa al cliente HTTP o al siguiente middleware en la pila
de Rack. Lo ms comn es que sea un string, como en los ejemplos anteriores.
Sin embargo, otros valor tambin son aceptados.

Pods devolver cualquier objeto que sea una respuesta Rack vlida, un objeto
que represente el cuerpo de una respuesta Rack o un cdigo de estado HTTP:

* Un arreglo con tres elementos: <tt>[estado (Fixnum), cabeceras (Hash), cuerpo de la respuesta (responde a #each)]</tt>
* Un arreglo con dos elementos: <tt>[estado (Fixnum), cuerpo de la respuesta (responde a #each)]</tt>
* Un objeto que responde a <tt>#each</tt> y que le pasa nicamente strings al bloque dado
* Un Fixnum representando el cdigo de estado

De esa manera podemos, por ejemplo, implementar fcilmente un streaming:

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

=== Comparadores de Rutas Personalizados

Como se mostr anteriormente, Sinatra permite utilizar Strings y expresiones
regulares para definir las rutas.  Sin embargo, la cosa no termina ah.  Pods
definir tus propios comparadores muy fcilmente:

  class PattronCualquieraMenos
    Match = Struct.new(:captures)

    def initialize(excepto)
      @excepto  = excepto
      @capturas = Match.new([])
    end

    def match(str)
      @capturas unless @excepto === str
    end
  end

  def cualquiera_menos(patron)
    PatronCualquieraMenos.new(patron)
  end

  get cualquiera_menos("/index") do
    # ...
  end

Ten en cuenta que el ejemplo anterior es un poco rebuscado.  Un resultado
similar puede conseguirse ms sencillamente:

  get // do
    pass if request.path_info == "/index"
    # ...
  end

O, usando un lookahead negativo:

  get %r{^(?!/index$)} do
    # ...
  end

== Archivos Estticos

Los archivos estticos son servidos desde el directorio pblico
<tt>./public</tt>. Pods especificar una ubicacin diferente ajustando la
opcin <tt>:public_folder</tt>:

  set :public_folder, File.dirname(__FILE__) + '/estaticos'

Not que el nombre del directorio pblico no est incluido en la URL. Por
ejemplo, el archivo <tt>./public/css/style.css</tt> se accede a travs de
<tt>http://ejemplo.com/css/style.css</tt>.

Us la configuracin <tt>:static_cache_control</tt> para agregar el encabezado
<tt>Cache-Control</tt> (ver la seccin de configuracin para ms detalles).

== Vistas / Plantillas

Cada lenguaje de plantilla se expone a travs de un mtodo de renderizado que
lleva su nombre.  Estos mtodos simplemente devuelven un string:

  get '/' do
    erb :index
  end

Renderiza <tt>views/index.erb</tt>.

En lugar del nombre de la plantilla pods proporcionar directamente el
contenido de la misma:

  get '/' do
    codigo = "<%= Time.now %>"
    erb codigo
  end

Los mtodos de renderizado, aceptan adems un segundo argumento, el hash de
opciones:

  get '/' do
    erb :index, :layout => :post
  end

Renderiza <tt>views/index.erb</tt> embebido en <tt>views/post.erb</tt> (por
defecto, la plantilla :index es embebida en <tt>views/layout.erb</tt> siempre y
cuando este ltimo archivo exista).

Cualquier opcin que Sinatra no entienda le ser pasada al motor de renderizado
de la plantilla:

  get '/' do
    haml :index, :format => :html5
  end

Adems pods definir las opciones para un lenguaje de plantillas de forma
general:

  set :haml, :format => :html5

  get '/' do
    haml :index
  end

Las opciones pasadas al mtodo de renderizado tienen precedencia sobre las
definidas mediante +set+.

Opciones disponibles:

[locals]
  Lista de variables locales pasadas al documento.  Resultan muy tiles cuando
  se combinan con parciales.
  Ejemplo: <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>

[default_encoding]
  Encoding utilizado cuando el de un string es dudoso.  Por defecto toma el
  valor de <tt>settings.default_encoding</tt>.

[views]
  Directorio desde donde se cargan las vistas.  Por defecto toma el valor de
  <tt>settings.views</tt>.

[layout]
  Si es +true+ o +false+ indica que se debe usar, o n, un layout,
  respectivamente.  Tambin puede ser un smbolo que especifique qu plantilla
  usar.  Ejemplo: <tt>erb :index, :layout => !request.xhr?</tt>

[content_type]
  Content-Type que produce la plantilla.  El valor por defecto depende de cada
  lenguaje de plantillas.

[scope]
  mbito en el que se renderiza la plantilla.  Por defecto utiliza la instancia
  de la aplicacin.  Ten en cuenta que si cambis esta opcin las variables de
  instancia y los helpers van a dejar de estar disponibles.

[layout_engine]
  Motor de renderizado de plantillas que usa para el layout.  Resulta
  conveniente para lenguajes que no soportan layouts.  Por defecto toma el valor
  del motor usado para renderizar la plantilla.
  Ejemplo: <tt>set :rdoc, :layout_engine => :erb</tt>

Se asume que las plantillas estn ubicadas directamente bajo el directorio
<tt>./views</tt>. Para usar un directorio de vistas diferente:

  set :views, settings.root + '/plantillas'

Es importante acordarse que siempre tens que referenciar a las plantillas con
smbolos, incluso cuando se encuentran en un subdirectorio (en este caso tens
que usar <tt>:'subdir/plantilla'</tt>). Tens que usar un smbolo porque los
mtodos de renderizacin van a renderizar directamente cualquier string que se
les pase como argumento.

=== Lenguajes de Plantillas Disponibles

Algunos lenguajes tienen varias implementaciones.  Para especificar que
implementacin usar (y para ser thread-safe), deberas requerirla antes de
usarla:

  require 'rdiscount' # o require 'bluecloth'
  get('/') { markdown :index }

=== Plantillas Haml

Dependencias::             {haml}[http://haml.info/]
Extensiones de Archivo::   <tt>.haml</tt>
Ejemplo::                  <tt>haml :index, :format => :html5</tt>

=== Plantillas Erb

Dependencias::             {erubis}[http://www.kuwata-lab.com/erubis/] o
                           erb (incluida en Ruby)
Extensiones de Archivo::   <tt>.erb</tt>, <tt>.rhtml</tt> o <tt>.erubis</tt>
                           (solamente con Erubis)
Ejemplo::                  <tt>erb :index</tt>

=== Plantillas Builder

Dependencias::             {builder}[http://builder.rubyforge.org/]
Extensiones de Archivo::   <tt>.builder</tt>
Ejemplo::                  <tt>builder { |xml| xml.em "hola" }</tt>

Adems, acepta un bloque con la definicin de la plantilla (ver el ejemplo).

=== Plantillas Nokogiri

Dependencias::             {nokogiri}[http://nokogiri.org/]
Extensiones de Archivo::   <tt>.nokogiri</tt>
Ejemplo::                  <tt>nokogiri { |xml| xml.em "hola" }</tt>

Adems, acepta un bloque con la definicin de la plantilla (ver el ejemplo).

=== Plantillas Sass

Dependencias::             {sass}[http://sass-lang.com/]
Extensiones de Archivo::   <tt>.sass</tt>
Ejemplo::                  <tt>sass :stylesheet, :style => :expanded</tt>

=== Plantillas SCSS

Dependencias::             {scss}[http://sass-lang.com/]
Extensiones de Archivo::   <tt>.scss</tt>
Ejemplo::                  <tt>scss :stylesheet, :style => :expanded</tt>

=== Plantillas Less

Dependencias::             {less}[http://www.lesscss.org/]
Extensiones de Archivo::   <tt>.less</tt>
Ejemplo::                  <tt>less :stylesheet</tt>

=== Plantillas Liquid

Dependencias::             {liquid}[http://www.liquidmarkup.org/]
Extensiones de Archivo::   <tt>.liquid</tt>
Ejemplo::                  <tt>liquid :index, :locals => { :clave => 'valor' }</tt>

Como no vas a poder llamar a mtodos de Ruby (excepto por +yield+) desde una
plantilla Liquid, casi siempre vas a querer pasarle locales.

=== Plantillas Markdown

Dependencias::             {rdiscount}[https://github.com/rtomayko/rdiscount],
                           {redcarpet}[https://github.com/tanoku/redcarpet],
                           {bluecloth}[http://deveiate.org/projects/BlueCloth],
                           {kramdown}[http://kramdown.rubyforge.org/] *o*
                           {maruku}[http://maruku.rubyforge.org/]
Extensiones de Archivo::   <tt>.markdown</tt>, <tt>.mkd</tt> y <tt>.md</tt>
Ejemplo::                  <tt>markdown :index, :layout_engine => :erb</tt>

No es posible llamar mtodos desde markdown, ni pasarle locales. Por lo tanto,
generalmente vas a usarlo en combinacin con otro motor de renderizado:

  erb :resumen, :locals => { :texto => markdown(:introduccion) }

Ten en cuenta que tambin pods llamar al mtodo +markdown+ desde otras
plantillas:

  %h1 Hola Desde Haml!
  %p= markdown(:saludos)

Como no pods utilizar Ruby desde Markdown, no pods usar layouts escritos en
Markdown. De todos modos, es posible usar un motor de renderizado para el
layout distinto al de la plantilla pasando la opcin <tt>:layout_engine</tt>.

=== Plantillas Textile

Dependencias::             {RedCloth}[http://redcloth.org/]
Extensiones de Archivo::   <tt>.textile</tt>
Ejemplo::                  <tt>textile :index, :layout_engine => :erb</tt>

No es posible llamar mtodos desde textile, ni pasarle locales. Por lo tanto,
generalmente vas a usarlo en combinacin con otro motor de renderizado:

  erb :resumen, :locals => { :texto => textile(:introduccion) }

Ten en cuenta que tambin pods llamar al mtodo +textile+ desde otras
plantillas:

  %h1 Hola Desde Haml!
  %p= textile(:saludos)

Como no pods utilizar Ruby desde Textile, no pods usar layouts escritos en
Textile. De todos modos, es posible usar un motor de renderizado para el
layout distinto al de la plantilla pasando la opcin <tt>:layout_engine</tt>.

=== Plantillas RDoc

Dependencias::             {rdoc}[http://rdoc.rubyforge.org/]
Extensiones de Archivo::   <tt>.rdoc</tt>
Ejemplo::                  <tt>rdoc :LEEME, :layout_engine => :erb</tt>

No es posible llamar mtodos desde rdoc, ni pasarle locales. Por lo tanto,
generalmente vas a usarlo en combinacin con otro motor de renderizado:

  erb :resumen, :locals => { :texto => rdoc(:introduccion) }

Ten en cuenta que tambin pods llamar al mtodo +rdoc+ desde otras
plantillas:

  %h1 Hola Desde Haml!
  %p= rdoc(:saludos)

Como no pods utilizar Ruby desde RDoc, no pods usar layouts escritos en RDoc.
De todos modos, es posible usar un motor de renderizado para el layout distinto
al de la plantilla pasando la opcin <tt>:layout_engine</tt>.

=== Plantillas Radius

Dependencias::             {radius}[http://radius.rubyforge.org/]
Extensiones de Archivo::   <tt>.radius</tt>
Ejemplo::                  <tt>radius :index, :locals => { :clave => 'valor' }</tt>

Como no vas a poder llamar a mtodos de Ruby (excepto por +yield+) desde una
plantilla Radius, casi siempre vas a querer pasarle locales.

=== Plantillas Markaby

Dependencias::             {markaby}[http://markaby.github.com/]
Extensiones de Archivo::   <tt>.mab</tt>
Ejemplos::                 <tt>markaby { h1 "Bienvenido!" }</tt>

Adems, acepta un bloque con la definicin de la plantilla (ver el ejemplo).

=== Plantillas Slim

Dependencias::             {slim}[http://slim-lang.com/]
Extensiones de Archivo::   <tt>.slim</tt>
Ejemplo::                  <tt>slim :index</tt>

=== Plantillas Creole

Dependencias::             {creole}[https://github.com/minad/creole]
Extensiones de Archivo::   <tt>.creole</tt>
Ejemplo::                  <tt>creole :wiki, :layout_engine => :erb</tt>

No es posible llamar mtodos desde creole, ni pasarle locales. Por lo tanto,
generalmente vas a usarlo en combinacin con otro motor de renderizado:

  erb :resumen, :locals => { :texto => cerole(:introduccion) }

Ten en cuenta que tambin pods llamar al mtodo +creole+ desde otras
plantillas:

  %h1 Hola Desde Haml!
  %p= creole(:saludos)

Como no pods utilizar Ruby desde Creole, no pods usar layouts escritos en
Creloe.  De todos modos, es posible usar un motor de renderizado para el layout
distinto al de la plantilla pasando la opcin <tt>:layout_engine</tt>.

=== Plantillas CoffeeScript

Dependencias::             {coffee-script}[https://github.com/josh/ruby-coffee-script]
                           y un {mecanismo para ejecutar javascript}[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
Extensiones de Archivo::   <tt>.coffee</tt>
Ejemplo::                  <tt>coffee :index</tt>

=== Plantillas Embebidas

  get '/' do
    haml '%div.titulo Hola Mundo'
  end

Renderiza el template embebido en el string.

=== Accediendo a Variables en Plantillas

Las plantillas son evaluadas dentro del mismo contexto que los manejadores de
ruta. Las variables de instancia asignadas en los manejadores de ruta son
accesibles directamente por las plantillas:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.nombre'
  end

O es posible especificar un Hash de variables locales explcitamente:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= bar.nombre', :locals => { :bar => foo }
  end

Esto es usado tpicamente cuando se renderizan plantillas como parciales desde
adentro de otras plantillas.

=== Plantillas Inline

Las plantillas pueden ser definidas al final del archivo fuente:

  require 'rubygems'
  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.titulo Hola mundo!!!!!

NOTA: nicamente las plantillas inline definidas en el archivo fuente que
requiere sinatra son cargadas automticamente. Llam <tt>enable
:inline_templates</tt> explcitamente si tens plantillas inline en otros
archivos fuente.

=== Plantillas Nombradas

Las plantillas tambin pueden ser definidas usando el mtodo top-level
<tt>template</tt>:

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.titulo Hola Mundo!'
  end

  get '/' do
    haml :index
  end

Si existe una plantilla con el nombre "layout", va a ser usada cada vez que
una plantilla es renderizada. Pods desactivar los layouts individualmente
pasando <tt>:layout => false</tt> o globalmente con
<tt>set :haml, :layout => false</tt>:

  get '/' do
    haml :index, :layout => !request.xhr?
  end

=== Asociando Extensiones de Archivo

Para asociar una extensin de archivo con un motor de renderizado, us
<tt>Tilt.register</tt>. Por ejemplo, si quers usar la extensin +tt+ para
las plantillas Textile, pods hacer lo siguiente:

  Tilt.register :tt, Tilt[:textile]

=== Agregando Tu Propio Motor de Renderizado

Primero, registr tu motor con Tilt, y despus, cre tu mtodo de renderizado:

  Tilt.register :mipg, MiMotorParaPlantillaGenial

  helpers do
    def mypg(*args) render(:mypg, *args) end
  end

  get '/' do
    mypg :index
  end

Renderiza <tt>./views/index.mypg</tt>. Mir https://github.com/rtomayko/tilt
para aprender ms de Tilt.

== Filtros

Los filtros +before+ son evaluados antes de cada peticin dentro del mismo
contexto que las rutas. Pueden modificar la peticin y la respuesta.  Las
variables de instancia asignadas en los filtros son accesibles por las rutas y
las plantillas:

  before do
    @nota = 'Hey!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @nota #=> 'Hey!'
    params[:splat] #=> 'bar/baz'
  end

Los filtros +after+ son evaluados despus de cada peticin dentro del mismo
contexto y tambin pueden modificar la peticin y la respuesta.  Las variables
de instancia asignadas en los filtros +before+ y en las rutas son accesibles por
los filtros +after+:

  after do
    puts response.status
  end

Nota: A menos que uss el mtodo +body+ en lugar de simplemente devolver un
string desde una ruta, el cuerpo de la respuesta no va a estar disponible en
un filtro after, debido a que todava no se ha generado.

Los filtros aceptan un patrn opcional, que cuando est presente causa que los
mismos sean evaluados nicamente si el path de la peticin coincide con ese
patrn:

  before '/protegido/*' do
    autenticar!
  end

  after '/crear/:slug' do |slug|
    session[:ultimo_slug] = slug
  end

Al igual que las rutas, los filtros tambin pueden aceptar condiciones:

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'ejemplo.com' do
    # ...
  end

== Ayudantes

Us el mtodo top-level <tt>helpers</tt> para definir mtodos ayudantes que
pueden ser utilizados dentro de los manejadores de rutas y las plantillas:

  helpers do
    def bar(nombre)
      "#{nombre}bar"
    end
  end

  get '/:nombre' do
    bar(params[:nombre])
  end

Por cuestiones organizativas, puede resultar conveniente organizar los mtodos
ayudantes en distintos mdulos:

  module FooUtils
    def foo(nombre) "#{nombre}foo" end
  end

  module BarUtils
    def bar(nombre) "#{nombre}bar" end
  end

  helpers FooUtils, BarUtils

El efecto de utilizar <tt>helpers</tt> de esta manera es el mismo que resulta de
incluir los mdulos en la clase de la aplicacin.

=== Usando Sesiones

Una sesin es usada para mantener el estado a travs de distintas peticiones.
Cuando estn activadas, tens un hash de sesin para cada sesin de usuario:

  enable :sessions

  get '/' do
    "valor = " << session[:valor].inspect
  end

  get '/:valor' do
    session[:valor] = params[:valor]
  end

Ten en cuenta que <tt>enable :sessions</tt> guarda todos los datos en una
cookie, lo que no es siempre deseable (guardar muchos datos va a incrementar
tu trfico, por citar un ejemplo).  Pods usar cualquier middleware Rack para
manejar sesiones, de la misma manera que usaras cualquier otro middleware,
pero con la salvedad de que *no* tens que llamar a <tt>enable :sessions</tt>:

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "valor = " << session[:valor].inspect
  end

  get '/:valor' do
    session[:valor] = params[:valor]
  end

Para incrementar la seguridad, los datos de la sesin almacenados en
la cookie son firmados con un secreto de sesin.  Este secreto, es
generado aleatoriamente por Sinatra.  De cualquier manera, hay que
tener en cuenta que cada vez que inicies la aplicacin se va a generar
uno nuevo.  As, si quers que todas las instancias de tu aplicacin
compartan un nico secreto, tens que definirlo vos:

  set :session_secret, 'super secreto'

Si necesits una configuracin ms especfica, +sessions+ acepta un
Hash con opciones:

  set :sessions, :domain => 'foo.com'

=== Interrupcin

Para detener inmediatamente una peticin dentro de un filtro o una ruta us:

  halt

Tambin pods especificar el estado:

  halt 410

O el cuerpo:

  halt 'esto va a ser el cuerpo'

O los dos:

  halt 401, 'sal de ac!'

Con cabeceras:

  halt 402, { 'Content-Type' => 'text/plain' }, 'venganza'

Obviamente, es posible utilizar +halt+ con una plantilla:

  halt erb(:error)

=== Paso

Una ruta puede pasarle el procesamiento a la siguiente ruta que coincida con
la peticin usando <tt>pass</tt>:

  get '/adivina/:quien' do
    pass unless params[:quien] == 'Franco'
    'Adivinaste!'
  end

  get '/adivina/*' do
    'Erraste!'
  end

Se sale inmediatamente del bloque de la ruta y se le pasa el control a la
siguiente ruta que coincida. Si no coincide ninguna ruta, se devuelve un 404.

=== Ejecutando Otra Ruta

Cuando quers obtener el resultado de la llamada a una ruta, +pass+ no te va a
servir.  Para lograr esto, pods usar +call+:

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

Not que en el ejemplo anterior, es conveniente mover <tt>"bar"</tt> a un
helper, y llamarlo desde <tt>/foo</tt> y <tt>/bar</tt>.  As, vas a simplificar
las pruebas y a mejorar el rendimiento.

Si quers que la peticin se enve a la misma instancia de la aplicacin en
lugar de a otra, us <tt>call!</tt> en lugar de <tt>call</tt>.

En la especificacin de Rack pods encontrar ms informacin sobre
<tt>call</tt>.

=== Asignando el Cdigo de Estado, los Encabezados y el Cuerpo de una Respuesta

Es posible, y se recomienda, asignar el cdigo de estado y el cuerpo de una
respuesta con el valor de retorno de una ruta.  De cualquier manera, en varios
escenarios, puede que sea conveniente asignar el cuerpo en un punto arbitrario
del flujo de ejecucin con el mtodo +body+.  A partir de ah, pods usar ese
mismo mtodo para acceder al cuerpo de la respuesta:

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

Tambin es posible pasarle un bloque a +body+, que ser ejecutado por el Rack
handler (pods usar esto para implementar streaming, mir "Valores de retorno").

De manera similar, tambin pods asignar el cdigo de estado y encabezados:

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "I'm a tea pot!"
  end

Tambin, al igual que +body+, tanto +status+ como +headers+ pueden utilizarse
para obtener sus valores cuando no se les pasa argumentos.

=== Streaming De Respuestas

A veces vas a querer empezar a enviar la respuesta a pesar de que todava no
terminaste de generar su cuerpo.  Tambin es posible que, en algunos casos,
quieras seguir enviando informacin hasta que el cliente cierre la conexin.
Cuando esto ocurra, el +stream+ helper te va a ser de gran ayuda:

  get '/' do
    stream do |out|
      out << "Esto va a ser legen -\n"
      sleep 0.5
      out << " (esperalo) \n"
      sleep 1
      out << "- dario!\n"
    end
  end

Pods implementar APIs de streaming,
{Server-Sent Events}[http://dev.w3.org/html5/eventsource/] y puede ser usado
como base para {WebSockets}[http://es.wikipedia.org/wiki/WebSockets].  Tambin
puede ser usado para incrementar el throughput si solo una parte del contenido
depende de un recurso lento.

Hay que tener en cuenta que el comportamiento del streaming, especialmente el
nmero de peticiones concurrentes, depende del servidor web utilizado para
servir la aplicacin.  Puede que algunos servidores, como es el caso de
WEBRick, no soporten streaming directamente, as el cuerpo de la respuesta ser
enviado completamente de una vez cuando el bloque pasado a +stream+ finalice su
ejecucin.  Si ests usando Shotgun, el streaming no va a funcionar.

Cuando se pasa +keep_open+ como parmetro, no se va a enviar el mensaje
+close+ al objeto de stream. Queda en vos cerrarlo en el punto de ejecucin
que quieras. Nuevamente, hay que tener en cuenta que este comportamiento es
posible solo en servidores que soporten eventos, como Thin o Rainbows. El
resto de los servidores van a cerrar el stream de todos modos:

  set :server, :thin
  conexiones = []

  get '/' do
    # mantenemos abierto el stream
    stream(:keep_open) { |salida| conexiones << salida }
  end

  post '/' do
    # escribimos a todos los streams abiertos
    conexiones.each { |salida| salida << params[:mensaje] << "\n" }
    "mensaje enviado"
  end

=== Log (Registro)

En el mbito de la peticin, el helper +logger+ (registrador) expone
una instancia de +Logger+:

  get '/' do
    logger.info "cargando datos"
    # ...
  end

Este logger tiene en cuenta la configuracin de logueo de tu Rack
handler.  Si el logueo est desactivado, este mtodo va a devolver un
objeto que se comporta como un logger pero que en realidad no hace
nada.  As, no vas a tener que preocuparte por esta situacin.

Ten en cuenta que el logueo est habilitado por defecto nicamente
para <tt>Sinatra::Application</tt>.  Si heredaste de
<tt>Sinatra::Base</tt>, probablemente quieras habilitarlo manualmente:

  class MiApp < Sinatra::Base
    configure :production, :development do
      enable :logging
    end
  end

Para evitar que se inicialice cualquier middleware de logging, configur
+logging+ a +nil+.  Ten en cuenta que, cuando hagas esto, +logger+ va a
devolver +nil+.  Un caso comn es cuando quers usar tu propio logger. Sinatra
va a usar lo que encuentre en <tt>env['rack.logger']</tt>.

=== Tipos Mime

Cuando uss <tt>send_file</tt> o archivos estticos tal vez tengas tipos mime
que Sinatra no entiende. Us +mime_type+ para registrarlos a travs de la
extensin de archivo:

  configure do
    mime_type :foo, 'text/foo'
  end

Tambin lo pods usar con el ayudante +content_type+:

  get '/' do
    content_type :foo
    "foo foo foo"
  end

=== Generando URLs

Para generar URLs deberas usar el mtodo +url+.  Por ejemplo, en Haml:

  %a{:href => url('/foo')} foo

Tiene en cuenta proxies inversos y encaminadores de Rack, si estn presentes.

Este mtodo tambin puede invocarse mediante su alias +to+  (mir un ejemplo
a continuacin).

=== Redireccin del Navegador

Pods redireccionar al navegador con el mtodo +redirect+:

  get '/foo' do
    redirect to('/bar')
  end

Cualquier parmetro adicional se utiliza de la misma manera que los argumentos
pasados a +halt+:

  redirect to('/bar'), 303
  redirect 'http://google.com', 'te confundiste de lugar, compaero'

Tambin pods redireccionar fcilmente de vuelta hacia la pgina desde donde
vino el usuario con +redirect back+:

  get '/foo' do
    "<a href='/bar'>hacer algo</a>"
  end

  get '/bar' do
    hacer_algo
    redirect back
  end

Para pasar argumentos con una redireccin, pods agregarlos a la cadena de
bsqueda:

  redirect to('/bar?suma=42')

O usar una sesin:

  enable :sessions

  get '/foo' do
    session[:secreto] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secreto]
  end

=== Cache Control

Asignar tus encabezados correctamente es el cimiento para realizar un cacheo
HTTP correcto.

Pods asignar el encabezado Cache-Control fcilmente:

  get '/' do
    cache_control :public
    "cachealo!"
  end

Pro tip: configurar el cacheo en un filtro +before+:

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

Si ests usando el helper +expires+ para definir el encabezado correspondiente,
<tt>Cache-Control</tt> se va a definir automticamente:

  before do
    expires 500, :public, :must_revalidate
  end

Para usar cachs adecuadamente, deberas considerar usar +etag+ o
+last_modified+.  Es recomendable que llames a estos helpers *antes* de hacer
cualquier trabajo pesado, ya que van a enviar la respuesta inmediatamente si
el cliente ya tiene la versin actual en su cach:

  get '/articulo/:id' do
    @articulo = Articulo.find params[:id]
    last_modified @articulo.updated_at
    etag @articulo.sha1
    erb :articulo
  end

Tambin es posible usar una
{weak ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation]:

  etag @articulo.sha1, :weak

Estos helpers no van a cachear nada por vos, sino que van a facilitar la
informacin necesaria para poder hacerlo.  Si ests buscando soluciones rpidas
de cacheo con proxys inversos, mir
{rack-cache}[http://rtomayko.github.com/rack-cache/]:

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hola"
  end

Us la configuracin <tt>:static_cache_control</tt> para agregar el encabezado
<tt>Cache-Control</tt> a archivos estticos (ver la seccin de configuracin
para ms detalles).

De acuerdo con la RFC 2616 tu aplicacin debera comportarse diferente si a las
cabeceras If-Match o If-None-Match se le asigna el valor <tt>*</tt> cuando el
recurso solicitado ya existe.  Sinatra asume para peticiones seguras (como get)
e idempotentes (como put) que el recurso existe, mientras que para el resto
(como post), que no.  Podes cambiar este comportamiento con la opcin
<tt>:new_resource</tt>:

  get '/crear' do
    etag '', :new_resource => true
    Articulo.create
    erb :nuevo_articulo
  end

Si quers seguir usando una weak ETag, indicalo con la opcin <tt>:kind</tt>:

  etag '', :new_resource => true, :kind => :weak

=== Enviando Archivos

Para enviar archivos, pods usar el mtodo <tt>send_file</tt>:

  get '/' do
    send_file 'foo.png'
  end

Adems acepta un par de opciones:

  send_file 'foo.png', :type => :jpg

Estas opciones son:

[filename]
  nombre del archivo devuelto, por defecto es el nombre real del archivo.

[last_modified]
  valor para el encabezado Last-Modified, por defecto toma el mtime del archivo.

[type]
  el content type que se va a utilizar, si no est presente se intenta adivinar
  a partir de la extensin del archivo.

[disposition]
  se utiliza para el encabezado Content-Disposition, y puede tomar alguno de los
  siguientes valores: +nil+ (por defecto), <tt>:attachment</tt> e
  <tt>:inline</tt>

[length]
  encabezado Content-Length, por defecto toma el tamao del archivo.

Si el Rack handler lo soporta, se intentar no transmitir directamente desde el
proceso de Ruby.  Si uss este mtodo, Sinatra se va a encargar automticamente
peticiones de rango.

=== Accediendo al objeto de la peticin

El objeto de la peticin entrante puede ser accedido desde el nivel de la
peticin (filtros, rutas y manejadores de errores) a travs del mtodo
<tt>request</tt>:

  # app corriendo en http://ejemplo.com/ejemplo
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                # cuerpo de la peticin enviado por el cliente (ver ms abajo)
    request.scheme              # "http"
    request.script_name         # "/ejemplo"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      # longitud de request.body
    request.media_type          # tipo de medio de request.body
    request.host                # "ejemplo.com"
    request.get?                # true (hay mtodos anlogos para los otros verbos)
    request.form_data?          # false
    request["UNA_CABECERA"]     # valor de la cabecera UNA_CABECERA
    request.referrer            # la referencia del cliente o '/'
    request.user_agent          # user agent (usado por la condicin :agent)
    request.cookies             # hash de las cookies del browser
    request.xhr?                # es una peticin ajax?
    request.url                 # "http://ejemplo.com/ejemplo/foo"
    request.path                # "/ejemplo/foo"
    request.ip                  # direccin IP del cliente
    request.secure?             # false (sera true sobre ssl)
    request.forwarded?          # true (si se est corriendo atrs de un proxy inverso)
    requuest.env                # hash de entorno directamente entregado por Rack
  end

Algunas opciones, como <tt>script_name</tt> o <tt>path_info</tt> pueden
tambin ser escritas:

  before { request.path_info = "/" }

  get "/" do
    "todas las peticiones llegan ac"
  end

El objeto <tt>request.body</tt> es una instancia de IO o StringIO:

  post "/api" do
    request.body.rewind  # en caso de que alguien ya lo haya ledo
    datos = JSON.parse request.body.read
    "Hola #{datos['nombre']}!"
  end

=== Archivos Adjuntos

Pods usar el mtodo helper +attachment+ para indicarle al navegador que
almacene la respuesta en el disco en lugar de mostrarla en pantalla:

  get '/' do
    attachment
    "guardalo!"
  end

Tambin pods pasarle un nombre de archivo:

  get '/' do
    attachment "info.txt"
    "guardalo!"
  end

=== Fecha y Hora

Sinatra pone a tu disposicin el helper +time_for+, que genera un objeto +Time+
a partir del valor que recibe como argumento.  Este valor puede ser un
+String+, pero tambin es capaz de convertir objetos +DateTime+, +Date+ y de
otras clases similares:

  get '/' do
    pass if Time.now > time_for('Dec 23, 2012')
    "todava hay tiempo"
  end

Este mtodo es usado internamente por mtodos como +expires+ y +last_modified+,
entre otros.  Por lo tanto, es posible extender el comportamiento de estos
mtodos sobreescribiendo +time_for+ en tu aplicacin:

  helpers do
    def time_for(value)
      case value
      when :ayer then Time.now - 24*60*60
      when :maana then Time.now + 24*60*60
      else super
      end
    end
  end

  get '/' do
    last_modified :ayer
    expires :maana
    "hola"
  end

=== Buscando los Archivos de las Plantillas

El helper <tt>find_template</tt> se utiliza para encontrar los archivos de las
plantillas que se van a renderizar:

  find_template settings.views, 'foo', Tilt[:haml] do |archivo|
    puts "podra ser #{archivo}"
  end

Si bien esto no es muy til, lo interesante es que pods sobreescribir este
mtodo, y as enganchar tu propio mecanismo de bsqueda.  Por ejemplo, para
poder utilizar ms de un directorio de vistas:

  set :views, ['vistas', 'plantillas']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

Otro ejemplo consiste en usar directorios diferentes para los distintos motores
de renderizado:

  set :views, :sass => 'vistas/sass', :haml => 'plantillas', :defecto => 'vistas'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:defecto]
      super(folder, name, engine, &block)
    end
  end

Es muy fcil convertir estos ejemplos en una extensin y compartirla!.

Not que <tt>find_template</tt> no verifica si un archivo existe realmente, sino
que llama al bloque que recibe para cada path posible.  Esto no representa un
problema de rendimiento debido a que +render+ va a usar +break+ ni bien
encuentre un archivo que exista.  Adems, las ubicaciones de las plantillas (y
su contenido) se cachean cuando no ests en el modo de desarrollo.  Es bueno
tener en cuenta lo anteiror si escribs un mtodo medio loco.

== Configuracin

Ejecutar una vez, en el inicio, en cualquier entorno:

  configure do
    # asignando una opcin
    set :opcion, 'valor'

    # asignando varias opciones
    set :a => 1, :b => 2

    # atajo para `set :opcion, true`
    enable :opcion

    # atajo para `set :opcion, false`
    disable :opcion

    # tambin pods tener configuraciones dinmicas usando bloques
    set(:css_dir) { File.join(views, 'css') }
  end

Ejecutar nicamente cuando el entorno (la variable de entorno RACK_ENV) es
<tt>:production</tt>:

  configure :production do
    ...
  end

Ejecutar cuando el entorno es <tt>:production</tt> o <tt>:test</tt>:

  configure :production, :test do
    ...
  end

Pods acceder a estas opciones utilizando el mtodo <tt>settings</tt>:

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

=== Configurando la Proteccin de Ataques

Sinatra usa {Rack::Protection}[https://github.com/rkh/rack-protection#readme]
para defender a tu aplicacin de los ataques ms comunes. Si por algn motivo,
quers desactivar esta funcionalidad, pods hacerlo como se indica a
continuacin (ten en cuenta que tu aplicacin va a quedar expuesta a un
montn de vulnerabilidades bien conocidas):

  disable :protection

Tambin es posible desactivar una nica capa de defensa:

  set :protection, :except => :path_traversal

O varias:

  set :protection, :except => [:path_traversal, :session_hijacking]

=== Configuraciones Disponibles

[absolute_redirects]   si est deshabilitada, Sinatra va a permitir
                       redirecciones relativas, sin embargo, como consecuencia
                       de esto, va a dejar de cumplir con el RFC 2616 (HTTP
                       1.1), que solamente permite redirecciones absolutas.

                       Activalo si tu apliacin est corriendo atrs de un proxy
                       inverso que no se ha configurado adecuadamente.  Not que
                       el helper +url+ va a seguir produciendo URLs absolutas, a
                       menos que le pass +false+ como segundo parmetro.

                       Deshabilitada por defecto.

[add_charsets]         tipos mime a los que el helper <tt>content_type</tt> les
                       aade automticamente el charset.

                       En general, no deberas asignar directamente esta opcin,
                       sino aadirle los charsets que quieras:

                         settings.add_charsets << "application/foobar"

[app_file]             path del archivo principal de la aplicacin, se utiliza
                       para detectar la raz del proyecto, el directorio de las
                       vistas y el pblico, as como las plantillas inline.

[bind]                 direccin IP que utilizar el servidor integrado (por
                       defecto: 0.0.0.0).

[default_encoding]     encoding utilizado cuando el mismo se desconoce (por
                       defecto <tt>"utf-8"</tt>).

[dump_errors]          mostrar errores en el log.

[environment]          entorno actual, por defecto toma el valor de
                       <tt>ENV['RACK_ENV']</tt>, o <tt>"development"</tt> si no
                       est disponible.

[logging]              define si se utiliza el logger.

[lock]                 coloca un lock alrededor de cada peticin, procesando
                       solamente una por proceso.

                       Habilit esta opcin si tu aplicacin no es thread-safe.
                       Se encuentra deshabilitada por defecto.

[method_override]      utiliza el parmetro <tt>_method</tt> para permtir
                       formularios put/delete en navegadores que no los
                       soportan.

[port]                 puerto en el que escuchar el servidor integrado.

[prefixed_redirects]   define si inserta <tt>request.script_name</tt> en las
                       redirecciones cuando no se proporciona un path absoluto.
                       De esta manera, cuando est habilitada,
                       <tt>redirect '/foo'</tt> se comporta de la misma manera
                       que <tt>redirect to('/foo')</tt>.  Se encuentra
                       deshabilitada por defecto.

[protection]           define si deben activarse las protecciones para los
                       ataques web ms comunes.  Para ms detalles mir la
                       seccin sobre la configuracin de proteccin de ataques
                       ms arriba.

[public_folder]        path del directorio desde donde se sirven los archivos
                       pblicos.  Solo se utiliza cuando se sirven archivos
                       estticos (ver la opcin <tt>static</tt>).  Si no
                       est presente, se infiere del valor de la opcin
                       <tt>app_file</tt>.

[reload_templates]     define si se recargan las plantillas entre peticiones.

                       Se encuentra activado en el entorno de desarrollo.

[root]                 path del directorio raz del proyecto.  Si no est
                       presente, se infiere del valor de la opcin
                       <tt>app_file</tt>.

[raise_errors]         elevar excepciones (detiene la aplicacin).  Se
                       encuentra activada por defecto cuando el valor de
                       <tt>environment</tt>  es <tt>"test"</tt>.  En caso
                       contrario estar desactivada.

[run]                  cuando est habilitada, Sinatra se va a encargar de
                       iniciar el servidor web, no la habilits cuando ests
                       usando rackup o algn otro medio.

[running]              indica si el servidor integrado est ejecutandose, no
                       cambis esta configuracin!.

[server]               servidor, o lista de servidores, para usar como servidor
                       integrado.  Por defecto: ['thin', 'mongrel', 'webrick'],
                       el orden establece la prioridad.

[sessions]             habilita el soporte de sesiones basadas en cookies a
                       travs de <tt>Rack::Session::Cookie</tt>.  Ver la
                       seccin 'Usando Sesiones' para ms informacin.

[show_exceptions]      muestra un stack trace en el navegador cuando ocurre una
                       excepcin.  Se encuentra activada por defecto cuando el
                       valor de <tt>environment</tt> es <tt>"development"</tt>.
                       En caso contrario estar desactivada.

[static]               define si Sinatra debe encargarse de servir archivos
                       estticos.

                       Deshabilitala cuando uss un servidor capaz de
                       hacerlo por s solo, porque mejorar el
                       rendimiento.  Se encuentra habilitada por
                       defecto en el estilo clsico y desactivado en el
                       el modular.

[static_cache_control] cuando Sinatra est sirviendo archivos estticos, y
                       est opcin est habilitada, les va a agregar encabezados
                       <tt>Cache-Control</tt> a las respuestas.  Para esto
                       utiliza el helper +cache_control+.  Se encuentra
                       deshabilitada por defecto.  Notar que es necesario
                       utilizar un array cuando se asignan mltiples valores: 
                       <tt>set :static_cache_control, [:public, :max_age => 300]</tt>.

[views]                path del directorio de las vistas.  Si no est presente,
                       se infiere del valor de la opcin <tt>app_file</tt>.

== Entornos

Existen tres entornos (+environments+) predefinidos: <tt>development</tt>,
<tt>production</tt> y <tt>test</tt>.  El entorno por defecto es
<tt>development</tt> y tiene algunas particularidades:

* Se recargan las plantillas entre una peticin y la siguiente, a diferencia
de <tt>production</tt> y <tt>test</tt>, donde se cachean.
* Se instalan manejadores de errores <tt>not_found</tt> y <tt>error</tt>
especiales que muestran un stack trace en el navegador cuando son disparados.

Para utilizar alguno de los otros entornos puede asignarse el valor
correspondiente a la variable de entorno +RACK_ENV+, o bien utilizar la opcin
<tt>-e</tt> al ejecutar la aplicacin:

  ruby mi_app.rb -e <ENTORNO>

Los mtodos +development?+, +test?+ y +production?+ te permiten conocer el
entorno actual.

== Manejo de Errores

Los manejadores de errores se ejecutan dentro del mismo contexto que las rutas
y los filtros +before+, lo que significa que pods usar, por ejemplo,
<tt>haml</tt>, <tt>erb</tt>, <tt>halt</tt>, etc.

=== No encontrado <em>(Not Found)</em>

Cuando se eleva una excepcin <tt>Sinatra::NotFound</tt>, o el cdigo de
estado de la respuesta es 404, el manejador <tt>not_found</tt> es invocado:

  not_found do
    'No existo'
  end

=== Error

El manejador +error+ es invocado cada vez que una excepcin es elevada
desde un bloque de ruta o un filtro. El objeto de la excepcin se puede
obtener de la variable Rack <tt>sinatra.error</tt>:

  error do
    'Disculp, ocurri un error horrible - ' + env['sinatra.error'].name
  end

Errores personalizados:

  error MiErrorPersonalizado do
    'Lo que pas fue...' + env['sinatra.error'].message
  end

Entonces, si pasa esto:

  get '/' do
    raise MiErrorPersonalizado, 'algo malo'
  end

Obtens esto:

  Lo que pas fue... algo malo

Tambin, pods instalar un manejador de errores para un cdigo de estado:

  error 403 do
    'Acceso prohibido'
  end

  get '/secreto' do
    403
  end

O un rango:

  error 400..510 do
    'Boom'
  end

Sinatra instala manejadores <tt>not_found</tt> y <tt>error</ttt> especiales
cuando se ejecuta dentro del entorno de desarrollo "development".

== Rack Middleware

Sinatra corre sobre Rack[http://rack.rubyforge.org/], una interfaz minimalista
que es un estndar para frameworks webs escritos en Ruby. Una de las
capacidades ms interesantes de Rack para los desarrolladores de aplicaciones
es el soporte de "middleware" -- componentes que se ubican entre el servidor y
tu aplicacin, supervisando y/o manipulando la peticin/respuesta HTTP para
proporcionar varios tipos de funcionalidades comunes.

Sinatra hace muy sencillo construir tuberas de Rack middleware a travs del
mtodo top-level +use+:

  require 'sinatra'
  require 'mi_middleware_personalizado'

  use Rack::Lint
  use MiMiddlewarePersonalizado

  get '/hola' do
    'Hola Mundo'
  end

Las semnticas de +use+ son idnticas a las definidas para el DSL
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] (ms
frecuentemente usado desde archivos rackup). Por ejemplo, el mtodo +use+
acepta argumentos mltiples/variables as como bloques:

  use Rack::Auth::Basic do |nombre_de_usuario, password|
    nombre_de_usuario == 'admin' && password == 'secreto'
  end

Rack es distribuido con una variedad de middleware estndar para logging,
debugging, enrutamiento URL, autenticacin, y manejo de sesiones. Sinatra
usa muchos de estos componentes automticamente de acuerdo a su configuracin
para que tpicamente no tengas que usarlas (con +use+) explcitamente.

Pods encontrar middleware til en
{rack}[https://github.com/rack/rack/tree/master/lib/rack],
{rack-contrib}[https://github.com/rack/rack-contrib#readme],
con {CodeRack}[http://coderack.org/] o en la
{Rack wiki}[https://github.com/rack/rack/wiki/List-of-Middleware].

== Pruebas

Las pruebas para las aplicaciones Sinatra pueden ser escritas utilizando
cualquier framework o librera de pruebas basada en Rack. Se recomienda usar
{Rack::Test}[http://rdoc.info/github/brynary/rack-test/master/frames]:

  require 'mi_app_sinatra'
  require 'test/unit'
  require 'rack/test'

  class MiAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_mi_defecto
      get '/'
      assert_equal 'Hola Mundo!', last_response.body
    end

    def test_con_parametros
      get '/saludar', :name => 'Franco'
      assert_equal 'Hola Frank!', last_response.body
    end

    def test_con_entorno_rack
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Ests usando Songbird!", last_response.body
    end
  end

== Sinatra::Base - Middleware, Libreras, y Aplicaciones Modulares

Definir tu aplicacin en el top-level funciona bien para micro-aplicaciones
pero trae inconvenientes considerables a la hora de construir componentes
reutilizables como Rack middleware, Rails metal, simple libreras con un
componente de servidor, o incluso extensiones de Sinatra. El DSL de top-level
contamina el espacio de nombres de Object y asume una configuracin apropiada
para micro-aplicaciones (por ejemplo, un nico archivo de aplicacin, los
directorios <tt>./public</tt> y <tt>./views</tt>, logging, pgina con detalles
de excepcin, etc.). Ah es donde <tt>Sinatra::Base</tt> entra en el juego:

  require 'sinatra/base'

  class MiApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hola Mundo!'
    end
  end

Las subclases de <tt>Sinatra::Base</tt> tienen disponibles exactamente los
mismos mtodos que los provistos por el DSL de top-level. La mayora de las
aplicaciones top-level se pueden convertir en componentes
<tt>Sinatra::Base</tt> con dos modificaciones:

* Tu archivo debe requerir <tt>sinatra/base</tt> en lugar de +sinatra+; de otra
  manera, todos los mtodos del DSL de sinatra son importados dentro del
  espacio de nombres principal.
* Pon las rutas, manejadores de errores, filtros y opciones de tu aplicacin
  en una subclase de <tt>Sinatra::Base</tt>.

<tt>Sinatra::Base</tt> es una pizarra en blanco. La mayora de las opciones estn
desactivadas por defecto, incluyendo el servidor incorporado. Mir
{Opciones y Configuraciones}[http://sinatra.github.com/configuration.html]
para detalles sobre las opciones disponibles y su comportamiento.

=== Estilo Modular vs. Clsico

Contrariamente a la creencia popular, no hay nada de malo con el estilo clsico.
Si se ajusta a tu aplicacin, no es necesario que la cambies a una modular.

Existen tan solo dos desventajas en comparacin con el estilo modular:

* Solamente pods tener una aplicacin Sinatra por proceso Ruby - si tens
  planificado usar ms, cambi al estilo modular.

* El estilo clsico contamina Object con mtodos delegadores - si tens
  planificado empaquetar tu aplicacin en una librera/gem, cambi al estilo
  modular.

No hay ninguna razn por la cul no puedas mezclar los estilos modular y
clsico.

Cuando cambis de un estilo al otro, ten en cuenta las sutiles diferencias
entre sus configuraciones:

  Configuracin       Clsica                      Modular

  app_file            archivo que carga sinatra    archivo con la subclase de Sinatra::Base
  run                 $0 == app_file               false
  logging             true                         false
  method_override     true                         false
  inline_templates    true                         false
  static              true                         false

=== Sirviendo una Aplicacin Modular

Las dos opciones ms comunes para iniciar una aplicacin modular son, iniciarla
activamente con <tt>run!</tt>:

  # mi_app.rb
  require 'sinatra/base'

  class MiApp < Sinatra::Base
    # ... cdigo de la app  ...

    # iniciar el servidor si el archivo fue ejecutado directamente
    run! if app_file == $0
  end

Iniciar con:

  ruby mi_app.rb

O, con un archivo <tt>config.ru</tt>, que permite usar cualquier handler Rack:

  # config.ru
  require './mi_app'
  run MiApp

Despus ejecutar:

  rackup -p 4567

=== Usando una Aplicacin Clsica con un Archivo config.ru

Escrib el archivo de tu aplicacin:

  # app.rb
  require 'sinatra'

  get '/' do
    'Hola mundo!'
  end

Y el <tt>config.ru</tt> correspondiente:

  require './app'
  run Sinatra::Application

=== Cundo Usar config.ru?

Indicadores de que probablemente quers usar <tt>config.ru</tt>:

* Quers realizar el deploy con un hanlder Rack distinto (Passenger, Unicorn,
  Heroku, ...).
* Quers usar ms de una subclase de <tt>Sinatra::Base</tt>.
* Quers usar Sinatra nicamente para middleware, pero no como un endpoint.

<b>No hay necesidad de utilizar un archivo <tt>config.ru</tt> exclusivamente
porque tens una aplicacin modular, y no necesits una aplicacin modular para
iniciarla con <tt>config.ru</tt>.</b>

=== Utilizando Sinatra como Middleware

Sinatra no solo es capaz de usar otro Rack middleware, sino que a su vez,
cualquier aplicacin Sinatra puede ser agregada delante de un endpoint Rack
como middleware. Este endpoint puede ser otra aplicacin Sinatra, o cualquier
aplicacin basada en Rack (Rails/Ramaze/Camping/...):

  require 'sinatra/base'

  class PantallaDeLogin < Sinatra::Base
    enable :sessions

    get('/login') { haml :login }

    post('/login') do
      if params[:nombre] == 'admin' && params[:password] == 'admin'
        session['nombre_de_usuario'] = params[:nombre]
      else
        redirect '/login'
      end
    end
  end

  class MiApp < Sinatra::Base
    # el middleware se ejecutar antes que los filtros
    use PantallaDeLogin

    before do
      unless session['nombre_de_usuario']
        halt "Acceso denegado, por favor <a href='/login'>inici sesin</a>."
      end
    end

    get('/') { "Hola #{session['nombre_de_usuario']}." }
  end

=== Creacin Dinmica de Aplicaciones

Puede que en algunas ocasiones quieras crear nuevas aplicaciones en
tiempo de ejecucin sin tener que asignarlas a una constante.  Para
esto tens <tt>Sinatra.new</tt>:

  require 'sinatra/base'
  mi_app = Sinatra.new { get('/') { "hola" } }
  mi_app.run!

Acepta como argumento opcional una aplicacin desde la que se
heredar:

  # config.ru
  require 'sinatra/base'

  controller = Sinatra.new do
    enable :logging
    helpers MisHelpers
  end

  map('/a') do
    run Sinatra.new(controller) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controller) { get('/') { 'b' } }
  end

Construir aplicaciones de esta forma resulta especialmente til para
testear extensiones Sinatra o para usar Sinatra en tus libreras.

Por otro lado, hace extremadamente sencillo usar Sinatra como
middleware:

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run ProyectoRails::Application

== mbitos y Ligaduras

El mbito en el que te encontrs determina que mtodos y variables estn
disponibles.

=== mbito de Aplicacin/Clase

Cada aplicacin Sinatra es una subclase de <tt>Sinatra::Base</tt>. Si ests
usando el DSL de top-level (<tt>require 'sinatra'</tt>), entonces esta clase es
<tt>Sinatra::Application</tt>, de otra manera es la subclase que creaste
explcitamente.  Al nivel de la clase tens mtodos como +get+ o +before+, pero
no pods acceder a los objetos +request+ o +session+, ya que hay una nica
clase de la aplicacin para todas las peticiones.

Las opciones creadas utilizando +set+ son mtodos al nivel de la clase:

    class MiApp < Sinatra::Base
      # Ey, estoy en el mbito de la aplicacin!
      set :foo, 42
      foo # => 42

      get '/foo' do
        # Hey, ya no estoy en el mbito de la aplicacin!
      end
    end

Tens la ligadura al mbito de la aplicacin dentro de:

* El cuerpo de la clase de tu aplicacin
* Mtodos definidos por extensiones
* El bloque pasado a +helpers+
* Procs/bloques usados como el valor para +set+

Este mbito puede alcanzarse de las siguientes maneras:

* A travs del objeto pasado a los bloques de configuracin (<tt>configure { |c| ...}</tt>)
* Llamando a +settings+ desde dentro del mbito de la peticin

=== mbito de Peticin/Instancia

Para cada peticin entrante, una nueva instancia de la clase de tu aplicacin
es creada y todos los bloques de rutas son ejecutados en ese mbito. Desde este
mbito pods acceder a los objetos +request+ y +session+ o llamar a los mtodos
de renderizacin como +erb+ o +haml+. Pods acceder al mbito de la aplicacin
desde el mbito de la peticin utilizando +settings+:

  class MiApp < Sinatra::Base
    # Ey, estoy en el mbito de la aplicacin!
    get '/definir_ruta/:nombre' do
      # mbito de peticin para '/definir_ruta/:nombre'
      @valor = 42

      settings.get("/#{params[:nombre]}") do
        # mbito de peticin para "/#{params[:nombre]}"
        @valor # => nil (no es la misma peticin)
      end

      "Ruta definida!"
    end
  end

Tens la ligadura al mbito de la peticin dentro de:

* bloques pasados a get/head/post/put/delete/options
* filtros before/after
* mtodos ayudantes
* plantillas/vistas

=== mbito de Delegacin

El mbito de delegacin solo reenva mtodos al mbito de clase. De cualquier
manera, no se comporta 100% como el mbito de clase porque no tens la ligadura
de la clase: nicamente mtodos marcados explcitamente para delegacin estn
disponibles y no comparts variables/estado con el mbito de clase (lase:
tens un +self+ diferente). Pods agregar delegaciones de mtodo llamando a
<tt>Sinatra::Delegator.delegate :nombre_del_metodo</tt>.

Tens la ligadura al mbito de delegacin dentro de:

* La ligadura del top-level, si hiciste <tt>require "sinatra"</tt>
* Un objeto extendido con el mixin <tt>Sinatra::Delegator</tt>

Pegale una mirada al cdigo: ac est el
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
que es {incluido en el espacio de nombres principal}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28].

== Lnea de Comandos

Las aplicaciones Sinatra pueden ser ejecutadas directamente:

  ruby miapp.rb [-h] [-x] [-e ENTORNO] [-p PUERTO] [-o HOST] [-s MANEJADOR]

Las opciones son:

  -h # ayuda
  -p # asigna el puerto (4567 es usado por defecto)
  -o # asigna el host (0.0.0.0 es usado por defecto)
  -e # asigna el entorno (development es usado por defecto)
  -s # especifica el servidor/manejador rack (thin es usado por defecto)
  -x # activa el mutex lock (est desactivado por defecto)

== Versiones de Ruby Soportadas

Las siguientes versiones de Ruby son soportadas oficialmente:

[ Ruby 1.8.7 ]
  1.8.7 es soportado completamente.  Sin embargo, si no hay nada que te lo
  prohba, te recomendamos que uss 1.9.2 o cambies a JRuby o Rubinius.  No se
  dejar de dar soporte a 1.8.7 hasta Sinatra 2.0 y Ruby 2.0, aunque si se
  libera la versin 1.8.8 de Ruby las cosas podran llegar a cambiar.  Sin
  embargo, que eso ocurra es muy poco probable, e incluso el caso de que lo
  haga, puede que se siga dando soporte a 1.8.7.  <b>Hemos dejado de soportar
  Ruby 1.8.6.</b> Si quers ejecutar Sinatra sobre 1.8.6, pods utilizar la
  versin 1.2, pero ten en cuenta que una vez que Sinatra 1.4.0 sea liberado,
  ya no se corregirn errores por ms que se reciban reportes de los mismos.

[ Ruby 1.9.2 ]
  1.9.2 es soportado y recomendado.  Ten en cuenta que Radius y Markaby no son
  compatibles con 1.9 actualmente.  Adems, no uss 1.9.2p0, porque se producen
  fallos de segmentacin cuando se ejecuta Sinatra.  El soporte se mantendr al
  menos hasta que se libere la versin 1.9.4/2.0 de Ruby.  El soporte para la
  ltima versin de la serie 1.9 se mantendr mientras lo haga el core team de
  Ruby.

[ Ruby 1.9.3 ]
  1.9.3 es soportado completamente.  De todas maneras, recomendamos esperar a
  que se liberen niveles de parche superiores (el actual es p0) antes de usarlo
  en produccin.  Es importante notar que el cambio desde una versin anterior a
  1.9.3 va a invalidar todas las sesiones.

[ Rubinius ]
  Rubinius es soportado oficialmente (Rubinius >= 1.2.4).  Todo funciona
  correctamente, incluyendo los lenguajes de plantillas.  La prxima versin,
  2.0, tambin es soportada.

[ JRuby ]
  JRuby es soportado oficialmente (JRuby >= 1.6.5).  No se conocen problemas
  con libreras de plantillas de terceras partes.  Sin embargo, si elegs usar
  JRuby, deberas examinar sus Rack handlers porque el servidor web Thin no es
  soportado completamente.  El soporte de JRuby para extensiones C se encuentra
  en una etapa experimental, sin embargo, de momento solamente RDiscount,
  Redcarpet y RedCloth se ven afectadas.

Siempre le prestamos atencin a las nuevas versiones de Ruby.

Las siguientes implementaciones de Ruby no se encuentran soportadas
oficialmente.  De cualquier manera, pueden ejecutar Sinatra:

* Versiones anteriores de JRuby y Rubinius
* Ruby Enterprise Edition
* MacRuby, Maglev e IronRuby
* Ruby 1.9.0 y 1.9.1 (pero no te recomendamos que los uss)

No estar soportada oficialmente, significa que si las cosas solamente se rompen
ah y no en una plataforma soportada, asumimos que no es nuestro problema sino
el suyo.

Nuestro servidor CI tambin se ejecuta sobre ruby-head (que ser la prxima
versin 2.0.0) y la rama 1.9.4.  Como estn en movimiento constante, no podemos
garantizar nada.  De todas formas, pods contar con que tanto 1.9.4-p0 como
2.0.0-p0 sea soportadas.

Sinatra debera funcionar en cualquier sistema operativo soportado por la
implementacin de Ruby elegida.

En este momento, no vas a poder ejecutar Sinatra en Cardinal, SmallRuby,
BlueRuby o cualquier versin de Ruby anterior a 1.8.7.

== A la Vanguardia

Si quers usar el cdigo de Sinatra ms reciente, sentite libre de ejecutar
tu aplicacin sobre la rama master, en general es bastante estable.

Tambin liberamos prereleases de vez en cuando, as, pods hacer

  gem install sinatra --pre

Para obtener algunas de las ltimas caractersticas.

=== Con Bundler

Esta es la manera recomendada para ejecutar tu aplicacin sobre la ltima
versin de Sinatra usando {Bundler}[http://gembundler.com/].

Primero, instal bundler si no lo hiciste todava:

  gem install bundler

Despus, en el directorio de tu proyecto, cre un archivo +Gemfile+:

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  # otras dependencias
  gem 'haml'                    # por ejemplo, si uss haml
  gem 'activerecord', '~> 3.0'  # quizs tambin necesits ActiveRecord 3.x

Ten en cuenta que tens que listar todas las dependencias directas de tu
aplicacin. No es necesario listar las dependencias de Sinatra (Rack y Tilt)
porque Bundler las agrega directamente.

Ahora pods arrancar tu aplicacin as:

  bundle exec ruby miapp.rb

=== Con Git

Clon el repositorio localmente y ejecut tu aplicacin, asegurndote que el
directorio <tt>sinatra/lib</tt> est en el <tt>$LOAD_PATH</tt>:

  cd miapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib miapp.rb

Para actualizar el cdigo fuente de Sinatra en el futuro:

  cd miapp/sinatra
  git pull

=== Instalacin Global

Pods construir la gem vos mismo:

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

Si instals tus gems como root, el ltimo paso debera ser

  sudo rake install

== Versionado

Sinatra utiliza el {Versionado Semntico}[http://semver.org/],
siguiendo las especificaciones SemVer y SemVerTag.

== Lecturas Recomendadas

* {Sito web del proyecto}[http://www.sinatrarb.com/] - Documentacin
  adicional, noticias, y enlaces a otros recursos.
* {Contribuyendo}[http://www.sinatrarb.com/contributing] - Encontraste un
  error?. Necesits ayuda?. Tens un parche?.
* {Seguimiento de problemas}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Lista de Correo}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] en http://freenode.net
* {Sinatra Book}[http://sinatra-book.gittr.com] Tutorial (en ingls).
* {Sinatra Recipes}[http://recipes.sinatrarb.com/] Recetas contribuidas
  por la comunidad (en ingls).
* Documentacin de la API para la
  {ltima versin liberada}[http://rubydoc.info/gems/sinatra] o para la
  {rama de desarrollo actual}[http://rubydoc.info/github/sinatra/sinatra]
  en http://rubydoc.info/
* {Servidor de IC}[http://ci.rkh.im/view/Sinatra/]

= Sinatra
<i>Attention : Ce document correspond  la traduction de la version anglaise et
il n'est peut tre plus  jour.</i>

Sinatra est un DSL pour crer rapidement et facilement des applications web en
Ruby :

  # mon_application.rb
  require 'sinatra'

  get '/' do
    'Bonjour le monde !'
  end

Installez la gem et lancez avec :

  gem install sinatra
  ruby -rubygems mon_application.rb

Le rsultat est visible sur : http://localhost:4567

Il est recommand d'excuter galement <tt>gem install thin</tt>, pour que
Sinatra utilise le server Thin quand il est disponible.

== Routes

Dans Sinatra, une route est une mthode HTTP couple  un masque (pattern)
URL. Chaque route est associe  un bloc :

  get '/' do
    .. montrer quelque chose ..
  end

  post '/' do
    .. crer quelque chose ..
  end

  put '/' do
    .. remplacer quelque chose ..
  end

  patch '/' do
    .. changer quelque chose ..
  end

  delete '/' do
    .. effacer quelque chose ..
  end

  options '/' do
    .. apaiser quelquechose ..
  end

Les routes sont values  dans l'ordre o elles ont t dfinies. La premire
route qui correspond  la requte est appele.

Les masques peuvent inclure des paramtres nomms, accessibles par
l'intermdiaire du hash <tt>params</tt> :

  get '/bonjour/:nom' do
    # rpond aux requtes "GET /bonjour/foo" et "GET /bonjour/bar"
    # params[:nom] est 'foo' ou 'bar'
    "Bonjour #{params[:nom]} !"
  end

Vous pouvez aussi accder aux paramtres nomms directement grce aux
paramtres du bloc comme ceci :

  get '/bonjour/:nom' do |n|
    "Bonjour #{n} !"
  end

Une route peut contenir un splat (caractre joker), accessible par
l'intermdiaire du tableau <tt>params[:splat]</tt> :

  get '/dire/*/a/*' do
    # rpond  /dire/bonjour/a/monde
    params[:splat] # => ["bonjour", "monde"]
  end

  get '/telecharger/*.*' do
    # rpond  /telecharger/chemin/vers/fichier.xml
    params[:splat] # => ["chemin/vers/fichier", "xml"]
  end

Ou par l'intermdiaire des paramtres du bloc :

  get '/telecharger/*.*' do |chemin, ext|
    [chemin, ext] # => ["path/to/file", "xml"]
  end

Une route peut aussi tre dfinie par une Expression Rgulire :

  get %r{/bonjour/([\w]+)} do
    "Bonjour, #{params[:captures].first} !"
  end

L encore on peut utiliser les paramtres de bloc :

  get %r{/bonjour/([\w]+)} do |c|
    "Bonjour, #{c} !"
  end

Les routes peuvent aussi comporter des paramtres optionnels :

  get '/posts.?:format?' do
    # rpond  "GET /posts" et aussi  "GET /posts.json", "GET /posts.xml" etc...
  end

=== Conditions

Les routes peuvent dfinir toutes sortes de conditions, comme par exemple le
"user agent" :

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Vous utilisez Songbird version #{params[:agent][0]}"
  end

  get '/foo' do
    # Correspond  tous les autres navigateurs
  end

Les autres conditions disponibles sont +host_name+ et +provides+ :

  get '/', :host_name => /^admin\./ do
    "Zone Administrateur, Accs refus !"
  end

  get '/', :provides => 'html' do
    haml :index
  end

  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

Vous pouvez facilement dfinir vos propres conditions :

  set(:probability) { |value| condition { rand <= value } }

  get '/gagner_une_voiture', :probability => 0.1 do
    "Vous avez gagn !"
  end

  get '/gagner_une_voiture' do
    "Dsol, vous avez perdu."
  end

Utilisez un splat (caractre joker) dans le cas d'une condition qui prend
plusieurs valeurs :

  set(:auth) do |*roles|   # <- ici on utilise un splat
    condition do
      unless logged_in? && roles.any? {|role| current_user.in_role? role }
        redirect "/login/", 303 
      end
    end
  end

  get "/mon/compte/", :auth => [:user, :admin] do
    "Informations sur votre compte"
  end

  get "/reserve/aux/admins/", :auth => :admin do  
    "Seuls les administrateurs sont accepts ici !"
  end

=== Valeurs de retour

La valeur renvoye par le bloc correspondant  une route constitue le corps de
la rponse qui sera transmise au client HTTP ou du moins au prochain middleware
dans la pile Rack. Le plus souvent, il s'agit d'une chane de caractres,
comme dans les exemples prcdents. Cependant, d'autres valeurs sont
acceptes.

Vous pouvez renvoyer n'importe quel objet qu'il s'agisse d'une rponse Rack
valide, d'un corps de rponse Rack ou d'un code statut HTTP :

* Un tableau de 3 lments : <tt>[code statut (Fixnum), enttes (Hash), corps
  de la rponse (rpondant  #each)]</tt>
* Un tableau de 2 lements : <tt>[code statut (Fixnum), corps de la rponse
  (rpondant  #each)]</tt>
* Un objet qui rpond  <tt>#each</tt> et qui ne transmet que des chanes de
  caractres au bloc fourni
* Un Fixnum reprsentant le code statut

Avec cela, on peut facilement implmenter un streaming par exemple :

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

Vous pouvez aussi utiliser le helper +stream+ (prsent un peu plus loin) pour
viter la surcharge et intgrer le traitement relatif au streaming dans le bloc
de code de la route.

=== Masques de route spcifiques

Comme cela a t vu auparavant, Sinatra offre la possibilit d'utiliser des
masques sous forme de chaines de caractres ou des expressions rgulires
pour dfinir les routes. Mais il est possible de faire bien plus. Vous pouvez
facilement dfinir vos propres masques :

  class MasqueToutSauf
    Masque = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Masque.new([])
    end

    def match(str)
      @caputres unless @except === str
    end
  end

  def tout_sauf(masque)
    MasqueToutSauf.new(masque)
  end

  get tout_sauf("/index") do
    # ...
  end

Notez que l'exemple ci-dessus est bien trop compliqu et que le mme rsultat
peut tre obtenu avec :

  get // do
    pass if request.path_info == "/index"
    # ...
  end

Ou bien en utilisant la forme ngative :

  get %r{^(?!/index$)} do
    # ...
  end

== Fichiers statiques

Les fichiers du dossier <tt>./public</tt> sont servis de faon statique. Vous
avez la possibilit d'utiliser un autre rpertoire en dfinissant le paramtre
<tt>:public_folder</tt> :

  set :public_folder, File.dirname(__FILE__) + '/statique'

Notez que le nom du dossier public n'apparait pas dans l'URL. Le fichier
<tt>./public/css/style.css</tt> sera appel via l'URL : 
<tt>http://exemple.com/css/style.css</tt>.

Utilisez le paramtre <tt>:static_cache_control</tt> pour ajouter l'information
d'en-tte <tt>Cache-Control</tt> (voir plus loin).

== Vues / Templates

Chaqie langage de template est disponible via sa propre mthode de rendu,
lesquelles renvoient tout simplement une chane de caractres.

  get '/' do
    erb :index
  end

Ceci effectue le rendu de la vue <tt>views/index.erb</tt>.

Plutt que d'utiliser le nom d'un template, vous pouvez directement passer
le contenu du template :

  get '/' do
    code = "<%= Time.now %>"
    erb code
  end

Les mthodes de templates acceptent un second paramtre, un hash d'options :

  get '/' do
    erb :index, :layout => :post
  end

Ceci effectuera le rendu de la vue <tt>views/index.erb</tt> en l'intgrant
au +layout+ <tt>views/post.erb</tt> (les vues Erb sont intgres par dfaut
au +layout+ <tt>views/layout.erb</tt> quand ce fichier existe).

Toute option que Sinatra ne comprend pas sera passe au moteur de rendu :

  get '/' do
    haml :index, :format => :html5
  end

Vous pouvez galement dfinir des options par langage de template de faon
gnrale :

  set :haml, :format => html5

  get '/' do
    haml :index
  end

Les options passes  la mthode de rendu prennent le pas sur les options
dfinies au moyen de +set+.

Options disponibles :

[locals]
  Liste de variables locales passes au document. Pratique pour les vues
  partielles.
  Exemple : <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>.

[default_encoding]
  Encodage de caractres  utiliser en cas d'incertitude. Par dfaut, c'est
  <tt>settings.default_encoding</tt>.

[views]
  Dossier de vues dans lequel chercher les templates. Par dfaut
  <tt>settings.views</tt>.

[layout]
  S'il faut ou non utiliser un +layout+ (+true+ or +false+). Indique le
  template  utiliser lorsque c'est un symbole. Exemple : <tt>erb :index,
  :layout => !request.xhr?</tt>.

[content_type]
  Content-Type que le template produit, dpend par dfaut du langage de
  template.

[scope]
  Contexte sous lequel effectuer le rendu du template. Par dfaut il s'agit
  de l'instance de l'application. Si vous changez cela, les variables
  d'instance et les mthodes utilitaires ne seront pas disponibles.

[layout_engine]
  Moteur de rendu  utiliser pour le +layout+. Utile pour les langages ne
  supportant pas les +layouts+. Il s'agit par dfaut du moteur utilis pour
  le rendu du template. Exemple : <tt>set :rdoc, :layout_engine => :erb</tt>

Les templates sont supposs se trouver directement dans le dossier
<tt>./views</tt>. Pour utiliser un dossier de vues diffrent :

  set :views, settings.root + '/templates'

Il est important de se souvenir que les templates sont toujours rfrencs
sous forme de symboles, mme lorsqu'ils sont dans un sous-rpertoire (dans
ce cas, utilisez <tt>:'sous_repertoire/template'</tt>). Il faut utiliser
un symbole car les mthodes de rendu valuent le contenu des chanes de
caractres au lieu de les considrer comme un chemin vers un fichier.

=== Langages de template disponibles

Certains langages ont plusieurs implmentations. Pour prciser l'implmentation
 utiliser (et garantir l'aspect thread-safe), vous devez simplement l'avoir
charge au pralable :

  require 'rdiscount' # ou require 'bluecloth'
  get('/') { markdown :index }

=== Templates Haml

Dpendances::             {haml}[http://haml.info/]
Extensions de fichier::   <tt>.haml</tt>
Exemple::                 <tt>haml :index, :format => :html5</tt>

=== Templates Erb

Dpendances::             {erubis}[http://www.kuwata-lab.com/erubis/] ou
                          erb (inclus avec Ruby)
Extensions de fichier::   <tt>.erb</tt>, <tt>.rhtml</tt> ou <tt>.erubis</tt>
                          (Erubis seulement)
Exemple::                 <tt>erb :index</tt>

=== Templates Builder

Dpendances::             {builder}[http://builder.rubyforge.org/]
Extensions de fichier::   <tt>.builder</tt>
Exemple::                 <tt>builder { |xml| xml.em "salut" }</tt>

Ce moteur accepte galement un bloc pour des templates en ligne (voir exemple).

=== Templates Nokogiri

Dpendances::             {nokogiri}[http://nokogiri.org/]
Extensions de fichier::   <tt>.nokogiri</tt>
Exemple::                 <tt>builder { |xml| xml.em "salut" }</tt>

Ce moteur accepte galement un bloc pour des templates en ligne (voir exemple).

=== Templates Sass

Dpendances::             {sass}[http://sass-lang.com/]
Extensions de fichier::   <tt>.sass</tt>
Exemple::                 <tt>sass :stylesheet, :style => :expanded</tt>

=== Templates SCSS

Dpendances::             {sass}[http://sass-lang.com/]
Extensions de fichier::   <tt>.scss</tt>
Exemple::                 <tt>scss :stylesheet, :style => :expanded</tt>

=== Templates Less

Dpendances::             {less}[http://www.lesscss.org/]
Extensions de fichier::   <tt>.less</tt>
Exemple::                 <tt>less :stylesheet</tt>

=== Templates Liquid

Dpendances::             {liquid}[http://www.liquidmarkup.org/]
Extensions de fichier::   <tt>.liquid</tt>
Exemple::                 <tt>liquid :index, :locals => { :key => 'value' }</tt>

Comme vous ne pouvez appeler de mthodes Ruby (autres que +yield+) dans un
template Liquid, vous aurez srement  lui passer des variables locales.

=== Templates Markdown

Dpendances::             {rdiscount}[https://github.com/rtomayko/rdiscount],
                          {redcarpet}[https://github.com/tanoku/redcarpet],
                          {bluecloth}[http://deveiate.org/projects/BlueCloth],
                          {kramdown}[http://kramdown.rubyforge.org/] *ou*
                          {maruku}[http://maruku.rubyforge.org/]
Extensions de fichier::   <tt>.markdown</tt>, <tt>.mkd</tt> et <tt>.md</tt>
Exemple::                 <tt>markdown :index, :layout_engine => :erb</tt>

Il n'est pas possible d'appeler des mthodes depuis markdown, ni de lui
passer des variables locales. Par consquent, il sera souvent utilis en
combinaison avec un autre moteur de rendu :

  erb :overview, :locals => { :text => markdown(:introduction) }

Notez que vous pouvez galement appeler la mthode +markdown+ au sein d'autres
templates :

  %h1 Hello From Haml !
  %p= markdown(:greetings)

Comme vous ne pouvez pas appeler de Ruby au sein de Markdown, vous ne pouvez
pas utiliser de +layouts+ crits en Markdown. Toutefois, il est possible
d'utiliser un moteur de rendu diffrent pour le template et pour le +layout+
en utilisant l'option <tt>:layout_engine</tt>.

=== Templates Textile

Dpendances::             {RedCloth}[http://redcloth.org/]
Extensions de fichier::   <tt>.textile</tt>
Exemple::                 <tt>textile :index, :layout_engine => :erb</tt>

Il n'est pas possible d'appeler des mthodes depuis textile, ni de lui
passer des variables locales. Par consquent, il sera souvent utilis en
combinaison avec un autre moteur de rendu :

  erb :overview, :locals => { :text => textile(:introduction) }

Notez que vous pouvez galement appeler la mthode +textile+ au sein d'autres
templates :

  %h1 Hello From Haml !
  %p= textile(:greetings)

Comme vous ne pouvez pas appeler de Ruby au sein de Textile, vous ne pouvez
pas utiliser de +layouts+ crits en Textile. Toutefois, il est possible
d'utiliser un moteur de rendu diffrent pour le template et pour le +layout+
en utilisant l'option <tt>:layout_engine</tt>.

=== Templates RDoc

Dpendances::             {rdoc}[http://rdoc.rubyforge.org/]
Extensions de fichier::   <tt>.rdoc</tt>
Exemple::                 <tt>rdoc :README, :layout_engine => :erb</tt>

Il n'est pas possible d'appeler des mthodes depuis rdoc, ni de lui
passer des variables locales. Par consquent, il sera souvent utilis en
combinaison avec un autre moteur de rendu :

  erb :overview, :locals => { :text => rdoc(:introduction) }

Notez que vous pouvez galement appeler la mthode +rdoc+ au sein d'autres
templates :

  %h1 Hello From Haml !
  %p= rdoc(:greetings)

Comme vous ne pouvez pas appeler de Ruby au sein de RDoc, vous ne pouvez
pas utiliser de +layouts+ crits en RDoc. Toutefois, il est possible
d'utiliser un moteur de rendu diffrent pour le template et pour le +layout+
en utilisant l'option <tt>:layout_engine</tt>.

=== Templates Radius

Dpendances::             {radius}[http://radius.rubyforge.org/]
Extensions de fichier::   <tt>.radius</tt>
Exemple::                 <tt>radius :index, :locals => { :key => 'value' }</tt>

Comme vous ne pouvez pas appeler de mthodes Ruby depuis un template Radius,
vous aurez srement  lui passer des variables locales.

=== Templates Markaby

Dpendances::             {markaby}[http://markaby.github.com/]
Extensions de fichier::   <tt>.mab</tt>
Exemple::                 <tt>markaby { h1 "Bienvenue !" }</tt>

Ce moteur accepte galement un bloc pour des templates en ligne (voir exemple).

=== Templates Slim

Dpendances::             {slim}[http://slim-lang.com/]
Extensions de fichier::   <tt>.slim</tt>
Exemple::                 <tt>slim :index</tt>

=== Templates Creole

Dpendances::             {creole}[https://github.com/minad/creole]
Extensions de fichier::   <tt>.creole</tt>
Exemple::                 <tt>creole :wiki, :layout_engine => :erb</tt>

Il n'est pas possible d'appeler des mthodes depuis creole, ni de lui
passer des variables locales. Par consquent, il sera souvent utilis en
combinaison avec un autre moteur de rendu :

  erb :overview, :locals => { :text => creole(:introduction) }

Notez que vous pouvez galement appeler la mthode +creole+ au sein d'autres
templates :

  %h1 Hello From Haml !
  %p= creole(:greetings)

Comme vous ne pouvez pas appeler de Ruby au sein de Creole, vous ne pouvez
pas utiliser de +layouts+ crits en Creole. Toutefois, il est possible
d'utiliser un moteur de rendu diffrent pour le template et pour le +layout+
en utilisant l'option <tt>:layout_engine</tt>.

=== Templates CoffeeScript

Dpendances::             {coffee-script}[https://github.com/josh/ruby-coffee-script]
                          et un {moyen d'excuter javascript}[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
Extensions de fichier::   <tt>.coffee</tt>
Exemple::                 <tt>coffee :index</tt>

=== Templates embarqus

  get '/' do
    haml '%div.title Bonjour le monde'
  end

Gnrera le code du template spcifi dans la chane de caractres.

=== Accder aux variables dans un Template

Un template est valu dans le mme contexte que l'endroit d'o il a t
appel (gestionnaire de route). Les variables d'instance dclares dans le
gestionnaire de route sont directement accessibles dans le template :

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.nom'
  end

Alternativement, on peut passer un hash contenant des variables locales :

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.nom', :locals => { :foo => foo }
  end

Ceci est gnralement utilis lorsque l'on veut utiliser un template comme
partiel (depuis un autre template) et qu'il est donc ncessaire d'adapter les
noms de variables.

=== Templates dans le fichier source

Des templates peuvent tre dfinis dans le fichier source comme ceci :

  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Bonjour le monde !

NOTE : Les templates du fichier source qui contient <tt>require 'sinatra'</tt>
sont automatiquement chargs. Si vous avez des templates dans d'autres
fichiers source, il faut explicitement les dclarer avec
<tt>enable :inline_templates</tt>.

=== Templates nomms

Les templates peuvent aussi tre dfinis grce  la mthode de haut niveau
<tt>template</tt> :

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Bonjour le monde !'
  end

  get '/' do
    haml :index
  end

Si un template nomm "layout" existe, il sera utilis  chaque fois qu'un
template sera affich. Vous pouvez dsactivez les layouts au cas par cas en
passant <tt>:layout => false</tt> ou bien les dsactiver par dfaut au moyen
de <tt>set :haml, :layout => false</tt> :

  get '/' do
    haml :index, :layout => !request.xhr?
  end

=== Associer des extensions de fichier

Pour associer une extension de fichier avec un moteur de rendu, utilisez
<tt>Tilt.register</tt>. Par exemple, si vous dsirez utiliser l'extension
de fichier +tt+ pour les templates Textile, vous pouvez faire comme suit :

  Tilt.register :tt, Tilt[:textile]

=== Ajouter son propre moteur de rendu

En premier lieu, dclarez votre moteur de rendu avec Tilt, ensuite crez
votre mthode de rendu :

  Tilt.register :monmoteur, MonMerveilleurMoteurDeRendu

  helpers do
    def monmoteur(*args) render(:monmoteur, *args) end
  end

  get '/' do
    monmoteur :index
  end

Utilisera <tt>./views/index.monmoteur</tt>. Voir
https://github.com/rtomayko/tilt pour en savoir plus sur Tilt.

== Filtres

Un filtre <tt>before</tt> est valu avant n'importe quelle requte, dans le
contexte de celle-ci, et peut modifier la requte ou la rponse. Les variables
d'instance dclares dans le filtre sont accessibles au gestionnaire de route
et au template :

  before do
    @note = 'Coucou !'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Coucou !'
    params[:splat] #=> 'bar/baz'
  end

Un filtre <tt>after</tt> est valu aprs chaque requte, dans le contexte
de celle-ci et peut galement modifier la requte et/ou la rponse. Toutes les
variables d'instance dclares dans un filtre <tt>before</tt> et dans le
gestionnaire de route sont accessibles dans le filtre <tt>after</tt> :

  after do
    puts response.status
  end

Note : Sauf si vous utilisez la mthode +body+ au lieu de renvoyer une chane
de caractres dans vos gestionnaires de routes, le corps de la rponse ne sera
pas disponible dans le filtre <tt>after</tt>, tant donn qu'il est gnr
plus tard.

En option, on peut passer un masque au filtre, ce qui le rend actif uniquement
si la requte correspond au masque en question :

  before '/secret/*' do
    authentification!
  end

  after '/faire/:travail' do |travail|
    session[:dernier_travail] = travail
  end

Tout comme les routes, les filtres acceptent galement les conditions :

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== Helpers

Utilisez la mthode de haut niveau <tt>helpers</tt> pour dfinir des routines
qui seront accessibles dans vos gestionnaires de route et dans vos templates :

  helpers do
    def bar(nom)
      "#{nom}bar"
    end
  end

  get '/:nom' do
    bar(params[:nom])
  end

Vous pouvez aussi dfinir les mthodes helper dans un module spar :

  module FooUtils
    def foo(nom) "#{nom}foo" end
  end

  module BarUtils
    def bar(nom) "#{nom}bar" end
  end

  helpers FooUtils, BarUtils

Cela a le mme rsultat que d'inclure les modules dans la classe de
l'application.

=== Utiliser les sessions

Une session est utilise pour conserver un tat entre les requtes. Une fois
actives, vous avez un +hash+ de session par session utilisateur :

  enable :sessions

  get '/' do
    "valeur = " << session[:valeur].inspect
  end

  get '/:value' do
    session[:valeur] = params[:valeur]
  end

Notez que <tt>enable :sessions</tt> enregistre en fait toutes les donnes dans
un +cookie+. Ce n'est pas toujours ce que vous voulez (enregistrer beaucoup de
donnes va augmenter le traffic par exemple). Vous pouvez utiliser n'importe
quel +middleware+ Rack de session afin d'viter cela. N'utiliser *pas*
<tt>enable :sessions</tt> dans ce cas mais charger le +middleware+ de votre
choix comme vous le feriez pour n'importe quel autre +middleware+ :

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "valeur = " << session[:valeur].inspect
  end

  get '/:value' do
    session[:valeur] = params[:valeur]
  end

Pour renforcer la scurit, les donnes de session dans le cookie sont signes
avec une cl secrte de session. Une cl secrte est gnre pour vous au
hasard par Sinatra. Toutefois, comme cette cl change  chaque dmarrage de
votre application, vous pouvez dfinir cette cl vous-mme afin que toutes
les instances de votre application la partage :

  set :session_secret, 'super secret'

Si vous souhaitez avoir plus de contrle, vous pouvez galement enregistrer un
+hash+ avec des options lors de la configuration de +sessions+ :

  set :sessions, :domain => 'foo.com'

=== Halt

Pour arrter immdiatement la requte dans un filtre ou un gestionnaire de
route :

  halt

Vous pouvez aussi passer le code retour ...

  halt 410

Ou le texte ...

  halt 'Ceci est le texte'

Ou les deux ...

  halt 401, 'Partez !'

Ainsi que les enttes ...

  halt 402, {'Content-Type' => 'text/plain'}, 'revanche'

Bien sr il est possible de combiner un template avec +halt+ :

  halt erb(:erreur)

=== Passer

Une route peut passer le relais aux autres routes qui correspondent galement
avec <tt>pass</tt> :

  get '/devine/:qui' do
    pass unless params[:qui] == 'Frank'
    "Tu m'as eu !"
  end

  get '/devine/*' do
    'Manqu !'
  end

On sort donc immdiatement de ce gestionnaire et on continue  chercher,
dans les masques suivants, le prochain qui correspond  la requte.
Si aucun des masques suivants ne correspond, un code 404 est retourn.

=== Dclencher une autre route

Parfois, +pass+ n'est pas ce que vous recherchez, au lieu de cela vous
souhaitez obtenir le rsultat d'une autre route. Pour cela, utilisez
simplement +call+ :

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

Notez que dans l'exemple ci-dessus, vous faciliterez les tests et amliorerez
la performance en dplaant simplement <tt>"bar"</tt> dans un +helper+
utilis  la fois par <tt>/foo</tt> et <tt>/bar</tt>.

Si vous souhiatez que la requte soit envoye  la mme instance de
l'application plutt qu' une copie, utilisez <tt>call!</tt> au lieu de
<tt>call</tt>.

Lisez la spcification Rack si vous souhaitez en savoir plus sur
<tt>call</tt>.

=== Dfinir le corps, le code retour et les enttes

Il est possible et recommand de dfinir le code retour et le corps de la
rponse au moyen de la valeur de retour d'un bloc dfinissant une route.
Quoiqu'il en soit, dans certains cas vous pourriez avoir besoin de dfinir
le coprs de la rponse  un moment arbitraire de l'excution. Vous pouvez le
faire au moyen de la mthode +body+. Si vous faites ainsi, vous pouvez alors
utiliser cette mme mthode pour accder au corps de la rponse :

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

Il est galement possible de passer un bloc  +body+, qui sera excut par le
gestionnaire Rack (ceci peut tre utilis pour implmenter un +streaming+,
voir "Valeurs de retour").

Pareillement au corps de la rponse, vous pouvez galement dfinir le code
retour et les enttes :

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "Je suis une thire !"
  end

Comme +body+, +headers+ et +status+ peuvent tre utiliss sans arguments
pour accder  leurs valeurs.

=== Faire du streaming

Il y a des cas o vous voulez commencer  renvoyer des donnes pendant que
vous tes en train de gnrer le reste de la rponse. Dans les cas les plus
extrmes, vous souhaitez continuer  envoyer des donnes tant que le client
n'abandonne pas la connection. Vous pouvez alors utiliser le helper +stream+
pour viter de crer votre propre systme :

  get '/' do
    stream do |out|
      out << "Ca va tre hallu -\n"
      sleep 0.5
      out << " (attends la suite) \n"
      sleep 1
      out << "- cinant !\n"
    end
  end

Cela permet d'implmenter des API de streaming ou de
{Server Sent Events}[http://dev.w3.org/html5/eventsource/] et peut servir de
base pour des {WebSockets}[http://en.wikipedia.org/wiki/WebSocket]. Vous
pouvez aussi l'employer pour augmenter le dbit quand une partie du contenu
provient d'une resource lente.

Le fonctionnement du streaming, notamment le nombre de requtes simultanes,
dpend normment du serveur web utilis. Certains ne prennent pas du tout en
charge le streaming (WEBRick par exemple). Lorsque le serveur ne gre pas le
streaming, la partie body de la rponse sera envoye au client en une seule
fois, aprs que l'excution du bloc pass au helper +stream+ sera termine. Le
streaming ne fonctionne pas du tout avec Shotgun.

En utilisant le helper +stream+ avec le paramtre +keep_open+, il n'appelera
pas la mthode +close+ du flux, vous laissant la possibilit de le fermer 
tout moment au cours de l'excution. Ceci ne fonctionne qu'avec les serveurs
evented (ie non threads) tels que Thin et Rainbows. Les autres serveurs
fermeront malgr tout le flux.

  set :server, :thin
  connections = []

  get '/' do
    # conserve le flux ouvert
    stream(:keep_open) { |out| connections << out }
  end

  post '/' do
    # crit dans tous les flux ouverts
    connections.each { |out| out << params[:message] << "\n" }
    "message sent"
  end

=== Journalisation (Logging)

Dans le contexte de la requte, la mthode utilitaire +logger+ expose une
instance de +logger+ :

  get '/' do
    logger.info "chargement des donnes"
    # ...
  end

Ce +logger+ va automatiquement prendre en compte les paramtres de
configuration pour la journalisation de votre gestionnaire Rack. Si la
journalisation est dsactive, cette mthode renverra un objet factice et
vous n'avez pas  vous en inquiter dans vos routes en le filtrant.

Notez que la journalisation est seulement active par dfaut pour
<tt>Sinatra::Application</tt>, donc si vous hritez de <tt>Sinatra::Base</tt>,
vous aurez  l'activer vous-mme :

  class MonApp < Sinatra::Base
    configure :production, :development do
      enable :logging
    end
  end

=== Types Mime

Quand vous utilisez <tt>send_file</tt> ou des fichiers statiques, vous
pouvez rencontrer des types mime que Sinatra ne connat pas. Utilisez
+mime_type+ pour les dclarer par extension de fichier :

  configure do
    mime_type :foo, 'text/foo'
  end

Vous pouvez galement les utiliser avec la mthode +content_type+ :

  get '/' do
    content_type :foo
    "foo foo foo"
  end

=== Former des URLs

Pour former des URLs, vous devriez utiliser la mthode +url+, par exemple en
Haml :

  %a{:href => url('/foo')} foo

Cela prend en compte les proxy inverse et les routeurs Rack, s'ils existent.

Cette mthode est galement disponible sous l'alias +to+ (voir ci-dessous
pour un exemple).

=== Redirection du navigateur

Vous pouvez dclencher une redirection du navigateur avec la mthode
+redirect+ :

  get '/foo' do
    redirect to('/bar')
  end

Tout paramtre additionnel est gr comme des arguments pour la mthode
+halt+ :

  redirect to('/bar'), 303
  redirect 'http://google.com', 'mauvais endroit mon pote'

Vous pouvez aussi rediriger vers la page dont l'utilisateur venait au moyen de
<tt>redirect back</tt> :

  get '/foo' do
    "<a href='/bar'>faire quelque chose</a>"
  end

  get '/bar' do
    faire_quelque_chose
    redirect back
  end

Pour passer des arguments  une redirection, ajoutez-les soit  la requte :

  redirect to('/bar?sum=42')

Ou bien utilisez une session :

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end

=== Contrle du cache

Dfinir correctement vos enttes  la base pour un bon cache HTTP.

Vous pouvez facilement dfinir l'entte Cache-Control de la manire suivante :

  get '/' do
    cache_control :public
    "met le en cache !"
  end

Conseil de pro : dfinir le cache dans un filtre +before+ :

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

Si vous utilisez la mthode +expires+ pour dfinir l'entte correspondant,
<tt>Cache-Control</tt> sera alors dfini automatiquement :

  before do
    expires 500, :public, :must_revalidate
  end

Pour utiliser correctement les caches, vous devriez utiliser +etag+ ou
+last_modified+. Il est recommand d'utiliser ces mthodes *avant* de faire
d'importantes modifications, car elles vont immdiatement dclencher la rponse
si le client a dj la version courante dans son cache :

  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end

Il est galement possible d'utiliser un
{weak ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation] :

  etag @article.sha1, :weak

Ces mthodes ne sont pas charges de mettre des donnes en cache, mais elles
fournissent les informations ncessaires pour votre cache. Si vous tes  la
recherche de solutions rapides pour un reverse-proxy de cache, essayez
{rack-cache}[http://rtomayko.github.com/rack-cache/] :

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

=== Envoyer des fichiers

Pour envoyer des fichiers, vous pouvez utiliser la mthode
<tt>send_file</tt> :

  get '/' do
    send_file 'foo.png'
  end

Quelques options sont galement acceptes :

  send_file 'foo.png', :type => :jpg

Les options sont :

[filename]
  le nom du fichier dans la rponse, par dfaut le nom du fichier envoy.

[last_modified]
  valeur pour l'entte Last-Modified, par dfaut la date de modification du
  fichier

[type]
  type de contenu  utiliser, devin  partir de l'extension de fichier si
  absent

[disposition]
  utilis pour Content-Disposition, les valuers possibles tant : +nil+ (par
  dfaut), <tt>:attachment</tt> et <tt>:inline</tt>

[length]
  entte Content-Length, par dfaut la taille du fichier

Si le gestionnaire Rack le supporte, d'autres moyens que le +streaming+ via le
processus Ruby seront utiliss. Si vous utilisez cette mthode, Sinatra grera
automatiquement les requtes de type +range+.

=== Accder  l'objet requte

L'objet correspondant  la requte envoye peut tre rcupr dans le contexte
de la requte (filtres, routes, gestionnaires d'erreur) au moyen de la mthode
+request+ :

  # application tournant  l'adresse http://exemple.com/exemple
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                # corps de la requte envoye par le client
                                # (voir ci-dessous)
    request.scheme              # "http"
    request.script_name         # "/exemple"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      # taille de request.body
    request.media_type          # type de mdia pour request.body
    request.host                # "exemple.com"
    request.get?                # true (mthodes similaires pour les autres
                                # verbes HTTP)
    request.form_data?          # false
    request["UN_ENTETE"]        # valeur de l'entte UN_ENTETE
    request.referer             # rfrant du client ou '/'
    request.user_agent          # user agent (utilis par la condition :agent)
    request.cookies             # tableau contenant les cookies du navigateur
    request.xhr?                # requte AJAX ?
    request.url                 # "http://exemple.com/exemple/foo"
    request.path                # "/exemple/foo"
    request.ip                  # adresse IP du client
    request.secure?             # false
    request.forwarded?          # vrai (si on est derrire un proxy inverse)
    request.env                 # tableau brut de l'environnement fourni par
                                # Rack
  end

Certaines options, telles que <tt>script_name</tt> ou <tt>path_info</tt>
peuvent galement tre modifies :

  before { request.path_info = "/" }

  get "/" do
    "toutes les requtes arrivent ici"
  end

<tt>request.body</tt> est un objet IO ou StringIO :

  post "/api" do
    request.body.rewind  # au cas o il a dj t lu
    donnees = JSON.parse request.body.read
    "Bonjour #{donnees['nom']} !"
  end

=== Fichiers joints

Vous pouvez utiliser la mthode +attachment+ pour indiquer au navigateur que
la rponse devrait tre stocke sur le disque plutt qu'affiche :

  get '/' do
    attachment
    "enregistre-le !"
  end

Vous pouvez galement lui passer un nom de fichier :

  get '/' do
    attachment "info.txt"
    "enregistre-le !"
  end

=== Grer Date et Time

Sinatra fourni un helper +time_for+ pour convertir une valeur donne en
objet +Time+. Il peut aussi faire la conversion  partir d'objets +DateTime+,
+Date+ ou de classes similaires.

  get '/' do
    pass if Time.now > time_for('Dec 23, 2012')
    "encore temps"
  end

Cette mthode est utilise en interne par +expires+, +last_modified+ et
consorts. Par consquent, vous pouvez trs facilement tendre le
fonctionnement de ces mthodes en surchargeant le helper +time_for+ dans
votre application :

  helpers do
    def time_for(value)
      case value
      when :yesterday then Time.now - 24*60*60
      when :tomorrow  then Time.now + 24*60*60
      else super
      end
    end
  end

  get '/' do
    last_modified :yesterday
    expires :tomorrow
    "salut"
  end

=== Chercher les fichiers de templates

La mthode <tt>find_template</tt> est utilise pour trouver les fichiers de
templates  gnrer :

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "pourrait tre #{file}"
  end

Ce n'est pas trs utilise. En revanche, il est utile de pouvoir surcharger
cette mthode afin de dfinir son propre mcanisme de recherche. Par exemple,
vous pouvez utiliser plus d'un rpertoire de vues :

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

Un autre exemple est d'utiliser des rpertoires diffrents pour des moteurs
de rendu diffrents :

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end

Vous pouvez galement crire cela dans une extension et la partager avec
d'autres !

Notez que <tt>find_template</tt> ne vrifie pas que le fichier existe mais
va plutt excuter le bloc pour tous les chemins possibles. Cela n'induit pas
un problme de performance dans le sens o +render+ va utiliser +break+ ds
qu'un fichier est trouv. De plus, l'emplacement des templates (et leur
contenu) est mis en cache si vous n'tes pas en mode dveloppement. Vous
devriez garder cela en tte si vous crivez une mthode vraiment dingue.

== Configuration

Lanc une seule fois au dmarrage de tous les environnements :

  configure do
    # dfinir un paramtre
    set :option, 'value'

    # dfinir plusieurs paramtre
    set :a => 1, :b => 2

    # identique  "set :option, true"
    enable :option

    # identique  "set :option, false""
    disable :option

    # vous pouvez galement avoir des paramtres dynamiques avec des blocs
    set(:css_dir) { File.join(views, 'css') }
  end

Lanc si l'environnement (variable d'environnement RACK_ENV) est dfini comme
<tt>:production</tt> :

  configure :production do
    ...
  end

Lanc si l'environnement est <tt>:production</tt> ou
<tt>:test</tt> :

  configure :production, :test do
    ...
  end

Vous pouvez accder  ces paramtres via <tt>settings</tt> :

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

=== Se protger des attaques

Sinatra utilise {Rack::Protection}[https://github.com/rkh/rack-protection#readme]
pour protger votre application contre les principales attaques opportunistes.
Vous pouvez trs simplement dsactiver cette fonctionnalit (ce qui exposera
votre application  beaucoup de vulnerabilits courantes) :

  disable :protection

Pour dsactiver seulement un type de protection, vous pouvez dfinir +protection+
avec un hash d'options : 

  set :protection, :except => :path_traversal

Vous pouvez galement lui passer un tableau pour dsactiver plusieurs types de
protection :

  set :protection, :except => [:path_traversal, :session_hijacking]

=== Paramtres disponibles

[absolute_redirects]  Si dsactiv, Sinatra permettra les redirections
                      relatives. Toutefois, Sinatra ne sera plus conforme  la
                      RFC 2616 (HTTP 1.1), qui n'autorise que les redirections
                      absolues.

                      Activez si votre application tourne derrire un proxy
                      inverse qui n'a pas t correctement configur. Notez
                      que la mthode +url+ continuera de produire des URLs
                      absolues, sauf si vous lui passez +false+ comme second
                      argument.

                      Dsactiv par dfaut.

[add_charsets]        types mime pour lesquels la mthode
                      <tt>content_type</tt> va automatiquement ajouter
                      l'information du +charset+.

                      Vous devriez lui ajouter des valeurs plutt que de
                      l'craser :

                        settings.add_charsets << "application/foobar"

[app_file]            fichier de l'application principale, utilis pour
                      dtecterla racine du projet, le dossier public et le
                      dossier de vues ainsi que pour les templates en ligne.

[bind]                adresse IP sur laquelle se brancher
                      (par dfaut : 0.0.0.0).
                      Utiliser seulement pour le serveur intgr.

[default_encoding]    encodage  utiliser si inconnu (par dfaut
                      <tt>"utf-8"</tt>).

[dump_errors]         afficher les erreurs dans le +log+.

[environment]         environnement courant, par dfaut
                      <tt>ENV['RACK_ENV']</tt>, ou
                      <tt>"development"</tt> si absent.

[logging]             utiliser le +logger+.

[lock]                Place un +lock+ autour de chaque requte, n'excutant
                      donc qu'une seule requte par processus Ruby.

                      Activ si votre application n'est pas +thread-safe+.
                      Dsactiv par dfaut.

[method_override]     utilise la magie de <tt>_method</tt> afin de permettre
                      des formulaires put/delete dans des navigateurs qui ne
                      le permettent pas.

[port]                port  couter. Utiliser seulement pour le serveur
                      intgr.

[prefixed_redirects]  si oui ou non <tt>request.script_name</tt> doit tre
                      insr dans les redirections si un chemin non absolu
                      est utilis. Ainsi, <tt>redirect '/foo'</tt> se
                      comportera comme <tt>redirect to('/foo')</tt>.
                      Dsactiv par dfaut.

[public_folder]       dossier duquel les fichiers publics sont servis

[reload_templates]    si oui ou non les templates doivent tre rechargs
                      entre les requtes. Activ en mode dveloppement.

[root]                dossier racine du projet.

[raise_errors]        soulever les erreurs (ce qui arrtera l'application).

[run]                 si activ, Sinatra s'occupera de dmarrer le serveur,
                      ne pas activer si vous utiliser rackup ou autres.

[running]             est-ce que le serveur intgr est en marche ?
                      ne changez pas ce paramtre !

[server]              serveur ou liste de serveurs  utiliser pour le serveur
                      intgr.
                      Par dfaut ['thin', 'mongrel', 'webrick'], l'ordre
                      indiquant la priorit.

[sessions]            active l'enregistrement des sessions en utilisant les
                      cookies.

[show_exceptions]     affiche la trace de l'erreur dans le navigateur.

[static]              Si oui ou non Sinatra doit s'occuper de servir les
                      fichiers statiques.
                      Dsactivez si vous utilisez un serveur capable de le
                      grer lui mme. Le dsactiver augmentera la performance.
                      Activ par dfaut pour le style classique, dsactiv pour
                      le style modulaire.

[threaded]             dfinir  +true+ pour indiquer  Thin d'utiliser
                      <tt>EventMachine.defer</tt> pour traiter la requte.

[views]               dossier des vues.

== Environements

Il existe trois environnements prdfinis : <tt>"development"</tt>,
<tt>"production"</tt> et <tt>"test"</tt>. Les environements peuvent tre
slectionn via la variable d'environnement +RACK_ENV+. Sa valeur par dfaut
est <tt>"development"</tt>. Dans ce mode, tous les templates sont rechargs 
chaque requte. Des handlers spcifiques pour <tt>not_found</tt> et
<tt>error</tt> sont installs pour vous permettre d'avoir une pile de trace
dans votre navigateur. En mode <tt>"production"</tt> et <tt>"test"</tt> les
templates sont mis en cache par dfaut.

Pour excuter votre application dans un environnement diffrent, utilisez
l'option <tt>-e</tt> de Ruby :

  ruby mon_application.rb -e [ENVIRONMENT]

Vous pouvez utiliser une des mthodes +development?+, +test?+ et +production?+
pour dterminer quel est l'environnement en cours.

== Grer les erreurs

Les gestionnaires d'erreur s'excutent dans le mme contexte que les routes ou
les filtres, ce qui veut dire que vous avez accs (entre autres) aux bons
vieux <tt>haml</tt>, <tt>erb</tt>, <tt>halt</tt>, etc.

=== NotFound

Quand une exception <tt>Sinatra::NotFound</tt> est souleve, ou que le code
retour est 404, le gestionnaire <tt>not_found</tt> est invoqu :

  not_found do
    'Pas moyen de trouver ce que vous cherchez'
  end

=== Error

Le gestionnaire +error+ est invoqu  chaque fois qu'une exception est
souleve dans une route ou un filtre. L'objet exception est accessible via la
variable Rack <tt>sinatra.error</tt> :

  error do
    'Dsol mais une mchante erreur est survenue - ' + env['sinatra.error'].name
  end

Erreur sur mesure :

  error MonErreurSurMesure do
    'Donc il est arriv ceci...' + env['sinatra.error'].message
  end

Donc si ceci arrive :

  get '/' do
    raise MonErreurSurMesure, 'quelque chose de mal'
  end

Vous obtenez a :

  Donc il est arriv ceci... quelque chose de mal

Alternativement, vous pouvez avoir un gestionnaire d'erreur associ  un code
particulier :

  error 403 do
    'Accs interdit'
  end

  get '/secret' do
    403
  end

Ou un intervalle :

  error 400..510 do
    'Boom'
  end

Sinatra installe pour vous quelques gestionnaires <tt>not_found</tt> et
<tt>error</tt> gnriques lorsque vous tes en environnement
<tt>development</tt>.

== Les Middlewares Rack

Sinatra tourne avec Rack[http://rack.rubyforge.org/], une interface standard
et minimale pour les web frameworks Ruby. Un des points forts de Rack est le
support de ce que l'on appelle des "middlewares" -- composant qui vient se
situer entre le serveur et votre application, et dont le but est de
visualiser/manipuler la requte/rponse HTTP, et d'offrir diverses
fonctionnalits classiques.

Sinatra permet de construire facilement des middlewares Rack via la mthode de
haut niveau +use+ :

  require 'sinatra'
  require 'mon_middleware_perso'

  use Rack::Lint
  use MonMiddlewarePerso

  get '/bonjour' do
    'Bonjour le monde'
  end

La smantique de +use+ est identique  celle dfinie dans le DSL de
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html]
(le plus souvent utilis dans un fichier rackup). Par exemple, la mthode
+use+ accepte divers arguments ainsi que des blocs :

  use Rack::Auth::Basic do |login, password|
    login == 'admin' && password == 'secret'
  end

Rack est distribu avec une bonne varit de middlewares standards pour les
logs, dbuguer, faire du routage URL, de l'authentification, grer des
sessions. Sinatra utilise beaucoup de ces composants automatiquement via la
configuration, donc pour ceux-ci vous n'aurez pas  utiliser la mthode +use+.

== Tester

Les tests pour Sinatra peuvent tre crit avec n'importe quelle bibliothque
base sur Rack. {Rack::Test}[http://gitrdoc.com/brynary/rack-test] est
recommand :

  require 'mon_application_sinatra'
  require 'test/unit'
  require 'rack/test'

  class MonTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_ma_racine
      get '/'
      assert_equal 'Bonjour le monde !', last_response.body
    end

    def test_avec_des_parametres
      get '/rencontrer', :name => 'Frank'
      assert_equal 'Salut Frank !', last_response.body
    end

    def test_avec_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Vous utilisez Songbird !", last_response.body
    end
  end

== Sinatra::Base - Les Middlewares, les Bibliothques, et les Applications Modulaires

Dfinir votre application au niveau suprieur fonctionne bien pour les
micro-applications, mais peut s'avrer moins pratique lorsqu'il s'agit
de crer des composants rutilisables comme des middlewares Rack, faire
du Rails metal, ou de simples bibliothques avec un composant serveur, ou
mme une extension pour Sinatra. Le DSL de haut niveau pollue l'espace de noms
et est une configuration adapte  une micro-application (un fichier unique
pour l'application, les dossiers <tt>./public</tt> et <tt>./views</tt>, les
logs, pages d'erreur, etc.). C'est l que <tt>Sinatra::Base</tt> entre en jeu :

  require 'sinatra/base'

  class MonApplication < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Bonjour le monde !'
    end
  end

Les mthodes disponibles dans <tt>Sinatra::Base</tt> sont exactement identiques
 celles disponibles dans le DSL de haut niveau. La plupart des applications
de haut niveau peuvent tre converties en composant <tt>Sinatra::Base</tt> avec
deux modifications :

* Votre fichier doit charger +sinatra/base+ au lieu de +sinatra+ ;
  autrement, toutes les mthodes de la DSL seront charges dans l'espace
  de noms.
* Mettre vos gestionnaires de route, vos gestionnaires d'erreur, vos filtres
  et options dans une sous-classe de <tt>Sinatra::Base</tt>.

<tt>Sinatra::Base</tt> est plutt pur. La plupart des options sont
dsactives par dfaut, ceci inclus le serveur. Voir {Options et
Configuration}[http://sinatra.github.com/configuration.html]
pour plus de dtails sur les options et leur comportement.

=== Style modulaire vs. style classique

Contrairement aux croyanaces, le style classique n'a rien de mauvais. Si cela
convient  votre application, vous n'avez pas  changer pour une application
modulaire.

Il n'y a que deux inconvnient au style classique compar au style modulaire :

* Vous ne pouvez avoir qu'une seule application Sinatra par processus Ruby. Si
  vous envisagez d'en utiliser plus, passez au style modulaire

* Le style classique pollue  la classe Object avec des mthodes dlguantes.
  Si vous prvoyez de diffuser votre application dans une bibliothque/gem,
  passez au style modulaire.

Il n'y pas d'empchement  mlanger style classic et style modulaire.

Si vous passez d'un style  l'autre, vous devriez tre vigilant  quelques
lgres diffrences dans les paramtres par dfaut :

  Paramtre           Classique                     Modulaire

  app_file            fichier chargeant sinatra     nil
  run                 $0 == app_file                false
  logging             true                          false
  method_override     true                          false
  inline_templates    true                          false
  static              true                          false


=== Servir une application modulaire

Il y a deux faons de faire pour dmarrer une application modulaire, dmarrez
avec <tt>run!</tt> :

  # my_app.rb
  require 'sinatra/base'

  class MyApp < Sinatra::Base
    # ... code de l'application ici ...

    # dmarre le serveur si ce fichier est directement excut
    run! if app_file == $0
  end

Dmarrez ensuite avec :

  ruby my_app.rb

Ou alors avec un fichier <tt>config.ru</tt>, qui permet d'utiliser n'importe
quel gestionnaire Rack :

  # config.ru
  require './my_app'
  run MyApp

Excutez :

  rackup -p 4567

=== Utiliser une application de style classique avec un fichier config.ru

Ecrivez votre application :

  # app.rb
  require 'sinatra'

  get '/' do
    'Bonjour le monde !'
  end

Et un fichier <tt>config.ru</tt> correspondant :

  require './app'
  run Sinatra::Application

=== Quand utiliser un fichier config.ru ?

Quelques cas o vous devriez utiliser un fichier <tt>config.ru</tt> :

* Vous souhaitez dployer avec un autre gestionnaire Rack (Passenger, Unicorn,
  Heroku, ...).
* Vous souhaitez utiliser plus d'une sous-classe de <tt>Sinatra::Base</tt>.
* Vous voulez utiliser Sinatra comme un +middleware+, non en tant que
  +endpoint+.

<b>Il n'est pas ncessaire de passer par un fichier <tt>config.ru</tt> pour la
seule raison que vous tes pass au style modulaire, et vous n'avez pas besoin
de passer au style modulaire pour utiliser un fichier <tt>config.ru</tt>.</b>

=== Utiliser Sinatra comme Middleware

Non seulement Sinatra peut utiliser d'autres middlewares Rack, il peut
galement tre  son tour utilis au-dessus de n'importe quel +endpoint+ Rack
en tant que middleware. Ce +endpoint+ peut trs bien tre une autre
application Sinatra, ou n'importe quelle application base sur Rack
(Rails/Ramaze/Camping/...) :

  require 'sinatra/base'

  class EcranDeConnexion < Sinatra::Base
    enable :sessions

    get('/connexion') { haml :connexion }

    post('/connexion') do
      if params[:nom] = 'admin' && params[:motdepasse] = 'admin'
        session['nom_utilisateur'] = params[:nom]
      else
        redirect '/connexion'
      end
    end
  end

  class MonApp < Sinatra::Base
    # le middleware sera appel avant les filtres
    use EcranDeConnexion

    before do
      unless session['nom_utilisateur']
        halt "Accs refus, merci de vous <a href='/connexion'>connecter</a>."
      end
    end

    get('/') { "Bonjour #{session['nom_utilisateur']}." }
  end

=== Cration dynamique d'applications

Il se peut que vous ayez besoin de crer une nouvelle application  l'excution
sans avoir  les assigner  une constante, vous pouvez le faire grce 
<tt>Sinatra.new</tt> :

  require 'sinatra/base'
  mon_app = Sinatra.new { get('/') { "salut" } }
  mon_app.run!

L'application dont elle hrite peut tre pass en argument optionnel :

  # config.ru
  require 'sinatra/base'

  controleur = Sinatra.new do
    enable :logging
    helpers MyHelpers
  end

  map('/a') do
    run Sinatra.new(controleur) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controleur) { get('/') { 'b' } }
  end

C'est notamment utile pour tester des extensions  Sinatra ou bien pour
utiliser Sinatra dans votre propre bibliothque.

Cela permet galement d'utiliser trs facilement Sinatra comme middleware :

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run RailsProject::Application

== Contextes et Binding

Le contexte dans lequel vous tes dtermine les mthodes et variables
disponibles.

=== Contexte de l'application/classe

Toute application Sinatra correspond  une sous-classe de <tt>Sinatra::Base</tt>.
Si vous utilisez le DSL haut niveau (<tt>require 'sinatra'</tt>), alors cette
classe est <tt>Sinatra::Application</tt>, sinon il s'agit de la sous-classe que
vous avez dfinie. Dans le contexte de la classe, vous avez accs aux mthodes
telles que +get+ ou +before+, mais vous n'avez pas accs aux objets +request+
ou +session+ car c'est la mme classe d'application qui traitera toutes les
requtes.

Les options dfinies au moyen de +set+ deviennent des mthodes de classe :

    class MonApp < Sinatra::Base
      # Eh, je suis dans le contexte de l'application !
      set :foo, 42
      foo # => 42

      get '/foo' do
        # Eh, je ne suis plus dans le contexte de l'application !
      end
    end

Vous avez le binding du contexte de l'application dans :

* Le corps de la classe d'application
* Les mthodes dfinies par les extensions
* Le bloc pass  +helpers+
* Les procs/blocs utiliss comme argument pour +set+
* Le bloc pass  <tt>Sinatra.new</tt>

Vous pouvez atteindre ce contexte (donc la classe) de la faon suivante :

* Via l'objet pass dans les blocs +configure+ (<tt>configure { |c| ... }</tt>)
* En utilisant +settings+ dans le contexte de la requte

=== Contexte de la requte/instance

Pour tout traitement d'une requte, une nouvelle instance de votre classe
d'application est cre et tous vos gestionnaires sont excuts dans ce
contexte. Dans ce dernier, vous pouvez accder aux objets +request+ et
+session+ et faire appel aux fonctions de rendu telles que +erb+ ou +haml+.
Vous pouvez accder au contexte de l'application depuis le contexte de la
requte au moyen de +settings+ :

  class MonApp < Sinatra::Base
    # Eh, je suis dans le contexte de l'application !
    get '/ajouter_route/:nom' do
      # Contexte de la requte pour '/ajouter_route/:nom'
      @value = 42

      settings.get("/#{params[:nom]}") do
        # Contexte de la requte pour "/#{params[:nom]}"
        @value # => nil (on est pas au sein de la mme requte)
      end

      "Route ajoute !"
    end
  end

Vous avez le binding du contexte de la requte dans :

* les blocs get/head/post/put/delete/options
* les filtres before/after
* les mthodes utilitaires (dfinies au moyen de +helpers+)
* les vues/templates

=== Le contexte de dlgation

Le contexte de dlgation se contente de transmettre les appels de mthodes au
contexte de classe. Toutefois, il ne se comporte pas  100% comme le contexte
de classe car vous n'avez pas le binding de la classe : seules les mthodes
spcifiquement dclares pour dlgation sont disponibles et il n'est pas
possible de partager des variables/tats avec le contexte de classe
(comprenez : +self+ n'est pas le mme). Vous pouvez ajouter des dlgation de
mthodes en appelant <tt>Sinatra::Delegator.delegate :method_name</tt>.

Vous avez le binding du contexte de dlgation dans :

* Le binding de haut niveau, si vous avez utilis <tt>require "sinatra"</tt>
* Un objet qui inclut le module +Sinatra::Delegator+

Jetez un oeil pour vous faire une ide : voici le mixin
{Sinatra::Delegator}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
qui est {inclus dans l'espace de noms principal}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28]

== Ligne de commande

Les applications en Sinatra peuvent tre lances directement :

  ruby mon_application.rb [-h] [-x] [-e ENVIRONNEMENT] [-p PORT] [-o HOTE] [-s SERVEUR]

Les options sont :

  -h # aide
  -p # dclare le port (4567 par dfaut)
  -o # dclare l'hte (0.0.0.0 par dfaut)
  -e # dclare l'environnement (+development+ par dfaut)
  -s # dclare le serveur/gestionnaire  utiliser (thin par dfaut)
  -x # active le mutex lock (off par dfaut)

== Configuration ncessaire

Les versions suivantes de Ruby sont officiellement supportes :

[ Ruby 1.8.7 ]
  1.8.7 est compltement support, toutefois si rien ne vous y retient, nous
  vous recommandons de passer  1.9.2 ou bien de passer  JRuby ou Rubinius.

[ Ruby 1.9.2 ]
  1.9.2 est support et recommand. Notez que Radius et Markaby ne sont
  actuellement pas compatible avec 1.9. N'utilisez pas 1.9.2p0 qui est
  rput causer des erreurs de segmentation lorque Sinatra est utilis.

[ Rubinius ]
  Rubinius est officiellement support (Rubinius >= 1.2.3), tout fonctionne,
  y compris tous les langages de template.

[ JRuby ]
  JRuby est officiellement support (JRuby >= 1.6.1). Aucune anomalie avec
  des bibliothques de templates tierces ne sont connues. Toutefois, si vous
  choisissez JRuby, alors tournez vous vers des gestionnaires Rack JRuby car
  le serveur Thin n'est pas compltement support par JRuby. Le support des
  extensions C dans JRuby est encore exprimental, ce qui n'affecte que
  RDiscount.

<b>Ruby 1.8.6 n'est plus support.</b>

Nous gardons galement un oeil sur les versions Ruby  venir.

Les implmentations Ruby suivantes ne sont pas officiellement supportes mais
sont toujours connues comme permettant  Sinatra de fonctionner :

* Plus anciennes versions de JRuby et Rubinius
* MacRuby, Maglev, IronRuby
* Ruby 1.9.0 et 1.9.1

Ne pas tre officiellement support signifie que si les choses se passent mal
sur ces plateformes et non sur celles supportes, nous considrons que
l'anomalie est de le ressort, pas du ntre.

Nous faisons galement notre intgration continue (CI) avec ruby-head (la
future 1.9.3), mais nous ne pouvons rien garantir tant donn que c'est
constant mouvement. Vous pouvez vous attendre  ce que 1.9.3p0 soit support.

Sinatra devrait fonctionner sur n'importe quel systme d'exploitation
supportant l'implmentation Ruby choisie.

== Essuyer les pltres

Si vous voulez utiliser la toute dernire version de Sinatra, n'ayez pas peur
de faire tourner votre application sur la branche master, cela devrait tre
stable.

Nous publions galement une gem de +prerelease+ de temps en temps que vous 
pouvez installer comme suit :

  gem install sinatra --pre

afin d'avoir les toutes dernires fonctionnalits.

=== Avec Bundler

Si vous voulez faire tourner votre application avec le tout dernier
Sinatra, {Bundler}[http://gembundler.com/] est recommand.

Tout d'abord, installer bundler si vous ne l'avez pas :

  gem install bundler

Ensuite, dans le dossier de votre projet, crez un fichier +Gemfile+ :

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  # autres dpendances
  gem 'haml'                    # par exemple, si vous utilisez haml
  gem 'activerecord', '~> 3.0'  # peut-tre que vous avez galement besoin
                                # de ActiveRecord 3.x

Notez que vous aurez  lister toutes les dpendances de votre application dans
ce fichier. Les dpendances directes de Sinatra (Rack et Tilt) seront
automatiquement tlcharges et ajoutes par Bundler.

Maintenant, vous pouvez faire tourner votre application de la faon suivante :

  bundle exec ruby myapp.rb

=== Faites le vous-mme

Crez un clone local et dmarrez votre application avec le dossier
<tt>sinatra/lib</tt> dans le <tt>$LOAD_PATH</tt> :

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

A l'avenir, pour mettre  jour le code source de Sinatra :

  cd myapp/sinatra
  git pull

=== Installez globalement

Vous pouvez construire la gem vous-mme :

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

Si vous installez les gems en tant que +root+, la dernire tape sera :

  sudo rake install

== Versions

Sinatra se conforme aux {versions smantiques}[http://semver.org/], aussi bien
SemVer que SemVerTag.

== Mais encore

* {Site internet}[http://www.sinatrarb.com/] - Plus de documentation,
  de news, et des liens vers d'autres ressources.
* {Contribuer}[http://www.sinatrarb.com/contributing] - Vous avez trouv un
  bug ? Besoin d'aide ? Vous avez un patch ?
* {Suivi des problmes}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Mailing List}[http://groups.google.com/group/sinatrarb/topics]
* {IRC : #sinatra}[irc://chat.freenode.net/#sinatra] sur http://freenode.net
* {IRC : #sinatra}[irc://chat.freenode.net/#sinatra] on http://freenode.net
* {Sinatra Book}[http://sinatra-book.gittr.com] Tutoriels et recettes
* {Sinatra Recipes}[http://recipes.sinatrarb.com/] Recettes contribues
  par la communaut
* Documentation API de la {dernire version}[http://rubydoc.info/gems/sinatra]
  ou du {HEAD courant}[http://rubydoc.info/github/sinatra/sinatra] sur
  http://rubydoc.info/


= Sinatra
<i>Fontos megjegyzs: Ez a dokumentum csak egy fordtsa az angol nyelv
vltozat, s lehet, hogy nem napraksz.</i>

A Sinatra egy DSL webalkalmazsok Ruby nyelven trtn fejlesztshez, minimlis
energiabefektetssel:

  # myapp.rb
  require 'sinatra'
  get '/' do
    'Hell Vilg!'
  end

Teleptsd a gem-et s indtsd el az alkalmazst a kvetkezkppen:

  sudo gem install sinatra
  ruby -rubygems myapp.rb

Az alkalmazs elrhet lesz itt: http://localhost:4567

== tvonalak (routes)

A Sinatrban az tvonalat egy HTTP metdus s egy URL-re illeszked minta
prosa alkotja. Minden egyes tvonalhoz tartozik egy blokk:

  get '/' do
    .. megjelentnk valamit ..
  end

  post '/' do
    .. ltrehozunk valamit ..
  end

  put '/' do
    .. frisstnk valamit ..
  end

  delete '/' do
    .. trlnk valamit ..
  end

Az tvonalak illeszkedst a rendszer a definilsuk sorrendjben
ellenrzi. Sorrendben mindig az els illeszked tvonalhoz tartoz metdus kerl
meghvsra.

Az tvonalmintk tartalmazhatnak paramtereket is, melyeket a <tt>params</tt>
hash-bl rhetnk el:

  get '/hello/:name' do
    # illeszkedik a "GET /hello/foo" s a "GET /hello/bar" tvonalakra
    # ekkor params[:name] rtke 'foo' vagy 'bar' lesz
    "Hell #{params[:name]}!"
  end

A kulcsszavas argumentumokat (named parameters) blokk paramterek tjn
is el tudod rni:

  get '/hello/:name' do |n|
    "Hell #{n}!"
  end

Az tvonalmintkban szerepelhetnek joker paramterek is, melyeket a 
<tt>params[:splat]</tt> tmbn keresztl tudunk elrni.

  get '/say/*/to/*' do
    # illeszkedik a /say/hello/to/world mintra
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    # illeszkedik a /download/path/to/file.xml mintra
    params[:splat] # => ["path/to/file", "xml"]
  end

Regulris kifejezseket is felvehetnk az tvonalba:

  get %r{/hello/([\w]+)} do
    "Hell, #{params[:captures].first}!"
  end

Vagy blokk paramtereket:

  get %r{/hello/([\w]+)} do |c|
    "Hell, #{c}!"
  end

Az tvonalak azonban szmos egyb illeszkedsi felttel szerint is
tervezhetk, gy pldul az user agent karakterlncot alapul vve:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "A Songbird #{params[:agent][0]} verzijt hasznlod"
  end

  get '/foo' do
    # illeszkedik az egyb user agentekre
  end

== Statikus llomnyok

A statikus fjlok kiszolglsa a <tt>./public</tt> knyvtrbl
trtnik, de termszetesen ms knyvtrat is megadhatsz erre a clra,
mgpedig a <tt>:public_folder</tt> kapcsol belltsval:

  set :public_folder, File.dirname(__FILE__) + '/static'

Fontos mgejegyezni, hogy a nyilvnos knyvtr neve nem szerepel az URL-ben.
A <tt>./public/css/style.css</tt> fjl az
<tt>http://example.com/css/style.css</tt> URL-en lesz elrhet.

== Nzetek s Sablonok

A sablonfjlokat rendszerint a  <tt>./views</tt> knyvtrba helyezzk, de
itt is lehetsg nylik egyb knyvtr hasznlatra:

  set :views, File.dirname(__FILE__) + '/templates'

Nagyon fontos szben tartani, hogy a sablononkra mindig szimblumokkal
hivatkozunk, mg akkor is, ha egyb (ebben az esetben a 
<tt>:'subdir/template'</tt>) knyvtrban troljuk ket. A renderel
metdusok minden, nekik kzvetlenl tadott karakterlncot megjelentenek.

=== Haml sablonok

HAML sablonok renderelshez szksgnk lesz a haml gem-re vagy knyvtrra:

  # Importljuk be a haml-t az alkalmazsba
  require 'haml'

  get '/' do
    haml :index
  end

Ez szpen lerendereli a <tt>./views/index.haml</tt> sablont.

A {Haml kapcsoli}[http://haml.hamptoncatlin.com/docs/rdoc/classes/Haml.html]
globlisan is bellthatk a Sinatra konfigurcii kztt, lsd az
{Options and Configurations}[http://www.sinatrarb.com/configuration.html] lapot.
A globlis belltsokat lehetsgnk van fellrni metdus szinten is.

  set :haml, {:format => :html5 } # az alaprtelmezett Haml formtum az :xhtml

  get '/' do
    haml :index, :haml_options => {:format => :html4 } # immr fellrva
  end


=== Erb sablonok

  # Importljuk be az erb-t az alkalmazsba
  require 'erb'

  get '/' do
    erb :index
  end

Ez a <tt>./views/index.erb</tt> sablont fogja lerenderelni.

=== Builder sablonok

Szksgnk lesz a builder gem-re vagy knyvtrra a builder sablonok
renderelshez:

  # Importljuk be a builder-t az alkalmazsba
  require 'builder'

  get '/' do
    builder :index
  end

Ez pedig a <tt>./views/index.builder</tt> llomnyt fogja renderelni.

=== Sass sablonok

Sass sablonok hasznlathoz szksg lesz a haml gem-re vagy knyvtrra:

  # Be kell importlni a haml, vagy a sass knyvtrat
  require 'sass'

  get '/stylesheet.css' do
    sass :stylesheet
  end

gy a <tt>./views/stylesheet.sass</tt> fjl mris renderelhet.

A {Sass kapcsoli}[http://haml.hamptoncatlin.com/docs/rdoc/classes/Sass.html]
globlisan is bellthatk a Sinatra konfigurcii kztt, lsd az
{Options and Configurations}[http://www.sinatrarb.com/configuration.html] lapot.
A globlis belltsokat lehetsgnk van fellrni metdus szinten is.

  set :sass, {:style => :compact } # az alaprtelmezett Sass stlus a :nested

  get '/stylesheet.css' do
    sass :stylesheet, :sass_options => {:style => :expanded } # fellrva
  end


=== Begyazott sablonok

  get '/' do
    haml '%div.title Hell Vilg'
  end

Lerendereli a begyazott sablon karakerlnct.

=== Vltozk elrse a sablonokban

A sablonok ugyanabban a kontextusban kerlnek kirtkelsre, mint az
tvonal metdusok (route handlers). Az tvonal metdusokban megadott
vltozk kzvetlenl elrhetek lesznek a sablonokban:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end

De megadhatod egy loklis vltozkat tartalmaz explicit hash-ben is:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.name', :locals => { :foo => foo }
  end

Ezt leginkbb akkor rdemes megtenni, ha partial-eket akarunk renderelni
valamely ms sablonbl.

=== Fjlon belli sablonok

Sablonokat gy is megadhatunk, hogy egyszeren az alkalmazs fjl
vgre begpeljk ket:

  require 'rubygems'
  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hell Vilg!!!!!

Megjegyzs: azok a fjlon belli sablonok, amelyek az alkalmazs fjl vgre
kerlnek s fggnek a sinatra knyvtrtl, automatikusan betltdnek.
Ha ugyanezt ms alkalmazsfjlban is szeretnd megtenni, hvd meg 
a <tt>use_in_file_templates!</tt> metdust az adott fjlban.

=== Kulcsszavas sablonok

Sablonokat vgl a felsszint <tt>template</tt> metdussal is 
definilhatunk: 

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hell Vilg!'
  end

  get '/' do
    haml :index
  end

Ha ltezik "layout" nev sablon, akkor az minden esetben meghvdik, amikor
csak egy sablon renderelsre kerl. A layoutokat ki lehet kapcsolni a
<tt>:layout => false</tt> meghvsval.

  get '/' do
    haml :index, :layout => !request.xhr?
  end

== Helperek

Hasznld a fels szint <tt>helpers</tt> metdust azokhoz a helper
fggvnyekhez, amiket az tvonal metdusokban s a sablonokban akarsz
hasznlni:

  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

== Szrk (filters)

Az elszrk (before filter) az adott hvs kontextusban minden egyes
krs alkalmval kirtkeldnek, gy mdosthatjk a krst s a
vlaszt egyarnt. A szrkbe felvett pldnyvltozk elrhetek lesznek
az tvonalakban s a sablonokban is:

  before do
    @note = 'Cs!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Szeva!'
    params[:splat] #=> 'bar/baz'
  end

Az utszrk az egyes krsek utn, az adott krs kontextusban kerlnek
kirtkelsre, gy ezek is kpesek mdostani a krst s a vlaszt egyarnt.
Az elszrkben s vonalakban ltrehozott pldnyvltozk elrhetek lesznek
az utszrk szmra:

  after do
    puts response.status
  end

== Megllts

Egy krs szrben vagy tvonalban trtn azonnal blokkolshoz
hasznld a kvetkez parancsot:

  halt

A meglltskor egy blokktrzset is megadhatsz ...

  halt 'ez fog megjelenni a trzsben'

Vagy lltsd be a HTTP sttuszt s a trzset is egyszerre ...

  halt 401, 'menj innen!'

== Passzols

Az tvonalak tovbbadhatjk a vgrehajtst egy msik tvonalnak 
a <tt>pass</tt> fggvnyhvssal:

  get '/guess/:who' do
    pass unless params[:who] == 'Frici'
    "Elkaptl!"
  end

  get '/guess/*' do
    "Elhibztl!"
  end

Az tvonal blokkja azonnal kilp s tadja a vezrlst a kvetkez
illeszked tvonalnak. Ha nem tall megfelel tvonalat, a Sinatra
egy 404-es hibval tr vissza.

== Belltsok

Csak indtskor, de minden krnyezetre rvnyesen fusson le:

  configure do
    ...
  end

Csak akkor fusson le, ha a krnyezet (a RACK_ENV krnyezeti vltozban)
<tt>:production</tt>-ra van lltva:

  configure :production do
    ...
  end

Csak akkor fusson le, ha a krnyezet <tt>:production</tt> vagy <tt>:test</tt>:

  configure :production, :test do
    ...
  end

== Hibakezels

A hibakezelk ugyanabban a kontextusban futnak le, mint az tvonalak s
elszrk, ezrt szmukra is elrhetek mindazok a knyvtrak, amelyek
az utbbiak rendelkezsre is llnak; gy pldul a <tt>haml</tt>, 
az <tt>erb</tt>, a <tt>halt</tt> stb.

=== Nem tallhat

Amikor a <tt>Sinatra::NotFound</tt> kivtel fellp, vagy a vlasz HTTP
sttuszkdja 404-es, mindig a <tt>not_found</tt> metdus hvdik meg.

  not_found do
    'Sehol sem tallom, amit keresel'
  end

=== Hiba

Az +error+ metdus hvdik meg olyankor, amikor egy tvonal, blokk vagy
elszr kivtelt vlt ki. A kivtel objektum lehvhat a
<tt>sinatra.error</tt> Rack vltoztl:

  error do
    'Elnzst, de valami szrny hiba lpett fel - ' + env['sinatra.error'].name
  end

Egyni hibakezels:

  error MyCustomError do
    'Szval az van, hogy...' + env['sinatra.error'].message
  end

s amikor fellp:

  get '/' do
    raise MyCustomError, 'valami nem stimmel!'
  end

Ez fog megjelenni:

  Szval az van, hogy... valami nem stimmel!

A Sinatra specilis <tt>not_found</tt> s <tt>error</tt> hibakezelket
hasznl, amikor a futtatsi krnyezet fejleszti mdba van kapcsolva.

== Mime tpusok

A <tt>send_file</tt> metdus hasznlatakor, vagy statikus fjlok
kiszolglsakor elfordulhat, hogy a Sinatra nem ismeri fel a fjlok
mime tpust. Ilyenkor hasznld a +mime_type+ kapcsolt a fjlkiterjeszts
bevezetshez:

  mime_type :foo, 'text/foo'

== Rack Middleware

A Sinatra egy Ruby keretrendszerek szmra kifejlesztett egyszer s szabvnyos
interfszre, a {Rack}[http://rack.rubyforge.org/] -re pl. A Rack fejleszti 
szempontbl egyik legrdekesebb jellemzje, hogy tmogatja az gynevezett
"middleware" elnevezs komponenseket, amelyek bekeldnek a szerver s az
alkalmazs kz, gy kpesek megfigyelni s/vagy mdostani a HTTP 
krseket s vlaszokat. Segtsgkkel klnfle, egysgesen mkd
funkcikat pthetnk be rendszernkbe.

A Sinatra keretrendszerben gyerekjtk a Rack middleware-ek behzsa a
+use+ metdus segtsgvel:

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hell Vilg'
  end

A +use+ metdus szemantikja megegyezik a 
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] DSL-ben
hasznlt +use+ metdusval (az emltett DSL-t leginkbb rackup llomnyokban
hasznljk). Hogy egy pldt emltsnk, a +use+ metdus elfogad 
vltozkat s blokkokat egyarnt, akr kombinlva is ezeket:

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'titkos'
  end

A Rack terjesztssel egy csom alap middleware komponens is rkezik,
amelyekkel a naplzs, URL tvonalak megadsa, autentikci s 
munkamenet-kezels knnyen megvalsthat. A Sinatra ezek kzl elg
sokat automatikusan felhasznl a belltsoktl fggen, gy ezek
explicit betltsvel (+use+) nem kell bajldnod.

== Tesztels

Sinatra teszteket brmely Rack alap tesztel knyvtrral vagy
keretrendszerrel kszthetsz. Mi a {Rack::Test}[http://gitrdoc.com/brynary/rack-test]
knyvtrat ajnljuk:

  require 'my_sinatra_app'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hell Vilg!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frici'
      assert_equal 'Hell Frici!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Songbird-t hasznlsz!", last_response.body
    end
  end

Megjegyzs: A beptett Sinatra::Test s Sinatra::TestHarness osztlyok
a 0.9.2-es kiadstl kezdve elavultnak szmtanak.

== Sinatra::Base - Middleware-ek, knyvtrak s modulris alkalmazsok

Az alkalmazst fels szinten pteni megfelelhet mondjuk egy kisebb
app esetn, m kifejezetten krosnak bizonyulhat olyan komolyabb,
jra felhasznlhat komponensek ksztsekor, mint pldul egy Rack
middleware, Rails metal, egyszerbb kiszolgl komponenssel br
knyvtrak vagy ppen Sinatra kiterjesztsek. A fels szint DSL
bepiszktja az Objektum nvteret, radsul kisalkalmazsokra szabott
belltsokat felttelez (gy pldul egyetlen alkalmazsfjl, ./public
s ./views knyvtr megltt, naplzst, kivtelkezel oldalt stb.).
Itt jn a kpbe a Sinatra::Base osztly:

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hell Vilg!'
    end
  end

A MyApp osztly immr nll Rack komponensknt, mondjuk Rack middleware-knt
vagy alkalmazsknt, esetleg Rails metal-knt is tud mkdni. Kzvetlenl
hasznlhatod (+use+) vagy futtathatod (+run+) az osztlyodat egy rackup
konfigurcis llomnyban (+config.ru+), vagy egy szerverkomponenst
tartalmaz knyvtr vezrlsekor:

   MyApp.run! :host => 'localhost', :port => 9090

A Sinatra::Base gyermekosztlyaiban elrhet metdusok egyttal a fels
szint DSL-en keresztl is hozzfrhetk. A legtbb fels szint
alkalmazs talakthat Sinatra::Base alap komponensekk kt lpsben:

* A fjlban nem a +sinatra+, hanem a +sinatra/base+ osztlyt kell
  beimportlni, mert egybknt az sszes Sinatra DSL metdus a f
  nvtrbe kerl.
* Az alkalmazs tvonalait, hibakezelit, szrit s belltsait
  a Sinatra::Base osztly gyermekosztlyaiban kell megadni.

A +Sinatra::Base+ osztly igazbl egy res lap: a legtbb funkci
alapbl ki van kapcsolva, belertve a beptett szervert is. A 
belltsokkal s az egyes kapcsolk hatsval az
{Options and Configuration}[http://sinatra.github.com/configuration.html] lap
foglalkozik.

Szljegyzet: A Sinatra fels szint DSL-je egy egyszer delegcis
rendszerre pl. A Sinatra::Application osztly - a Sinatra::Base egy
specilis osztlyaknt - fogadja az sszes :get, :put, :post,
:delete, :before, :error, :not_found, :configure s :set zenetet,
ami csak a fels szintre berkezik. rdemes utnanzned a kdban,
mikpp {kerl be}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/main.rb#L25]
a {Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb#L1064]
a f nvtrbe.

== Parancssori lehetsgek

Sinatra alkalmazsokat kzvetlenl futtathatunk:

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-s HANDLER]

Az albbi kapcsolkat ismeri fel a rendszer:

  -h # segtsg
  -p # a port belltsa (alaprtelmezs szerint ez a 4567-es)
  -e # a krnyezet belltsa (alaprtelmezs szerint ez a development)
  -s # a rack szerver/handler belltsa (alaprtelmezetten ez a thin)
  -x # a mutex lock bekapcsolsa (alaprtelmezetten ki van kapcsolva)

== Fejleszti vltozat

Ha a Sinatra legfrissebb, fejleszti vltozatt szeretnd hasznlni,
kszts egy helyi msolatot s indtsd az alkalmazsodat gy,
hogy a <tt>sinatra/lib</tt> knyvtr elrhet legyen a 
<tt>LOAD_PATH</tt>-on:

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

De hozz is adhatod a <tt>sinatra/lib</tt> knyvtrat a <tt>LOAD_PATH</tt>-hoz
az alkalmazsodban:

  $LOAD_PATH.unshift File.dirname(__FILE__) + '/sinatra/lib'
  require 'rubygems'
  require 'sinatra'

  get '/about' do
    "A kvetkez vltozatot futtatom " + Sinatra::VERSION
  end

A Sinatra frisstst ksbb gy vgezheted el:

  cd myproject/sinatra
  git pull

== Tovbbi informcik

* {A projekt weboldala}[http://sinatra.github.com/] - Kiegszt dokumentci,
  hrek, hasznos linkek
* {Kzremkds}[http://sinatra.github.com/contributing.html] - Hibt talltl?
  Segtsgre van szksged? Foltot kldenl be?
* {Lighthouse}[http://sinatra.lighthouseapp.com] - Hibakvets s kiadsok
* {Twitter}[http://twitter.com/sinatra]
* {Levelezlista}[http://groups.google.com/group/sinatrarb]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] a http://freenode.net cmen

= Sinatra
<i> </i>

SinatraRubyDSL

  # myapp.rb
  require 'sinatra'
  get '/' do
    'Hello world!'
  end

gem

  gem install sinatra
  ruby -rubygems myapp.rb

http://localhost:4567 

== 

SinatraHTTPURL


  get '/' do
    ..  ..
  end

  post '/' do
    ..  ..
  end

  put '/' do
    ..  ..
  end

  delete '/' do
    ..  ..
  end

 


<tt>params</tt>

  get '/hello/:name' do
    # matches "GET /hello/foo" and "GET /hello/bar"
    # params[:name] is 'foo' or 'bar'
    "Hello #{params[:name]}!"
  end



  get '/hello/:name' do |n|
    "Hello #{n}!"
  end

splat()
<tt>params[:splat]</tt> 

  get '/say/*/to/*' do
    # matches /say/hello/to/world
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    # matches /download/path/to/file.xml
    params[:splat] # => ["path/to/file", "xml"]
  end

:

  get '/download/*.*' do |path, ext|
    [path, ext] # => ["path/to/file", "xml"]
  end

:

  get %r{/hello/([\w]+)} do
    "Hello, #{params[:captures].first}!"
  end

:

  get %r{/hello/([\w]+)} do |c|
    "Hello, #{c}!"
  end


=== 



  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "You're using Songbird version #{params[:agent][0]}"
  end

  get '/foo' do
    # Matches non-songbird browsers
  end

+host_name++provides+:

  get '/', :host_name => /^admin\./ do
    "Admin Area, Access denied!"
  end

  get '/', :provides => 'html' do
    haml :index
  end
  
  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

:

  set(:probability) { |value| condition { rand <= value } }
  
  get '/win_a_car', :probability => 0.1 do
    "You won!"
  end
  
  get '/win_a_car' do
    "Sorry, you lost."
  end


=== 

HTTPRack



RackRackHTTP
:

* 3: <tt>[(Fixnum), (Hash), (#each)]</tt>
* 2: <tt>[(Fixnum), (#each)]</tt>
* <tt>#each</tt>
* Fixnum

:

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }


== 

<tt>./public</tt>
<tt>:public_folder</tt>

  set :public_folder, File.dirname(__FILE__) + '/static'

: URL
<tt>./public/css/style.css</tt><tt>http://example.com/css/style.css</tt>

==  / 

<tt>./views</tt>
:

  set :views, File.dirname(__FILE__) + '/templates'


<tt>:'subdir/template'</tt>


=== Haml 

hamlhaml:

  # haml
  require 'haml'

  get '/' do
    haml :index
  end

<tt>./views/index.haml</tt>

{Haml's options}[http://haml.info/docs/yardoc/file.HAML_REFERENCE.html#options]
Sinatra
{Options and Configurations}[http://www.sinatrarb.com/configuration.html],


  set :haml, {:format => :html5 } # :xhtml

  get '/' do
    haml :index, :haml_options => {:format => :html4 } # 
  end


=== Erb 

  # erb
  require 'erb'

  get '/' do
    erb :index
  end

<tt>./views/index.erb</tt>

=== Erubis

erubiserubis:

  # erubis
  require 'erubis'

  get '/' do
    erubis :index
  end

<tt>./views/index.erubis</tt>

=== Builder 

builderbuilder:

  # builder
  require 'builder'

  get '/' do
    builder :index
  end

<tt>./views/index.builder</tt>

===  

:

  # 
  require 'nokogiri'

  get '/' do
    nokogiri :index
  end

<tt>./views/index.nokogiri</tt>

=== Sass 

Sasssass:

  # hamlsass
  require 'sass'

  get '/stylesheet.css' do
    sass :stylesheet
  end

<tt>./views/stylesheet.sass</tt>

{Sass' options}[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
Sinatra
see {Options and Configurations}[http://www.sinatrarb.com/configuration.html],


  set :sass, {:style => :compact } # Sass style :nested

  get '/stylesheet.css' do
    sass :stylesheet, :sass_options => {:style => :expanded } # 
  end

=== Scss 

Scsssass:

  # hamlsass
  require 'sass'

  get '/stylesheet.css' do
    scss :stylesheet
  end

<tt>./views/stylesheet.scss</tt>

{Sass' options}[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
Sinatra
see {Options and Configurations}[http://www.sinatrarb.com/configuration.html],


  set :scss, :style => :compact # Scss style:nested

  get '/stylesheet.css' do
    scss :stylesheet, :style => :expanded # 
  end

=== Less 

Lessless:

  # less
  require 'less'

  get '/stylesheet.css' do
    less :stylesheet
  end

<tt>./views/stylesheet.less</tt>

=== Liquid 

Liquidliquid:

  # liquid
  require 'liquid'

  get '/' do
    liquid :index
  end

<tt>./views/index.liquid</tt>

LiquidRuby(+yield+)
locals:

  liquid :index, :locals => { :key => 'value' }

=== Markdown 

Markdownrdiscount:

  # rdiscount
  require "rdiscount"
  
  get '/' do
    markdown :index
  end

<tt>./views/index.markdown</tt>(+md++mkd+)

markdownlocals
:

  erb :overview, :locals => { :text => markdown(:introduction) }

markdown:

  %h1 Hello From Haml!
  %p= markdown(:greetings)

=== Textile 

TextileRedCloth:

  # redcloth
  require "redcloth"

  get '/' do
    textile :index
  end

<tt>./views/index.textile</tt>

textilelocals
:

  erb :overview, :locals => { :text => textile(:introduction) }

textile:

  %h1 Hello From Haml!
  %p= textile(:greetings)

=== RDoc 

RDocRDoc:

  # rdoc/markup/to_html
  require "rdoc"
  require "rdoc/markup/to_html"

  get '/' do
    rdoc :index
  end

<tt>./views/index.rdoc</tt>

rdoclocals
:

  erb :overview, :locals => { :text => rdoc(:introduction) }

rdoc:

  %h1 Hello From Haml!
  %p= rdoc(:greetings)

=== Radius 

Radiusradius:

  # radius
  require 'radius'

  get '/' do
    radius :index
  end

<tt>./views/index.radius</tt>

RadiusRuby(+yield+)
locals:

  radius :index, :locals => { :key => 'value' }

=== Markaby 

Markabymarkaby:

  # markaby
  require 'markaby'

  get '/' do
    markaby :index
  end

<tt>./views/index.mab</tt>

=== Slim 

Slimslim:

  # slim
  require 'slim'

  get '/' do
    slim :index
  end

<tt>./views/index.slim</tt>

=== Creole 

Creolecreole:

  # creole
  require 'creole'

  get '/' do
    creole :index
  end

<tt>./views/index.creole</tt>

=== CoffeeScript 

CoffeeScriptcoffee-script`coffee`:

  # coffee-script
  require 'coffee-script'

  get '/application.js' do
    coffee :application
  end

<tt>./views/application.coffee</tt>

=== 

  get '/' do
    haml '%div.title Hello World'
  end



=== 

. 


  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end



  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.name', :locals => { :foo => foo }
  end



=== 



  require 'rubygems'
  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hello world!!!!!

: sinatrarequire
 <tt>enable :inline_templates</tt>

=== 

<tt>template</tt>

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hello World!'
  end

  get '/' do
    haml :index
  end

layout
<tt>:layout => false</tt>layouts

  get '/' do
    haml :index, :layout => !request.xhr?
  end

== 

<tt>helpers</tt>


  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

== 

before



  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end

after

before
after:

  after do
    puts response.status
  end


:

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

== 

before:

  halt

:

  halt 410

body ...

  halt 'body'

body ...

  halt 401, '!'

:

  halt 402, {'Content-Type' => 'text/plain'}, ''

== (Passing)

<tt>pass</tt>:

  get '/guess/:who' do
    pass unless params[:who] == 'Frank'
    "!"
  end

  get '/guess/*' do
    "!"
  end


404

== 

`request`():

  #  http://example.com/example 
  get '/foo' do
    request.body              # ()
    request.scheme            # "http"
    request.script_name       # "/example"
    request.path_info         # "/foo"
    request.port              # 80
    request.request_method    # "GET"
    request.query_string      # ""
    request.content_length    # request.body
    request.media_type        # request.body
    request.host              # "example.com"
    request.get?              # true ()
    request.form_data?        # false
    request["SOME_HEADER"]    # SOME_HEADER
    request.referer           # '/'
    request.user_agent        #  (:agent )
    request.cookies           # 
    request.xhr?              # Ajax
    request.url               # "http://example.com/example/foo"
    request.path              # "/example/foo"
    request.ip                # IP
    request.secure?           # false
    request.env               # Rackenv
  end

<tt>script_name</tt><tt>path_info</tt>:

  before { request.path_info = "/" }
  
  get "/" do
    ""
  end

<tt>request.body</tt>IOStringIO:

  post "/api" do
    request.body.rewind  # 
    data = JSON.parse request.body.read
    "Hello #{data['name']}!"
  end


== 



  configure do
    ...
  end

(RACK_ENV)<tt>:production</tt>:

  configure :production do
    ...
  end

<tt>:production</tt><tt>:test</tt>:

  configure :production, :test do
    ...
  end

== 

before
<tt>haml</tt><tt>erb</tt><tt>halt</tt>

=== Not Found

<tt>Sinatra::NotFound</tt> 
404<tt>not_found</tt>

  not_found do
    ''
  end

=== 

+error+ before
Rack<tt>sinatra.error</tt>

  error do
    ' - ' + env['sinatra.error'].name
  end



  error MyCustomError do
    '...' + env['sinatra.error'].message
  end

,

  get '/' do
    raise MyCustomError, ''
  end

:

  ... 

:

  error 403 do
    'Access forbidden'
  end

  get '/secret' do
    403
  end

:

  error 400..510 do
    'Boom'
  end


Sinatra<tt>not_found</tt><tt>error</tt>


== MIME

<tt>send_file</tt>SinatraMIME
 +mime_type+ 

  mime_type :foo, 'text/foo'

content_type:

  content_type :foo

== Rack

SinatraRack[http://rack.rubyforge.org/]RubyWEB
 Rack
(HTTP
)

Sinatra+user+ Rack

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hello World'
  end

<tt>use</tt> {Rack::Builder}[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] DSL
 +use+ 

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'secret'
  end

RackURL
Sinatra+use+

== 

SinatraRack-based
{Rack::Test}[http://gitrdoc.com/brynary/rack-test] :

  require 'my_sinatra_app'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hello World!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hello Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Songbird!", last_response.body
    end
  end

: Sinatra::TestSinatra::TestHarness
0.9.2

== Sinatra::Base -  

()
RackRails metal
Sinatra
DSL(:./public./view)
Sinatra::Base

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hello world!'
    end
  end

MyAppRackRackRack
Rails metal<tt>config.ru</tt> +use+ 
+run+ 

   MyApp.run! :host => 'localhost', :port => 9090

Sinatra::BaseDSL
Sinatra::Base

* +sinatra+<tt>sinatra/base</tt>
(SinatraDSL)
* Sinatra::Base

<tt>Sinatra::Base</tt> 
{Options and Configuration}[http://sinatra.github.com/configuration.html]


: SinatraDSL(delgation)
<tt>Sinatra::Application</tt>(Sinatra::Base)
:get :put :post:delete :before:error:not_found :configure:set messages
 ():
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb#L1064]
{included into the main namespace}[http://github.com/sinatra/sinatra/blob/master/lib/sinatra/main.rb#L25].

=== Sinatra

SinatraRack
SinatraRack

SinatraRack(Rails/Ramaze/Camping/...)

  require 'sinatra/base'
  
  class LoginScreen < Sinatra::Base
    enable :sessions
    
    get('/login') { haml :login }
    
    post('/login') do
      if params[:name] = 'admin' and params[:password] = 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end
  
  class MyApp < Sinatra::Base
    # middleware will run before filters
    use LoginScreen
    
    before do
      unless session['user_name']
        halt "Access denied, please <a href='/login'>login</a>."
      end
    end
    
    get('/') { "Hello #{session['user_name']}." }
  end

== 



=== /

SinatraSinatra::Base
DSL(<tt>require 'sinatra'</tt>)Sinatra::Application

`get``before`
`request``session`1

`set`:

    class MyApp < Sinatra::Base
      # Hey, I'm in the application scope!
      set :foo, 42
      foo # => 42
      
      get '/foo' do
        # Hey, I'm no longer in the application scope!
      end
    end

:

* 
* 
* `helpers`
* `set`Proc

():

* configure(<tt>configure { |c| ... }</tt>)
* `settings`

=== /


`request``session``erb``haml`
`settings`

  class MyApp < Sinatra::Base
    # Hey, I'm in the application scope!
    get '/define_route/:name' do
      # Request scope for '/define_route/:name'
      @value = 42
      
      settings.get("/#{params[:name]}") do
        # Request scope for "/#{params[:name]}"
        @value # => nil (not the same request)
      end
      
      "Route defined!"
    end
  end

:

* get/head/post/put/delete 
* before/after 
* helper 
* /

=== 


:
/(: `self`)
<tt>Sinatra::Delegator.delegate :method_name</tt>

:

* <tt>require "sinatra"</tt>
* `Sinatra::Delegator` mixinextend

: 
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
{main include}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28].

== 

Sinatra

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]

:

  -h # 
  -p # (4567)
  -o # (0.0.0.0)
  -e #  (development)
  -s # rackserver/handler (thin)
  -x # mutex lock (off)

== 

Sinatra
<tt>LOAD_PATH</tt><tt>sinatra/lib</tt>

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

<tt>sinatra/lib</tt><tt>LOAD_PATH</tt>

  $LOAD_PATH.unshift File.dirname(__FILE__) + '/sinatra/lib'
  require 'rubygems'
  require 'sinatra'

  get '/about' do
    "" + Sinatra::VERSION
  end

Sinatra:

  cd myproject/sinatra
  git pull

== 



* {Greenbear Laboratory Rack}[http://mono.kmc.gr.jp/~yhara/w/?RackReferenceJa] - Rack



* {}[http://sinatra.github.com/] - 
  
* {()}[http://sinatra.github.com/contributing.html] - 
  
* {Issue tracker}[http://github.com/sinatra/sinatra/issues] - 
* {Twitter}[http://twitter.com/sinatra]
* {}[http://groups.google.com/group/sinatrarb]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] on http://freenode.net

= Sinatra

<i>:         .</i>

Sinatra             DSL:

  # myapp.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

    :

  gem install sinatra
  ruby -rubygems myapp.rb

: http://localhost:4567

<tt>gem install thin</tt>   ,   Sinatra thin .

== (Routes)

Sinatra, (route) URL-    HTTP .
   :

  get '/' do
    ..  (show) ..
  end

  post '/' do
    ..  (create) ..
  end

  put '/' do
    ..  (replace) ..
  end

  patch '/' do
    ..  (modify) ..
  end

  delete '/' do
    ..  (annihilate) ..
  end

  options '/' do
    ..  (appease) ..
  end

         .

      , <tt>params</tt>    :

  get '/hello/:name' do
    # "GET /hello/foo"  "GET /hello/bar" 
    # params[:name] 'foo'  'bar'
    "Hello #{params[:name]}!"
  end

         :

  get '/hello/:name' do |n|
    "Hello #{n}!"
  end

  (splat,  )   ,   <tt>params[:splat]</tt>    :

  get '/say/*/to/*' do
    # /say/hello/to/world 
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    # /download/path/to/file.xml 
    params[:splat] # => ["path/to/file", "xml"]
  end

   :

  get '/download/*.*' do |path, ext|
    [path, ext] # => ["path/to/file", "xml"]
  end

   :

  get %r{/hello/([\w]+)} do
    "Hello, #{params[:captures].first}!"
  end

   :

  get %r{/hello/([\w]+)} do |c|
    "Hello, #{c}!"
  end

  (optional)    :

  get '/posts.?:format?' do
    # "GET /posts"  "GET /posts.json", "GET /posts.xml"     
  end

,    (path traversal attack protection,  )  , 
       .

=== (Conditions)

    (user agent)       :

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Songbird  #{params[:agent][0]} !"
  end

  get '/foo' do
    # songbird    
  end

    +host_name+ +provides+ :

  get '/', :host_name => /^admin\./ do
    "Admin Area, Access denied!"
  end

  get '/', :provides => 'html' do
    haml :index
  end

  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

     :

  set(:probability) { |value| condition { rand <= value } }

  get '/win_a_car', :probability => 0.1 do
    " !"
  end

  get '/win_a_car' do
    " ."
  end

    (splat) :

  set(:auth) do |*roles|   # <-  
    condition do
      unless logged_in? && roles.any? {|role| current_user.in_role? role }
        redirect "/login/", 303
      end
    end
  end

  get "/my/account/", :auth => [:user, :admin] do
    "  "
  end

  get "/only/admin/", :auth => :admin do
    "  !"
  end

=== (Return Values)

   HTTP     ,  Rack     .
 ,      ,   .

 Rack , Rack    HTTP        :

*    : <tt>[ (Fixnum),  (Hash),   (#each )]</tt>
*    : <tt>[ (Fixnum),   (#each )]</tt>
* <tt>#each</tt>      
*    Fixnum

  ,  , (streaming)     :

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

    +stream+  ( )        .

===   (Custom Route Matchers)

 , Sinatra          .
,   .   (matcher)    :

  class AllButPattern
    Match = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Match.new([])
    end

    def match(str)
      @captures unless @except === str
    end
  end

  def all_but(pattern)
    AllButPattern.new(pattern)
  end

  get all_but("/index") do
    # ...
  end

       .     :

  get // do
    pass if request.path_info == "/index"
    # ...
  end

  (negative look ahead)   :

  get %r{^(?!/index$)} do
    # ...
  end

==  (Static Files)

  <tt>./public</tt> .
    <tt>:public_folder</tt>   :

  set :public_folder, File.dirname(__FILE__) + '/static'

  public  URL    .
<tt>./public/css/style.css</tt>  <tt>http://example.com/css/style.css</tt>   .

<tt>Cache-Control</tt>    <tt>:static_cache_control</tt> ( )  .

==  / (Views / Templates)

        .
    .

  get '/' do
    erb :index
  end

  <tt>views/index.erb</tt> .

        :

  get '/' do
    code = "<%= Time.now %>"
    erb code
  end

      :

  get '/' do
    erb :index, :layout => :post
  end

  <tt>views/post.erb</tt>   <tt>views/index.erb</tt> .
( <tt>views/layout.erb</tt>,     ).

Sinatra        :

  get '/' do
    haml :index, :format => :html5
  end

      :

  set :haml, :format => :html5

  get '/' do
    haml :index
  end

render    +set+     .

 :

[locals]
    local .    .
  : <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>

[default_encoding]
      .  <tt>settings.default_encoding</tt>.

[views]
     .  <tt>settings.views</tt>.

[layout]
     (+true+  +false+),     , 
    . : <tt>erb :index, :layout => !request.xhr?</tt>

[content_type]
    Content-Type,    .

[scope]
    .   .
     ,        .

[layout_engine]
      .      .
     . : <tt>set :rdoc, :layout_engine => :erb</tt>

 <tt>./views</tt>    .      :

  set :views, settings.root + '/templates'

           ,
     (  <tt>:'subdir/template'</tt> ). 
   ,             .

===   (Available Template Languages)

     .    ( -thread-safe  ),
 require   :

  require 'rdiscount' # or require 'bluecloth'
  get('/') { markdown :index }

=== Haml 

::        {haml}[http://haml.info/]
 ::   <tt>.haml</tt>
::           <tt>haml :index, :format => :html5</tt>

=== Erb 

::        {erubis}[http://www.kuwata-lab.com/erubis/]  erb (  )
 ::   <tt>.erb</tt>, <tt>.rhtml</tt>  <tt>.erubis</tt> (Erubis )
::           <tt>erb :index</tt>

=== Builder 

::        {builder}[http://builder.rubyforge.org/]
 ::   <tt>.builder</tt>
Example::           <tt>builder { |xml| xml.em "hi" }</tt>

   ( ).

=== Nokogiri 

::        {nokogiri}[http://nokogiri.org/]
 ::   <tt>.nokogiri</tt>
::           <tt>nokogiri { |xml| xml.em "hi" }</tt>

   ( ).

=== Sass 

::        {sass}[http://sass-lang.com/]
 ::   <tt>.sass</tt>
::           <tt>sass :stylesheet, :style => :expanded</tt>

=== SCSS 

::        {sass}[http://sass-lang.com/]
 ::   <tt>.scss</tt>
::           <tt>scss :stylesheet, :style => :expanded</tt>

=== Less 

::        {less}[http://www.lesscss.org/]
 ::   <tt>.less</tt>
::           <tt>less :stylesheet</tt>

=== Liquid 

::        {liquid}[http://www.liquidmarkup.org/]
 ::   <tt>.liquid</tt>
::           <tt>liquid :index, :locals => { :key => 'value' }</tt>

Liquid   (+yield+ )    ,    locals  .

=== Markdown 

::               {rdiscount}[https://github.com/rtomayko/rdiscount],
                    {redcarpet}[https://github.com/tanoku/redcarpet],
                    {bluecloth}[http://deveiate.org/projects/BlueCloth],
                    {kramdown}[http://kramdown.rubyforge.org/] **
                    {maruku}[http://maruku.rubyforge.org/]
 ::   <tt>.markdown</tt>, <tt>.mkd</tt>,  <tt>.md</tt>
::           <tt>markdown :index, :layout_engine => :erb</tt>

     locals  . 
        :

  erb :overview, :locals => { :text => markdown(:introduction) }

    +markdown+    :

  %h1  Haml!
  %p= markdown(:greetings)

Markdown     , Markdown     .
, <tt>:layout_engine</tt>         .

=== Textile 

::        {RedCloth}[http://redcloth.org/]
 ::   <tt>.textile</tt>
::           <tt>textile :index, :layout_engine => :erb</tt>

Textile   locals   .
        :

  erb :overview, :locals => { :text => textile(:introduction) }

    +textile+    :

  %h1  Haml!
  %p= textile(:greetings)

Textile     , Textile     .
, <tt>:layout_engine</tt>         .

=== RDoc 

::        {rdoc}[http://rdoc.rubyforge.org/]
 ::   <tt>.rdoc</tt>
::           <tt>rdoc :README, :layout_engine => :erb</tt>

rdoc   locals   .
        :

  erb :overview, :locals => { :text => rdoc(:introduction) }

    +rdoc+    :

  %h1 Hello From Haml!
  %p= rdoc(:greetings)

RDoc     , RDoc     .
, <tt>:layout_engine</tt>         .


=== Radius 

::        {radius}[http://radius.rubyforge.org/]
 ::   <tt>.radius</tt>
::           <tt>radius :index, :locals => { :key => 'value' }</tt>

Radius       ,    locals   .


=== Markaby 

::        {markaby}[http://markaby.github.com/]
::   <tt>.mab</tt>
::           <tt>markaby { h1 "Welcome!" }</tt>

     ( ).

=== Slim 

::        {slim}[http://slim-lang.com/]
 ::   <tt>.slim</tt>
::           <tt>slim :index</tt>

=== Creole 

::        {creole}[https://github.com/minad/creole]
 ::   <tt>.creole</tt>
::           <tt>creole :wiki, :layout_engine => :erb</tt>

creole      locals   .
        .

  erb :overview, :locals => { :text => creole(:introduction) }

    +creole+    :

  %h1 Hello From Haml!
  %p= creole(:greetings)

Creole     , Creole     .
, <tt>:layout_engine</tt>         .


=== CoffeeScript 

::        {coffee-script}[https://github.com/josh/ruby-coffee-script]
                     { }[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
 ::   <tt>.coffee</tt>
::           <tt>coffee :index</tt>

=== Yajl 

::        {yajl-ruby}[https://github.com/brianmario/yajl-ruby]
 ::   <tt>.yajl</tt>
::           <tt>yajl :index, :locals => { :key => 'qux' }, :callback => 'present', :variable => 'resource' </tt>

The template source is evaluated as a Ruby string, and the resulting json variable is converted #to_json.
    (evaluate),  json  #to_json .

  json = { :foo => 'bar' }
  json[:baz] = key

<tt>:callback</tt> <tt>:variable</tt>    (decorate)   .

  var resource = {"foo":"bar","baz":"qux"}; present(resource);

=== (Embedded) 

  get '/' do
    haml '%div.title Hello World'
  end

   .

===   

Templates are evaluated within the same context as route handlers. Instance
variables set in route handlers are directly accessible by templates:
    (context) .
       : 

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end

,     : 

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= bar.name', :locals => { :bar => foo }
  end

This is typically used when rendering templates as partials from within
other templates.
       (partial)   .

===  

      :

  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hello world.

: require sinatra        .
       <tt>enable :inline_templates</tt>  .

===   (Named Templates)

  (top-level) <tt>template</tt>    :

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hello World!'
  end

  get '/' do
    haml :index
  end

"layout"   ,      .
  <tt>:layout => false</tt>    
 <tt>set :haml, :layout => false</tt>     :

  get '/' do
    haml :index, :layout => !request.xhr?
  end

===   

      , <tt>Tilt.register</tt>  .
 , +tt+   Textile   ,    :

  Tilt.register :tt, Tilt[:textile]

===     

, Tilt   ,     :

  Tilt.register :myat, MyAwesomeTemplateEngine

  helpers do
    def myat(*args) render(:myat, *args) end
  end

  get '/' do
    myat :index
  end

<tt>./views/index.myat</tt> . 
Tilt     https://github.com/rtomayko/tilt .

== (Filters)

 (before filter)            .
        :

  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end

 (after filter)             .
         :

  after do
    puts response.status
  end

:   +body+       , body   ,       .

     ,           .

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

 ,    :

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== (Helpers)

- <tt>helpers</tt>           :

  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

,        :

  module FooUtils
    def foo(name) "#{name}foo" end
  end

  module BarUtils
    def bar(name) "#{name}bar" end
  end

  helpers FooUtils, BarUtils

     (include)    .

=== (Sessions) 

      . 
 ,    session    :

  enable :sessions

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

<tt>enable :sessions</tt>       .
       ( ,       ).
      (Rack session middleware)    :
  , <tt>enable :sessions</tt>  **, 
        :

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

 ,      (secret) (sign). 
Sinatra     .
,          ,
           :

  set :session_secret, 'super secret'

    , +sessions+        :

  set :sessions, :domain => 'foo.com'

=== (Halting)

       :

  halt

     :

  halt 410

    :

  halt 'this will be the body'

   :

  halt 401, 'go away!'

      :

  halt 402, {'Content-Type' => 'text/plain'}, 'revenge'

 +halt+    :

  halt erb(:error)

=== (Passing)

 <tt>pass</tt>         :

  get '/guess/:who' do
    pass unless params[:who] == 'Frank'
    'You got me!'
  end

  get '/guess/*' do
    'You missed!'
  end

            .
    , 404 .

===   (Triggering Another Route)

  +pass+ ,         .
   ++call++  :

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

  , <tt>"bar"</tt>   <tt>/foo</tt> <tt>/bar</tt>   
       .

           , 
<tt>call</tt>  <tt>call!</tt>  .

<tt>call</tt>     Rack   .

=== ,     

     (status code)  (response body)      . ,            .
  +body+    .
 ,          :

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

+body+    ,   (Rack)    .
(       , " " ).

 ,     :

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "I'm a tea pot!"
  end

+body+, +header+ +status+           .

===  (Streaming Responses)

             .
 ,          .
 (wrapper)   +stream+   :

  get '/' do
    stream do |out|
      out << "It's gonna be legen -\n"
      sleep 0.5
      out << " (wait for it) \n"
      sleep 1
      out << "- dary!\n"
    end
  end

   API 
{  Server Sent Events}[http://dev.w3.org/html5/eventsource/]     ,
{WebSockets}[http://en.wikipedia.org/wiki/WebSocket]     .
         
(throughtput)     .

 ,         .
 ,  WEBRick        .
    ,  +stream+         .
 Shotgun  . 

   +keep_open+  ,   +close+   ,
           .
  Thin Rainbow     .
     :

  set :server, :thin
  connections = []

  get '/' do
    #    
    stream(:keep_open) { |out| connections << out }
  end

  post '/' do
    #    
    connections.each { |out| out << params[:message] << "\n" }
    "message sent"
  end

=== (Logging)

In the request scope, the +logger+ helper exposes a +Logger+ instance:
 (request scope) , +Logger+  +logger+    : 

  get '/' do
    logger.info "loading data"
    # ...
  end

   Rack      .
  ,   (dummy)   ,
         .

 <tt>Sinatra::Application</tt>    .
 <tt>Sinatra::Base</tt>      :

  class MyApp < Sinatra::Base
    configure :production, :development do
      enable :logging
    end
  end

     , +logging+  +nil+  .
,   +logger+ +nil+   .
       .
Sinatra <tt>env['rack.logger']</tt>    .

===  (Mime Types)

<tt>send_file</tt>     Sinatra       .
  +mime_type+     :

  configure do
    mime_type :foo, 'text/foo'
  end

 +content_type+     :

  get '/' do
    content_type :foo
    "foo foo foo"
  end

=== URL 

URL  +url+    .   Haml:

  %a{:href => url('/foo')} foo

  (reverse proxies) Rack ,  , .

This method is also aliased to +to+ (see below for an example).
  +to+     (  ).

===  (Browser Redirect)

+redirect+        :

  get '/foo' do
    redirect to('/bar')
  end

   +halt+    :

  redirect to('/bar'), 303
  redirect 'http://google.com', 'wrong place, buddy'

<tt>redirect back</tt>           :

  get '/foo' do
    "<a href='/bar'>do something</a>"
  end

  get '/bar' do
    do_something
    redirect back
  end

   ,  :

  redirect to('/bar?sum=42')

   :

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end

===  (Cache Control)

     HTTP  . 

Cache-Control       :

  get '/' do
    cache_control :public
    "cache it!"
  end

 :    :

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

+expires+      ,
<tt>Cache-Control</tt>   :

  before do
    expires 500, :public, :must_revalidate
  end

  , +etag+  +last_modified+    .
   **     ,
            (flush)  :

  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end

{ ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation]   :

  etag @article.sha1, :weak

     ,     .
    (reverse-proxy)    ,
{rack-cache}[http://rtomayko.github.com/rack-cache/] :

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

  <tt>Cache-Control</tt>    <tt>:static_cache_control</tt> ( ) :

RFC 2616  If-Match  If-None-Match  <tt>*</tt>    (resource)         .
Sinatra (get )  (put )       , 
  (  post  )    .
  <tt>:new_resource</tt>     :

  get '/create' do
    etag '', :new_resource => true
    Article.create
    erb :new_article
  end

  ETag  , <tt>:kind</tt> :

  etag '', :new_resource => true, :kind => :weak

===  (Sending Files)

 , <tt>send_file</tt>    :

  get '/' do
    send_file 'foo.png'
  end

     :

  send_file 'foo.png', :type => :jpg

:

[filename]
   .   .

[last_modified]
  Last-Modified .   mtime.

[type]
    .    .

[disposition]
  Content-Disposition .  : +nil+ (),
  <tt>:attachment</tt>  <tt>:inline</tt>

[length]
  Content-Length,   .

[status]
    .       .

Rack   , Ruby        .
     , Sinatra   (range request)  .

===   (Accessing the Request Object)

    (, ,  ) <tt>request</tt>    : 

# http://example.com/example    
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                #     ( )
    request.scheme              # "http"
    request.script_name         # "/example"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      # request.body 
    request.media_type          # request.body  
    request.host                # "example.com"
    request.get?                # true (     )
    request.form_data?          # false
    request["SOME_HEADER"]      # SOME_HEADER  
    request.referrer            #    '/'
    request.user_agent          #   (:agent  )
    request.cookies             #   
    request.xhr?                #  ajax ?
    request.url                 # "http://example.com/example/foo"
    request.path                # "/example/foo"
    request.ip                  #  IP 
    request.secure?             # false (ssl   true)
    request.forwarded?          # true (    )
    request.env                 # Rack   (raw) env 
  end

 , <tt>script_name</tt>  <tt>path_info</tt>      :

  before { request.path_info = "/" }

  get "/" do
    "all requests end up here"
  end

<tt>request.body</tt> IO  StringIO :

  post "/api" do
    request.body.rewind  #    
    data = JSON.parse request.body.read
    "Hello #{data['name']}!"
  end

=== (Attachments)

+attachment+         
     :

  get '/' do
    attachment
    "store it!"
  end

     :

  get '/' do
    attachment "info.txt"
    "store it!"
  end

===   

Sinatra +time_for_+   ,     Time  .
+DateTime+  +Date+     :

  get '/' do
    pass if Time.now > time_for('Dec 23, 2012')
    "still time"
  end

   +expires+  +last_modified+   .
   +time_for+  
      :

  helpers do
    def time_for(value)
      case value
      when :yesterday then Time.now - 24*60*60
      when :tomorrow  then Time.now + 24*60*60
      else super
      end
    end
  end

  get '/' do
    last_modified :yesterday
    expires :tomorrow
    "hello"
  end

===   

<tt>find_template</tt>     :

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "could be #{file}"
  end

This is not really useful. But it is useful that you can actually override this
method to hook in your own lookup mechanism. For instance, if you want to be
able to use more than one view directory:
   .          .
 ,      :

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

       :

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end

   (extension)      !

<tt>find_template</tt>       .
        .
    , +render+    +break+   .
,  ( )       .
       .

== (Configuration)

 ,  ,  :

  configure do
    #   
    set :option, 'value'

    #   
    set :a => 1, :b => 2

    # `set :option, true` 
    enable :option

    # `set :option, false` 
    disable :option

    #      
    set(:css_dir) { File.join(views, 'css') }
  end

(RACK_ENV  ) <tt>:production</tt>  :

  configure :production do
    ...
  end

 <tt>:production</tt>  <tt>:test</tt>  :

  configure :production, :test do
    ...
  end

  <tt>settings</tt>   :

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

===   (Configuring attack protection)

Sinatra {Rack::Protection}[https://github.com/rkh/rack-protection#readme]  
,     . 
     (    ):

  disable :protection

  ,   +protection+  :

  set :protection, :except => :path_traversal

   ,   :

  set :protection, :except => [:path_traversal, :session_hijacking]

===  (Available Settings)

[absolute_redirects]    , Sinatra    ,
                         Sinatra       
                       RFC 2616(HTTP 1.1)  .

                                 .
                       +rul+ ,     +false+  ,
                         URL   .

                        .

[add_charsets]         <tt>content_type</tt>      (mime) .

                            :

                         settings.add_charsets << "application/foobar"

[app_file]                .   ,  public ,  
                         .

[bind]                  IP (: 0.0.0.0).
                        (built-in)  .

[default_encoding]        
                       ( <tt>"utf-8"</tt>).

[dump_errors]            .

[environment]           ,  <tt>ENV['RACK_ENV']</tt>      "development".

[logging]              (logger) .

[lock]                    (lock) . Ruby      .

                         (thread-safe)   .
                        .

[method_override]      put/delete    put/delete  
                       <tt>_method</tt>  .

[port]                  .   .

[prefixed_redirects]       <tt>request.script_name</tt>
                        .   <tt>redirect '/foo'</tt> <tt>redirect to('/foo')</tt>
                        .  .

[protection]                .    .

[public_folder]        public    .
                       static     ( <tt>static</tt>).
                          <tt>app_file</tt> .

[reload_templates]        (reload)  .
                         .

[root]                    . 
                         +app_file+  .

[raise_errors]          ( ).
                        <tt>environment</tt> <tt>"test"</tt>  ,   .

[run]                  , Sinatra   .
                       rackup        .

[running]                 ?
                           !

[server]                     .
                        ['thin', 'mongrel', 'webrick']   .

[sessions]             <tt>Rack::Session::Cookie</tt>     .
                          ' ' .

[show_exceptions]            .
                        <tt>environment</tt> <tt>"development"</tt>  ,  .

[static]               Sinatra (static)    .
                              .
                         .
                          ,   .

[static_cache_control] Sinatra    ,  <tt>Cache-Control</tt>    .
                       +cache_control+  .
                        .
                              :
                       <tt>set :static_cache_control, [:public, :max_age => 300]</tt>

[threaded]             +true+ , Thin    <tt>EventMachine.defer</tt>  . 

[views]                  .    <tt>app_file</tt> .

== (Environments)

 +RACK_ENV+      .  "development".
 ,     .
 <tt>not_found</tt>  <tt>error</tt>     
      .
<tt>"production"</tt> <tt>"test"</tt>    .

   <tt>-e</tt>  :

  ruby my_app.rb -e [ENVIRONMENT]

        +development?+, +test?+  +production?+ 
  .

==  (Error Handling)

        . 
 ,        .   <tt>haml</tt>,
<tt>erb</tt>, <tt>halt</tt>, .

===   (Not Found)

<tt>Sinatra::NotFound</tt>       404,
<tt>not_found</tt>  :

  not_found do
    '    .'
  end

=== (Error)

+error+         .
  Rack  <tt>sinatra.error</tt>   :

  error do
    '   - ' + env['sinatra.error'].name
  end

  :

  error MyCustomError do
    '  ...' + env['sinatra.error'].message
  end

 ,   :

  get '/' do
    raise MyCustomError, ' '
  end

 :

    ...  

,        :

  error 403 do
    ' '
  end

  get '/secret' do
    403
  end

Or a range:

  error 400..510 do
    ''
  end

Sinatra     
 <tt>not_found</tt>  <tt>error</tt>  .

== Rack (Rack Middleware)

Sinatra Rack[http://rack.rubyforge.org/]  ,
Rack       .
Rack         
"(middleware)"  ,      
 HTTP / / 
     (component).

Sinatra  +use+   Rack        :

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hello World'
  end

+use+  Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] DSL
(rackup    )   .
 , +use+      /  :

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'secret'
  end

Rack , , URL , ,         .
Sinatra         ,
   +use+     .

  
{rack}[https://github.com/rack/rack/tree/master/lib/rack],
{rack-contrib}[https://github.com/rack/rack-contrib#readme],
{CodeRack}[http://coderack.org/] 
{Rack wiki}[https://github.com/rack/rack/wiki/List-of-Middleware]
   .

== (Testing)

Sinatra  Rack          .
{Rack::Test}[http://rdoc.info/github/brynary/rack-test/master/frames] :

  require 'my_sinatra_app'
  require 'test/unit'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hello World!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hello Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "You're using Songbird!", last_response.body
    end
  end

== Sinatra::Base - (Middleware), (Libraries),   (Modular Apps)

     (micro-app)   ,
Rack , Rails (metal)      ,   
Sinatra (extension)         .
     (,     
<tt>./public</tt>  <tt>./views</tt> , ,    ).
  <tt>Sinatra::Base</tt>  :

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hello world!'
    end
  end

<tt>Sinatra::Base</tt>     DSL    .
       <tt>Sinatra::Base</tt>   :

*  +sinatra+  <tt>sinatra/base</tt> require ,  
   Sinatra DSL     .
*  ,  , ,   <tt>Sinatra::Base</tt>   .

<tt>Sinatra::Base</tt> (blank slate).
       .
      {Options and Configuration}[http://sinatra.github.com/configuration.html]  .

=== (Modular) vs.  (Classic Style)

  ,     .
  ,     .

            
  Sinatra     .
    ,   .
       .

     ,      :

                                   


  app_file            sinatra     Sinatra::Base  
  run                 $0 == app_file          false
  logging             true                    false
  method_override     true                    false
  inline_templates    true                    false
  static              true                    false


===  (Modular Application) 

       , 
 <tt>run!</tt> :

  # my_app.rb
  require 'sinatra/base'

  class MyApp < Sinatra::Base
    # ...     ...

    #       
    run! if app_file == $0
  end

  :

  ruby my_app.rb

 <tt>config.ru</tt>  ,    Rack    :

  # config.ru
  require './my_app'
  run MyApp

:

  rackup -p 4567

=== config.ru    

    :

  # app.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

 <tt>config.ru</tt>   :

  require './app'
  run Sinatra::Application

===  config.ru ?

Good signs you probably want to use a <tt>config.ru</tt>:
 <tt>config.ru</tt>   :

*  Rack (Passenger, Unicorn, Heroku, ...)   .
*   <tt>Sinatra::Base</tt>    .
* Sinatra (endpoint) ,     .

<b>    <tt>config.ru</tt>   ,
 <tt>config.ru</tt>        .</b>

=== Sinatra  

Sinatra  Rack      ,
 Sinatra    Rack      .
   Sinatra    , 
 Rack   (Rails/Ramaze/Camping/...) :

  require 'sinatra/base'

  class LoginScreen < Sinatra::Base
    enable :sessions

    get('/login') { haml :login }

    post('/login') do
      if params[:name] == 'admin' && params[:password] == 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end

  class MyApp < Sinatra::Base
    #     
    use LoginScreen

    before do
      unless session['user_name']
        halt " , <a href='/login'></a> ."
      end
    end

    get('/') { "Hello #{session['user_name']}." }
  end

===   (Dynamic Application Creation)

             ,
  <tt>Sinatra.new</tt>  :

  require 'sinatra/base'
  my_app = Sinatra.new { get('/') { "hi" } }
  my_app.run!

     :

  # config.ru
  require 'sinatra/base'

  controller = Sinatra.new do
    enable :logging
    helpers MyHelpers
  end

  map('/a') do
    run Sinatra.new(controller) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controller) { get('/') { 'b' } }
  end

 Sintra      Sinatra    .

   Sinatra       :

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run RailsProject::Application

== (Scopes) (Binding)

          .

=== / 

 Sinatra  <tt>Sinatra::Base</tt>  .
  DSL (<tt>require 'sinatra'</tt>) ,
  <tt>Sinatra::Application</tt>,       
  .   +get+  +before+   ,
+request+  +session+    .    
    .

+set+     :

    class MyApp < Sinatra::Base
      # ,    !
      set :foo, 42
      foo # => 42

      get '/foo' do
        # ,         !
      end
    end

      :

*   
*   
* +helpers+  
* +set+   Procs/blocks
* <tt>Sinatra.new</tt>  

  ()     :

* configure    (<tt>configure { |c| ... }</tt>)
*    +settings+

=== / 

 ,            .
    +request+  +session+   
+erb+  +haml+      .
     +settings+    :

  class MyApp < Sinatra::Base
    # ,    !
    get '/define_route/:name' do
      # '/define_route/:name'  
      @value = 42

      settings.get("/#{params[:name]}") do
        # "/#{params[:name]}"  
        @value # => nil (  )
      end

      " !"
    end
  end

       :

* get/head/post/put/delete/options 
* before/after 
* (helper) 
* /

===  (Delegation Scope)

 (delegation scope)     (forward).
, 100%    ,      .
  (delegation)     
   /   (: +self+ ).
<tt>Sinatra::Delegator.delegate :method_name</tt>       .

       :

*  , <tt>require "sinatra"</tt>  
* <tt>Sinatra::Delegator</tt>   

   : 
{Sinatra::Delegator }[https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633]
 {   }[https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30].

== (Command Line)

Sinatra     :

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]

:

  -h # 
  -p #   ( 4567)
  -o #   ( 0.0.0.0)
  -e #   ( development)
  -s # rack /  ( thin)
  -x # mutex   ( off)

== (Requirement)

    :

[ Ruby 1.8.7 ]
  1.8.7  ,     , 
  1.9.2   JRuby Rubinius   .
  1.8.7   Sinatra 2.0 Ruby 2.0    .
   ,    .
  <b>Ruby 1.8.6   .</b>
   1.8.6  , Sinatra 1.2 .
  Sinatra 1.4.0         .

[ Ruby 1.9.2 ]
  1.9.2   . Radius Maraby  1.9   .
  1.9.2p0, Sinatra         .
  Ruby 1.9.4/2.0     ,
   1.9    Ruby       .

[ Ruby 1.9.3 ]
  1.9.3  .   
         ( p0). 
    1.9.3       .

[ Rubinius ]
  Rubinius   (Rubinius >= 1.2.4),       .
    2.0    .

[ JRuby ]
  JRuby   (JRuby >= 1.6.5).        ,
   JRuby  , JRuby rack   .
  Thin   JRuby   .
  JRuby C     , RDiscount, Redcarpet  RedCloth 
    .

      .

      
 Sinatra      :

* JRuby Rubinius  
* Ruby Enterprise Edition
* MacRuby, Maglev, IronRuby
* Ruby 1.9.0  1.9.1 (      )

       
    ,       .

  CI ruby-head (  2.0.0)  1.9.4   ,
        . 
1.9.4p0 2.0.0p0  .

Sinatra        .

 Cardinal, SmallRuby, BlueRuby  1.8.7    
Sinatra    .

== (The Bleeding Edge)

Sinatra     , 
      ,    .

   (prerelease)   ,     

  gem install sinatra --pre

   

=== Bundler 

   Sinatra  , 
{Bundler}[http://gembundler.com/]   .

,    bundler :

  gem install bundler

 ,  , +Gemfile+  :

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  #  
  gem 'haml'                    #  , haml 
  gem 'activerecord', '~> 3.0'  #  ActiveRecord 3.x  

       .
, Sinatra     (Rack Tilt) 
Bundler    .

       :

  bundle exec ruby myapp.rb

===  (Roll Your Own)

 (clone)   <tt>$LOAD_PATH</tt> <tt>sinatra/lib</tt>  
  :

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

 Sinatra  :

  cd myapp/sinatra
  git pull

===  (Install Globally)

    :

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

   ,      

  sudo rake install

== (Versioning)

Sinatra { Semantic Versioning}[http://semver.org/] .
SemVer  SemVerTag   .


==   (Further Reading)

* { }[http://www.sinatrarb.com/] -  , ,     .
* {}[http://www.sinatrarb.com/contributing] -  ?  ?  ?
* { }[http://github.com/sinatra/sinatra/issues]
* {}[http://twitter.com/sinatra]
* {Mailing List}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] http://freenode.net 
* {Sinatra Book}[http://sinatra-book.gittr.com] Cookbook 
* {Sinatra Recipes}[http://recipes.sinatrarb.com/]   
* http://rubydoc.info  { }[http://rubydoc.info/gems/sinatra]
   {current HEAD}[http://rubydoc.info/github/sinatra/sinatra]  API 
* {CI server}[http://ci.rkh.im/view/Sinatra/]

= Sinatra
<i>Ateno: Este documento  apenas uma traduo da verso em ingls e pode estar desatualizado.</i>

Sinatra  uma DSL para criar rapidamente aplicaes web em Ruby com o mnimo de
esforo:

  # minhaapp.rb
  require 'rubygems'
  require 'sinatra'
  get '/' do
    'Ol Mundo!'
  end

Instale a gem e execute como:

  sudo gem install sinatra
  ruby minhaapp.rb

Acesse em: http://localhost:4567

== Rotas

No Sinatra, uma rota  um metodo HTTP associado a uma URL correspondente padro.
Cada rota  associada a um bloco:

  get '/' do
    .. mostrando alguma coisa ..
  end

  post '/' do
    .. criando alguma coisa ..
  end

  put '/' do
    .. atualizando alguma coisa ..
  end

  delete '/' do
    .. apagando alguma coisa ..
  end

Rotas so encontradas na ordem em que so definidas. A primeira rota que
 encontrada invoca o pedido.

Padres de rota podem incluir parmetros nomeados, acessveis via a
hash <tt>params</tt>:

  get '/ola/:nome' do
    # corresponde a "GET /ola/foo" e "GET /ola/bar"
    # params[:nome]  'foo' ou 'bar'
    "Ol #{params[:nome]}!"
  end

Voc tambm pode acessar parmetros nomeados via bloco de parmetros:

  get '/ola/:nome' do |n|
    "Ol #{n}!"
  end

Padres de rota tambm podem incluir parmetros splat (ou curingas), acessveis
via o array <tt>params[:splat]</tt>.

  get '/diga/*/para/*' do
    # corresponde a /diga/ola/para/mundo
    params[:splat] # => ["ola", "mundo"]
  end

  get '/download/*.*' do
    # corresponde a /download/pasta/do/arquivo.xml
    params[:splat] # => ["pasta/do/arquivo", "xml"]
  end

Rotas se correspondem com expresses regulares:

  get %r{/ola/([\w]+)} do
    "Ol, #{params[:captures].first}!"
  end

Ou com um bloco de parmetro:

  get %r{/ola/([\w]+)} do |c|
    "Hello, #{c}!"
  end

Rotas podem incluir uma variedade de condies correspondes, tal como o agente usurio:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Voc est utilizando a verso #{params[:agent][0]} do Songbird."
  end

  get '/foo' do
    # Corresponde a um navegador no Songbird
  end

== Arquivos estticos

Arquivos estticos so disponibilizados a partir do diretrio <tt>./public</tt>. Voc pode especificar
um local diferente pela opo <tt>:public_folder</tt>

  set :public_folder, File.dirname(__FILE__) + '/estatico'

Note que o nome do diretrio pblico no  incluido na URL. Um arquivo
<tt>./public/css/style.css</tt>  disponibilizado como
<tt>http://example.com/css/style.css</tt>.

== Views / Templates

Templates presumem-se estar localizados sob o diretrio <tt>./views</tt>.
Para utilizar um diretrio view diferente:

  set :views, File.dirname(__FILE__) + '/modelo'

Uma coisa importante a ser lembrada  que voc sempre tem as referncias dos
templates como smbolos, mesmo se eles estiverem em um sub-diretrio (nesse
caso utilize <tt>:'subdir/template'</tt>). Mtodos de renderizao iro processar
qualquer string passada diretamente para elas.

=== Haml Templates

A gem/biblioteca haml  necessria para renderizar templates HAML:

  # Voc precisa do 'require haml' em sua aplicao.
  require 'haml'

  get '/' do
    haml :index
  end

Renderiza <tt>./views/index.haml</tt>.

{Opes Haml}[http://haml.info/docs/yardoc/file.HAML_REFERENCE.html#options]
podem ser setadas globalmente atravs das configuraes do sinatra,
veja {Opes e Configuraes}[http://www.sinatrarb.com/configuration.html],
e substitua em uma requisio individual.

  set :haml, {:format => :html5 } # o formato padro do Haml  :xhtml

  get '/' do
    haml :index, :haml_options => {:format => :html4 } # substituido
  end


=== Erb Templates

  # Voc precisa do 'require erb' em sua aplicao
  require 'erb'

  get '/' do
    erb :index
  end

Renderiza <tt>./views/index.erb</tt>

=== Erubis

A gem/biblioteca erubis  necessria para renderizar templates erubis:

  # Voc precisa do 'require erubis' em sua aplicao.
  require 'erubis'

  get '/' do
    erubis :index
  end

Renderiza <tt>./views/index.erubis</tt>

=== Builder Templates

A gem/biblioteca builder  necessria para renderizar templates builder:

  # Voc precisa do 'require builder' em sua aplicao.
  require 'builder'

  get '/' do
    content_type 'application/xml', :charset => 'utf-8'
    builder :index
  end

Renderiza <tt>./views/index.builder</tt>.

=== Sass Templates

A gem/biblioteca sass  necessria para renderizar templates sass:

  # Voc precisa do 'require haml' ou 'require sass' em sua aplicao.
  require 'sass'

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    sass :stylesheet
  end

Renderiza <tt>./views/stylesheet.sass</tt>.

{Opes Sass}[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
podem ser setadas globalmente atravs das configuraes do sinatra,
veja {Opes e Configuraes}[http://www.sinatrarb.com/configuration.html],
e substitua em uma requisio individual.

  set :sass, {:style => :compact } # o estilo padro do Sass  :nested

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    sass :stylesheet, :style => :expanded # substituido
  end

=== Less Templates

A gem/biblioteca less  necessria para renderizar templates Less:

  # Voc precisa do 'require less' em sua aplicao.
  require 'less'

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    less :stylesheet
  end

Renderiza <tt>./views/stylesheet.less</tt>.

=== Inline Templates

  get '/' do
    haml '%div.title Ol Mundo'
  end

Renderiza a string, em uma linha, no template.

=== Acessando Variveis nos Templates

Templates so avaliados dentro do mesmo contexto como manipuladores de rota. Variveis
de instncia setadas em rotas manipuladas so diretamente acessadas por templates:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.nome'
  end

Ou, especifique um hash explcito para variveis locais:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.nome', :locals => { :foo => foo }
  end

Isso  tipicamente utilizando quando renderizamos templates como partials dentro
de outros templates.

=== Templates Inline

Templates podem ser definidos no final do arquivo fonte(.rb):

  require 'rubygems'
  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Ol Mundo!!!!!

NOTA: Templates inline definidos no arquivo fonte so automaticamente carregados
pelo sinatra. Digite `enable :inline_templates` se voc tem templates
inline no outro arquivo fonte.

=== Templates nomeados

Templates tambm podem ser definidos utilizando o  mtodo top-level <tt>template</tt>:

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Ol Mundo!'
  end

  get '/' do
    haml :index
  end

Se existir um template com nome "layout", ele ser utilizado toda vez que um
template for renderizado. Voc pode desabilitar layouts passando <tt>:layout => false</tt>.

  get '/' do
    haml :index, :layout => !request.xhr?
  end

== Helpers

Use o mtodo de alto nvel <tt>helpers</tt> para definir mtodos auxiliares para utilizar em
manipuladores de rotas e modelos:

  helpers do
    def bar(nome)
      "#{nome}bar"
    end
  end

  get '/:nome' do
    bar(params[:nome])
  end

== Filtros

Filtros Before so avaliados antes de cada requisio dentro do contexto da requisio
e pode modificar a requisio e a reposta. Variveis de instncia setadas nos
filtros so acessadas atravs de rotas e templates:

  before do
    @nota = 'Oi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @nota #=> 'Oi!'
    params[:splat] #=> 'bar/baz'
  end

Filtros After so avaliados aps cada requisio dentro do contexto da
requisio e tambm podem modificar o pedido e a resposta. Variveis de instncia
definidas nos filtros before e rotas so acessadas atravs dos filtros after:

  after do
    puts response.status
  end

Filtros opcionalmente tem um padro, fazendo com que sejam avaliados somente se o caminho
do pedido coincidir com esse padro:

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

== Halting

Para parar imediatamente uma requisio com um filtro ou rota utilize:

  halt

Voc tambm pode especificar o status quando parar...

  halt 410

Ou com corpo de texto...

  halt 'isso ser o corpo do texto'

Ou tambm...

  halt 401, 'vamos embora!'

Com cabealhos...

  halt 402, {'Content-Type' => 'text/plain'}, 'revanche'

== Passing

Uma rota pode processar aposta para a prxima rota correspondente usando <tt>pass</tt>:

  get '/adivinhar/:quem' do
    pass unless params[:quem] == 'Frank'
    'Voc me pegou!'
  end

  get '/adivinhar/*' do
    'Voc falhou!'
  end

O bloqueio da rota  imediatamente encerrado e o controle continua com a prxima
rota de parmetro. Se o parmetro da rota no for encontrado, um 404  retornado.

== Configurao

Rodando uma vez, na inicializao, em qualquer ambiente:

  configure do
    ...
  end

Rodando somente quando o ambiente (RACK_ENV environment varivel)  setado para
<tt>:production</tt>:

  configure :production do
    ...
  end

Rodando quando o ambiente  setado para <tt>:production</tt> ou
<tt>:test</tt>:

  configure :production, :test do
    ...
  end

== Tratamento de Erros

Tratamento de erros rodam dentro do mesmo contexto como rotas e filtros before, o
que significa que voc pega todos os presentes que tem para oferecer, como <tt>haml</tt>, <tt>erb</tt>,
<tt>halt</tt>, etc.

=== No Encontrado

Quando um <tt>Sinatra::NotFound</tt> exception  levantado, ou o cdigo de status
da reposta  404, o <tt>not_found</tt> manipulador  invocado:

  not_found do
    'Isto est longe de ser encontrado'
  end

=== Erro

O manipulador +error+  invocado toda a vez que uma exceo  lanada a partir de
um bloco de rota ou um filtro. O objeto da exceo pode ser obtido a partir da varivel
Rack <tt>sinatra.error</tt>:

  error do
    'Desculpe, houve um erro desagradvel - ' + env['sinatra.error'].name
  end

Erros customizados:

  error MeuErroCustomizado do
    'Ento que aconteceu foi...' + env['sinatra.error'].message
  end

Ento, se isso acontecer:

  get '/' do
    raise MeuErroCustomizado, 'alguma coisa ruim'
  end

Voc receber isso:

  Ento que aconteceu foi... alguma coisa ruim

Alternativamente, voc pode instalar manipulador de erro para um cdigo de status:

  error 403 do
    'Accesso negado'
  end

  get '/secreto' do
    403
  end

Ou um range:

  error 400..510 do
    'Boom'
  end

O Sinatra instala os manipuladores especiais <tt>not_found</tt> e <tt>error</tt> quando
roda sobre o ambiente de desenvolvimento.

== Mime Types

Quando utilizamos <tt>send_file</tt> ou arquivos estticos voc pode ter mime types Sinatra
no entendidos. Use +mime_type+ para registrar eles por extenso de arquivos:

  mime_type :foo, 'text/foo'

Voc tambm pode utilizar isto com o helper +content_type+:

  content_type :foo

== Middleware Rack

O Sinatra roda no Rack[http://rack.rubyforge.org/], uma interface padro
mnima para frameworks web em Ruby. Um das capacidades mais interessantes do Rack
para desenvolver aplicativos  suporte a "middleware" -- componentes que ficam
entre o servidor e sua aplicao monitorando e/ou manipulando o request/response do
HTTP para prover vrios tipos de funcionalidades comuns.

O Sinatra faz construtores pipelines do middleware Rack facilmente em um nvel superior
utilizando o mtodo +use+:

  require 'sinatra'
  require 'meu_middleware_customizado'

  use Rack::Lint
  use MeuMiddlewareCustomizado

  get '/ola' do
    'Ol mundo'
  end

A semntica de +use+  idntica aquela definida para a DSL
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html]
(mais frequentemente utilizada para arquivos rackup). Por exemplo, o mtodo +use+
aceita mltiplos argumentos/variveis bem como blocos:

  use Rack::Auth::Basic do |usuario, senha|
    usuario == 'admin' && senha == 'secreto'
  end

O Rack  distribuido com uma variedade de middleware padres para logs,
debugs, rotas de URL, autenticao, e manipuladores de sesso. Sinatra utilizada
muitos desses componentes automaticamente baseando sobre configurao, ento, tipicamente
voc no tem +use+ explicitamente.

== Testando

Testes no Sinatra podem ser escritos utilizando qualquer biblioteca ou framework
de teste baseados no Rack. {Rack::Test}[http://gitrdoc.com/brynary/rack-test] 
recomendado:

  require 'minha_aplicacao_sinatra'
  require 'rack/test'

  class MinhaAplicacaoTeste < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def meu_test_default
      get '/'
      assert_equal 'Ola Mundo!', last_response.body
    end

    def teste_com_parametros
      get '/atender', :name => 'Frank'
      assert_equal 'Ol Frank!', last_response.bodymeet
    end

    def test_com_ambiente_rack
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Voc est utilizando o Songbird!", last_response.body
    end
  end

NOTA: Os mdulos de classe embutidos Sinatra::Test e Sinatra::TestHarness
so depreciados na verso 0.9.2.

== Sinatra::Base - Middleware, Bibliotecas e aplicativos modulares

Definir sua aplicao em um nvel superior de trabalho funciona bem para micro aplicativos, mas tem
considerveis incovenientes na construo de componentes reutilizveis como um middleware Rack,
metal Rails, bibliotecas simples como um componente de servidor, ou
mesmo extenses Sinatra. A DSL de nvel superior polui o espao do objeto
e assume um estilo de configurao de micro aplicativos (exemplo: uma simples arquivo de
aplicao, diretrios ./public e ./views, logs, pgina de detalhes de exceo,
etc.).  onde o Sinatra::Base entra em jogo:

  require 'sinatra/base'

  class MinhaApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Ola mundo!'
    end
  end

A classe MinhaApp  um componente Rack independente que pode agir como um
middleware Rack, uma aplicao Rack, ou metal Rails. Voc pode +utilizar+ ou
+executar+ esta classe com um arquivo rackup +config.ru+; ou, controlar um componente
de servidor fornecendo como biblioteca:

   MinhaApp.run! :host => 'localhost', :port => 9090

Os mtodos disponveis para subclasses Sinatra::Base so exatamente como aqueles
disponveis via a DSL de nvel superior. Aplicaes de nvel mais alto podem ser convertidas para
componentes Sinatra::Base com duas modificaes:

* Seu arquivo deve requerer +sinatra/base+  ao invs de +sinatra+;
  outra coisa, todos os mtodos DSL do Sinatra so importados para o espao
  principal.
* Coloque as rotas da sua aplicao, manipuladores de erro, filtros e opes na subclasse de
  um Sinatra::Base.

+Sinatra::Base+  um quadro branco. Muitas opes so desabilitadas por padro,
incluindo o servidor embutido. Veja {Opes e Configuraes}[http://sinatra.github.com/configuration.html]
para detalhes de opes disponveis e seus comportamentos.

SIDEBAR: A DSL de alto nvel do Sinatra  implementada utilizando um simples sistema de
delegao. A classe +Sinatra::Application+ -- uma subclasse especial da
Sinatra::Base -- recebe todos os :get, :put, :post, :delete, :before,
:error, :not_found, :configure, e :set messages enviados para o
alto nvel. D uma olhada no cdigo voc mesmo: aqui est o
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
sendo {incluido dentro de um espao principal}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28]

== Linha de Comando

Aplicaes Sinatra podem ser executadas diretamente:

  ruby minhaapp.rb [-h] [-x] [-e AMBIENTE] [-p PORTA] [-o HOST] [-s SERVIDOR]

As opes so:

  -h # ajuda
  -p # define a porta (padro  4567)
  -o # define o host (padro  0.0.0.0)
  -e # define o ambiente (padro  development)
  -s # especifica o servidor/manipulador rack (padro  thin)
  -x # ativa o bloqueio (padro  desligado)

== A ltima verso

Se voc gostaria de utilizar o cdigo da ltima verso do Sinatra, crie um clone
local e execute sua aplicao com o diretrio <tt>sinatra/lib</tt> no
<tt>LOAD_PATH</tt>:

  cd minhaapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -I sinatra/lib minhaapp.rb

Alternativamente, voc pode adicionar o diretrio do <tt>sinatra/lib</tt> no
<tt>LOAD_PATH</tt> do seu aplicativo:

  $LOAD_PATH.unshift File.dirname(__FILE__) + '/sinatra/lib'
  require 'rubygems'
  require 'sinatra'

  get '/sobre' do
    "Estou rodando a verso" + Sinatra::VERSION
  end

Para atualizar o cdigo do Sinatra no futuro:

  cd meuprojeto/sinatra
  git pull

== Mais

* {Website do Projeto}[http://www.sinatrarb.com/] - Documentao adicional,
  novidades e links para outros recursos.
* {Contribuir}[http://www.sinatrarb.com/contributing] - Encontrar um bug? Precisa
  de ajuda? Tem um patch?
* {Acompanhar Questes}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Lista de Email}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] em http://freenode.net

= Sinatra
<i>Ateno: Este documento  apenas uma traduo da verso em ingls e pode estar desatualizado.</i>

Sinatra  uma DSL para criar rapidamente aplicaes web em Ruby com o mnimo de
esforo:

  # minhaapp.rb
  require 'rubygems'
  require 'sinatra'
  get '/' do
    'Ol Mundo!'
  end

Instale a gem e execute com:

  sudo gem install sinatra
  ruby minhaapp.rb

Aceda em: http://localhost:4567

== Rotas

No Sinatra, uma rota  um metodo HTTP associado a uma URL correspondente padro.
Cada rota  associada a um bloco:

  get '/' do
    .. mostrar algo ..
  end

  post '/' do
    .. criar algo ..
  end

  put '/' do
    .. atualizar algo ..
  end

  delete '/' do
    .. apagar algo ..
  end

Rotas so encontradas na ordem em que so definidas. A primeira rota que
 encontrada invoca o pedido.

Padres de rota podem incluir parmetros nomeados, acessveis atravs da
hash <tt>params</tt>:

  get '/ola/:nome' do
    # corresponde a "GET /ola/foo" e "GET /ola/bar"
    # params[:nome]  'foo' ou 'bar'
    "Ol #{params[:nome]}!"
  end

Pode tambm aceder a parmetros nomeados atravs do bloco de parmetros:

  get '/ola/:nome' do |n|
    "Ol #{n}!"
  end

Padres de rota podem tambm incluir parmetros splat (asteriscos), acessveis
atravs do array <tt>params[:splat]</tt>.

  get '/diga/*/ao/*' do
    # corresponde a /diga/ola/ao/mundo
    params[:splat] # => ["ola", "mundo"]
  end

  get '/download/*.*' do
    # corresponde a /download/pasta/do/arquivo.xml
    params[:splat] # => ["pasta/do/arquivo", "xml"]
  end

Rotas correspondem-se com expresses regulares:

  get %r{/ola/([\w]+)} do
    "Ol, #{params[:captures].first}!"
  end

Ou com um bloco de parmetro:

  get %r{/ola/([\w]+)} do |c|
    "Ol, #{c}!"
  end

Rotas podem incluir uma variedade de condies correspondentes, por exemplo, o agente usurio:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Voc est a utilizar a verso #{params[:agent][0]} do Songbird."
  end

  get '/foo' do
    # Corresponde a um navegador no Songbird
  end

== Arquivos estticos

Arquivos estticos so disponibilizados a partir do directrio <tt>./public</tt>. Voc pode especificar
um local diferente atravs da opo <tt>:public_folder</tt>

  set :public_folder, File.dirname(__FILE__) + '/estatico'

Note que o nome do directrio pblico no  incluido no URL. Um arquivo
<tt>./public/css/style.css</tt>  disponibilizado como
<tt>http://example.com/css/style.css</tt>.

== Views / Templates

Templates presumem-se estar localizados sob o directrio <tt>./views</tt>.
Para utilizar um directrio de views diferente:

  set :views, File.dirname(__FILE__) + '/modelo'

Uma coisa importante a ser lembrada  que voc sempre tem as referncias dos
templates como smbolos, mesmo se eles estiverem num sub-directrio (nesse
caso utilize <tt>:'subdir/template'</tt>). Mtodos de renderizao iro processar
qualquer string passada directamente para elas.

=== Haml Templates

A gem/biblioteca haml  necessria para renderizar templates HAML:

  #  necessrio requerir 'haml' na aplicao.
  require 'haml'

  get '/' do
    haml :index
  end

Renderiza <tt>./views/index.haml</tt>.

{Opes Haml}[http://haml.info/docs/yardoc/file.HAML_REFERENCE.html#options]
podem ser definidas globalmente atravs das configuraes do sinatra,
veja {Opes e Configuraes}[http://www.sinatrarb.com/configuration.html],
e substitua em uma requisio individual.

  set :haml, {:format => :html5 } # o formato padro do Haml  :xhtml

  get '/' do
    haml :index, :haml_options => {:format => :html4 } # substituido
  end


=== Erb Templates

  #  necessrio requerir 'erb' na aplicao.
  require 'erb'

  get '/' do
    erb :index
  end

Renderiza <tt>./views/index.erb</tt>

=== Erubis

A gem/biblioteca erubis  necessria para renderizar templates erubis:

  #  necessrio requerir 'erubis' na aplicao.
  require 'erubis'

  get '/' do
    erubis :index
  end

Renderiza <tt>./views/index.erubis</tt>

=== Builder Templates

A gem/biblioteca builder  necessria para renderizar templates builder:

  #  necessrio requerir 'builder' na aplicao.
  require 'builder'

  get '/' do
    content_type 'application/xml', :charset => 'utf-8'
    builder :index
  end

Renderiza <tt>./views/index.builder</tt>.

=== Sass Templates

A gem/biblioteca sass  necessria para renderizar templates sass:

  #  necessrio requerir 'haml' ou 'sass' na aplicao.
  require 'sass'

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    sass :stylesheet
  end

Renderiza <tt>./views/stylesheet.sass</tt>.

{Opes Sass}[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
podem ser definidas globalmente atravs das configuraes do sinatra,
veja {Opes e Configuraes}[http://www.sinatrarb.com/configuration.html],
e substitua em uma requisio individual.

  set :sass, {:style => :compact } # o estilo padro do Sass  :nested

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    sass :stylesheet, :style => :expanded # substituido
  end

=== Less Templates

A gem/biblioteca less  necessria para renderizar templates Less:

  #  necessrio requerir 'less' na aplicao.
  require 'less'

  get '/stylesheet.css' do
    content_type 'text/css', :charset => 'utf-8'
    less :stylesheet
  end

Renderiza <tt>./views/stylesheet.less</tt>.

=== Templates Inline

  get '/' do
    haml '%div.title Ol Mundo'
  end

Renderiza a string, em uma linha, no template.

=== Acedendo a Variveis nos Templates

Templates so avaliados dentro do mesmo contexto que os manipuladores de rota. Variveis
de instncia definidas em rotas manipuladas so directamente acedidas por templates:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.nome'
  end

Ou, especifique um hash explcito para variveis locais:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.nome', :locals => { :foo => foo }
  end

Isso  tipicamente utilizado quando renderizamos templates parciais (partials) dentro
de outros templates.

=== Templates Inline

Templates podem ser definidos no final do arquivo fonte(.rb):

  require 'rubygems'
  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Ol Mundo!!!!!

NOTA: Templates inline definidos no arquivo fonte so automaticamente carregados
pelo sinatra. Digite `enable :inline_templates` se tem templates inline no outro 
arquivo fonte.

=== Templates nomeados

Templates tambm podem ser definidos utilizando o  mtodo top-level <tt>template</tt>:

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Ol Mundo!'
  end

  get '/' do
    haml :index
  end

Se existir um template com nome "layout", ele ser utilizado sempre que um
template for renderizado. Pode desactivar layouts usando <tt>:layout => false</tt>.

  get '/' do
    haml :index, :layout => !request.xhr?
  end

== Helpers

Use o mtodo de alto nvel <tt>helpers</tt> para definir mtodos auxiliares para utilizar em
manipuladores de rotas e modelos:

  helpers do
    def bar(nome)
      "#{nome}bar"
    end
  end

  get '/:nome' do
    bar(params[:nome])
  end

== Filtros

Filtros Before so avaliados antes de cada requisio dentro do contexto da requisio
e podem modificar a requisio e a reposta. Variveis de instncia definidas nos
filtros so acedidas atravs de rotas e templates:

  before do
    @nota = 'Ol!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @nota #=> 'Ol!'
    params[:splat] #=> 'bar/baz'
  end

Filtros After so avaliados aps cada requisio dentro do contexto da
requisio e tambm podem modificar o pedido e a resposta. Variveis de instncia
definidas nos filtros before e rotas so acedidas atravs dos filtros after:

  after do
    puts response.status
  end

Filtros opcionalmente tm um padro, fazendo com que sejam avaliados somente se o caminho
do pedido coincidir com esse padro:

  before '/protected/*' do
    autenticar!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

== Halting

Para parar imediatamente uma requisio dentro de um filtro ou rota utilize:

  halt

Pode tambm especificar o status ao parar...

  halt 410

Ou com um corpo de texto...

  halt 'isto ser o corpo de texto'

Ou tambm...

  halt 401, 'vamos embora!'

Com cabealhos...

  halt 402, {'Content-Type' => 'text/plain'}, 'revanche'

== Passing

Dentro de uma rota, pode passar para a prxima rota correspondente usando <tt>pass</tt>:

  get '/adivinhar/:quem' do
    pass unless params[:quem] == 'Frank'
    'Apanhaste-me!'
  end

  get '/adivinhar/*' do
    'Falhaste!'
  end

O bloqueio da rota  imediatamente encerrado e o controle continua com a prxima
rota de parmetro. Se o parmetro da rota no for encontrado, um 404  retornado.

== Configurao

Correndo uma vez, na inicializao, em qualquer ambiente:

  configure do
    ...
  end

Correndo somente quando o ambiente (RACK_ENV environment varivel)  definido para
<tt>:production</tt>:

  configure :production do
    ...
  end

Correndo quando o ambiente  definido para <tt>:production</tt> ou
<tt>:test</tt>:

  configure :production, :test do
    ...
  end

== Lidar com Erros

Lida-se com erros no mesmo contexto das rotas e filtros before, o que signifca que
<tt>haml</tt>, <tt>erb</tt>, etc, esto disponveis.

=== No Encontrado

Quando um <tt>Sinatra::NotFound</tt> exception  levantado, ou o cdigo de status
da reposta  404, o manipulador <tt>not_found</tt>  invocado:

  not_found do
    'Isto est longe de ser encontrado'
  end

=== Erro

O manipulador +error+  invocado sempre que uma exceo  lanada a partir de
um bloco de rota ou um filtro. O objecto da exceo pode ser obtido a partir da varivel
Rack <tt>sinatra.error</tt>:

  error do
    'Peo desculpa, houve um erro desagradvel - ' + env['sinatra.error'].name
  end

Erros personalizados:

  error MeuErroPersonalizado do
    'O que aconteceu foi...' + env['sinatra.error'].message
  end

Ento, se isso acontecer:

  get '/' do
    raise MeuErroPersonalizado, 'alguma coisa desagradvel'
  end

O resultado ser:

  O que aconteceu foi...alguma coisa desagradvel

Alternativamente, pode definir um manipulador de erro para um cdigo de status:

  error 403 do
    'Accesso negado'
  end

  get '/secreto' do
    403
  end

Ou um range (alcance):

  error 400..510 do
    'Boom'
  end

O Sinatra define os manipuladores especiais <tt>not_found</tt> e <tt>error</tt> quando
corre no ambiente de desenvolvimento.

== Mime Types

Quando utilizamos <tt>send_file</tt> ou arquivos estticos pode ter mime types Sinatra
no entendidos. Use +mime_type+ para os registar por extenso de arquivos:

  mime_type :foo, 'text/foo'

Pode tambm utilizar isto com o helper +content_type+:

  content_type :foo

== Middleware Rack

O Sinatra corre no Rack[http://rack.rubyforge.org/], uma interface padro mnima para
frameworks web em Ruby. Uma das capacidades mais interessantes do Rack, para desenvolver
aplicaes,  o suporte de "middleware" -- componentes que residem entre o servidor e
a aplicao, monitorizando e/ou manipulando o pedido/resposta (request/response) HTTP
para providenciar varios tipos de funcionalidades comuns.

O Sinatra torna a construo de pipelines do middleware Rack fcil a um nvel superior
utilizando o mtodo +use+:

  require 'sinatra'
  require 'meu_middleware_personalizado'

  use Rack::Lint
  use MeuMiddlewarePersonalizado

  get '/ola' do
    'Ol mundo'
  end

A semntica de +use+  idntica aquela definida para a DSL
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html]
(mais frequentemente utilizada para arquivos rackup). Por exemplo, o mtodo +use+
aceita mltiplos argumentos/variveis, bem como blocos:

  use Rack::Auth::Basic do |utilizador, senha|
    utilizador == 'admin' && senha == 'secreto'
  end

O Rack  distribuido com uma variedade de middleware padres para logs,
debugs, rotas de URL, autenticao, e manipuladores de sesso.Sinatra utiliza 
muitos desses componentes automaticamente dependendo da configurao, por isso, 
tipicamente nao  necessrio utilizar +use+ explicitamente.

== Testando

Testes no Sinatra podem ser escritos utilizando qualquer biblioteca ou framework
de teste baseados no Rack. {Rack::Test}[http://gitrdoc.com/brynary/rack-test] 
recomendado:

  require 'minha_aplicacao_sinatra'
  require 'rack/test'

  class MinhaAplicacaoTeste < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def meu_test_default
      get '/'
      assert_equal 'Ola Mundo!', last_response.body
    end

    def teste_com_parametros
      get '/atender', :name => 'Frank'
      assert_equal 'Ol Frank!', last_response.bodymeet
    end

    def test_com_ambiente_rack
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "Voc est utilizando o Songbird!", last_response.body
    end
  end

NOTA: Os mdulos de classe embutidos Sinatra::Test e Sinatra::TestHarness
so depreciados na verso 0.9.2.

== Sinatra::Base - Middleware, Bibliotecas e aplicativos modulares

Definir sua aplicao a um nvel superior de trabalho funciona bem para micro aplicativos, mas tem
considerveis incovenientes na construo de componentes reutilizveis como um middleware Rack,
metal Rails, bibliotecas simples como um componente de servidor, ou
mesmo extenses Sinatra. A DSL de nvel superior polui o espao do objeto
e assume um estilo de configurao de micro aplicativos (exemplo: um simples arquivo de
aplicao, directrios ./public e ./views, logs, pgina de detalhes de excepo,
etc.).  onde o Sinatra::Base entra em jogo:

  require 'sinatra/base'

  class MinhaApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Ol mundo!'
    end
  end

A classe MinhaApp  um componente Rack independente que pode utilizar como um
middleware Rack, uma aplicao Rack, ou metal Rails. Pode +utilizar+ ou
+executar+ esta classe com um arquivo rackup +config.ru+; ou, controlar um componente
de servidor fornecendo como biblioteca:

   MinhaApp.run! :host => 'localhost', :port => 9090

Os mtodos disponveis para subclasses Sinatra::Base so exatamente como aqueles
disponveis via a DSL de nvel superior. Aplicaes de nvel mais alto podem ser convertidas para
componentes Sinatra::Base com duas modificaes:

* Seu arquivo deve requerer +sinatra/base+  ao invs de +sinatra+;
  outra coisa, todos os mtodos DSL do Sinatra so importados para o espao
  principal.
* Coloque as rotas da sua aplicao, manipuladores de erro, filtros e opes na subclasse de
  um Sinatra::Base.

+Sinatra::Base+  um quadro branco. Muitas opes so desactivadas por padro,
incluindo o servidor embutido. Veja {Opes e Configuraes}[http://sinatra.github.com/configuration.html]
para detalhes de opes disponveis e seus comportamentos.

SIDEBAR: A DSL de alto nvel do Sinatra  implementada utilizando um simples sistema de
delegao. A classe +Sinatra::Application+ -- uma subclasse especial da
Sinatra::Base -- recebe todos os :get, :put, :post, :delete, :before,
:error, :not_found, :configure, e :set messages enviados para o
alto nvel. D voc mesmo uma vista de olhos ao cdigo: aqui est o
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
sendo {incluido dentro de um espao principal}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28]

== Linha de Comandos

As aplicaes Sinatra podem ser executadas directamente:

  ruby minhaapp.rb [-h] [-x] [-e AMBIENTE] [-p PORTA] [-o HOST] [-s SERVIDOR]

As opes so:

  -h # ajuda
  -p # define a porta (padro  4567)
  -o # define o host (padro  0.0.0.0)
  -e # define o ambiente (padro  development)
  -s # especifica o servidor/manipulador rack (padro  thin)
  -x # activa o bloqueio (padro  desligado)

== A ltima verso

Se gostaria de utilizar o cdigo da ltima verso do Sinatra, crie um clone
local e execute sua aplicao com o directrio <tt>sinatra/lib</tt> no
<tt>LOAD_PATH</tt>:

  cd minhaapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -I sinatra/lib minhaapp.rb

Alternativamente, pode adicionar o directrio do <tt>sinatra/lib</tt> no
<tt>LOAD_PATH</tt> do seu aplicativo:

  $LOAD_PATH.unshift File.dirname(__FILE__) + '/sinatra/lib'
  require 'rubygems'
  require 'sinatra'

  get '/sobre' do
    "Estou correndo a verso" + Sinatra::VERSION
  end

Para actualizar o cdigo do Sinatra no futuro:

  cd meuprojeto/sinatra
  git pull

== Mais

* {Website do Projeto}[http://www.sinatrarb.com/] - Documentao adicional,
  novidades e links para outros recursos.
* {Contribuir}[http://www.sinatrarb.com/contributing] - Encontrou um bug? Precisa
  de ajuda? Tem um patch?
* {Acompanhar Questes}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Lista de Email}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] em http://freenode.net

= Sinatra

Sinatra is a DSL for quickly creating web applications in Ruby with minimal
effort:

  # myapp.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

Install the gem and run with:

  gem install sinatra
  ruby -rubygems myapp.rb

View at: http://localhost:4567

It is recommended to also run <tt>gem install thin</tt>, which Sinatra will
pick up if available.

== Routes

In Sinatra, a route is an HTTP method paired with a URL-matching pattern.
Each route is associated with a block:

  get '/' do
    .. show something ..
  end

  post '/' do
    .. create something ..
  end

  put '/' do
    .. replace something ..
  end

  patch '/' do
    .. modify something ..
  end

  delete '/' do
    .. annihilate something ..
  end

  options '/' do
    .. appease something ..
  end

Routes are matched in the order they are defined. The first route that
matches the request is invoked.

Route patterns may include named parameters, accessible via the
<tt>params</tt> hash:

  get '/hello/:name' do
    # matches "GET /hello/foo" and "GET /hello/bar"
    # params[:name] is 'foo' or 'bar'
    "Hello #{params[:name]}!"
  end

You can also access named parameters via block parameters:

  get '/hello/:name' do |n|
    "Hello #{n}!"
  end

Route patterns may also include splat (or wildcard) parameters, accessible
via the <tt>params[:splat]</tt> array:

  get '/say/*/to/*' do
    # matches /say/hello/to/world
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    # matches /download/path/to/file.xml
    params[:splat] # => ["path/to/file", "xml"]
  end

Or with block parameters:

  get '/download/*.*' do |path, ext|
    [path, ext] # => ["path/to/file", "xml"]
  end

Route matching with Regular Expressions:

  get %r{/hello/([\w]+)} do
    "Hello, #{params[:captures].first}!"
  end

Or with a block parameter:

  get %r{/hello/([\w]+)} do |c|
    "Hello, #{c}!"
  end

Route patterns may have optional parameters:

  get '/posts.?:format?' do
    # matches "GET /posts" and any extension "GET /posts.json", "GET /posts.xml" etc.
  end

By the way, unless you disable the path traversal attack protection (see below),
the request path might be modified before matching against your routes.

=== Conditions

Routes may include a variety of matching conditions, such as the user agent:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "You're using Songbird version #{params[:agent][0]}"
  end

  get '/foo' do
    # Matches non-songbird browsers
  end

Other available conditions are +host_name+ and +provides+:

  get '/', :host_name => /^admin\./ do
    "Admin Area, Access denied!"
  end

  get '/', :provides => 'html' do
    haml :index
  end

  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

You can easily define your own conditions:

  set(:probability) { |value| condition { rand <= value } }

  get '/win_a_car', :probability => 0.1 do
    "You won!"
  end

  get '/win_a_car' do
    "Sorry, you lost."
  end

For a condition that takes multiple values use a splat:

  set(:auth) do |*roles|   # <- notice the splat here
    condition do
      unless logged_in? && roles.any? {|role| current_user.in_role? role }
        redirect "/login/", 303
      end
    end
  end

  get "/my/account/", :auth => [:user, :admin] do
    "Your Account Details"
  end

  get "/only/admin/", :auth => :admin do
    "Only admins are allowed here!"
  end

=== Return Values

The return value of a route block determines at least the response body passed
on to the HTTP client, or at least the next middleware in the Rack stack.
Most commonly, this is a string, as in the above examples. But other values are
also accepted.

You can return any object that would either be a valid Rack response, Rack
body object or HTTP status code:

* An Array with three elements: <tt>[status (Fixnum), headers (Hash), response
  body (responds to #each)]</tt>
* An Array with two elements: <tt>[status (Fixnum), response body (responds to
  #each)]</tt>
* An object that responds to <tt>#each</tt> and passes nothing but strings to
  the given block
* A Fixnum representing the status code

That way we can, for instance, easily implement a streaming example:

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

You can also use the +stream+ helper method (described below) to reduce boiler
plate and embed the streaming logic in the route.

=== Custom Route Matchers

As shown above, Sinatra ships with built-in support for using String patterns
and regular expressions as route matches. However, it does not stop there. You
can easily define your own matchers:

  class AllButPattern
    Match = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Match.new([])
    end

    def match(str)
      @captures unless @except === str
    end
  end

  def all_but(pattern)
    AllButPattern.new(pattern)
  end

  get all_but("/index") do
    # ...
  end

Note that the above example might be over-engineered, as it can also be
expressed as:

  get // do
    pass if request.path_info == "/index"
    # ...
  end

Or, using negative look ahead:

  get %r{^(?!/index$)} do
    # ...
  end

== Static Files

Static files are served from the <tt>./public</tt> directory. You can specify
a different location by setting the <tt>:public_folder</tt> option:

  set :public_folder, File.dirname(__FILE__) + '/static'

Note that the public directory name is not included in the URL. A file
<tt>./public/css/style.css</tt> is made available as
<tt>http://example.com/css/style.css</tt>.

Use the <tt>:static_cache_control</tt> setting (see below) to add
<tt>Cache-Control</tt> header info.

== Views / Templates

Each template language is exposed via its own rendering method. These
methods simply return a string:

  get '/' do
    erb :index
  end

This renders <tt>views/index.erb</tt>.

Instead of a template name, you can also just pass in the template content
directly:

  get '/' do
    code = "<%= Time.now %>"
    erb code
  end

Templates take a second argument, the options hash:

  get '/' do
    erb :index, :layout => :post
  end

This will render <tt>views/index.erb</tt> embedded in the
<tt>views/post.erb</tt> (default is <tt>views/layout.erb</tt>, if it exists).

Any options not understood by Sinatra will be passed on to the template
engine:

  get '/' do
    haml :index, :format => :html5
  end

You can also set options per template language in general:

  set :haml, :format => :html5

  get '/' do
    haml :index
  end

Options passed to the render method override options set via +set+.

Available Options:

[locals]
  List of locals passed to the document. Handy with partials.
  Example: <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>

[default_encoding]
  String encoding to use if uncertain. Defaults to
  <tt>settings.default_encoding</tt>.

[views]
  Views folder to load templates from. Defaults to <tt>settings.views</tt>.

[layout]
  Whether to use a layout (+true+ or +false+), if it's a Symbol, specifies
  what template to use. Example: <tt>erb :index, :layout => !request.xhr?</tt>

[content_type]
  Content-Type the template produces, default depends on template language.

[scope]
  Scope to render template under. Defaults to the application instance. If you
  change this, instance variables and helper methods will not be available.

[layout_engine]
  Template engine to use for rendering the layout. Useful for languages that
  do not support layouts otherwise. Defaults to the engine used for the
  template. Example: <tt>set :rdoc, :layout_engine => :erb</tt>

Templates are assumed to be located directly under the <tt>./views</tt>
directory. To use a different views directory:

  set :views, settings.root + '/templates'

One important thing to remember is that you always have to reference
templates with symbols, even if they're in a subdirectory (in this
case, use <tt>:'subdir/template'</tt>). You must use a symbol because
otherwise rendering methods will render any strings passed to them
directly.

=== Available Template Languages

Some languages have multiple implementations. To specify what implementation
to use (and to be thread-safe), you should simply require it first:

  require 'rdiscount' # or require 'bluecloth'
  get('/') { markdown :index }

=== Haml Templates

Dependency::        {haml}[http://haml.info/]
File Extensions::   <tt>.haml</tt>
Example::           <tt>haml :index, :format => :html5</tt>

=== Erb Templates

Dependency::        {erubis}[http://www.kuwata-lab.com/erubis/] or
                    erb (included in Ruby)
File Extensions::   <tt>.erb</tt>, <tt>.rhtml</tt> or <tt>.erubis</tt> (Erubis
                    only)
Example::           <tt>erb :index</tt>

=== Builder Templates

Dependency::        {builder}[http://builder.rubyforge.org/]
File Extensions::   <tt>.builder</tt>
Example::           <tt>builder { |xml| xml.em "hi" }</tt>

It also takes a block for inline templates (see example).

=== Nokogiri Templates

Dependency::        {nokogiri}[http://nokogiri.org/]
File Extensions::   <tt>.nokogiri</tt>
Example::           <tt>nokogiri { |xml| xml.em "hi" }</tt>

It also takes a block for inline templates (see example).

=== Sass Templates

Dependency::        {sass}[http://sass-lang.com/]
File Extensions::   <tt>.sass</tt>
Example::           <tt>sass :stylesheet, :style => :expanded</tt>

=== SCSS Templates

Dependency::        {sass}[http://sass-lang.com/]
File Extensions::   <tt>.scss</tt>
Example::           <tt>scss :stylesheet, :style => :expanded</tt>

=== Less Templates

Dependency::        {less}[http://www.lesscss.org/]
File Extensions::   <tt>.less</tt>
Example::           <tt>less :stylesheet</tt>

=== Liquid Templates

Dependency::        {liquid}[http://www.liquidmarkup.org/]
File Extensions::   <tt>.liquid</tt>
Example::           <tt>liquid :index, :locals => { :key => 'value' }</tt>

Since you cannot call Ruby methods (except for +yield+) from a Liquid
template, you almost always want to pass locals to it.

=== Markdown Templates

Dependency::        {rdiscount}[https://github.com/rtomayko/rdiscount],
                    {redcarpet}[https://github.com/tanoku/redcarpet],
                    {bluecloth}[http://deveiate.org/projects/BlueCloth],
                    {kramdown}[http://kramdown.rubyforge.org/] *or*
                    {maruku}[http://maruku.rubyforge.org/]
File Extensions::   <tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt>
Example::           <tt>markdown :index, :layout_engine => :erb</tt>

It is not possible to call methods from markdown, nor to pass locals to it.
You therefore will usually use it in combination with another rendering
engine:

  erb :overview, :locals => { :text => markdown(:introduction) }

Note that you may also call the +markdown+ method from within other templates:

  %h1 Hello From Haml!
  %p= markdown(:greetings)

Since you cannot call Ruby from Markdown, you cannot use layouts written in
Markdown. However, it is possible to use another rendering engine for the
template than for the layout by passing the <tt>:layout_engine</tt> option.

=== Textile Templates

Dependency::        {RedCloth}[http://redcloth.org/]
File Extensions::   <tt>.textile</tt>
Example::           <tt>textile :index, :layout_engine => :erb</tt>

It is not possible to call methods from textile, nor to pass locals to it. You
therefore will usually use it in combination with another rendering engine:

  erb :overview, :locals => { :text => textile(:introduction) }

Note that you may also call the +textile+ method from within other templates:

  %h1 Hello From Haml!
  %p= textile(:greetings)

Since you cannot call Ruby from Textile, you cannot use layouts written in
Textile. However, it is possible to use another rendering engine for the
template than for the layout by passing the <tt>:layout_engine</tt> option.

=== RDoc Templates

Dependency::        {rdoc}[http://rdoc.rubyforge.org/]
File Extensions::   <tt>.rdoc</tt>
Example::           <tt>rdoc :README, :layout_engine => :erb</tt>

It is not possible to call methods from rdoc, nor to pass locals to it. You
therefore will usually use it in combination with another rendering engine:

  erb :overview, :locals => { :text => rdoc(:introduction) }

Note that you may also call the +rdoc+ method from within other templates:

  %h1 Hello From Haml!
  %p= rdoc(:greetings)

Since you cannot call Ruby from RDoc, you cannot use layouts written in
RDoc. However, it is possible to use another rendering engine for the
template than for the layout by passing the <tt>:layout_engine</tt> option.

=== Radius Templates

Dependency::        {radius}[http://radius.rubyforge.org/]
File Extensions::   <tt>.radius</tt>
Example::           <tt>radius :index, :locals => { :key => 'value' }</tt>

Since you cannot call Ruby methods directly from a Radius template, you almost
always want to pass locals to it.

=== Markaby Templates

Dependency::        {markaby}[http://markaby.github.com/]
File Extensions::   <tt>.mab</tt>
Example::           <tt>markaby { h1 "Welcome!" }</tt>

It also takes a block for inline templates (see example).

=== Slim Templates

Dependency::        {slim}[http://slim-lang.com/]
File Extensions::   <tt>.slim</tt>
Example::           <tt>slim :index</tt>

=== Creole Templates

Dependency::        {creole}[https://github.com/minad/creole]
File Extensions::   <tt>.creole</tt>
Example::           <tt>creole :wiki, :layout_engine => :erb</tt>

It is not possible to call methods from creole, nor to pass locals to it. You
therefore will usually use it in combination with another rendering engine:

  erb :overview, :locals => { :text => creole(:introduction) }

Note that you may also call the +creole+ method from within other templates:

  %h1 Hello From Haml!
  %p= creole(:greetings)

Since you cannot call Ruby from Creole, you cannot use layouts written in
Creole. However, it is possible to use another rendering engine for the
template than for the layout by passing the <tt>:layout_engine</tt> option.

=== CoffeeScript Templates

Dependency::        {coffee-script}[https://github.com/josh/ruby-coffee-script]
                    and a {way to execute javascript}[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
File Extensions::   <tt>.coffee</tt>
Example::           <tt>coffee :index</tt>

=== Embedded Templates

  get '/' do
    haml '%div.title Hello World'
  end

Renders the embedded template string.

=== Accessing Variables in Templates

Templates are evaluated within the same context as route handlers. Instance
variables set in route handlers are directly accessible by templates:

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end

Or, specify an explicit Hash of local variables:

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= bar.name', :locals => { :bar => foo }
  end

This is typically used when rendering templates as partials from within
other templates.

=== Inline Templates

Templates may be defined at the end of the source file:

  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hello world.

NOTE: Inline templates defined in the source file that requires sinatra are
automatically loaded. Call <tt>enable :inline_templates</tt> explicitly if you
have inline templates in other source files.

=== Named Templates

Templates may also be defined using the top-level <tt>template</tt> method:

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hello World!'
  end

  get '/' do
    haml :index
  end

If a template named "layout" exists, it will be used each time a template
is rendered. You can individually disable layouts by passing
<tt>:layout => false</tt> or disable them by default via
<tt>set :haml, :layout => false</tt>:

  get '/' do
    haml :index, :layout => !request.xhr?
  end

=== Associating File Extensions

To associate a file extension with a template engine, use
<tt>Tilt.register</tt>. For instance, if you like to use the file extension
+tt+ for Textile templates, you can do the following:

  Tilt.register :tt, Tilt[:textile]

=== Adding Your Own Template Engine

First, register your engine with Tilt, then create a rendering method:

  Tilt.register :myat, MyAwesomeTemplateEngine

  helpers do
    def myat(*args) render(:myat, *args) end
  end

  get '/' do
    myat :index
  end

Renders <tt>./views/index.myat</tt>. See https://github.com/rtomayko/tilt to
learn more about Tilt.

== Filters

Before filters are evaluated before each request within the same
context as the routes will be and can modify the request and response. Instance
variables set in filters are accessible by routes and templates:

  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end

After filters are evaluated after each request within the same context and can
also modify the request and response. Instance variables set in before filters
and routes are accessible by after filters:

  after do
    puts response.status
  end

Note: Unless you use the +body+ method rather than just returning a String from
the routes, the body will not yet be available in the after filter, since it is
generated later on.

Filters optionally take a pattern, causing them to be evaluated only if the
request path matches that pattern:

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

Like routes, filters also take conditions:

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== Helpers

Use the top-level <tt>helpers</tt> method to define helper methods for use in
route handlers and templates:

  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

Alternatively, helper methods can be separately defined in a module:

  module FooUtils
    def foo(name) "#{name}foo" end
  end

  module BarUtils
    def bar(name) "#{name}bar" end
  end

  helpers FooUtils, BarUtils

The effect is the same as including the modules in the application class.

=== Using Sessions

A session is used to keep state during requests. If activated, you have one
session hash per user session:

  enable :sessions

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

Note that <tt>enable :sessions</tt> actually stores all data in a cookie. This
might not always be what you want (storing lots of data will increase your
traffic, for instance). You can use any Rack session middleware: in order to
do so, do *not* call <tt>enable :sessions</tt>, but instead pull in your
middleware of choice as you would any other middleware:

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

To improve security, the session data in the cookie is signed with a session
secret. A random secret is generated for you by Sinatra. However, since this
secret will change with every start of your application, you might want to
set the secret yourself, so all your application instances share it:

  set :session_secret, 'super secret'

If you want to configure it further, you may also store a hash with options in
the +sessions+ setting:

  set :sessions, :domain => 'foo.com'

=== Halting

To immediately stop a request within a filter or route use:

  halt

You can also specify the status when halting:

  halt 410

Or the body:

  halt 'this will be the body'

Or both:

  halt 401, 'go away!'

With headers:

  halt 402, {'Content-Type' => 'text/plain'}, 'revenge'

It is of course possible to combine a template with +halt+:

  halt erb(:error)

=== Passing

A route can punt processing to the next matching route using <tt>pass</tt>:

  get '/guess/:who' do
    pass unless params[:who] == 'Frank'
    'You got me!'
  end

  get '/guess/*' do
    'You missed!'
  end

The route block is immediately exited and control continues with the next
matching route. If no matching route is found, a 404 is returned.

=== Triggering Another Route

Sometimes +pass+ is not what you want, instead you would like to get the result
of calling another route. Simply use +call+ to achieve this:

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

Note that in the example above, you would ease testing and increase performance
by simply moving <tt>"bar"</tt> into a helper used by both <tt>/foo</tt>
and <tt>/bar</tt>.

If you want the request to be sent to the same application instance rather than
a duplicate, use <tt>call!</tt> instead of <tt>call</tt>.

Check out the Rack specification if you want to learn more about <tt>call</tt>.

=== Setting Body, Status Code and Headers

It is possible and recommended to set the status code and response body with the
return value of the route block. However, in some scenarios you might want to
set the body at an arbitrary point in the execution flow. You can do so with the
+body+ helper method. If you do so, you can use that method from there on to
access the body:

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

It is also possible to pass a block to +body+, which will be executed by the
Rack handler (this can be used to implement streaming, see "Return Values").

Similar to the body, you can also set the status code and headers:

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "I'm a tea pot!"
  end

Like +body+, +headers+ and +status+ with no arguments can be used to access
their current values.

=== Streaming Responses

Sometimes you want to start sending out data while still generating parts of
the response body. In extreme examples, you want to keep sending data until
the client closes the connection. You can use the +stream+ helper to avoid
creating your own wrapper:

  get '/' do
    stream do |out|
      out << "It's gonna be legen -\n"
      sleep 0.5
      out << " (wait for it) \n"
      sleep 1
      out << "- dary!\n"
    end
  end

This allows you to implement streaming APIs,
{Server Sent Events}[http://dev.w3.org/html5/eventsource/] and can be used as
the basis for {WebSockets}[http://en.wikipedia.org/wiki/WebSocket]. It can also be
used to increase throughput if some but not all content depends on a slow
resource.

Note that the streaming behavior, especially the number of concurrent requests,
highly depends on the web server used to serve the application. Some servers,
like WEBRick, might not even support streaming at all. If the server does not
support streaming, the body will be sent all at once after the block passed to
+stream+ finishes executing. Streaming does not work at all with Shotgun.

If the optional parameter is set to +keep_open+, it will not call +close+ on
the stream object, allowing you to close it at any later point in the
execution flow. This only works on evented servers, like Thin and Rainbows.
Other servers will still close the stream:

  # long polling

  set :server, :thin
  connections = []

  get '/subscribe' do
    # register a client's interest in server events
    stream(:keep_open) { |out| connections << out }

    # purge dead connections
    connections.reject!(&:closed?)

    # acknowledge
    "subscribed"
  end

  post '/message' do
    connections.each do |out|
      # notify client that a new message has arrived
      out << message << "\n"

      #indicate client to connect again
      out.close
    end

    # acknowledge
    "message received"
  end

=== Logging

In the request scope, the +logger+ helper exposes a +Logger+ instance:

  get '/' do
    logger.info "loading data"
    # ...
  end

This logger will automatically take your Rack handler's logging settings into
account. If logging is disabled, this method will return a dummy object, so
you do not have to worry in your routes and filters about it.

Note that logging is only enabled for <tt>Sinatra::Application</tt> by
default, so if you inherit from <tt>Sinatra::Base</tt>, you probably want to
enable it yourself:

  class MyApp < Sinatra::Base
    configure :production, :development do
      enable :logging
    end
  end

To avoid any logging middleware to be set up, set the +logging+ setting to
+nil+. However, keep in mind that +logger+ will in that case return +nil+. A
common use case is when you want to set your own logger. Sinatra will use
whatever it will find in <tt>env['rack.logger']</tt>.

=== Mime Types

When using <tt>send_file</tt> or static files you may have mime types Sinatra
doesn't understand. Use +mime_type+ to register them by file extension:

  configure do
    mime_type :foo, 'text/foo'
  end

You can also use it with the +content_type+ helper:

  get '/' do
    content_type :foo
    "foo foo foo"
  end

=== Generating URLs

For generating URLs you should use the +url+ helper method, for instance, in
Haml:

  %a{:href => url('/foo')} foo

It takes reverse proxies and Rack routers into account, if present.

This method is also aliased to +to+ (see below for an example).

=== Browser Redirect

You can trigger a browser redirect with the +redirect+ helper method:

  get '/foo' do
    redirect to('/bar')
  end

Any additional parameters are handled like arguments passed to +halt+:

  redirect to('/bar'), 303
  redirect 'http://google.com', 'wrong place, buddy'

You can also easily redirect back to the page the user came from with
<tt>redirect back</tt>:

  get '/foo' do
    "<a href='/bar'>do something</a>"
  end

  get '/bar' do
    do_something
    redirect back
  end

To pass arguments with a redirect, either add them to the query:

  redirect to('/bar?sum=42')

Or use a session:

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end

=== Cache Control

Setting your headers correctly is the foundation for proper HTTP caching.

You can easily set the Cache-Control header with like this:

  get '/' do
    cache_control :public
    "cache it!"
  end

Pro tip: Set up caching in a before filter:

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

If you are using the +expires+ helper to set the corresponding header,
<tt>Cache-Control</tt> will be set automatically for you:

  before do
    expires 500, :public, :must_revalidate
  end

To properly use caches, you should consider using +etag+ or +last_modified+.
It is recommended to call those helpers *before* doing heavy lifting, as they
will immediately flush a response if the client already has the current
version in its cache:

  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end

It is also possible to use a
{weak ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation]:

  etag @article.sha1, :weak

These helpers will not do any caching for you, but rather feed the necessary
information to your cache. If you are looking for a quick reverse-proxy caching
solution, try {rack-cache}[http://rtomayko.github.com/rack-cache/]:

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

Use the <tt>:static_cache_control</tt> setting (see below) to add
<tt>Cache-Control</tt> header info to static files.

According to RFC 2616 your application should behave differently if the If-Match
or If-None-Match header is set to <tt>*</tt> depending on whether the resource
requested is already in existence. Sinatra assumes resources for safe (like get)
and idempotent (like put) requests are already in existence, whereas other
resources (for instance for post requests), are treated as new resources. You
can change this behavior by passing in a <tt>:new_resource</tt> option:

  get '/create' do
    etag '', :new_resource => true
    Article.create
    erb :new_article
  end

If you still want to use a weak ETag, pass in a <tt>:kind</tt> option:

  etag '', :new_resource => true, :kind => :weak

=== Sending Files

For sending files, you can use the <tt>send_file</tt> helper method:

  get '/' do
    send_file 'foo.png'
  end

It also takes a couple of options:

  send_file 'foo.png', :type => :jpg

The options are:

[filename]
  file name, in response, defaults to the real file name.

[last_modified]
  value for Last-Modified header, defaults to the file's mtime.

[type]
  content type to use, guessed from the file extension if missing.

[disposition]
  used for Content-Disposition, possible values: +nil+ (default),
  <tt>:attachment</tt> and <tt>:inline</tt>

[length]
  Content-Length header, defaults to file size.

If supported by the Rack handler, other means than streaming from the Ruby
process will be used. If you use this helper method, Sinatra will automatically
handle range requests.

=== Accessing the Request Object

The incoming request object can be accessed from request level (filter, routes,
error handlers) through the <tt>request</tt> method:

  # app running on http://example.com/example
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                # request body sent by the client (see below)
    request.scheme              # "http"
    request.script_name         # "/example"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      # length of request.body
    request.media_type          # media type of request.body
    request.host                # "example.com"
    request.get?                # true (similar methods for other verbs)
    request.form_data?          # false
    request["some_param"]       # value of some_param parameter. [] is a shortcut to the params hash.
    request.referrer            # the referrer of the client or '/'
    request.user_agent          # user agent (used by :agent condition)
    request.cookies             # hash of browser cookies
    request.xhr?                # is this an ajax request?
    request.url                 # "http://example.com/example/foo"
    request.path                # "/example/foo"
    request.ip                  # client IP address
    request.secure?             # false (would be true over ssl)
    request.forwarded?          # true (if running behind a reverse proxy)
    request.env                 # raw env hash handed in by Rack
  end

Some options, like <tt>script_name</tt> or <tt>path_info</tt>, can also be
written:

  before { request.path_info = "/" }

  get "/" do
    "all requests end up here"
  end

The <tt>request.body</tt> is an IO or StringIO object:

  post "/api" do
    request.body.rewind  # in case someone already read it
    data = JSON.parse request.body.read
    "Hello #{data['name']}!"
  end

=== Attachments

You can use the +attachment+ helper to tell the browser the response should be
stored on disk rather than displayed in the browser:

  get '/' do
    attachment
    "store it!"
  end

You can also pass it a file name:

  get '/' do
    attachment "info.txt"
    "store it!"
  end

=== Dealing with Date and Time

Sinatra offers a +time_for+ helper method, which, from the given value
generates a Time object. It is also able to convert +DateTime+, +Date+ and
similar classes:

  get '/' do
    pass if Time.now > time_for('Dec 23, 2012')
    "still time"
  end

This method is used internally by +expires+, +last_modified+ and akin. You can
therefore easily extend the behavior of those methods by overriding +time_for+
in your application:

  helpers do
    def time_for(value)
      case value
      when :yesterday then Time.now - 24*60*60
      when :tomorrow  then Time.now + 24*60*60
      else super
      end
    end
  end

  get '/' do
    last_modified :yesterday
    expires :tomorrow
    "hello"
  end

=== Looking Up Template Files

The <tt>find_template</tt> helper is used to find template files for rendering:

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "could be #{file}"
  end

This is not really useful. But it is useful that you can actually override this
method to hook in your own lookup mechanism. For instance, if you want to be
able to use more than one view directory:

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

Another example would be using different directories for different engines:

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end

You can also easily wrap this up in an extension and share with others!

Note that <tt>find_template</tt> does not check if the file really exists but
rather calls the given block for all possible paths. This is not a performance
issue, since +render+ will use +break+ as soon as a file is found. Also,
template locations (and content) will be cached if you are not running in
development mode. You should keep that in mind if you write a really crazy
method.

== Configuration

Run once, at startup, in any environment:

  configure do
    # setting one option
    set :option, 'value'

    # setting multiple options
    set :a => 1, :b => 2

    # same as `set :option, true`
    enable :option

    # same as `set :option, false`
    disable :option

    # you can also have dynamic settings with blocks
    set(:css_dir) { File.join(views, 'css') }
  end

Run only when the environment (RACK_ENV environment variable) is set to
<tt>:production</tt>:

  configure :production do
    ...
  end

Run when the environment is set to either <tt>:production</tt> or
<tt>:test</tt>:

  configure :production, :test do
    ...
  end

You can access those options via <tt>settings</tt>:

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

=== Configuring attack protection

Sinatra is using
{Rack::Protection}[https://github.com/rkh/rack-protection#readme] to defend
your application against common, opportunistic attacks. You can easily disable
this behavior (which will open up your application to tons of common
vulnerabilities):

  disable :protection

To skip a single defense layer, set +protection+ to an options hash:

  set :protection, :except => :path_traversal

You can also hand in an array in order to disable a list of protections:

  set :protection, :except => [:path_traversal, :session_hijacking]

=== Available Settings

[absolute_redirects]   If disabled, Sinatra will allow relative redirects,
                       however, Sinatra will no longer conform with RFC 2616
                       (HTTP 1.1), which only allows absolute redirects.

                       Enable if your app is running behind a reverse proxy that
                       has not been set up properly. Note that the +url+ helper
                       will still produce absolute URLs, unless you pass in
                       +false+ as second parameter.

                       Disabled per default.

[add_charsets]         mime types the <tt>content_type</tt> helper will
                       automatically add the charset info to.

                       You should add to it rather than overriding this option:

                         settings.add_charsets << "application/foobar"

[app_file]             Path to the main application file, used to detect project
                       root, views and public folder and inline templates.

[bind]                 IP address to bind to (default: 0.0.0.0).
                       Only used for built-in server.

[default_encoding]     encoding to assume if unknown
                       (defaults to <tt>"utf-8"</tt>).

[dump_errors]          display errors in the log.

[environment]          current environment, defaults to <tt>ENV['RACK_ENV']</tt>,
                       or <tt>"development"</tt> if not available.

[logging]              use the logger.

[lock]                 Places a lock around every request, only running
                       processing on request per Ruby process concurrently.

                       Enabled if your app is not thread-safe.
                       Disabled per default.

[method_override]      use <tt>_method</tt> magic to allow put/delete forms in
                       browsers that don't support it.

[port]                 Port to listen on. Only used for built-in server.

[prefixed_redirects]   Whether or not to insert <tt>request.script_name</tt>
                       into redirects if no absolute path is given. That way
                       <tt>redirect '/foo'</tt> would behave like
                       <tt>redirect to('/foo')</tt>. Disabled per default.

[protection]           Whether or not to enable web attack protections. See
                       protection section above.

[public_folder]        Path to the folder public files are served from. Only
                       used if static file serving is enabled (see
                       <tt>static</tt> setting below). Inferred from
                       <tt>app_file</tt> setting if not set.

[reload_templates]     whether or not to reload templates between requests.
                       Enabled in development mode.

[root]                 Path to project root folder. Inferred from +app_file+
                       setting if not set.

[raise_errors]         raise exceptions (will stop application). Enabled
                       by default when <tt>environment</tt> is set to
                       <tt>"test"</tt>, disabled otherwise.

[run]                  if enabled, Sinatra will handle starting the web server,
                       do not enable if using rackup or other means.

[running]              is the built-in server running now?
                       do not change this setting!

[server]               server or list of servers to use for built-in server.
                       defaults to ['thin', 'mongrel', 'webrick'], order
                       indicates priority.

[sessions]             enable cookie based sessions support using
                       <tt>Rack::Session::Cookie</tt>. See 'Using Sessions'
                       section for more information.

[show_exceptions]      show a stack trace in the browser when an exception
                       happens. Enabled by default when <tt>environment</tt>
                       is set to <tt>"development"</tt>, disabled otherwise.
                       Can also be set to <tt>:after_handler</tt> to trigger
                       app-specified error handling before showing a stack
                       trace in the browser.

[static]               Whether Sinatra should handle serving static files.
                       Disable when using a Server able to do this on its own.
                       Disabling will boost performance.
                       Enabled per default in classic style, disabled for
                       modular apps.

[static_cache_control] When Sinatra is serving static files, set this to add
                       <tt>Cache-Control</tt> headers to the responses. Uses the
                       +cache_control+ helper. Disabled by default.
                       Use an explicit array when setting multiple values:
                       <tt>set :static_cache_control, [:public, :max_age => 300]</tt>

[threaded]             If set to +true+, will tell Thin to use
                       <tt>EventMachine.defer</tt> for processing the request.

[views]                Path to the views folder. Inferred from <tt>app_file</tt>
                       setting if not set.

== Environments

There are three predefined +environments+: <tt>"development"</tt>,
<tt>"production"</tt> and <tt>"test"</tt>. Environments can be set
through the +RACK_ENV+ environment variable. The default value is
<tt>"development"</tt>. In this mode, all templates are reloaded between
requests. Special <tt>not_found</tt> and <tt>error</tt> handlers are installed
for this environment so you will see a stack trace in your browser.
In <tt>"production"</tt> and <tt>"test"</tt> templates are cached by default.

To run different environments use the <tt>-e</tt> option:

  ruby my_app.rb -e [ENVIRONMENT]

You can use predefined methods: +development?+, +test?+ and +production?+ to
check which enviroment is currently set.

== Error Handling

Error handlers run within the same context as routes and before filters, which
means you get all the goodies it has to offer, like <tt>haml</tt>,
<tt>erb</tt>, <tt>halt</tt>, etc.

=== Not Found

When a <tt>Sinatra::NotFound</tt> exception is raised, or the response's status
code is 404, the <tt>not_found</tt> handler is invoked:

  not_found do
    'This is nowhere to be found.'
  end

=== Error

The +error+ handler is invoked any time an exception is raised from a route
block or a filter. The exception object can be obtained from the
<tt>sinatra.error</tt> Rack variable:

  error do
    'Sorry there was a nasty error - ' + env['sinatra.error'].name
  end

Custom errors:

  error MyCustomError do
    'So what happened was...' + env['sinatra.error'].message
  end

Then, if this happens:

  get '/' do
    raise MyCustomError, 'something bad'
  end

You get this:

  So what happened was... something bad

Alternatively, you can install an error handler for a status code:

  error 403 do
    'Access forbidden'
  end

  get '/secret' do
    403
  end

Or a range:

  error 400..510 do
    'Boom'
  end

Sinatra installs special <tt>not_found</tt> and <tt>error</tt> handlers when
running under the development environment.

== Rack Middleware

Sinatra rides on Rack[http://rack.rubyforge.org/], a minimal standard
interface for Ruby web frameworks. One of Rack's most interesting capabilities
for application developers is support for "middleware" -- components that sit
between the server and your application monitoring and/or manipulating the
HTTP request/response to provide various types of common functionality.

Sinatra makes building Rack middleware pipelines a cinch via a top-level
+use+ method:

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hello World'
  end

The semantics of +use+ are identical to those defined for the
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] DSL
(most frequently used from rackup files). For example, the +use+ method
accepts multiple/variable args as well as blocks:

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'secret'
  end

Rack is distributed with a variety of standard middleware for logging,
debugging, URL routing, authentication, and session handling. Sinatra uses
many of these components automatically based on configuration so you
typically don't have to +use+ them explicitly.

You can find useful middleware in
{rack}[https://github.com/rack/rack/tree/master/lib/rack],
{rack-contrib}[https://github.com/rack/rack-contrib#readme],
with {CodeRack}[http://coderack.org/] or in the
{Rack wiki}[https://github.com/rack/rack/wiki/List-of-Middleware].

== Testing

Sinatra tests can be written using any Rack-based testing library or framework.
{Rack::Test}[http://rdoc.info/github/brynary/rack-test/master/frames]
is recommended:

  require 'my_sinatra_app'
  require 'test/unit'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hello World!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hello Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "You're using Songbird!", last_response.body
    end
  end

== Sinatra::Base - Middleware, Libraries, and Modular Apps

Defining your app at the top-level works well for micro-apps but has
considerable drawbacks when building reusable components such as Rack
middleware, Rails metal, simple libraries with a server component, or
even Sinatra extensions. The top-level DSL pollutes the Object namespace
and assumes a micro-app style configuration (e.g., a single application
file, <tt>./public</tt> and <tt>./views</tt> directories, logging, exception
detail page, etc.). That's where <tt>Sinatra::Base</tt> comes into play:

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hello world!'
    end
  end

The methods available to <tt>Sinatra::Base</tt> subclasses are exactly as those
available via the top-level DSL. Most top-level apps can be converted to
<tt>Sinatra::Base</tt> components with two modifications:

* Your file should require <tt>sinatra/base</tt> instead of +sinatra+;
  otherwise, all of Sinatra's DSL methods are imported into the main
  namespace.
* Put your app's routes, error handlers, filters, and options in a subclass
  of <tt>Sinatra::Base</tt>.

<tt>Sinatra::Base</tt> is a blank slate. Most options are disabled by default,
including the built-in server. See
{Options and Configuration}[http://sinatra.github.com/configuration.html]
for details on available options and their behavior.

=== Modular vs. Classic Style

Contrary to common belief, there is nothing wrong with classic style. If it
suits your application, you do not have to switch to a modular application.

There are only two downsides compared with modular style:

* You may only have one Sinatra application per Ruby process. If you plan to
  use more, switch to modular style.

* Classic style pollutes Object with delegator methods. If you plan to ship
  your application in a library/gem, switch to modular style.

There is no reason you cannot mix modular and classic style.

If switching from one style to the other, you should be aware of slightly
different default settings:

  Setting             Classic                 Modular

  app_file            file loading sinatra    file subclassing Sinatra::Base
  run                 $0 == app_file          false
  logging             true                    false
  method_override     true                    false
  inline_templates    true                    false
  static              true                    false


=== Serving a Modular Application

There are two common options for starting a modular app, actively starting with
<tt>run!</tt>:

  # my_app.rb
  require 'sinatra/base'

  class MyApp < Sinatra::Base
    # ... app code here ...

    # start the server if ruby file executed directly
    run! if app_file == $0
  end

Start with:

  ruby my_app.rb

Or with a <tt>config.ru</tt>, which allows using any Rack handler:

  # config.ru (run with rackup)
  require './my_app'
  run MyApp

Run:

  rackup -p 4567

=== Using a Classic Style Application with a config.ru

Write your app file:

  # app.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

And a corresponding <tt>config.ru</tt>:

  require './app'
  run Sinatra::Application

=== When to use a config.ru?

Good signs you probably want to use a <tt>config.ru</tt>:

* You want to deploy with a different Rack handler (Passenger, Unicorn,
  Heroku, ...).
* You want to use more than one subclass of <tt>Sinatra::Base</tt>.
* You want to use Sinatra only for middleware, but not as endpoint.

<b>There is no need to switch to a <tt>config.ru</tt> only because you
switched to modular style, and you don't have to use modular style for running
with a <tt>config.ru</tt>.</b>

=== Using Sinatra as Middleware

Not only is Sinatra able to use other Rack middleware, any Sinatra application
can in turn be added in front of any Rack endpoint as middleware itself. This
endpoint could be another Sinatra application, or any other Rack-based
application (Rails/Ramaze/Camping/...):

  require 'sinatra/base'

  class LoginScreen < Sinatra::Base
    enable :sessions

    get('/login') { haml :login }

    post('/login') do
      if params[:name] == 'admin' && params[:password] == 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end

  class MyApp < Sinatra::Base
    # middleware will run before filters
    use LoginScreen

    before do
      unless session['user_name']
        halt "Access denied, please <a href='/login'>login</a>."
      end
    end

    get('/') { "Hello #{session['user_name']}." }
  end

=== Dynamic Application Creation

Sometimes you want to create new applications at runtime without having to
assign them to a constant, you can do this with <tt>Sinatra.new</tt>:

  require 'sinatra/base'
  my_app = Sinatra.new { get('/') { "hi" } }
  my_app.run!

It takes the application to inherit from as optional argument:

  # config.ru (run with rackup)
  require 'sinatra/base'

  controller = Sinatra.new do
    enable :logging
    helpers MyHelpers
  end

  map('/a') do
    run Sinatra.new(controller) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controller) { get('/') { 'b' } }
  end

This is especially useful for testing Sinatra extensions or using Sinatra in
your own library.

This also makes using Sinatra as middleware extremely easy:

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run RailsProject::Application

== Scopes and Binding

The scope you are currently in determines what methods and variables are
available.

=== Application/Class Scope

Every Sinatra application corresponds to a subclass of <tt>Sinatra::Base</tt>.
If you are using the top-level DSL (<tt>require 'sinatra'</tt>), then this
class is <tt>Sinatra::Application</tt>, otherwise it is the subclass you
created explicitly. At class level you have methods like +get+ or +before+, but
you cannot access the +request+ object or the +session+, as there only is a
single application class for all requests.

Options created via +set+ are methods at class level:

    class MyApp < Sinatra::Base
      # Hey, I'm in the application scope!
      set :foo, 42
      foo # => 42

      get '/foo' do
        # Hey, I'm no longer in the application scope!
      end
    end

You have the application scope binding inside:

* Your application class body
* Methods defined by extensions
* The block passed to +helpers+
* Procs/blocks used as value for +set+
* The block passed to <tt>Sinatra.new</tt>

You can reach the scope object (the class) like this:

* Via the object passed to configure blocks (<tt>configure { |c| ... }</tt>)
* +settings+ from within request scope

=== Request/Instance Scope

For every incoming request, a new instance of your application class is
created and all handler blocks run in that scope. From within this scope you
can access the +request+ and +session+ object or call rendering methods like
+erb+ or +haml+. You can access the application scope from within the request
scope via the +settings+ helper:

  class MyApp < Sinatra::Base
    # Hey, I'm in the application scope!
    get '/define_route/:name' do
      # Request scope for '/define_route/:name'
      @value = 42

      settings.get("/#{params[:name]}") do
        # Request scope for "/#{params[:name]}"
        @value # => nil (not the same request)
      end

      "Route defined!"
    end
  end

You have the request scope binding inside:

* get/head/post/put/delete/options blocks
* before/after filters
* helper methods
* templates/views

=== Delegation Scope

The delegation scope just forwards methods to the class scope. However, it
does not behave 100% like the class scope, as you do not have the class
binding. Only methods explicitly marked for delegation are available and you
do not share variables/state with the class scope (read: you have a different
+self+). You can explicitly add method delegations by calling
<tt>Sinatra::Delegator.delegate :method_name</tt>.

You have the delegate scope binding inside:

* The top level binding, if you did <tt>require "sinatra"</tt>
* An object extended with the <tt>Sinatra::Delegator</tt> mixin

Have a look at the code for yourself: here's the
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
being {included into the main namespace}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28].

== Command Line

Sinatra applications can be run directly:

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]

Options are:

  -h # help
  -p # set the port (default is 4567)
  -o # set the host (default is 0.0.0.0)
  -e # set the environment (default is development)
  -s # specify rack server/handler (default is thin)
  -x # turn on the mutex lock (default is off)

== Requirement

The following Ruby versions are officially supported:

[ Ruby 1.8.7 ]
  1.8.7 is fully supported, however, if nothing is keeping you from it, we
  recommend upgrading to 1.9.2 or switching to JRuby or Rubinius. Support for
  1.8.7 will not be dropped before Sinatra 2.0 and Ruby 2.0 except maybe for
  the unlikely event of 1.8.8 being released. Even then, we might continue
  supporting it. <b>Ruby 1.8.6 is no longer supported.</b> If you want to run
  with 1.8.6, downgrade to Sinatra 1.2, which will receive bug fixes until
  Sinatra 1.4.0 is released.

[ Ruby 1.9.2 ]
  1.9.2 is fully supported and recommended. Do not use 1.9.2p0, it is known to
  cause segmentation faults when running Sinatra. Support will continue at least
  until the release of Ruby 1.9.4/2.0 and support for the latest 1.9 release
  will continue as long as it is still supported by the Ruby core team.

[ Ruby 1.9.3 ]
  1.9.3 is fully supported and recommended. Please note that switching to 1.9.3
  from an earlier version will invalidate all sessions.

[ Rubinius ]
  Rubinius is officially supported (Rubinius >= 1.2.4), everything, including
  all template languages, works. The upcoming 2.0 release is supported as
  well, including 1.9 mode.

[ JRuby ]
  JRuby is officially supported (JRuby >= 1.6.7). No issues with third party
  template libraries are known, however, if you choose to use JRuby, please
  look into JRuby rack handlers, as the Thin web server is not fully supported
  on JRuby. JRuby's support for C extensions is still experimental, which only
  affects RDiscount, Redcarpet, RedCloth and Yajl templates as well as Thin
  and Mongrel at the moment.

We also keep an eye on upcoming Ruby versions.

The following Ruby implementations are not officially supported but still are
known to run Sinatra:

* Older versions of JRuby and Rubinius
* Ruby Enterprise Edition
* MacRuby, Maglev, IronRuby
* Ruby 1.9.0 and 1.9.1 (but we do recommend against using those)

Not being officially supported means if things only break there and not on a
supported platform, we assume it's not our issue but theirs.

We also run our CI against ruby-head (the upcoming 2.0.0) and the 1.9.4
branch, but we can't guarantee anything, since it is constantly moving. Expect
both 1.9.4p0 and 2.0.0p0 to be supported.

Sinatra should work on any operating system supported by the chosen Ruby
implementation.

You will not be able to run Sinatra on Cardinal, SmallRuby, BlueRuby or any
Ruby version prior to 1.8.7 as of the time being.

== The Bleeding Edge

If you would like to use Sinatra's latest bleeding code, feel free to run your
application against the master branch, it should be rather stable.

We also push out prerelease gems from time to time, so you can do a

  gem install sinatra --pre

To get some of the latest features.

=== With Bundler

If you want to run your application with the latest Sinatra, using
{Bundler}[http://gembundler.com/] is the recommended way.

First, install bundler, if you haven't:

  gem install bundler

Then, in your project directory, create a +Gemfile+:

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  # other dependencies
  gem 'haml'                    # for instance, if you use haml
  gem 'activerecord', '~> 3.0'  # maybe you also need ActiveRecord 3.x

Note that you will have to list all your applications dependencies in there.
Sinatra's direct dependencies (Rack and Tilt) will, however, be automatically
fetched and added by Bundler.

Now you can run your app like this:

  bundle exec ruby myapp.rb

=== Roll Your Own

Create a local clone and run your app with the <tt>sinatra/lib</tt> directory
on the <tt>$LOAD_PATH</tt>:

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

To update the Sinatra sources in the future:

  cd myapp/sinatra
  git pull

=== Install Globally

You can build the gem on your own:

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

If you install gems as root, the last step should be

  sudo rake install

== Versioning

Sinatra follows {Semantic Versioning}[http://semver.org/], both SemVer and
SemVerTag.

== Further Reading

* {Project Website}[http://www.sinatrarb.com/] - Additional documentation,
  news, and links to other resources.
* {Contributing}[http://www.sinatrarb.com/contributing] - Find a bug? Need
  help? Have a patch?
* {Issue tracker}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {Mailing List}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] on http://freenode.net
* {Sinatra Book}[http://sinatra-book.gittr.com] Cookbook Tutorial
* {Sinatra Recipes}[http://recipes.sinatrarb.com/] Community
  contributed recipes
* API documentation for the {latest release}[http://rubydoc.info/gems/sinatra]
  or the {current HEAD}[http://rubydoc.info/github/sinatra/sinatra] on
  http://rubydoc.info
* {CI server}[http://ci.rkh.im/view/Sinatra/]

= Sinatra
<i>:          </i>

Sinatra   -  (DSL)     -  Ruby:

  # myapp.rb
  require 'sinatra'
  
  get '/' do
    'Hello world!'
  end

 gem:

  gem install sinatra

    :

  ruby -rubygems myapp.rb

  : http://localhost:4567

   thin,    : <tt>gem install thin</tt>.
Thin -           Sinatra.

== 

 Sinatra    : <HTTP >  < URL>.
     ,  , :

  get '/' do
    .. -  ..
  end

  post '/' do
    .. -  ..
  end

  put '/' do
    .. -  ..
  end

  patch '/' do
    .. -  ..
  end

  delete '/' do
    .. -  ..
  end

  options '/' do
    .. -  ..
  end

           .  
      .

        
<tt>params</tt> x:

  get '/hello/:name' do
    #  "GET /hello/foo"  "GET /hello/bar",
    #  params[:name] 'foo'  'bar'
    "Hello #{params[:name]}!"
  end

       :

  get '/hello/:name' do |n|
    "Hello #{n}!"
  end

     splat ( '*' ,   )  
  <tt>params[:splat]</tt>:

  get '/say/*/to/*' do
    #  /say/hello/to/world
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    #  /download/path/to/file.xml
    params[:splat] # => ["path/to/file", "xml"]
  end

   :

  get '/download/*.*' do |path, ext|
    [path, ext] # => ["path/to/file", "xml"]
  end

     :

  get %r{/hello/([\w]+)} do
    "Hello, #{params[:captures].first}!"
  end

   :

  get %r{/hello/([\w]+)} do |c|
    "Hello, #{c}!"
  end

=== 

     ,   user agent:

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "You're using Songbird version #{params[:agent][0]}"
  end

  get '/foo' do
    #  non-songbird 
  end

    +host_name+  +provides+:

  get '/', :host_name => /^admin\./ do
    "Admin Area, Access denied!"
  end

  get '/', :provides => 'html' do
    haml :index
  end
  
  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end

    :

  set(:probability) { |value| condition { rand <= value } }
  
  get '/win_a_car', :probability => 0.1 do
    "You won!"
  end
  
  get '/win_a_car' do
    "Sorry, you lost."
  end

===  

      ,    HTTP ,
  "" (middleware)  Rack .    ,    .
     .

    ,     Rack ,  Rack body,
   HTTP:

*    : <tt>[status (Fixnum), headers (Hash), response body (   #each)]</tt>;
*    : <tt>[status (Fixnum), response body (   #each)]</tt>;
* ,   <tt>#each</tt>,         ;
* Fixnum,    HTTP.

 ,      :

    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

===     

  , Sinatra      
     URL.      .  
      (matchers)  :

  class AllButPattern
    Match = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Match.new([])
    end

    def match(str)
      @captures unless @except === str
    end
  end

  def all_but(pattern)
    AllButPattern.new(pattern)
  end

  get all_but("/index") do
    # ...
  end

,      ,      :

  get // do
    pass if request.path_info == "/index"
    # ...
  end

     :

  get %r{^(?!/index$)} do
    # ...
  end

==  

    <tt>./public</tt> .     ,
    <tt>:public_folder</tt>:

  set :public_folder, File.dirname(__FILE__) + '/static'

,          URL. , 
<tt>./public/css/style.css</tt>   
<tt>http://example.com/css/style.css</tt>.

  <tt>:static_cache_control</tt> (. ), 
  <tt>Cache-Control</tt>.

==  / 

     .  
  :

  get '/' do
    erb :index
  end

 <tt>views/index.erb</tt>.

         
 

  get '/' do
    code = "<%= Time.now %>"
    erb code
  end

    ,   :

  get '/' do
    erb :index, :layout => :post
  end

 <tt>views/index.erb</tt>,  
<tt>views/post.erb</tt> ( : <tt>views/layout.erb</tt>,  ).

 ,   Sinatra,    

  get '/' do
    haml :index, :format => :html5
  end

        :

  set :haml, :format => :html5

  get '/' do
    haml :index
  end

,   ,  ,   
+set+.

 :

[locals]
    ,   .
  : <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>

[default_encoding]
  ,   ,    
  .  : <tt>settings.default_encoding</tt>.

[views]
    .  : <tt>settings.views</tt>.

[layout]
      (+true+  +false+).    Symbol,
   ,      . :
  <tt>erb :index, :layout => !request.xhr?</tt>

[content_type]
  Content-Type  .  :  .

[scope]
   ,    .  : 
  .     ,    
  -     .

[layout_engine]
  ,      . 
    ,      . 
  :   ,      .
  : <tt>set :rdoc, :layout_engine => :erb</tt>

  ,      <tt>./views</tt>.
     :

  set :views, settings.root + '/templates'

 :         
(Symbol),      (   
<tt>:'subdir/template'</tt>).    ,  
     ,  .

===  

     .  , 
 ,     
:

  require 'rdiscount' #  require 'bluecloth'
  get('/') { markdown :index }

=== Haml 

::         {haml}[http://haml.info/]
 ::   <tt>.haml</tt>
::              <tt>haml :index, :format => :html5</tt>

=== Erb 

::         {erubis}[http://www.kuwata-lab.com/erubis/]  erb (  Ruby)
 ::   <tt>.erb</tt>, <tt>.rhtml</tt> or <tt>.erubis</tt> ( Erubis)
::              <tt>erb :index</tt>

=== Builder 

::         {builder}[http://builder.rubyforge.org/]
 ::   <tt>.builder</tt>
::              <tt>builder { |xml| xml.em "hi" }</tt>

       (. ).

=== Nokogiri 

::         {nokogiri}[http://nokogiri.org/]
 ::   <tt>.nokogiri</tt>
::              <tt>nokogiri { |xml| xml.em "hi" }</tt>

       (. ).

=== Sass 

::         {sass}[http://sass-lang.com/]
 ::   <tt>.sass</tt>
::              <tt>sass :stylesheet, :style => :expanded</tt>

=== SCSS 

::         {sass}[http://sass-lang.com/]
 ::   <tt>.scss</tt>
::              <tt>scss :stylesheet, :style => :expanded</tt>

=== Less 

::         {less}[http://www.lesscss.org/]
 ::   <tt>.less</tt>
::              <tt>less :stylesheet</tt>

=== Liquid 

::         {liquid}[http://www.liquidmarkup.org/]
 ::   <tt>.liquid</tt>
::              <tt>liquid :index, :locals => { :key => 'value' }</tt>

   Liquid      Ruby ( yield), 
        .

=== Markdown 

::          {rdiscount}[https://github.com/rtomayko/rdiscount], {redcarpet}[https://github.com/tanoku/redcarpet], {bluecloth}[http://deveiate.org/projects/BlueCloth], {kramdown}[http://kramdown.rubyforge.org/]  {maruku}[http://maruku.rubyforge.org/]
 ::   <tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt>
::              <tt>markdown :index, :layout_engine => :erb</tt>

 Markdown       .
, ,  ,     
  :

  erb :overview, :locals => { :text => markdown(:introduction) }

,      +markdown+   :

  %h1 Hello From Haml!
  %p= markdown(:greetings)

    Ruby  Markdown, ,   
   Markdown.   ,   
    ,      
 <tt>:layout_engine</tt>.

=== Textile 

::         {RedCloth}[http://redcloth.org/]
 ::   <tt>.textile</tt>
::              <tt>textile :index, :layout_engine => :erb</tt>

 Textile       .
, ,  ,      
 :

  erb :overview, :locals => { :text => textile(:introduction) }

,      +textile+   :

  %h1 Hello From Haml!
  %p= textile(:greetings)

    Ruby  Textile, ,   
   Textile.   ,   
    ,      
 <tt>:layout_engine</tt>.

=== RDoc 

::         {rdoc}[http://rdoc.rubyforge.org/]
 ::   <tt>.rdoc</tt>
::              <tt>textile :README, :layout_engine => :erb</tt>

 RDoc       .
, ,  ,      
 :

  erb :overview, :locals => { :text => rdoc(:introduction) }

,      +rdoc+   :

  %h1 Hello From Haml!
  %p= rdoc(:greetings)

    Ruby  RDoc, ,   
   RDoc.   ,   
    ,      
 <tt>:layout_engine</tt>.

=== Radius 

::         {radius}[http://radius.rubyforge.org/]
 ::   <tt>.radius</tt>
::              <tt>radius :index, :locals => { :key => 'value' }</tt>

   Radius      Ruby , 
        .

=== Markaby 

::         {markaby}[http://markaby.github.com/]
 ::   <tt>.mab</tt>
::              <tt>markaby { h1 "Welcome!" }</tt>

       (. ).

=== Slim 

::         {slim}[http://slim-lang.com/]
 ::   <tt>.slim</tt>
::              <tt>slim :index</tt>

=== Creole 

::         {creole}[https://github.com/minad/creole]
 ::   <tt>.creole</tt>
::              <tt>creole :wiki, :layout_engine => :erb</tt>

 Creole       .
, ,  ,      
 :

  erb :overview, :locals => { :text => creole(:introduction) }

,      +creole+   :

  %h1 Hello From Haml!
  %p= creole(:greetings)

    Ruby  Creole, ,   
   Creole.   ,   
    ,      
 <tt>:layout_engine</tt>.

=== CoffeeScript 

::         {coffee-script}[https://github.com/josh/ruby-coffee-script]  {  javascript}[https://github.com/sstephenson/execjs/blob/master/README.md#readme]
 ::   <tt>.coffee</tt>
::              <tt>coffee :index</tt>

===  

  get '/' do
    haml '%div.title Hello World'
  end

  ,  .

===     

     ,    .  ,
    ,     :

  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end

      :

  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= bar.name', :locals => { :bar => foo }
  end

  ,       .

===  

        :

  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hello world!!!!!

:  ,    ,   Sinatra, 
 .  <tt>enable :inline_templates</tt> ,    
   .

===  

       <tt>template</tt> :

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hello World!'
  end

  get '/' do
    haml :index
  end

    "layout" ,      
 .          
<tt>:layout => false</tt>      , , :
<tt>set :haml, :layout => false</tt>:

  get '/' do
    haml :index, :layout => !request.xhr?
  end

===   

      , 
<tt>Tilt.register</tt>. ,      +tt+
  Textile:

  Tilt.register :tt, Tilt[:textile]

===    

     Tilt,   ,   :

  Tilt.register :myat, MyAwesomeTemplateEngine

  helpers do
    def myat(*args) render(:myat, *args) end
  end

  get '/' do
    myat :index
  end

 <tt>./views/index.myat</tt>.     Tilt,
 https://github.com/rtomayko/tilt

== 

+before+-        ,   .   
 ,     .  ,   ,     :

  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end

+after+-        ,   .   
 ,     .  ,   +before+-  ,
   +after+-:

  after do
    puts response.status
  end

:     +body+,      
,        +after+-,      .

    URL           :

  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

  ,    :

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== -

  <tt>helpers</tt>,   -, 
         :

  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

===  

 ,     .   
,           :

  enable :sessions

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

,    <tt>enable :sessions</tt>  
  cookies.      ,    (,
      ).    
   Rack "" (middleware), 
 .   * *  <tt>enable :sessions</tt>,
      ,     "":

  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

        
.    Sinatra.   ,   
      , , , 
  ,      
     :

  set :session_secret, 'super secret'

      ,    ,      +sessions+:

  set :sessions, :domain => 'foo.com'

=== 

        , :

  halt

     :

  halt 410

:

  halt 'this will be the body'

 ,  :

  halt 401, 'go away!'

  :

  halt 402, {'Content-Type' => 'text/plain'}, 'revenge'

, ,     +halt+:

  halt erb(:error)

=== 

       ,  <tt>pass</tt>:

  get '/guess/:who' do
    pass unless params[:who] == 'Frank'
    'You got me!'
  end

  get '/guess/*' do
    'You missed!'
  end

    ,       .
    ,      404.

===   

 +pass+  , ,     
   .      +call+:

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end

,         
,  <tt>"bar"</tt>  -, 
  <tt>/foo</tt>,   <tt>/bar</tt>.

  ,         ,  
  ,  <tt>call!</tt>  <tt>call</tt>.

     <tt>call</tt>,   Rack.

===  ,    

      HTTP     
  .   ,    , ,
        .  
    - +body+.     +body+,
       ,      .

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

      +body+,    
 Rack (       
, . " ").

        :

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "I'm a tea pot!"
  end

  +body+,  +headers+  +status+,   , 
  .

=== 

     +logger+     +Logger+:

  get '/' do
    logger.info "loading data"
    # ...
  end

        Rack. 
 ,      (dummy) ,   
      .

,        <tt>Sinatra::Application</tt>,
    --  <tt>Sinatra::Base</tt>,  , ,  
 :

  class MyApp < Sinatra::Base
    configure(:production, :development) do
      enable :logging
    end
  end

=== Mime-

   <tt>send_file</tt>   ,     mime-,  Sinatra
   .  +mime_type+      :

  configure do
    mime_type :foo, 'text/foo'
  end

      +content_type+ -:

  get '/' do
    content_type :foo
    "foo foo foo"
  end

===  URL

  URL     +url+, ,  Haml:

  %a{:href => url('/foo')} foo

       Rack,   .

  +url+    +to+ (  ).

===  ()

        +redirect+:

  get '/foo' do
    redirect to('/bar')
  end

         +halt+:

  redirect to('/bar'), 303
  redirect 'http://google.com', 'wrong place, buddy'

     ,      ,
  <tt>redirect back</tt>:

  get '/foo' do
    "<a href='/bar'>do something</a>"
  end

  get '/bar' do
    do_something
    redirect back
  end

  -    ,      :

  redirect to('/bar?sum=42')

  :

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end

===  

      HTTP .

     Cache-Control  :

  get '/' do
    cache_control :public
    "cache it!"
  end

:    +before+-:

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

    +expires+    ,
 <tt>Cache-Control</tt>   :

  before do
    expires 500, :public, :must_revalidate
  end

    ,     
+etag+  +last_modified+.    - **
  ,       ,
       :

  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end

   
{weak ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation]:

  etag @article.sha1, :weak

 -      ,   
    .      
,  {rack-cache}[http://rtomayko.github.com/rack-cache/]:

  require 'rack/cache'
  require 'sinatra'

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

  <tt>:static_cache_control</tt> (. ), 
  <tt>Cache-Control</tt>   .

===  

        <tt>send_file</tt>:

  get '/' do
    send_file 'foo.png'
  end

    :

  send_file 'foo.png', :type => :jpg

 :

[filename]
   ,  :   .

[last_modified]
     Last-Modified,  : mtime ( ) .

[type]
   ,  :    .

[disposition]
     Content-Disposition,  :
  +nil+ ( ), <tt>:attachment</tt>  <tt>:inline</tt>.

[length]
     Content-Length,  :  .


     Rack    ,  
,    ,      Ruby .
 <tt>send_file</tt>      (range)
   Sinatra.

===    

        ( , ,
 )   <tt>request</tt> :

  #    http://example.com/example
  get '/foo' do
    t = %w[text/css text/html application/javascript]
    request.accept              # ['text/html', '*/*']
    request.accept? 'text/xml'  # true
    request.preferred_type(t)   # 'text/html'
    request.body                #  ,   (. )
    request.scheme              # "http"
    request.script_name         # "/example"
    request.path_info           # "/foo"
    request.port                # 80
    request.request_method      # "GET"
    request.query_string        # ""
    request.content_length      #   
    request.media_type          #   
    request.host                # "example.com"
    request.get?                # true (     HTTP)
    request.form_data?          # false
    request["some_param"]       #   some_param.    params
    request.referrer            #     '/'
    request.user_agent          # user agent (  :agent )
    request.cookies             # ,  cookies 
    request.xhr?                #    ajax ?
    request.url                 # "http://example.com/example/foo"
    request.path                # "/example/foo"
    request.ip                  # IP- 
    request.secure?             # false (true,     SSL)
    request.forwarded?          # true (     )
    request.env                 # "" env ,  Rack
  end

 ,   <tt>script_name</tt>  <tt>path_info</tt>   :

  before { request.path_info = "/" }
  
  get "/" do
    "all requests end up here"
  end

<tt>request.body</tt>  IO  StringIO :

  post "/api" do
    request.body.rewind  #  ,  -    
    data = JSON.parse request.body.read
    "Hello #{data['name']}!"
  end

=== 

    +attachment+,   ,  
     ,   :

  get '/' do
    attachment
    "store it!"
  end

     :

  get '/' do
    attachment "info.txt"
    "store it!"
  end

===  

         <tt>find_template</tt>:

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "could be #{file}"
  end

    .    ,    
 ,      . ,  
,        :

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

 ,        :

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end

            !

,  <tt>find_template</tt>  ,      ,
       .     ,
  ,  +render+  +break+,      .
     ,    
   (set :environment, :development).      , 
  - "" .

== 

         ,  (environment):

  configure do
    #   
    set :option, 'value'

    #   
    set :a => 1, :b => 2

    #   ,   `set :option, true`
    enable :option

    #   ,   `set :option, false`
    disable :option

    #     ""   
    set(:css_dir) { File.join(views, 'css') }
  end

 ,   (RACK_ENV ) <tt>:production</tt>:

  configure :production do
    ...
  end

 ,   <tt>:production</tt>  <tt>:test</tt>:

  configure :production, :test do
    ...
  end

         <tt>settings</tt>:

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

===  

[absolute_redirects]    ,  Sinatra   
                        ,    
                        RFC 2616 (HTTP 1.1),   
                        .

                         ,       ,
                           .  ,  +url+
                            URL,    
                       +false+  .

                         .

[add_charsets]         mime-,    <tt>content_type</tt>  
                          .

                                :

                         settings.add_charsets << "application/foobar"

[app_file]               ,     
                       ,      ,  .

[bind]                  IP- ( : 0.0.0.0).  
                        .

[default_encoding]     ,   ( : <tt>"utf-8"</tt>).

[dump_errors]             .

[environment]           ,  ,  <tt>ENV['RACK_ENV']</tt>
                        <tt>"development"</tt>,  <tt>ENV['RACK_ENV']</tt>  .

[logging]               .

[lock]                     ,   
                               Ruby .

                       ,     - (thread-safe).
                         .

[method_override]       ""  <tt>_method</tt>,  
                        PUT/DELETE   ,   
                        .

[port]                 ,     .  
                        .

[prefixed_redirects]       <tt>request.script_name</tt>  ,
                           .  ,  <tt>redirect '/foo'</tt>
                           <tt>redirect to('/foo')</tt>.   .

[public_folder]        ,     .

[reload_templates]           .
                          .

[root]                   .

[raise_errors]           (  ).

[run]                   , Sinatra    -.
                        ,   rackup   .

[running]                  ?
                          !

[server]                  ,     
                        .  : ['thin', 'mongrel', 'webrick'],
                         .

[sessions]                  (cookie).

[show_exceptions]       /  (stack trace)  .

[static]                 Sinatra    .
                       ,   - -   .
                           .
                               
                       .

[static_cache_control]  Sinatra   ,   ,
                           <tt>Cache-Control</tt>.  
                        - +cache_control+.   .
                        ,     :
                       <tt>set :static_cache_control, [:public, :max_age => 300]</tt>

[views]                 .

==  

      ,   ,  +before+-,   ,  
  <tt>haml</tt>, <tt>erb</tt>, <tt>halt</tt>  ..   .

=== Not Found

   <tt>Sinatra::NotFound</tt>,     404,
   <tt>not_found</tt> :

  not_found do
    'This is nowhere to be found.'
  end

=== 

  +error+  ,      ,   .
-    <tt>sinatra.error</tt>  Rack:

  error do
    'Sorry there was a nasty error - ' + env['sinatra.error'].name
  end

 :

  error MyCustomError do
    'So what happened was...' + env['sinatra.error'].message
  end

,   :

  get '/' do
    raise MyCustomError, 'something bad'
  end

  :

  So what happened was... something bad

         HTTP:

  error 403 do
    'Access forbidden'
  end

  get '/secret' do
    403
  end

  :

  error 400..510 do
    'Boom'
  end

Sinatra   <tt>not_found</tt>  <tt>error</tt> ,     
 ( <tt>:development</tt>).

== Rack ""

Sinatra  Rack[http://rack.rubyforge.org/],   
  -  Ruby.        Rack
  "" ("middleware")  ,
 ""    ,   / 
HTTP /    .

 Sinatra     ""    +use+:

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hello World'
  end

 +use+  ,   
Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] DSL
(    rackup ). ,  +use+ 
  ,   :

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'secret'
  end

Rack     ""
 , ,  URL, ,  . Sinatra 
    ,   ,    
 (+use+)  .

     
{rack}[https://github.com/rack/rack/tree/master/lib/rack],
{rack-contrib}[https://github.com/rack/rack-contrib#readme],
{CodeRack}[http://coderack.org/]  
{Rack wiki}[https://github.com/rack/rack/wiki/List-of-Middleware].

== 

  Sinatra       , , 
 Rack. {Rack::Test}[http://rdoc.info/github/brynary/rack-test/master/frames] :

  require 'my_sinatra_app'
  require 'test/unit'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hello World!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hello Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "You're using Songbird!", last_response.body
    end
  end

== Sinatra::Base  "",    

      (  DSL  ,
   )     .   ,
       ,  
Rack middleware (""), Rails metal,     ,
 Sinatra.

DSL   ""   <tt>Object</tt>    
- (,   , <tt>./public</tt> 
<tt>./views</tt> , ,    
 ..).      <tt>Sinatra::Base</tt>:

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hello world!'
    end
  end

,  <tt>Sinatra::Base</tt>   ,  
 DSL  .      
  <tt>Sinatra::Base</tt>     :

*    <tt>sinatra/base</tt>  +sinatra+,
    ,  Sinatra,      .
*   ,  ,      <tt>Sinatra::Base</tt>.

<tt>Sinatra::Base</tt>    .  ,   ,   .
 {  }[http://www.sinatrarb.com/configuration.html]   
    .

===    

  ,    ( )   .
     ,       
.

        :

*        Sinatra   Ruby .   
   ,     .

* ,   ,    Object.  
        /gem,  
    .

  ,           .

     ,       :

                             

  app_file                       Sinatra::Base
  run                 $0 == app_file          false
  logging             true                    false
  method_override     true                    false
  inline_templates    true                    false
  static              true                    false


===   

      :     <tt>run!</tt>:

  # my_app.rb
  require 'sinatra/base'

  class MyApp < Sinatra::Base
    # ...    ...

    #  ,    
    run! if app_file == $0
  end

   :

  ruby my_app.rb

     <tt>config.ru</tt>,    
Rack-  .

  # config.ru
  require './my_app'
  run MyApp

:

  rackup -p 4567

===     config.ru

 :

  # app.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

  <tt>config.ru</tt>:

  require './app'
  run Sinatra::Application

===   config.ru?

  ,   , ,   <tt>config.ru</tt>:

*        Rack-  (Passenger, Unicorn,
  Heroku, ...);
*       <tt>Sinatra::Base</tt>;
*    Sinatra    "" Rack.

<b>     <tt>config.ru</tt>  ,   
   .     , 
    <tt>config.ru</tt>.</b>

===  Sinatra   ""

   Sinatra   "" Rack,    Sinatra 
      Rack endpoint   "".  endpoint ( )
   Sinatra ,  ,   Rack (Rails/Ramaze/Camping/...):

  require 'sinatra/base'
  
  class LoginScreen < Sinatra::Base
    enable :sessions
    
    get('/login') { haml :login }
    
    post('/login') do
      if params[:name] == 'admin' && params[:password] == 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end
  
  class MyApp < Sinatra::Base
    # ""    
    use LoginScreen
    
    before do
      unless session['user_name']
        halt "Access denied, please <a href='/login'>login</a>."
      end
    end
    
    get('/') { "Hello #{session['user_name']}." }
  end

===   " "

   Sinatra  " " (,
  ).     <tt>Sinatra.new</tt>:

  require 'sinatra/base'
  my_app = Sinatra.new { get('/') { "hi" } }
  my_app.run!

     ,  
 :

  # config.ru
  require 'sinatra/base'

  controller = Sinatra.new do
    enable :logging
    helpers MyHelpers
  end

  map('/a') do
    run Sinatra.new(controller) { get('/') { 'a' } }
  end

  map('/b') do
    run Sinatra.new(controller) { get('/') { 'b' } }
  end

      Sinatra  
 Sinatra   .

 ,  Sinatra  ""  :

  require 'sinatra/base'

  use Sinatra do
    get('/') { ... }
  end

  run RailsProject::Application


==    

      , 
  .

===    / 

 Sinatra    <tt>Sinatra::Base</tt>.  
 DSL   (<tt>require 'sinatra'</tt>),     
<tt>Sinatra::Application</tt>,    ,    .
       ,  +get+  +before+,  
      +request+  +session+,   
      .

,    +set+,    :

    class MyApp < Sinatra::Base
      #     !
      set :foo, 42
      foo # => 42
      
      get '/foo' do
        #       !
      end
    end

      :

*    ;
* ,  ;
* ,   +helpers+;
* ,     +set+;
* ,   <tt>Sinatra.new</tt>.

        ( )  :

*  ,    (<tt>configure { |c| ... }</tt>);
* +settings+    .

===   /

         ,
        .   
   +request+  +session+ ,  
,   +erb+  +haml+.     
     ,  - +settings+:

  class MyApp < Sinatra::Base
    #     !
    get '/define_route/:name' do
      #    '/define_route/:name'
      @value = 42
      
      settings.get("/#{params[:name]}") do
        #    "/#{params[:name]}"
        @value # => nil ( )
      end
      
      "Route defined!"
    end
  end

      :

* get/head/post/put/delete/options ;
* before/after ;
* -;
* /.

===   

         .
,         ,     
  .  ,    ,  ,
 /      ( ,
    +self+ ).  
   , 
<tt>Sinatra::Delegator.delegate :method_name</tt>.

     :

*   ,    <tt>require 'sinatra'</tt>;
* ,    <tt>Sinatra::Delegator</tt>.

   : 
{Sinatra::Delegator }[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
 {    }[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28].

==  

Sinatra     :

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]

 :

  -h #  
  -p #   (  4567)
  -o #   (  0.0.0.0)
  -e #  ,  (  development)
  -s #  rack / (  thin)
  -x #  - (  )

==  

  Ruby  :

[ Ruby 1.8.7 ]
  1.8.7  ,   ,      
   ,    1.9.2    JRuby  Rubinius.

[ Ruby 1.9.2 ]
  1.9.2     . ,  Radius  Markaby
     1.9.2.   1.9.2p0, ,  
       Sinatra.

[ Rubinius ]
  Rubinius   (Rubinius >= 1.2.3), ,  
   , .

[ JRuby ]
  JRuby   (JRuby >= 1.6.1).    
    .   ,   
  JRuby, , ,   JRuby Rack-,   Thin 
     JRuby.    C  JRuby 
   ,       RDiscount 
  Redcarpet.

<b>Ruby 1.8.6   .</b>     
  1.8.6,   Sinatra 1.2,    
    ,     Sinatra 1.4.0

        Ruby.

  Ruby   ,  ,  
  Sinatra:

*   JRuby  Rubinius;
* MacRuby, Maglev, IronRuby;
* Ruby 1.9.0  1.9.1;
* Ruby 1.8.6   {backports}[https://github.com/marcandre/backports/#readme].

,     , , ,  - 
   ,     -    ,  .

    CI-    Ruby ( 1.9.3),
     ,     .
,  1.9.3p0  .

Sinatra      ,         Ruby.

==  

       Sinatra,   
      master  Sinatra,   .

       ,      :

  gem install sinatra --pre

     .

===   Bundler

         Sinatra, 
  {Bundler}[http://gembundler.com/].

  Bundler,      :

  gem install bundler

   +Gemfile+    :

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"

  #  
  gem 'haml'                    # ,   haml
  gem 'activerecord', '~> 3.0'  #  ,    ActiveRecord 3.x

 ,        
  . ,   Sinatra (Rack  Tilt) Bundler
   .

      :

  bundle exec ruby myapp.rb

=== 

         <tt>sinatra/lib</tt>
  <tt>$LOAD_PATH</tt>:

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

   Sinatra:

  cd myapp/sinatra
  git pull

===  

    gem:

  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

    (gem)   root,       

  sudo rake install

== 

Sinatra  {Semantic Versioning}[http://semver.org/], SemVer 
SemVerTag.

==  

* {- }[http://www.sinatrarb.com/] -  ,
       .
* {  }[http://www.sinatrarb.com/contributing] -  ?  ?  ?
* {  /}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* { }[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra]  http://freenode.net
* {Sinatra Book}[http://sinatra-book.gittr.com]    
* {Sinatra Recipes}[http://recipes.sinatrarb.com/]  
* API   { }[http://rubydoc.info/gems/sinatra]
   { HEAD}[http://rubydoc.info/github/sinatra/sinatra] 
  http://rubydoc.info

= Sinatra
<i>
</i>

SinatraRubywebDSL


  # myapp.rb
  require 'sinatra'

  get '/' do
    'Hello world!'
  end

gem

  gem install sinatra
  ruby -rubygems myapp.rb

 http://localhost:4567

<tt>gem install thin</tt>Sinatrathin

== 

SinatraHTTPURL


  get '/' do
    ..  ..
  end

  post '/' do
    ..  ..
  end

  put '/' do
    ..  ..
  end

  delete '/' do
    ..  ..
  end

  options '/' do
    ..  ..
  end




<tt>params</tt>

  get '/hello/:name' do
    #  "GET /hello/foo"  "GET /hello/bar"
    # params[:name]  'foo'  'bar'
    "Hello #{params[:name]}!"
  end



  get '/hello/:name' do |n|
    "Hello #{n}!"
  end


<tt>params[:splat]</tt> 

  get '/say/*/to/*' do
    #  /say/hello/to/world
    params[:splat] # => ["hello", "world"]
  end

  get '/download/*.*' do
    #  /download/path/to/file.xml
    params[:splat] # => ["path/to/file", "xml"]
  end



  get %r{/hello/([\w]+)} do
    "Hello, #{params[:captures].first}!"
  end



  get %r{/hello/([\w]+)} do |c|
    "Hello, #{c}!"
  end

=== 

user agent

  get '/foo', :agent => /Songbird (\d\.\d)[\d\/]*?/ do
    "Songbird #{params[:agent][0]}"
  end

  get '/foo' do
    # Songbird
  end

 +host_name+  +provides+

  get '/', :host_name => /^admin\./ do
    ""
  end

  get '/', :provides => 'html' do
    haml :index
  end
  
  get '/', :provides => ['rss', 'atom', 'xml'] do
    builder :feed
  end



  set(:probability) { |value| condition { rand <= value } }
  
  get '/win_a_car', :probability => 0.1 do
    "You won!"
  end
  
  get '/win_a_car' do
    "Sorry, you lost."
  end

=== 

HTTP
Rack



Rack
Rack bodyHTTP

* : <tt>[ (Fixnum),  (Hash),  ( #each)]</tt>
* : <tt>[ (Fixnum),  ( #each)]</tt>
*  <tt>#each</tt> 
* 



    class Stream
      def each
        100.times { |i| yield "#{i}\n" }
      end
    end

    get('/') { Stream.new }

=== 

Sinatra

:

  class AllButPattern
    Match = Struct.new(:captures)

    def initialize(except)
      @except   = except
      @captures = Match.new([])
    end

    def match(str)
      @captures unless @except === str
    end
  end

  def all_but(pattern)
    AllButPattern.new(pattern)
  end

  get all_but("/index") do
    # ...
  end


:

  get // do
    pass if request.path_info == "/index"
    # ...
  end

:

  get %r{^(?!/index$)} do
    # ...
  end

== 

 <tt>./public_folder</tt> <tt>:public</tt>


  set :public_folder, File.dirname(__FILE__) + '/static'

publicURL
<tt>./public/css/style.css</tt>
<tt>http://example.com/css/style.css</tt>

==  / 

<tt>./views</tt>


  set :views, File.dirname(__FILE__) + '/templates'



 <tt>:'subdir/template'</tt>

 

=== Haml

 <tt>haml</tt> gem/library HAML 

  #  haml
  require 'haml'

  get '/' do
    haml :index
  end

 <tt>./views/index.haml</tt>

{Haml}[http://haml.info/docs/yardoc/file.HAML_REFERENCE.html#options]
Sinatra
 {}[http://www.sinatrarb.com/configuration.html]


  set :haml, {:format => :html5 } # Haml :xhtml

  get '/' do
    haml :index, :haml_options => {:format => :html4 } # :html4
  end


=== Erb

  #  erb
  require 'erb'

  get '/' do
    erb :index
  end

 <tt>./views/index.erb</tt>

=== Erubis

 <tt>erubis</tt> gem/library erubis 

  #  erubis
  require 'erubis'

  get '/' do
    erubis :index
  end

 <tt>./views/index.erubis</tt>

ErubisErb:

  require 'erubis'
  Tilt.register :erb, Tilt[:erubis]

  get '/' do
    erb :index
  end

Erubis <tt>./views/index.erb</tt>

=== Builder 

 <tt>builder</tt> gem/library  builder templates

  # builder
  require 'builder'

  get '/' do
    builder :index
  end

 <tt>./views/index.builder</tt>

=== Nokogiri 

 <tt>nokogiri</tt> gem/library  nokogiri 

  #  nokogiri
  require 'nokogiri'

  get '/' do
    nokogiri :index
  end

 <tt>./views/index.nokogiri</tt>

=== Sass  

 <tt>haml</tt>  <tt>sass</tt> gem/library  Sass 

  #  haml  sass 
  require 'sass'

  get '/stylesheet.css' do
    sass :stylesheet
  end

 <tt>./views/stylesheet.sass</tt>

{Sass }[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
Sinatra
 {}[http://www.sinatrarb.com/configuration.html],


  set :sass, {:style => :compact } #  Sass  :nested

  get '/stylesheet.css' do
    sass :stylesheet, :style => :expanded # 
  end

=== Scss  

 <tt>haml</tt>  <tt>sass</tt> gem/library  Scss templates

  #  haml  sass
  require 'sass'

  get '/stylesheet.css' do
    scss :stylesheet
  end

 <tt>./views/stylesheet.scss</tt>

{Scss}[http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#options]
Sinatra
 {}[http://www.sinatrarb.com/configuration.html],


  set :scss, :style => :compact # default Scss style is :nested

  get '/stylesheet.css' do
    scss :stylesheet, :style => :expanded # overridden
  end

=== Less  

 <tt>less</tt> gem/library  Less 

  #  less
  require 'less'

  get '/stylesheet.css' do
    less :stylesheet
  end

 <tt>./views/stylesheet.less</tt>

=== Liquid  

 <tt>liquid</tt> gem/library  Liquid 

  #  liquid
  require 'liquid'

  get '/' do
    liquid :index
  end

 <tt>./views/index.liquid</tt>

Liquid  Ruby  ( +yield+) 
locals

  liquid :index, :locals => { :key => 'value' }

=== Markdown 

 <tt>rdiscount</tt> gem/library  Markdown 

  # rdiscount
  require "rdiscount"
  
  get '/' do
    markdown :index
  end

 <tt>./views/index.markdown</tt> 
(+md+  +mkd+ )

markdown locals



  erb :overview, :locals => { :text => markdown(:introduction) }

 markdown 

  %h1 Hello From Haml!
  %p= markdown(:greetings)

MarkdownRubyMarkdown

<tt>:layout_engine</tt>:

  get '/' do
    markdown :index, :layout_engine => :erb
  end

 <tt>./views/index.md</tt> 
<tt>./views/layout.erb</tt> 

:

  set :markdown, :layout_engine => :haml, :layout => :post

  get '/' do
    markdown :index
  end

 <tt>./views/index.markdown</tt> ( Markdown
)  <tt>./views/post.haml</tt> .

BlueClothRDiscountMarkdown:

  require 'bluecloth'

  Tilt.register 'markdown', BlueClothTemplate
  Tilt.register 'mkd',      BlueClothTemplate
  Tilt.register 'md',       BlueClothTemplate

  get '/' do
    markdown :index
  end

BlueCloth <tt>./views/index.md</tt> 

=== Textile 

 <tt>RedCloth</tt> gem/library  Textile 

  # redcloth
  require "redcloth"

  get '/' do
    textile :index
  end

 <tt>./views/index.textile</tt>

textile locals


  erb :overview, :locals => { :text => textile(:introduction) }

+textile+

  %h1 Hello From Haml!
  %p= textile(:greetings)

TextileRubyTextile

<tt>:layout_engine</tt>:

  get '/' do
    textile :index, :layout_engine => :erb
  end

 <tt>./views/index.textile</tt> 
<tt>./views/layout.erb</tt> 

:

  set :textile, :layout_engine => :haml, :layout => :post

  get '/' do
    textile :index
  end

 <tt>./views/index.textile</tt> ( Textile
)  <tt>./views/post.haml</tt> .

=== RDoc 

 <tt>RDoc</tt> gem/library RDoc

  # rdoc/markup/to_html
  require "rdoc"
  require "rdoc/markup/to_html"

  get '/' do
    rdoc :index
  end

 <tt>./views/index.rdoc</tt>

rdoclocals


  erb :overview, :locals => { :text => rdoc(:introduction) }

+rdoc+

  %h1 Hello From Haml!
  %p= rdoc(:greetings)

RDocRubyRDoc

<tt>:layout_engine</tt>:

  get '/' do
    rdoc :index, :layout_engine => :erb
  end

 <tt>./views/index.rdoc</tt> 
<tt>./views/layout.erb</tt> 

:

  set :rdoc, :layout_engine => :haml, :layout => :post

  get '/' do
    rdoc :index
  end

 <tt>./views/index.rdoc</tt> ( RDoc
)  <tt>./views/post.haml</tt> .

=== Radius 

 <tt>radius</tt> gem/library  Radius 

  # radius
  require 'radius'

  get '/' do
    radius :index
  end

 <tt>./views/index.radius</tt>

Radius  Ruby  ( +yield+) 
locals

  radius :index, :locals => { :key => 'value' }

=== Markaby  

<tt>markaby</tt> gem/libraryMarkaby

  # markaby
  require 'markaby'

  get '/' do
    markaby :index
  end

 <tt>./views/index.mab</tt>

 Markaby:

  get '/' do
    markaby { h1 "Welcome!" }
  end

=== Slim  

 <tt>slim</tt> gem/library  Slim 

  #  slim
  require 'slim'

  get '/' do
    slim :index
  end

 <tt>./views/index.slim</tt>

=== Creole  

 <tt>creole</tt> gem/library  Creole 

  #  creole
  require 'creole'

  get '/' do
    creole :index
  end

 <tt>./views/index.creole</tt>

=== CoffeeScript 

 <tt>coffee-script</tt> gem/library 
Javascript:

* +node+ ( Node.js) 
*  OSX
* +therubyracer+ gem/library

 http://github.com/josh/ruby-coffee-script 

 CoffeeScript :

  # coffee-script
  require 'coffee-script'

  get '/application.js' do
    coffee :application
  end

 <tt>./views/application.coffee</tt>

=== 

  get '/' do
    haml '%div.title Hello World'
  end



=== 




  get '/:id' do
    @foo = Foo.find(params[:id])
    haml '%h1= @foo.name'
  end



  get '/:id' do
    foo = Foo.find(params[:id])
    haml '%h1= foo.name', :locals => { :foo => foo }
  end




=== 



  require 'sinatra'

  get '/' do
    haml :index
  end

  __END__

  @@ layout
  %html
    = yield

  @@ index
  %div.title Hello world!!!!!

sinatra

<tt>enable :inline_templates</tt>

=== 

 <tt>template</tt> 

  template :layout do
    "%html\n  =yield\n"
  end

  template :index do
    '%div.title Hello World!'
  end

  get '/' do
    haml :index
  end

"layout"
 <tt>:layout => false</tt>
<tt>set :haml, :layout => false</tt>

  get '/' do
    haml :index, :layout => !request.xhr?
  end

=== 


<tt>Tilt.register</tt>
+tt+ Textile:

  Tilt.register :tt, Tilt[:textile]

=== 

Tilt:

  Tilt.register :myat, MyAwesomeTemplateEngine

  helpers do
    def myat(*args) render(:myat, *args) end
  end

  get '/' do
    myat :index
  end

 <tt>./views/index.myat</tt> https://github.com/rtomayko/tilt 
Tilt.

== 





  before do
    @note = 'Hi!'
    request.path_info = '/foo/bar/baz'
  end

  get '/foo/*' do
    @note #=> 'Hi!'
    params[:splat] #=> 'bar/baz'
  end





  after do
    puts response.status
  end

 +body+ 






  before '/protected/*' do
    authenticate!
  end

  after '/create/:slug' do |slug|
    session[:last_slug] = slug
  end

:

  before :agent => /Songbird/ do
    # ...
  end

  after '/blog/*', :host_name => 'example.com' do
    # ...
  end

== 

 <tt>helpers</tt> 


  helpers do
    def bar(name)
      "#{name}bar"
    end
  end

  get '/:name' do
    bar(params[:name])
  end

===  Sessions

Session
session:

  enable :sessions

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

 <tt>enable :sessions</tt> cookie

Rack session
** <tt>enable :sessions</tt>


  use Rack::Session::Pool, :expire_after => 2592000

  get '/' do
    "value = " << session[:value].inspect
  end

  get '/:value' do
    session[:value] = params[:value]
  end

=== 



  halt



  halt 410



  halt 'this will be the body'

;

  halt 401, 'go away!'



  halt 402, {'Content-Type' => 'text/plain'}, 'revenge'

=== 

 <tt>pass</tt>

  get '/guess/:who' do
    pass unless params[:who] == 'Frank'
    'You got me!'
  end

  get '/guess/*' do
    'You missed!'
  end


404

=== 

+pass+ 
 +call+ :

  get '/foo' do
    status, headers, body = call env.merge("PATH_INFO" => '/bar')
    [status, headers, body.map(&:upcase)]
  end

  get '/bar' do
    "bar"
  end


 <tt>"bar"</tt><tt>/foo</tt>
 <tt>/bar</tt>helper


 <tt>call!</tt>  <tt>call</tt>.

 Rack specification  <tt>call</tt>.

===  



 +body+ 

:

  get '/foo' do
    body "bar"
  end

  after do
    puts body
  end

 +body+Rack
streaming

:

  get '/foo' do
    status 418
    headers \
      "Allow"   => "BREW, POST, GET, PROPFIND, WHEN",
      "Refresh" => "Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"
    body "I'm a tea pot!"
  end

 +body+,  +headers+  +status+ 
.

=== 

 <tt>send_file</tt> 
Sinatra +mime_type+ 

  mime_type :foo, 'text/foo'

 +content_type+ 

  get '/' do
    content_type :foo
    "foo foo foo"
  end

===  URL

URL +url+ 
Haml:

  %a{:href => url('/foo')} foo

RackURL

 +to+ ().

=== 

 +redirect+ :

  get '/foo' do
    redirect to('/bar')
  end

 +halt+:

  redirect to('/bar'), 303
  redirect 'http://google.com', 'wrong place, buddy'


<tt>redirect back</tt>:

  get '/foo' do
    "<a href='/bar'>do something</a>"
  end

  get '/bar' do
    do_something
    redirect back
  end

redirectquery:

  redirect to('/bar?sum=42')

session:

  enable :sessions

  get '/foo' do
    session[:secret] = 'foo'
    redirect to('/bar')
  end

  get '/bar' do
    session[:secret]
  end

=== 

HTTP

 Cache-Control :

  get '/' do
    cache_control :public
    "cache it!"
  end

: .

  before do
    cache_control :public, :must_revalidate, :max_age => 60
  end

 +expires+ 
<tt>Cache-Control</tt> 

  before do
    expires 500, :public, :must_revalidate
  end

 +etag+  +last_modified+.
**helpers


  get '/article/:id' do
    @article = Article.find params[:id]
    last_modified @article.updated_at
    etag @article.sha1
    erb :article
  end


{weak ETag}[http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation]
:

  etag @article.sha1, :weak



{rack-cache}[http://rtomayko.github.com/rack-cache/]:

  require "rack/cache"
  require "sinatra"

  use Rack::Cache

  get '/' do
    cache_control :public, :max_age => 36000
    sleep 5
    "hello"
  end

=== 

 <tt>send_file</tt> :

  get '/' do
    send_file 'foo.png'
  end

:

  send_file 'foo.png', :type => :jpg

:

[filename]
  

[last_modified]
  Last-Modified mtime

[type]
  

[disposition]
   Content-Disposition +nil+ (),
  <tt>:attachment</tt>  <tt>:inline</tt>

[length]
  Content-Length 

RackRubystreaming

Sinatrarange

=== 


 <tt>request</tt> 

  #  http://example.com/example 
  get '/foo' do
    request.body              # 
    request.scheme            # "http"
    request.script_name       # "/example"
    request.path_info         # "/foo"
    request.port              # 80
    request.request_method    # "GET"
    request.query_string      # ""
    request.content_length    # request.body
    request.media_type        # request.body
    request.host              # "example.com"
    request.get?              # true ()
    request.form_data?        # false
    request["SOME_HEADER"]    # SOME_HEADER header
    request.referrer          # referrer  '/'
    request.user_agent        # user agent ( :agent )
    request.cookies           #  cookies 
    request.xhr?              # ajax
    request.url               # "http://example.com/example/foo"
    request.path              # "/example/foo"
    request.ip                # IP
    request.secure?           # falsessltrue
    request.forwarded?        # true 
    request.env               # Rackenv
  end

 <tt>script_name</tt>  <tt>path_info</tt> 


  before { request.path_info = "/" }
  
  get "/" do
    "all requests end up here"
  end

<tt>request.body</tt> IOStringIO

  post "/api" do
    request.body.rewind  # 
    data = JSON.parse request.body.read
    "Hello #{data['name']}!"
  end

=== 

 +attachment+ 


  get '/' do
    attachment
    "store it!"
  end

:

  get '/' do
    attachment "info.txt"
    "store it!"
  end

=== 

<tt>find_template</tt> :

  find_template settings.views, 'foo', Tilt[:haml] do |file|
    puts "could be #{file}"
  end



:

  set :views, ['views', 'templates']

  helpers do
    def find_template(views, name, engine, &block)
      Array(views).each { |v| super(v, name, engine, &block) }
    end
  end

:

  set :views, :sass => 'views/sass', :haml => 'templates', :default => 'views'

  helpers do
    def find_template(views, name, engine, &block)
      _, folder = views.detect { |k,v| engine == Tilt[k] }
      folder ||= views[:default]
      super(folder, name, engine, &block)
    end
  end



 <tt>find_template</tt> 

 +render+  +break+ 
development mode



== 



  configure do
    # setting one option
    set :option, 'value'
    
    # setting multiple options
    set :a => 1, :b => 2
    
    # same as `set :option, true`
    enable :option
    
    # same as `set :option, false`
    disable :option
    
    # you can also have dynamic settings with blocks
    set(:css_dir) { File.join(views, 'css') }
  end

 (RACK_ENV environment ) 
<tt>:production</tt>

  configure :production do
    ...
  end

 <tt>:production</tt> 
<tt>:test</tt>

  configure :production, :test do
    ...
  end

 <tt>settings</tt> :

  configure do
    set :foo, 'bar'
  end

  get '/' do
    settings.foo? # => true
    settings.foo  # => 'bar'
    ...
  end

=== 

[absolute_redirects]  Sinatra
                      Sinatra RFC 2616
                      (HTTP 1.1), 
                      
                      
                       +url+ 
                       URL
                      +false+ 

                      

[add_charsets]         <tt>content_type</tt> 
                      

                      :

                        settings.add_charsets << "application/foobar"

[app_file]            
                      viewspublic

[bind]                IP  (: 0.0.0.0)
                      

[default_encoding]    
                      ( <tt>"utf-8"</tt>)

[dump_errors]         log

[environment]          <tt>ENV['RACK_ENV']</tt>
                       <tt>"development"</tt> 

[logging]             logger

[lock]                
                      

                      
                      

[method_override]      <tt>_method</tt> 
                       put/delete 

[port]                

[prefixed_redirects]   <tt>request.script_name</tt> 
                      
                      <tt>redirect '/foo'</tt> 
                      <tt>redirect to('/foo')</tt>

[public_folder]      public

[reload_templates]    
                      development mode Ruby 1.8.6 
                      Rubybug

[root]                

[raise_errors]        

[run]                 Sinatraweb
                      rackup

[running]             
                      

[server]              
                       ['thin', 'mongrel', 'webrick'], 
                      

[sessions]            cookiesesson

[show_exceptions]     stack trace

[static]              Sinatra
                      
                      
                      

[views]               views 

== 


 <tt>haml</tt>, <tt>erb</tt>,
<tt>halt</tt>

=== 

 <tt>Sinatra::NotFound</tt> 
404<tt>not_found</tt> 

  not_found do
    'This is nowhere to be found'
  end

=== 

+error+  
<tt>sinatra.error</tt> Rack 


  error do
    'Sorry there was a nasty error - ' + env['sinatra.error'].name
  end



  error MyCustomError do
    'So what happened was...' + env['sinatra.error'].message
  end



  get '/' do
    raise MyCustomError, 'something bad'
  end



  So what happened was... something bad



  error 403 do
    'Access forbidden'
  end

  get '/secret' do
    403
  end



  error 400..510 do
    'Boom'
  end

developmentSinatra
<tt>not_found</tt>  <tt>error</tt> 

== Rack 

Sinatra  Rack[http://rack.rubyforge.org/], 
Ruby web
Rack
 / HTTP/


Sinatra Rack
 +use+ 

  require 'sinatra'
  require 'my_custom_middleware'

  use Rack::Lint
  use MyCustomMiddleware

  get '/hello' do
    'Hello World'
  end

+use+  Rack::Builder[http://rack.rubyforge.org/doc/classes/Rack/Builder.html] 
DSL(rack)+use+
 / 

  use Rack::Auth::Basic do |username, password|
    username == 'admin' && password == 'secret'
  end

Rack
URLsession
Sinatra
 +use+ 

== 

SinatraRack
{Rack::Test}[http://gitrdoc.com/brynary/rack-test]


  require 'my_sinatra_app'
  require 'test/unit'
  require 'rack/test'

  class MyAppTest < Test::Unit::TestCase
    include Rack::Test::Methods

    def app
      Sinatra::Application
    end

    def test_my_default
      get '/'
      assert_equal 'Hello World!', last_response.body
    end

    def test_with_params
      get '/meet', :name => 'Frank'
      assert_equal 'Hello Frank!', last_response.body
    end

    def test_with_rack_env
      get '/', {}, 'HTTP_USER_AGENT' => 'Songbird'
      assert_equal "You're using Songbird!", last_response.body
    end
  end

:  Sinatra::Test  Sinatra::TestHarness 
 0.9.2 

== Sinatra::Base - 



RackRails metal
SinatraDSLObject
 (, 
./public  ./views 
 Sinatra::Base 

  require 'sinatra/base'

  class MyApp < Sinatra::Base
    set :sessions, true
    set :foo, 'bar'

    get '/' do
      'Hello world!'
    end
  end

Sinatra::Base DSL

Sinatra::Base

*  +sinatra/base+  +sinatra+;
  Sinatra DSL 
  
* 
  Sinatra::Base

<tt>+Sinatra::Base+</tt> 
 {}[http://sinatra.github.com/configuration.html]


===  vs. 




:

* RubySinatra
  

*  Object 
   library/gem



settings
:

  Setting             Classic                 Modular

  app_file            file loading sinatra    nil
  run                 $0 == app_file          false
  logging             true                    false
  method_override     true                    false
  inline_templates    true                    false


=== 


<tt>run!</tt>:

  # my_app.rb
  require 'sinatra/base'
  
  class MyApp < Sinatra::Base
    # ... app code here ...
    
    # start the server if ruby file executed directly
    run! if app_file == $0
  end

:

  ruby my_app.rb

 <tt>config.ru</tt>Rack:

  # config.ru
  require './my_app'
  run MyApp

:

  rackup -p 4567

=== config.ru

:

  # app.rb
  require 'sinatra'
  
  get '/' do
    'Hello world!'
  end

 <tt>config.ru</tt>:

  require './app'
  run Sinatra::Application

===  config.ru?

 <tt>config.ru</tt>:

*  Rack  (Passenger, Unicorn,
  Heroku, ...).
*  <tt>Sinatra::Base</tt>.
* Sinatra

<b><tt>config.ru</tt>

 <tt>config.ru</tt>.</b>

=== Sinatra

SinatraRackSinatra
Rack
SinatraRack
(Rails/Ramaze/Camping/...)

  require 'sinatra/base'
  
  class LoginScreen < Sinatra::Base
    enable :sessions
    
    get('/login') { haml :login }
    
    post('/login') do
      if params[:name] = 'admin' and params[:password] = 'admin'
        session['user_name'] = params[:name]
      else
        redirect '/login'
      end
    end
  end
  
  class MyApp < Sinatra::Base
    # 
    use LoginScreen
    
    before do
      unless session['user_name']
        halt "Access denied, please <a href='/login'>login</a>."
      end
    end
    
    get('/') { "Hello #{session['user_name']}." }
  end

== 




=== / 

SinatraSinatra::Base
DSL(<tt>require 'sinatra'</tt>)
Sinatra::Application
 `get`  `before`
`request`  `session`, 


 `set` 

    class MyApp < Sinatra::Base
      # 
      set :foo, 42
      foo # => 42
      
      get '/foo' do
        # 
      end
    end



* 
* 
*  `helpers` 
* `set`/



*  (<tt>configure { |c| ... }</tt>)
* `settings`

=== / 



 `request`  `session` 
`erb`  `haml``settings`


  class MyApp < Sinatra::Base
    # !
    get '/define_route/:name' do
      #  '/define_route/:name' 
      @value = 42
      
      settings.get("/#{params[:name]}") do
        #  "/#{params[:name]}" 
        @value # => nil ()
      end
      
      "Route defined!"
    end
  end



* get/head/post/put/delete 
* / 
* 
* /

=== 


100%, : 

/(
`self`) 
<tt>Sinatra::Delegator.delegate :method_name</tt>



*  <tt>require "sinatra"</tt>
*  `Sinatra::Delegator` mixin

: 
{Sinatra::Delegator mixin}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/base.rb#L1128]
 {}[http://github.com/sinatra/sinatra/blob/ceac46f0bc129a6e994a06100aa854f606fe5992/lib/sinatra/main.rb#L28]

== 

Sinatra 

  ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]



  -h # help
  -p #  ( 4567)
  -o #  ( 0.0.0.0)
  -e #  ( development)
  -s #  rack / ( thin)
  -x #  ( off)

== 

 Ruby 1.8.7, 1.9.2, JRuby  Rubinius Sinatra

Ruby:

[ Ruby 1.8.6 ]
  1.8.6Sinatra
  Sinatra 1.3.0
  RDoc  CoffeScriptRuby
  1.8.6Hash
  1.1.1Sinatra
  Rack1.1.x
  Rack >= 1.21.8.6

[ Ruby 1.8.7 ]
  1.8.7 
   1.9.2  JRuby  Rubinius.

[ Ruby 1.9.2 ]
  1.9.2  Radius  Markaby
  1.9 1.9.2p0, 
  segmentation faults.

[ Rubinius ]
  Rubinius  (Rubinius >= 1.2.2)
  Textile

[ JRuby ]
  JRuby  (JRuby >= 1.5.6)
  
  JRubyJRuby rack 
   Thin web JRuby

Ruby

 Ruby 
 Sinatra:

* JRuby  Rubinius 
* MacRuby
* Maglev
* IronRuby
* Ruby 1.9.0 and 1.9.1




SinatraRuby


== 

 Sinatra  master

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

gems

  gem install sinatra --pre



=== Bundler
Sinatra
{Bundler}[http://gembundler.com/] 

bundler:

  gem install bundler

 +Gemfile+:

  source :rubygems
  gem 'sinatra', :git => "git://github.com/sinatra/sinatra.git"
  
  # 
  gem 'haml'                    # haml
  gem 'activerecord', '~> 3.0'  #  ActiveRecord 3.x


Sinatra (Rack and Tilt) 
Bundler

:

  bundle exec ruby myapp.rb

=== 
 <tt>sinatra/lib</tt> 
 <tt>$LOAD_PATH</tt>:

  cd myapp
  git clone git://github.com/sinatra/sinatra.git
  ruby -Isinatra/lib myapp.rb

 Sinatra :

  cd myapp/sinatra
  git pull

=== 

 gem :


  git clone git://github.com/sinatra/sinatra.git
  cd sinatra
  rake sinatra.gemspec
  rake install

root gems

  sudo rake install

== 

* {}[http://www.sinatrarb.com/] - 
  
* {}[http://www.sinatrarb.com/contributing] - bug
   patch?
* {}[http://github.com/sinatra/sinatra/issues]
* {Twitter}[http://twitter.com/sinatra]
* {}[http://groups.google.com/group/sinatrarb/topics]
* {IRC: #sinatra}[irc://chat.freenode.net/#sinatra] on http://freenode.net

# Tests to check if all the README examples work.
require File.expand_path('../helper', __FILE__)

class ReadmeTest < Test::Unit::TestCase
  example do
    mock_app { get('/') { 'Hello world!' } }
    get '/'
    assert_body 'Hello world!'
  end

  section "Routes" do
    example do
      mock_app do
        get '/' do
          ".. show something .."
        end

        post '/' do
          ".. create something .."
        end

        put '/' do
          ".. replace something .."
        end

        patch '/' do
          ".. modify something .."
        end

        delete '/' do
          ".. annihilate something .."
        end

        options '/' do
          ".. appease something .."
        end
      end

      get '/'
      assert_body '.. show something ..'

      post '/'
      assert_body '.. create something ..'

      put '/'
      assert_body '.. replace something ..'

      patch '/'
      assert_body '.. modify something ..'

      delete '/'
      assert_body '.. annihilate something ..'

      options '/'
      assert_body '.. appease something ..'
    end

    example do
      mock_app do
        get '/hello/:name' do
          # matches "GET /hello/foo" and "GET /hello/bar"
          # params[:name] is 'foo' or 'bar'
          "Hello #{params[:name]}!"
        end
      end

      get '/hello/foo'
      assert_body 'Hello foo!'

      get '/hello/bar'
      assert_body 'Hello bar!'
    end

    example do
      mock_app do
        get '/hello/:name' do |n|
          "Hello #{n}!"
        end
      end

      get '/hello/foo'
      assert_body 'Hello foo!'

      get '/hello/bar'
      assert_body 'Hello bar!'
    end

    example do
      mock_app do
        get '/say/*/to/*' do
          # matches /say/hello/to/world
          params[:splat].inspect # => ["hello", "world"]
        end

        get '/download/*.*' do
          # matches /download/path/to/file.xml
          params[:splat].inspect # => ["path/to/file", "xml"]
        end
      end

      get "/say/hello/to/world"
      assert_body '["hello", "world"]'

      get "/download/path/to/file.xml"
      assert_body '["path/to/file", "xml"]'
    end

    example do
      mock_app do
        get %r{/hello/([\w]+)} do
          "Hello, #{params[:captures].first}!"
        end
      end

      get '/hello/foo'
      assert_body 'Hello, foo!'

      get '/hello/bar'
      assert_body 'Hello, bar!'
    end

    example do
      mock_app do
        get %r{/hello/([\w]+)} do |c|
          "Hello, #{c}!"
        end
      end

      get '/hello/foo'
      assert_body 'Hello, foo!'

      get '/hello/bar'
      assert_body 'Hello, bar!'
    end
  end
end

# Hello From Markdown
= SQLite3/Ruby Interface

* http://github.com/luislavena/sqlite3-ruby
* http://groups.google.com/group/sqlite3-ruby

== DESCRIPTION

This module allows Ruby programs to interface with the SQLite3
database engine (http://www.sqlite.org).  You must have the
SQLite engine installed in order to build this module.

Note that this module is only compatible with SQLite 3.6.16 or newer.

== SYNOPSIS

  require "sqlite3"
  
  # Open a database
  db = SQLite3::Database.new "test.db"
  
  # Create a database
  rows = db.execute <<-SQL
    create table numbers (
      name varchar(30),
      val int
    );
  SQL
  
  # Execute a few inserts
  {
    "one" => 1,
    "two" => 2,
  }.each do |pair|
    db.execute "insert into numbers values ( ?, ? )", pair
  end
  
  # Find a few rows
  db.execute( "select * from numbers" ) do |row|
    p row
  end


== Compilation and Installation

Install SQLite3, enabling the option SQLITE_ENABLE_COLUMN_METADATA (see
www.sqlite.org/compile.html for details).

Then do the following:

  ruby setup.rb config
  ruby setup.rb setup
  ruby setup.rb install

Alternatively, you can download and install the RubyGem package for
SQLite3/Ruby (you must have RubyGems and SQLite3 installed, first):

  gem install sqlite3

If you have sqlite3 installed in a non-standard location, you can specify the location of the include and lib files by doing:

  gem install sqlite3 -- --with-sqlite3-include=/opt/local/include \
     --with-sqlite3-lib=/opt/local/lib

= SUPPORT!!!

== OMG!  Something has gone wrong!  Where do I get help?

The best place to get help is from the
{sqlite3-ruby mailing list}[http://groups.google.com/group/sqlite3-ruby] which
can be found here:

  * http://groups.google.com/group/sqlite3-ruby

== I've found a bug!  Where do I file it?

Uh oh.  After contacting the mailing list, you've found that you've actually
discovered a bug.  You can file the bug at the
{github issues page}[http://github.com/luislavena/sqlite3-ruby/issues]
which can be found here:

  * http://github.com/luislavena/sqlite3-ruby/issues

== Usage

For help figuring out the SQLite3/Ruby interface, check out the
SYNOPSIS as well as the RDoc. It includes examples of
usage. If you have any questions that you feel should be address in the
FAQ, please send them to {the mailing list}[http://groups.google.com/group/sqlite3-ruby]

== Source Code

The source repository is accessible via git:

  git clone git://github.com/luislavena/sqlite3-ruby.git


Tilt
====

Tilt is a thin interface over a bunch of different Ruby template engines in
an attempt to make their usage as generic possible. This is useful for web
frameworks, static site generators, and other systems that support multiple
template engines but don't want to code for each of them individually.

The following features are supported for all template engines (assuming the
feature is relevant to the engine):

 * Custom template evaluation scopes / bindings
 * Ability to pass locals to template evaluation
 * Support for passing a block to template evaluation for "yield"
 * Backtraces with correct filenames and line numbers
 * Template file caching and reloading
 * Fast, method-based template source compilation

The primary goal is to get all of the things listed above right for all
template engines included in the distribution.

Support for these template engines is included with the package:

    ENGINE                     FILE EXTENSIONS         REQUIRED LIBRARIES
    -------------------------- ----------------------- ----------------------------
    ERB                        .erb, .rhtml            none (included ruby stdlib)
    Interpolated String        .str                    none (included ruby core)
    Erubis                     .erb, .rhtml, .erubis   erubis
    Haml                       .haml                   haml
    Sass                       .sass                   haml (< 3.1) or sass (>= 3.1)
    Scss                       .scss                   haml (< 3.1) or sass (>= 3.1)
    Less CSS                   .less                   less
    Builder                    .builder                builder
    Liquid                     .liquid                 liquid
    RDiscount                  .markdown, .mkd, .md    rdiscount
    Redcarpet                  .markdown, .mkd, .md    redcarpet
    BlueCloth                  .markdown, .mkd, .md    bluecloth
    Kramdown                   .markdown, .mkd, .md    kramdown
    Maruku                     .markdown, .mkd, .md    maruku
    RedCloth                   .textile                redcloth
    RDoc                       .rdoc                   rdoc
    Radius                     .radius                 radius
    Markaby                    .mab                    markaby
    Nokogiri                   .nokogiri               nokogiri
    CoffeeScript               .coffee                 coffee-script (+ javascript)
    Creole (Wiki markup)       .wiki, .creole          creole
    WikiCloth (Wiki markup)    .wiki, .mediawiki, .mw  wikicloth
    Yajl                       .yajl                   yajl-ruby

These template engines ship with their own Tilt integration:

    ENGINE                     FILE EXTENSIONS   REQUIRED LIBRARIES
    -------------------------- ----------------- ----------------------------
    Slim                       .slim             slim (>= 0.7)
    Embedded JavaScript                          sprockets
    Embedded CoffeeScript                        sprockets
    JST                                          sprockets

See [TEMPLATES.md][t] for detailed information on template engine
options and supported features.

[t]: http://github.com/rtomayko/tilt/blob/master/TEMPLATES.md
   "Tilt Template Engine Documentation"

Basic Usage
-----------

Instant gratification:

    require 'erb'
    require 'tilt'
    template = Tilt.new('templates/foo.erb')
    => #<Tilt::ERBTemplate @file="templates/foo.rb" ...>
    output = template.render
    => "Hello world!"

It's recommended that calling programs explicitly require template engine
libraries (like 'erb' above) at load time. Tilt attempts to lazy require the
template engine library the first time a template is created but this is
prone to error in threaded environments.

The `Tilt` module contains generic implementation classes for all supported
template engines. Each template class adheres to the same interface for
creation and rendering. In the instant gratification example, we let Tilt
determine the template implementation class based on the filename, but
`Tilt::Template` implementations can also be used directly:

    template = Tilt::HamlTemplate.new('templates/foo.haml')
    output = template.render

The `render` method takes an optional evaluation scope and locals hash
arguments. Here, the template is evaluated within the context of the
`Person` object with locals `x` and `y`:

    template = Tilt::ERBTemplate.new('templates/foo.erb')
    joe = Person.find('joe')
    output = template.render(joe, :x => 35, :y => 42)

If no scope is provided, the template is evaluated within the context of an
object created with `Object.new`.

A single `Template` instance's `render` method may be called multiple times
with different scope and locals arguments. Continuing the previous example,
we render the same compiled template but this time in jane's scope:

    jane = Person.find('jane')
    output = template.render(jane, :x => 22, :y => nil)

Blocks can be passed to `render` for templates that support running
arbitrary ruby code (usually with some form of `yield`). For instance,
assuming the following in `foo.erb`:

    Hey <%= yield %>!

The block passed to `render` is called on `yield`:

    template = Tilt::ERBTemplate.new('foo.erb')
    template.render { 'Joe' }
    # => "Hey Joe!"

Template Mappings
-----------------

The `Tilt` module includes methods for associating template implementation
classes with filename patterns and for locating/instantiating template
classes based on those associations.

The `Tilt::register` method associates a filename pattern with a specific
template implementation. To use ERB for files ending in a `.bar` extension:

     >> Tilt.register Tilt::ERBTemplate, 'bar'
     >> Tilt.new('views/foo.bar')
     => #<Tilt::ERBTemplate @file="views/foo.bar" ...>

Retrieving the template class for a file or file extension:

     >> Tilt['foo.bar']
     => Tilt::ERBTemplate
     >> Tilt['haml']
     => Tilt::HamlTemplate

It's also possible to register template file mappings that are more specific
than a file extension. To use Erubis for `bar.erb` but ERB for all other `.erb`
files:

     >> Tilt.register Tilt::ErubisTemplate, 'bar.erb'
     >> Tilt.new('views/foo.erb')
     => Tilt::ERBTemplate
     >> Tilt.new('views/bar.erb')
     => Tilt::ErubisTemplate

The template class is determined by searching for a series of decreasingly
specific name patterns. When creating a new template with
`Tilt.new('views/foo.html.erb')`, we check for the following template
mappings:

  1. `views/foo.html.erb`
  2. `foo.html.erb`
  3. `html.erb`
  4. `erb`

### Fallback mode

If there are more than one template class registered for a file extension, Tilt
will automatically try to load the version that works on your machine:

  1. If any of the template engines has been loaded already: Use that one.
  2. If not, it will try to initialize each of the classes with an empty template.
  3. Tilt will use the first that doesn't raise an exception.
  4. If however *all* of them failed, Tilt will raise the exception of the first
     template engine, since that was the most preferred one.

Template classes that were registered *last* would be tried first. Because the
Markdown extensions are registered like this:

    Tilt.register Tilt::BlueClothTemplate, 'md'
    Tilt.register Tilt::RDiscountTemplate, 'md'

Tilt will first try RDiscount and then BlueCloth. You could say that RDiscount
has a *higher priority* than BlueCloth.

The fallback mode works nicely when you just need to render an ERB or Markdown
template, but if you depend on a specific implementation, you should use #prefer:

    # Prefer BlueCloth for all its registered extensions (markdown, mkd, md)
    Tilt.prefer Tilt::BlueClothTemplate
    
    # Prefer Erubis for .erb only:
    Tilt.prefer Tilt::ErubisTemplate, 'erb'

When a file extension has a preferred template class, Tilt will *always* use
that class, even if it raises an exception.

Template Compilation
--------------------

Tilt compiles generated Ruby source code produced by template engines and reuses
it on subsequent template invocations. Benchmarks show this yields a 5x-10x
performance increase over evaluating the Ruby source on each invocation.

Template compilation is currently supported for these template engines:
StringTemplate, ERB, Erubis, Haml, Nokogiri, Builder and Yajl.

LICENSE
-------

Tilt is Copyright (c) 2010 [Ryan Tomayko](http://tomayko.com/about) and
distributed under the MIT license. See the `COPYING` file for more info.

Tilt Templates
==============

(See <https://github.com/rtomayko/tilt/blob/master/TEMPLATES.md> for a rendered,
HTML-version of this file).

While all Tilt templates use the same basic interface for template loading and
evaluation, each varies in its capabilities and available options. Detailed
documentation on each supported template engine is provided below.

There are also some file extensions that have several implementations
(currently ERB and Markdown). These template classes have certain features
which are guaranteed to work across all the implementations. If you wish to be
compatible with all of these template classes, you should only depend on the
cross-implementation features.

 * [ERB](#erb) - Generic ERB implementation (backed by erb.rb or Erubis)
 * [erb.rb](#erbrb) - `Tilt::ERBTemplate`
 * [Erubis](#erubis) - `Tilt::ErubisTemplate`
 * [Haml](#haml) - `Tilt::HamlTemplate`
 * [Liquid](#liquid) - `Tilt::LiquidTemplate`
 * Nokogiri - `Tilt::NokogiriTemplate`
 * Builder - `Tilt::BuilderTemplate`
 * Markaby - `Tilt::MarkabyTemplate`
 * [Radius](#radius) - `Tilt::RadiusTemplate`

Tilt also includes support for CSS processors like [LessCSS][lesscss] and
[Sass][sass], [CoffeeScript][coffee-script] and some simple text formats.

 * Less - `Tilt::LessTemplate`
 * Sass - `Tilt::SassTemplate`
 * Scss - `Tilt::ScssTemplate`
 * CoffeeScript - `Tilt::CoffeeScriptTemplate`
 * [Textile](#redcloth) - `Tilt::RedClothTemplate`
 * Creole - `Tilt::CreoleTemplate`
 * [RDoc](#rdoc) - `Tilt::RDocTemplate`

Tilt has extensive support for Markdown, backed by one of four different
implementations (depending on which are available on your system):

 * [Markdown](#markdown) - Generic Markdown implementation
 * [RDiscount](#rdiscount) - `Tilt::RDiscountTemplate`
 * Redcarpet - `Tilt::RedcarpetTemplate`
 * BlueCloth - `Tilt::BlueClothTemplate`
 * Kramdown - `Tilt::KramdownTemplate`
 * Maruku - `Tilt::MarukuTemplate`

<a name='erb'></a>
ERB (`erb`, `rhtml`)
--------------------

ERB is a simple but powerful template languge for Ruby. In Tilt it's backed by
[Erubis](#erubis) (if installed on your system) or by [erb.rb](#erbrb) (which
is included in Ruby's standard library). This documentation applies to both
implementations.

### Example

    Hello <%= world %>!
    
### Usage

ERB templates support custom evaluation scopes and locals:

    >> require 'erb'
    >> template = Tilt.new('hello.html.erb')
    >> template.render(self, :world => 'World!')
    => "Hello World!"

Or, use `Tilt['erb']` directly to process strings:

    template = Tilt['erb'].new { "Hello <%= world %>!" }
    template.render(self, :world => 'World!')

### Options

#### `:trim => trim`

Omits newlines and spaces around certain lines (usually those that starts with
`<%` and ends with `%>`). There isn't a specification for how trimming in ERB
should work, so if you need more control over the whitespace, you should use
[erb.rb](#erbrb) or [Erubis](#erubis) directly.


#### `:outvar => '_erbout'`

The name of the variable used to accumulate template output. This can be
any valid Ruby expression but must be assignable. By default a local
variable named `_erbout` is used.

<a name='erbrb'></a>
erb.rb (`erb`, `rhtml`)
-----------------------

[ERB](#erb) implementation available in Ruby's standard library.

All the documentation of [ERB](#erb) applies in addition to the following:

### Usage

The `Tilt::ERBTemplate` class is registered for all files ending in `.erb` or
`.rhtml` by default, but with a *lower* priority than ErubisTemplate. If you
specifically want to use ERB, it's recommended to use `#prefer`:

    Tilt.prefer Tilt::ERBTemplate

__NOTE:__ It's suggested that your program `require 'erb'` at load time when
using this template engine within a threaded environment.

### Options

#### `:trim => true`

The ERB trim mode flags. This is a string consisting of any combination of the
following characters:

  * `'>'`  omits newlines for lines ending in `>`
  * `'<>'` omits newlines for lines starting with `<%` and ending in `%>`
  * `'%'`  enables processing of lines beginning with `%`
  * `true` is an alias of `<>`

#### `:safe => nil`

The `$SAFE` level; when set, ERB code will be run in a
separate thread with `$SAFE` set to the provided level.

#### `:outvar => '_erbout'`

The name of the variable used to accumulate template output. This can be
any valid Ruby expression but must be assignable. By default a local
variable named `_erbout` is used.

### See also

  * [ERB documentation](http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html)


<a name='erubis'></a>
Erubis (`erb`, `rhtml`, `erubis`)
---------------------------------

[Erubis][erubis] is a fast, secure, and very extensible implementation of [ERB](#erb).

All the documentation of [ERB](#erb) applies in addition to the following:

### Usage

The `Tilt::ErubisTemplate` class is registered for all files ending in `.erb` or
`.rhtml` by default, but with a *higher* priority than `ERBTemplate`. If you
specifically want to use Erubis, it's recommended to use `#prefer`:

    Tilt.prefer Tilt::ErubisTemplate

__NOTE:__ It's suggested that your program `require 'erubis'` at load time when
using this template engine within a threaded environment.

### Options

#### `:engine_class => Erubis::Eruby`

Allows you to specify a custom engine class to use instead of the
default which is `Erubis::Eruby`.

#### `:escape_html => false`

When `true`, `Erubis::EscapedEruby` will be used as the engine class
instead of the default. All content within `<%= %>` blocks will be
automatically html escaped.

#### `:outvar => '_erbout'`

The name of the variable used to accumulate template output. This can be
any valid Ruby expression but must be assignable. By default a local
variable named `_erbout` is used.

#### `:pattern => '<% %>'`

Set pattern for embedded Ruby code.

#### `:trim => true`

Delete spaces around `<% %>`. (But, spaces around `<%= %>` are preserved.)

### See also

  * [Erubis Home][erubis]
  * [Erubis User's Guide](http://www.kuwata-lab.com/erubis/users-guide.html)


<a name='haml'></a>
Haml (`haml`)
-------------

[Haml][haml] is a markup language thats used to cleanly and simply describe
the HTML of any web document without the use of inline code. Haml functions as
a replacement for inline page templating systems such as PHP, ASP, and ERB, the
templating language used in most Ruby on Rails applications. However, Haml
avoids the need for explicitly coding HTML into the template, because it itself
is a description of the HTML, with some code to generate dynamic content.
([more](http://haml-lang.com/about.html))


### Example

    %html
      %head
        %title= @title
      %body
        %h1
          Hello
          = world + '!'

### Usage

The `Tilt::HamlTemplate` class is registered for all files ending in `.haml`
by default. Haml templates support custom evaluation scopes and locals:

    >> require 'haml'
    >> template = Tilt.new('hello.haml')
    => #<Tilt::HamlTemplate @file='hello.haml'>
    >> @title = "Hello Haml!"
    >> template.render(self, :world => 'Haml!')
    => "
    <html>
      <head>
        <title>Hello Haml!</title>
      </head>
      <body>
        <h1>Hello Haml!</h1>
      </body>
    </html>"

Or, use the `Tilt::HamlTemplate` class directly to process strings:

    >> require 'haml'
    >> template = Tilt::HamlTemplate.new { "%h1= 'Hello Haml!'" }
    => #<Tilt::HamlTemplate @file=nil ...>
    >> template.render
    => "<h1>Hello Haml!</h1>"

__NOTE:__ It's suggested that your program `require 'haml'` at load time when
using this template engine within a threaded environment.

### Options

Please see the [Haml Reference](http://haml-lang.com/docs/yardoc/file.HAML_REFERENCE.html#options) for all available options.

### See also

  * [#haml.docs](http://haml-lang.com/docs.html)
  * [Haml Tutorial](http://haml-lang.com/tutorial.html)
  * [Haml Reference](http://haml-lang.com/docs/yardoc/HAML_REFERENCE.md.html)


<a name='liquid'></a>
Liquid (`liquid`)
-----------------

[Liquid][liquid] is for rendering safe templates which cannot affect the
security of the server they are rendered on.

### Example

    <html>
      <head>
        <title>{{ title }}</title>
      </head>
      <body>
        <h1>Hello {{ world }}!</h1>
      </body>
    </html>

### Usage

`Tilt::LiquidTemplate` is registered for all files ending in `.liquid` by
default. Liquid templates support locals and objects that respond to
`#to_h` as scopes:

    >> require 'liquid'
    >> require 'tilt'
    >> template = Tilt.new('hello.liquid')
    => #<Tilt::LiquidTemplate @file='hello.liquid'>
    >> scope = { :title => "Hello Liquid Templates" }
    >> template.render(nil, :world => "Liquid")
    => "
    <html>
      <head>
        <title>Hello Liquid Templates</title>
      </head>
      <body>
        <h1>Hello Liquid!</h1>
      </body>
    </html>"

Or, use `Tilt::LiquidTemplate` directly to process strings:

    >> require 'haml'
    >> template = Tilt::LiquidTemplate.new { "<h1>Hello Liquid!</h1>" }
    => #<Tilt::LiquidTemplate @file=nil ...>
    >> template.render
    => "<h1>Hello Liquid!</h1>"

__NOTE:__ It's suggested that your program `require 'liquid'` at load
time when using this template engine within a threaded environment.

### See also

  * [Liquid for Programmers](http://wiki.github.com/tobi/liquid/liquid-for-programmers)
  * [Liquid Docs](http://liquid.rubyforge.org/)
  * GitHub: [tobi/liquid](http://github.com/tobi/liquid/)


<a name='radius'></a>
Radius (`radius`)
-----------------

[Radius][radius] is the template language used by [Radiant CMS][radiant]. It is
a tag language designed to be valid XML/HTML.

### Example

    <html>
    <body>
      <h1><r:title /></h1>
      <ul class="<r:type />">
      <r:repeat times="3">
        <li><r:hello />!</li>
      </r:repeat>
      </ul>
      <r:yield />
    </body>
    </html>

### Usage

To render a template such as the one above.

    scope = OpenStruct.new
    scope.title = "Radius Example"
    scope.hello = "Hello, World!"

    require 'radius'
    template = Tilt::RadiusTemplate.new('example.radius', :tag_prefix=>'r')
    template.render(scope, :type=>'hlist'){ "Jackpot!" }

The result will be:

    <html>
    <body>
      <h1>Radius Example</h1>
      <ul class="hlist">
        <li>Hello, World!</li>
        <li>Hello, World!</li>
        <li>Hello, World!</li>
      </ul>
      Jackpot!
    </body>
    </html>

### See also

  * [Radius][radius]
  * [Radiant CMS][radiant]


<a name='textile'></a>
Textile (`textile`)
-------------------

Textile is a lightweight markup language originally developed by Dean Allen and
billed as a "humane Web text generator". Textile converts its marked-up text
input to valid, well-formed XHTML and also inserts character entity references
for apostrophes, opening and closing single and double quotation marks,
ellipses and em dashes.

Textile formatted texts are converted to HTML with the [RedCloth][redcloth]
engine, which is a Ruby extension written in C.

### Example

    h1. Hello Textile Templates
    
    Hello World. This is a paragraph.

### Usage

__NOTE:__ It's suggested that your program `require 'redcloth'` at load time
when using this template engine in a threaded environment.

### See Also

  * [RedCloth][redcloth]


<a name='rdoc'></a>
RDoc (`rdoc`)
-------------

[RDoc][rdoc] is the simple text markup system that comes with Ruby's standard
library.

### Example

    = Hello RDoc Templates

    Hello World. This is a paragraph.

### Usage

__NOTE:__ It's suggested that your program `require 'rdoc/markup'` and
`require 'rdoc/markup/to_html'` at load time when using this template
engine in a threaded environment.

### See also

 * [RDoc][rdoc]


<a name='markdown'></a>
Markdown (`markdown`, `md`, `mkd`)
----------------------------------

[Markdown][markdown] is a lightweight markup language, created by John Gruber
and Aaron Swartz. For any markup that is not covered by Markdowns syntax, HTML
is used.  Marking up plain text with Markdown markup is easy and Markdown
formatted texts are readable.

Markdown formatted texts are converted to HTML with one of these libraries:

  * [RDiscount](#rdiscount) - `Tilt::RDiscountTemplate`
  * Redcarpet - `Tilt::RedcarpetTemplate`
  * BlueCloth - `Tilt::BlueClothTemplate`
  * Kramdown - `Tilt::KramdownTemplate`
  * Maruku - `Tilt::MarukuTemplate`

Tilt will use fallback mode (as documented in the README) for determining which
library to use. RDiscount has highest priority - Maruku has lowest. 

### Example

    Hello Markdown Templates
    ========================

    Hello World. This is a paragraph.

### Usage

To wrap a Markdown formatted document with a layout:

    layout = Tilt['erb'].new do
      "<!doctype html><title></title><%= yield %>"
    end
    data = Tilt['md'].new { "# hello tilt" }
    layout.render { data.render }
    # => "<!doctype html><title></title><h1>hello tilt</h1>\n"

### Options

Every implementation of Markdown *should* support these options, but there are
some known problems with the Kramdown and Maruku engines.

#### `:smartypants => true|false`

Set `true` to enable [Smarty Pants][smartypants]
style punctuation replacement.

#### `:escape_html => true|false`

Set `true` disallow raw HTML in Markdown contents. HTML is converted to
literal text by escaping `<` characters.

### See also

 * [Markdown Syntax Documentation](http://daringfireball.net/projects/markdown/syntax/)

<a name='rdiscount'></a>
RDiscount (`markdown`, `md`, `mkd`)
-----------------------------------

[Discount][discount] is an implementation of the Markdown markup language in C.
[RDiscount][rdiscount] is a Ruby wrapper around Discount.

All the documentation of [Markdown](#markdown) applies in addition to the following:

### Usage

The `Tilt::RDiscountTemplate` class is registered for all files ending in
`.markdown`, `.md` or `.mkd` by default with the highest priority. If you
specifically want to use RDiscount, it's recommended to use `#prefer`:

    Tilt.prefer Tilt::RDiscountTemplate

__NOTE:__ It's suggested that your program `require 'erubis'` at load time when
using this template engine within a threaded environment.

### See also

  * [Discount][discount]
  * [RDiscount][rdiscount]
  * GitHub: [rtomayko/rdiscount][rdiscount]


[lesscss]: http://lesscss.org/ "Less CSS"
[sass]: http://sass-lang.com/ "Sass"
[coffee-script]: http://jashkenas.github.com/coffee-script/ "Coffee Script"
[erubis]: http://www.kuwata-lab.com/erubis/ "Erubis"
[haml]: http://haml-lang.org/ "Haml"
[liquid]: http://www.liquidmarkup.org/ "Liquid"
[radius]: http://radius.rubyforge.org/ "Radius"
[radiant]: http://radiantcms.org/ "Radiant CMS"
[redcloth]: http://redcloth.org/ "RedCloth"
[rdoc]: http://rdoc.rubyforge.org/ "RDoc"
[discount]: http://www.pell.portland.or.us/~orc/Code/discount/ "Discount"
[rdiscount]: http://github.com/rtomayko/rdiscount/ "RDiscount"
[smartypants]: http://daringfireball.net/projects/smartypants/ "Smarty Pants"


# Search Emoji codes using Alfred 2

This simple workflow lets you search emoji codes.

Usage: `emoji <query>`

After you hit `enter` the code of the selected emoji will be copied to your
clipboard.

[DOWNLOAD](https://github.com/carlosgaldino/alfred-emoji-workflow/blob/master/package/emoji-codes.alfredworkflow?raw=true)

![](http://f.cl.ly/items/1B1h0d0c093m3G2f0H1a/Screen%20Shot%202013-04-03%20at%2012.08.18%20AM.png)

--------------------------------------------------------------------------------
File:         Image/ExifTool/README

Description:  ExifTool support modules documentation

The ExifTool support modules are loaded by ExifTool to allow processing of
various meta information formats.

The tables in these files are used as lookups based on the tag ID values.  The
hash keys are the tag IDs (in decimal or hexadecimal if the ID is numerical as
with EXIF tables, or the tag name if the ID is ASCII as with XMP tables).  In
the case of a BinaryData table, the IDs are numerical and specify offsets into
the binary data block (floating point IDs allow multiple tags for the same
offset, with the integer part being used for the offset).  The corresponding
hash value provides information about the tag (explained later).

Twenty-five special keys (TABLE_NAME, SHORT_NAME, PROCESS_PROC, WRITE_PROC,
CHECK_PROC, GROUPS, FORMAT, FIRST_ENTRY, TAG_PREFIX, PRINT_CONV, WRITABLE,
TABLE_DESC, NOTES, IS_OFFSET, IS_SUBDIR, EXTRACT_UNKNOWN, NAMESPACE, PREFERRED,
SRC_TABLE, PRIORITY, WRITE_GROUP, LANG_INFO, VARS, DATAMEMBER and SET_GROUP1)
are used to provide additional information about a table. The special keys have
names that are all capitalized to avoid possible conflicts with tag keys.  Below
is an explanation of the meaning of each special key:

  TABLE_NAME : Name of this table (set by GetTagTable()).

  SHORT_NAME : Table name with leading "Image::ExifTool::" removed.

  PROCESS_PROC : Reference to a function used to process the directory for this
  table.  If PROCESS_PROC is not given, \&Image::ExifTool::Exif::ProcessExif is
  assumed (except for QuickTime atoms for which
  \&Image::ExifTool::QuickTime::ProcessMOV is the default).  If PROCESS_PROC is
  set to 0, the tags are not added to the lookup. The process proc returns 1 on
  success or 0 on failure, and takes 3 arguments: 0) reference to the ExifTool
  object, 1) reference to a directory information hash (with the following
  entries:), 2) reference to the tag table hash.

    Name        - Tag name for this SubDirectory entry (for verbose messages)
    Base        - Base offset for pointers from start of file
    DataPt      - Reference to data block containing directory (may be undef)
    DataPos     - Position of data block within file (relative to Base)
    DataLen     - Length of data block in bytes
    DirStart    - Offset to start of directory from start of data block
    DirLen      - Length of directory data within block
    DirName     - Name of this directory
    OutFile     - Output file or scalar reference
    Parent      - Name of parent directory
    RAF         - Reference to File::RandomAccess object if available
    NewDataPos  - File position of new data (write proc only)
    Fixup       - Reference to hash of offset fixups (used in EXIF writing only)
    FixBase     - Flag set to attempt to fix base offsets
    FixOffsets  - Evaluated for each value pointer to patch maker note offsets
    LastIFD     - Used by WriteExif() to return offset of last IFD written
    ImageData   - Used by WriteExif() to avoid buffering large image data blocks

  WRITE_PROC : Reference to a function to write all new tags for this directory.
  The write proc returns the new directory data or undefined on error.  It takes
  the same arguments as the process proc above except that the second argument
  (reference to directory information hash) is optional, and if specified gives
  information about the source directory for tags to be copied to the output.

  CHECK_PROC : Reference to a function which validates Raw values for writing.
  The function takes three arguments: 0) ExifTool object reference, 1) tagInfo
  reference, 2) value reference, and returns undefined (and possibly modifies
  the input value) if successful, or an error message if there was a format
  problem.  May set ExifTool CHECK_WARN datamember for success with a warning.

  GROUPS : A hash lookup for the default group names for all entries in this
  table. If not specified, the Group 0 and 1 names will be set automatically
  according to the name of the module.

  FORMAT : Specifies the default tag Format, and corresponding pointer increment
  for entries in a BinaryData table.  Defaults to 'int8u' if not specified.  The
  possible values of FORMAT are:

    int8s       - Signed 8-bit integer                    (EXIF 'SBYTE')
    int8u       - Unsigned 8-bit integer                  (EXIF 'BYTE')
    int16s      - Signed 16-bit integer                   (EXIF 'SSHORT')
    int16u      - Unsigned 16-bit integer                 (EXIF 'SHORT')
    int16uRev   - Unsigned 16-bit integer, reversed byte order
    int32s      - Signed 32-bit integer                   (EXIF 'SLONG')
    int32u      - Unsigned 32-bit integer                 (EXIF 'LONG')
    int64s      - Signed 64-bit integer                   (BigTIFF 'SLONG8')
    int64u      - Unsigned 64-bit integer                 (BigTIFF 'LONG8')
    rational32s - Rational consisting of 2 int16s values
    rational32u - Rational consisting of 2 int16u values
    rational64s - Rational consisting of 2 int32s values  (EXIF 'SRATIONAL')
    rational64u - Rational consisting of 2 int32u values  (EXIF 'RATIONAL')
    fixed16s    - Signed 16-bit fixed point value
    fixed16u    - Unsigned 16-bit fixed point value
    fixed32s    - Signed 32-bit fixed point value
    fixed32u    - Unsigned 32-bit fixed point value
    float       - 32-bit IEEE floating point value        (EXIF 'FLOAT')
    double      - 64-bit IEEE floating point value        (EXIF 'DOUBLE')
    extended    - 80-bit extended floating float
    ifd         - Unsigned 32-bit integer sub-IFD pointer (EXIF 'IFD')
    ifd64       - Unsigned 64-bit integer sub-IFD pointer (BigTIFF 'IFD8')
    string      - Series of 8-bit ASCII characters        (EXIF 'ASCII')
    undef       - Undefined-format binary data            (EXIF 'UNDEFINED')
    binary      - Binary data

  Additionally, the following variable-length Format types may be used in
  individual tag information hashes of a BinaryData table.  The 'var_' formats
  cause subsequent tag indices to be incremented according to the size of the
  data, not including the terminator.  See "Format" below for more details.

    pstring     - Pascal string
    var_string  - variable-length null-terminated ASCII string
    var_ustring - variable-length null-terminated UCS-2 string
    var_pstring - variable-length Pascal string
    var_pstr32  - variable-length Pascal string /w 32-bit len
    var_int16u  - variable-length undef data with int6u count

  FIRST_ENTRY : Specifies the index for the first tag entry in a binary table.
  This value is only used if the Unknown option is set to 2 or higher, and
  allows the binary data to be scanned for unknown tag entries.

  TAG_PREFIX : Prefix for names of unknown tags.

  PRINT_CONV : Default print conversion for tags where PrintConv isn't
  specified.  PrintConv may be set to undef for individual tags to disable print
  conversion when PRINT_CONV is defined for a table.

  WRITABLE : Indicates that all tags in this table are writable.  This is the
  same as setting the Writable flag for each individual tag in the table, except
  for SubDirectory tags which are not made Writable.

  TABLE_DESC : Short description for this table.  Plain text only.  Used only
  for XML tag database output.

  NOTES : Notes to introduce the table in the TagNames documentation.  Pod
  formatting codes B<> and C<> may be used in this text.

  IS_OFFSET : Reference to list of sorted TagID's representing offsets for
  writable binary data tables only.  Not used for EXIF tables.

  IS_SUBDIR : BinaryData tables only.  A reference to a list of sorted tag ID's
  representing subdirectories.  Required for writable subdirectories only.

  EXTRACT_UNKNOWN : Used in PDF tables to specify a directory where all unknown
  tags should be extracted.  Set to 0 to extract only unknown numbered tags for
  which the unnumbered tag is known.

  NAMESPACE : Namespace prefix for tags in the XMP table.  If this isn't a
  standard namespace defined in %Image::ExifTool::XMP::nsURI, then the URI must
  be defined as well (however, this is not recommended for pre-defined
  namespaces because then non-standard namespace prefixes won't be recognized). 
  To define the URI, the NAMESPACE value is a reference to a hash where the key
  is the namespace prefix and and the value is the URI (alternatively, a
  reference to a 2-element array containing the prefix and URI is also allowed
  for backward compatibility).  The NAMESAPCE value may be undef for XMP tables
  where tags have variable namespaces (in this case each tag must have a
  Namespace entry).

  PREFERRED : Set to true if the tags in this table should always be added when
  writing information.  Overrides the order specified by SetNewGroups().  When
  this feature is used, it may also be desireable to specify a preferred group
  when calling InitWriteDirs() to write these tags; this avoids creating other
  directories for tags which are already being creating in the preferred group.

  SRC_TABLE : Used internally to store the source table name of a user-defined
  tag table so the appropriate module can be loaded as required.

  PRIORITY : Default Priority for all tags in this table.

  WRITE_GROUP : Default WriteGroup for all tags in the table.

  LANG_INFO : Code reference to a routine which returns a reference to a
  language-specific tag information hash.  The routine takes two arguments: a
  reference to the non-specific tagInfo hash, and the language code. Used only
  in tables with writable tags which support tag name language extensions (ie.
  MIE and XMP).

  VARS : Hash used to store additional parameters.  Individual modules may use
  this to store any parameters they want.  The following additional parameters
  have been defined, and may be used by any module:

    ID_LABEL      Label to use instead of "Tag ID" for column heading in tag
                  name documentation.  When this is set, numerical TagID's are
                  not converted to hexadecimal notation. Unless otherwise set,
                  an ID_LABEL of "Index" is assumed for tables which use
                  ProcessBinaryData.

    NO_ID         Avoid printing "Tag ID" column in tag name documentation.

    HEX_ID        Print tag ID in hexadecimal (with 4 hex digits or more).

    NO_LOOKUP     Do not add tags to TagLookup.pm lookup tables.

    CAPTURE       Used by PDF module to name dictionaries to capture when
                  writing.

    MINOR_ERRORS  [EXIF tables only] Flag to make errors in this IFD minor, or
                  to downgrade already minor errors to warnings while writing.
                  (Errors in MakerNote IFD's are already classified as minor.)
                  Note that for certain types errors, the response is to delete
                  the entire IFD from the image.

    NUMBERS_LAST  Sort numerical tags after character tags in documentation.

    LONG_TAGS     Suppress "Long tags" warning when generating documentation.
                  Value is the number of long tag names to expect.

  DATAMEMBER : BinaryData tables only.  A reference to a list of sorted tag ID's
  which must be extracted as data members when writing.  Must also list "var_"
  format tags and tags with Hook so offsets are properly calculated if the table
  is writable.

  SET_GROUP1 : [EXIF tables only] Flag to set group1 name to the directory name
  for all tags in the table.

The remaining entries in a tag table are the tag IDs with their associated
information.  The information may exist in one of three forms:  1) A simple
scalar which is the name of the tag, 2) A reference to a hash of information
describing this tag, or 3) a reference to a list of hashes which contain
Condition expressions allowing the appropriate hash to be selected to suit the
conditions.  The following is a description of possible hash entries.  All
entries are optional, except for the tag Name which is required if the tag ID is
numerical.

  Name          : The tag name.  Tag names need not be unique.  If they aren't
                  unique, then duplicate tags will hide the values of previous
                  tags when extracting information unless the Duplicates option
                  is set or the new tag has lower Priority.  With Duplicates
                  set, to allow multiple tags with the same name to exist in the
                  tag information hash, the key of the previous tag is changed
                  to the form "TagName (N)", where N starts at 1 and increments
                  for subsequent duplicate tags.  A tag name should start with
                  an uppercase letter, and contain only the charcters in the set
                  [A-Za-z0-9_-].  If not given, the Name is taken from the tag
                  ID with the first character changed to upper case.

  Description   : A more readable description of tag name.  If a tag doesn't
                  specify a Description, then the tag Name is used instead, with
                  spaces inserted between the words.

  Notes         : Notes for this tag in the HTML TagNames documentation.

  Groups        : Hash lookup for group names for this tag.

  Format        : Only valid for BinaryData, EXIF and IPTC tables. For a Binary
                  or EXIF table, this gives the format that is used to convert
                  the binary data, and is one of the FORMAT types specified
                  above.  If not specified, the Format of an EXIF entry is taken
                  from the EXIF information, and the Format of a BinaryData
                  entry is taken from the FORMAT specified for the table (or
                  int8u if FORMAT is not specified).  Must be specified for
                  Writable tags where the value must be converted for a
                  Condition.  For BinaryData tables, the format may have a size
                  in trailing brackets which is a Perl expression to be
                  evaluated. The expression may access any of the previous table
                  entries through a %val hash (read-only tags), the data size
                  via $size, or the ExifTool object via $self.  For example,
                  'string[$val{3}]' defines a string with length given by the
                  table entry with tag index '3'.  An initial "var_" may be
                  added to the Format name of any BinaryData tag with a size in
                  brackets.  In this case, subsequent offsets are adjusted by
                  the value length minus the size of the default table FORMAT
                  (ie. "var_int16u[10]" causes subsequent offsets to be
                  incremented by sizeof(int16u) * 10 - sizeof(int8u) if the
                  default table FORMAT is "int8u").  Note that all "var_" Format
                  tags (as well as tags with values used within "var_" Format
                  expressions) must have corresponding DATAMEMBER entries.

  Count         : Used when writing EXIF information to specify the number
                  values to write, or the number of characters in a fixed-length
                  string.  A value of -1 indicates that the count is variable
                  and should be determined by the number of values provided.
                  Note that this count that corresponds to the specified Format,
                  so if a different-sized Writable format is defined, the actual
                  count written to the file will be different.

  FixCount      : Flag set to determine correct count from offsets in IFD.  This
                  is necessary for some Kodak tags which write an incorrect
                  Count value.

  Flags         : Flags to specify characteristics for this tag.  May be a
                  simple scalar flag name, a reference to a list of flag names,
                  or a reference to a hash of flag/value pairs.  If not a hash
                  reference, the flag value is set to 1.  Flags are expanded for
                  faster access at run time into members of the tagInfo hash,
                  and may be written directly as members if desired. The
                  available flag names are:

                  'AutoSplit' - [List tags only] Similar to ListSplit option,
                  but applied automatically to individual tags.  Value specifies
                  pattern for split, or 1 for default pattern ',?\\s+'.

                  'Avoid' - avoid creating this tag if possible.  This is only
                  effective if another tag exists with the same name.  Setting
                  this flag also sets the default Priority to 0 for this tag.

                  'Binary' - set to 1 for binary data.  This has the same effect
                  as setting ValueConv to '\$val', but it it a bit cleaner and
                  avoids dummy ValueConvInv entries for writable tags.  Has no
                  effect if ValueConv is defined for the tag.  Some values may
                  be treated as binary data even if this flag is not set.

                  'BlockExtract' - set for writable directories in EXIF
                  information which are extracted by default.  Otherwise
                  writable directories are only extracted as a block if
                  specified explicitly.

                  'DataMember' - name of exiftool data member associated with
                  this tag if it should be stored as a special data member when
                  writing information.  Necessary only if the value of the tag
                  affects other written information.  Currently only used for
                  tags in EXIF tables where it triggers the execution of the
                  RawConv to convert and stores the value as an ExifTool data
                  member when writing.

                  'DataTag' - associated tag name containing data for offset or
                  byte count tags.

                  'Drop' - set to 1 for tags that should be excluded when
                  rebuilding maker notes when copying all tags.  Set to a number
                  larger than 1 to drop only if data is larger than this size.
                  Works for SubDirectory tags too.

                  'EntryBased' - set to 1 if the offset for this value is based
                  on the IFD entry position.  This allows individual values to
                  be entry-based even though some others aren't (as with the
                  Casio PrintIM information).

                  'Flat' - [flattened XMP structure tags only] must be set for
                  all pre-defined flattened tags (including user-defined
                  flattened tags).  This flag is reset to 0 internally after all
                  associated flattened tags in the structure have been
                  generated.

                  'Flattened' - [reserved] used internally to mark Struct tags
                  which have been processed to generate flattened equivalents.

                  'GotGroups' - [reserved] flag used internally to indicate that
                  the Groups hash has been initialized for this tag.

                  'Hidden' - set to hide tag from the TagName documentation. 
                  Also suppresses verbose output of a BinaryData tag.

                  'IsOffset' - flag set if the tag represents an offset to some
                  data, and causes value will be adjusted to an absolute file
                  offset.  If set to 2, the offset base of the parent directory
                  is used even if the base changes for the current directory
                  (only some maker notes are this messed up).  Set to 3 if
                  absolute file offsets are used.  May be set to an expression
                  to be evaluated.  Expression may access $val and $exifTool,
                  and is evaluated only when reading.

                  'List' - flag indicating that duplicate entries of this tag
                  are allowed, and will be accumulated in a list.  Note that for
                  XMP information, 3 different types of lists are supported and
                  the List value specifies the type: 'Bag', 'Seq' or 'Alt'.  As
                  well, a value of '1' is used internally in XMP to allow list
                  behaviour for a flattened tag which is itself not a list
                  element (ie. a member of list of structures).  Note that in
                  ExifTool an XMP lang-alt tag (Writable="lang-alt") is NOT a
                  list-type tag (unless it is a list of lang-alt lists, which is
                  uncommon).

                  'MakerNotes' - set if this tag is maker note data.

                  'MakerPreview' - set in the PreviewImageStart tag information
                  if the preview must be stored inside the maker notes.

                  'Mandatory' - set for mandatory tags.  Used only by TagInfoXML
                  and documentation purposes.  Mandatory tags may be added
                  automatically by ExifTool.

                  'NestedHtmlDump' - flag set if value for this tag is also
                  dumped when processing the SubDirectory.  This flag is implied
                  if the MakerNotes flag is set.  Set to 2 if the dump should
                  only be underlined if nested inside other maker notes.

                  'NotIFD' - set for 'MakerNotes' SubDirectory tags only if the
                  SubDirectory is not EXIF IFD format.  (Note: All SubDirectory
                  tags in the MakerNotes table are 'MakerNotes' type by
                  default.)

                  'OffsetPair' - set if the tag represents half of an offset/
                  byte count pair.  Data for these tags must be handled
                  separately.  Value is the tagID for the paired tag.

                  'Permanent' - flag indicates that a tag is permanent, and
                  can't be added or deleted from the file, although a new value
                  may be written if the tag already exists.  By default, all
                  MakerNotes tags are permanent unless otherwise specified.

                  'PrintHex' - specifies that unknown PrintConv values should
                  be printed in hex (ie. 'Unknown (0x01)').  Also causes
                  numerical tag values to be printed in hex in the HTML tag name
                  documentation.

                  'PrintString' - flag set to force PrintConv values to be
                  printed as strings in the documentation.

                  'Priority' - gives the priority of this tag while reading.  If
                  set to zero, this tag will not override the value of previous
                  tags with the same name.  If the priority is greater than
                  zero, this tag won't be overridden by subsequent tags unless
                  their priority is equal to or greater than this priority.  A
                  special feature is that Priority 0 tags are automatically
                  incremented to Priority 1 if they exist in the IFD of the full
                  resolution image (as determined by SubfileType).  If not
                  defined, the priority defaults to 1 for all tags except except
                  tags in IFD1 of JPEG images which default to priority 0.

                  'Protected' - bit mask to protect tags from writing:
                  Bit 0x01 indicates an 'unsafe' tag, which is not set via
                  SetNewValuesFromFile() unless specified explicitly.
                  Bit 0x02 indicates a 'protected' tag, which should not be set
                  directly by the user.

                  'PutFirst' - [EXIF only] flag to place this value before IFD0
                  when writing (ie. immediately after TIFF header).  Only used
                  for main IFD's (IFD0, IFD1, etc) and IFD's where SubIFD flag
                  is set to 2 (currently only ExifIFD).

                  'RawJoin' - [List tags only] Joins raw List-type tag values
                  into a single string with a space separator, allowing
                  ValueConv and PrintConv to act on the concatenated string so
                  the tag does not exhibit list-type behaviour.  When writing,
                  the inverse is performed and the value is split at whitespace.

                  'Resource' - [XMP only] flag to write value as an rdf:resource
                  in an empty element instead of as a normal string.

                  'SeparateTable' - set to list PrintConv values in a separate
                  table in the HTML documentation.  Value is 1 for a table name
                  of 'Module TagName', or 'TAG' for 'Module TAG', or 'MODULE
                  TAG' to fully specify the table name.  The table may have a
                  'Notes' entry for a description of the table.

                  'SetResourceName' - [Photoshop tags only] set to 1 to append
                  resource name to the extracted value (ie. 'VALUE/#NAME#/').
                  Also allows resource name to be appended when writing new
                  values.  May be set to any value other than 1 for a default
                  resource name to use when writing if an appended name is not
                  provided.

                  'StructType' - [reserved] used internally by XMP writer for
                  flattened structure tags as a flag to indicate that one or
                  more enclosing structures has a TYPE field.

                  'SubDoc' - [Composite tags only] set to cause this Composite
                  tag to also be generated for each sub-document.  To achieve
                  this, 'Main:' and 'Doc#:' prefixes are added to all Require'd
                  and Desire'd tag names which don't already start with 'Main:'
                  or 'Doc#:', and the Composite tag is built once for each of
                  the main document and all sub-documents.

                  'SubIFD' - used in writing to determine that the tag specifies
                  an offset to a sub-IFD.  When this flag is set, the Group1
                  name gives the name of the IFD.  Must be set if and only if
                  the tag has a SubDirectory Start that references '$val' (this
                  is validated by BuildTagLookup).  Set to 2 for standard EXIF
                  SubIFD's where the PutFirst flag is valid.

                  'Unknown' - this is an unknown tag (only extracted when the
                  Unknown option is set).

                  'WrongBase' - ['IsOffset' tags only] An expression using $self
                  that is evaluated to generate a base shift for 'IsOffset' tags
                  which use a different base than the rest of the tags.

  RawConv       : Used to convert the Raw value at extraction time (while the
                  image file is still open, unlike ValueConv and PrintConv below
                  which are done later only if the value is requested).  May be
                  a scalar expression using $val (the Raw tag value), $self (the
                  current ExifTool object), $tag (the tag key) and $tagInfo
                  (reference to the tag information hash) or a code reference
                  with $val and $self as arguments.  For Composite tags, $val is
                  a reference to a hash of source ("derived from") tag names,
                  and @val may be used to access the Raw values of these tags.
                  The returned value may be a scalar which is used as the new
                  Raw value, a scalar reference to a binary data value, a hash
                  reference for Composite tags, an ARRAY reference for a list of
                  values, or undefined to indicate that the tag should be
                  ignored.  If RawConv is specified for a Composite tag, then
                  ValueConv and PrintConv evals will no longer have access to
                  the source @val and @prt values unless the input $val is
                  returned.  RawConv may generate Warning or Error tags, while
                  ValueConv and PrintConv may not. Note: RawConv should only be
                  used if necessary (in general, only if the conversion may
                  return undef to ignore the tag) because ValueConv is more
                  efficient since it is only executed if the tag value is
                  requested, while RawConv is executed for all extracted tags.

  ValueConv     : Used to convert the Raw value to a useable form. May be a hash
                  reference to act as a lookup table, a scalar which is
                  evaluated as a Perl expression, or a code reference to a
                  subroutine.  May also be a list reference, in which case the
                  value is split at whitespace into a list of items and each
                  item is converted by the associated entry in the ValueConv
                  list.  If a hash reference is used and the Raw value doesn't
                  appear as one of the keys, then the converted value is set to
                  "Unknown (X)", where X is the Raw value (unless either of the
                  special keys exist: 'BITMASK', a reference to a hash used to
                  decode individual value bits; or 'OTHER', a reference to a
                  subroutine used to convert unknown values.  The OTHER
                  subroutine takes 3 arguments: the value, a flag which is set
                  for the inverse conversion, and a reference to the PrintConv
                  hash, and returns the converted value or undef on error.  The
                  lookup hash may also contain a 'Notes' entry which is used for
                  documentation if the SeparateTable flag is set).  In an
                  expression, $self is a reference to the current ExifTool
                  object, $val is the Raw value, and $tag is the tag key.  The
                  subroutine takes 2 arguments: the Raw value and a reference to
                  the current ExifTool object.  The expression or subroutine is
                  evaluated when and if the tag value is requested (ie. only
                  after all extraction is complete), so if necessary at this
                  time the values of all other tags are available via calls to
                  $self->GetValue("Tag","Raw"). (Note: In theory, types other
                  than "Raw" may be accessed, but they are slower and may lead
                  to cyclical dependencies so they should be avoided). When
                  evaluated, the expression or subroutine returns a scalar for
                  the converted value, a SCALAR reference to a binary data value
                  (see the 'Binary' flag), or an ARRAY reference for a list of
                  values.  The return value should always be defined -- use
                  RawConv instead to return undef if it is necessary to test the
                  value for validity, otherwise an undef tag may hide a
                  previously defined value when the Duplicates option is not
                  enabled.  If this isn't possible (as with Composite tags where
                  the converted values of the source tags are needed), set the
                  Priority to 0 to avoid taking priority over a valid tag.  If
                  ValueConv is not specified, the Raw value is not converted.
                  Composite tags which Require or Desire other tags may access
                  the ValueConv, PrintConv and Raw values of these tags through
                  the elements of the @val, @prt and @raw lists respectively
                  (only if there was no RawConv or it returned a hash
                  reference).  For these tags, $val may be used in an expression
                  to represent $val[0], and the first argument passed for a code
                  reference is a reference to @val.

  PrintConv     : This entry is similar to ValueConv above, except that it is
                  used to further convert the tag value to a human readable
                  form.  It can be either a hash lookup, a scalar Perl
                  expression, a code reference or a list reference.  In this
                  expression, $self, $val and $tag may be used as with
                  ValueConv, but if ValueConv was defined then $val is the
                  ValueConv value instead of the Raw value.  The returned value
                  should always be defined.  Note that the print conversion is
                  only done if the PrintConv option is enabled (which it is by
                  default), and if the result of the ValueConv is not a scalar
                  reference.  If it is a list reference, then the converted
                  values are joined by '; ' in the output string.

  RawConvInv    : The inverse of RawConv.  This should only be used in very rare
                  situations when the raw value can not be predetermined.
                  Unlike the other inverse conversions which are applied in
                  SetNewValue(), this conversion is applied in WriteInfo() as
                  the file is being written.  This is important because it means
                  that FILE_TYPE and any DataMember tags ocurring before this
                  tag in the file are available.  Beware that if the return
                  value is not defined, the tag will be deleted unless there is
                  specific logic to avoid this (currently, only EXIF and Binary
                  data directories handle this case).

  ValueConvInv  : The inverse of ValueConv.  Only necessary for Writable tags
                  when ValueConv is specified (except WriteAlso tags).  Note
                  that DataMember tags may NOT be used in the inverse
                  conversions because these conversions are done before the
                  input file is parsed.  Instead, a Condition or RawConvInv must
                  be used.  May return undef on conversion error and call warn()
                  to issue a warning.  If warn() is not called, a generic
                  warning is generated when undef is returned.  An empty warning
                  ("\n") may be issued to suppress warning messages when undef
                  is returned.  If a scalar, the expression may use the
                  variables $val, $self and $wantGroup.  If a code ref, the
                  routine is passed 2 arguments: $val and $self.  Note that this
                  conversion is not applied for deleted tags (ie. $val is
                  undef).

  PrintConvInv  : The inverse of PrintConv.  Only necessary if for Writable tags
                  when PrintConv is specified (unless WriteAlso is used).  See
                  ValueConvInv above for more details.

  PrintConvColumns : Number of columns for PrintConv lookup in HTML docs. If not
                  set, the number of columns is determined automatically
                  according to the maximum width of the entries.

  DelValue      : Raw value to be used when deleting a permanent tag.  (Note all
                  MakerNotes tags are permanent.)  If not specified, an attempt
                  is made to convert an empty string for the raw value.

  Relist        : [Only if ValueConv or PrintConv is a list ref] Reference to a
                  list of original value indices used to reorganize values. Each
                  entry in the list may be a scalar index, or a reference to a
                  list of indices to join values.  (Currently values may be
                  joined, but the order of writable values must not be changed
                  until this ability is added to the writer.)

  Mask          : [BinaryData tags only] Bitmask for this value.  (Multiple tags
                  may have the same index by using floating point indices.  An
                  unknown tag will only be generated for a certain TagID if
                  there is no integral TagID for that tag.)  The Mask is applied
                  before evaluating RawConv.  When Mask is used, PrintHex=1 is
                  implied unless otherwise defined.

  Condition     : If given, specifies scalar which is evaluated as a Perl
                  expression at extraction time to decide whether the tag is
                  valid.  If used in a list of alternate tag definitions, the
                  first list entry with a true condition is taken.  If no
                  condition exists, then a 'true' condition is assumed.  The
                  expression may use $self to access the ExifTool object.  The
                  first 128 bytes of the raw data value are accessible through
                  the reference $valPt for EXIF, Jpeg2000 and BinaryData tags
                  only (note that for BinaryData tags, the raw data of $$valPt
                  is always 'undef' type, and may not be used when writing
                  except for SubDirectory tags).  EXIF tags may also reference
                  the format string and value count through $format and $count.
                  Note that if the value is writable and $valPt is used, the tag
                  must have a Format (unless 'undef' or 'string'), and a Count
                  (unless 1 or length of the 'undef' or 'string'), so the raw
                  data may be generated for evaluating the Condition.  When
                  writing, $valPt, $format and $count refer to the new value,
                  except for MakerNotes tags where $format and $count refer to
                  the old tag if it existed.

  Require       : [Composite tags only] A hash reference specifying the tags
                  required to calculate the Composite tag value.  The hash
                  values are the names of the required tags, and the keys
                  specify the indices where the tag values are stored in the
                  @val list used in the ValueConv and/or PrintConv expression.
                  The Composite value is only calculated if the values for all
                  Require'd tags are defined.  Require, Desire and Inhibit tag
                  names may be prefixed by an optional group family 0 or 1 name
                  followed by a colon.  Case IS significant.  The keys used by
                  the Require, Desire and Inhibit hashes must not overlap (since
                  they are used as indices into the common @val, @prt and @raw
                  lists), and together the keys must be sequential starting from
                  0.  A special feature allows a scalar tag name to be used
                  instead of the hash reference when only the 0th tag is
                  defined.  For example, the following two definitions are
                  equivalent:

                        Require => { 0 => 'XMP:Title' },
                        Require => 'XMP:Title',

  Desire        : [Composite tags only] This is the same as Require except that
                  the Composite value is calculated even if the specified tags
                  don't exist.  Beware that the elements of @val, @prt and @raw
                  may be undefined for Desire'd tags.  If no tags are Require'd,
                  at least one of the Desire'd tags must exist for the Composite
                  tag to be generated.

  Inhibit       : [Composite tags only] Similar to the Require and Desire
                  hashes, except that the Composite tag is NOT built if any of
                  the Inhibit tags exist.

  Shift         : [Writable tags only] Specifies type of shift to apply if this
                  value may be shifted.  Set to 'Time' for shifting date/time
                  tags.

  Writable      : Indicates this tag can be written (or not written if Writable
                  is set to zero), and for EXIF-type tables gives format for
                  writing.  Writable may be set to 1 for MakerNotes information
                  because the existing format is always used, however providing
                  a format is desireable because it is used in validating the
                  value.  For EXIF tables, the Writable flag may be different
                  than the Format flag, in which case Format is used for
                  converting the binary value and Writable specifies the format
                  code written to the EXIF IFD.  For SubDirectories in EXIF
                  information, this flag is only defined if the SubDirectory is
                  writable as a block, or if the SubDirectory can not be edited
                  (in which case Writable is set to 0).  If non-zero, the
                  SubDirectory is also extracted as a block, so the Binary and
                  Protected flags should usually set as well.  There is
                  currently no way to specify a write format for a SubDirectory
                  that is not writable as a block (the default is 'int32u' for
                  IFD-type SubDirectories, and 'undef' for all others).

  WriteAlso     : Used for writable tag to specify other tags to write when this
                  tag is written.  The value is a hash reference.  The hash keys
                  are the names of the tags to write, and the values are
                  evaluated to obtain the ValueConv values of each tag (or undef
                  to delete the tag).  In the eval, $val is the Raw value of the
                  parent tag (which may be undef if the tag is being deleted),
                  and the %opts hash may be accessed to modify SetNewValue
                  options for each tag.  By default, Type is set to "ValueConv"
                  and the Protected option has bit 0x02 set to allow writing of
                  Protected tags that aren't directly writable.  The AddValue
                  and DelValue options from the parent tag are also defined, but
                  no other options are set by default.  Previous new values of
                  WriteAlso tags have already been removed prior to the eval if
                  the Replace option was used for the parent tag.  If an empty
                  warning is issued ("\n"), the target tag is not written and no
                  error is reported.

  WriteCheck    : If given, specifies a scalar which is evaluated as a Perl
                  expression for a one-time validatation the Raw value being
                  written.  The expression has access to 3 variables: $val is
                  the value to be written, $self is the ExifTool object, and
                  $tagInfo is the tag information hash reference.  It returns an
                  error string, or undef if the value is good.  If the error
                  string is empty, the tag is not written and no warnings are
                  issued, but WriteAlso is still evaluated if it exists.

  WriteOnly     : Flag set if tag is write-only.  Used for documentation only.

  DelCheck      : Similar to WriteCheck, but called when the tag is deleted. The
                  expression may access $self, $tagInfo and $wantGroup.  Returns
                  error string, or undef on success, and may set $val to
                  something other than undef.  May return empty string ('') to
                  suppress warning messages but not delete tag (ie. when
                  deleting only associated tags).

  WriteCondition: [Writable EXIF tags only] Specifies a condition to be
                  evaluated before the tag can be written to a specific file.
                  The condition may use $self to reference the ExifTool object,
                  and returns true if it is OK for writing.  Unlike WriteCheck
                  which is done only once when the new value is set, this
                  condition is evaluated just before the tags of the specific
                  SubDirectory are written.

  WriteGroup    : [Writable EXIF tags only] Specifies the IFD where the
                  information gets written by default.  Must be defined for
                  writable EXIF tags if WRITE_GROUP is not specified in table.

  IsOverwriting : [Writable EXIF tags only] Specifies reference to subroutine
                  which determines if tag should be overwritten.  Arguments are:
                  0) ExifTool object ref, 1) new value hash ref, 2) old value,
                  3) new value reference.

  AllowGroup    : [Writable tags only] Regular expression string (case
                  insensitive) to match group names which are allowed when
                  writing this tag.  Only needed if tag can be written to
                  groups other than the normal groups for this tag (very rare).

  OffsetPair    : Used in EXIF table to specify the tagID for the corresponding
                  offset or length tag.

  DataTag       : Used in EXIF table to specify the tag name of the data
                  associated with offset/length tags.

  FixFormat     : [Writable EXIF SubIFD SubDirectory's only] Used to specify a
                  format for writing an IFD pointer other than 'int32u'.

  ChangeBase    : [EXIF tags in JPEG images only] Eval used to return new base
                  for the offset for this tag only.  Eval may use $dirStart and
                  $dataPos.  Note this is geared to the quirky Leica preview
                  image offset, and is only used if the preview is outside the
                  APP1 EXIF segment.

  Struct        : [XMP tags only] Reference to structure hash for structured XMP
                  tags.  See "STRUCTURES" section below for more details.  (For
                  backward compatibility, this may be a name to an entry in
                  %Image::ExifTool::UserDefined::xmpStruct, but this use is
                  deprecated.)  Flattened tags are automatically generated for
                  each field in the structure.  Note that Struct tags can NOT
                  have ValueConv/PrintConv entries, because values that are HASH
                  references are are also used by Composite tags, which use the
                  the Conv entries to generate the Composite value.

  NoSubStruct   : [XMP tags only] Flag set in flattened tag to break cyclical
                  recursion in nested structures.

  Namespace     : [XMP tags only] Gives standard XMP namespace prefix to use for
                  this tag.  If not defined, the tag table NAMESPACE is used.

  FlatName      : [Struct tags and structure fields only] Name used for
                  automatically-generated flattened tag names, defaults to Name
                  if not specified.  In general, this is used to remove the
                  redundant names found in some specifications.  May be empty
                  ('') for a Struct tag but not for a structure field.

  Units         : [MIE tags only] Reference to a list of valid units strings.
                  The default units are the first item in the list.

  Hook          : [BinaryData tags only] Expression to be evaluated when
                  extracting tag to allow dynamic Format, etc for BinaryData
                  tags.  May access $self, and assign a new value to $format to
                  dynamically set the tag format, and/or increment $varSize to
                  add a byte offset to subsequent tags.  $varSize may be set to
                  a large number to effectively abort processing of the
                  directory after this tag.  Must have corresponding DATAMEMBER
                  entry in writable tables.

  TagID         : [reserved] Used internally to save the table key for this tag.
                  Note: For XMP tables this corresponds to the XMP property
                  name, but the table key may have a full XMP namespace prefix
                  added.

  NewTagID      : [reserved] Used internally to save new ID of tag in Composite
                  table if it is different that the original TagID (happens if
                  there was a conflict with an existing entry in the table)

  Index         : [reserved] Used internally to save the index of tagInfo items
                  which are in a conditional list.

  Table         : [reserved] Reference to parent tag table.

  PropertyPath  : [reserved] Used internally by XMP writer to save property path
                  name.  Also used in structure field information hashes, but
                  for these the full property path is not stored.

  SrcTagInfo    : [reserved] Used internally by XMP module to store reference to
                  default language tagInfo hash for alternate-language tags.

  RootTagInfo   : [reserved] Used internally to store a reference to the tag
                  information hash of the top-level structure for flattened
                  structure tags.

  Module        : [reserved] Used internally to store module name for writable
                  Composite tags.

  LangCode      : [reserved] Used internally to indicate language code for
                  alternate language tags (ie. 'fr').  Only used with formats
                  which support alternate languages (ie. XMP, MIE, etc).

  SubDirectory {  If it exists, this specifies the start of a new subdirectory.
                  It contains a collection of variables which specify the type
                  and location of the subdirectory.  These variables are
                  described below:

     TagTable   : Specifies the name of the tag table lookup for the new
                  subdirectory.  If not specified, the parent tag table is used.

     Start      : The offset to the start of the subdirectory relative to the
                  current Base.  This is a Perl expression which may use
                  $valuePtr to represent the location of the tag value in the
                  file, or $val for the value itself.  If not specified, a Start
                  of '$valuePtr' is assumed.

     OffsetPt   : [EXIF directories only] If specified, this is a Perl
                  expression that gives the position of a 32-bit word in the
                  current directory that is added to the Start position to get
                  the position of the new subdirectory.  The expression
                  should use the position of the current tag ($valuePtr).

     Base       : This specifies the base offset for all pointers in the
                  subdirectory.  This need not be specified if the offset is the
                  same as the current directory, which is normally the case.
                  May use $start to represent the subdirectory start location
                  relative to the current base, and $base for the value of the
                  current base.  If this is defined, the automatic validation of
                  base offsets is disabled for maker notes directories.  The
                  IFD is flagged as using relative offsets when writing if
                  '$start' is used in this expression.

     EntryBased : [EXIF directories only] Flag indicating that the offsets are
                  based on the individual directory entry position, so offsets
                  are incremented by 12 times the corresponding entry index.

     MaxSubdirs : Maximum number of subdirectories specified by the current tag
                  (if the tag specifies multiple values).  If not specified, the
                  tag value ($val) is used as-is.  If MaxSubdirs is specified,
                  then one subdirectory is parsed for each value found up to the
                  maximum number specified.  Ignored when writing.

     ByteOrder  : Specifies byte ordering if different than than the rest of the
                  file.  Must be either BigEndian, LittleEndian or Unknown.  If
                  Unknown is specified, the byte order will be determined from
                  the directory count (however, this can not be done if OffsetPt
                  is specified).

     Validate   : If given, specifies Perl expression which is used to validate
                  the subdirectory data.  The following variables may be used in
                  the expression: $val (value of the tag), $dirData (reference
                  to directory data), $subdirStart (offset to subdirectory
                  start) and $size (size of subdirectory).  Returns true if
                  subirectory is valid.

     ProcessProc: If given, specifies processing procedure used to decode this
                  subdirectory data.  This overrides the default procedure
                  specified by PROCESS_PROC in the tag table.

     WriteProc  : If given, specifies processing procedure used to write this
                  subdirectory data.  This overrides the default procedure
                  specified by WRITE_PROC in the tag table.

     DirName    : Name of this subdirectory.  If not specified, the name is
                  taken from the tag name.  DirName is important because it is
                  used when writing to compare against names in the directory
                  map to determine which directories need to be edited.

     FixBase    : Flag set if base offsets should be fixed.  Used to add a
                  constant to maker notes offsets to fix damage done by some
                  image editing utilities. (maker notes only)  Set to 2 for
                  unknown maker notes to be a bit more flexible in adjusting
                  the base offset.

     AutoFix    : Flag set to patch GE makernote offset quirks and apply FixBase
                  without warnings when writing.

     FixOffsets : Expression to evaluate for each value pointer to patch
                  problems with some EXIF maker note offsets.  May access the
                  following variables: $valuePtr, $valEnd, $size, $tagID and
                  $wFlag.  May return undef when writing to ignore the entry.

     RelativeBase:[EXIF directories only] Flag to adjust all offsets relative
                  to the start of the IFD when writing.

     Multi      : [EXIF directories only] Flag to allow multiple linked IFD's.
                  1 is assumed if DirName is IFD0 or SubIFD unless otherwise
                  defined.

     Magic      : [TiffIFD directories only] Magic number used in TIFF-like
                  header.
  }

STRUCTURES

Structure hashes are very similar to tag tables in that their keys are structure
field ID's and their values are structure field information hashes.  The special
keys in structure hashes are:

  NAMESPACE   : Same as in tag tables, but may be set to undef for a
                variable-namespace structure which holds any top-level tag. This
                is mandatory for built-in tags, but optional for user-defined
                tags (where it defaults to the NAMESPACE of the tag table).

  STRUCT_NAME : Name of structure (used in warning messages and documentation).
                May contain leading module name separated by a space to avoid
                name conflicts with same-named structures in other modules.
                Default module is "XMP" unless otherwise specified.

  TYPE        : rdf:type resource for structure.

  NOTES       : Notes for documentation.

  GROUPS      : Same as in tag table, but only the family 2 group name is used,
                as the default for the flattened tags.

The contained structure field information hashes are similar to tag information
hashes, except that only the following elements are used:

  Raw/Value/PrintConv (and their inverses), TagID (optional), Groups, List,
  Writable, Struct, Namespace, LangCode, PropertyPath.

But note that for PropertyPath, only the element of the path corresponding to
the specific field is stored (including any necessary list properties).  The
full property path is obtained by walking the structure tree.

Flattened tags corresponding to each field in a structure are automatically
generated (using an on-demand approach to reduce startup overhead).  Pre-defined
flattened tags are allowed, and are used when it is necessary to change the Name
or Description of a flattened tag.  The flattened tag information hash entries
are copied from the corresponding structure field definitions, even for
pre-defined flattened tags.  The exception is that the List property is
generated automatically unless explicity set to 0 in a pre-defined flattened
tag.

--------------------------------------------------------------------------------

ExifTool by Phil Harvey (phil at owl.phy.queensu.ca)
----------------------------------------------------------------------------

ExifTool is a customizable set of Perl modules plus a full-featured
application for reading and writing meta information in a wide variety of
files, including the maker note information of many digital cameras by
various manufacturers such as Canon, Casio, FLIR, FujiFilm, GE, HP,
JVC/Victor, Kodak, Leaf, Minolta/Konica-Minolta, Nikon, Olympus/Epson,
Panasonic/Leica, Pentax/Asahi, Phase One, Reconyx, Ricoh, Samsung, Sanyo,
Sigma/Foveon and Sony.

Below is a list of file types and meta information formats currently
supported by ExifTool (r = read, w = write, c = create):

  File Types
  ------------+-------------+-------------+-------------+------------
  3FR   r     | EIP   r     | LNK   r     | OTF   r     | RTF   r
  3G2   r     | EPS   r/w   | M2TS  r     | PAC   r     | RW2   r/w
  3GP   r     | ERF   r/w   | M4A/V r     | PAGES r     | RWL   r/w
  ACR   r     | EXE   r     | MEF   r/w   | PBM   r/w   | RWZ   r
  AFM   r     | EXIF  r/w/c | MIE   r/w/c | PCD   r     | RM    r
  AI    r/w   | EXR   r     | MIFF  r     | PDF   r/w   | SO    r
  AIFF  r     | F4A/V r     | MKA   r     | PEF   r/w   | SR2   r/w
  APE   r     | FFF   r/w   | MKS   r     | PFA   r     | SRF   r
  ARW   r/w   | FLA   r     | MKV   r     | PFB   r     | SRW   r/w
  ASF   r     | FLAC  r     | MNG   r/w   | PFM   r     | SVG   r
  AVI   r     | FLV   r     | MODD  r     | PGF   r     | SWF   r
  BMP   r     | FPX   r     | MOS   r/w   | PGM   r/w   | THM   r/w
  BTF   r     | GIF   r/w   | MOV   r     | PLIST r     | TIFF  r/w
  CHM   r     | GZ    r     | MP3   r     | PICT  r     | TTC   r
  COS   r     | HDP   r/w   | MP4   r     | PMP   r     | TTF   r
  CR2   r/w   | HDR   r     | MPC   r     | PNG   r/w   | VRD   r/w/c
  CRW   r/w   | HTML  r     | MPG   r     | PPM   r/w   | VSD   r
  CS1   r/w   | ICC   r/w/c | MPO   r/w   | PPT   r     | WAV   r
  DCM   r     | IDML  r     | MQV   r     | PPTX  r     | WDP   r/w
  DCP   r/w   | IIQ   r/w   | MRW   r/w   | PS    r/w   | WEBP  r
  DCR   r     | IND   r/w   | MXF   r     | PSB   r/w   | WEBM  r
  DFONT r     | INX   r     | NEF   r/w   | PSD   r/w   | WMA   r
  DIVX  r     | ITC   r     | NRW   r/w   | PSP   r     | WMV   r
  DJVU  r     | J2C   r     | NUMBERS r   | QTIF  r     | WV    r
  DLL   r     | JNG   r/w   | ODP   r     | RA    r     | X3F   r/w
  DNG   r/w   | JP2   r/w   | ODS   r     | RAF   r/w   | XCF   r
  DOC   r     | JPEG  r/w   | ODT   r     | RAM   r     | XLS   r
  DOCX  r     | K25   r     | OFR   r     | RAR   r     | XLSX  r
  DV    r     | KDC   r     | OGG   r     | RAW   r/w   | XMP   r/w/c
  DVB   r     | KEY   r     | OGV   r     | RIFF  r     | ZIP   r
  DYLIB r     | LA    r     | ORF   r/w   | RSRC  r     |

  Meta Information
  ----------------------+----------------------+---------------------
  EXIF           r/w/c  |  CIFF           r/w  |  Ricoh RMETA    r
  GPS            r/w/c  |  AFCP           r/w  |  Picture Info   r
  IPTC           r/w/c  |  Kodak Meta     r/w  |  Adobe APP14    r
  XMP            r/w/c  |  FotoStation    r/w  |  MPF            r
  MakerNotes     r/w/c  |  PhotoMechanic  r/w  |  Stim           r
  Photoshop IRB  r/w/c  |  JPEG 2000      r    |  APE            r
  ICC Profile    r/w/c  |  DICOM          r    |  Vorbis         r
  MIE            r/w/c  |  Flash          r    |  SPIFF          r
  JFIF           r/w/c  |  FlashPix       r    |  DjVu           r
  Ducky APP12    r/w/c  |  QuickTime      r    |  M2TS           r
  PDF            r/w/c  |  Matroska       r    |  PE/COFF        r
  PNG            r/w/c  |  GeoTIFF        r    |  AVCHD          r
  Canon VRD      r/w/c  |  PrintIM        r    |  ZIP            r
  Nikon Capture  r/w/c  |  ID3            r    |  (and more)

See html/index.html for more details about ExifTool features.

ExifTool can be downloaded from

  Main server URL:  http://owl.phy.queensu.ca/~phil/exiftool/
  Alternate URL:    http://130.15.24.87/~phil/exiftool/

Note:  Please do not make links to the alternate URL above, because this
server is not permanent.

RUNNING

The exiftool script can be run right away without the need to install
Image::ExifTool.  For example, from within the exiftool directory you can
extract the information from one of the included test files by typing:

  ./exiftool t/images/ExifTool.jpg

If you move the exiftool script to a different directory, you must also
either move the contents of the lib directory or install the Image::ExifTool
package so the script can find the necessary libraries.

Note:  If you are using the Windows cmd shell, you may need to rename
'exiftool' to 'exiftool.pl' to run it directly from the command line.
Alternatively, you can run exiftool with the command 'perl exiftool'.

IF YOU ARE STILL CONFUSED

The exiftool script is a command line application.  You run it by typing
commands in a terminal window.  The first step is to determine the name of
the directory where you downloaded the ExifTool distribution package.
Assuming, for example, you downloaded it to a folder called "Desktop" in
your home directory, then you would type the following commands in a
terminal window to extract and run ExifTool:

  cd ~/Desktop
  gzip -dc Image-ExifTool-#.##.tar.gz | tar -xf -
  cd Image-ExifTool-#.##
  ./exiftool t/images/ExifTool.jpg

Note: You must replace "#.##" in the above commands with the actual version
number of ExifTool that you downloaded.  These commands extract meta
information from one of the test images.  To use one of your images instead,
enter the full path name of your file in place of "t/images/ExifTool.jpg".

INSTALLATION

You can install the Image::ExifTool package to make it available for use by
other Perl scripts by typing the following:

  perl Makefile.PL
  make
  make test
  make install

Notes:
  i) You need root access for the last step above.

  ii) Some Perl installations (like the standard OSX installation) may not
  contain the necessary files to complete the first step above.  But no
  worries:  You can install ExifTool manually by moving 'exiftool' and the
  'lib' directory to any directory in your current PATH (ie. /usr/bin).

  iii) In Windows, "dmake" or "nmake" may be used if "make" is not
  available.  The "nmake" utility may be downloaded from Microsoft at
  http://support.microsoft.com/default.aspx?scid=kb;en-us;Q132084 but note
  that is utility is very old, and may not work with Makefiles generated by
  newer Perl versions.

(Also see html/install.html for more help with installation.)

DEPENDENCIES

Requires Perl version 5.004 or later.  No other special libraries are
required, however the following modules are recommended for decoding
compressed and/or encrypted information from the indicated file types, and
for calculating digest values for some information types:

  Archive::Zip         (ZIP, DOCX, PPTX, XLSX, ODP, ODS, ODT, EIP, iWork)
  Compress::Zlib       (DNG, PNG, PDF, DCM, MIE and SWF files)
  Digest::MD5          (PDF files, IPTC information, and JPG Extended XMP)
  Digest::SHA          (PDF with AES-256 encryption)
  IO::Compress::Bzip2  (RWZ files)
  Win32API::File::Time (enables writing of FileCreateDate in Windows)

COPYRIGHT AND LICENSE

Copyright 2003-2013, Phil Harvey

This is free software; you can redistribute it and/or modify it under the
same terms as Perl itself.

DISTRIBUTION FILES

Below is a list of the files/directories included in the full ExifTool
distribution package:

  Changes                   - Revision history
  ExifTool_config           - Sample run-time configuration file
  MANIFEST                  - Full list of distribution files
  META.yml                  - Standard CPAN dependency file
  Makefile.PL               - Makefile for installation
  README                    - This file
  arg_files/                - Argument files to convert metadata formats:
    exif2iptc.args          - Arguments for converting EXIF to IPTC
    exif2xmp.args           - Arguments for converting EXIF to XMP
    gps2xmp.args            - Arguments for converting GPS to XMP
    iptc2exif.args          - Arguments for converting IPTC to EXIF
    iptc2xmp.args           - Arguments for converting IPTC to XMP
    iptcCore.args           - Complete list of IPTC Core XMP tags
    pdf2xmp.args            - Arguments for converting PDF to XMP
    xmp2exif.args           - Arguments for converting XMP to EXIF
    xmp2gps.args            - Arguments for converting XMP to GPS
    xmp2iptc.args           - Arguments for converting XMP to IPTC
    xmp2pdf.args            - Arguments for converting XMP to PDF
  config_files/             - Sample ExifTool configuration files:
    convert_regions.config  - Config file for converting face regions
  exiftool                  - The exiftool application (Perl script)
  fmt_files/                - Output formatting example files:
    gpx.fmt                 - Format file for creating GPX track
    gpx_wpt.fmt             - Format file for creating GPX waypoints
    kml.fmt                 - Format file for creating KML output files
  html/                     - HTML documentation
  html/TagNames/            - HTML tag name documentation
  lib/                      - ExifTool Perl library modules
  perl-Image-ExifTool.spec  - Red Hat Packaging Manager specification file
  t/                        - Verification test code
  t/images/                 - Verification test images

ADDITIONAL INFORMATION

Read the following files included in the full distribution for more
information:

  html/index.html           - Main ExifTool documentation
  html/install.html         - Installation instructions
  html/history.html         - Revision history
  html/ExifTool.html        - API documentation
  html/TagNames/index.html  - Tag name documentation
  html/geotag.html          - Geotag feature
  html/faq.html             - Frequently asked questions
  html/filename.html        - Renaming/moving files
  html/metafiles.html       - Working with metadata sidecar files
  html/struct.html          - Working with structured XMP information
  lib/Image/ExifTool/README - ExifTool library modules documentation

and if you have installed Image::ExifTool, you can also consult perldoc or
the man pages:

  perldoc exiftool
  perldoc Image::ExifTool
  perldoc Image::ExifTool::TagNames

  man exiftool
  man Image::ExifTool
  man Image::ExifTool::TagNames

Note: If the man pages don't work, it is probably because your man path is
not set to include the installed documentation.  See "man man" for
information about how to set the man path.

----------------------------------------------------------------------------

# alfred-workflow [![Build Status](https://travis-ci.org/zhaocai/alfred-workflow.png?branch=master)](https://travis-ci.org/zhaocai/alfred-workflow)

* home  :: http://zhaocai.github.com/alfred2-ruby-template/
* rdoc  :: http://rubydoc.info/gems/alfred-workflow/
* code  :: https://github.com/zhaocai/alfred-workflow
* bugs  :: https://github.com/zhaocai/alfred-workflow/issues


## DESCRIPTION:

alfred-workflow is a ruby Gem helper for building [Alfred](http://www.alfredapp.com) workflow.


## FEATURES:

* Use standard [bundler][gembundler] to easily package, manage, and update ruby gems in the workflow.
* Friendly exception and debug output to the Mac OS X Console.
* Automate saving and loading cached feedback
* Automate rescue feedback items to alfred when something goes wrong.
* Functions to easily load and save user configuration (in YAML)
* Functions for smart case query filter of feedback results.
* Functions for finding the bundle ID, cache and storage paths, and query arguments.
* Functions for reading and writing plist files.
* Functions to simplify generating feedback XML for Alfred.

## INSTALL:

`gem install alfred-workflow`

## USAGE:

* Refer to [alfred2-ruby-template]( https://github.com/zhaocai/alfred2-ruby-template ) for examples and detailed instruction. Also refer to some of the example projects:

* [alfred2-top-workflow]( https://github.com/zhaocai/alfred2-top-workflow )
* [alfred2-google-workflow]( https://github.com/zhaocai/alfred2-google-workflow )
* [alfred2-sourcetree-workflow]( https://github.com/zhaocai/alfred2-sourcetree-workflow )

## SYNOPSIS:

### The Basic
```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

Alfred.with_friendly_error do |alfred|
  fb = alfred.feedback

  fb.add_file_item(File.expand_path "~/Applications/")

  puts fb.to_alfred(ARGV)
end
```

Code are wrapped in `Alfred.with_friendly_error` block. Exceptions and debug messages are logged to Console log file **~/Library/Logs/Alfred-Workflow.log**.

### With rescue feedback automatically generated!

```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

def my_code_with_something_goes_wrong
  true
end

Alfred.with_friendly_error do |alfred|
  alfred.with_rescue_feedback = true

  fb = alfred.feedback

  if my_code_with_something_goes_wrong
    raise Alfred::NoBundleIDError, "Wrong Bundle ID Test!"
  end
end
```

![rescue feedback](https://raw.github.com/zhaocai/alfred2-ruby-template/master/screenshots/rescue%20feedback.png)


### Automate saving and loading cached feedback
```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

Alfred.with_friendly_error do |alfred|
  alfred.with_rescue_feedback = true
  alfred.with_cached_feedback do
    # expire in 1 hour
    use_cache_file :expire => 3600
    # use_cache_file :file => "/path/to/your/cache_file", :expire => 3600
  end

  if fb = alfred.feedback.get_cached_feedback
    # cached feedback is valid
    puts fb.to_alfred
  else 
    fb = alfred.feedback
    # ... generate_feedback as usually
    fb.put_cached_feedback
  end
end
```






## Troubleshooting




## DEVELOPERS:

After checking out the source, run:

  $ rake newb

This task will install any missing dependencies, run the tests/specs,
and generate the RDoc.

## LICENSE:

Copyright (c) 2013 Zhao Cai <caizhaoff@gmail.com>

This program is free software: you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see <http://www.gnu.org/licenses/>.


[gembundler]: http://gembundler.com/
[alfredapp]: http://www.alfredapp.com

= All-purpose Property List manipulation library

Plist is a library to manipulate Property List files, also known as plists.  It can parse plist files into native Ruby data structures as well as generating new plist files from your Ruby objects.

== Usage

=== Parsing

  result = Plist::parse_xml('path/to/example.plist')

  result.class
  => Hash

  "#{result['FirstName']} #{result['LastName']}"
  => "John Public"

  result['ZipPostal']
  => "12345"

==== Example Property List

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
          <key>FirstName</key>
          <string>John</string>

          <key>LastName</key>
          <string>Public</string>

          <key>StreetAddr1</key>
          <string>123 Anywhere St.</string>

          <key>StateProv</key>
          <string>CA</string>

          <key>City</key>
          <string>Some Town</string>

          <key>CountryName</key>
          <string>United States</string>

          <key>AreaCode</key>
          <string>555</string>

          <key>LocalPhoneNumber</key>
          <string>5551212</string>

          <key>ZipPostal</key>
          <string>12345</string>
  </dict>
  </plist>

=== Generation

plist also provides the ability to generate plists from Ruby objects.  The following Ruby classes are converted into native plist types:
  Array, Bignum, Date, DateTime, Fixnum, Float, Hash, Integer, String, Symbol, Time, true, false

* +Array+ and +Hash+ are both recursive; their elements will be converted into plist nodes inside the <array> and <dict> containers (respectively).
* +IO+ (and its descendants) and +StringIO+ objects are read from and their contents placed in a <data> element.
* User classes may implement +to_plist_node+ to dictate how they should be serialized; otherwise the object will be passed to <tt>Marshal.dump</tt> and the result placed in a <data> element.  See below for more details.

==== Creating a plist

There are two ways to generate complete plists.  Given an object:

  obj = [1, :two, {'c' => 0xd}]

If you've mixed in <tt>Plist::Emit</tt> (which is already done for +Array+ and +Hash+), you can simply call +to_plist+:

  obj.to_plist

This is equivalent to calling <tt>Plist::Emit.dump(obj)</tt>.  Either one will yield:

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <array>
      <integer>1</integer>
      <string>two</string>
      <dict>
        <key>c</key>
        <integer>13</integer>
      </dict>
  </array>
  </plist>

You can also dump plist fragments by passing +false+ as the second parameter:

  Plist::Emit.dump('holy cow!', false)
  => "<string>holy cow!</string>"

==== Custom serialization

If your class can be safely coerced into a native plist datatype, you can implement +to_plist_node+.  Upon encountering an object of a class it doesn't recognize, the plist library will check to see if it responds to +to_plist_node+, and if so, insert the result of that call into the plist output.

An example:

  class MyFancyString
    ...

    def to_plist_node
      return "<string>#{self.defancify}</string>"
    end
  end

When you attempt to serialize a +MyFancyString+ object, the +to_plist_node+ method will be called and the object's contents will be defancified and placed in the plist.

If for whatever reason you can't add this method, your object will be serialized with <tt>Marshal.dump</tt> instead.

== Links

[Project Page]  http://plist.rubyforge.org
[GitHub]        http://github.com/bleything/plist
[RDoc]          http://plist.rubyforge.org

== Credits

plist is maintained by Ben Bleything <mailto:ben@bleything.net> and Patrick May <mailto:patrick@hexane.org>.  Patrick wrote most of the code; Ben is a recent addition to the project, having merged in his plist generation library.

Other folks who have helped along the way:

[<b>Martin Dittus</b>] who pointed out that +Time+ wasn't enough for plist <tt>Dates</tt>, especially those in <tt>~/Library/Cookies/Cookies.plist</tt>
[<b>Chuck Remes</b>] who pushed Patrick towards implementing <tt>#to_plist</tt>
[<b>Mat Schaffer</b>] who supplied code and test cases for <tt><data></tt> elements
[<b>Michael Granger</b>] for encouragement and help
[<b>Carsten Bormann, Chris Hoffman, Dana Contreras, Hongli Lai, Johan Srensen</b>] for contributing Ruby 1.9.x compatibility fixes

== License and Copyright

plist is released under the MIT License.

Portions of the code (notably the Rakefile) contain code pulled and/or adapted from other projects.  These files contain a comment at the top describing what was used.

=== MIT License

Copyright (c) 2006-2010, Ben Bleything <ben@bleything.net> and Patrick May <patrick@hexane.org>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY
KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


# Alfred 2 workflow for Packagist

<div><img src="screenshot.png"></div>

**[Download!](https://github.com/skyzyx/packagist.alfredworkflow/raw/master/packagist.alfredworkflow)**
Requires [Alfred 2 and the Powerpack](http://www.alfredapp.com/powerpack/).

Updates can be found and installed using **[Alleyoop](http://alfred.daniel.sh/Workflows/Alleyoop.alfredworkflow)**.

CHANGELOG
=========

3.3.1 (2013-03-10)
------------------

* Added the ability to create PHP streaming responses from HTTP requests
* Bug fix: Running any filters when parsing response headers with service descriptions
* Bug fix: OauthPlugin fixes to allow for multi-dimensional array signing, and sorting parameters before signing
* Bug fix: Removed the adding of default empty arrays and false Booleans to responses in order to be consistent across
  response location visitors.
* Bug fix: Removed the possibility of creating configuration files with circular dependencies
* RequestFactory::create() now uses the key of a POST file when setting the POST file name
* Added xmlAllowEmpty to serialize an XML body even if no XML specific parameters are set

3.3.0 (2013-03-03)
------------------

* A large number of performance optimizations have been made
* Bug fix: Added 'wb' as a valid write mode for streams
* Bug fix: `Guzzle\Http\Message\Response::json()` now allows scalar values to be returned
* Bug fix: Fixed bug in `Guzzle\Http\Message\Response` where wrapping quotes were stripped from `getEtag()`
* BC: Removed `Guzzle\Http\Utils` class
* BC: Setting a service description on a client will no longer modify the client's command factories.
* BC: Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using
  the 'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'
* BC: `Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to
  lowercase
* Operation parameter objects are now lazy loaded internally
* Added ErrorResponsePlugin that can throw errors for responses defined in service description operations' errorResponses
* Added support for instantiating responseType=class responseClass classes. Classes must implement
  `Guzzle\Service\Command\ResponseClassInterface`
* Added support for additionalProperties for top-level parameters in responseType=model responseClasses. These
  additional properties also support locations and can be used to parse JSON responses where the outermost part of the
  JSON is an array
* Added support for nested renaming of JSON models (rename sentAs to name)
* CachePlugin
    * Added support for stale-if-error so that the CachePlugin can now serve stale content from the cache on error
    * Debug headers can now added to cached response in the CachePlugin

3.2.0 (2013-02-14)
------------------

* CurlMulti is no longer reused globally. A new multi object is created per-client. This helps to isolate clients.
* URLs with no path no longer contain a "/" by default
* Guzzle\Http\QueryString does no longer manages the leading "?". This is now handled in Guzzle\Http\Url.
* BadResponseException no longer includes the full request and response message
* Adding setData() to Guzzle\Service\Description\ServiceDescriptionInterface
* Adding getResponseBody() to Guzzle\Http\Message\RequestInterface
* Various updates to classes to use ServiceDescriptionInterface type hints rather than ServiceDescription
* Header values can now be normalized into distinct values when multiple headers are combined with a comma separated list
* xmlEncoding can now be customized for the XML declaration of a XML service description operation
* Guzzle\Http\QueryString now uses Guzzle\Http\QueryAggregator\QueryAggregatorInterface objects to add custom value
  aggregation and no longer uses callbacks
* The URL encoding implementation of Guzzle\Http\QueryString can now be customized
* Bug fix: Filters were not always invoked for array service description parameters
* Bug fix: Redirects now use a target response body rather than a temporary response body
* Bug fix: The default exponential backoff BackoffPlugin was not giving when the request threshold was exceeded
* Bug fix: Guzzle now takes the first found value when grabbing Cache-Control directives

3.1.2 (2013-01-27)
------------------

* Refactored how operation responses are parsed. Visitors now include a before() method responsible for parsing the
  response body. For example, the XmlVisitor now parses the XML response into an array in the before() method.
* Fixed an issue where cURL would not automatically decompress responses when the Accept-Encoding header was sent
* CURLOPT_SSL_VERIFYHOST is never set to 1 because it is deprecated (see 5e0ff2ef20f839e19d1eeb298f90ba3598784444)
* Fixed a bug where redirect responses were not chained correctly using getPreviousResponse()
* Setting default headers on a client after setting the user-agent will not erase the user-agent setting

3.1.1 (2013-01-20)
------------------

* Adding wildcard support to Guzzle\Common\Collection::getPath()
* Adding alias support to ServiceBuilder configs
* Adding Guzzle\Service\Resource\CompositeResourceIteratorFactory and cleaning up factory interface

3.1.0 (2013-01-12)
------------------

* BC: CurlException now extends from RequestException rather than BadResponseException
* BC: Renamed Guzzle\Plugin\Cache\CanCacheStrategyInterface::canCache() to canCacheRequest() and added CanCacheResponse()
* Added getData to ServiceDescriptionInterface
* Added context array to RequestInterface::setState()
* Bug: Removing hard dependency on the BackoffPlugin from Guzzle\Http
* Bug: Adding required content-type when JSON request visitor adds JSON to a command
* Bug: Fixing the serialization of a service description with custom data
* Made it easier to deal with exceptions thrown when transferring commands or requests in parallel by providing
  an array of successful and failed responses
* Moved getPath from Guzzle\Service\Resource\Model to Guzzle\Common\Collection
* Added Guzzle\Http\IoEmittingEntityBody
* Moved command filtration from validators to location visitors
* Added `extends` attributes to service description parameters
* Added getModels to ServiceDescriptionInterface

3.0.7 (2012-12-19)
------------------

* Fixing phar detection when forcing a cacert to system if null or true
* Allowing filename to be passed to `Guzzle\Http\Message\Request::setResponseBody()`
* Cleaning up `Guzzle\Common\Collection::inject` method
* Adding a response_body location to service descriptions

3.0.6 (2012-12-09)
------------------

* CurlMulti performance improvements
* Adding setErrorResponses() to Operation
* composer.json tweaks

3.0.5 (2012-11-18)
------------------

* Bug: Fixing an infinite recursion bug caused from revalidating with the CachePlugin
* Bug: Response body can now be a string containing "0"
* Bug: Using Guzzle inside of a phar uses system by default but now allows for a custom cacert
* Bug: QueryString::fromString now properly parses query string parameters that contain equal signs
* Added support for XML attributes in service description responses
* DefaultRequestSerializer now supports array URI parameter values for URI template expansion
* Added better mimetype guessing to requests and post files

3.0.4 (2012-11-11)
------------------

* Bug: Fixed a bug when adding multiple cookies to a request to use the correct glue value
* Bug: Cookies can now be added that have a name, domain, or value set to "0"
* Bug: Using the system cacert bundle when using the Phar
* Added json and xml methods to Response to make it easier to parse JSON and XML response data into data structures
* Enhanced cookie jar de-duplication
* Added the ability to enable strict cookie jars that throw exceptions when invalid cookies are added
* Added setStream to StreamInterface to actually make it possible to implement custom rewind behavior for entity bodies
* Added the ability to create any sort of hash for a stream rather than just an MD5 hash

3.0.3 (2012-11-04)
------------------

* Implementing redirects in PHP rather than cURL
* Added PECL URI template extension and using as default parser if available
* Bug: Fixed Content-Length parsing of Response factory
* Adding rewind() method to entity bodies and streams. Allows for custom rewinding of non-repeatable streams.
* Adding ToArrayInterface throughout library
* Fixing OauthPlugin to create unique nonce values per request

3.0.2 (2012-10-25)
------------------

* Magic methods are enabled by default on clients
* Magic methods return the result of a command
* Service clients no longer require a base_url option in the factory
* Bug: Fixed an issue with URI templates where null template variables were being expanded

3.0.1 (2012-10-22)
------------------

* Models can now be used like regular collection objects by calling filter, map, etc
* Models no longer require a Parameter structure or initial data in the constructor
* Added a custom AppendIterator to get around a PHP bug with the `\AppendIterator`

3.0.0 (2012-10-15)
------------------

* Rewrote service description format to be based on Swagger
    * Now based on JSON schema
    * Added nested input structures and nested response models
    * Support for JSON and XML input and output models
    * Renamed `commands` to `operations`
    * Removed dot class notation
    * Removed custom types
* Broke the project into smaller top-level namespaces to be more component friendly
* Removed support for XML configs and descriptions. Use arrays or JSON files.
* Removed the Validation component and Inspector
* Moved all cookie code to Guzzle\Plugin\Cookie
* Magic methods on a Guzzle\Service\Client now return the command un-executed.
* Calling getResult() or getResponse() on a command will lazily execute the command if needed.
* Now shipping with cURL's CA certs and using it by default
* Added previousResponse() method to response objects
* No longer sending Accept and Accept-Encoding headers on every request
* Only sending an Expect header by default when a payload is greater than 1MB
* Added/moved client options:
    * curl.blacklist to curl.option.blacklist
    * Added ssl.certificate_authority
* Added a Guzzle\Iterator component
* Moved plugins from Guzzle\Http\Plugin to Guzzle\Plugin
* Added a more robust backoff retry strategy (replaced the ExponentialBackoffPlugin)
* Added a more robust caching plugin
* Added setBody to response objects
* Updating LogPlugin to use a more flexible MessageFormatter
* Added a completely revamped build process
* Cleaning up Collection class and removing default values from the get method
* Fixed ZF2 cache adapters

2.8.8 (2012-10-15)
------------------

* Bug: Fixed a cookie issue that caused dot prefixed domains to not match where popular browsers did

2.8.7 (2012-09-30)
------------------

* Bug: Fixed config file aliases for JSON includes
* Bug: Fixed cookie bug on a request object by using CookieParser to parse cookies on requests
* Bug: Removing the path to a file when sending a Content-Disposition header on a POST upload
* Bug: Hardening request and response parsing to account for missing parts
* Bug: Fixed PEAR packaging
* Bug: Fixed Request::getInfo
* Bug: Fixed cases where CURLM_CALL_MULTI_PERFORM return codes were causing curl transactions to fail
* Adding the ability for the namespace Iterator factory to look in multiple directories
* Added more getters/setters/removers from service descriptions
* Added the ability to remove POST fields from OAuth signatures
* OAuth plugin now supports 2-legged OAuth

2.8.6 (2012-09-05)
------------------

* Added the ability to modify and build service descriptions
* Added the use of visitors to apply parameters to locations in service descriptions using the dynamic command
* Added a `json` parameter location
* Now allowing dot notation for classes in the CacheAdapterFactory
* Using the union of two arrays rather than an array_merge when extending service builder services and service params
* Ensuring that a service is a string before doing strpos() checks on it when substituting services for references
  in service builder config files.
* Services defined in two different config files that include one another will by default replace the previously
  defined service, but you can now create services that extend themselves and merge their settings over the previous
* The JsonLoader now supports aliasing filenames with different filenames. This allows you to alias something like
  '_default' with a default JSON configuration file.

2.8.5 (2012-08-29)
------------------

* Bug: Suppressed empty arrays from URI templates
* Bug: Added the missing $options argument from ServiceDescription::factory to enable caching
* Added support for HTTP responses that do not contain a reason phrase in the start-line
* AbstractCommand commands are now invokable
* Added a way to get the data used when signing an Oauth request before a request is sent

2.8.4 (2012-08-15)
------------------

* Bug: Custom delay time calculations are no longer ignored in the ExponentialBackoffPlugin
* Added the ability to transfer entity bodies as a string rather than streamed. This gets around curl error 65. Set `body_as_string` in a request's curl options to enable.
* Added a StreamInterface, EntityBodyInterface, and added ftell() to Guzzle\Common\Stream
* Added an AbstractEntityBodyDecorator and a ReadLimitEntityBody decorator to transfer only a subset of a decorated stream
* Stream and EntityBody objects will now return the file position to the previous position after a read required operation (e.g. getContentMd5())
* Added additional response status codes
* Removed SSL information from the default User-Agent header
* DELETE requests can now send an entity body
* Added an EventDispatcher to the ExponentialBackoffPlugin and added an ExponentialBackoffLogger to log backoff retries
* Added the ability of the MockPlugin to consume mocked request bodies
* LogPlugin now exposes request and response objects in the extras array

2.8.3 (2012-07-30)
------------------

* Bug: Fixed a case where empty POST requests were sent as GET requests
* Bug: Fixed a bug in ExponentialBackoffPlugin that caused fatal errors when retrying an EntityEnclosingRequest that does not have a body
* Bug: Setting the response body of a request to null after completing a request, not when setting the state of a request to new
* Added multiple inheritance to service description commands
* Added an ApiCommandInterface and added ``getParamNames()`` and ``hasParam()``
* Removed the default 2mb size cutoff from the Md5ValidatorPlugin so that it now defaults to validating everything
* Changed CurlMulti::perform to pass a smaller timeout to CurlMulti::executeHandles

2.8.2 (2012-07-24)
------------------

* Bug: Query string values set to 0 are no longer dropped from the query string
* Bug: A Collection object is no longer created each time a call is made to ``Guzzle\Service\Command\AbstractCommand::getRequestHeaders()``
* Bug: ``+`` is now treated as an encoded space when parsing query strings
* QueryString and Collection performance improvements
* Allowing dot notation for class paths in filters attribute of a service descriptions

2.8.1 (2012-07-16)
------------------

* Loosening Event Dispatcher dependency
* POST redirects can now be customized using CURLOPT_POSTREDIR

2.8.0 (2012-07-15)
------------------

* BC: Guzzle\Http\Query
    * Query strings with empty variables will always show an equal sign unless the variable is set to QueryString::BLANK (e.g. ?acl= vs ?acl)
    * Changed isEncodingValues() and isEncodingFields() to isUrlEncoding()
    * Changed setEncodeValues(bool) and setEncodeFields(bool) to useUrlEncoding(bool)
    * Changed the aggregation functions of QueryString to be static methods
    * Can now use fromString() with querystrings that have a leading ?
* cURL configuration values can be specified in service descriptions using ``curl.`` prefixed parameters
* Content-Length is set to 0 before emitting the request.before_send event when sending an empty request body
* Cookies are no longer URL decoded by default
* Bug: URI template variables set to null are no longer expanded

2.7.2 (2012-07-02)
------------------

* BC: Moving things to get ready for subtree splits. Moving Inflection into Common. Moving Guzzle\Http\Parser to Guzzle\Parser.
* BC: Removing Guzzle\Common\Batch\Batch::count() and replacing it with isEmpty()
* CachePlugin now allows for a custom request parameter function to check if a request can be cached
* Bug fix: CachePlugin now only caches GET and HEAD requests by default
* Bug fix: Using header glue when transferring headers over the wire
* Allowing deeply nested arrays for composite variables in URI templates
* Batch divisors can now return iterators or arrays

2.7.1 (2012-06-26)
------------------

* Minor patch to update version number in UA string
* Updating build process

2.7.0 (2012-06-25)
------------------

* BC: Inflection classes moved to Guzzle\Inflection. No longer static methods. Can now inject custom inflectors into classes.
* BC: Removed magic setX methods from commands
* BC: Magic methods mapped to service description commands are now inflected in the command factory rather than the client __call() method
* Verbose cURL options are no longer enabled by default. Set curl.debug to true on a client to enable.
* Bug: Now allowing colons in a response start-line (e.g. HTTP/1.1 503 Service Unavailable: Back-end server is at capacity)
* Guzzle\Service\Resource\ResourceIteratorApplyBatched now internally uses the Guzzle\Common\Batch namespace
* Added Guzzle\Service\Plugin namespace and a PluginCollectionPlugin
* Added the ability to set POST fields and files in a service description
* Guzzle\Http\EntityBody::factory() now accepts objects with a __toString() method
* Adding a command.before_prepare event to clients
* Added BatchClosureTransfer and BatchClosureDivisor
* BatchTransferException now includes references to the batch divisor and transfer strategies
* Fixed some tests so that they pass more reliably
* Added Guzzle\Common\Log\ArrayLogAdapter

2.6.6 (2012-06-10)
------------------

* BC: Removing Guzzle\Http\Plugin\BatchQueuePlugin
* BC: Removing Guzzle\Service\Command\CommandSet
* Adding generic batching system (replaces the batch queue plugin and command set)
* Updating ZF cache and log adapters and now using ZF's composer repository
* Bug: Setting the name of each ApiParam when creating through an ApiCommand
* Adding result_type, result_doc, deprecated, and doc_url to service descriptions
* Bug: Changed the default cookie header casing back to 'Cookie'

2.6.5 (2012-06-03)
------------------

* BC: Renaming Guzzle\Http\Message\RequestInterface::getResourceUri() to getResource()
* BC: Removing unused AUTH_BASIC and AUTH_DIGEST constants from
* BC: Guzzle\Http\Cookie is now used to manage Set-Cookie data, not Cookie data
* BC: Renaming methods in the CookieJarInterface
* Moving almost all cookie logic out of the CookiePlugin and into the Cookie or CookieJar implementations
* Making the default glue for HTTP headers ';' instead of ','
* Adding a removeValue to Guzzle\Http\Message\Header
* Adding getCookies() to request interface.
* Making it easier to add event subscribers to HasDispatcherInterface classes. Can now directly call addSubscriber()

2.6.4 (2012-05-30)
------------------

* BC: Cleaning up how POST files are stored in EntityEnclosingRequest objects. Adding PostFile class.
* BC: Moving ApiCommand specific functionality from the Inspector and on to the ApiCommand
* Bug: Fixing magic method command calls on clients
* Bug: Email constraint only validates strings
* Bug: Aggregate POST fields when POST files are present in curl handle
* Bug: Fixing default User-Agent header
* Bug: Only appending or prepending parameters in commands if they are specified
* Bug: Not requiring response reason phrases or status codes to match a predefined list of codes
* Allowing the use of dot notation for class namespaces when using instance_of constraint
* Added any_match validation constraint
* Added an AsyncPlugin
* Passing request object to the calculateWait method of the ExponentialBackoffPlugin
* Allowing the result of a command object to be changed
* Parsing location and type sub values when instantiating a service description rather than over and over at runtime

2.6.3 (2012-05-23)
------------------

* [BC] Guzzle\Common\FromConfigInterface no longer requires any config options.
* [BC] Refactoring how POST files are stored on an EntityEnclosingRequest. They are now separate from POST fields.
* You can now use an array of data when creating PUT request bodies in the request factory.
* Removing the requirement that HTTPS requests needed a Cache-Control: public directive to be cacheable.
* [Http] Adding support for Content-Type in multipart POST uploads per upload
* [Http] Added support for uploading multiple files using the same name (foo[0], foo[1])
* Adding more POST data operations for easier manipulation of POST data.
* You can now set empty POST fields.
* The body of a request is only shown on EntityEnclosingRequest objects that do not use POST files.
* Split the Guzzle\Service\Inspector::validateConfig method into two methods. One to initialize when a command is created, and one to validate.
* CS updates

2.6.2 (2012-05-19)
------------------

* [Http] Better handling of nested scope requests in CurlMulti.  Requests are now always prepares in the send() method rather than the addRequest() method.

2.6.1 (2012-05-19)
------------------

* [BC] Removing 'path' support in service descriptions.  Use 'uri'.
* [BC] Guzzle\Service\Inspector::parseDocBlock is now protected. Adding getApiParamsForClass() with cache.
* [BC] Removing Guzzle\Common\NullObject.  Use https://github.com/mtdowling/NullObject if you need it.
* [BC] Removing Guzzle\Common\XmlElement.
* All commands, both dynamic and concrete, have ApiCommand objects.
* Adding a fix for CurlMulti so that if all of the connections encounter some sort of curl error, then the loop exits.
* Adding checks to EntityEnclosingRequest so that empty POST files and fields are ignored.
* Making the method signature of Guzzle\Service\Builder\ServiceBuilder::factory more flexible.

2.6.0 (2012-05-15)
------------------

* [BC] Moving Guzzle\Service\Builder to Guzzle\Service\Builder\ServiceBuilder
* [BC] Executing a Command returns the result of the command rather than the command
* [BC] Moving all HTTP parsing logic to Guzzle\Http\Parsers. Allows for faster C implementations if needed.
* [BC] Changing the Guzzle\Http\Message\Response::setProtocol() method to accept a protocol and version in separate args.
* [BC] Moving ResourceIterator* to Guzzle\Service\Resource
* [BC] Completely refactored ResourceIterators to iterate over a cloned command object
* [BC] Moved Guzzle\Http\UriTemplate to Guzzle\Http\Parser\UriTemplate\UriTemplate
* [BC] Guzzle\Guzzle is now deprecated
* Moving Guzzle\Common\Guzzle::inject to Guzzle\Common\Collection::inject
* Adding Guzzle\Version class to give version information about Guzzle
* Adding Guzzle\Http\Utils class to provide getDefaultUserAgent() and getHttpDate()
* Adding Guzzle\Curl\CurlVersion to manage caching curl_version() data
* ServiceDescription and ServiceBuilder are now cacheable using similar configs
* Changing the format of XML and JSON service builder configs.  Backwards compatible.
* Cleaned up Cookie parsing
* Trimming the default Guzzle User-Agent header
* Adding a setOnComplete() method to Commands that is called when a command completes
* Keeping track of requests that were mocked in the MockPlugin
* Fixed a caching bug in the CacheAdapterFactory
* Inspector objects can be injected into a Command object
* Refactoring a lot of code and tests to be case insensitive when dealing with headers
* Adding Guzzle\Http\Message\HeaderComparison for easy comparison of HTTP headers using a DSL
* Adding the ability to set global option overrides to service builder configs
* Adding the ability to include other service builder config files from within XML and JSON files
* Moving the parseQuery method out of Url and on to QueryString::fromString() as a static factory method.

2.5.0 (2012-05-08)
------------------

* Major performance improvements
* [BC] Simplifying Guzzle\Common\Collection.  Please check to see if you are using features that are now deprecated.
* [BC] Using a custom validation system that allows a flyweight implementation for much faster validation. No longer using Symfony2 Validation component.
* [BC] No longer supporting "{{ }}" for injecting into command or UriTemplates.  Use "{}"
* Added the ability to passed parameters to all requests created by a client
* Added callback functionality to the ExponentialBackoffPlugin
* Using microtime in ExponentialBackoffPlugin to allow more granular backoff strategies.
* Rewinding request stream bodies when retrying requests
* Exception is thrown when JSON response body cannot be decoded
* Added configurable magic method calls to clients and commands.  This is off by default.
* Fixed a defect that added a hash to every parsed URL part
* Fixed duplicate none generation for OauthPlugin.
* Emitting an event each time a client is generated by a ServiceBuilder
* Using an ApiParams object instead of a Collection for parameters of an ApiCommand
* cache.* request parameters should be renamed to params.cache.*
* Added the ability to set arbitrary curl options on requests (disable_wire, progress, etc). See CurlHandle.
* Added the ability to disable type validation of service descriptions
* ServiceDescriptions and ServiceBuilders are now Serializable

Guzzle, PHP HTTP client and webservice framework
================================================

Guzzle is a PHP HTTP client and framework for building RESTful web service clients.

- Extremely powerful API provides all the power of cURL with a simple interface.
- Truly take advantage of HTTP/1.1 with persistent connections, connection pooling, and parallel requests.
- Service description DSL allows you build awesome web service clients faster.
- Symfony2 event-based plugin system allows you to completely modify the behavior of a request.
- Includes a custom node.js webserver to test your clients.
- Unit-tested with PHPUnit with 100% code coverage.

Getting started
---------------

- [Download the phar](http://guzzlephp.org/guzzle.phar) and include it in your project ([minimal phar](http://guzzlephp.org/guzzle-min.phar))
- Docs: [www.guzzlephp.org](http://www.guzzlephp.org/)
- Forum: https://groups.google.com/forum/?hl=en#!forum/guzzle
- IRC: [#guzzlephp](irc://irc.freenode.net/#guzzlephp) channel on irc.freenode.net

### Installing via Composer

The recommended way to install Guzzle is through [Composer](http://getcomposer.org).

1. Add ``guzzle/guzzle`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/guzzle": "~3.1"
            }
        }

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

Features
--------

- Supports GET, HEAD, POST, DELETE, PUT, PATCH, OPTIONS, and any custom verbs
- Allows full access to request and response headers
- Persistent connections are implicitly managed by Guzzle, resulting in huge performance benefits
- [Send requests in parallel](http://guzzlephp.org/tour/http.html#send-http-requests-in-parallel)
- Cookie sessions can be maintained between requests using the [CookiePlugin](http://guzzlephp.org/tour/http.html#cookie-session-plugin)
- Allows custom [entity bodies](http://guzzlephp.org/tour/http.html#entity-bodies), including sending data from a PHP stream and downloading data to a PHP stream
- Responses can be cached and served from cache using the [caching forward proxy plugin](http://guzzlephp.org/tour/http.html#php-based-caching-forward-proxy)
- Failed requests can be retried using [truncated exponential backoff](http://guzzlephp.org/tour/http.html#truncated-exponential-backoff) with custom retry policies
- Entity bodies can be validated automatically using Content-MD5 headers and the [MD5 hash validator plugin](http://guzzlephp.org/tour/http.html#md5-hash-validator-plugin)
- All data sent over the wire can be logged using the [LogPlugin](http://guzzlephp.org/tour/http.html#over-the-wire-logging)
- Subject/Observer signal slot system for unobtrusively [modifying request behavior](http://guzzlephp.org/guide/http/creating_plugins.html)
- Supports all of the features of libcurl including authentication, compression, redirects, SSL, proxies, etc
- Web service client framework for building future-proof interfaces to web services
- Includes a [service description DSL](http://guzzlephp.org/guide/service/service_descriptions.html) for quickly building webservice clients
- Full support for [URI templates](http://tools.ietf.org/html/rfc6570)
- Advanced batching functionality to efficiently send requests or commands in parallel with customizable batch sizes and transfer strategies

HTTP basics
-----------

```php
<?php

use Guzzle\Http\Client;

$client = new Client('http://www.example.com/api/v1/key/{{key}}', array(
    'key' => '***'
));

// Issue a path using a relative URL to the client's base URL
// Sends to http://www.example.com/api/v1/key/***/users
$request = $client->get('users');
$response = $request->send();

// Relative URL that overwrites the path of the base URL
$request = $client->get('/test/123.php?a=b');

// Issue a head request on the base URL
$response = $client->head()->send();
// Delete user 123
$response = $client->delete('users/123')->send();

// Send a PUT request with custom headers
$response = $client->put('upload/text', array(
    'X-Header' => 'My Header'
), 'body of the request')->send();

// Send a PUT request using the contents of a PHP stream as the body
// Send using an absolute URL (overrides the base URL)
$response = $client->put('http://www.example.com/upload', array(
    'X-Header' => 'My Header'
), fopen('http://www.test.com/', 'r'));

// Create a POST request with a file upload (notice the @ symbol):
$request = $client->post('http://localhost:8983/solr/update', null, array (
    'custom_field' => 'my value',
    'file' => '@/path/to/documents.xml'
));

// Create a POST request and add the POST files manually
$request = $client->post('http://localhost:8983/solr/update')
    ->addPostFiles(array(
        'file' => '/path/to/documents.xml'
    ));

// Responses are objects
echo $response->getStatusCode() . ' ' . $response->getReasonPhrase() . "\n";

// Requests and responses can be cast to a string to show the raw HTTP message
echo $request . "\n\n" . $response;

// Create a request based on an HTTP message
$request = RequestFactory::fromMessage(
    "PUT / HTTP/1.1\r\n" .
    "Host: test.com:8081\r\n" .
    "Content-Type: text/plain" .
    "Transfer-Encoding: chunked\r\n" .
    "\r\n" .
    "this is the body"
);
```

Send requests in parallel
-------------------------

```php
<?php

try {
    $client = new Guzzle\Http\Client('http://www.myapi.com/api/v1');
    $responses = $client->send(array(
        $client->get('users'),
        $client->head('messages/123'),
        $client->delete('orders/123')
    ));
} catch (Guzzle\Common\Exception\ExceptionCollection $e) {
    echo "The following requests encountered an exception: \n";
    foreach ($e as $exception) {
        echo $exception->getRequest() . "\n" . $exception->getMessage() . "\n";
    }
}
```

URI templates
-------------

Guzzle supports the entire [URI templates RFC](http://tools.ietf.org/html/rfc6570).

```php
<?php

$client = new Guzzle\Http\Client('http://www.myapi.com/api/v1', array(
    'path' => '/path/to',
    'a'    => 'hi',
    'data' => array(
        'foo'  => 'bar',
        'mesa' => 'jarjar'
    )
));

$request = $client->get('http://www.test.com{+path}{?a,data*}');
```

The generated request URL would become: ``http://www.test.com/path/to?a=hi&foo=bar&mesa=jarajar``

You can specify URI templates and an array of additional template variables to use when creating requests:

```php
<?php

$client = new Guzzle\Http\Client('http://test.com', array(
    'a' => 'hi'
));

$request = $client->get(array('/{?a,b}', array(
    'b' => 'there'
));
```

The resulting URL would become ``http://test.com/?a=hi&b=there``

Unit testing
------------

[![Build Status](https://secure.travis-ci.org/guzzle/guzzle.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Guzzle uses PHPUnit for unit testing. In order to run the unit tests, you'll first need
to install the dependencies of the project using Composer: `php composer.phar install --dev`.
You can then run the tests using `vendor/bin/phpunit` or `phing test` (if you have phing installed).

Guzzle Iterator
===============

[![Build Status](https://secure.travis-ci.org/guzzle/iterator.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Component library that provides useful Iterators and Iterator decorators

- ChunkedIterator: Pulls out chunks from an inner iterator and yields the chunks as arrays
- FilterIterator: Used when PHP 5.4's CallbackFilterIterator is not available
- MapIterator: Maps values before yielding
- MethodProxyIterator: Proxies missing method calls to the innermost iterator

### Installing via Composer

The recommended way to install is through [Composer](http://getcomposer.org).

1. Add ``guzzle/iterator`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/iterator": "*"
            }
        }

    Consider tightening your dependencies to a known version when deploying mission critical applications (e.g. ``2.7.*``).

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

<?php

namespace Guzzle\Service\Command\Factory;

use Guzzle\Service\Description\ServiceDescriptionInterface;
use Guzzle\Inflection\InflectorInterface;

/**
 * Command factory used to create commands based on service descriptions
 */
class ServiceDescriptionFactory implements FactoryInterface
{
    /**
     * @var ServiceDescriptionInterface
     */
    protected $description;

    /**
     * @var InflectorInterface
     */
    protected $inflector;

    /**
     * @param ServiceDescriptionInterface $description Service description
     * @param InflectorInterface          $inflector   Optional inflector to use if the command is not at first found
     */
    public function __construct(ServiceDescriptionInterface $description, InflectorInterface $inflector = null)
    {
        $this->setServiceDescription($description);
        $this->inflector = $inflector;
    }

    /**
     * Change the service description used with the factory
     *
     * @param ServiceDescriptionInterface $description Service description to use
     *
     * @return FactoryInterface
     */
    public function setServiceDescription(ServiceDescriptionInterface $description)
    {
        $this->description = $description;

        return $this;
    }

    /**
     * Returns the service description
     *
     * @return ServiceDescriptionInterface
     */
    public function getServiceDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function factory($name, array $args = array())
    {
        $command = $this->description->getOperation($name);

        // If an inflector was passed, then attempt to get the command using snake_case inflection
        if (!$command && $this->inflector) {
            $command = $this->description->getOperation($this->inflector->snake($name));
        }

        if ($command) {
            $class = $command->getClass();
            return new $class($args, $command, $this->description);
        }
    }
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Common\Exception\InvalidArgumentException;

/**
 * A ServiceDescription stores service information based on a service document
 */
class ServiceDescription implements ServiceDescriptionInterface
{
    /**
     * @var array Array of {@see OperationInterface} objects
     */
    protected $operations = array();

    /**
     * @var array Array of API models
     */
    protected $models = array();

    /**
     * @var string Name of the API
     */
    protected $name;

    /**
     * @var string API version
     */
    protected $apiVersion;

    /**
     * @var string Summary of the API
     */
    protected $description;

    /**
     * @var array Any extra API data
     */
    protected $extraData = array();

    /**
     * @var ServiceDescriptionLoader Factory used in factory method
     */
    protected static $descriptionLoader;

    /**
     * @var string baseUrl/basePath
     */
    protected $baseUrl;

    /**
     * {@inheritdoc}
     * @param string|array $config  File to build or array of operation information
     * @param array        $options Service description factory options
     *
     * @return self
     */
    public static function factory($config, array $options = array())
    {
        // @codeCoverageIgnoreStart
        if (!self::$descriptionLoader) {
            self::$descriptionLoader = new ServiceDescriptionLoader();
        }
        // @codeCoverageIgnoreEnd

        return self::$descriptionLoader->load($config, $options);
    }

    /**
     * Create a new ServiceDescription
     *
     * @param array $config Array of configuration data
     */
    public function __construct(array $config = array())
    {
        $this->fromArray($config);
    }

    /**
     * Serialize the service description
     *
     * @return string
     */
    public function serialize()
    {
        $result = array(
            'name'        => $this->name,
            'apiVersion'  => $this->apiVersion,
            'baseUrl'     => $this->baseUrl,
            'description' => $this->description
        ) + $this->extraData;
        $result['operations'] = array();
        foreach ($this->getOperations() as $name => $operation) {
            $result['operations'][$operation->getName() ?: $name] = $operation->toArray();
        }
        if (!empty($this->models)) {
            $result['models'] = array();
            foreach ($this->models as $id => $model) {
                $result['models'][$id] = $model instanceof Parameter ? $model->toArray(): $model;
            }
        }

        return json_encode(array_filter($result));
    }

    /**
     * Unserialize the service description
     *
     * @param string|array $json JSON data
     */
    public function unserialize($json)
    {
        $this->operations = array();
        $this->fromArray(json_decode($json, true));
    }

    /**
     * {@inheritdoc}
     */
    public function getBaseUrl()
    {
        return $this->baseUrl;
    }

    /**
     * Set the baseUrl of the description
     *
     * @param string $baseUrl Base URL of each operation
     *
     * @return self
     */
    public function setBaseUrl($baseUrl)
    {
        $this->baseUrl = $baseUrl;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getOperations()
    {
        foreach (array_keys($this->operations) as $name) {
            $this->getOperation($name);
        }

        return $this->operations;
    }

    /**
     * {@inheritdoc}
     */
    public function hasOperation($name)
    {
        return isset($this->operations[$name]);
    }

    /**
     * {@inheritdoc}
     */
    public function getOperation($name)
    {
        // Lazily retrieve and build operations
        if (!isset($this->operations[$name])) {
            return null;
        }

        if (!($this->operations[$name] instanceof Operation)) {
            $this->operations[$name] = new Operation($this->operations[$name], $this);
        }

        return $this->operations[$name];
    }

    /**
     * Add a operation to the service description
     *
     * @param OperationInterface $operation Operation to add
     *
     * @return self
     */
    public function addOperation(OperationInterface $operation)
    {
        $this->operations[$operation->getName()] = $operation->setServiceDescription($this);

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getModel($id)
    {
        if (!isset($this->models[$id])) {
            return null;
        }

        if (!($this->models[$id] instanceof Parameter)) {
            $this->models[$id] = new Parameter($this->models[$id], $this);
        }

        return $this->models[$id];
    }

    /**
     * {@inheritdoc}
     */
    public function getModels()
    {
        // Ensure all models are converted into parameter objects
        foreach (array_keys($this->models) as $id) {
            $this->getModel($id);
        }

        return $this->models;
    }

    /**
     * {@inheritdoc}
     */
    public function hasModel($id)
    {
        return isset($this->models[$id]);
    }

    /**
     * Add a model to the service description
     *
     * @param Parameter $model Model to add
     *
     * @return self
     */
    public function addModel(Parameter $model)
    {
        $this->models[$model->getName()] = $model;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getApiVersion()
    {
        return $this->apiVersion;
    }

    /**
     * {@inheritdoc}
     */
    public function getName()
    {
        return $this->name;
    }

    /**
     * {@inheritdoc}
     */
    public function getDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function getData($key)
    {
        return isset($this->extraData[$key]) ? $this->extraData[$key] : null;
    }

    /**
     * {@inheritdoc}
     */
    public function setData($key, $value)
    {
        $this->extraData[$key] = $value;

        return $this;
    }

    /**
     * Initialize the state from an array
     *
     * @param array $config Configuration data
     * @throws InvalidArgumentException
     */
    protected function fromArray(array $config)
    {
        // Keep a list of default keys used in service descriptions that is later used to determine extra data keys
        $defaultKeys = array('name', 'models', 'apiVersion', 'baseUrl', 'description');
        // Pull in the default configuration values
        foreach ($defaultKeys as $key) {
            if (isset($config[$key])) {
                $this->{$key} = $config[$key];
            }
        }

        // Account for the Swagger name for Guzzle's baseUrl
        if (isset($config['basePath'])) {
            $this->baseUrl = $config['basePath'];
        }

        // Ensure that the models and operations properties are always arrays
        $this->models = (array) $this->models;
        $this->operations = (array) $this->operations;

        // We want to add operations differently than adding the other properties
        $defaultKeys[] = 'operations';

        // Create operations for each operation
        if (isset($config['operations'])) {
            foreach ($config['operations'] as $name => $operation) {
                if (!($operation instanceof Operation) && !is_array($operation)) {
                    throw new InvalidArgumentException('Invalid operation in service description: '
                        . gettype($operation));
                }
                $this->operations[$name] = $operation;
            }
        }

        // Get all of the additional properties of the service description and store them in a data array
        foreach (array_diff(array_keys($config), $defaultKeys) as $key) {
            $this->extraData[$key] = $config[$key];
        }
    }
}

<?php

namespace Guzzle\Service\Description;

/**
 * A ServiceDescription stores service information based on a service document
 */
interface ServiceDescriptionInterface extends \Serializable
{
    /**
     * Get the basePath/baseUrl of the description
     *
     * @return string
     */
    public function getBaseUrl();

    /**
     * Get the API operations of the service
     *
     * @return array Returns an array of {@see OperationInterface} objects
     */
    public function getOperations();

    /**
     * Check if the service has an operation by name
     *
     * @param string $name Name of the operation to check
     *
     * @return bool
     */
    public function hasOperation($name);

    /**
     * Get an API operation by name
     *
     * @param string $name Name of the command
     *
     * @return OperationInterface|null
     */
    public function getOperation($name);

    /**
     * Get a specific model from the description
     *
     * @param string $id ID of the model
     *
     * @return Parameter|null
     */
    public function getModel($id);

    /**
     * Get all service description models
     *
     * @return array
     */
    public function getModels();

    /**
     * Check if the description has a specific model by name
     *
     * @param string $id ID of the model
     *
     * @return bool
     */
    public function hasModel($id);

    /**
     * Get the API version of the service
     *
     * @return string
     */
    public function getApiVersion();

    /**
     * Get the name of the API
     *
     * @return string
     */
    public function getName();

    /**
     * Get a summary of the purpose of the API
     *
     * @return string
     */
    public function getDescription();

    /**
     * Get arbitrary data from the service description that is not part of the Guzzle spec
     *
     * @param string $key Data key to retrieve
     *
     * @return null|mixed
     */
    public function getData($key);

    /**
     * Set arbitrary data on the service description
     *
     * @param string $key   Data key to set
     * @param mixed  $value Value to set
     *
     * @return self
     */
    public function setData($key, $value);
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Service\AbstractConfigLoader;
use Guzzle\Service\Exception\DescriptionBuilderException;

/**
 * Loader for service descriptions
 */
class ServiceDescriptionLoader extends AbstractConfigLoader
{
    /**
     * {@inheritdoc}
     */
    protected function build($config, array $options)
    {
        $operations = array();
        if (!empty($config['operations'])) {
            foreach ($config['operations'] as $name => $op) {
                $name = $op['name'] = isset($op['name']) ? $op['name'] : $name;
                // Extend other operations
                if (!empty($op['extends'])) {
                    $this->resolveExtension($name, $op, $operations);
                }
                $op['parameters'] = isset($op['parameters']) ? $op['parameters'] : array();
                $operations[$name] = $op;
            }
        }

        return new ServiceDescription(array(
            'apiVersion'  => isset($config['apiVersion']) ? $config['apiVersion'] : null,
            'baseUrl'     => isset($config['baseUrl']) ? $config['baseUrl'] : null,
            'description' => isset($config['description']) ? $config['description'] : null,
            'operations'  => $operations,
            'models'      => isset($config['models']) ? $config['models'] : null
        ) + $config);
    }

    /**
     * @param string $name       Name of the operation
     * @param array  $op         Operation value array
     * @param array  $operations Currently loaded operations
     * @throws DescriptionBuilderException when extending a non-existent operation
     */
    protected function resolveExtension($name, array &$op, array &$operations)
    {
        $resolved = array();
        $original = empty($op['parameters']) ? false: $op['parameters'];
        $hasClass = !empty($op['class']);
        foreach ((array) $op['extends'] as $extendedCommand) {
            if (empty($operations[$extendedCommand])) {
                throw new DescriptionBuilderException("{$name} extends missing operation {$extendedCommand}");
            }
            $toArray = $operations[$extendedCommand];
            $resolved = empty($resolved)
                ? $toArray['parameters']
                : array_merge($resolved, $toArray['parameters']);

            $op = $op + $toArray;
            if (!$hasClass && isset($toArray['class'])) {
                $op['class'] = $toArray['class'];
            }
        }
        $op['parameters'] = $original ? array_merge($resolved, $original) : $resolved;
    }
}

<?php

namespace Guzzle\Service\Exception;

use Guzzle\Common\Exception\RuntimeException;

class DescriptionBuilderException extends RuntimeException {}

<?php

namespace Guzzle\Tests\Service\Command;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Command\Factory\ServiceDescriptionFactory;
use Guzzle\Inflection\Inflector;

/**
 * @covers Guzzle\Service\Command\Factory\ServiceDescriptionFactory
 */
class ServiceDescriptionFactoryTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testProvider()
    {
        return array(
            array('foo', null),
            array('jar_jar', 'Guzzle\Tests\Service\Mock\Command\MockCommand'),
            array('binks', 'Guzzle\Tests\Service\Mock\Command\OtherCommand')
        );
    }

    /**
     * @dataProvider testProvider
     */
    public function testCreatesCommandsUsingServiceDescriptions($key, $result)
    {
        $d = $this->getDescription();

        $factory = new ServiceDescriptionFactory($d);
        $this->assertSame($d, $factory->getServiceDescription());

        if (is_null($result)) {
            $this->assertNull($factory->factory($key));
        } else {
            $this->assertInstanceof($result, $factory->factory($key));
        }
    }

    public function testUsesInflectionIfNoExactMatch()
    {
        $d = $this->getDescription();
        $factory = new ServiceDescriptionFactory($d, new Inflector());
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('Binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('JarJar'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('jar_jar'));
    }

    protected function getDescription()
    {
        return ServiceDescription::factory(array(
            'operations' => array(
                'jar_jar' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\MockCommand'
                ),
                'binks' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\OtherCommand'
                )
            )
        ));
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\ServiceDescriptionLoader;

/**
 * @covers Guzzle\Service\Description\ServiceDescriptionLoader
 */
class ServiceDescriptionLoaderTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testAllowsExtraData()
    {
        $d = ServiceDescription::factory(array(
            'foo' => true,
            'baz' => array('bar'),
            'apiVersion' => '123',
            'operations' => array()
        ));

        $this->assertEquals(true, $d->getData('foo'));
        $this->assertEquals(array('bar'), $d->getData('baz'));
        $this->assertEquals('123', $d->getApiVersion());
    }

    public function testAllowsDeepNestedInheritance()
    {
        $d = ServiceDescription::factory(array(
            'operations' => array(
                'abstract' => array(
                    'httpMethod' => 'HEAD',
                    'parameters' => array(
                        'test' => array('type' => 'string', 'required' => true)
                    )
                ),
                'abstract2' => array('uri' => '/test', 'extends' => 'abstract'),
                'concrete'  => array('extends' => 'abstract2'),
                'override'  => array('extends' => 'abstract', 'httpMethod' => 'PUT'),
                'override2'  => array('extends' => 'override', 'httpMethod' => 'POST', 'uri' => '/')
            )
        ));

        $c = $d->getOperation('concrete');
        $this->assertEquals('/test', $c->getUri());
        $this->assertEquals('HEAD', $c->getHttpMethod());
        $params = $c->getParams();
        $param = $params['test'];
        $this->assertEquals('string', $param->getType());
        $this->assertTrue($param->getRequired());

        // Ensure that merging HTTP method does not make an array
        $this->assertEquals('PUT', $d->getOperation('override')->getHttpMethod());
        $this->assertEquals('POST', $d->getOperation('override2')->getHttpMethod());
        $this->assertEquals('/', $d->getOperation('override2')->getUri());
    }

    /**
     * @expectedException RuntimeException
     */
    public function testThrowsExceptionWhenExtendingMissingCommand()
    {
        ServiceDescription::factory(array(
            'operations' => array(
                'concrete' => array(
                    'extends' => 'missing'
                )
            )
        ));
    }

    public function testAllowsMultipleInheritance()
    {
        $description = ServiceDescription::factory(array(
            'operations' => array(
                'a' => array(
                    'httpMethod' => 'GET',
                    'parameters' => array(
                        'a1' => array(
                            'default'  => 'foo',
                            'required' => true,
                            'prepend'  => 'hi'
                        )
                    )
                ),
                'b' => array(
                    'extends' => 'a',
                    'parameters' => array(
                        'b2' => array()
                    )
                ),
                'c' => array(
                    'parameters' => array(
                        'a1' => array(
                            'default'     => 'bar',
                            'required'    => true,
                            'description' => 'test'
                        ),
                        'c3' => array()
                    )
                ),
                'd' => array(
                    'httpMethod' => 'DELETE',
                    'extends'    => array('b', 'c'),
                    'parameters' => array(
                        'test' => array()
                    )
                )
            )
        ));

        $command = $description->getOperation('d');
        $this->assertEquals('DELETE', $command->getHttpMethod());
        $this->assertContains('a1', $command->getParamNames());
        $this->assertContains('b2', $command->getParamNames());
        $this->assertContains('c3', $command->getParamNames());
        $this->assertContains('test', $command->getParamNames());

        $this->assertTrue($command->getParam('a1')->getRequired());
        $this->assertEquals('bar', $command->getParam('a1')->getDefault());
        $this->assertEquals('test', $command->getParam('a1')->getDescription());
    }

    public function testAddsOtherFields()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(),
            'description' => 'Foo',
            'apiVersion'  => 'bar'
        ));
        $this->assertEquals('Foo', $description->getDescription());
        $this->assertEquals('bar', $description->getApiVersion());
    }

    public function testCanLoadNestedExtends()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(
                'root' => array(
                    'class' => 'foo'
                ),
                'foo' => array(
                    'extends' => 'root',
                    'parameters' => array(
                        'baz' => array('type' => 'string')
                    )
                ),
                'foo_2' => array(
                    'extends' => 'foo',
                    'parameters' => array(
                        'bar' => array('type' => 'string')
                    )
                ),
                'foo_3' => array(
                    'class' => 'bar',
                    'parameters' => array(
                        'bar2' => array('type' => 'string')
                    )
                ),
                'foo_4' => array(
                    'extends' => array('foo_2', 'foo_3'),
                    'parameters' => array(
                        'bar3' => array('type' => 'string')
                    )
                )
            )
        ));

        $this->assertTrue($description->hasOperation('foo_4'));
        $foo4 = $description->getOperation('foo_4');
        $this->assertTrue($foo4->hasParam('baz'));
        $this->assertTrue($foo4->hasParam('bar'));
        $this->assertTrue($foo4->hasParam('bar2'));
        $this->assertTrue($foo4->hasParam('bar3'));
        $this->assertEquals('bar', $foo4->getClass());
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\Operation;
use Guzzle\Service\Description\Parameter;
use Guzzle\Service\Client;

/**
 * @covers Guzzle\Service\Description\ServiceDescription
 */
class ServiceDescriptionTest extends \Guzzle\Tests\GuzzleTestCase
{
    protected $serviceData;

    public function setup()
    {
        $this->serviceData = array(
            'test_command' => new Operation(array(
                'name'        => 'test_command',
                'description' => 'documentationForCommand',
                'httpMethod'  => 'DELETE',
                'class'       => 'Guzzle\\Tests\\Service\\Mock\\Command\\MockCommand',
                'parameters'  => array(
                    'bucket'  => array('required' => true),
                    'key'     => array('required' => true)
                )
            ))
        );
    }

    /**
     * @covers Guzzle\Service\Description\ServiceDescription::factory
     * @covers Guzzle\Service\Description\ServiceDescriptionLoader::build
     */
    public function testFactoryDelegatesToConcreteFactories()
    {
        $jsonFile = __DIR__ . '/../../TestData/test_service.json';
        $this->assertInstanceOf('Guzzle\Service\Description\ServiceDescription', ServiceDescription::factory($jsonFile));
    }

    public function testConstructor()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $this->assertEquals(1, count($service->getOperations()));
        $this->assertFalse($service->hasOperation('foobar'));
        $this->assertTrue($service->hasOperation('test_command'));
    }

    public function testIsSerializable()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $data = serialize($service);
        $d2 = unserialize($data);
        $this->assertEquals(serialize($service), serialize($d2));
    }

    public function testSerializesParameters()
    {
        $service = new ServiceDescription(array(
            'operations' => array(
                'foo' => new Operation(array('parameters' => array('foo' => array('type' => 'string'))))
            )
        ));
        $serialized = serialize($service);
        $this->assertContains('"parameters":{"foo":', $serialized);
        $service = unserialize($serialized);
        $this->assertTrue($service->getOperation('foo')->hasParam('foo'));
    }

    public function testAllowsForJsonBasedArrayParamsFunctionalTest()
    {
        $description = new ServiceDescription(array(
            'operations' => array(
                'test' => new Operation(array(
                    'httpMethod' => 'PUT',
                    'parameters' => array(
                        'data'   => array(
                            'required' => true,
                            'filters'  => 'json_encode',
                            'location' => 'body'
                        )
                    )
                ))
            )
        ));
        $client = new Client();
        $client->setDescription($description);
        $command = $client->getCommand('test', array(
            'data' => array(
                'foo' => 'bar'
            )
        ));

        $request = $command->prepare();
        $this->assertEquals('{"foo":"bar"}', (string) $request->getBody());
    }

    public function testContainsModels()
    {
        $d = new ServiceDescription(array(
            'operations' => array('foo' => array()),
            'models' => array(
                'Tag'    => array('type' => 'object'),
                'Person' => array('type' => 'object')
            )
        ));
        $this->assertTrue($d->hasModel('Tag'));
        $this->assertTrue($d->hasModel('Person'));
        $this->assertFalse($d->hasModel('Foo'));
        $this->assertInstanceOf('Guzzle\Service\Description\Parameter', $d->getModel('Tag'));
        $this->assertNull($d->getModel('Foo'));
        $this->assertContains('"models":{', serialize($d));
        $this->assertEquals(array('Tag', 'Person'), array_keys($d->getModels()));
    }

    public function testCanAddModels()
    {
        $d = new ServiceDescription(array());
        $this->assertFalse($d->hasModel('Foo'));
        $d->addModel(new Parameter(array('name' => 'Foo')));
        $this->assertTrue($d->hasModel('Foo'));
    }

    public function testHasAttributes()
    {
        $d = new ServiceDescription(array(
            'operations'  => array(),
            'name'        => 'Name',
            'description' => 'Description',
            'apiVersion'  => '1.24'
        ));

        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());

        $s = serialize($d);
        $this->assertContains('"name":"Name"', $s);
        $this->assertContains('"description":"Description"', $s);
        $this->assertContains('"apiVersion":"1.24"', $s);

        $d = unserialize($s);
        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());
    }

    public function testPersistsCustomAttributes()
    {
        $data = array(
            'operations'  => array('foo' => array('class' => 'foo', 'parameters' => array())),
            'name'        => 'Name',
            'description' => 'Test',
            'apiVersion'  => '1.24',
            'auth'        => 'foo',
            'keyParam'    => 'bar'
        );
        $d = new ServiceDescription($data);
        $d->setData('hello', 'baz');
        $this->assertEquals('foo', $d->getData('auth'));
        $this->assertEquals('baz', $d->getData('hello'));
        $this->assertEquals('bar', $d->getData('keyParam'));
        // responseClass and responseType are added by default
        $data['operations']['foo']['responseClass'] = 'array';
        $data['operations']['foo']['responseType'] = 'primitive';
        $this->assertEquals($data + array('hello' => 'baz'), json_decode($d->serialize(), true));
    }

    public function testReturnsNullWhenRetrievingMissingOperation()
    {
        $s = new ServiceDescription(array());
        $this->assertNull($s->getOperation('foo'));
    }

    public function testCanAddOperations()
    {
        $s = new ServiceDescription(array());
        $this->assertFalse($s->hasOperation('Foo'));
        $s->addOperation(new Operation(array('name' => 'Foo')));
        $this->assertTrue($s->hasOperation('Foo'));
    }

    /**
     * @expectedException Guzzle\Common\Exception\InvalidArgumentException
     */
    public function testValidatesOperationTypes()
    {
        $s = new ServiceDescription(array(
            'operations' => array('foo' => new \stdClass())
        ));
    }

    public function testHasBaseUrl()
    {
        $description = new ServiceDescription(array('baseUrl' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
        $description->setBaseUrl('http://foobar.com');
        $this->assertEquals('http://foobar.com', $description->getBaseUrl());
    }

    public function testCanUseBasePath()
    {
        $description = new ServiceDescription(array('basePath' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
    }
}

Guzzle Upgrade Guide
====================

3.2 to 3.3
----------

### Response::getEtag() quote stripping removed

`Guzzle\Http\Message\Response::getEtag()` no longer strips quotes around the ETag response header

### Removed `Guzzle\Http\Utils`

The `Guzzle\Http\Utils` class was removed. This class was only used for testing.

### Stream wrapper and type

`Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to lowercase.

### curl.emit_io became emit_io

Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using the
'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'

3.1 to 3.2
----------

### CurlMulti is no longer reused globally

Before 3.2, the same CurlMulti object was reused globally for each client. This can cause issue where plugins added
to a single client can pollute requests dispatched from other clients.

If you still wish to reuse the same CurlMulti object with each client, then you can add a listener to the
ServiceBuilder's `service_builder.create_client` event to inject a custom CurlMulti object into each client as it is
created.

```php
$multi = new Guzzle\Http\Curl\CurlMulti();
$builder = Guzzle\Service\Builder\ServiceBuilder::factory('/path/to/config.json');
$builder->addListener('service_builder.create_client', function ($event) use ($multi) {
    $event['client']->setCurlMulti($multi);
}
});
```

### No default path

URLs no longer have a default path value of '/' if no path was specified.

Before:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com/
```

After:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com
```

### Less verbose BadResponseException

The exception message for `Guzzle\Http\Exception\BadResponseException` no longer contains the full HTTP request and
response information. You can, however, get access to the request and response object by calling `getRequest()` or
`getResponse()` on the exception object.


### Query parameter aggregation

Multi-valued query parameters are no longer aggregated using a callback function. `Guzzle\Http\Query` now has a
setAggregator() method that accepts a `Guzzle\Http\QueryAggregator\QueryAggregatorInterface` object. This object is
responsible for handling the aggregation of multi-valued query string variables into a flattened hash.

2.8 to 3.x
----------

### Guzzle\Service\Inspector

Change `\Guzzle\Service\Inspector::fromConfig` to `\Guzzle\Common\Collection::fromConfig`

**Before**

```php
use Guzzle\Service\Inspector;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Inspector::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

**After**

```php
use Guzzle\Common\Collection;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Collection::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

### Convert XML Service Descriptions to JSON

**Before**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<client>
    <commands>
        <!-- Groups -->
        <command name="list_groups" method="GET" uri="groups.json">
            <doc>Get a list of groups</doc>
        </command>
        <command name="search_groups" method="GET" uri='search.json?query="{{query}} type:group"'>
            <doc>Uses a search query to get a list of groups</doc>
            <param name="query" type="string" required="true" />
        </command>
        <command name="create_group" method="POST" uri="groups.json">
            <doc>Create a group</doc>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
        <command name="delete_group" method="DELETE" uri="groups/{{id}}.json">
            <doc>Delete a group by ID</doc>
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="get_group" method="GET" uri="groups/{{id}}.json">
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="update_group" method="PUT" uri="groups/{{id}}.json">
            <doc>Update a group</doc>
            <param name="id" type="integer" required="true"/>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
    </commands>
</client>
```

**After**

```json
{
    "name":       "Zendesk REST API v2",
    "apiVersion": "2012-12-31",
    "description":"Provides access to Zendesk views, groups, tickets, ticket fields, and users",
    "operations": {
        "list_groups":  {
            "httpMethod":"GET",
            "uri":       "groups.json",
            "summary":   "Get a list of groups"
        },
        "search_groups":{
            "httpMethod":"GET",
            "uri":       "search.json?query=\"{query} type:group\"",
            "summary":   "Uses a search query to get a list of groups",
            "parameters":{
                "query":{
                    "location":   "uri",
                    "description":"Zendesk Search Query",
                    "type":       "string",
                    "required":   true
                }
            }
        },
        "create_group": {
            "httpMethod":"POST",
            "uri":       "groups.json",
            "summary":   "Create a group",
            "parameters":{
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        },
        "delete_group": {
            "httpMethod":"DELETE",
            "uri":       "groups/{id}.json",
            "summary":   "Delete a group",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to delete by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "get_group":    {
            "httpMethod":"GET",
            "uri":       "groups/{id}.json",
            "summary":   "Get a ticket",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to get by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "update_group": {
            "httpMethod":"PUT",
            "uri":       "groups/{id}.json",
            "summary":   "Update a group",
            "parameters":{
                "id":          {
                    "location":   "uri",
                    "description":"Group to update by ID",
                    "type":       "integer",
                    "required":   true
                },
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        }
}
```

### Guzzle\Service\Description\ServiceDescription

Commands are now called Operations

**Before**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getCommands();     // @returns ApiCommandInterface[]
$sd->hasCommand($name);
$sd->getCommand($name); // @returns ApiCommandInterface|null
$sd->addCommand($command); // @param ApiCommandInterface $command
```

**After**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getOperations();           // @returns OperationInterface[]
$sd->hasOperation($name);
$sd->getOperation($name);       // @returns OperationInterface|null
$sd->addOperation($operation);  // @param OperationInterface $operation
```

### Guzzle\Common\Inflection\Inflector

Namespace is now `Guzzle\Inflection\Inflector`

### Guzzle\Http\Plugin

Namespace is now `Guzzle\Plugin`. Many other changes occur within this namespace and are detailed in their own sections below.

### Guzzle\Http\Plugin\LogPlugin and Guzzle\Common\Log

Now `Guzzle\Plugin\Log\LogPlugin` and `Guzzle\Log` respectively.

**Before**

```php
use Guzzle\Common\Log\ClosureLogAdapter;
use Guzzle\Http\Plugin\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $verbosity is an integer indicating desired message verbosity level
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $verbosity = LogPlugin::LOG_VERBOSE);
```

**After**

```php
use Guzzle\Log\ClosureLogAdapter;
use Guzzle\Log\MessageFormatter;
use Guzzle\Plugin\Log\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $format is a string indicating desired message format -- @see MessageFormatter
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $format = MessageFormatter::DEBUG_FORMAT);
```

### Guzzle\Http\Plugin\CurlAuthPlugin

Now `Guzzle\Plugin\CurlAuth\CurlAuthPlugin`.

### Guzzle\Http\Plugin\ExponentialBackoffPlugin

Now `Guzzle\Plugin\Backoff\BackoffPlugin`, and other changes.

**Before**

```php
use Guzzle\Http\Plugin\ExponentialBackoffPlugin;

$backoffPlugin = new ExponentialBackoffPlugin($maxRetries, array_merge(
        ExponentialBackoffPlugin::getDefaultFailureCodes(), array(429)
    ));

$client->addSubscriber($backoffPlugin);
```

**After**

```php
use Guzzle\Plugin\Backoff\BackoffPlugin;
use Guzzle\Plugin\Backoff\HttpBackoffStrategy;

// Use convenient factory method instead -- see implementation for ideas of what
// you can do with chaining backoff strategies
$backoffPlugin = BackoffPlugin::getExponentialBackoff($maxRetries, array_merge(
        HttpBackoffStrategy::getDefaultFailureCodes(), array(429)
    ));
$client->addSubscriber($backoffPlugin);
```


### Known Issues

#### [BUG] Accept-Encoding header behavior changed unintentionally.

(See #217) (Fixed in 09daeb8c666fb44499a0646d655a8ae36456575e)

In version 2.8 setting the `Accept-Encoding` header would set the CURLOPT_ENCODING option, which permitted cURL to
properly handle gzip/deflate compressed responses from the server. In versions affected by this bug this does not happen.
See issue #217 for a workaround, or use a version containing the fix.

JSON Lint
=========

[![Build Status](https://secure.travis-ci.org/Seldaek/jsonlint.png)](http://travis-ci.org/Seldaek/jsonlint)

Usage
-----

```php
use Seld\JsonLint\JsonParser;

$parser = new JsonParser();
    
// returns null if it's valid json, or a ParsingException object.
$parser->lint($json);

// Call getMessage() on the exception object to get
// a well formatted error message error like this

// Parse error on line 2:
// ... "key": "value"    "numbers": [1, 2, 3]
// ----------------------^
// Expected one of: 'EOF', '}', ':', ',', ']'

// Call getDetails() on the exception to get more info.

// returns parsed json, like json_decode() does, but slower, throws
// exceptions on failure.
$parser->parse($json);
```

Installation
------------

JSON Lint can easily be used within another app if you have a PSR-0 autoloader, or
it can be installed through [Composer](http://packagist.org/) for use as a CLI util.
Once installed via Composer you can run the following command to lint a json file or URL:

    $ bin/jsonlint file.json

Requirements
------------

- PHP 5.3+
- [optional] PHPUnit 3.5+ to execute the test suite (phpunit --version)

Submitting bugs and feature requests
------------------------------------

Bugs and feature request are tracked on [GitHub](https://github.com/Seldaek/jsonlint/issues)

Author
------

Jordi Boggiano - <j.boggiano@seld.be> - <http://twitter.com/seldaek>

License
-------

JSON Lint is licensed under the MIT License - see the LICENSE file for details

Acknowledgements
----------------

This library is a port of the JavaScript [jsonlint](https://github.com/zaach/jsonlint) library.

# Alfred Workflow Builder

Alfred Workflow Builder is a PHP class for creating workflows with Alfred 2. This class provides functions for working
with plist settings files, reading and writing data to files, generating Alfred feedback results, and more.


## Installation

[Composer](composer) is the recommended way to install is package. Composer is dependency management tool for PHP that
allows you to declare the dependencies your project needs and installs them into your project.

1. Add `skyzyx/alfred-workflow-builder` as a dependency in your project's `composer.json` file.

	```json
	{
	    "require": {
	        "skyzyx/alfred-workflow-builder": "1.0.*"
	    }
	}
	```

2. Download and install Composer.

	```bash
	curl -s "http://getcomposer.org/installer" | php
	```

3. Install your dependencies.

	```bash
	php composer.phar install --optimize-autoloader
	```

4. Require Composer's autoloader.
Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that
it downloads. To use it, just add the following line to your code's bootstrap process.

	```php
	require 'vendor/autoload.php';
	```

The [original version of this class](original-class) (written by [David Ferguson](dferg)) had methods for things like
caching data to local files and fetching remote data over HTTP. Instead, we recommend you use [Guzzle](guzzle),
[Requests](requests) or [Buzz](buzz) for HTTP requests and [Doctrine Cache][doctrine-cache] for local file system caching.
If you'd also like logging, we recommend [Monolog](monolog).

[buzz]: https://github.com/kriswallsmith/Buzz
[composer]: http://getcomposer.org
[dferg]: http://dferg.us
[doctrine-cache]: http://docs.doctrine-project.org/en/2.0.x/reference/caching.html
[guzzle]: http://guzzlephp.org
[monolog]: https://github.com/Seldaek/monolog
[original-class]: https://github.com/jdfwarrior/Workflows
[requests]: http://requests.ryanmccue.info


## `Alfred\Workflow`

```php
use Alfred\Workflow;

$w = new Workflow('com.ryanparman.my-workflow');
#=> <Alfred\Workflow>
```

### Properties

#### bundle
The bundle ID for the workflow.

```php
$bundle = $w->bundle;
#=> (string) com.ryanparman.my-workflow
```

#### cache
The cache directory for the workflow.

```php
$cache = $w->cache;
#=> (string) /Users/rparman/Library/Caches/com.runningwithcrayons.Alfred-2/Workflow Data/com.ryanparman.my-workflow
```

#### data
The data directory for the workflow.

```php
$data = $w->data;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Workflow Data/com.ryanparman.my-workflow
```

#### home
The current user's `$HOME` directory.

```php
$home = $w->home;
#=> (string) /Users/rparman
```

#### path
The working directory for the workflow.

```php
$path = $w->path;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Alfred.alfredpreferences/workflows/com.ryanparman.my-workflow
```

#### results
An array containing all of the results so far.

##### Example
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo var_export($w->results());
```

##### Results
```php
array (
  0 =>
  array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
  ),
)
```


### Methods

#### `string` toXML()
Accepts a properly formatted array or json object and converts it to XML for creating Alfred feedback results. If results
have been created using the `result()` function, then passing no arguments will use the array of results created using
the `result()` function. Arrays passed in must be an associative array with array key values for the following required
values: `uid`, `arg`, `title`, `subtitle` and `icon`. You may also pass array `key => value` pairs for the following
optional keys: `valid` and `autocomplete`.

##### Example using result function
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo $w->toXML();
```

##### Example using array
```php
$results = array();
$temp = array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
);
array_push($results, $temp);
echo $w->toXML($results);
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="itemuid" arg="itemarg" autocomplete="autocomplete">
        <title>Some Item Title</title>
        <subtitle>Some item subtitle</subtitle>
        <icon>icon.png</icon>
    </item>
</items>
```

#### `array` mdfind()
Executes an `mdfind` command and returns results as an array of matching files.

```php
$results = $w->mdfind('"kMDItemContentType == com.apple.mail.emlx"');
/* or */
$results = $w->mdfind('Alfred 2.app');
#=> (array) ['/Applications/Alfred 2.app']
```

#### `array` result()
Creates a new result item that is cached within the class object. This set of results is available via the `results()`
functions, or, can be formatted and returned as XML via the `toXML()` function.

Autocomplete value is optional. If no value is specified, it will take the value of the result title. Possible values
for `$valid` are `yes` and `no` to set the validity of the result item.

##### Example
```php
$w->result(array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
));
echo $w->toXML();
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="alfred" arg="alfredapp" autocomplete="Alfredapp">
        <title>Alfred</title>
        <subtitle>/Applications/Alfred.app</subtitle>
        <icon type="fileicon">/Applications/Alfred.app</icon>
    </item>
</items>
```


## `Alfred\Storage\Plist`

```php
use Alfred\Storage\Plist;

$plist = new Plist('com.ryanparman.my-workflow');
#=> <Alfred\Storage\Plist>
```


### Methods

#### `string` setValue()
Stores a key-value pair.

```php
$plist->setValue('username', 'rparman');
```

#### `string` setValues()
Stores a series of key-value pairs.

```php
$plist->setValues(array(
    'username' => 'rparman',
    'password' => 'abc123',
    'zipcode'  => '90210',
));
```

#### `string` getValue()
Retrieves the value of a key.

```php
$username = $plist->getValue('username');
#=> (string) rparman
```

CHANGELOG
=========

2.1.0
-----

 * added TraceableEventDispatcherInterface
 * added ContainerAwareEventDispatcher
 * added a reference to the EventDispatcher on the Event
 * added a reference to the Event name on the event
 * added fluid interface to the dispatch() method which now returns the Event
   object
 * added GenericEvent event class
 * added the possibility for subscribers to subscribe several times for the
   same event
 * added ImmutableEventDispatcher

EventDispatcher Component
=========================

EventDispatcher implements a lightweight version of the Observer design
pattern.

    use Symfony\Component\EventDispatcher\EventDispatcher;
    use Symfony\Component\EventDispatcher\Event;

    $dispatcher = new EventDispatcher();

    $dispatcher->addListener('event_name', function (Event $event) {
        // ...
    });

    $dispatcher->dispatch('event_name');

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/EventDispatcher/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.2.0
-----

 * added a delete option for the mirror() method

2.1.0
-----

 * 24eb396 : BC Break : mkdir() function now throws exception in case of failure instead of returning Boolean value
 * created the component

Filesystem Component
====================

Filesystem provides basic utility to manipulate the file system:

```php
<?php

use Symfony\Component\Filesystem\Filesystem;

$filesystem = new Filesystem();

$filesystem->copy($originFile, $targetFile, $override = false);

$filesystem->mkdir($dirs, $mode = 0777);

$filesystem->touch($files, $time = null, $atime = null);

$filesystem->remove($files);

$filesystem->chmod($files, $mode, $umask = 0000, $recursive = false);

$filesystem->chown($files, $user, $recursive = false);

$filesystem->chgrp($files, $group, $recursive = false);

$filesystem->rename($origin, $target);

$filesystem->symlink($originDir, $targetDir, $copyOnWindows = false);

$filesystem->makePathRelative($endPath, $startPath);

$filesystem->mirror($originDir, $targetDir, \Traversable $iterator = null, $options = array());

$filesystem->isAbsolutePath($file);
```

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/Filesystem/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.2.0
-----

 * added ProcessBuilder::setArguments() to reset the arguments on a builder
 * added a way to retrieve the standard and error output incrementally
 * added Process:restart()

2.1.0
-----

 * added support for non-blocking processes (start(), wait(), isRunning(), stop())
 * enhanced Windows compatibility
 * added Process::getExitCodeText() that returns a string representation for
   the exit code returned by the process
 * added ProcessBuilder

Process Component
=================

Process executes commands in sub-processes.

In this example, we run a simple directory listing and get the result back:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->setTimeout(3600);
    $process->run();
    if (!$process->isSuccessful()) {
        throw new RuntimeException($process->getErrorOutput());
    }

    print $process->getOutput();

You can think that this is easy to achieve with plain PHP but it's not especially
if you want to take care of the subtle differences between the different platforms.

And if you want to be able to get some feedback in real-time, just pass an
anonymous function to the ``run()`` method and you will get the output buffer
as it becomes available:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->run(function ($type, $buffer) {
        if ('err' === $type) {
            echo 'ERR > '.$buffer;
        } else {
            echo 'OUT > '.$buffer;
        }
    });

That's great if you want to execute a long running command (like rsync-ing files to a
remote server) and give feedback to the user in real-time.

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/XXX/
    $ composer.phar install --dev
    $ phpunit

GitHub Workflow for [Alfred 2](http://www.alfredapp.com)
==============================

It works almost like the [GitHub command bar](https://github.com/blog/1264-introducing-the-command-bar), the keyword is "gh" (example: `gh github/gollum issues`).

With `enter` you can open the entry in your default browser. If you just want to copy the URL of a repo/user/issue, hit `cmd+c` on an entry. Hit `cmd+enter` to paste the URL to the front most app. With `shift` or `cmd+y` you can open the URL in QuickLook.

There are some additional workflow specific commands, they begin with `>`:

* `gh > login <user>`
* `gh > logout`
* `gh > delete cache`
* `gh > update`
* `gh > activate autoupdate`
* `gh > deactivate autoupdate`

You have to login before you can use the workflow. The login command opens a dialog box for the password. The workflow does not save the plain password, only a cookie for the login.

**[DOWNLOAD](http://gh01.de/alfred/github/github.alfredworkflow)**

![Workflow Screenshot](http://gh01.de/alfred/github/workflow.png)


= Google Search

Fast, feature rich Google Search client. Search web results, images,
books, local, patents, blogs and news using an elegant Ruby API with
only a single dependency.

== Dependencies 

* json gem

== Features

* Fast
* Lazy Enumeration (requests more results from google, not all at once)
* Populates Google::Search::Item's blog, book, image, local, news, patent, video, and web
* Clean, well documented source code
* Full test coverage

== Classes

  - Google::Search                  | superclass of all other search classes. Is Enumerable
  - Google::Search::Web             | web search.
  - Google::Search::Blog            | blog search.
  - Google::Search::Book            | book search.
  - Google::Search::Image           | image search.
  - Google::Search::Local           | local search.
  - Google::Search::News            | news search.
  - Google::Search::Patent          | patent search.
  - Google::Search::Video           | video search.
  - Google::Search::Response        | single request response, containing items. Is Enumerable
  - Google::Search::Item            | single item, superclass of all other items.
  - Google::Search::Item::Web       | single item containing web specific data.
  - Google::Search::Item::Blog      | single item containing blog specific data.
  - Google::Search::Item::Book      | single item containing book specific data.
  - Google::Search::Item::Image     | single item containing image specific data.
  - Google::Search::Item::Local     | single item containing local specific data.
  - Google::Search::Item::News      | single item containing news specific data.
  - Google::Search::Item::Patent    | single item containing patent specific data.
  - Google::Search::Item::Video     | single item containing video specific data.

== Arbitrary Query String Support

Arbitrary key / value pairs may be passed to Google::Search.new, all options
passed that are not assigned (deleted) will pass on to be part of the query string. 

For argument reference visit: http://code.google.com/apis/ajaxsearch/documentation/reference.html#_fonje_web
  
== Items

Each item type (web, image, etc) is a subclass of Google::Search::Item,
whose constant is Google::Search::Item::{Web, Image, Blog, etc}. Every aspect
of google-search is well documented, so poke around to learn more or view
spec/item_spec.rb for item attributes.

== Image example

Below we simply create a new :image search, and pass a :query string.
Query strings are urlencoded when Search#get_uri is called, so there
is no reason to do so manually.

  File.open('path/to/images.html', 'w+') do |file|
    Google::Search::Image.new(:query => 'Cookies').each do |image|
      file.write %(<img src="#{image.uri}">)
    end
  end
  
== More Information

* View the source :) 

== License:

(The MIT License)

Copyright (c) 2009 TJ Holowaychuk <tj@vision-media.ca>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, an d/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

JSON-JRuby
==========

JSON-JRuby is a port of Florian Frank's native
[`json` library](http://json.rubyforge.org/) to JRuby.
It aims to be a perfect drop-in replacement for `json_pure`.


Development version
===================

The latest version is available from the
[Git repository](http://github.com/mernen/json-jruby/tree):

    git clone git://github.com/mernen/json-jruby.git


Compiling
=========

You'll need JRuby version 1.2 or greater to build JSON-JRuby.
Its path must be set on the `jruby.dir` property of
`nbproject/project.properties` (defaults to `../jruby`).

Additionally, you'll need [Ant](http://ant.apache.org/), and
[Ragel](http://www.cs.queensu.ca/~thurston/ragel/) 6.4 or greater.

Then, from the folder where the sources are located, type:

    ant clean jar

to clean any leftovers from previous builds and generate the `.jar` files.
To generate a RubyGem, specify the `gem` action rather than `jar`.

= JSON implementation for Ruby {<img src="https://secure.travis-ci.org/flori/json.png" />}[http://travis-ci.org/flori/json]

== Description

This is a implementation of the JSON specification according to RFC 4627
http://www.ietf.org/rfc/rfc4627.txt . Starting from version 1.0.0 on there
will be two variants available:

* A pure ruby variant, that relies on the iconv and the stringscan
  extensions, which are both part of the ruby standard library.
* The quite a bit faster C extension variant, which is in parts implemented
  in C and comes with its own unicode conversion functions and a parser
  generated by the ragel state machine compiler
  http://www.cs.queensu.ca/~thurston/ragel .

Both variants of the JSON generator generate UTF-8 character sequences by
default. If an :ascii_only option with a true value is given, they escape all
non-ASCII and control characters with \uXXXX escape sequences, and support
UTF-16 surrogate pairs in order to be able to generate the whole range of
unicode code points.

All strings, that are to be encoded as JSON strings, should be UTF-8 byte
sequences on the Ruby side. To encode raw binary strings, that aren't UTF-8
encoded, please use the to_json_raw_object method of String (which produces
an object, that contains a byte array) and decode the result on the receiving
endpoint.

The JSON parsers can parse UTF-8, UTF-16BE, UTF-16LE, UTF-32BE, and UTF-32LE
JSON documents under Ruby 1.8. Under Ruby 1.9 they take advantage of Ruby's
M17n features and can parse all documents which have the correct
String#encoding set. If a document string has ASCII-8BIT as an encoding the
parser attempts to figure out which of the UTF encodings from above it is and
trys to parse it.

== Installation

It's recommended to use the extension variant of JSON, because it's faster than
the pure ruby variant. If you cannot build it on your system, you can settle
for the latter.

Just type into the command line as root:

  # rake install

The above command will build the extensions and install them on your system.

  # rake install_pure

or

  # ruby install.rb

will just install the pure ruby implementation of JSON.

If you use Rubygems you can type

  # gem install json

instead, to install the newest JSON version.

There is also a pure ruby json only variant of the gem, that can be installed
with:

  # gem install json_pure

== Compiling the extensions yourself

If you want to build the extensions yourself you need rake:

  You can get it from rubyforge:
    http://rubyforge.org/projects/rake

  or just type

  # gem install rake

  for the installation via rubygems.

If you want to create the parser.c file from its parser.rl file or draw nice
graphviz images of the state machines, you need ragel from: http://www.cs.queensu.ca/~thurston/ragel


== Usage

To use JSON you can
  require 'json'
to load the installed variant (either the extension 'json' or the pure
variant 'json_pure'). If you have installed the extension variant, you can
pick either the extension variant or the pure variant by typing
  require 'json/ext'
or
  require 'json/pure'

Now you can parse a JSON document into a ruby data structure by calling

  JSON.parse(document)

If you want to generate a JSON document from a ruby data structure call
  JSON.generate(data)

You can also use the pretty_generate method (which formats the output more
verbosely and nicely) or fast_generate (which doesn't do any of the security
checks generate performs, e. g. nesting deepness checks).

To create a valid JSON document you have to make sure, that the output is
embedded in either a JSON array [] or a JSON object {}. The easiest way to do
this, is by putting your values in a Ruby Array or Hash instance.

There are also the JSON and JSON[] methods which use parse on a String or
generate a JSON document from an array or hash:

  document = JSON 'test'  => 23 # => "{\"test\":23}"
  document = JSON['test'] => 23 # => "{\"test\":23}"

and

  data = JSON '{"test":23}'  # => {"test"=>23}
  data = JSON['{"test":23}'] # => {"test"=>23}

You can choose to load a set of common additions to ruby core's objects if
you
  require 'json/add/core'

After requiring this you can, e. g., serialise/deserialise Ruby ranges:

  JSON JSON(1..10) # => 1..10

To find out how to add JSON support to other or your own classes, read the
section "More Examples" below.

To get the best compatibility to rails' JSON implementation, you can
  require 'json/add/rails'

Both of the additions attempt to require 'json' (like above) first, if it has
not been required yet.

== More Examples

To create a JSON document from a ruby data structure, you can call
JSON.generate like that:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,\"4..10\"]"

To get back a ruby data structure from a JSON document, you have to call
JSON.parse on it:

 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, "4..10"]

Note, that the range from the original data structure is a simple
string now. The reason for this is, that JSON doesn't support ranges
or arbitrary classes. In this case the json library falls back to call
Object#to_json, which is the same as #to_s.to_json.

It's possible to add JSON support serialization to arbitrary classes by
simply implementing a more specialized version of the #to_json method, that
should return a JSON object (a hash converted to JSON with #to_json) like
this (don't forget the *a for all the arguments):

 class Range
   def to_json(*a)
     {
       'json_class'   => self.class.name, # = 'Range'
       'data'         => [ first, last, exclude_end? ]
     }.to_json(*a)
   end
 end

The hash key 'json_class' is the class, that will be asked to deserialise the
JSON representation later. In this case it's 'Range', but any namespace of
the form 'A::B' or '::A::B' will do. All other keys are arbitrary and can be
used to store the necessary data to configure the object to be deserialised.

If a the key 'json_class' is found in a JSON object, the JSON parser checks
if the given class responds to the json_create class method. If so, it is
called with the JSON object converted to a Ruby hash. So a range can
be deserialised by implementing Range.json_create like this:

 class Range
   def self.json_create(o)
     new(*o['data'])
   end
 end

Now it possible to serialise/deserialise ranges as well:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,{\"json_class\":\"Range\",\"data\":[4,10,false]}]"
 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, 4..10]

JSON.generate always creates the shortest possible string representation of a
ruby data structure in one line. This is good for data storage or network
protocols, but not so good for humans to read. Fortunately there's also
JSON.pretty_generate (or JSON.pretty_generate) that creates a more readable
output:

 puts JSON.pretty_generate([1, 2, {"a"=>3.141}, false, true, nil, 4..10])
 [
   1,
   2,
   {
     "a": 3.141
   },
   false,
   true,
   null,
   {
     "json_class": "Range",
     "data": [
       4,
       10,
       false
     ]
   }
 ]

There are also the methods Kernel#j for generate, and Kernel#jj for
pretty_generate output to the console, that work analogous to Core Ruby's p and
the pp library's pp methods.

The script tools/server.rb contains a small example if you want to test, how
receiving a JSON object from a webrick server in your browser with the
javasript prototype library http://www.prototypejs.org works.

== Speed Comparisons

I have created some benchmark results (see the benchmarks/data-p4-3Ghz
subdir of the package) for the JSON-parser to estimate the speed up in the C
extension:

 Comparing times (call_time_mean):
  1 ParserBenchmarkExt#parser   900 repeats:
        553.922304770 (  real) ->   21.500x 
          0.001805307
  2 ParserBenchmarkYAML#parser  1000 repeats:
        224.513358139 (  real) ->    8.714x 
          0.004454078
  3 ParserBenchmarkPure#parser  1000 repeats:
         26.755020642 (  real) ->    1.038x 
          0.037376163
  4 ParserBenchmarkRails#parser 1000 repeats:
         25.763381731 (  real) ->    1.000x 
          0.038814780
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1 is JSON::Ext::Parser, 2 is YAML.load with YAML
compatbile JSON document, 3 is is JSON::Pure::Parser, and 4 is
ActiveSupport::JSON.decode. The ActiveSupport JSON-decoder converts the
input first to YAML and then uses the YAML-parser, the conversion seems to
slow it down so much that it is only as fast as the JSON::Pure::Parser!

If you look at the benchmark data you can see that this is mostly caused by
the frequent high outliers - the median of the Rails-parser runs is still
overall smaller than the median of the JSON::Pure::Parser runs:

 Comparing times (call_time_median):
  1 ParserBenchmarkExt#parser   900 repeats:
        800.592479481 (  real) ->   26.936x 
          0.001249075
  2 ParserBenchmarkYAML#parser  1000 repeats:
        271.002390644 (  real) ->    9.118x 
          0.003690004
  3 ParserBenchmarkRails#parser 1000 repeats:
         30.227910865 (  real) ->    1.017x 
          0.033082008
  4 ParserBenchmarkPure#parser  1000 repeats:
         29.722384421 (  real) ->    1.000x 
          0.033644676
            calls/sec (  time) ->    speed  covers
            secs/call

I have benchmarked the JSON-Generator as well. This generated a few more
values, because there are different modes that also influence the achieved
speed:

 Comparing times (call_time_mean):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        547.354332608 (  real) ->   15.090x 
          0.001826970
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        443.968212317 (  real) ->   12.240x 
          0.002252414
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        375.104545883 (  real) ->   10.341x 
          0.002665923
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         49.978706968 (  real) ->    1.378x 
          0.020008521
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         38.531868759 (  real) ->    1.062x 
          0.025952543
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         36.927649925 (  real) ->    1.018x 7 (>=3859)
          0.027079979
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         36.272134441 (  real) ->    1.000x 6 (>=3859)
          0.027569373
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1-3 are JSON::Ext::Generator methods. 4, 6, and 7 are
JSON::Pure::Generator methods and 5 is the Rails JSON generator. It is now a
bit faster than the generator_safe and generator_pretty methods of the pure
variant but slower than the others.

To achieve the fastest JSON document output, you can use the fast_generate
method. Beware, that this will disable the checking for circular Ruby data
structures, which may cause JSON to go into an infinite loop.

Here are the median comparisons for completeness' sake:

 Comparing times (call_time_median):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        708.258020939 (  real) ->   16.547x 
          0.001411915
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        569.105020353 (  real) ->   13.296x 
          0.001757145
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        482.825371244 (  real) ->   11.280x 
          0.002071142
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         62.717626652 (  real) ->    1.465x 
          0.015944481
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         43.965681162 (  real) ->    1.027x 
          0.022745013
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         43.929073409 (  real) ->    1.026x 7 (>=3859)
          0.022763968
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         42.802514491 (  real) ->    1.000x 6 (>=3859)
          0.023363113
            calls/sec (  time) ->    speed  covers
            secs/call

== Author

Florian Frank <mailto:flori@ping.de>

== License

Ruby License, see the COPYING file included in the source distribution. The
Ruby License includes the GNU General Public License (GPL), Version 2, so see
the file GPL as well.

== Download

The latest version of this library can be downloaded at

* http://rubyforge.org/frs?group_id=953

Online Documentation should be located at

* http://json.rubyforge.org

#include <html_element_description.h>

/*
 * call-seq:
 *  required_attributes
 *
 * A list of required attributes for this element
 */
static VALUE required_attributes(VALUE self)
{
  htmlElemDesc * description;
  VALUE list;
  int i;

  Data_Get_Struct(self, htmlElemDesc, description);

  list = rb_ary_new();

  if(NULL == description->attrs_req) return list;

  for(i = 0; description->attrs_depr[i]; i++) {
    rb_ary_push(list, NOKOGIRI_STR_NEW2(description->attrs_req[i]));
  }

  return list;
}

/*
 * call-seq:
 *  deprecated_attributes
 *
 * A list of deprecated attributes for this element
 */
static VALUE deprecated_attributes(VALUE self)
{
  htmlElemDesc * description;
  VALUE list;
  int i;

  Data_Get_Struct(self, htmlElemDesc, description);

  list = rb_ary_new();

  if(NULL == description->attrs_depr) return list;

  for(i = 0; description->attrs_depr[i]; i++) {
    rb_ary_push(list, NOKOGIRI_STR_NEW2(description->attrs_depr[i]));
  }

  return list;
}

/*
 * call-seq:
 *  optional_attributes
 *
 * A list of optional attributes for this element
 */
static VALUE optional_attributes(VALUE self)
{
  htmlElemDesc * description;
  VALUE list;
  int i;

  Data_Get_Struct(self, htmlElemDesc, description);

  list = rb_ary_new();

  if(NULL == description->attrs_opt) return list;

  for(i = 0; description->attrs_opt[i]; i++) {
    rb_ary_push(list, NOKOGIRI_STR_NEW2(description->attrs_opt[i]));
  }

  return list;
}

/*
 * call-seq:
 *  default_sub_element
 *
 * The default sub element for this element
 */
static VALUE default_sub_element(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  return NOKOGIRI_STR_NEW2(description->defaultsubelt);
}

/*
 * call-seq:
 *  sub_elements
 *
 * A list of allowed sub elements for this element.
 */
static VALUE sub_elements(VALUE self)
{
  htmlElemDesc * description;
  VALUE list;
  int i;

  Data_Get_Struct(self, htmlElemDesc, description);

  list = rb_ary_new();

  if(NULL == description->subelts) return list;

  for(i = 0; description->subelts[i]; i++) {
    rb_ary_push(list, NOKOGIRI_STR_NEW2(description->subelts[i]));
  }

  return list;
}

/*
 * call-seq:
 *  description
 *
 * The description for this element
 */
static VALUE description(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  return NOKOGIRI_STR_NEW2(description->desc);
}

/*
 * call-seq:
 *  inline?
 *
 * Is this element an inline element?
 */
static VALUE inline_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->isinline) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  deprecated?
 *
 * Is this element deprecated?
 */
static VALUE deprecated_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->depr) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  empty?
 *
 * Is this an empty element?
 */
static VALUE empty_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->empty) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  save_end_tag?
 *
 * Should the end tag be saved?
 */
static VALUE save_end_tag_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->saveEndTag) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  implied_end_tag?
 *
 * Can the end tag be implied for this tag?
 */
static VALUE implied_end_tag_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->endTag) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  implied_start_tag?
 *
 * Can the start tag be implied for this tag?
 */
static VALUE implied_start_tag_eh(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(description->startTag) return Qtrue;
  return Qfalse;
}

/*
 * call-seq:
 *  name
 *
 * Get the tag name for this ElemementDescription
 */
static VALUE name(VALUE self)
{
  htmlElemDesc * description;
  Data_Get_Struct(self, htmlElemDesc, description);

  if(NULL == description->name) return Qnil;
  return NOKOGIRI_STR_NEW2(description->name);
}

/*
 * call-seq:
 *  [](tag_name)
 *
 * Get ElemementDescription for +tag_name+
 */
static VALUE get_description(VALUE klass, VALUE tag_name)
{
  const htmlElemDesc * description = htmlTagLookup(
      (const xmlChar *)StringValuePtr(tag_name)
  );

  if(NULL == description) return Qnil;
  return Data_Wrap_Struct(klass, 0, 0, (void *)description);
}

VALUE cNokogiriHtmlElementDescription ;
void init_html_element_description()
{
  VALUE nokogiri = rb_define_module("Nokogiri");
  VALUE html     = rb_define_module_under(nokogiri, "HTML");
  VALUE klass    = rb_define_class_under(html, "ElementDescription",rb_cObject);

  cNokogiriHtmlElementDescription = klass;

  rb_define_singleton_method(klass, "[]", get_description, 1);

  rb_define_method(klass, "name", name, 0);
  rb_define_method(klass, "implied_start_tag?", implied_start_tag_eh, 0);
  rb_define_method(klass, "implied_end_tag?", implied_end_tag_eh, 0);
  rb_define_method(klass, "save_end_tag?", save_end_tag_eh, 0);
  rb_define_method(klass, "empty?", empty_eh, 0);
  rb_define_method(klass, "deprecated?", deprecated_eh, 0);
  rb_define_method(klass, "inline?", inline_eh, 0);
  rb_define_method(klass, "description", description, 0);
  rb_define_method(klass, "sub_elements", sub_elements, 0);
  rb_define_method(klass, "default_sub_element", default_sub_element, 0);
  rb_define_method(klass, "optional_attributes", optional_attributes, 0);
  rb_define_method(klass, "deprecated_attributes", deprecated_attributes, 0);
  rb_define_method(klass, "required_attributes", required_attributes, 0);
}

#ifndef NOKOGIRI_HTML_ELEMENT_DESCRIPTION
#define NOKOGIRI_HTML_ELEMENT_DESCRIPTION

#include <nokogiri.h>

void init_html_element_description();

extern VALUE cNokogiriHtmlElementDescription ;

#endif

                        8                                                         __text          __TEXT                              p"  Q                 __debug_info    __DWARF               R            $  =                  __debug_abbrev  __DWARF         _                                          __debug_aranges __DWARF         C                                           __debug_macinfo __DWARF         C                                           __debug_line    __DWARF         C                  &                    __debug_loc     __DWARF               X            &  P                  __debug_pubtypes__DWARF         ]      $                                    __debug_str     __DWARF                     A                             __debug_ranges  __DWARF         G                                           __data          __DATA          G                                            __cstring       __TEXT          G                                          __common        __DATA                                                     __apple_names   __DWARF         (                  h)                     __apple_objc    __DWARF               $                                    __apple_namespac__DWARF         ,      $                                    __apple_types   __DWARF         P                   h*                    __debug_inlined __DWARF         2                                          __eh_frame      __TEXT          @      p                       h                  *  >   .       P       .   .      1                                                      UHSPH=        H5    H    H    HH5    H    HH5    H    H    H       H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1    H5    H    H1H[]    UHSPHHuH}    H       HtHH11    HHH[]UHSPH"       HC H8HtH[]       H[]UHSPH"       HC x HH[]UHSPH"       HC x	 HH[]UHSPH"       HC x
 HH[]UHSPH"       HC x HH[]UHSPH"       HC x HH[]UHSPH"       HC x HH[]UHSPH"       HC HxH[]    UHAWAVSPH"       Ls     IIFHt.H8Ht&       LH    IFH<HHuLH[A^A_]UHSPH"       HC Hx H[]    UHAWAVSPH"       Ls     IIF(Ht.H8Ht&       LH    IF(H<HHuLH[A^A_]UHAWAVSPH"       Ls     IIF0Ht.H8Ht&       LH    IF0H<HHuLH[A^A_]UHAWAVSPH"       L{     IIG8Ht6IO0H9 t,1HIG8H<    LH    IG0H| uLH[A^A_]N            ?               Z      '     Z   .   	                      V               .          .   #   
module Nokogiri
  module HTML
    class ElementDescription
      ###
      # Is this element a block element?
      def block?
        !inline?
      end

      ###
      # Convert this description to a string
      def to_s
        "#{name}: #{description}"
      end

      ###
      # Inspection information
      def inspect
        "#<#{self.class.name}: #{name} #{description}>"
      end
    end
  end
end

module Nokogiri
  module HTML
    class ElementDescription

      # Methods are defined protected by method_defined? because at
      # this point the C-library or Java library is already loaded,
      # and we don't want to clobber any methods that have been
      # defined there.

      Desc = Struct.new("HTMLElementDescription", :name,
                        :startTag, :endTag, :saveEndTag,
                        :empty, :depr, :dtd, :isinline,
                        :desc,
                        :subelts, :defaultsubelt,
                        :attrs_opt, :attrs_depr, :attrs_req)

      # This is filled in down below.
      DefaultDescriptions = Hash.new()

      def default_desc
        DefaultDescriptions[name.downcase]
      end
      private :default_desc

      unless method_defined? :implied_start_tag?
        def implied_start_tag?
          d = default_desc
          d ? d.startTag : nil
        end
      end

      unless method_defined? :implied_end_tag?
        def implied_end_tag?
          d = default_desc
          d ? d.endTag : nil
        end
      end

      unless method_defined? :save_end_tag?
        def save_end_tag?
          d = default_desc
          d ? d.saveEndTag : nil
        end
      end

      unless method_defined? :deprecated?
        def deprecated?
          d = default_desc
          d ? d.depr : nil
        end
      end

      unless method_defined? :description
        def description
          d = default_desc
          d ? d.desc : nil
        end
      end

      unless method_defined? :default_sub_element
        def default_sub_element
          d = default_desc
          d ? d.defaultsubelt : nil
        end
      end

      unless method_defined? :optional_attributes
        def optional_attributes
          d = default_desc
          d ? d.attrs_opt : []
        end
      end

      unless method_defined? :deprecated_attributes
        def deprecated_attributes
          d = default_desc
          d ? d.attrs_depr : []
        end
      end

      unless method_defined? :required_attributes
        def required_attributes
          d = default_desc
          d ? d.attrs_req : []
        end
      end

      ###
      # Default Element Descriptions (HTML 4.0) copied from
      # libxml2/HTMLparser.c and libxml2/include/libxml/HTMLparser.h
      #
      # The copyright notice for those files and the following list of
      # element and attribute descriptions is reproduced here:
      #
      # Except where otherwise noted in the source code (e.g. the
      # files hash.c, list.c and the trio files, which are covered by
      # a similar licence but with different Copyright notices) all
      # the files are:
      #
      #  Copyright (C) 1998-2003 Daniel Veillard.  All Rights Reserved.
      #
      # Permission is hereby granted, free of charge, to any person
      # obtaining a copy of this software and associated documentation
      # files (the "Software"), to deal in the Software without
      # restriction, including without limitation the rights to use,
      # copy, modify, merge, publish, distribute, sublicense, and/or
      # sell copies of the Software, and to permit persons to whom the
      # Software is fur- nished to do so, subject to the following
      # conditions:

      # The above copyright notice and this permission notice shall be
      # included in all copies or substantial portions of the
      # Software.

      # THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY
      # KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
      # WARRANTIES OF MERCHANTABILITY, FIT- NESS FOR A PARTICULAR
      # PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE DANIEL
      # VEILLARD BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
      # WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
      # FROM, OUT OF OR IN CON- NECTION WITH THE SOFTWARE OR THE USE
      # OR OTHER DEALINGS IN THE SOFTWARE.

      # Except as contained in this notice, the name of Daniel
      # Veillard shall not be used in advertising or otherwise to
      # promote the sale, use or other deal- ings in this Software
      # without prior written authorization from him.

      # Attributes defined and categorized
      FONTSTYLE = ["tt", "i", "b", "u", "s", "strike", "big", "small"]
      PHRASE = ['em', 'strong', 'dfn', 'code', 'samp',
                'kbd', 'var', 'cite', 'abbr', 'acronym']
      SPECIAL = ['a', 'img', 'applet', 'embed', 'object', 'font','basefont',
                 'br', 'script', 'map', 'q', 'sub', 'sup', 'span', 'bdo',
                 'iframe']
      PCDATA = []
      HEADING = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6']
      LIST = ['ul', 'ol', 'dir', 'menu']
      FORMCTRL = ['input', 'select', 'textarea', 'label', 'button']
      BLOCK = [HEADING, LIST, 'pre', 'p', 'dl', 'div', 'center', 'noscript',
               'noframes', 'blockquote', 'form', 'isindex', 'hr', 'table',
               'fieldset', 'address']
      INLINE = [PCDATA, FONTSTYLE, PHRASE, SPECIAL, FORMCTRL]
      FLOW = [BLOCK, INLINE]
      MODIFIER = []
      EMPTY = []

      HTML_FLOW = FLOW
      HTML_INLINE = INLINE
      HTML_PCDATA = PCDATA
      HTML_CDATA = HTML_PCDATA

      COREATTRS = ['id', 'class', 'style', 'title']
      I18N = ['lang', 'dir']
      EVENTS = ['onclick', 'ondblclick', 'onmousedown', 'onmouseup',
                'onmouseover', 'onmouseout', 'onkeypress', 'onkeydown',
                'onkeyup']
      ATTRS = [COREATTRS, I18N,EVENTS]
      CELLHALIGN = ['align', 'char', 'charoff']
      CELLVALIGN = ['valign']

      HTML_ATTRS = ATTRS
      CORE_I18N_ATTRS = [COREATTRS, I18N]
      CORE_ATTRS = COREATTRS
      I18N_ATTRS = I18N


      A_ATTRS = [ATTRS, 'charset', 'type', 'name',
                 'href', 'hreflang', 'rel', 'rev', 'accesskey', 'shape',
                 'coords', 'tabindex', 'onfocus', 'onblur']
      TARGET_ATTR = ['target']
      ROWS_COLS_ATTR = ['rows', 'cols']
      ALT_ATTR = ['alt']
      SRC_ALT_ATTRS = ['src', 'alt']
      HREF_ATTRS = ['href']
      CLEAR_ATTRS = ['clear']
      INLINE_P = [INLINE, 'p']

      FLOW_PARAM = [FLOW, 'param']
      APPLET_ATTRS = [COREATTRS , 'codebase',
                      'archive', 'alt', 'name', 'height', 'width', 'align',
                      'hspace', 'vspace']
      AREA_ATTRS = ['shape', 'coords', 'href', 'nohref',
                    'tabindex', 'accesskey', 'onfocus', 'onblur']
      BASEFONT_ATTRS = ['id', 'size', 'color', 'face']
      QUOTE_ATTRS = [ATTRS, 'cite']
      BODY_CONTENTS = [FLOW, 'ins', 'del']
      BODY_ATTRS = [ATTRS, 'onload', 'onunload']
      BODY_DEPR = ['background', 'bgcolor', 'text',
                   'link', 'vlink', 'alink']
      BUTTON_ATTRS = [ATTRS, 'name', 'value', 'type',
                      'disabled', 'tabindex', 'accesskey', 'onfocus', 'onblur']


      COL_ATTRS = [ATTRS, 'span', 'width', CELLHALIGN, CELLVALIGN]
      COL_ELT = ['col']
      EDIT_ATTRS = [ATTRS, 'datetime', 'cite']
      COMPACT_ATTRS = [ATTRS, 'compact']
      DL_CONTENTS = ['dt', 'dd']
      COMPACT_ATTR = ['compact']
      LABEL_ATTR = ['label']
      FIELDSET_CONTENTS = [FLOW, 'legend' ]
      FONT_ATTRS = [COREATTRS, I18N, 'size', 'color', 'face' ]
      FORM_CONTENTS = [HEADING, LIST, INLINE, 'pre', 'p', 'div', 'center',
                       'noscript', 'noframes', 'blockquote', 'isindex', 'hr',
                       'table', 'fieldset', 'address']
      FORM_ATTRS = [ATTRS, 'method', 'enctype', 'accept', 'name', 'onsubmit',
                    'onreset', 'accept-charset']
      FRAME_ATTRS = [COREATTRS, 'longdesc', 'name', 'src', 'frameborder',
                     'marginwidth', 'marginheight', 'noresize', 'scrolling' ]
      FRAMESET_ATTRS = [COREATTRS, 'rows', 'cols', 'onload', 'onunload']
      FRAMESET_CONTENTS = ['frameset', 'frame', 'noframes']
      HEAD_ATTRS = [I18N, 'profile']
      HEAD_CONTENTS = ['title', 'isindex', 'base', 'script', 'style', 'meta',
                       'link', 'object']
      HR_DEPR = ['align', 'noshade', 'size', 'width']
      VERSION_ATTR = ['version']
      HTML_CONTENT = ['head', 'body', 'frameset']
      IFRAME_ATTRS = [COREATTRS, 'longdesc', 'name', 'src', 'frameborder',
                      'marginwidth', 'marginheight', 'scrolling', 'align',
                      'height', 'width']
      IMG_ATTRS = [ATTRS, 'longdesc', 'name', 'height', 'width', 'usemap',
                   'ismap']
      EMBED_ATTRS = [COREATTRS, 'align', 'alt', 'border', 'code', 'codebase',
                     'frameborder', 'height', 'hidden', 'hspace', 'name',
                     'palette', 'pluginspace', 'pluginurl', 'src', 'type',
                     'units', 'vspace', 'width']
      INPUT_ATTRS = [ATTRS, 'type', 'name', 'value', 'checked', 'disabled',
                     'readonly', 'size', 'maxlength', 'src', 'alt', 'usemap',
                     'ismap', 'tabindex', 'accesskey', 'onfocus', 'onblur',
                     'onselect', 'onchange', 'accept']
      PROMPT_ATTRS = [COREATTRS, I18N, 'prompt']
      LABEL_ATTRS = [ATTRS, 'for', 'accesskey', 'onfocus', 'onblur']
      LEGEND_ATTRS = [ATTRS, 'accesskey']
      ALIGN_ATTR = ['align']
      LINK_ATTRS = [ATTRS, 'charset', 'href', 'hreflang', 'type', 'rel', 'rev',
                    'media']
      MAP_CONTENTS = [BLOCK, 'area']
      NAME_ATTR = ['name']
      ACTION_ATTR = ['action']
      BLOCKLI_ELT = [BLOCK, 'li']
      META_ATTRS = [I18N, 'http-equiv', 'name', 'scheme']
      CONTENT_ATTR = ['content']
      TYPE_ATTR = ['type']
      NOFRAMES_CONTENT = ['body', FLOW, MODIFIER]
      OBJECT_CONTENTS = [FLOW, 'param']
      OBJECT_ATTRS = [ATTRS, 'declare', 'classid', 'codebase', 'data', 'type',
                      'codetype', 'archive', 'standby', 'height', 'width',
                      'usemap', 'name', 'tabindex']
      OBJECT_DEPR = ['align', 'border', 'hspace', 'vspace']
      OL_ATTRS = ['type', 'compact', 'start']
      OPTION_ELT = ['option']
      OPTGROUP_ATTRS = [ATTRS, 'disabled']
      OPTION_ATTRS = [ATTRS, 'disabled', 'label', 'selected', 'value']
      PARAM_ATTRS = ['id', 'value', 'valuetype', 'type']
      WIDTH_ATTR = ['width']
      PRE_CONTENT = [PHRASE, 'tt', 'i', 'b', 'u', 's', 'strike', 'a', 'br',
                     'script', 'map', 'q', 'span', 'bdo', 'iframe']
      SCRIPT_ATTRS = ['charset', 'src', 'defer', 'event', 'for']
      LANGUAGE_ATTR = ['language']
      SELECT_CONTENT = ['optgroup', 'option']
      SELECT_ATTRS = [ATTRS, 'name', 'size', 'multiple', 'disabled', 'tabindex',
                      'onfocus', 'onblur', 'onchange']
      STYLE_ATTRS = [I18N, 'media', 'title']
      TABLE_ATTRS = [ATTRS, 'summary', 'width', 'border', 'frame', 'rules',
                     'cellspacing', 'cellpadding', 'datapagesize']
      TABLE_DEPR = ['align', 'bgcolor']
      TABLE_CONTENTS = ['caption', 'col', 'colgroup', 'thead', 'tfoot', 'tbody',
                        'tr']
      TR_ELT = ['tr']
      TALIGN_ATTRS = [ATTRS, CELLHALIGN, CELLVALIGN]
      TH_TD_DEPR = ['nowrap', 'bgcolor', 'width', 'height']
      TH_TD_ATTR = [ATTRS, 'abbr', 'axis', 'headers', 'scope', 'rowspan',
                    'colspan', CELLHALIGN, CELLVALIGN]
      TEXTAREA_ATTRS = [ATTRS, 'name', 'disabled', 'readonly', 'tabindex',
                        'accesskey', 'onfocus', 'onblur', 'onselect',
                        'onchange']
      TR_CONTENTS = ['th', 'td']
      BGCOLOR_ATTR = ['bgcolor']
      LI_ELT = ['li']
      UL_DEPR = ['type', 'compact']
      DIR_ATTR = ['dir']

      [
       ['a', false, false, false, false, false, :any, true,
        'anchor ',
        HTML_INLINE, nil, A_ATTRS, TARGET_ATTR, []
       ],
       ['abbr', false, false, false, false, false, :any, true,
        'abbreviated form',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['acronym', false, false, false, false, false, :any, true, '',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['address', false, false, false, false, false, :any, false,
        'information on author',
        INLINE_P , nil, HTML_ATTRS, [], []
       ],
       ['applet', false, false, false, false, true, :loose, true,
        'java applet ',
        FLOW_PARAM, nil, [], APPLET_ATTRS, []
       ],
       ['area', false, true, true, true, false, :any, false,
        'client-side image map area ',
        EMPTY, nil, AREA_ATTRS, TARGET_ATTR, ALT_ATTR
       ],
       ['b', false, true, false, false, false, :any, true,
        'bold text style',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['base', false, true, true, true, false, :any, false,
        'document base uri ',
        EMPTY, nil, [], TARGET_ATTR, HREF_ATTRS
       ],
       ['basefont', false, true, true, true, true, :loose, true,
        'base font size ',
        EMPTY, nil, [], BASEFONT_ATTRS, []
       ],
       ['bdo', false, false, false, false, false, :any, true,
        'i18n bidi over-ride ',
        HTML_INLINE, nil, CORE_I18N_ATTRS, [], DIR_ATTR
       ],
       ['big', false, true, false, false, false, :any, true,
        'large text style',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['blockquote', false, false, false, false, false, :any, false,
        'long quotation ',
        HTML_FLOW, nil, QUOTE_ATTRS, [], []
       ],
       ['body', true, true, false, false, false, :any, false,
        'document body ',
        BODY_CONTENTS, 'div', BODY_ATTRS, BODY_DEPR, []
       ],
       ['br', false, true, true, true, false, :any, true,
        'forced line break ',
        EMPTY, nil, CORE_ATTRS, CLEAR_ATTRS, []
       ],
       ['button', false, false, false, false, false, :any, true,
        'push button ',
        [HTML_FLOW, MODIFIER], nil, BUTTON_ATTRS, [], []
       ],
       ['caption', false, false, false, false, false, :any, false,
        'table caption ',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['center', false, true, false, false, true, :loose, false,
        'shorthand for div align=center ',
        HTML_FLOW, nil, [], HTML_ATTRS, []
       ],
       ['cite', false, false, false, false, false, :any, true, 'citation',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['code', false, false, false, false, false, :any, true,
        'computer code fragment',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['col', false, true, true, true, false, :any, false, 'table column ',
        EMPTY, nil, COL_ATTRS, [], []
       ],
       ['colgroup', false, true, false, false, false, :any, false,
        'table column group ',
        COL_ELT, 'col', COL_ATTRS, [], []
       ],
       ['dd', false, true, false, false, false, :any, false,
        'definition description ',
        HTML_FLOW, nil, HTML_ATTRS, [], []
       ],
       ['del', false, false, false, false, false, :any, true,
        'deleted text ',
        HTML_FLOW, nil, EDIT_ATTRS, [], []
       ],
       ['dfn', false, false, false, false, false, :any, true,
        'instance definition',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['dir', false, false, false, false, true, :loose, false,
        'directory list',
        BLOCKLI_ELT, 'li', [], COMPACT_ATTRS, []
       ],
       ['div', false, false, false, false, false, :any, false,
        'generic language/style container',
        HTML_FLOW, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['dl', false, false, false, false, false, :any, false,
        'definition list ',
        DL_CONTENTS, 'dd', HTML_ATTRS, COMPACT_ATTR, []
       ],
       ['dt', false, true, false, false, false, :any, false,
        'definition term ',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['em', false, true, false, false, false, :any, true,
        'emphasis',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['embed', false, true, false, false, true, :loose, true,
        'generic embedded object ',
        EMPTY, nil, EMBED_ATTRS, [], []
       ],
       ['fieldset', false, false, false, false, false, :any, false,
        'form control group ',
        FIELDSET_CONTENTS, nil, HTML_ATTRS, [], []
       ],
       ['font', false, true, false, false, true, :loose, true,
        'local change to font ',
        HTML_INLINE, nil, [], FONT_ATTRS, []
       ],
       ['form', false, false, false, false, false, :any, false,
        'interactive form ',
        FORM_CONTENTS, 'fieldset', FORM_ATTRS, TARGET_ATTR, ACTION_ATTR
       ],
       ['frame', false, true, true, true, false, :frameset, false,
        'subwindow ',
        EMPTY, nil, [], FRAME_ATTRS, []
       ],
       ['frameset', false, false, false, false, false, :frameset, false,
        'window subdivision',
        FRAMESET_CONTENTS, 'noframes', [], FRAMESET_ATTRS, []
       ],
       ['htrue', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['htrue', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['htrue', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['h4', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['h5', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['h6', false, false, false, false, false, :any, false,
        'heading ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['head', true, true, false, false, false, :any, false,
        'document head ',
        HEAD_CONTENTS, nil, HEAD_ATTRS, [], []
       ],
       ['hr', false, true, true, true, false, :any, false,
        'horizontal rule ',
        EMPTY, nil, HTML_ATTRS, HR_DEPR, []
       ],
       ['html', true, true, false, false, false, :any, false,
        'document root element ',
        HTML_CONTENT, nil, I18N_ATTRS, VERSION_ATTR, []
       ],
       ['i', false, true, false, false, false, :any, true,
        'italic text style',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['iframe', false, false, false, false, false, :any, true,
        'inline subwindow ',
        HTML_FLOW, nil, [], IFRAME_ATTRS, []
       ],
       ['img', false, true, true, true, false, :any, true,
        'embedded image ',
        EMPTY, nil, IMG_ATTRS, ALIGN_ATTR, SRC_ALT_ATTRS
       ],
       ['input', false, true, true, true, false, :any, true,
        'form control ',
        EMPTY, nil, INPUT_ATTRS, ALIGN_ATTR, []
       ],
       ['ins', false, false, false, false, false, :any, true,
        'inserted text',
        HTML_FLOW, nil, EDIT_ATTRS, [], []
       ],
       ['isindex', false, true, true, true, true, :loose, false,
        'single line prompt ',
        EMPTY, nil, [], PROMPT_ATTRS, []
       ],
       ['kbd', false, false, false, false, false, :any, true,
        'text to be entered by the user',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['label', false, false, false, false, false, :any, true,
        'form field label text ',
        [HTML_INLINE, MODIFIER], nil, LABEL_ATTRS, [], []
       ],
       ['legend', false, false, false, false, false, :any, false,
        'fieldset legend ',
        HTML_INLINE, nil, LEGEND_ATTRS, ALIGN_ATTR, []
       ],
       ['li', false, true, true, false, false, :any, false,
        'list item ',
        HTML_FLOW, nil, HTML_ATTRS, [], []
       ],
       ['link', false, true, true, true, false, :any, false,
        'a media-independent link ',
        EMPTY, nil, LINK_ATTRS, TARGET_ATTR, []
       ],
       ['map', false, false, false, false, false, :any, true,
        'client-side image map ',
        MAP_CONTENTS, nil, HTML_ATTRS, [], NAME_ATTR
       ],
       ['menu', false, false, false, false, true, :loose, false,
        'menu list ',
        BLOCKLI_ELT, nil, [], COMPACT_ATTRS, []
       ],
       ['meta', false, true, true, true, false, :any, false,
        'generic metainformation ',
        EMPTY, nil, META_ATTRS, [], CONTENT_ATTR
       ],
       ['noframes', false, false, false, false, false, :frameset, false,
        'alternate content container for non frame-based rendering ',
        NOFRAMES_CONTENT, 'body', HTML_ATTRS, [], []
       ],
       ['noscript', false, false, false, false, false, :any, false,
        'alternate content container for non script-based rendering ',
        HTML_FLOW, 'div', HTML_ATTRS, [], []
       ],
       ['object', false, false, false, false, false, :any, true,
        'generic embedded object ',
        OBJECT_CONTENTS, 'div', OBJECT_ATTRS, OBJECT_DEPR, []
       ],
       ['ol', false, false, false, false, false, :any, false,
        'ordered list ',
        LI_ELT, 'li', HTML_ATTRS, OL_ATTRS, []
       ],
       ['optgroup', false, false, false, false, false, :any, false,
        'option group ',
        OPTION_ELT, 'option', OPTGROUP_ATTRS, [], LABEL_ATTR
       ],
       ['option', false, true, false, false, false, :any, false,
        'selectable choice ',
        HTML_PCDATA, nil, OPTION_ATTRS, [], []
       ],
       ['p', false, true, false, false, false, :any, false,
        'paragraph ',
        HTML_INLINE, nil, HTML_ATTRS, ALIGN_ATTR, []
       ],
       ['param', false, true, true, true, false, :any, false,
        'named property value ',
        EMPTY, nil, PARAM_ATTRS, [], NAME_ATTR
       ],
       ['pre', false, false, false, false, false, :any, false,
        'preformatted text ',
        PRE_CONTENT, nil, HTML_ATTRS, WIDTH_ATTR, []
       ],
       ['q', false, false, false, false, false, :any, true,
        'short inline quotation ',
        HTML_INLINE, nil, QUOTE_ATTRS, [], []
       ],
       ['s', false, true, false, false, true, :loose, true,
        'strike-through text style',
        HTML_INLINE, nil, [], HTML_ATTRS, []
       ],
       ['samp', false, false, false, false, false, :any, true,
        'sample program output, scripts, etc.',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['script', false, false, false, false, false, :any, true,
        'script statements ',
        HTML_CDATA, nil, SCRIPT_ATTRS, LANGUAGE_ATTR, TYPE_ATTR
       ],
       ['select', false, false, false, false, false, :any, true,
        'option selector ',
        SELECT_CONTENT, nil, SELECT_ATTRS, [], []
       ],
       ['small', false, true, false, false, false, :any, true,
        'small text style',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['span', false, false, false, false, false, :any, true,
        'generic language/style container ',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['strike', false, true, false, false, true, :loose, true,
        'strike-through text',
        HTML_INLINE, nil, [], HTML_ATTRS, []
       ],
       ['strong', false, true, false, false, false, :any, true,
        'strong emphasis',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['style', false, false, false, false, false, :any, false,
        'style info ',
        HTML_CDATA, nil, STYLE_ATTRS, [], TYPE_ATTR
       ],
       ['sub', false, true, false, false, false, :any, true,
        'subscript',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['sup', false, true, false, false, false, :any, true,
        'superscript ',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['table', false, false, false, false, false, :any, false,
        '',
        TABLE_CONTENTS, 'tr', TABLE_ATTRS, TABLE_DEPR, []
       ],
       ['tbody', true, false, false, false, false, :any, false,
        'table body ',
        TR_ELT, 'tr', TALIGN_ATTRS, [], []
       ],
       ['td', false, false, false, false, false, :any, false,
        'table data cell',
        HTML_FLOW, nil, TH_TD_ATTR, TH_TD_DEPR, []
       ],
       ['textarea', false, false, false, false, false, :any, true,
        'multi-line text field ',
        HTML_PCDATA, nil, TEXTAREA_ATTRS, [], ROWS_COLS_ATTR
       ],
       ['tfoot', false, true, false, false, false, :any, false,
        'table footer ',
        TR_ELT, 'tr', TALIGN_ATTRS, [], []
       ],
       ['th', false, true, false, false, false, :any, false,
        'table header cell',
        HTML_FLOW, nil, TH_TD_ATTR, TH_TD_DEPR, []
       ],
       ['thead', false, true, false, false, false, :any, false,
        'table header ',
        TR_ELT, 'tr', TALIGN_ATTRS, [], []
       ],
       ['title', false, false, false, false, false, :any, false,
        'document title ',
        HTML_PCDATA, nil, I18N_ATTRS, [], []
       ],
       ['tr', false, false, false, false, false, :any, false,
        'table row ',
        TR_CONTENTS, 'td', TALIGN_ATTRS, BGCOLOR_ATTR, []
       ],
       ['tt', false, true, false, false, false, :any, true,
        'teletype or monospaced text style',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ],
       ['u', false, true, false, false, true, :loose, true,
        'underlined text style',
        HTML_INLINE, nil, [], HTML_ATTRS, []
       ],
       ['ul', false, false, false, false, false, :any, false,
        'unordered list ',
        LI_ELT, 'li', HTML_ATTRS, UL_DEPR, []
       ],
       ['var', false, false, false, false, false, :any, true,
        'instance of a variable or program argument',
        HTML_INLINE, nil, HTML_ATTRS, [], []
       ]
      ].each do |descriptor|
        name = descriptor[0]

        begin
        d = Desc.new(*descriptor)

        # flatten all the attribute lists (Ruby1.9, *[a,b,c] can be
        # used to flatten a literal list, but not in Ruby1.8).
        d[:subelts] = d[:subelts].flatten
        d[:attrs_opt] = d[:attrs_opt].flatten
        d[:attrs_depr] = d[:attrs_depr].flatten
          d[:attrs_req] = d[:attrs_req].flatten
        rescue => e
            p name
          raise e
        end

        DefaultDescriptions[name] = d
      end
    end
  end
end

= Nokogiri () {<img src="https://secure.travis-ci.org/sparklemotion/nokogiri.png?rvm=1.9.3" />}[http://travis-ci.org/sparklemotion/nokogiri] {<img src="https://codeclimate.com/badge.png" />}[https://codeclimate.com/github/sparklemotion/nokogiri]

* http://nokogiri.org/
* http://github.com/sparklemotion/nokogiri/wikis
* http://github.com/sparklemotion/nokogiri/tree/master
* http://groups.google.com/group/nokogiri-list
* http://github.com/sparklemotion/nokogiri/issues

== DESCRIPTION:

Nokogiri HTMLXMLSAXXSLTReader
XPathCSS3

XML - XMLXML


== FEATURES:

* XPath 
* CSS3 
* XML/HTML

XML/HTMLCSS3XPath

== SUPPORT:

Nokogiri
{}[http://groups.google.com/group/nokogiri-list]

  * http://groups.google.com/group/nokogiri-list

{}[http://github.com/sparklemotion/nokogiri/issues]

  * http://github.com/sparklemotion/nokogiri/issues

IRCfreenode #nokogiri 

== SYNOPSIS:

  require 'nokogiri'
  require 'open-uri'
  
  doc = Nokogiri::HTML(open('http://www.google.com/search?q=tenderlove'))
  
  ####
  # Search for nodes by css
  doc.css('h3.r a.l').each do |link|
    puts link.content
  end
  
  ####
  # Search for nodes by xpath
  doc.xpath('//h3/a[@class="l"]').each do |link|
    puts link.content
  end
  
  ####
  # Or mix and match.
  doc.search('h3.r a.l', '//h3/a[@class="l"]').each do |link|
    puts link.content
  end


== REQUIREMENTS:

* ruby 1.8 or 1.9
* libxml2
* libxml2-dev
* libxslt
* libxslt-dev

== INSTALL:

* sudo gem install nokogiri

== LICENSE:

(The MIT License)

Copyright (c) 2008 - 2010:

* {Aaron Patterson}[http://tenderlovemaking.com]
* {Mike Dalessio}[http://mike.daless.io]
* {Charles Nutter}[http://blog.headius.com]
* {Sergio Arbeo}[http://www.serabe.com]
* {Patrick Mahoney}[http://polycrystal.org]
* {Yoko Harada}[http://yokolet.blogspot.com]

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

= Nokogiri {<img src="https://secure.travis-ci.org/sparklemotion/nokogiri.png?rvm=1.9.3" />}[http://travis-ci.org/sparklemotion/nokogiri] {<img src="https://codeclimate.com/badge.png" />}[https://codeclimate.com/github/sparklemotion/nokogiri]

* http://nokogiri.org
* http://github.com/sparklemotion/nokogiri/wikis
* http://github.com/sparklemotion/nokogiri/tree/master
* http://groups.google.com/group/nokogiri-talk
* http://github.com/sparklemotion/nokogiri/issues

== DESCRIPTION:

Nokogiri () is an HTML, XML, SAX, and Reader parser.  Among Nokogiri's
many features is the ability to search documents via XPath or CSS3 selectors.

XML is like violence - if it doesnt solve your problems, you are not using
enough of it.

== FEATURES:

* XPath support for document searching
* CSS3 selector support for document searching
* XML/HTML builder

Nokogiri parses and searches XML/HTML very quickly, and also has
correctly implemented CSS3 selector support as well as XPath support.

== SUPPORT:

Before filing a bug report, please read our {submission guidelines}[http://nokogiri.org/tutorials/getting_help.html] at:

  * http://nokogiri.org/tutorials/getting_help.html

The Nokogiri {mailing list}[http://groups.google.com/group/nokogiri-talk]
is available here:

  * http://groups.google.com/group/nokogiri-talk

The {bug tracker}[http://github.com/sparklemotion/nokogiri/issues]
is available here:

  * http://github.com/sparklemotion/nokogiri/issues

The IRC channel is #nokogiri on freenode.

== SYNOPSIS:

  require 'nokogiri'
  require 'open-uri'

  # Get a Nokogiri::HTML::Document for the page were interested in...

  doc = Nokogiri::HTML(open('http://www.google.com/search?q=sparklemotion'))

  # Do funky things with it using Nokogiri::XML::Node methods...

  ####
  # Search for nodes by css
  doc.css('h3.r a').each do |link|
    puts link.content
  end

  ####
  # Search for nodes by xpath
  doc.xpath('//h3/a').each do |link|
    puts link.content
  end

  ####
  # Or mix and match.
  doc.search('h3.r a.l', '//h3/a').each do |link|
    puts link.content
  end


== REQUIREMENTS:

* ruby 1.8 or 1.9
* libxml2
* libxml2-dev
* libxslt
* libxslt-dev

== ENCODING:

Strings are always stored as UTF-8 internally.  Methods that return
text values will always return UTF-8 encoded strings.  Methods that
return XML (like to_xml, to_html and inner_html) will return a string
encoded like the source document.

*WARNING*

Some documents declare one particular encoding, but use a different
one. So, which encoding should the parser choose?

Remember that data is just a stream of bytes. Only we humans add
meaning to that stream. Any particular set of bytes could be valid
characters in multiple encodings, so detecting encoding with 100%
accuracy is not possible. libxml2 does its best, but it can't be right
100% of the time.

If you want Nokogiri to handle the document encoding properly, your
best bet is to explicitly set the encoding.  Here is an example of
explicitly setting the encoding to EUC-JP on the parser:

    doc = Nokogiri.XML('<foo><bar /><foo>', nil, 'EUC-JP')

== INSTALL:

* sudo gem install nokogiri

=== Binary packages

Binary packages are available for:

* SuSE[http://download.opensuse.org/repositories/devel:/languages:/ruby:/extensions/]
* Fedora[http://s390.koji.fedoraproject.org/koji/packageinfo?packageID=6756]

== DEVELOPMENT:

=== Developing on C Ruby (MRI)

Developing Nokogiri requires racc and rexical to generate the parser and
tokenizer.  To start development, make sure you have `libxml2` and `libxslt`
installed.

Then install core gems and bootstrap:

    $ gem install hoe rake-compiler mini_portile
    $ rake newb

=== Developing on JRuby

Currently, development with JRuby depends on CRuby being installed.  With
CRuby, install racc and rexical:

    $ gem install racc rexical

Make sure hoe and rake compiler are installed with JRuby:

    $ jgem install hoe rake-compiler

Then run rake:

    $ jruby -S rake

== LICENSE:

(The MIT License)

Copyright (c) 2008 - 2012:

* {Aaron Patterson}[http://tenderlovemaking.com]
* {Mike Dalessio}[http://mike.daless.io]
* {Charles Nutter}[http://blog.headius.com]
* {Sergio Arbeo}[http://www.serabe.com]
* {Patrick Mahoney}[http://polycrystal.org]
* {Yoko Harada}[http://yokolet.blogspot.com]

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Roadmap for 2.0

## overhaul serialize/pretty printing API

* https://github.com/sparklemotion/nokogiri/issues/530
  XHTML formatting can't be turned off

* https://github.com/sparklemotion/nokogiri/issues/415
  XML formatting should be no formatting


## overhaul and optimize the SAX parsing

* see fairy wing throwdown - SAX parsing is wicked slow.


## Node should not be Enumerable; and should have a better attributes API

* https://github.com/sparklemotion/nokogiri/issues/679
  Mixing in Enumerable has some unintended consequences; plus we want to improve the attributes API

* Some ideas for a better attributes API?
  * (closed) https://github.com/sparklemotion/nokogiri/issues/666
  * https://github.com/sparklemotion/nokogiri/issues/765


## improve CSS query parsing

* https://github.com/sparklemotion/nokogiri/issues/528
  support `:not()` with a nontrivial argument, like `:not(div p.c)`

* https://github.com/sparklemotion/nokogiri/issues/451
  chained :not pseudoselectors

* better jQuery selector support:
  * https://github.com/sparklemotion/nokogiri/issues/621
  * https://github.com/sparklemotion/nokogiri/issues/342
  * https://github.com/sparklemotion/nokogiri/issues/628
  * https://github.com/sparklemotion/nokogiri/issues/652
  * https://github.com/sparklemotion/nokogiri/issues/688

* https://github.com/sparklemotion/nokogiri/issues/394
  nth-of-type is wrong, and possibly other selectors as well

* https://github.com/sparklemotion/nokogiri/issues/309
  incorrect query being executed

* https://github.com/sparklemotion/nokogiri/issues/350
  :has is wrong?


## DocumentFragment

* there are a few tickets about searches not working properly if you
  use or do not use the context node as part of the search.
  - https://github.com/sparklemotion/nokogiri/issues/213
  - https://github.com/sparklemotion/nokogiri/issues/370
  - https://github.com/sparklemotion/nokogiri/issues/454
  - https://github.com/sparklemotion/nokogiri/issues/572


## Better Syntax for custom XPath function handler

* https://github.com/sparklemotion/nokogiri/pull/464


## Better Syntax around Node#xpath and NodeSet#xpath

* look at those methods, and use of Node#extract_params in Node#{css,search}
  * we should standardize on a hash of options for these and other calls
* what should NodeSet#xpath return?
  * https://github.com/sparklemotion/nokogiri/issues/656
* also, clean up or unify the implementations of #xpath-and-friends in Node and NodeSet
  * implementations are very similar, but no shared code :(
  * decorate nodes in a consistent manner

## Encoding

We have a lot of issues open around encoding. How bad are things?
Would it help if we deprecated support for Ruby 1.8.7? Somebody who
knows encoding well should head this up.

* Extract EncodingReader as a real object that can be injected
  https://groups.google.com/forum/#!msg/nokogiri-talk/arJeAtMqvkg/tGihB-iBRSAJ


## Reader

It's fundamentally broken, in that we can't stop people from crashing
their application if they want to use object reference unsafely.

# Standard Responses to Requests

These responses are needed often enough that I figured, let's just
check them in for future reference and use.


# Not enough information to help

Hello!

Thanks for asking this question! However, without more information,
Team Nokogiri cannot reproduce your issue, and so we cannot offer much
help.

Please provide us with:

* A self-contained script (one that we can run without modification,
  and preferably without making external network connections).

* Please note that you need to include the XML/HTML that you are
  operating on.

* The output of `nokogiri -v`, which will provide details about your
  platform and versions of ruby, libxml2 and nokogiri.

For more information about requesting help or reporting bugs, please
take a look at http://bit.ly/nokohelp

Thank you so much!


# Not a bug

Hello!

Thanks for asking this question! Your request for assistance using
Nokogiri will not go unanswered!

However, Nokogiri's Github Issues is reserved for reporting bugs or
submitting patches. If you ask your question on the mailing list, Team
Nokogiri promises someone will provide you with an answer in a timely
manner.

If you'd like to read up on Team Nokogiri's rationale for this policy,
please go to http://bit.ly/nokohelp.

Thank you so much for understanding! And thank you for using Nokogiri.

require "helper"

module Nokogiri
  module HTML
    class TestElementDescription < Nokogiri::TestCase
      def test_fetch_nonexistent
        assert_nil ElementDescription['foo']
      end

      def test_fetch_element_description
        assert desc = ElementDescription['a']
        assert_instance_of ElementDescription, desc
      end

      def test_name
        assert_equal 'a', ElementDescription['a'].name
      end

      def test_implied_start_tag?
        assert !ElementDescription['a'].implied_start_tag?
      end

      def test_implied_end_tag?
        assert !ElementDescription['a'].implied_end_tag?
        assert ElementDescription['p'].implied_end_tag?
      end

      def test_save_end_tag?
        assert !ElementDescription['a'].save_end_tag?
        assert ElementDescription['br'].save_end_tag?
      end

      def test_empty?
        assert ElementDescription['br'].empty?
        assert !ElementDescription['a'].empty?
      end

      def test_deprecated?
        assert ElementDescription['applet'].deprecated?
        assert !ElementDescription['br'].deprecated?
      end

      def test_inline?
        assert ElementDescription['a'].inline?
        assert !ElementDescription['div'].inline?
      end

      def test_block?
        element = ElementDescription['a']
        assert_equal(!element.inline?, element.block?)
      end

      def test_description
        assert ElementDescription['a'].description
      end

      def test_subelements
        sub_elements = ElementDescription['body'].sub_elements
        if Nokogiri.uses_libxml? && Nokogiri::LIBXML_VERSION >= '2.7.7'
          assert_equal 65, sub_elements.length
        elsif Nokogiri.uses_libxml?
          assert_equal 61, sub_elements.length
        else
          assert sub_elements.length > 0
        end
      end

      def test_default_sub_element
        assert_equal 'div', ElementDescription['body'].default_sub_element
      end

      def test_optional_attributes
        attrs = ElementDescription['table'].optional_attributes
        assert attrs
      end

      def test_deprecated_attributes
        attrs = ElementDescription['table'].deprecated_attributes
        assert attrs
        assert_equal 2, attrs.length
      end

      def test_required_attributes
        attrs = ElementDescription['table'].required_attributes
        assert attrs
        assert_equal 0, attrs.length
      end

      def test_inspect
        desc = ElementDescription['input']
        assert_match desc.name, desc.inspect
      end

      def test_to_s
        desc = ElementDescription['input']
        assert_match desc.name, desc.to_s
      end
    end
  end
end

(note: this was originally a blog post published at http://blog.flavorjon.es/2012/03/y-u-no-gemspec.html)

## tl;dr

1. Team Nokogiri are not 10-foot-tall code-crunching robots, so `master` is usually unstable.
2. Unstable code can corrupt your data and crash your application, which would make everybody look bad.
3. Therefore, the _risk_ associated with using unstable code is severe; for you _and_ for Team Nokogiri.
4. The absence of a gemspec is a risk mitigation tactic.
5. You can always ask for an RC release.


## Why Isn't There a Gemspec!?

OHAI! Thank you for asking this question!

Team Nokogiri gets asked this pretty frequently. Just a sample from
the historical record:

* [Issue #274](https://github.com/sparklemotion/nokogiri/issues/274)
* [Issue #371](https://github.com/sparklemotion/nokogiri/issues/371)
* [A commit removing nokogiri.gemspec](https://github.com/sparklemotion/nokogiri/commit/7f17a643a05ca381d65131515b54d4a3a61ca2e1#commitcomment-667477)
* [A nokogiri-talk thread](http://groups.google.com/group/nokogiri-talk/browse_thread/thread/4706b002e492d23f)
* [Another nokogiri-talk thread](http://groups.google.com/group/nokogiri-talk/browse_thread/thread/0b201bb80ea3eea0)

Sometimes people imply that we've forgotten, or that we don't how to
properly manage our codebase. Those people are super fun to respond
to!

We've gone back and forth a couple of times over the past few years,
but the current policy of Team Nokogiri is to **not** provide a
gemspec in the Github repo. This is a conscious choice, not an
oversight.


## But You Didn't Answer the Question!

Ah, I was hoping you wouldn't notice. Well, OK, let's do this, if
you're serious about it.

I'd like to start by talking about _risk_. Specifically, the risk
associated with using a known-unstable version of Nokogiri.


### Risk

One common way to evaluate the _risk_ of an incident is:

    risk = probability x impact

You can read more about this on [the internets](http://en.wikipedia.org/wiki/Risk_Matrix).

The _risk_ associated with a Nokogiri bug could be loosely defined by
answering the questions:

* "How likely is it that a bug exists?" (probability)
* "How severe will the consequences of a bug be?" (impact)


### Probability

The `master` branch should be considered unstable. Team Nokogiri are
not 10-foot-tall code-crunching robots; we are humans. We make
mistakes, and as a result, any arbitrary commit on `master` is likely
to contain bugs.

Just as an example, Nokogiri `master` was unstable for about five
months between November 2011 and March 2012. It was unstable not
because we were sloppy, or didn't care, but because the fixes were
hard and unobvious.

When we release Nokogiri, we test for memory leaks and invalid memory
access on all kinds of platforms with many flavors of Ruby and lots of
versions of libxml2. Because these tests are time-consuming, we don't
run them on every commit. We run them often when preparing a release.

If we're releasing Nokogiri, it means we think it's rock solid.

And if we're not releasing it, it means there are probably bugs.


### Impact

Nokogiri is a gem with native extensions. This means it's not pure
Ruby -- there's C or Java code being compiled and run, which means
that there's always a chance that the gem will crash your application,
or worse. Possible outcomes include:

* leaking memory
* corrupting data
* making benign code crash (due to memory corruption)

So, then, a bug in a native extension can have much worse downside
than you might think. It's not just going to do something unexpected;
it's possibly going to do terrible, awful things to your application
and data.

**Nobody** wants that to happen. Especially Team Nokogiri.


### Risk, Redux

So, if you accept the equation

    risk = probability x impact

and you believe me when I say that:

* the probablility of a bug in unreleased code is high, and
* the impact of a bug is likely to be severe,

then you should easily see that the _risk_ associated with a bug in
Nokogiri is quite high.

Part of Team Nokogiri's job is to try to mitigate this risk. We have a
number of tactics that we use to accomplish this:

* we respond quickly to bug reports, particularly when they are possible memory issues
* we review each others' commits
* we have a thorough test suite, and we test-drive new features
* we discuss code design and issues on a core developer mailing list
* we use valgrind to test for memory issues (leaks and invalid
  access) on multiple combinations of OS, libxml2 and Ruby
* we package release candidates, and encourage devs to use them
* **we do NOT commit a gemspec in our git repository**

Yes, that's right, the absence of a gemspec is a risk mitigation
tactic. Not only does Team Nokogiri not want to imply support for
`master`, we want to **actively discourage** people from using
it. Because it's not stable.


## But I Want to Do It Anyway

Another option, is to email the [nokogiri-talk
list](http://groups.google.com/group/nokogiri-talk) and ask for a
release candidate to be built. We're pretty accommodating if there's a
bugfix that's a blocker for you. And if we can't release an RC, we'll
tell you why.

And in the end, nothing is stopping you from cloning the repo and
generating a private gemspec. This is an extra step or two, but it has
the benefit of making sure developers have thought through the costs
and risks involved; and it tends to select for developers who know
what they're doing.


## In Conclusion

Team Nokogiri takes stability very seriously. We want everybody who
uses Nokogiri to have a pleasant experience. And so we want to make
sure that you're using the best software we can make.

Please keep in mind that we're trying very hard to do the right thing
for all Nokogiri users out there in Rubyland. Nokogiri loves you very
much, and we hope you love it back.

Hash text for Alfred 2
============

A simple Alfred 2 string hash workflow's.


Installation
----------------

- Download "[Hash.alfredworkflow](https://github.com/BigLuck/alfred2-hash/raw/master/Hash.alfredworkflow)" extension.
- Double click the downloaded "Hash.alfredworkflow" file to install.
*Alfred 2 is required*


Instructions
----------------

- md5 `<string>`
- sha1 `<string>`
- htpasswd `<string>`
- crc32 `<string>`
- whirlpool `<string>`
- base64_decode `<string>`
- base64_encode `<string>`
# alfred-workflow [![Build Status](https://travis-ci.org/zhaocai/alfred-workflow.png?branch=master)](https://travis-ci.org/zhaocai/alfred-workflow)

* home  :: http://zhaocai.github.com/alfred2-ruby-template/
* rdoc  :: http://rubydoc.info/gems/alfred-workflow/
* code  :: https://github.com/zhaocai/alfred-workflow
* bugs  :: https://github.com/zhaocai/alfred-workflow/issues


## DESCRIPTION:

alfred-workflow is a ruby Gem helper for building [Alfred](http://www.alfredapp.com) workflow.


## FEATURES:

* Use standard [bundler][gembundler] to easily package, manage, and update ruby gems in the workflow.
* Friendly exception and debug output to the Mac OS X Console.
* Automate saving and loading cached feedback
* Automate rescue feedback items to alfred when something goes wrong.
* Functions to easily load and save user configuration (in YAML)
* Functions for smart case query filter of feedback results.
* Functions for finding the bundle ID, cache and storage paths, and query arguments.
* Functions for reading and writing plist files.
* Functions to simplify generating feedback XML for Alfred.

## INSTALL:

`gem install alfred-workflow`

## USAGE:

* Refer to [alfred2-ruby-template]( https://github.com/zhaocai/alfred2-ruby-template ) for examples and detailed instruction. Also refer to some of the example projects:

* [alfred2-top-workflow]( https://github.com/zhaocai/alfred2-top-workflow )
* [alfred2-google-workflow]( https://github.com/zhaocai/alfred2-google-workflow )
* [alfred2-sourcetree-workflow]( https://github.com/zhaocai/alfred2-sourcetree-workflow )

## SYNOPSIS:

### The Basic
```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

Alfred.with_friendly_error do |alfred|
  fb = alfred.feedback

  fb.add_file_item(File.expand_path "~/Applications/")

  puts fb.to_alfred(ARGV)
end
```

Code are wrapped in `Alfred.with_friendly_error` block. Exceptions and debug messages are logged to Console log file **~/Library/Logs/Alfred-Workflow.log**.

### With rescue feedback automatically generated!

```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

def my_code_with_something_goes_wrong
  true
end

Alfred.with_friendly_error do |alfred|
  alfred.with_rescue_feedback = true

  fb = alfred.feedback

  if my_code_with_something_goes_wrong
    raise Alfred::NoBundleIDError, "Wrong Bundle ID Test!"
  end
end
```

![rescue feedback](https://raw.github.com/zhaocai/alfred2-ruby-template/master/screenshots/rescue%20feedback.png)


### Automate saving and loading cached feedback
```ruby
require 'rubygems' unless defined? Gem
require "bundle/bundler/setup"
require "alfred"

Alfred.with_friendly_error do |alfred|
  alfred.with_rescue_feedback = true
  alfred.with_cached_feedback do
    # expire in 1 hour
    use_cache_file :expire => 3600
    # use_cache_file :file => "/path/to/your/cache_file", :expire => 3600
  end

  if fb = alfred.feedback.get_cached_feedback
    # cached feedback is valid
    puts fb.to_alfred
  else 
    fb = alfred.feedback
    # ... generate_feedback as usually
    fb.put_cached_feedback
  end
end
```






## Troubleshooting




## DEVELOPERS:

After checking out the source, run:

  $ rake newb

This task will install any missing dependencies, run the tests/specs,
and generate the RDoc.

## LICENSE:

Copyright (c) 2013 Zhao Cai <caizhaoff@gmail.com>

This program is free software: you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see <http://www.gnu.org/licenses/>.


[gembundler]: http://gembundler.com/
[alfredapp]: http://www.alfredapp.com

= Little Plugger
* by Tim Pease
* http://github.com/TwP/little-plugger/tree/master

=== DESCRIPTION:

LittlePlugger is a module that provides Gem based plugin management.
By extending your own class or module with LittlePlugger you can easily
manage the loading and initializing of plugins provided by other gems.

=== FEATURES:

* List of plugins so that some plugins can be excluded while others are
  loaded by default.
* Loading and initializing of plugins.
* Access to the plugin classes and modules.

LittlePlugger is a distallation of the plugin system from Hoe. It has been
"genericized" and encapsulated into its own easy to use module.

=== REQUIREMENTS:

Since Little Plugger is a Gem based plugin system, Ruby Gems must be
installed on your system.

=== INSTALL:

  gem install little-plugger

=== LICENSE:

(The MIT License)

Copyright (c) 2009-2011

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

= Logging
by Tim Pease {<img src="https://secure.travis-ci.org/TwP/logging.png">}[http://travis-ci.org/TwP/logging]

* {Homepage}[http://rubygems.org/gems/logging]
* {Github Project}[https://github.com/TwP/logging]
* email tim dot pease at gmail dot com

== DESCRIPTION

Logging is a flexible logging library for use in Ruby programs based on the
design of Java's log4j library. It features a hierarchical logging system,
custom level names, multiple output destinations per log event, custom
formatting, and more.

== INSTALL

  gem install logging

== EXAMPLE

This example configures a logger to output messages in a format similar to the
core ruby Logger class. Only log messages that are warnings or higher will be
logged.

  require 'logging'

  logger = Logging.logger(STDOUT)
  logger.level = :warn

  logger.debug "this debug message will not be output by the logger"
  logger.warn "this is your last warning"

In this example, a single logger is created that will append to STDOUT and to a
file. Only log messages that are informational or higher will be logged.

  require 'logging'

  logger = Logging.logger['example_logger']
  logger.add_appenders(
      Logging.appenders.stdout,
      Logging.appenders.file('example.log')
  )
  logger.level = :info

  logger.debug "this debug message will not be output by the logger"
  logger.info "just some friendly advice"

The Logging library was created to allow each class in a program to have its
own configurable logger. The logging level for a particular class can be
changed independently of all other loggers in the system. This example shows
the recommended way of accomplishing this.

  require 'logging'

  Logging.logger['FirstClass'].level = :warn
  Logging.logger['SecondClass'].level = :debug

  class FirstClass
    def initialize
      @logger = Logging.logger[self]
    end

    def some_method
      @logger.debug "some method was called on #{self.inspect}"
    end
  end

  class SecondClass
    def initialize
      @logger = Logging.logger[self]
    end

    def another_method
      @logger.debug "another method was called on #{self.inspect}"
    end
  end

There are many more examples in the "examples" folder of the logging
package. The recommended reading order is the following:

* {simple.rb}[https://github.com/TwP/logging/blob/master/examples/simple.rb]
* {rspec_integration.rb}[https://github.com/TwP/logging/blob/master/examples/rspec_integration.rb]
* {loggers.rb}[https://github.com/TwP/logging/blob/master/examples/loggers.rb]
* {classes.rb}[https://github.com/TwP/logging/blob/master/examples/classes.rb]
* {hierarchies.rb}[https://github.com/TwP/logging/blob/master/examples/hierarchies.rb]
* {names.rb}[https://github.com/TwP/logging/blob/master/examples/names.rb]
* {lazy.rb}[https://github.com/TwP/logging/blob/master/examples/lazy.rb]
* {appenders.rb}[https://github.com/TwP/logging/blob/master/examples/appenders.rb]
* {layouts.rb}[https://github.com/TwP/logging/blob/master/examples/layouts.rb]
* {formatting.rb}[https://github.com/TwP/logging/blob/master/examples/formatting.rb]
* {colorization.rb}[https://github.com/TwP/logging/blob/master/examples/colorization.rb]
* {consolidation.rb}[https://github.com/TwP/logging/blob/master/examples/consolidation.rb]
* {fork.rb}[https://github.com/TwP/logging/blob/master/examples/fork.rb]
* {mdc.rb}[https://github.com/TwP/logging/blob/master/examples/mdc.rb]

== NOTES

Although Logging is intended to supersede Log4r, it is not a one-to-one
replacement for the Log4r library. Most notably is the difference in namespaces
-- Logging vs. Log4r. Other differences include renaming Log4r::Outputter to
Logging::Appender and renaming Log4r::Formatter to Logging::Layout. These
changes were meant to bring the Logging class names more in line with the Log4j
class names.

== REQUIREMENTS

The Logging source code relies on the Mr Bones project for default rake tasks.
You will need to install the Mr Bones gem if you want to build or test the
logging gem.

   gem install bones

After Mr Bones is installed you can install all the depdencies via the rake
task.

   rake gem:install_dependencies

Always remember that "rake -T" is your friend!

== LICENSE

The MIT License

Copyright (c) 2012 Tim Pease

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

1.7.2
-----
* [Renamed Jrjackson adapter to JrJackson](https://github.com/intridea/multi_json/commit/b36dc915fc0e6548cbad06b5db6f520e040c9c8b)
* [Implemented jrjackson -> jr_jackson alias for back-compatability](https://github.com/intridea/multi_json/commit/aa50ab8b7bb646b8b75d5d65dfeadae8248a4f10)
* [Update vendored OkJson module](https://github.com/intridea/multi_json/commit/30a3f474e17dd86a697c3fab04f468d1a4fd69d7)

1.7.1
-----
* [Fix capitalization of JrJackson class](https://github.com/intridea/multi_json/commit/5373a5e38c647f02427a0477cb8e0e0dafad1b8d)

1.7.0
-----
* [Add load_options/dump_options to MultiJson](https://github.com/intridea/multi_json/commit/a153956be6b0df06ea1705ce3c1ff0b5b0e27ea5)
* [MultiJson does not modify arguments](https://github.com/intridea/multi_json/commit/58525b01c4c2f6635ba2ac13d6fd987b79f3962f)
* [Enable quirks_mode by default for json_gem/json_pure adapters](https://github.com/intridea/multi_json/commit/1fd4e6635c436515b7d7d5a0bee4548de8571520)
* [Add JrJackson adapter](https://github.com/intridea/multi_json/commit/4dd86fa96300aaaf6d762578b9b31ea82adb056d)
* [Raise ArgumentError on bad adapter input](https://github.com/intridea/multi_json/commit/911a3756bdff2cb5ac06497da3fa3e72199cb7ad)

1.6.1
-----
* [Revert "Use JSON.generate instead of #to_json"](https://github.com/intridea/multi_json/issues/86)

1.6.0
-----
* [Add gson.rb support](https://github.com/intridea/multi_json/pull/71)
* [Add MultiJson.default_options](https://github.com/intridea/multi_json/pull/70)
* [Add MultiJson.with_adapter](https://github.com/intridea/multi_json/pull/67)
* [Stringify all possible keys for ok_json](https://github.com/intridea/multi_json/pull/66)
* [Use JSON.generate instead of #to_json](https://github.com/intridea/multi_json/issues/73)
* [Alias `MultiJson::DecodeError` to `MultiJson::LoadError`](https://github.com/intridea/multi_json/pull/79)

1.5.1
-----
* [Do not allow Oj or JSON to create symbols by searching for classes](https://github.com/intridea/multi_json/commit/193e28cf4dc61b6e7b7b7d80f06f74c76df65c41)

1.5.0
-----
* [Add `MultiJson.with_adapter` method](https://github.com/intridea/multi_json/commit/d14c5d28cae96557a0421298621b9499e1f28104)
* [Stringify all possible keys for `ok_json`](https://github.com/intridea/multi_json/commit/73998074058e1e58c557ffa7b9541d486d6041fa)

1.4.0
-----
* [Allow `load`/`dump` of JSON fragments](https://github.com/intridea/multi_json/commit/707aae7d48d39c85b38febbd2c210ba87f6e4a36)

1.3.7
-----
* [Fix rescue clause for MagLev](https://github.com/intridea/multi_json/commit/39abdf50199828c50e85b2ce8f8ba31fcbbc9332)
* [Remove unnecessary check for string version of options key](https://github.com/intridea/multi_json/commit/660101b70e962b3c007d0b90d45944fa47d13ec4)
* [Explicitly set default adapter when adapter is set to `nil` or `false`](https://github.com/intridea/multi_json/commit/a9e587d5a63eafb4baee9fb211265e4dd96a26bc)
* [Fix Oj `ParseError` mapping for Oj 1.4.0](https://github.com/intridea/multi_json/commit/7d9045338cc9029401c16f3c409d54ce97f275e2)

1.3.6
-----
* [Allow adapter-specific options to be passed through to Oj](https://github.com/intridea/multi_json/commit/d0e5feeebcba0bc69400dd203a295f5c30971223)

1.3.5
-----
* [Add pretty support to Oj adapter](https://github.com/intridea/multi_json/commit/0c8f75f03020c53bcf4c6be258faf433d24b2c2b)

1.3.4
-----
* [Use `class << self` instead of `module_function` to create aliases](https://github.com/intridea/multi_json/commit/ba1451c4c48baa297e049889be241a424cb05980)

1.3.3
-----
* [Remove deprecation warnings](https://github.com/intridea/multi_json/commit/36b524e71544eb0186826a891bcc03b2820a008f)

1.3.2
-----
* [Add ability to use adapter per call](https://github.com/intridea/multi_json/commit/106bbec469d5d0a832bfa31fffcb8c0f0cdc9bd3)
* [Add and deprecate `default_engine` method](https://github.com/intridea/multi_json/commit/fc3df0c7a3e2ab9ce0c2c7e7617a4da97dd13f6e)

1.3.1
-----
* [Only warn once for each instance a deprecated method is called](https://github.com/intridea/multi_json/commit/e21d6eb7da74b3f283995c1d27d5880e75f0ae84)

1.3.0
-----
* [Implement `load`/`dump`; deprecate `decode`/`encode`](https://github.com/intridea/multi_json/commit/e90fd6cb1b0293eb0c73c2f4eb0f7a1764370216)
* [Rename engines to adapters](https://github.com/intridea/multi_json/commit/ae7fd144a7949a9c221dcaa446196ec23db908df)

1.2.0
-----
* [Add support for Oj](https://github.com/intridea/multi_json/commit/acd06b233edabe6c44f226873db7b49dab560c60)

1.1.0
-----
* [`NSJSONSerialization` support for MacRuby](https://github.com/intridea/multi_json/commit/f862e2fc966cac8867fe7da3997fc76e8a6cf5d4)

1.0.4
-----
* [Set data context to `DecodeError` exception](https://github.com/intridea/multi_json/commit/19ddafd44029c6681f66fae2a0f6eabfd0f85176)
* [Allow `ok_json` to fallback to `to_json`](https://github.com/intridea/multi_json/commit/c157240b1193b283d06d1bd4d4b5b06bcf3761f8)
* [Add warning when using `ok_json`](https://github.com/intridea/multi_json/commit/dd4b68810c84f826fb98f9713bfb29ab96888d57)
* [Options can be passed to an engine on encode](https://github.com/intridea/multi_json/commit/e0a7ff5d5ff621ffccc61617ed8aeec5816e81f7)

1.0.3
-----
* [`Array` support for `stringify_keys`](https://github.com/intridea/multi_json/commit/644d1c5c7c7f6a27663b11668527b346094e38b9)
* [`Array` support for `symbolize_keys`](https://github.com/intridea/multi_json/commit/c885377d47a2aa39cb0d971fea78db2d2fa479a7)

1.0.2
-----
* [Allow encoding of rootless JSON when `ok_json` is used](https://github.com/intridea/multi_json/commit/d1cde7de97cb0f6152aef8daf14037521cdce8c6)

1.0.1
-----
* [Correct an issue with `ok_json` not being returned as the default engine](https://github.com/intridea/multi_json/commit/d33c141619c54cccd770199694da8fd1bd8f449d)

1.0.0
-----
* [Remove `ActiveSupport::JSON` support](https://github.com/intridea/multi_json/commit/c2f4140141d785a24b3f56e58811b0e561b37f6a)
* [Fix `@engine` ivar warning](https://github.com/intridea/multi_json/commit/3b978a8995721a8dffedc3b75a7f49e5494ec553)
* [Only `rescue` from parsing errors during decoding, not any `StandardError`](https://github.com/intridea/multi_json/commit/391d00b5e85294d42d41347605d8d46b4a7f66cc)
* [Rename `okjson` engine and vendored lib to `ok_json`](https://github.com/intridea/multi_json/commit/5bd1afc977a8208ddb0443e1d57cb79665c019f1)
* [Add `StringIO` support to `json` gem and `ok_json`](https://github.com/intridea/multi_json/commit/1706b11568db7f50af451fce5f4d679aeb3bbe8f)

0.0.5
-----
* [Trap all JSON decoding errors; raise `MultiJson::DecodeError`](https://github.com/intridea/multi_json/commit/dea9a1aef6dd1212aa1e5a37ab1669f9b045b732)

0.0.4
-----
* [Fix default_engine check for `json` gem](https://github.com/intridea/multi_json/commit/caced0c4e8c795922a109ebc00c3c4fa8635bed8)
* [Make requirement mapper an `Array` to preserve order in Ruby versions < 1.9](https://github.com/intridea/multi_json/commit/526f5f29a42131574a088ad9bbb43d7f48439b2c)

0.0.3
-----
* [Improved defaulting and documentation](https://github.com/sferik/twitter/commit/3a0e41b9e4b0909201045fa47704b78c9d949b73)

0.0.2
-----

* [Rename to `multi_json`](https://github.com/sferik/twitter/commit/461ab89ce071c8c9fabfc183581e0ec523788b62)

0.0.1
-----

* [Initial commit](https://github.com/sferik/twitter/commit/518c21ab299c500527491e6c049ab2229e22a805)

## Contributing
In the spirit of [free software][free-sw], **everyone** is encouraged to help
improve this project.

[free-sw]: http://www.fsf.org/licensing/essays/free-sw.html

Here are some ways *you* can contribute:

* by using alpha, beta, and prerelease versions
* by reporting bugs
* by suggesting new features
* by writing or editing documentation
* by writing specifications
* by writing code (**no patch is too small**: fix typos, add comments, clean up
  inconsistent whitespace)
* by refactoring code
* by closing [issues][]
* by reviewing patches

[issues]: https://github.com/intridea/multi_json/issues

## Submitting an Issue
We use the [GitHub issue tracker][issues] to track bugs and features. Before
submitting a bug report or feature request, check to make sure it hasn't
already been submitted. When submitting a bug report, please include a [Gist][]
that includes a stack trace and any details that may be necessary to reproduce
the bug, including your gem version, Ruby version, and operating system.
Ideally, a bug report should include a pull request with failing specs.

[gist]: https://gist.github.com/

## Submitting a Pull Request
1. [Fork the repository.][fork]
2. [Create a topic branch.][branch]
3. Add specs for your unimplemented feature or bug fix.
4. Run `bundle exec rake spec`. If your specs pass, return to step 3.
5. Implement your feature or bug fix.
6. Run `bundle exec rake spec`. If your specs fail, return to step 5.
7. Run `open coverage/index.html`. If your changes are not completely covered
   by your tests, return to step 3.
8. Add, commit, and push your changes.
9. [Submit a pull request.][pr]

[fork]: http://help.github.com/fork-a-repo/
[branch]: http://learn.github.com/p/branching.html
[pr]: http://help.github.com/send-pull-requests/

Copyright (c) 2010-2013 Michael Bleigh, Josh Kalderimis, Erik Michaels-Ober, Pavel Pravosud

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# MultiJSON

[![Gem Version](https://badge.fury.io/rb/multi_json.png)][gem]
[![Build Status](https://secure.travis-ci.org/intridea/multi_json.png?branch=master)][travis]
[![Dependency Status](https://gemnasium.com/intridea/multi_json.png?travis)][gemnasium]
[![Code Climate](https://codeclimate.com/github/intridea/multi_json.png)][codeclimate]
[![Coverage Status](https://coveralls.io/repos/intridea/multi_json/badge.png?branch=master)][coveralls]

[gem]: https://rubygems.org/gems/multi_json
[travis]: http://travis-ci.org/intridea/multi_json
[gemnasium]: https://gemnasium.com/intridea/multi_json
[codeclimate]: https://codeclimate.com/github/intridea/multi_json
[coveralls]: https://coveralls.io/r/intridea/multi_json

Lots of Ruby libraries parse JSON and everyone has their favorite JSON coder.
Instead of choosing a single JSON coder and forcing users of your library to be
stuck with it, you can use MultiJSON instead, which will simply choose the
fastest available JSON coder. Here's how to use it:

```ruby
require 'multi_json'

MultiJson.load('{"abc":"def"}') #=> {"abc" => "def"}
MultiJson.load('{"abc":"def"}', :symbolize_keys => true) #=> {:abc => "def"}
MultiJson.dump({:abc => 'def'}) # convert Ruby back to JSON
MultiJson.dump({:abc => 'def'}, :pretty => true) # encoded in a pretty form (if supported by the coder)
```

When loading invalid JSON, multiJSON will throw a `MultiJson::LoadError`. `MultiJson::DecodeError` is an alias for backwards compatibility.

```ruby
MultiJson.load('invalid json') #=> MultiJson::LoadError
```

The `use` method, which sets the MultiJson adapter, takes either a symbol or a
class (to allow for custom JSON parsers) that responds to both `.load` and `.dump`
at the class level.

MultiJSON tries to have intelligent defaulting. That is, if you have any of the
supported engines already loaded, it will utilize them before attempting to
load any. When loading, libraries are ordered by speed. First Oj, then Yajl,
then the JSON gem, then JSON pure. If no other JSON library is available,
MultiJSON falls back to [OkJson][], a simple, vendorable JSON parser.

[okjson]: https://github.com/kr/okjson

## Supported JSON Engines

* [Oj](https://github.com/ohler55/oj) Optimized JSON by Peter Ohler
* [Yajl](https://github.com/brianmario/yajl-ruby) Yet Another JSON Library by Brian Lopez
* [JSON](https://github.com/flori/json) The default JSON gem with C-extensions (ships with Ruby 1.9)
* [JSON Pure](https://github.com/flori/json) A Ruby variant of the JSON gem
* [NSJSONSerialization](https://developer.apple.com/library/ios/#documentation/Foundation/Reference/NSJSONSerialization_Class/Reference/Reference.html) Wrapper for Apple's NSJSONSerialization in the Cocoa Framework (MacRuby only)
* [gson.rb](https://github.com/avsej/gson.rb) A Ruby wrapper for google-gson library (JRuby only)
* [JrJackson](https://github.com/guyboertje/jrjackson) JRuby wrapper for Jackson (JRuby only)
* [OkJson][okjson] A simple, vendorable JSON parser

## Supported Ruby Versions
This library aims to support and is [tested against][travis] the following Ruby
implementations:

* Ruby 1.8.7
* Ruby 1.9.2
* Ruby 1.9.3
* Ruby 2.0.0
* [JRuby][]
* [Rubinius][]
* [MacRuby][] (not tested on Travis CI)

[jruby]: http://www.jruby.org/
[rubinius]: http://rubini.us/
[macruby]: http://www.macruby.org/

If something doesn't work on one of these interpreters, it's a bug.

This library may inadvertently work (or seem to work) on other Ruby
implementations, however support will only be provided for the versions listed
above.

If you would like this library to support another Ruby version, you may
volunteer to be a maintainer. Being a maintainer entails making sure all tests
run and pass on that implementation. When something breaks on your
implementation, you will be responsible for providing patches in a timely
fashion. If critical issues for a particular implementation exist at the time
of a major release, support for that Ruby version may be dropped.

## Versioning

This library aims to adhere to [Semantic Versioning 2.0.0][semver]. Violations
of this scheme should be reported as bugs. Specifically, if a minor or patch
version is released that breaks backward compatibility, that version should be
immediately yanked and/or a new version should be immediately released that
restores compatibility. Breaking changes to the public API will only be
introduced with new major versions. As a result of this policy, you can (and
should) specify a dependency on this gem using the [Pessimistic Version
Constraint][pvc] with two digits of precision. For example:

```ruby
spec.add_dependency 'multi_json', '~> 1.0'
```

[semver]: http://semver.org/
[pvc]: http://docs.rubygems.org/read/chapter/16#page74

## Copyright
Copyright (c) 2010-2013 Michael Bleigh, Josh Kalderimis, Erik Michaels-Ober,
and Pavel Pravosud. See [LICENSE][] for details.

[license]: LICENSE.md

# Oj gem
A fast JSON parser and Object marshaller as a Ruby gem.

## <a name="installation">Installation</a>
    gem install oj

## <a name="documentation">Documentation</a>

*Documentation*: http://www.ohler.com/oj

## <a name="source">Source</a>

*GitHub* *repo*: https://github.com/ohler55/oj

*RubyGems* *repo*: https://rubygems.org/gems/oj

## <a name="follow">Follow @oxgem on Twitter</a>

[Follow @peterohler on Twitter](http://twitter.com/#!/peterohler) for announcements and news about the Oj gem.

## <a name="build_status">Build Status</a>

[![Build Status](https://secure.travis-ci.org/ohler55/oj.png?branch=master)](http://travis-ci.org/ohler55/oj)

## <a name="links">Links of Interest</a>

[Need for Speed](http://www.ohler.com/dev/need_for_speed/need_for_speed.html) for an overview of how Oj::Doc was designed.

*Fast XML parser and marshaller on RubyGems*: https://rubygems.org/gems/ox

*Fast XML parser and marshaller on GitHub*: https://github.com/ohler55/ox

## <a name="release">Release Notes</a>

### Release 2.0.10

 - Tweaked dump calls by reducing preallocation. Speeds are now several times faster for smaller objects.

 - Fixed Windows compile error with Ruby 2.0.0.

### Release 2.0.9

 - Fixed problem with INFINITY with CentOS and Ruby 2.0.0. There are some header file conflicts so a different INFINITY was used.

## <a name="description">Description</a>

Optimized JSON (Oj), as the name implies was written to provide speed
optimized JSON handling. It was designed as a faster alternative to Yajl and
other the common Ruby JSON parsers. So far is has achieved that at about 2
time faster than Yajl for parsing and 3 or more times faster writing JSON.

Oj has several dump or serialization modes which control how Objects are
converted to JSON. These modes are set with the :mode option in either the
default options or as one of the options to the dump() method.

- :strict mode will only allow the 7 basic JSON types to be serialized. Any other Object
will raise and Exception. 

- :null mode replaces any Object that is not one of the JSON types is replaced by a JSON null.

- :object mode will dump any Object as a JSON Object with keys that match the
Ruby Object's variable names without the '@' character. This is the highest
performance mode.

- :compat mode is is the compatible with other systems. It will serialize any
Object but will check to see if the Object implements a to_hash() or to_json()
method. If either exists that method is used for serializing the Object. The
to_hash() is more flexible and produces more consistent output so it has a
preference over the to_json() method. If neither the to_json() or to_hash()
methods exist then the Oj internal Object variable encoding is used.

Oj is compatible with Ruby 1.8.7, 1.9.2, 1.9.3, JRuby, RBX, and the latest 2.0dev. Note that JRuby now disables support
for extentions by default and is no longer supporting C extensions. Bugs reported in the JRuby MRI are no longer being
fixed and there is at least one that has caused a test to be commented out for JRuby in the Oj test suite. JRuby can be
build with extensions enabled. Check the documenation for JRuby installs in your environment.

Oj is also compatible with Rails. Just make sure the Oj gem is installed and
[multi_json](https://github.com/intridea/multi_json) will pick it up and use it.

Oj offers two alternative APIs for processing JSON. The fastest one is the Oj::Doc API. The Oj::Doc API takes a
completely different approach by opening a JSON document and providing calls to navigate around the JSON while it is
open. With this approach JSON access can be well over 20 times faster than conventional JSON parsing.

Another API, the Oj::Saj API follows an XML SAX model and walks the JSON document depth first and makes callbacks for
each element. The Oj::Saj API is useful when only portions of the JSON are of interest. Performance up to 20 times
faster than conventional JSON are possible. The API is simple to use but does require a different approach than the
conventional parse followed by access approach used by conventional JSON parsing.

## <a name="proper_use">Proper Use</a>

Two settings in Oj are useful for parsing but do expose a vunerability if used from an untrusted source. Symbolizing
keys can be used to cause memory to be filled up since Ruby does not garbage collect Symbols. The same is true for auto
defining classes. Memory can be exhausted if too many classes are automatically defined. Auto defining is a useful
feature during development and from trusted sources but it does allow too many classes to be created in the object load
mode and auto defined is used with an untrusted source. The Oj.strict_load() method sets uses the most strict and safest
options. It should be used by developers who find it difficult to understand the options available in Oj.

The options in Oj are designed to provide flexibility to the developer. This flexibility allows Objects to be serialized
and deserialized. No methods are ever called on these created Objects but that does not stop the developer from calling
methods on the Objects created. As in any system, check your inputs before working with them. Taking an arbitrary String
from a user and evaluating it is never a good idea from an unsecure source. The same is true for Object attributes as
they are not more than Strings. Always check inputs from untrusted sources.

## <a name="compare">Comparisons</a>

### Fast Oj::Doc parser comparisons

The fast Oj::Doc parser is compared to the Yajl and JSON::Pure parsers with
strict JSON documents. No object conversions are included, just simple JSON.

Since the Oj::Doc deviation from the conventional parsers comparisons of not
only parsing but data access is also included. These tests use the
perf_fast.rb test file. The first benchmark is for just parsing. The second is
for doing a get on every leaf value in the JSON data structure. The third
fetchs a value from a specific spot in the document. With Yajl and JSON this
is done with a set of calls to fetch() for each level in the document. For
Oj::Doc a single fetch with a path is used.

The benchmark results are:

    > perf_fast.rb -g 1 -f
    --------------------------------------------------------------------------------
    Parse Performance
    Oj::Doc.parse 100000 times in 0.164 seconds or 609893.696 parse/sec.
    Yajl.parse 100000 times in 3.168 seconds or 31569.902 parse/sec.
    JSON::Ext.parse 100000 times in 3.282 seconds or 30464.826 parse/sec.
    
    Summary:
       System  time (secs)  rate (ops/sec)
    ---------  -----------  --------------
      Oj::Doc       0.164      609893.696
         Yajl       3.168       31569.902
    JSON::Ext       3.282       30464.826
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                 Oj::Doc       Yajl  JSON::Ext
    ---------  ---------  ---------  ---------
      Oj::Doc       1.00      19.32      20.02
         Yajl       0.05       1.00       1.04
    JSON::Ext       0.05       0.96       1.00
    
    --------------------------------------------------------------------------------
    Parse and get all values Performance
    Oj::Doc.parse 100000 times in 0.417 seconds or 240054.540 parse/sec.
    Yajl.parse 100000 times in 5.159 seconds or 19384.191 parse/sec.
    JSON::Ext.parse 100000 times in 5.269 seconds or 18978.638 parse/sec.
    
    Summary:
       System  time (secs)  rate (ops/sec)
    ---------  -----------  --------------
      Oj::Doc       0.417      240054.540
         Yajl       5.159       19384.191
    JSON::Ext       5.269       18978.638
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                 Oj::Doc       Yajl  JSON::Ext
    ---------  ---------  ---------  ---------
      Oj::Doc       1.00      12.38      12.65
         Yajl       0.08       1.00       1.02
    JSON::Ext       0.08       0.98       1.00
    
    --------------------------------------------------------------------------------
    fetch nested Performance
    Oj::Doc.fetch 100000 times in 0.094 seconds or 1059995.760 fetch/sec.
    Ruby.fetch 100000 times in 0.503 seconds or 198851.434 fetch/sec.
    
    Summary:
     System  time (secs)  rate (ops/sec)
    -------  -----------  --------------
    Oj::Doc       0.094     1059995.760
       Ruby       0.503      198851.434
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
             Oj::Doc     Ruby
    -------  -------  -------
    Oj::Doc     1.00     5.33
       Ruby     0.19     1.00

What the results mean are that for getting just a few values from a JSON
document Oj::Doc is 20 times faster than any other parser and for accessing
all values it is still over 12 times faster than any other Ruby JSON parser.

### Conventional Oj parser comparisons

The following table shows the difference is speeds between several
serialization packages compared to the more conventional Oj parser. The tests
had to be scaled back due to limitation of some of the gems. I finally gave up
trying to get JSON Pure to serialize without errors with Ruby 1.9.3. It had
internal errors on anything other than a simple JSON structure. The errors
encountered were:

- MessagePack fails to convert Bignum to JSON

- JSON Pure fails to serialize any numbers or Objects with the to_json() method

Options were added to the test/perf_strict.rb test to run the test without
Object encoding and without Bignums.

None of the packages except Oj were able to serialize Ruby Objects that did
not have a to_json() method or were of the 7 native JSON types.

A perf_obj.rb file was added for comparing different Object marshalling
packages.

It is also worth noting that although Oj is slightly behind MessagePack for
parsing, Oj serialization is much faster than MessagePack even though Oj uses
human readable JSON vs the binary MessagePack format.

Oj supports circular references when in :object mode and when the :circular
flag is true. None of the other gems tested supported circular
references. They failed in the following manners when the input included
circular references.

 - Yajl core dumps Ruby

 - JSON fails and raises an Exception

 - MessagePack fails and raises an Exception

The benchmark results are:

with Object and Bignum encoding:

    > perf_strict.rb 
    --------------------------------------------------------------------------------
    Load/Parse Performance
    Oj:compat.load 100000 times in 1.481 seconds or 67513.146 load/sec.
    Oj.load 100000 times in 1.066 seconds or 93796.400 load/sec.
    JSON::Ext.parse 100000 times in 3.023 seconds or 33074.875 parse/sec.
    JSON::Pure.parse 100000 times in 18.908 seconds or 5288.799 parse/sec.
    Ox.load 100000 times in 1.240 seconds or 80671.900 load/sec.
    
    Summary:
        System  time (secs)  rate (ops/sec)
    ----------  -----------  --------------
            Oj       1.066       93796.400
            Ox       1.240       80671.900
     Oj:compat       1.481       67513.146
     JSON::Ext       3.023       33074.875
    JSON::Pure      18.908        5288.799
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                        Oj          Ox   Oj:compat   JSON::Ext  JSON::Pure
    ----------  ----------  ----------  ----------  ----------  ----------
            Oj        1.00        1.16        1.39        2.84       17.73
            Ox        0.86        1.00        1.19        2.44       15.25
     Oj:compat        0.72        0.84        1.00        2.04       12.77
     JSON::Ext        0.35        0.41        0.49        1.00        6.25
    JSON::Pure        0.06        0.07        0.08        0.16        1.00
    
    
    --------------------------------------------------------------------------------
    Dump/Encode/Generate Performance
    Oj:compat.dump 100000 times in 0.789 seconds or 126715.249 dump/sec.
    Oj.dump 100000 times in 0.457 seconds or 218798.751 dump/sec.
    JSON::Ext.generate 100000 times in 4.371 seconds or 22878.630 generate/sec.
    Ox.dump 100000 times in 0.501 seconds or 199425.256 dump/sec.
    
    Summary:
       System  time (secs)  rate (ops/sec)
    ---------  -----------  --------------
           Oj       0.457      218798.751
           Ox       0.501      199425.256
    Oj:compat       0.789      126715.249
    JSON::Ext       4.371       22878.630
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                      Oj         Ox  Oj:compat  JSON::Ext
    ---------  ---------  ---------  ---------  ---------
           Oj       1.00       1.10       1.73       9.56
           Ox       0.91       1.00       1.57       8.72
    Oj:compat       0.58       0.64       1.00       5.54
    JSON::Ext       0.10       0.11       0.18       1.00
    
    
    The following packages were not included for the reason listed
    ***** MessagePack: RangeError: bignum too big to convert into `unsigned long long'
    ***** Yajl: RuntimeError: Yajl parse and encode did not return the same object as the original.
    ***** JSON::Pure: TypeError: wrong argument type JSON::Pure::Generator::State (expected Data)

without Objects or numbers (for JSON Pure, Yajl, and Messagepack) JSON:

    --------------------------------------------------------------------------------
    Load/Parse Performance
    Oj:compat.load 100000 times in 0.806 seconds or 124051.164 load/sec.
    Oj.load 100000 times in 0.810 seconds or 123384.587 load/sec.
    Yajl.parse 100000 times in 1.441 seconds or 69385.996 parse/sec.
    JSON::Ext.parse 100000 times in 1.567 seconds or 63797.848 parse/sec.
    JSON::Pure.parse 100000 times in 13.500 seconds or 7407.247 parse/sec.
    Ox.load 100000 times in 0.954 seconds or 104836.748 load/sec.
    MessagePack.unpack 100000 times in 0.651 seconds or 153707.817 unpack/sec.
    
    Summary:
         System  time (secs)  rate (ops/sec)
    -----------  -----------  --------------
    MessagePack       0.651      153707.817
      Oj:compat       0.806      124051.164
             Oj       0.810      123384.587
             Ox       0.954      104836.748
           Yajl       1.441       69385.996
      JSON::Ext       1.567       63797.848
     JSON::Pure      13.500        7407.247
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                 MessagePack    Oj:compat           Oj           Ox         Yajl    JSON::Ext   JSON::Pure
    -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------
    MessagePack         1.00         1.24         1.25         1.47         2.22         2.41        20.75
      Oj:compat         0.81         1.00         1.01         1.18         1.79         1.94        16.75
             Oj         0.80         0.99         1.00         1.18         1.78         1.93        16.66
             Ox         0.68         0.85         0.85         1.00         1.51         1.64        14.15
           Yajl         0.45         0.56         0.56         0.66         1.00         1.09         9.37
      JSON::Ext         0.42         0.51         0.52         0.61         0.92         1.00         8.61
     JSON::Pure         0.05         0.06         0.06         0.07         0.11         0.12         1.00
    
    
    --------------------------------------------------------------------------------
    Dump/Encode/Generate Performance
    Oj:compat.dump 100000 times in 0.173 seconds or 578526.262 dump/sec.
    Oj.dump 100000 times in 0.179 seconds or 558362.880 dump/sec.
    Yajl.encode 100000 times in 0.776 seconds or 128794.279 encode/sec.
    JSON::Ext.generate 100000 times in 3.511 seconds or 28483.812 generate/sec.
    JSON::Pure.generate 100000 times in 7.389 seconds or 13533.717 generate/sec.
    Ox.dump 100000 times in 0.196 seconds or 510589.629 dump/sec.
    MessagePack.pack 100000 times in 0.317 seconds or 315307.220 pack/sec.
    
    Summary:
         System  time (secs)  rate (ops/sec)
    -----------  -----------  --------------
      Oj:compat       0.173      578526.262
             Oj       0.179      558362.880
             Ox       0.196      510589.629
    MessagePack       0.317      315307.220
           Yajl       0.776      128794.279
      JSON::Ext       3.511       28483.812
     JSON::Pure       7.389       13533.717
    
    Comparison Matrix
    (performance factor, 2.0 row is means twice as fast as column)
                   Oj:compat           Oj           Ox  MessagePack         Yajl    JSON::Ext   JSON::Pure
    -----------  -----------  -----------  -----------  -----------  -----------  -----------  -----------
      Oj:compat         1.00         1.04         1.13         1.83         4.49        20.31        42.75
             Oj         0.97         1.00         1.09         1.77         4.34        19.60        41.26
             Ox         0.88         0.91         1.00         1.62         3.96        17.93        37.73
    MessagePack         0.55         0.56         0.62         1.00         2.45        11.07        23.30
           Yajl         0.22         0.23         0.25         0.41         1.00         4.52         9.52
      JSON::Ext         0.05         0.05         0.06         0.09         0.22         1.00         2.10
     JSON::Pure         0.02         0.02         0.03         0.04         0.11         0.48         1.00
    
### Simple JSON Writing and Parsing:

    require 'oj'
    
    h = { 'one' => 1, 'array' => [ true, false ] }
    json = Oj.dump(h)
    
    # json =
    # {
    #   "one":1,
    #   "array":[
    #     true,
    #     false
    #   ]
    # }

    h2 = Oj.load(json)
    puts "Same? #{h == h2}"
    # true

### Object JSON format:

In :object mode Oj generates JSON that follows conventions which allow Class
and other information such as Object IDs for circular reference detection. The
formating follows the following rules.

1. JSON native types, true, false, nil, String, Hash, Array, and Number are
encoded normally.

2. A Symbol is encoded as a JSON string with a preceeding `:` character.

3. The `^` character denotes a special key value when in a JSON Object sequence.

4. A Ruby String that starts with `:` or the sequence `^i` or `^r` are encoded by
excaping the first character so that it appears as `\u005e` or `\u003a` instead of
`:` or `^`.

5. A `"^c"` JSON Object key indicates the value should be converted to a Ruby
class. The sequence `{"^c":"Oj::Bag"}` is read as the Oj::Bag class.

6. A `"^t"` JSON Object key indicates the value should be converted to a Ruby
Time. The sequence `{"^t":1325775487.000000}` is read as Jan 5, 2012 at
23:58:07.

7. A `"^o"` JSON Object key indicates the value should be converted to a Ruby
Object. The first entry in the JSON Object must be a class with the `"^o"`
key. After that each entry is treated as a variable of the Object where the
key is the variable name without the preceeding `@`. An example is
`{"^o":"Oj::Bag","x":58,"y":"marbles"}`. `"^O"` is the same except that it is
for built in or odd classes that don't obey the normal Ruby rules. Examples
are Rational, Date, and DateTime.

8. A `"^u"` JSON Object key indicates the value should be converted to a Ruby
Struct. The first entry in the JSON Object must be a class with the `"^u"`
key. After that each entry is is given a numeric position in the struct and
that is used as the key in the JSON Object. An example is `{"^u":["Range",1,7,false]}`.

9. When encoding an Object, if the variable name does not begin with an `@`
character then the name preceeded by a `~` character. This occurs in the
Exception class. An example is `{"^o":"StandardError","~mesg":"A Message","~bt":[".\/tests.rb:345:in `test_exception'"]}`.

10. If a Hash entry has a key that is not a String or Symbol then the entry is
encoded with a key of the form `"^#n"` where n is a hex number. The value that
is an Array where the first element is the key in the Hash and the second is
the value. An example is `{"^#3":[2,5]}`.

11. A `"^i"` JSON entry in either an Object or Array is the ID of the Ruby
Object being encoded. It is used when the :circular flag is set. It can appear
in either a JSON Object or in a JSON Array. In an Object the `"^i"` key has a
corresponding reference Fixnum. In an array the sequence will include an
embedded reference number. An example is
`{"^o":"Oj::Bag","^i":1,"x":["^i2",true],"me":"^r1"}`.

12. A `"^r"` JSON entry in an Object is a references to a Object or Array that
already appears in the JSON String. It must match up with a previous `"^i"`
ID. An example is `{"^o":"Oj::Bag","^i":1,"x":3,"me":"^r1"}`.

13. If an Array element is a String and starts with `"^i"` then the first
character, the `^` is encoded as a hex character sequence. An example is
`["\u005ei37",3]`.

### License:

    Copyright (c) 2012, Peter Ohler
    All rights reserved.
    
    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are met:
    
     - Redistributions of source code must retain the above copyright notice, this
       list of conditions and the following disclaimer.
    
     - Redistributions in binary form must reproduce the above copyright notice,
       this list of conditions and the following disclaimer in the documentation
       and/or other materials provided with the distribution.
    
     - Neither the name of Peter Ohler nor the names of its contributors may be
       used to endorse or promote products derived from this software without
       specific prior written permission.
    
    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
    AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
    DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
    FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
    DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
    SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
    CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
    OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

= All-purpose Property List manipulation library

Plist is a library to manipulate Property List files, also known as plists.  It can parse plist files into native Ruby data structures as well as generating new plist files from your Ruby objects.

== Usage

=== Parsing

  result = Plist::parse_xml('path/to/example.plist')

  result.class
  => Hash

  "#{result['FirstName']} #{result['LastName']}"
  => "John Public"

  result['ZipPostal']
  => "12345"

==== Example Property List

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
          <key>FirstName</key>
          <string>John</string>

          <key>LastName</key>
          <string>Public</string>

          <key>StreetAddr1</key>
          <string>123 Anywhere St.</string>

          <key>StateProv</key>
          <string>CA</string>

          <key>City</key>
          <string>Some Town</string>

          <key>CountryName</key>
          <string>United States</string>

          <key>AreaCode</key>
          <string>555</string>

          <key>LocalPhoneNumber</key>
          <string>5551212</string>

          <key>ZipPostal</key>
          <string>12345</string>
  </dict>
  </plist>

=== Generation

plist also provides the ability to generate plists from Ruby objects.  The following Ruby classes are converted into native plist types:
  Array, Bignum, Date, DateTime, Fixnum, Float, Hash, Integer, String, Symbol, Time, true, false

* +Array+ and +Hash+ are both recursive; their elements will be converted into plist nodes inside the <array> and <dict> containers (respectively).
* +IO+ (and its descendants) and +StringIO+ objects are read from and their contents placed in a <data> element.
* User classes may implement +to_plist_node+ to dictate how they should be serialized; otherwise the object will be passed to <tt>Marshal.dump</tt> and the result placed in a <data> element.  See below for more details.

==== Creating a plist

There are two ways to generate complete plists.  Given an object:

  obj = [1, :two, {'c' => 0xd}]

If you've mixed in <tt>Plist::Emit</tt> (which is already done for +Array+ and +Hash+), you can simply call +to_plist+:

  obj.to_plist

This is equivalent to calling <tt>Plist::Emit.dump(obj)</tt>.  Either one will yield:

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <array>
      <integer>1</integer>
      <string>two</string>
      <dict>
        <key>c</key>
        <integer>13</integer>
      </dict>
  </array>
  </plist>

You can also dump plist fragments by passing +false+ as the second parameter:

  Plist::Emit.dump('holy cow!', false)
  => "<string>holy cow!</string>"

==== Custom serialization

If your class can be safely coerced into a native plist datatype, you can implement +to_plist_node+.  Upon encountering an object of a class it doesn't recognize, the plist library will check to see if it responds to +to_plist_node+, and if so, insert the result of that call into the plist output.

An example:

  class MyFancyString
    ...

    def to_plist_node
      return "<string>#{self.defancify}</string>"
    end
  end

When you attempt to serialize a +MyFancyString+ object, the +to_plist_node+ method will be called and the object's contents will be defancified and placed in the plist.

If for whatever reason you can't add this method, your object will be serialized with <tt>Marshal.dump</tt> instead.

== Links

[Project Page]  http://plist.rubyforge.org
[GitHub]        http://github.com/bleything/plist
[RDoc]          http://plist.rubyforge.org

== Credits

plist is maintained by Ben Bleything <mailto:ben@bleything.net> and Patrick May <mailto:patrick@hexane.org>.  Patrick wrote most of the code; Ben is a recent addition to the project, having merged in his plist generation library.

Other folks who have helped along the way:

[<b>Martin Dittus</b>] who pointed out that +Time+ wasn't enough for plist <tt>Dates</tt>, especially those in <tt>~/Library/Cookies/Cookies.plist</tt>
[<b>Chuck Remes</b>] who pushed Patrick towards implementing <tt>#to_plist</tt>
[<b>Mat Schaffer</b>] who supplied code and test cases for <tt><data></tt> elements
[<b>Michael Granger</b>] for encouragement and help
[<b>Carsten Bormann, Chris Hoffman, Dana Contreras, Hongli Lai, Johan Srensen</b>] for contributing Ruby 1.9.x compatibility fixes

== License and Copyright

plist is released under the MIT License.

Portions of the code (notably the Rakefile) contain code pulled and/or adapted from other projects.  These files contain a comment at the top describing what was used.

=== MIT License

Copyright (c) 2006-2010, Ben Bleything <ben@bleything.net> and Patrick May <patrick@hexane.org>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY
KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


# Alfred 2 Workflow for Philips Hue

Trigger:

	hue [<command> | <light>:<function>:<query>]

## Examples

	hue off
	hue on
	hue party
	hue lights
	hue 2:off
	hue 1:effect:colorloop
	hue 1:effect:none
	hue 3:color:red

## Download

Download the extension here: http://goo.gl/Yt6qg

I've yet to officially release this workflow, but if you happened to stumble upon this Github repo, feel free to give it a try.  I will officially publish the workflow when I've finished the TODO items below and thoroughly tested everything.

## Setup

Press the link button on the top of the bridge and use the `setup-hue` Alfred keyword within 30 seconds to automatically configure the workflow to work with the Hue bridge on the local network.

A group id can optionally be specified, e.g. `setup-hue 1` (defaults to `0`, which is all of the Hue bulbs).  Although much of the [Groups API](http://developers.meethue.com/2_groupsapi.html) remains undocumented, some developers have figured out [how to add and configure groups](http://www.everyhue.com/vanilla/discussion/57/api-groups/p1).

## Screenshots

Home (blank query):

![Home](/screenshots/home.png)

Lights:

![Lights](/screenshots/lights.png)

Light controls:

![Control](/screenshots/control.png)

Setting the color:

![Color](/screenshots/color.png)

## Roadmap

* Add the ability to save current state as a preset.

[Alfred 2][alfred] Workflow for showing weather forecasts
=========================================================

<p align="center">
<img alt="Screenshot" src="http://i.imgur.com/c76YyE5.png" />
</p>

<p align="center">
  <a href="https://dl.dropbox.com/s/hug7tz83dk5wsa5/jc-weather.alfredworkflow"><img src="http://i.imgur.com/E8I5TfU.png" alt="Download"></a>
</p>

This workflow lets you access weather forecasts from [forecast.io][fio] and the
[Weather Underground][wund].  There are several setup commands, accessible as
`wset <command>`, and a single `weather` command to display current conditions
and a forecast.

The setup commands are:

  * `days` - set the number of forecast days to show
  * `getkey` - open the API key signup page for your current service
  * `icons` - choose an icon set
  * `location <ZIP or city>` - set your default location
  * `service` - set your preferred weather service, forecast.io or Weather
    Underground
  * `units` - set your preferred unit system

The `weather` command, with no argument, will show information for your default
location. It can also be given a location, such as a ZIP code or city name. It
(and the `wset location` command) uses the Weather Underground autocomplete API
to find possible locations based on what you enter.

The first time you try to access the weather, you'll be asked to set your
preferred service, currently either Weather Underground or Forecast.io. You'll
also be asked to set an API key for your chosen service. If you don't already
have a key you can use `wset getkey` to open the API signup page for the
weather service.  API keys from both Weather Underground and forecast.io are
free.

Once you've set the service and API key, you'll also need to set a default
location. This is done with the `wset location` command.

The data for each city you query is cached for 5 minutes to keep requests down
to a reasonable level while you're playing around with the workflow. The free
tier of Weather Underground API access is throttled to 10 requests per minute,
and it's surprisingly easy to hit that limit (you know, when you're spastically
querying city after city because using an Alfred workflow is just so cool).

Installation
------------

The easiest way to install the workflow is to download the
[prepackaged workflow][package].  Double-click on the downloaded file, or drag
it into the Alfred Workflows window, and Alfred should install it.

I'm using `weather` as the main command, which is the same as the built-in
weather web search in Alfred. The web search can be disabled in Features &rarr;
Web Search if you don't want it showing up in your weather report.
Alternatively, you can change the `weather` command to something else.

Requirements
------------

The only requirements are:

  * Python 2.7+
  * `requests`

If you have Lion or Mountain Lion, the [prepackaged workflow][package] includes
everything you need.

Credits
-------

This script was originally based on David Ferguson's Weather workflow. My code
base has diverged pretty far at this point, though, both in the source and in
how it works.

The package includes a number of icon sets from the Weather Underground and
from [weathericonsets.com][icons] (I'm not up to drawing weather icons yet).
Each set includes an `info.json` file that gives a short description and
provides a source URL for the icon set.

[api]: http://www.wunderground.com/weather/api/
[package]: https://dl.dropbox.com/s/hug7tz83dk5wsa5/jc-weather.alfredworkflow
[alfred]: http://www.alfredapp.com
[icons]: http://www.weathericonsets.com
[wund]: http://www.weatherunderground.com
[fio]: http://forecast.io


# jsapi-workflow

 javascript API  alfred workflow .  Alfred 2.0 , powerpack.

### 

![](http://api.allenm.me/jsapiworkflow/snapshot.png)

### 

#LOVEFiLM Alfred Workflow
To search films and tv shows on LOVEFiLM 

## Change Language
Edit the script filter in alfred workflow dialogue and change it to the following:
> python lovefilm.py de "{query}"
or
> python lovefilm.py com "{query}"

## Changelog

### 04-02-2013
- FIXED: Unread count was getting stored with folder list and not being updated on each run;
- NEW: Hotkey to mark all messages (unread messages in current mailbox) as read
- NEW: Hotkey to delete every message in current mailbox (useful for me anyway)
- NEW: Keyword/Hotkey to show list of mailboxes with unread messages

### 03-02-2013
- NEW: Added unread count next to each mailbox. If the mailbox has no unread emails then nothing is displayed.

### 29-01-2013
- NEW: Added action to display Info & Usage as well as Change Log.
- NEW: Added support for Local Mailboxes.

### 28-01-2013
- FIXED: Small encoding bug where special characters weren't encoded thus forming invalid XML.

### 27-01-2013
- FIXED: Wrong information in the Go To action (Thanks CarlosNZ);
- Uploaded to AlfPT (Forgot to do that initially)
# Introducing Mail Actions
Go crazy minimal with **Mail.app** and still stay functional thanks to the power of Alfred 2 Workflows.

## Features
Use Alfred to:
- Navigate Mailboxes from Alfred.  
	Drill down to the Mailbox you want and action the result.
- Move/Copy selected emails with Alfred.  
	Type a few keywords to choose the desired folder.  to move, + to copy.
	
###Optimizations
In order to limit the overhead of always having to query and generate a list of all Mailboxes, the workflow store the information in a plist file that is updated every 7 days. The file is located at:  

	~/Library/Application Support/Alfred 2/Workflow Data/com.palobo.mailactions/mbCache.plist

	
## Installation
[Download](http://bit.ly/10UFFP5) and import or alternatively use AlfPT.

## Usage
### Keywords

- **mm** - Move the selected messages to the chosen folder;
- **mm** - With  as modifier copies the messages rather than moving
- **mg** - Go To the chosen folder.
- **mgu** - Show list of mailboxes with unread messages
- **minfo** - Shows either **README** or **CHANGELOG**. Uses Marked by default or if not present will use your default markdown viewer/editor.

### Hotkeys
- **A** - Toggle script to Move/Copy messages
- **Z** - Toggle script to Go To Mailbox;
- **R** - Mark every unread message in current mailbox as read;
- **D** - Delete every message in current mailbox!! (USe with caution)
- **U** - Show list of mailboxes with unread messages

## Todo
1. Implement an action to update the cache on demand;
2. Filter the list of mailboxes with unread email
3. Integrate other useful workflows such as send to evernote/taskpaper etc.;

# Alfred 2 workflow for Manpages

<div><img src="https://raw.github.com/skyzyx/manpages.alfredworkflow/master/screenshot.png"></div>

**[Download!](https://github.com/skyzyx/manpages.alfredworkflow/raw/master/manpages.alfredworkflow)**
Requires [Alfred 2 and the Powerpack](http://www.alfredapp.com/powerpack/).

Updates can be found and installed using **[Alleyoop](http://alfred.daniel.sh/Workflows/Alleyoop.alfredworkflow)**.

# Alfred Workflow Builder

Alfred Workflow Builder is a PHP class for creating workflows with Alfred 2. This class provides functions for working
with plist settings files, reading and writing data to files, generating Alfred feedback results, and more.


## Installation

[Composer](http://getcomposer.org) is the recommended way to install is package. Composer is dependency management tool
for PHP that allows you to declare the dependencies your project needs and installs them into your project.

1. Add `skyzyx/alfred-workflow-builder` as a dependency in your project's `composer.json` file.

	```json
	{
	    "require": {
	        "skyzyx/alfred-workflow-builder": "1.0.*"
	    }
	}
	```

2. Download and install Composer.

	```bash
	curl -s "http://getcomposer.org/installer" | php
	```

3. Install your dependencies.

	```bash
	php composer.phar install --optimize-autoloader
	```

4. Require Composer's autoloader.
Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that
it downloads. To use it, just add the following line to your code's bootstrap process.

	```php
	require 'vendor/autoload.php';
	```

The [original version of this class](https://github.com/jdfwarrior/Workflows) (written by [David Ferguson](http://dferg.us))
had methods for things like caching data to local files and fetching remote data over HTTP. Instead, we recommend you use
[Guzzle](http://guzzlephp.org), [Requests](http://requests.ryanmccue.info) or [Buzz](https://github.com/kriswallsmith/Buzz)
for HTTP requests and [Doctrine Cache](http://docs.doctrine-project.org/en/2.0.x/reference/caching.html) for local file
system caching. If you'd also like logging, we recommend [Monolog](https://github.com/Seldaek/monolog).

----

## `Alfred\Workflow`

```php
use Alfred\Workflow;

// Pass a Bundle ID
$w = new Workflow('com.ryanparman.my-workflow');
#=> <Alfred\Workflow>
```

### `string` toXML()
Accepts a properly formatted array or json object and converts it to XML for creating Alfred feedback results. If results
have been created using the `result()` function, then passing no arguments will use the array of results created using
the `result()` function.

#### Example using result function
```php
$w->result(array(
    'uid'          => 'itemuid',
    'arg'          => 'itemarg',
    'title'        => 'Some Item Title',
    'subtitle'     => 'Some item subtitle',
    'icon'         => 'icon.png',
    'valid'        => 'yes',
    'autocomplete' => 'autocomplete'
));
echo $w->toXML();
```

#### Example using array
```php
$results = array();
$temp = array(
    'uid'          => 'itemuid',
    'arg'          => 'itemarg',
    'title'        => 'Some Item Title',
    'subtitle'     => 'Some item subtitle',
    'icon'         => 'icon.png',
    'valid'        => 'yes',
    'autocomplete' => 'autocomplete'
);
array_push($results, $temp);
echo $w->toXML($results);
```

#### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="itemuid" arg="itemarg" autocomplete="autocomplete">
        <title>Some Item Title</title>
        <subtitle>Some item subtitle</subtitle>
        <icon>icon.png</icon>
    </item>
</items>
```

### `array` mdfind()
Executes an `mdfind` command and returns results as an array of matching files.

```php
$results = $w->mdfind('"kMDItemContentType == com.apple.mail.emlx"');
/* or */
$results = $w->mdfind('Alfred 2.app');
#=> (array) ['/Applications/Alfred 2.app']
```

You can learn more about querying the OS X metadata service by checking out:
* [Using Spotlight from the OS X Commandline](http://0xfe.blogspot.com/2006/03/using-spotlight-from-os-x-commandline.html)
* [File Metadata Query Expression Syntax](https://developer.apple.com/library/mac/#documentation/carbon/conceptual/spotlightquery/concepts/queryformat.html)
* [Spotlight Metadata Attributes](https://developer.apple.com/library/mac/#documentation/carbon/Reference/MetadataAttributesRef/Reference/CommonAttrs.html#//apple_ref/doc/uid/TP40001694-SW1)

### `array` result()
Creates a new result item that is cached within the class object. This set of results is available via the `results()`
functions, or, can be formatted and returned as XML via the `toXML()` function.

<table>
    <thead>
        <tr>
            <th>Key</th>
            <th>Usage</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>uid</code></td>
            <td><p>Unique ID for the search result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>arg</code></td>
            <td><p>Argument for this result. This will get fed into any downstream actions. (Required)</p></td>
        </tr>
        <tr>
            <td><code>title</code></td>
            <td><p>The main title for the result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>subtitle</code></td>
            <td><p>The subtitle for the result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>icon</code></td>
            <td><p>The icon that this result should have. This should typically be <code>icon.png</code>. (Required)</p></td>
        </tr>
        <tr>
            <td><code>valid</code></td>
            <td><p>If you press enter with this result selected, should it trigger downstream actions? Valid values are
                <code>"yes"</code>, <code>"no"</code>, <code>true</code> and <code>false</code>. The default value is
                <code>"yes"</code>.</p></td>
        </tr>
        <tr>
            <td><code>autocomplete</code></td>
            <td><p>If you press enter with this result selected, what value should pop up as an autocomplete value?
                (<a href="http://simonbs.dk/post/41727742869/movies-workflow-for-alfred-2-0">Movies</a> is a good usage
                example.)</p></td>
        </tr>
    </tbody>
</table>

#### Example
```php
$w->result(array (
    'uid'          => 'alfred',
    'arg'          => 'alfredapp',
    'title'        => 'Alfred',
    'subtitle'     => '/Applications/Alfred.app',
    'icon'         => 'fileicon:/Applications/Alfred.app',
    'valid'        => 'yes',
    'autocomplete' => 'Alfredapp',
));
echo $w->toXML();
```

#### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="alfred" arg="alfredapp" autocomplete="Alfredapp">
        <title>Alfred</title>
        <subtitle>/Applications/Alfred.app</subtitle>
        <icon type="fileicon">/Applications/Alfred.app</icon>
    </item>
</items>
```

----

## `Alfred\Storage\Plist`

```php
use Alfred\Storage\Plist;

// Pass a Bundle ID and Plist name
$plist = new Plist('com.ryanparman.my-workflow', 'info');
#=> <Alfred\Storage\Plist>
```

### `string` setValue()
Stores a key-value pair.

```php
$plist->setValue('username', 'rparman');
```

### `string` setValues()
Stores a series of key-value pairs.

```php
$plist->setValues(array(
    'username' => 'rparman',
    'password' => 'abc123',
    'zipcode'  => '90210',
));
```

### `string` getValue()
Retrieves the value of a key.

```php
$username = $plist->getValue('username');
#=> (string) rparman
```

## More!
You can learn more about Alfred 2 Workflows by checking out <http://support.alfredapp.com/workflows>.

You can also deconstruct some workflows that are built with Alfred Workflow Builder.
* [Packagist](https://github.com/skyzyx/packagist.alfredworkflow)
* [Geolocation](https://github.com/skyzyx/geolocation.alfredworkflow)
* [Mimetypes](https://github.com/skyzyx/mimetypes.alfredworkflow)

CHANGELOG
=========

2.3.0
-----

 * added the dumpFile() method to atomically write files
 
2.2.0
-----

 * added a delete option for the mirror() method

2.1.0
-----

 * 24eb396 : BC Break : mkdir() function now throws exception in case of failure instead of returning Boolean value
 * created the component

Filesystem Component
====================

Filesystem provides basic utility to manipulate the file system:

```php
<?php

use Symfony\Component\Filesystem\Filesystem;

$filesystem = new Filesystem();

$filesystem->copy($originFile, $targetFile, $override = false);

$filesystem->mkdir($dirs, $mode = 0777);

$filesystem->touch($files, $time = null, $atime = null);

$filesystem->remove($files);

$filesystem->chmod($files, $mode, $umask = 0000, $recursive = false);

$filesystem->chown($files, $user, $recursive = false);

$filesystem->chgrp($files, $group, $recursive = false);

$filesystem->rename($origin, $target);

$filesystem->symlink($originDir, $targetDir, $copyOnWindows = false);

$filesystem->makePathRelative($endPath, $startPath);

$filesystem->mirror($originDir, $targetDir, \Traversable $iterator = null, $options = array());

$filesystem->isAbsolutePath($file);
```

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/Filesystem/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.3.0
-----

 * added ProcessUtils::escapeArgument() to fix the bug in escapeshellarg() function on Windows
 * added Process::signal()
 * added Process::getPid()
 * added support for a TTY mode

2.2.0
-----

 * added ProcessBuilder::setArguments() to reset the arguments on a builder
 * added a way to retrieve the standard and error output incrementally
 * added Process:restart()

2.1.0
-----

 * added support for non-blocking processes (start(), wait(), isRunning(), stop())
 * enhanced Windows compatibility
 * added Process::getExitCodeText() that returns a string representation for
   the exit code returned by the process
 * added ProcessBuilder

Process Component
=================

Process executes commands in sub-processes.

In this example, we run a simple directory listing and get the result back:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->setTimeout(3600);
    $process->run();
    if (!$process->isSuccessful()) {
        throw new RuntimeException($process->getErrorOutput());
    }

    print $process->getOutput();

You can think that this is easy to achieve with plain PHP but it's not especially
if you want to take care of the subtle differences between the different platforms.

And if you want to be able to get some feedback in real-time, just pass an
anonymous function to the ``run()`` method and you will get the output buffer
as it becomes available:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->run(function ($type, $buffer) {
        if ('err' === $type) {
            echo 'ERR > '.$buffer;
        } else {
            echo 'OUT > '.$buffer;
        }
    });

That's great if you want to execute a long running command (like rsync-ing files to a
remote server) and give feedback to the user in real-time.

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/XXX/
    $ composer.phar install --dev
    $ phpunit

# Alfred 2 workflow for Geolocation

<div><img src="screenshot.png"></div>

**[Download!](https://github.com/skyzyx/geolocation.alfredworkflow/raw/master/geolocation.alfredworkflow)**
Requires [Alfred 2 and the Powerpack](http://www.alfredapp.com/powerpack/).

Updates can be found and installed using **[Alleyoop](http://alfred.daniel.sh/Workflows/Alleyoop.alfredworkflow)**.

JSON Lint
=========

[![Build Status](https://secure.travis-ci.org/Seldaek/jsonlint.png)](http://travis-ci.org/Seldaek/jsonlint)

Usage
-----

```php
use Seld\JsonLint\JsonParser;

$parser = new JsonParser();
    
// returns null if it's valid json, or a ParsingException object.
$parser->lint($json);

// Call getMessage() on the exception object to get
// a well formatted error message error like this

// Parse error on line 2:
// ... "key": "value"    "numbers": [1, 2, 3]
// ----------------------^
// Expected one of: 'EOF', '}', ':', ',', ']'

// Call getDetails() on the exception to get more info.

// returns parsed json, like json_decode() does, but slower, throws
// exceptions on failure.
$parser->parse($json);
```

Installation
------------

JSON Lint can easily be used within another app if you have a PSR-0 autoloader, or
it can be installed through [Composer](http://packagist.org/) for use as a CLI util.
Once installed via Composer you can run the following command to lint a json file or URL:

    $ bin/jsonlint file.json

Requirements
------------

- PHP 5.3+
- [optional] PHPUnit 3.5+ to execute the test suite (phpunit --version)

Submitting bugs and feature requests
------------------------------------

Bugs and feature request are tracked on [GitHub](https://github.com/Seldaek/jsonlint/issues)

Author
------

Jordi Boggiano - <j.boggiano@seld.be> - <http://twitter.com/seldaek>

License
-------

JSON Lint is licensed under the MIT License - see the LICENSE file for details

Acknowledgements
----------------

This library is a port of the JavaScript [jsonlint](https://github.com/zaach/jsonlint) library.

# Alfred Workflow Builder

Alfred Workflow Builder is a PHP class for creating workflows with Alfred 2. This class provides functions for working
with plist settings files, reading and writing data to files, generating Alfred feedback results, and more.


## Installation

[Composer](composer) is the recommended way to install is package. Composer is dependency management tool for PHP that
allows you to declare the dependencies your project needs and installs them into your project.

1. Add `skyzyx/alfred-workflow-builder` as a dependency in your project's `composer.json` file.

	```json
	{
	    "require": {
	        "skyzyx/alfred-workflow-builder": "1.0.*"
	    }
	}
	```

2. Download and install Composer.

	```bash
	curl -s "http://getcomposer.org/installer" | php
	```

3. Install your dependencies.

	```bash
	php composer.phar install --optimize-autoloader
	```

4. Require Composer's autoloader.
Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that
it downloads. To use it, just add the following line to your code's bootstrap process.

	```php
	require 'vendor/autoload.php';
	```

The [original version of this class](original-class) (written by [David Ferguson](dferg)) had methods for things like
caching data to local files and fetching remote data over HTTP. Instead, we recommend you use [Guzzle](guzzle),
[Requests](requests) or [Buzz](buzz) for HTTP requests and [Doctrine Cache][doctrine-cache] for local file system caching.
If you'd also like logging, we recommend [Monolog](monolog).

[buzz]: https://github.com/kriswallsmith/Buzz
[composer]: http://getcomposer.org
[dferg]: http://dferg.us
[doctrine-cache]: http://docs.doctrine-project.org/en/2.0.x/reference/caching.html
[guzzle]: http://guzzlephp.org
[monolog]: https://github.com/Seldaek/monolog
[original-class]: https://github.com/jdfwarrior/Workflows
[requests]: http://requests.ryanmccue.info


## `Alfred\Workflow`

```php
use Alfred\Workflow;

$w = new Workflow('com.ryanparman.my-workflow');
#=> <Alfred\Workflow>
```

### Properties

#### bundle
The bundle ID for the workflow.

```php
$bundle = $w->bundle;
#=> (string) com.ryanparman.my-workflow
```

#### cache
The cache directory for the workflow.

```php
$cache = $w->cache;
#=> (string) /Users/rparman/Library/Caches/com.runningwithcrayons.Alfred-2/Workflow Data/com.ryanparman.my-workflow
```

#### data
The data directory for the workflow.

```php
$data = $w->data;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Workflow Data/com.ryanparman.my-workflow
```

#### home
The current user's `$HOME` directory.

```php
$home = $w->home;
#=> (string) /Users/rparman
```

#### path
The working directory for the workflow.

```php
$path = $w->path;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Alfred.alfredpreferences/workflows/com.ryanparman.my-workflow
```

#### results
An array containing all of the results so far.

##### Example
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo var_export($w->results());
```

##### Results
```php
array (
  0 =>
  array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
  ),
)
```


### Methods

#### `string` toXML()
Accepts a properly formatted array or json object and converts it to XML for creating Alfred feedback results. If results
have been created using the `result()` function, then passing no arguments will use the array of results created using
the `result()` function. Arrays passed in must be an associative array with array key values for the following required
values: `uid`, `arg`, `title`, `subtitle` and `icon`. You may also pass array `key => value` pairs for the following
optional keys: `valid` and `autocomplete`.

##### Example using result function
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo $w->toXML();
```

##### Example using array
```php
$results = array();
$temp = array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
);
array_push($results, $temp);
echo $w->toXML($results);
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="itemuid" arg="itemarg" autocomplete="autocomplete">
        <title>Some Item Title</title>
        <subtitle>Some item subtitle</subtitle>
        <icon>icon.png</icon>
    </item>
</items>
```

#### `array` mdfind()
Executes an `mdfind` command and returns results as an array of matching files.

```php
$results = $w->mdfind('"kMDItemContentType == com.apple.mail.emlx"');
/* or */
$results = $w->mdfind('Alfred 2.app');
#=> (array) ['/Applications/Alfred 2.app']
```

#### `array` result()
Creates a new result item that is cached within the class object. This set of results is available via the `results()`
functions, or, can be formatted and returned as XML via the `toXML()` function.

Autocomplete value is optional. If no value is specified, it will take the value of the result title. Possible values
for `$valid` are `yes` and `no` to set the validity of the result item.

##### Example
```php
$w->result(array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
));
echo $w->toXML();
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="alfred" arg="alfredapp" autocomplete="Alfredapp">
        <title>Alfred</title>
        <subtitle>/Applications/Alfred.app</subtitle>
        <icon type="fileicon">/Applications/Alfred.app</icon>
    </item>
</items>
```


## `Alfred\Storage\Plist`

```php
use Alfred\Storage\Plist;

$plist = new Plist('com.ryanparman.my-workflow');
#=> <Alfred\Storage\Plist>
```


### Methods

#### `string` setValue()
Stores a key-value pair.

```php
$plist->setValue('username', 'rparman');
```

#### `string` setValues()
Stores a series of key-value pairs.

```php
$plist->setValues(array(
    'username' => 'rparman',
    'password' => 'abc123',
    'zipcode'  => '90210',
));
```

#### `string` getValue()
Retrieves the value of a key.

```php
$username = $plist->getValue('username');
#=> (string) rparman
```

CHANGELOG
=========

2.2.0
-----

 * added a delete option for the mirror() method

2.1.0
-----

 * 24eb396 : BC Break : mkdir() function now throws exception in case of failure instead of returning Boolean value
 * created the component

Filesystem Component
====================

Filesystem provides basic utility to manipulate the file system:

```php
<?php

use Symfony\Component\Filesystem\Filesystem;

$filesystem = new Filesystem();

$filesystem->copy($originFile, $targetFile, $override = false);

$filesystem->mkdir($dirs, $mode = 0777);

$filesystem->touch($files, $time = null, $atime = null);

$filesystem->remove($files);

$filesystem->chmod($files, $mode, $umask = 0000, $recursive = false);

$filesystem->chown($files, $user, $recursive = false);

$filesystem->chgrp($files, $group, $recursive = false);

$filesystem->rename($origin, $target);

$filesystem->symlink($originDir, $targetDir, $copyOnWindows = false);

$filesystem->makePathRelative($endPath, $startPath);

$filesystem->mirror($originDir, $targetDir, \Traversable $iterator = null, $options = array());

$filesystem->isAbsolutePath($file);
```

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/Filesystem/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.2.0
-----

 * added ProcessBuilder::setArguments() to reset the arguments on a builder
 * added a way to retrieve the standard and error output incrementally
 * added Process:restart()

2.1.0
-----

 * added support for non-blocking processes (start(), wait(), isRunning(), stop())
 * enhanced Windows compatibility
 * added Process::getExitCodeText() that returns a string representation for
   the exit code returned by the process
 * added ProcessBuilder

Process Component
=================

Process executes commands in sub-processes.

In this example, we run a simple directory listing and get the result back:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->setTimeout(3600);
    $process->run();
    if (!$process->isSuccessful()) {
        throw new RuntimeException($process->getErrorOutput());
    }

    print $process->getOutput();

You can think that this is easy to achieve with plain PHP but it's not especially
if you want to take care of the subtle differences between the different platforms.

And if you want to be able to get some feedback in real-time, just pass an
anonymous function to the ``run()`` method and you will get the output buffer
as it becomes available:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->run(function ($type, $buffer) {
        if ('err' === $type) {
            echo 'ERR > '.$buffer;
        } else {
            echo 'OUT > '.$buffer;
        }
    });

That's great if you want to execute a long running command (like rsync-ing files to a
remote server) and give feedback to the user in real-time.

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/XXX/
    $ composer.phar install --dev
    $ phpunit

PNG

PNG

# NSC
*Number System Converter -- an [Alfred](http://www.alfredapp.com/) extension*
* * * 

**Author:** [Hans-Helge B&uuml;rger](http://www.hanshelgebuerger.de "Hans-Helge Brger - Webpage")  
**Date:** 07. May 2013	
**Version:** v2.1	
**Licence:** [Attribution 3.0 Unported (CC BY 3.0)](http://creativecommons.org/licenses/by/3.0/ "Attribution 3.0 Unported (CC BY 3.0)")

## Quick Installation
### Download [NSC v2.1](https://github.com/obstschale/NSC/raw/alfredextension/nsc-v2.1.alfredworkflow)


---
## Introduction

*NSC* is a little [Alfred](http://www.alfredapp.com/) workflow to convert a number into another number system. I study computer science and therefore I daily deal with different number systems. The most common ones are probably `binary`, `octal`, `decimal`, and `hexadecimal` but I got tiered to calculate them by hand, calculator or a webpage. Alfred is only a key stroke away and so I started programming this workflow.

I started to learn Python and to pratice that the new Alfred 2 workflow is written in Python insteed of PHP. You know, only if you use a language you get better ;) So your welcome to send a pull request if you have any improvement done.

## Functions

Like I mentioned above, you can convert numbers. In the first version I implemented `binary`, `decimal`, and `hexadecimal`. And you can even convert any number from any system into another. But be warned: I didn't implemented a _letter-replacement-function_ which would display the number _10_ with an _A_. I will definitely do this soon, but in this first version I had other problems (especially to get started with Python :) )

## Usage

But how can I use NSC? It is really simple.

You call NSC with the different keywords (this is new in v2.0) and according the number you want to convert. E.g. if you want to convert a decimal number you just type `decimal` and the `number`. Alfred 2 will show instantly the converted number in `binary`, `octal`, and even `hex`.

So the 4 basic keywords are:

* `decimal`
* `binary`
* `octal`
* `hex`

and it looks like that:

![screenshot of Alfred converting the decimal number 42](img/README_decimal.png)

I really love this feature, displaying live updates in Alfred :)

Beside these 4 keywords a fifth is implemented: `convert`. It is used if a number needs to be converted which is no to base 2, 8, 10 or 16. It uses the following syntax:

	`convert` `number` `base of number` `base of new system`

Imagine it like a sentence: _Convert number X with base B into system with base Y_

![screenshot of Alfred converting the number 42 with base 6 into base 4 system](img/README_convert.png)
_Convert 42 with base 6 into system with base 4_

### Clipboard and Notification
Another cool feature of Alfred 2 is that you can pass arguments to other parts of your workflow. In case of NSC, if you select a result and click `enter`, the number will be copied to your clipboard and a notification will pop up.

### Examples

* `decimal 10`  result: B: 1010 // O: 12 // H: a

* `binary 1011`  result: D: 11 // O: 13 // H: b

* `octal 150`  result: D: 104 // B: 1101000 // H: 68

* `hex FF2`  result: D: 4082 // B: 111111110010 // O: 7762

* `convert 119 11 3`  result: D: 141 // Base 3: 12020 

---

## Changelog
### v.2.1
* add: conversion upto base 62 (case-sensitive letters if base is greater than 35)
* add: add info.plist to repo
* add: all scripts uses now [alp](https://github.com/phyllisstein/alp) to generate XML feedback 

### v2.01
* bug: base 1 led into an infinite loop (thx to [@kevinlsw](https://github.com/kevinlsw) | [#2](https://github.com/obstschale/NSC/issues/2))
* add: new int2base function which uses now letters as input/output within `convert`
* add: NSC uses [alp](https://github.com/phyllisstein/alp) to generate XML feedback



### v2.0
* NSC is now an Alfred Workflow and works with Alfred 2
* add: convert from/into decimal, binary, octal, hex
* add: new keywords `decimal`, `binary`, `octal`, `hex` and `convert`
* add: update made easy with [Alleyoop](http://www.alfredforum.com/topic/1582-alleyoop-update-alfred-workflows/)
* change GitHub link


### v1.4
* add: support for [updater extension](http://jdfwarrior.tumblr.com/updater)

### v1.3
* bug: minor bugfixes
* add: display letters if digits larger than 10

### v1.2
* add: convert to `decimal` with an own function
* add: convert from `decimal` to other number system upto base 35

### v1.1
* add: convert between `binary`, `deciaml`, and  `hexadeciaml` with PHP builtin functions

### v1.0
* first version of NSC
* add: can convert from `decimal` to `binary` and `hexadecimal` with PHP builtin functions

## Roadmap
* convert floating numbers

---
## Licensing

I'm a huge fan of *CreativeCommons* and so it's my first choice for licensing. I choose the [**CC BY 3.0**](http://creativecommons.org/licenses/by/3.0/ "Attribution 3.0 Unported (CC BY 3.0)") so you can use it for free. It's also allowed to adapt the work, for an own tutorial or a new game. But if you use it link to the tutorial.

Alfred-open-airdrop
===================

Alfred Workflow (Alfred v.2 +) for Opening Airdrop
# Alfred 2 workflow for Packagist

<div><img src="screenshot.png"></div>

**[Download!](https://github.com/skyzyx/packagist.alfredworkflow/raw/master/packagist.alfredworkflow)**
Requires [Alfred 2 and the Powerpack](http://www.alfredapp.com/powerpack/).

Updates can be found and installed using **[Alleyoop](http://alfred.daniel.sh/Workflows/Alleyoop.alfredworkflow)**.

CHANGELOG
=========

3.3.1 (2013-03-10)
------------------

* Added the ability to create PHP streaming responses from HTTP requests
* Bug fix: Running any filters when parsing response headers with service descriptions
* Bug fix: OauthPlugin fixes to allow for multi-dimensional array signing, and sorting parameters before signing
* Bug fix: Removed the adding of default empty arrays and false Booleans to responses in order to be consistent across
  response location visitors.
* Bug fix: Removed the possibility of creating configuration files with circular dependencies
* RequestFactory::create() now uses the key of a POST file when setting the POST file name
* Added xmlAllowEmpty to serialize an XML body even if no XML specific parameters are set

3.3.0 (2013-03-03)
------------------

* A large number of performance optimizations have been made
* Bug fix: Added 'wb' as a valid write mode for streams
* Bug fix: `Guzzle\Http\Message\Response::json()` now allows scalar values to be returned
* Bug fix: Fixed bug in `Guzzle\Http\Message\Response` where wrapping quotes were stripped from `getEtag()`
* BC: Removed `Guzzle\Http\Utils` class
* BC: Setting a service description on a client will no longer modify the client's command factories.
* BC: Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using
  the 'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'
* BC: `Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to
  lowercase
* Operation parameter objects are now lazy loaded internally
* Added ErrorResponsePlugin that can throw errors for responses defined in service description operations' errorResponses
* Added support for instantiating responseType=class responseClass classes. Classes must implement
  `Guzzle\Service\Command\ResponseClassInterface`
* Added support for additionalProperties for top-level parameters in responseType=model responseClasses. These
  additional properties also support locations and can be used to parse JSON responses where the outermost part of the
  JSON is an array
* Added support for nested renaming of JSON models (rename sentAs to name)
* CachePlugin
    * Added support for stale-if-error so that the CachePlugin can now serve stale content from the cache on error
    * Debug headers can now added to cached response in the CachePlugin

3.2.0 (2013-02-14)
------------------

* CurlMulti is no longer reused globally. A new multi object is created per-client. This helps to isolate clients.
* URLs with no path no longer contain a "/" by default
* Guzzle\Http\QueryString does no longer manages the leading "?". This is now handled in Guzzle\Http\Url.
* BadResponseException no longer includes the full request and response message
* Adding setData() to Guzzle\Service\Description\ServiceDescriptionInterface
* Adding getResponseBody() to Guzzle\Http\Message\RequestInterface
* Various updates to classes to use ServiceDescriptionInterface type hints rather than ServiceDescription
* Header values can now be normalized into distinct values when multiple headers are combined with a comma separated list
* xmlEncoding can now be customized for the XML declaration of a XML service description operation
* Guzzle\Http\QueryString now uses Guzzle\Http\QueryAggregator\QueryAggregatorInterface objects to add custom value
  aggregation and no longer uses callbacks
* The URL encoding implementation of Guzzle\Http\QueryString can now be customized
* Bug fix: Filters were not always invoked for array service description parameters
* Bug fix: Redirects now use a target response body rather than a temporary response body
* Bug fix: The default exponential backoff BackoffPlugin was not giving when the request threshold was exceeded
* Bug fix: Guzzle now takes the first found value when grabbing Cache-Control directives

3.1.2 (2013-01-27)
------------------

* Refactored how operation responses are parsed. Visitors now include a before() method responsible for parsing the
  response body. For example, the XmlVisitor now parses the XML response into an array in the before() method.
* Fixed an issue where cURL would not automatically decompress responses when the Accept-Encoding header was sent
* CURLOPT_SSL_VERIFYHOST is never set to 1 because it is deprecated (see 5e0ff2ef20f839e19d1eeb298f90ba3598784444)
* Fixed a bug where redirect responses were not chained correctly using getPreviousResponse()
* Setting default headers on a client after setting the user-agent will not erase the user-agent setting

3.1.1 (2013-01-20)
------------------

* Adding wildcard support to Guzzle\Common\Collection::getPath()
* Adding alias support to ServiceBuilder configs
* Adding Guzzle\Service\Resource\CompositeResourceIteratorFactory and cleaning up factory interface

3.1.0 (2013-01-12)
------------------

* BC: CurlException now extends from RequestException rather than BadResponseException
* BC: Renamed Guzzle\Plugin\Cache\CanCacheStrategyInterface::canCache() to canCacheRequest() and added CanCacheResponse()
* Added getData to ServiceDescriptionInterface
* Added context array to RequestInterface::setState()
* Bug: Removing hard dependency on the BackoffPlugin from Guzzle\Http
* Bug: Adding required content-type when JSON request visitor adds JSON to a command
* Bug: Fixing the serialization of a service description with custom data
* Made it easier to deal with exceptions thrown when transferring commands or requests in parallel by providing
  an array of successful and failed responses
* Moved getPath from Guzzle\Service\Resource\Model to Guzzle\Common\Collection
* Added Guzzle\Http\IoEmittingEntityBody
* Moved command filtration from validators to location visitors
* Added `extends` attributes to service description parameters
* Added getModels to ServiceDescriptionInterface

3.0.7 (2012-12-19)
------------------

* Fixing phar detection when forcing a cacert to system if null or true
* Allowing filename to be passed to `Guzzle\Http\Message\Request::setResponseBody()`
* Cleaning up `Guzzle\Common\Collection::inject` method
* Adding a response_body location to service descriptions

3.0.6 (2012-12-09)
------------------

* CurlMulti performance improvements
* Adding setErrorResponses() to Operation
* composer.json tweaks

3.0.5 (2012-11-18)
------------------

* Bug: Fixing an infinite recursion bug caused from revalidating with the CachePlugin
* Bug: Response body can now be a string containing "0"
* Bug: Using Guzzle inside of a phar uses system by default but now allows for a custom cacert
* Bug: QueryString::fromString now properly parses query string parameters that contain equal signs
* Added support for XML attributes in service description responses
* DefaultRequestSerializer now supports array URI parameter values for URI template expansion
* Added better mimetype guessing to requests and post files

3.0.4 (2012-11-11)
------------------

* Bug: Fixed a bug when adding multiple cookies to a request to use the correct glue value
* Bug: Cookies can now be added that have a name, domain, or value set to "0"
* Bug: Using the system cacert bundle when using the Phar
* Added json and xml methods to Response to make it easier to parse JSON and XML response data into data structures
* Enhanced cookie jar de-duplication
* Added the ability to enable strict cookie jars that throw exceptions when invalid cookies are added
* Added setStream to StreamInterface to actually make it possible to implement custom rewind behavior for entity bodies
* Added the ability to create any sort of hash for a stream rather than just an MD5 hash

3.0.3 (2012-11-04)
------------------

* Implementing redirects in PHP rather than cURL
* Added PECL URI template extension and using as default parser if available
* Bug: Fixed Content-Length parsing of Response factory
* Adding rewind() method to entity bodies and streams. Allows for custom rewinding of non-repeatable streams.
* Adding ToArrayInterface throughout library
* Fixing OauthPlugin to create unique nonce values per request

3.0.2 (2012-10-25)
------------------

* Magic methods are enabled by default on clients
* Magic methods return the result of a command
* Service clients no longer require a base_url option in the factory
* Bug: Fixed an issue with URI templates where null template variables were being expanded

3.0.1 (2012-10-22)
------------------

* Models can now be used like regular collection objects by calling filter, map, etc
* Models no longer require a Parameter structure or initial data in the constructor
* Added a custom AppendIterator to get around a PHP bug with the `\AppendIterator`

3.0.0 (2012-10-15)
------------------

* Rewrote service description format to be based on Swagger
    * Now based on JSON schema
    * Added nested input structures and nested response models
    * Support for JSON and XML input and output models
    * Renamed `commands` to `operations`
    * Removed dot class notation
    * Removed custom types
* Broke the project into smaller top-level namespaces to be more component friendly
* Removed support for XML configs and descriptions. Use arrays or JSON files.
* Removed the Validation component and Inspector
* Moved all cookie code to Guzzle\Plugin\Cookie
* Magic methods on a Guzzle\Service\Client now return the command un-executed.
* Calling getResult() or getResponse() on a command will lazily execute the command if needed.
* Now shipping with cURL's CA certs and using it by default
* Added previousResponse() method to response objects
* No longer sending Accept and Accept-Encoding headers on every request
* Only sending an Expect header by default when a payload is greater than 1MB
* Added/moved client options:
    * curl.blacklist to curl.option.blacklist
    * Added ssl.certificate_authority
* Added a Guzzle\Iterator component
* Moved plugins from Guzzle\Http\Plugin to Guzzle\Plugin
* Added a more robust backoff retry strategy (replaced the ExponentialBackoffPlugin)
* Added a more robust caching plugin
* Added setBody to response objects
* Updating LogPlugin to use a more flexible MessageFormatter
* Added a completely revamped build process
* Cleaning up Collection class and removing default values from the get method
* Fixed ZF2 cache adapters

2.8.8 (2012-10-15)
------------------

* Bug: Fixed a cookie issue that caused dot prefixed domains to not match where popular browsers did

2.8.7 (2012-09-30)
------------------

* Bug: Fixed config file aliases for JSON includes
* Bug: Fixed cookie bug on a request object by using CookieParser to parse cookies on requests
* Bug: Removing the path to a file when sending a Content-Disposition header on a POST upload
* Bug: Hardening request and response parsing to account for missing parts
* Bug: Fixed PEAR packaging
* Bug: Fixed Request::getInfo
* Bug: Fixed cases where CURLM_CALL_MULTI_PERFORM return codes were causing curl transactions to fail
* Adding the ability for the namespace Iterator factory to look in multiple directories
* Added more getters/setters/removers from service descriptions
* Added the ability to remove POST fields from OAuth signatures
* OAuth plugin now supports 2-legged OAuth

2.8.6 (2012-09-05)
------------------

* Added the ability to modify and build service descriptions
* Added the use of visitors to apply parameters to locations in service descriptions using the dynamic command
* Added a `json` parameter location
* Now allowing dot notation for classes in the CacheAdapterFactory
* Using the union of two arrays rather than an array_merge when extending service builder services and service params
* Ensuring that a service is a string before doing strpos() checks on it when substituting services for references
  in service builder config files.
* Services defined in two different config files that include one another will by default replace the previously
  defined service, but you can now create services that extend themselves and merge their settings over the previous
* The JsonLoader now supports aliasing filenames with different filenames. This allows you to alias something like
  '_default' with a default JSON configuration file.

2.8.5 (2012-08-29)
------------------

* Bug: Suppressed empty arrays from URI templates
* Bug: Added the missing $options argument from ServiceDescription::factory to enable caching
* Added support for HTTP responses that do not contain a reason phrase in the start-line
* AbstractCommand commands are now invokable
* Added a way to get the data used when signing an Oauth request before a request is sent

2.8.4 (2012-08-15)
------------------

* Bug: Custom delay time calculations are no longer ignored in the ExponentialBackoffPlugin
* Added the ability to transfer entity bodies as a string rather than streamed. This gets around curl error 65. Set `body_as_string` in a request's curl options to enable.
* Added a StreamInterface, EntityBodyInterface, and added ftell() to Guzzle\Common\Stream
* Added an AbstractEntityBodyDecorator and a ReadLimitEntityBody decorator to transfer only a subset of a decorated stream
* Stream and EntityBody objects will now return the file position to the previous position after a read required operation (e.g. getContentMd5())
* Added additional response status codes
* Removed SSL information from the default User-Agent header
* DELETE requests can now send an entity body
* Added an EventDispatcher to the ExponentialBackoffPlugin and added an ExponentialBackoffLogger to log backoff retries
* Added the ability of the MockPlugin to consume mocked request bodies
* LogPlugin now exposes request and response objects in the extras array

2.8.3 (2012-07-30)
------------------

* Bug: Fixed a case where empty POST requests were sent as GET requests
* Bug: Fixed a bug in ExponentialBackoffPlugin that caused fatal errors when retrying an EntityEnclosingRequest that does not have a body
* Bug: Setting the response body of a request to null after completing a request, not when setting the state of a request to new
* Added multiple inheritance to service description commands
* Added an ApiCommandInterface and added ``getParamNames()`` and ``hasParam()``
* Removed the default 2mb size cutoff from the Md5ValidatorPlugin so that it now defaults to validating everything
* Changed CurlMulti::perform to pass a smaller timeout to CurlMulti::executeHandles

2.8.2 (2012-07-24)
------------------

* Bug: Query string values set to 0 are no longer dropped from the query string
* Bug: A Collection object is no longer created each time a call is made to ``Guzzle\Service\Command\AbstractCommand::getRequestHeaders()``
* Bug: ``+`` is now treated as an encoded space when parsing query strings
* QueryString and Collection performance improvements
* Allowing dot notation for class paths in filters attribute of a service descriptions

2.8.1 (2012-07-16)
------------------

* Loosening Event Dispatcher dependency
* POST redirects can now be customized using CURLOPT_POSTREDIR

2.8.0 (2012-07-15)
------------------

* BC: Guzzle\Http\Query
    * Query strings with empty variables will always show an equal sign unless the variable is set to QueryString::BLANK (e.g. ?acl= vs ?acl)
    * Changed isEncodingValues() and isEncodingFields() to isUrlEncoding()
    * Changed setEncodeValues(bool) and setEncodeFields(bool) to useUrlEncoding(bool)
    * Changed the aggregation functions of QueryString to be static methods
    * Can now use fromString() with querystrings that have a leading ?
* cURL configuration values can be specified in service descriptions using ``curl.`` prefixed parameters
* Content-Length is set to 0 before emitting the request.before_send event when sending an empty request body
* Cookies are no longer URL decoded by default
* Bug: URI template variables set to null are no longer expanded

2.7.2 (2012-07-02)
------------------

* BC: Moving things to get ready for subtree splits. Moving Inflection into Common. Moving Guzzle\Http\Parser to Guzzle\Parser.
* BC: Removing Guzzle\Common\Batch\Batch::count() and replacing it with isEmpty()
* CachePlugin now allows for a custom request parameter function to check if a request can be cached
* Bug fix: CachePlugin now only caches GET and HEAD requests by default
* Bug fix: Using header glue when transferring headers over the wire
* Allowing deeply nested arrays for composite variables in URI templates
* Batch divisors can now return iterators or arrays

2.7.1 (2012-06-26)
------------------

* Minor patch to update version number in UA string
* Updating build process

2.7.0 (2012-06-25)
------------------

* BC: Inflection classes moved to Guzzle\Inflection. No longer static methods. Can now inject custom inflectors into classes.
* BC: Removed magic setX methods from commands
* BC: Magic methods mapped to service description commands are now inflected in the command factory rather than the client __call() method
* Verbose cURL options are no longer enabled by default. Set curl.debug to true on a client to enable.
* Bug: Now allowing colons in a response start-line (e.g. HTTP/1.1 503 Service Unavailable: Back-end server is at capacity)
* Guzzle\Service\Resource\ResourceIteratorApplyBatched now internally uses the Guzzle\Common\Batch namespace
* Added Guzzle\Service\Plugin namespace and a PluginCollectionPlugin
* Added the ability to set POST fields and files in a service description
* Guzzle\Http\EntityBody::factory() now accepts objects with a __toString() method
* Adding a command.before_prepare event to clients
* Added BatchClosureTransfer and BatchClosureDivisor
* BatchTransferException now includes references to the batch divisor and transfer strategies
* Fixed some tests so that they pass more reliably
* Added Guzzle\Common\Log\ArrayLogAdapter

2.6.6 (2012-06-10)
------------------

* BC: Removing Guzzle\Http\Plugin\BatchQueuePlugin
* BC: Removing Guzzle\Service\Command\CommandSet
* Adding generic batching system (replaces the batch queue plugin and command set)
* Updating ZF cache and log adapters and now using ZF's composer repository
* Bug: Setting the name of each ApiParam when creating through an ApiCommand
* Adding result_type, result_doc, deprecated, and doc_url to service descriptions
* Bug: Changed the default cookie header casing back to 'Cookie'

2.6.5 (2012-06-03)
------------------

* BC: Renaming Guzzle\Http\Message\RequestInterface::getResourceUri() to getResource()
* BC: Removing unused AUTH_BASIC and AUTH_DIGEST constants from
* BC: Guzzle\Http\Cookie is now used to manage Set-Cookie data, not Cookie data
* BC: Renaming methods in the CookieJarInterface
* Moving almost all cookie logic out of the CookiePlugin and into the Cookie or CookieJar implementations
* Making the default glue for HTTP headers ';' instead of ','
* Adding a removeValue to Guzzle\Http\Message\Header
* Adding getCookies() to request interface.
* Making it easier to add event subscribers to HasDispatcherInterface classes. Can now directly call addSubscriber()

2.6.4 (2012-05-30)
------------------

* BC: Cleaning up how POST files are stored in EntityEnclosingRequest objects. Adding PostFile class.
* BC: Moving ApiCommand specific functionality from the Inspector and on to the ApiCommand
* Bug: Fixing magic method command calls on clients
* Bug: Email constraint only validates strings
* Bug: Aggregate POST fields when POST files are present in curl handle
* Bug: Fixing default User-Agent header
* Bug: Only appending or prepending parameters in commands if they are specified
* Bug: Not requiring response reason phrases or status codes to match a predefined list of codes
* Allowing the use of dot notation for class namespaces when using instance_of constraint
* Added any_match validation constraint
* Added an AsyncPlugin
* Passing request object to the calculateWait method of the ExponentialBackoffPlugin
* Allowing the result of a command object to be changed
* Parsing location and type sub values when instantiating a service description rather than over and over at runtime

2.6.3 (2012-05-23)
------------------

* [BC] Guzzle\Common\FromConfigInterface no longer requires any config options.
* [BC] Refactoring how POST files are stored on an EntityEnclosingRequest. They are now separate from POST fields.
* You can now use an array of data when creating PUT request bodies in the request factory.
* Removing the requirement that HTTPS requests needed a Cache-Control: public directive to be cacheable.
* [Http] Adding support for Content-Type in multipart POST uploads per upload
* [Http] Added support for uploading multiple files using the same name (foo[0], foo[1])
* Adding more POST data operations for easier manipulation of POST data.
* You can now set empty POST fields.
* The body of a request is only shown on EntityEnclosingRequest objects that do not use POST files.
* Split the Guzzle\Service\Inspector::validateConfig method into two methods. One to initialize when a command is created, and one to validate.
* CS updates

2.6.2 (2012-05-19)
------------------

* [Http] Better handling of nested scope requests in CurlMulti.  Requests are now always prepares in the send() method rather than the addRequest() method.

2.6.1 (2012-05-19)
------------------

* [BC] Removing 'path' support in service descriptions.  Use 'uri'.
* [BC] Guzzle\Service\Inspector::parseDocBlock is now protected. Adding getApiParamsForClass() with cache.
* [BC] Removing Guzzle\Common\NullObject.  Use https://github.com/mtdowling/NullObject if you need it.
* [BC] Removing Guzzle\Common\XmlElement.
* All commands, both dynamic and concrete, have ApiCommand objects.
* Adding a fix for CurlMulti so that if all of the connections encounter some sort of curl error, then the loop exits.
* Adding checks to EntityEnclosingRequest so that empty POST files and fields are ignored.
* Making the method signature of Guzzle\Service\Builder\ServiceBuilder::factory more flexible.

2.6.0 (2012-05-15)
------------------

* [BC] Moving Guzzle\Service\Builder to Guzzle\Service\Builder\ServiceBuilder
* [BC] Executing a Command returns the result of the command rather than the command
* [BC] Moving all HTTP parsing logic to Guzzle\Http\Parsers. Allows for faster C implementations if needed.
* [BC] Changing the Guzzle\Http\Message\Response::setProtocol() method to accept a protocol and version in separate args.
* [BC] Moving ResourceIterator* to Guzzle\Service\Resource
* [BC] Completely refactored ResourceIterators to iterate over a cloned command object
* [BC] Moved Guzzle\Http\UriTemplate to Guzzle\Http\Parser\UriTemplate\UriTemplate
* [BC] Guzzle\Guzzle is now deprecated
* Moving Guzzle\Common\Guzzle::inject to Guzzle\Common\Collection::inject
* Adding Guzzle\Version class to give version information about Guzzle
* Adding Guzzle\Http\Utils class to provide getDefaultUserAgent() and getHttpDate()
* Adding Guzzle\Curl\CurlVersion to manage caching curl_version() data
* ServiceDescription and ServiceBuilder are now cacheable using similar configs
* Changing the format of XML and JSON service builder configs.  Backwards compatible.
* Cleaned up Cookie parsing
* Trimming the default Guzzle User-Agent header
* Adding a setOnComplete() method to Commands that is called when a command completes
* Keeping track of requests that were mocked in the MockPlugin
* Fixed a caching bug in the CacheAdapterFactory
* Inspector objects can be injected into a Command object
* Refactoring a lot of code and tests to be case insensitive when dealing with headers
* Adding Guzzle\Http\Message\HeaderComparison for easy comparison of HTTP headers using a DSL
* Adding the ability to set global option overrides to service builder configs
* Adding the ability to include other service builder config files from within XML and JSON files
* Moving the parseQuery method out of Url and on to QueryString::fromString() as a static factory method.

2.5.0 (2012-05-08)
------------------

* Major performance improvements
* [BC] Simplifying Guzzle\Common\Collection.  Please check to see if you are using features that are now deprecated.
* [BC] Using a custom validation system that allows a flyweight implementation for much faster validation. No longer using Symfony2 Validation component.
* [BC] No longer supporting "{{ }}" for injecting into command or UriTemplates.  Use "{}"
* Added the ability to passed parameters to all requests created by a client
* Added callback functionality to the ExponentialBackoffPlugin
* Using microtime in ExponentialBackoffPlugin to allow more granular backoff strategies.
* Rewinding request stream bodies when retrying requests
* Exception is thrown when JSON response body cannot be decoded
* Added configurable magic method calls to clients and commands.  This is off by default.
* Fixed a defect that added a hash to every parsed URL part
* Fixed duplicate none generation for OauthPlugin.
* Emitting an event each time a client is generated by a ServiceBuilder
* Using an ApiParams object instead of a Collection for parameters of an ApiCommand
* cache.* request parameters should be renamed to params.cache.*
* Added the ability to set arbitrary curl options on requests (disable_wire, progress, etc). See CurlHandle.
* Added the ability to disable type validation of service descriptions
* ServiceDescriptions and ServiceBuilders are now Serializable

Guzzle, PHP HTTP client and webservice framework
================================================

Guzzle is a PHP HTTP client and framework for building RESTful web service clients.

- Extremely powerful API provides all the power of cURL with a simple interface.
- Truly take advantage of HTTP/1.1 with persistent connections, connection pooling, and parallel requests.
- Service description DSL allows you build awesome web service clients faster.
- Symfony2 event-based plugin system allows you to completely modify the behavior of a request.
- Includes a custom node.js webserver to test your clients.
- Unit-tested with PHPUnit with 100% code coverage.

Getting started
---------------

- [Download the phar](http://guzzlephp.org/guzzle.phar) and include it in your project ([minimal phar](http://guzzlephp.org/guzzle-min.phar))
- Docs: [www.guzzlephp.org](http://www.guzzlephp.org/)
- Forum: https://groups.google.com/forum/?hl=en#!forum/guzzle
- IRC: [#guzzlephp](irc://irc.freenode.net/#guzzlephp) channel on irc.freenode.net

### Installing via Composer

The recommended way to install Guzzle is through [Composer](http://getcomposer.org).

1. Add ``guzzle/guzzle`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/guzzle": "~3.1"
            }
        }

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

Features
--------

- Supports GET, HEAD, POST, DELETE, PUT, PATCH, OPTIONS, and any custom verbs
- Allows full access to request and response headers
- Persistent connections are implicitly managed by Guzzle, resulting in huge performance benefits
- [Send requests in parallel](http://guzzlephp.org/tour/http.html#send-http-requests-in-parallel)
- Cookie sessions can be maintained between requests using the [CookiePlugin](http://guzzlephp.org/tour/http.html#cookie-session-plugin)
- Allows custom [entity bodies](http://guzzlephp.org/tour/http.html#entity-bodies), including sending data from a PHP stream and downloading data to a PHP stream
- Responses can be cached and served from cache using the [caching forward proxy plugin](http://guzzlephp.org/tour/http.html#php-based-caching-forward-proxy)
- Failed requests can be retried using [truncated exponential backoff](http://guzzlephp.org/tour/http.html#truncated-exponential-backoff) with custom retry policies
- Entity bodies can be validated automatically using Content-MD5 headers and the [MD5 hash validator plugin](http://guzzlephp.org/tour/http.html#md5-hash-validator-plugin)
- All data sent over the wire can be logged using the [LogPlugin](http://guzzlephp.org/tour/http.html#over-the-wire-logging)
- Subject/Observer signal slot system for unobtrusively [modifying request behavior](http://guzzlephp.org/guide/http/creating_plugins.html)
- Supports all of the features of libcurl including authentication, compression, redirects, SSL, proxies, etc
- Web service client framework for building future-proof interfaces to web services
- Includes a [service description DSL](http://guzzlephp.org/guide/service/service_descriptions.html) for quickly building webservice clients
- Full support for [URI templates](http://tools.ietf.org/html/rfc6570)
- Advanced batching functionality to efficiently send requests or commands in parallel with customizable batch sizes and transfer strategies

HTTP basics
-----------

```php
<?php

use Guzzle\Http\Client;

$client = new Client('http://www.example.com/api/v1/key/{{key}}', array(
    'key' => '***'
));

// Issue a path using a relative URL to the client's base URL
// Sends to http://www.example.com/api/v1/key/***/users
$request = $client->get('users');
$response = $request->send();

// Relative URL that overwrites the path of the base URL
$request = $client->get('/test/123.php?a=b');

// Issue a head request on the base URL
$response = $client->head()->send();
// Delete user 123
$response = $client->delete('users/123')->send();

// Send a PUT request with custom headers
$response = $client->put('upload/text', array(
    'X-Header' => 'My Header'
), 'body of the request')->send();

// Send a PUT request using the contents of a PHP stream as the body
// Send using an absolute URL (overrides the base URL)
$response = $client->put('http://www.example.com/upload', array(
    'X-Header' => 'My Header'
), fopen('http://www.test.com/', 'r'));

// Create a POST request with a file upload (notice the @ symbol):
$request = $client->post('http://localhost:8983/solr/update', null, array (
    'custom_field' => 'my value',
    'file' => '@/path/to/documents.xml'
));

// Create a POST request and add the POST files manually
$request = $client->post('http://localhost:8983/solr/update')
    ->addPostFiles(array(
        'file' => '/path/to/documents.xml'
    ));

// Responses are objects
echo $response->getStatusCode() . ' ' . $response->getReasonPhrase() . "\n";

// Requests and responses can be cast to a string to show the raw HTTP message
echo $request . "\n\n" . $response;

// Create a request based on an HTTP message
$request = RequestFactory::fromMessage(
    "PUT / HTTP/1.1\r\n" .
    "Host: test.com:8081\r\n" .
    "Content-Type: text/plain" .
    "Transfer-Encoding: chunked\r\n" .
    "\r\n" .
    "this is the body"
);
```

Send requests in parallel
-------------------------

```php
<?php

try {
    $client = new Guzzle\Http\Client('http://www.myapi.com/api/v1');
    $responses = $client->send(array(
        $client->get('users'),
        $client->head('messages/123'),
        $client->delete('orders/123')
    ));
} catch (Guzzle\Common\Exception\ExceptionCollection $e) {
    echo "The following requests encountered an exception: \n";
    foreach ($e as $exception) {
        echo $exception->getRequest() . "\n" . $exception->getMessage() . "\n";
    }
}
```

URI templates
-------------

Guzzle supports the entire [URI templates RFC](http://tools.ietf.org/html/rfc6570).

```php
<?php

$client = new Guzzle\Http\Client('http://www.myapi.com/api/v1', array(
    'path' => '/path/to',
    'a'    => 'hi',
    'data' => array(
        'foo'  => 'bar',
        'mesa' => 'jarjar'
    )
));

$request = $client->get('http://www.test.com{+path}{?a,data*}');
```

The generated request URL would become: ``http://www.test.com/path/to?a=hi&foo=bar&mesa=jarajar``

You can specify URI templates and an array of additional template variables to use when creating requests:

```php
<?php

$client = new Guzzle\Http\Client('http://test.com', array(
    'a' => 'hi'
));

$request = $client->get(array('/{?a,b}', array(
    'b' => 'there'
));
```

The resulting URL would become ``http://test.com/?a=hi&b=there``

Unit testing
------------

[![Build Status](https://secure.travis-ci.org/guzzle/guzzle.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Guzzle uses PHPUnit for unit testing. In order to run the unit tests, you'll first need
to install the dependencies of the project using Composer: `php composer.phar install --dev`.
You can then run the tests using `vendor/bin/phpunit` or `phing test` (if you have phing installed).

Guzzle Iterator
===============

[![Build Status](https://secure.travis-ci.org/guzzle/iterator.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Component library that provides useful Iterators and Iterator decorators

- ChunkedIterator: Pulls out chunks from an inner iterator and yields the chunks as arrays
- FilterIterator: Used when PHP 5.4's CallbackFilterIterator is not available
- MapIterator: Maps values before yielding
- MethodProxyIterator: Proxies missing method calls to the innermost iterator

### Installing via Composer

The recommended way to install is through [Composer](http://getcomposer.org).

1. Add ``guzzle/iterator`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/iterator": "*"
            }
        }

    Consider tightening your dependencies to a known version when deploying mission critical applications (e.g. ``2.7.*``).

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

<?php

namespace Guzzle\Service\Command\Factory;

use Guzzle\Service\Description\ServiceDescriptionInterface;
use Guzzle\Inflection\InflectorInterface;

/**
 * Command factory used to create commands based on service descriptions
 */
class ServiceDescriptionFactory implements FactoryInterface
{
    /**
     * @var ServiceDescriptionInterface
     */
    protected $description;

    /**
     * @var InflectorInterface
     */
    protected $inflector;

    /**
     * @param ServiceDescriptionInterface $description Service description
     * @param InflectorInterface          $inflector   Optional inflector to use if the command is not at first found
     */
    public function __construct(ServiceDescriptionInterface $description, InflectorInterface $inflector = null)
    {
        $this->setServiceDescription($description);
        $this->inflector = $inflector;
    }

    /**
     * Change the service description used with the factory
     *
     * @param ServiceDescriptionInterface $description Service description to use
     *
     * @return FactoryInterface
     */
    public function setServiceDescription(ServiceDescriptionInterface $description)
    {
        $this->description = $description;

        return $this;
    }

    /**
     * Returns the service description
     *
     * @return ServiceDescriptionInterface
     */
    public function getServiceDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function factory($name, array $args = array())
    {
        $command = $this->description->getOperation($name);

        // If an inflector was passed, then attempt to get the command using snake_case inflection
        if (!$command && $this->inflector) {
            $command = $this->description->getOperation($this->inflector->snake($name));
        }

        if ($command) {
            $class = $command->getClass();
            return new $class($args, $command, $this->description);
        }
    }
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Common\Exception\InvalidArgumentException;

/**
 * A ServiceDescription stores service information based on a service document
 */
class ServiceDescription implements ServiceDescriptionInterface
{
    /**
     * @var array Array of {@see OperationInterface} objects
     */
    protected $operations = array();

    /**
     * @var array Array of API models
     */
    protected $models = array();

    /**
     * @var string Name of the API
     */
    protected $name;

    /**
     * @var string API version
     */
    protected $apiVersion;

    /**
     * @var string Summary of the API
     */
    protected $description;

    /**
     * @var array Any extra API data
     */
    protected $extraData = array();

    /**
     * @var ServiceDescriptionLoader Factory used in factory method
     */
    protected static $descriptionLoader;

    /**
     * @var string baseUrl/basePath
     */
    protected $baseUrl;

    /**
     * {@inheritdoc}
     * @param string|array $config  File to build or array of operation information
     * @param array        $options Service description factory options
     *
     * @return self
     */
    public static function factory($config, array $options = array())
    {
        // @codeCoverageIgnoreStart
        if (!self::$descriptionLoader) {
            self::$descriptionLoader = new ServiceDescriptionLoader();
        }
        // @codeCoverageIgnoreEnd

        return self::$descriptionLoader->load($config, $options);
    }

    /**
     * Create a new ServiceDescription
     *
     * @param array $config Array of configuration data
     */
    public function __construct(array $config = array())
    {
        $this->fromArray($config);
    }

    /**
     * Serialize the service description
     *
     * @return string
     */
    public function serialize()
    {
        $result = array(
            'name'        => $this->name,
            'apiVersion'  => $this->apiVersion,
            'baseUrl'     => $this->baseUrl,
            'description' => $this->description
        ) + $this->extraData;
        $result['operations'] = array();
        foreach ($this->getOperations() as $name => $operation) {
            $result['operations'][$operation->getName() ?: $name] = $operation->toArray();
        }
        if (!empty($this->models)) {
            $result['models'] = array();
            foreach ($this->models as $id => $model) {
                $result['models'][$id] = $model instanceof Parameter ? $model->toArray(): $model;
            }
        }

        return json_encode(array_filter($result));
    }

    /**
     * Unserialize the service description
     *
     * @param string|array $json JSON data
     */
    public function unserialize($json)
    {
        $this->operations = array();
        $this->fromArray(json_decode($json, true));
    }

    /**
     * {@inheritdoc}
     */
    public function getBaseUrl()
    {
        return $this->baseUrl;
    }

    /**
     * Set the baseUrl of the description
     *
     * @param string $baseUrl Base URL of each operation
     *
     * @return self
     */
    public function setBaseUrl($baseUrl)
    {
        $this->baseUrl = $baseUrl;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getOperations()
    {
        foreach (array_keys($this->operations) as $name) {
            $this->getOperation($name);
        }

        return $this->operations;
    }

    /**
     * {@inheritdoc}
     */
    public function hasOperation($name)
    {
        return isset($this->operations[$name]);
    }

    /**
     * {@inheritdoc}
     */
    public function getOperation($name)
    {
        // Lazily retrieve and build operations
        if (!isset($this->operations[$name])) {
            return null;
        }

        if (!($this->operations[$name] instanceof Operation)) {
            $this->operations[$name] = new Operation($this->operations[$name], $this);
        }

        return $this->operations[$name];
    }

    /**
     * Add a operation to the service description
     *
     * @param OperationInterface $operation Operation to add
     *
     * @return self
     */
    public function addOperation(OperationInterface $operation)
    {
        $this->operations[$operation->getName()] = $operation->setServiceDescription($this);

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getModel($id)
    {
        if (!isset($this->models[$id])) {
            return null;
        }

        if (!($this->models[$id] instanceof Parameter)) {
            $this->models[$id] = new Parameter($this->models[$id], $this);
        }

        return $this->models[$id];
    }

    /**
     * {@inheritdoc}
     */
    public function getModels()
    {
        // Ensure all models are converted into parameter objects
        foreach (array_keys($this->models) as $id) {
            $this->getModel($id);
        }

        return $this->models;
    }

    /**
     * {@inheritdoc}
     */
    public function hasModel($id)
    {
        return isset($this->models[$id]);
    }

    /**
     * Add a model to the service description
     *
     * @param Parameter $model Model to add
     *
     * @return self
     */
    public function addModel(Parameter $model)
    {
        $this->models[$model->getName()] = $model;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getApiVersion()
    {
        return $this->apiVersion;
    }

    /**
     * {@inheritdoc}
     */
    public function getName()
    {
        return $this->name;
    }

    /**
     * {@inheritdoc}
     */
    public function getDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function getData($key)
    {
        return isset($this->extraData[$key]) ? $this->extraData[$key] : null;
    }

    /**
     * {@inheritdoc}
     */
    public function setData($key, $value)
    {
        $this->extraData[$key] = $value;

        return $this;
    }

    /**
     * Initialize the state from an array
     *
     * @param array $config Configuration data
     * @throws InvalidArgumentException
     */
    protected function fromArray(array $config)
    {
        // Keep a list of default keys used in service descriptions that is later used to determine extra data keys
        $defaultKeys = array('name', 'models', 'apiVersion', 'baseUrl', 'description');
        // Pull in the default configuration values
        foreach ($defaultKeys as $key) {
            if (isset($config[$key])) {
                $this->{$key} = $config[$key];
            }
        }

        // Account for the Swagger name for Guzzle's baseUrl
        if (isset($config['basePath'])) {
            $this->baseUrl = $config['basePath'];
        }

        // Ensure that the models and operations properties are always arrays
        $this->models = (array) $this->models;
        $this->operations = (array) $this->operations;

        // We want to add operations differently than adding the other properties
        $defaultKeys[] = 'operations';

        // Create operations for each operation
        if (isset($config['operations'])) {
            foreach ($config['operations'] as $name => $operation) {
                if (!($operation instanceof Operation) && !is_array($operation)) {
                    throw new InvalidArgumentException('Invalid operation in service description: '
                        . gettype($operation));
                }
                $this->operations[$name] = $operation;
            }
        }

        // Get all of the additional properties of the service description and store them in a data array
        foreach (array_diff(array_keys($config), $defaultKeys) as $key) {
            $this->extraData[$key] = $config[$key];
        }
    }
}

<?php

namespace Guzzle\Service\Description;

/**
 * A ServiceDescription stores service information based on a service document
 */
interface ServiceDescriptionInterface extends \Serializable
{
    /**
     * Get the basePath/baseUrl of the description
     *
     * @return string
     */
    public function getBaseUrl();

    /**
     * Get the API operations of the service
     *
     * @return array Returns an array of {@see OperationInterface} objects
     */
    public function getOperations();

    /**
     * Check if the service has an operation by name
     *
     * @param string $name Name of the operation to check
     *
     * @return bool
     */
    public function hasOperation($name);

    /**
     * Get an API operation by name
     *
     * @param string $name Name of the command
     *
     * @return OperationInterface|null
     */
    public function getOperation($name);

    /**
     * Get a specific model from the description
     *
     * @param string $id ID of the model
     *
     * @return Parameter|null
     */
    public function getModel($id);

    /**
     * Get all service description models
     *
     * @return array
     */
    public function getModels();

    /**
     * Check if the description has a specific model by name
     *
     * @param string $id ID of the model
     *
     * @return bool
     */
    public function hasModel($id);

    /**
     * Get the API version of the service
     *
     * @return string
     */
    public function getApiVersion();

    /**
     * Get the name of the API
     *
     * @return string
     */
    public function getName();

    /**
     * Get a summary of the purpose of the API
     *
     * @return string
     */
    public function getDescription();

    /**
     * Get arbitrary data from the service description that is not part of the Guzzle spec
     *
     * @param string $key Data key to retrieve
     *
     * @return null|mixed
     */
    public function getData($key);

    /**
     * Set arbitrary data on the service description
     *
     * @param string $key   Data key to set
     * @param mixed  $value Value to set
     *
     * @return self
     */
    public function setData($key, $value);
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Service\AbstractConfigLoader;
use Guzzle\Service\Exception\DescriptionBuilderException;

/**
 * Loader for service descriptions
 */
class ServiceDescriptionLoader extends AbstractConfigLoader
{
    /**
     * {@inheritdoc}
     */
    protected function build($config, array $options)
    {
        $operations = array();
        if (!empty($config['operations'])) {
            foreach ($config['operations'] as $name => $op) {
                $name = $op['name'] = isset($op['name']) ? $op['name'] : $name;
                // Extend other operations
                if (!empty($op['extends'])) {
                    $this->resolveExtension($name, $op, $operations);
                }
                $op['parameters'] = isset($op['parameters']) ? $op['parameters'] : array();
                $operations[$name] = $op;
            }
        }

        return new ServiceDescription(array(
            'apiVersion'  => isset($config['apiVersion']) ? $config['apiVersion'] : null,
            'baseUrl'     => isset($config['baseUrl']) ? $config['baseUrl'] : null,
            'description' => isset($config['description']) ? $config['description'] : null,
            'operations'  => $operations,
            'models'      => isset($config['models']) ? $config['models'] : null
        ) + $config);
    }

    /**
     * @param string $name       Name of the operation
     * @param array  $op         Operation value array
     * @param array  $operations Currently loaded operations
     * @throws DescriptionBuilderException when extending a non-existent operation
     */
    protected function resolveExtension($name, array &$op, array &$operations)
    {
        $resolved = array();
        $original = empty($op['parameters']) ? false: $op['parameters'];
        $hasClass = !empty($op['class']);
        foreach ((array) $op['extends'] as $extendedCommand) {
            if (empty($operations[$extendedCommand])) {
                throw new DescriptionBuilderException("{$name} extends missing operation {$extendedCommand}");
            }
            $toArray = $operations[$extendedCommand];
            $resolved = empty($resolved)
                ? $toArray['parameters']
                : array_merge($resolved, $toArray['parameters']);

            $op = $op + $toArray;
            if (!$hasClass && isset($toArray['class'])) {
                $op['class'] = $toArray['class'];
            }
        }
        $op['parameters'] = $original ? array_merge($resolved, $original) : $resolved;
    }
}

<?php

namespace Guzzle\Service\Exception;

use Guzzle\Common\Exception\RuntimeException;

class DescriptionBuilderException extends RuntimeException {}

<?php

namespace Guzzle\Tests\Service\Command;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Command\Factory\ServiceDescriptionFactory;
use Guzzle\Inflection\Inflector;

/**
 * @covers Guzzle\Service\Command\Factory\ServiceDescriptionFactory
 */
class ServiceDescriptionFactoryTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testProvider()
    {
        return array(
            array('foo', null),
            array('jar_jar', 'Guzzle\Tests\Service\Mock\Command\MockCommand'),
            array('binks', 'Guzzle\Tests\Service\Mock\Command\OtherCommand')
        );
    }

    /**
     * @dataProvider testProvider
     */
    public function testCreatesCommandsUsingServiceDescriptions($key, $result)
    {
        $d = $this->getDescription();

        $factory = new ServiceDescriptionFactory($d);
        $this->assertSame($d, $factory->getServiceDescription());

        if (is_null($result)) {
            $this->assertNull($factory->factory($key));
        } else {
            $this->assertInstanceof($result, $factory->factory($key));
        }
    }

    public function testUsesInflectionIfNoExactMatch()
    {
        $d = $this->getDescription();
        $factory = new ServiceDescriptionFactory($d, new Inflector());
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('Binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('JarJar'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('jar_jar'));
    }

    protected function getDescription()
    {
        return ServiceDescription::factory(array(
            'operations' => array(
                'jar_jar' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\MockCommand'
                ),
                'binks' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\OtherCommand'
                )
            )
        ));
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\ServiceDescriptionLoader;

/**
 * @covers Guzzle\Service\Description\ServiceDescriptionLoader
 */
class ServiceDescriptionLoaderTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testAllowsExtraData()
    {
        $d = ServiceDescription::factory(array(
            'foo' => true,
            'baz' => array('bar'),
            'apiVersion' => '123',
            'operations' => array()
        ));

        $this->assertEquals(true, $d->getData('foo'));
        $this->assertEquals(array('bar'), $d->getData('baz'));
        $this->assertEquals('123', $d->getApiVersion());
    }

    public function testAllowsDeepNestedInheritance()
    {
        $d = ServiceDescription::factory(array(
            'operations' => array(
                'abstract' => array(
                    'httpMethod' => 'HEAD',
                    'parameters' => array(
                        'test' => array('type' => 'string', 'required' => true)
                    )
                ),
                'abstract2' => array('uri' => '/test', 'extends' => 'abstract'),
                'concrete'  => array('extends' => 'abstract2'),
                'override'  => array('extends' => 'abstract', 'httpMethod' => 'PUT'),
                'override2'  => array('extends' => 'override', 'httpMethod' => 'POST', 'uri' => '/')
            )
        ));

        $c = $d->getOperation('concrete');
        $this->assertEquals('/test', $c->getUri());
        $this->assertEquals('HEAD', $c->getHttpMethod());
        $params = $c->getParams();
        $param = $params['test'];
        $this->assertEquals('string', $param->getType());
        $this->assertTrue($param->getRequired());

        // Ensure that merging HTTP method does not make an array
        $this->assertEquals('PUT', $d->getOperation('override')->getHttpMethod());
        $this->assertEquals('POST', $d->getOperation('override2')->getHttpMethod());
        $this->assertEquals('/', $d->getOperation('override2')->getUri());
    }

    /**
     * @expectedException RuntimeException
     */
    public function testThrowsExceptionWhenExtendingMissingCommand()
    {
        ServiceDescription::factory(array(
            'operations' => array(
                'concrete' => array(
                    'extends' => 'missing'
                )
            )
        ));
    }

    public function testAllowsMultipleInheritance()
    {
        $description = ServiceDescription::factory(array(
            'operations' => array(
                'a' => array(
                    'httpMethod' => 'GET',
                    'parameters' => array(
                        'a1' => array(
                            'default'  => 'foo',
                            'required' => true,
                            'prepend'  => 'hi'
                        )
                    )
                ),
                'b' => array(
                    'extends' => 'a',
                    'parameters' => array(
                        'b2' => array()
                    )
                ),
                'c' => array(
                    'parameters' => array(
                        'a1' => array(
                            'default'     => 'bar',
                            'required'    => true,
                            'description' => 'test'
                        ),
                        'c3' => array()
                    )
                ),
                'd' => array(
                    'httpMethod' => 'DELETE',
                    'extends'    => array('b', 'c'),
                    'parameters' => array(
                        'test' => array()
                    )
                )
            )
        ));

        $command = $description->getOperation('d');
        $this->assertEquals('DELETE', $command->getHttpMethod());
        $this->assertContains('a1', $command->getParamNames());
        $this->assertContains('b2', $command->getParamNames());
        $this->assertContains('c3', $command->getParamNames());
        $this->assertContains('test', $command->getParamNames());

        $this->assertTrue($command->getParam('a1')->getRequired());
        $this->assertEquals('bar', $command->getParam('a1')->getDefault());
        $this->assertEquals('test', $command->getParam('a1')->getDescription());
    }

    public function testAddsOtherFields()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(),
            'description' => 'Foo',
            'apiVersion'  => 'bar'
        ));
        $this->assertEquals('Foo', $description->getDescription());
        $this->assertEquals('bar', $description->getApiVersion());
    }

    public function testCanLoadNestedExtends()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(
                'root' => array(
                    'class' => 'foo'
                ),
                'foo' => array(
                    'extends' => 'root',
                    'parameters' => array(
                        'baz' => array('type' => 'string')
                    )
                ),
                'foo_2' => array(
                    'extends' => 'foo',
                    'parameters' => array(
                        'bar' => array('type' => 'string')
                    )
                ),
                'foo_3' => array(
                    'class' => 'bar',
                    'parameters' => array(
                        'bar2' => array('type' => 'string')
                    )
                ),
                'foo_4' => array(
                    'extends' => array('foo_2', 'foo_3'),
                    'parameters' => array(
                        'bar3' => array('type' => 'string')
                    )
                )
            )
        ));

        $this->assertTrue($description->hasOperation('foo_4'));
        $foo4 = $description->getOperation('foo_4');
        $this->assertTrue($foo4->hasParam('baz'));
        $this->assertTrue($foo4->hasParam('bar'));
        $this->assertTrue($foo4->hasParam('bar2'));
        $this->assertTrue($foo4->hasParam('bar3'));
        $this->assertEquals('bar', $foo4->getClass());
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\Operation;
use Guzzle\Service\Description\Parameter;
use Guzzle\Service\Client;

/**
 * @covers Guzzle\Service\Description\ServiceDescription
 */
class ServiceDescriptionTest extends \Guzzle\Tests\GuzzleTestCase
{
    protected $serviceData;

    public function setup()
    {
        $this->serviceData = array(
            'test_command' => new Operation(array(
                'name'        => 'test_command',
                'description' => 'documentationForCommand',
                'httpMethod'  => 'DELETE',
                'class'       => 'Guzzle\\Tests\\Service\\Mock\\Command\\MockCommand',
                'parameters'  => array(
                    'bucket'  => array('required' => true),
                    'key'     => array('required' => true)
                )
            ))
        );
    }

    /**
     * @covers Guzzle\Service\Description\ServiceDescription::factory
     * @covers Guzzle\Service\Description\ServiceDescriptionLoader::build
     */
    public function testFactoryDelegatesToConcreteFactories()
    {
        $jsonFile = __DIR__ . '/../../TestData/test_service.json';
        $this->assertInstanceOf('Guzzle\Service\Description\ServiceDescription', ServiceDescription::factory($jsonFile));
    }

    public function testConstructor()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $this->assertEquals(1, count($service->getOperations()));
        $this->assertFalse($service->hasOperation('foobar'));
        $this->assertTrue($service->hasOperation('test_command'));
    }

    public function testIsSerializable()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $data = serialize($service);
        $d2 = unserialize($data);
        $this->assertEquals(serialize($service), serialize($d2));
    }

    public function testSerializesParameters()
    {
        $service = new ServiceDescription(array(
            'operations' => array(
                'foo' => new Operation(array('parameters' => array('foo' => array('type' => 'string'))))
            )
        ));
        $serialized = serialize($service);
        $this->assertContains('"parameters":{"foo":', $serialized);
        $service = unserialize($serialized);
        $this->assertTrue($service->getOperation('foo')->hasParam('foo'));
    }

    public function testAllowsForJsonBasedArrayParamsFunctionalTest()
    {
        $description = new ServiceDescription(array(
            'operations' => array(
                'test' => new Operation(array(
                    'httpMethod' => 'PUT',
                    'parameters' => array(
                        'data'   => array(
                            'required' => true,
                            'filters'  => 'json_encode',
                            'location' => 'body'
                        )
                    )
                ))
            )
        ));
        $client = new Client();
        $client->setDescription($description);
        $command = $client->getCommand('test', array(
            'data' => array(
                'foo' => 'bar'
            )
        ));

        $request = $command->prepare();
        $this->assertEquals('{"foo":"bar"}', (string) $request->getBody());
    }

    public function testContainsModels()
    {
        $d = new ServiceDescription(array(
            'operations' => array('foo' => array()),
            'models' => array(
                'Tag'    => array('type' => 'object'),
                'Person' => array('type' => 'object')
            )
        ));
        $this->assertTrue($d->hasModel('Tag'));
        $this->assertTrue($d->hasModel('Person'));
        $this->assertFalse($d->hasModel('Foo'));
        $this->assertInstanceOf('Guzzle\Service\Description\Parameter', $d->getModel('Tag'));
        $this->assertNull($d->getModel('Foo'));
        $this->assertContains('"models":{', serialize($d));
        $this->assertEquals(array('Tag', 'Person'), array_keys($d->getModels()));
    }

    public function testCanAddModels()
    {
        $d = new ServiceDescription(array());
        $this->assertFalse($d->hasModel('Foo'));
        $d->addModel(new Parameter(array('name' => 'Foo')));
        $this->assertTrue($d->hasModel('Foo'));
    }

    public function testHasAttributes()
    {
        $d = new ServiceDescription(array(
            'operations'  => array(),
            'name'        => 'Name',
            'description' => 'Description',
            'apiVersion'  => '1.24'
        ));

        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());

        $s = serialize($d);
        $this->assertContains('"name":"Name"', $s);
        $this->assertContains('"description":"Description"', $s);
        $this->assertContains('"apiVersion":"1.24"', $s);

        $d = unserialize($s);
        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());
    }

    public function testPersistsCustomAttributes()
    {
        $data = array(
            'operations'  => array('foo' => array('class' => 'foo', 'parameters' => array())),
            'name'        => 'Name',
            'description' => 'Test',
            'apiVersion'  => '1.24',
            'auth'        => 'foo',
            'keyParam'    => 'bar'
        );
        $d = new ServiceDescription($data);
        $d->setData('hello', 'baz');
        $this->assertEquals('foo', $d->getData('auth'));
        $this->assertEquals('baz', $d->getData('hello'));
        $this->assertEquals('bar', $d->getData('keyParam'));
        // responseClass and responseType are added by default
        $data['operations']['foo']['responseClass'] = 'array';
        $data['operations']['foo']['responseType'] = 'primitive';
        $this->assertEquals($data + array('hello' => 'baz'), json_decode($d->serialize(), true));
    }

    public function testReturnsNullWhenRetrievingMissingOperation()
    {
        $s = new ServiceDescription(array());
        $this->assertNull($s->getOperation('foo'));
    }

    public function testCanAddOperations()
    {
        $s = new ServiceDescription(array());
        $this->assertFalse($s->hasOperation('Foo'));
        $s->addOperation(new Operation(array('name' => 'Foo')));
        $this->assertTrue($s->hasOperation('Foo'));
    }

    /**
     * @expectedException Guzzle\Common\Exception\InvalidArgumentException
     */
    public function testValidatesOperationTypes()
    {
        $s = new ServiceDescription(array(
            'operations' => array('foo' => new \stdClass())
        ));
    }

    public function testHasBaseUrl()
    {
        $description = new ServiceDescription(array('baseUrl' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
        $description->setBaseUrl('http://foobar.com');
        $this->assertEquals('http://foobar.com', $description->getBaseUrl());
    }

    public function testCanUseBasePath()
    {
        $description = new ServiceDescription(array('basePath' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
    }
}

Guzzle Upgrade Guide
====================

3.2 to 3.3
----------

### Response::getEtag() quote stripping removed

`Guzzle\Http\Message\Response::getEtag()` no longer strips quotes around the ETag response header

### Removed `Guzzle\Http\Utils`

The `Guzzle\Http\Utils` class was removed. This class was only used for testing.

### Stream wrapper and type

`Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to lowercase.

### curl.emit_io became emit_io

Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using the
'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'

3.1 to 3.2
----------

### CurlMulti is no longer reused globally

Before 3.2, the same CurlMulti object was reused globally for each client. This can cause issue where plugins added
to a single client can pollute requests dispatched from other clients.

If you still wish to reuse the same CurlMulti object with each client, then you can add a listener to the
ServiceBuilder's `service_builder.create_client` event to inject a custom CurlMulti object into each client as it is
created.

```php
$multi = new Guzzle\Http\Curl\CurlMulti();
$builder = Guzzle\Service\Builder\ServiceBuilder::factory('/path/to/config.json');
$builder->addListener('service_builder.create_client', function ($event) use ($multi) {
    $event['client']->setCurlMulti($multi);
}
});
```

### No default path

URLs no longer have a default path value of '/' if no path was specified.

Before:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com/
```

After:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com
```

### Less verbose BadResponseException

The exception message for `Guzzle\Http\Exception\BadResponseException` no longer contains the full HTTP request and
response information. You can, however, get access to the request and response object by calling `getRequest()` or
`getResponse()` on the exception object.


### Query parameter aggregation

Multi-valued query parameters are no longer aggregated using a callback function. `Guzzle\Http\Query` now has a
setAggregator() method that accepts a `Guzzle\Http\QueryAggregator\QueryAggregatorInterface` object. This object is
responsible for handling the aggregation of multi-valued query string variables into a flattened hash.

2.8 to 3.x
----------

### Guzzle\Service\Inspector

Change `\Guzzle\Service\Inspector::fromConfig` to `\Guzzle\Common\Collection::fromConfig`

**Before**

```php
use Guzzle\Service\Inspector;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Inspector::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

**After**

```php
use Guzzle\Common\Collection;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Collection::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

### Convert XML Service Descriptions to JSON

**Before**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<client>
    <commands>
        <!-- Groups -->
        <command name="list_groups" method="GET" uri="groups.json">
            <doc>Get a list of groups</doc>
        </command>
        <command name="search_groups" method="GET" uri='search.json?query="{{query}} type:group"'>
            <doc>Uses a search query to get a list of groups</doc>
            <param name="query" type="string" required="true" />
        </command>
        <command name="create_group" method="POST" uri="groups.json">
            <doc>Create a group</doc>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
        <command name="delete_group" method="DELETE" uri="groups/{{id}}.json">
            <doc>Delete a group by ID</doc>
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="get_group" method="GET" uri="groups/{{id}}.json">
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="update_group" method="PUT" uri="groups/{{id}}.json">
            <doc>Update a group</doc>
            <param name="id" type="integer" required="true"/>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
    </commands>
</client>
```

**After**

```json
{
    "name":       "Zendesk REST API v2",
    "apiVersion": "2012-12-31",
    "description":"Provides access to Zendesk views, groups, tickets, ticket fields, and users",
    "operations": {
        "list_groups":  {
            "httpMethod":"GET",
            "uri":       "groups.json",
            "summary":   "Get a list of groups"
        },
        "search_groups":{
            "httpMethod":"GET",
            "uri":       "search.json?query=\"{query} type:group\"",
            "summary":   "Uses a search query to get a list of groups",
            "parameters":{
                "query":{
                    "location":   "uri",
                    "description":"Zendesk Search Query",
                    "type":       "string",
                    "required":   true
                }
            }
        },
        "create_group": {
            "httpMethod":"POST",
            "uri":       "groups.json",
            "summary":   "Create a group",
            "parameters":{
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        },
        "delete_group": {
            "httpMethod":"DELETE",
            "uri":       "groups/{id}.json",
            "summary":   "Delete a group",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to delete by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "get_group":    {
            "httpMethod":"GET",
            "uri":       "groups/{id}.json",
            "summary":   "Get a ticket",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to get by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "update_group": {
            "httpMethod":"PUT",
            "uri":       "groups/{id}.json",
            "summary":   "Update a group",
            "parameters":{
                "id":          {
                    "location":   "uri",
                    "description":"Group to update by ID",
                    "type":       "integer",
                    "required":   true
                },
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        }
}
```

### Guzzle\Service\Description\ServiceDescription

Commands are now called Operations

**Before**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getCommands();     // @returns ApiCommandInterface[]
$sd->hasCommand($name);
$sd->getCommand($name); // @returns ApiCommandInterface|null
$sd->addCommand($command); // @param ApiCommandInterface $command
```

**After**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getOperations();           // @returns OperationInterface[]
$sd->hasOperation($name);
$sd->getOperation($name);       // @returns OperationInterface|null
$sd->addOperation($operation);  // @param OperationInterface $operation
```

### Guzzle\Common\Inflection\Inflector

Namespace is now `Guzzle\Inflection\Inflector`

### Guzzle\Http\Plugin

Namespace is now `Guzzle\Plugin`. Many other changes occur within this namespace and are detailed in their own sections below.

### Guzzle\Http\Plugin\LogPlugin and Guzzle\Common\Log

Now `Guzzle\Plugin\Log\LogPlugin` and `Guzzle\Log` respectively.

**Before**

```php
use Guzzle\Common\Log\ClosureLogAdapter;
use Guzzle\Http\Plugin\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $verbosity is an integer indicating desired message verbosity level
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $verbosity = LogPlugin::LOG_VERBOSE);
```

**After**

```php
use Guzzle\Log\ClosureLogAdapter;
use Guzzle\Log\MessageFormatter;
use Guzzle\Plugin\Log\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $format is a string indicating desired message format -- @see MessageFormatter
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $format = MessageFormatter::DEBUG_FORMAT);
```

### Guzzle\Http\Plugin\CurlAuthPlugin

Now `Guzzle\Plugin\CurlAuth\CurlAuthPlugin`.

### Guzzle\Http\Plugin\ExponentialBackoffPlugin

Now `Guzzle\Plugin\Backoff\BackoffPlugin`, and other changes.

**Before**

```php
use Guzzle\Http\Plugin\ExponentialBackoffPlugin;

$backoffPlugin = new ExponentialBackoffPlugin($maxRetries, array_merge(
        ExponentialBackoffPlugin::getDefaultFailureCodes(), array(429)
    ));

$client->addSubscriber($backoffPlugin);
```

**After**

```php
use Guzzle\Plugin\Backoff\BackoffPlugin;
use Guzzle\Plugin\Backoff\HttpBackoffStrategy;

// Use convenient factory method instead -- see implementation for ideas of what
// you can do with chaining backoff strategies
$backoffPlugin = BackoffPlugin::getExponentialBackoff($maxRetries, array_merge(
        HttpBackoffStrategy::getDefaultFailureCodes(), array(429)
    ));
$client->addSubscriber($backoffPlugin);
```


### Known Issues

#### [BUG] Accept-Encoding header behavior changed unintentionally.

(See #217) (Fixed in 09daeb8c666fb44499a0646d655a8ae36456575e)

In version 2.8 setting the `Accept-Encoding` header would set the CURLOPT_ENCODING option, which permitted cURL to
properly handle gzip/deflate compressed responses from the server. In versions affected by this bug this does not happen.
See issue #217 for a workaround, or use a version containing the fix.

JSON Lint
=========

[![Build Status](https://secure.travis-ci.org/Seldaek/jsonlint.png)](http://travis-ci.org/Seldaek/jsonlint)

Usage
-----

```php
use Seld\JsonLint\JsonParser;

$parser = new JsonParser();
    
// returns null if it's valid json, or a ParsingException object.
$parser->lint($json);

// Call getMessage() on the exception object to get
// a well formatted error message error like this

// Parse error on line 2:
// ... "key": "value"    "numbers": [1, 2, 3]
// ----------------------^
// Expected one of: 'EOF', '}', ':', ',', ']'

// Call getDetails() on the exception to get more info.

// returns parsed json, like json_decode() does, but slower, throws
// exceptions on failure.
$parser->parse($json);
```

Installation
------------

JSON Lint can easily be used within another app if you have a PSR-0 autoloader, or
it can be installed through [Composer](http://packagist.org/) for use as a CLI util.
Once installed via Composer you can run the following command to lint a json file or URL:

    $ bin/jsonlint file.json

Requirements
------------

- PHP 5.3+
- [optional] PHPUnit 3.5+ to execute the test suite (phpunit --version)

Submitting bugs and feature requests
------------------------------------

Bugs and feature request are tracked on [GitHub](https://github.com/Seldaek/jsonlint/issues)

Author
------

Jordi Boggiano - <j.boggiano@seld.be> - <http://twitter.com/seldaek>

License
-------

JSON Lint is licensed under the MIT License - see the LICENSE file for details

Acknowledgements
----------------

This library is a port of the JavaScript [jsonlint](https://github.com/zaach/jsonlint) library.

# Alfred Workflow Builder

Alfred Workflow Builder is a PHP class for creating workflows with Alfred 2. This class provides functions for working
with plist settings files, reading and writing data to files, generating Alfred feedback results, and more.


## Installation

[Composer](composer) is the recommended way to install is package. Composer is dependency management tool for PHP that
allows you to declare the dependencies your project needs and installs them into your project.

1. Add `skyzyx/alfred-workflow-builder` as a dependency in your project's `composer.json` file.

	```json
	{
	    "require": {
	        "skyzyx/alfred-workflow-builder": "1.0.*"
	    }
	}
	```

2. Download and install Composer.

	```bash
	curl -s "http://getcomposer.org/installer" | php
	```

3. Install your dependencies.

	```bash
	php composer.phar install --optimize-autoloader
	```

4. Require Composer's autoloader.
Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that
it downloads. To use it, just add the following line to your code's bootstrap process.

	```php
	require 'vendor/autoload.php';
	```

The [original version of this class](original-class) (written by [David Ferguson](dferg)) had methods for things like
caching data to local files and fetching remote data over HTTP. Instead, we recommend you use [Guzzle](guzzle),
[Requests](requests) or [Buzz](buzz) for HTTP requests and [Doctrine Cache][doctrine-cache] for local file system caching.
If you'd also like logging, we recommend [Monolog](monolog).

[buzz]: https://github.com/kriswallsmith/Buzz
[composer]: http://getcomposer.org
[dferg]: http://dferg.us
[doctrine-cache]: http://docs.doctrine-project.org/en/2.0.x/reference/caching.html
[guzzle]: http://guzzlephp.org
[monolog]: https://github.com/Seldaek/monolog
[original-class]: https://github.com/jdfwarrior/Workflows
[requests]: http://requests.ryanmccue.info


## `Alfred\Workflow`

```php
use Alfred\Workflow;

$w = new Workflow('com.ryanparman.my-workflow');
#=> <Alfred\Workflow>
```

### Properties

#### bundle
The bundle ID for the workflow.

```php
$bundle = $w->bundle;
#=> (string) com.ryanparman.my-workflow
```

#### cache
The cache directory for the workflow.

```php
$cache = $w->cache;
#=> (string) /Users/rparman/Library/Caches/com.runningwithcrayons.Alfred-2/Workflow Data/com.ryanparman.my-workflow
```

#### data
The data directory for the workflow.

```php
$data = $w->data;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Workflow Data/com.ryanparman.my-workflow
```

#### home
The current user's `$HOME` directory.

```php
$home = $w->home;
#=> (string) /Users/rparman
```

#### path
The working directory for the workflow.

```php
$path = $w->path;
#=> (string) /Users/rparman/Library/Application Support/Alfred 2/Alfred.alfredpreferences/workflows/com.ryanparman.my-workflow
```

#### results
An array containing all of the results so far.

##### Example
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo var_export($w->results());
```

##### Results
```php
array (
  0 =>
  array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
  ),
)
```


### Methods

#### `string` toXML()
Accepts a properly formatted array or json object and converts it to XML for creating Alfred feedback results. If results
have been created using the `result()` function, then passing no arguments will use the array of results created using
the `result()` function. Arrays passed in must be an associative array with array key values for the following required
values: `uid`, `arg`, `title`, `subtitle` and `icon`. You may also pass array `key => value` pairs for the following
optional keys: `valid` and `autocomplete`.

##### Example using result function
```php
$w->result(array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
));
echo $w->toXML();
```

##### Example using array
```php
$results = array();
$temp = array(
    'uid' => 'itemuid',
    'arg' => 'itemarg',
    'title' => 'Some Item Title',
    'subtitle' => 'Some item subtitle',
    'icon' => 'icon.png',
    'valid' => 'yes',
    'autocomplete' => 'autocomplete'
);
array_push($results, $temp);
echo $w->toXML($results);
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="itemuid" arg="itemarg" autocomplete="autocomplete">
        <title>Some Item Title</title>
        <subtitle>Some item subtitle</subtitle>
        <icon>icon.png</icon>
    </item>
</items>
```

#### `array` mdfind()
Executes an `mdfind` command and returns results as an array of matching files.

```php
$results = $w->mdfind('"kMDItemContentType == com.apple.mail.emlx"');
/* or */
$results = $w->mdfind('Alfred 2.app');
#=> (array) ['/Applications/Alfred 2.app']
```

#### `array` result()
Creates a new result item that is cached within the class object. This set of results is available via the `results()`
functions, or, can be formatted and returned as XML via the `toXML()` function.

Autocomplete value is optional. If no value is specified, it will take the value of the result title. Possible values
for `$valid` are `yes` and `no` to set the validity of the result item.

##### Example
```php
$w->result(array (
    'uid' => 'alfred',
    'arg' => 'alfredapp',
    'title' => 'Alfred',
    'subtitle' => '/Applications/Alfred.app',
    'icon' => 'fileicon:/Applications/Alfred.app',
    'valid' => 'yes',
    'autocomplete' => 'Alfredapp',
));
echo $w->toXML();
```

##### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="alfred" arg="alfredapp" autocomplete="Alfredapp">
        <title>Alfred</title>
        <subtitle>/Applications/Alfred.app</subtitle>
        <icon type="fileicon">/Applications/Alfred.app</icon>
    </item>
</items>
```


## `Alfred\Storage\Plist`

```php
use Alfred\Storage\Plist;

$plist = new Plist('com.ryanparman.my-workflow');
#=> <Alfred\Storage\Plist>
```


### Methods

#### `string` setValue()
Stores a key-value pair.

```php
$plist->setValue('username', 'rparman');
```

#### `string` setValues()
Stores a series of key-value pairs.

```php
$plist->setValues(array(
    'username' => 'rparman',
    'password' => 'abc123',
    'zipcode'  => '90210',
));
```

#### `string` getValue()
Retrieves the value of a key.

```php
$username = $plist->getValue('username');
#=> (string) rparman
```

CHANGELOG
=========

2.1.0
-----

 * added TraceableEventDispatcherInterface
 * added ContainerAwareEventDispatcher
 * added a reference to the EventDispatcher on the Event
 * added a reference to the Event name on the event
 * added fluid interface to the dispatch() method which now returns the Event
   object
 * added GenericEvent event class
 * added the possibility for subscribers to subscribe several times for the
   same event
 * added ImmutableEventDispatcher

EventDispatcher Component
=========================

EventDispatcher implements a lightweight version of the Observer design
pattern.

    use Symfony\Component\EventDispatcher\EventDispatcher;
    use Symfony\Component\EventDispatcher\Event;

    $dispatcher = new EventDispatcher();

    $dispatcher->addListener('event_name', function (Event $event) {
        // ...
    });

    $dispatcher->dispatch('event_name');

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/EventDispatcher/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.2.0
-----

 * added a delete option for the mirror() method

2.1.0
-----

 * 24eb396 : BC Break : mkdir() function now throws exception in case of failure instead of returning Boolean value
 * created the component

Filesystem Component
====================

Filesystem provides basic utility to manipulate the file system:

```php
<?php

use Symfony\Component\Filesystem\Filesystem;

$filesystem = new Filesystem();

$filesystem->copy($originFile, $targetFile, $override = false);

$filesystem->mkdir($dirs, $mode = 0777);

$filesystem->touch($files, $time = null, $atime = null);

$filesystem->remove($files);

$filesystem->chmod($files, $mode, $umask = 0000, $recursive = false);

$filesystem->chown($files, $user, $recursive = false);

$filesystem->chgrp($files, $group, $recursive = false);

$filesystem->rename($origin, $target);

$filesystem->symlink($originDir, $targetDir, $copyOnWindows = false);

$filesystem->makePathRelative($endPath, $startPath);

$filesystem->mirror($originDir, $targetDir, \Traversable $iterator = null, $options = array());

$filesystem->isAbsolutePath($file);
```

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/Filesystem/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.2.0
-----

 * added ProcessBuilder::setArguments() to reset the arguments on a builder
 * added a way to retrieve the standard and error output incrementally
 * added Process:restart()

2.1.0
-----

 * added support for non-blocking processes (start(), wait(), isRunning(), stop())
 * enhanced Windows compatibility
 * added Process::getExitCodeText() that returns a string representation for
   the exit code returned by the process
 * added ProcessBuilder

Process Component
=================

Process executes commands in sub-processes.

In this example, we run a simple directory listing and get the result back:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->setTimeout(3600);
    $process->run();
    if (!$process->isSuccessful()) {
        throw new RuntimeException($process->getErrorOutput());
    }

    print $process->getOutput();

You can think that this is easy to achieve with plain PHP but it's not especially
if you want to take care of the subtle differences between the different platforms.

And if you want to be able to get some feedback in real-time, just pass an
anonymous function to the ``run()`` method and you will get the output buffer
as it becomes available:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->run(function ($type, $buffer) {
        if ('err' === $type) {
            echo 'ERR > '.$buffer;
        } else {
            echo 'OUT > '.$buffer;
        }
    });

That's great if you want to execute a long running command (like rsync-ing files to a
remote server) and give feedback to the user in real-time.

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/XXX/
    $ composer.phar install --dev
    $ phpunit

# Alfred 2 workflow for Redbox

<div><img src="screenshot.png"></div>

**[Download!](https://github.com/skyzyx/redbox.alfredworkflow/raw/master/redbox.alfredworkflow)**
Requires [Alfred 2 and the Powerpack](http://www.alfredapp.com/powerpack/).

Updates can be found and installed using **[Alleyoop](http://alfred.daniel.sh/Workflows/Alleyoop.alfredworkflow)**.

CHANGELOG
=========

3.3.1 (2013-03-10)
------------------

* Added the ability to create PHP streaming responses from HTTP requests
* Bug fix: Running any filters when parsing response headers with service descriptions
* Bug fix: OauthPlugin fixes to allow for multi-dimensional array signing, and sorting parameters before signing
* Bug fix: Removed the adding of default empty arrays and false Booleans to responses in order to be consistent across
  response location visitors.
* Bug fix: Removed the possibility of creating configuration files with circular dependencies
* RequestFactory::create() now uses the key of a POST file when setting the POST file name
* Added xmlAllowEmpty to serialize an XML body even if no XML specific parameters are set

3.3.0 (2013-03-03)
------------------

* A large number of performance optimizations have been made
* Bug fix: Added 'wb' as a valid write mode for streams
* Bug fix: `Guzzle\Http\Message\Response::json()` now allows scalar values to be returned
* Bug fix: Fixed bug in `Guzzle\Http\Message\Response` where wrapping quotes were stripped from `getEtag()`
* BC: Removed `Guzzle\Http\Utils` class
* BC: Setting a service description on a client will no longer modify the client's command factories.
* BC: Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using
  the 'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'
* BC: `Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to
  lowercase
* Operation parameter objects are now lazy loaded internally
* Added ErrorResponsePlugin that can throw errors for responses defined in service description operations' errorResponses
* Added support for instantiating responseType=class responseClass classes. Classes must implement
  `Guzzle\Service\Command\ResponseClassInterface`
* Added support for additionalProperties for top-level parameters in responseType=model responseClasses. These
  additional properties also support locations and can be used to parse JSON responses where the outermost part of the
  JSON is an array
* Added support for nested renaming of JSON models (rename sentAs to name)
* CachePlugin
    * Added support for stale-if-error so that the CachePlugin can now serve stale content from the cache on error
    * Debug headers can now added to cached response in the CachePlugin

3.2.0 (2013-02-14)
------------------

* CurlMulti is no longer reused globally. A new multi object is created per-client. This helps to isolate clients.
* URLs with no path no longer contain a "/" by default
* Guzzle\Http\QueryString does no longer manages the leading "?". This is now handled in Guzzle\Http\Url.
* BadResponseException no longer includes the full request and response message
* Adding setData() to Guzzle\Service\Description\ServiceDescriptionInterface
* Adding getResponseBody() to Guzzle\Http\Message\RequestInterface
* Various updates to classes to use ServiceDescriptionInterface type hints rather than ServiceDescription
* Header values can now be normalized into distinct values when multiple headers are combined with a comma separated list
* xmlEncoding can now be customized for the XML declaration of a XML service description operation
* Guzzle\Http\QueryString now uses Guzzle\Http\QueryAggregator\QueryAggregatorInterface objects to add custom value
  aggregation and no longer uses callbacks
* The URL encoding implementation of Guzzle\Http\QueryString can now be customized
* Bug fix: Filters were not always invoked for array service description parameters
* Bug fix: Redirects now use a target response body rather than a temporary response body
* Bug fix: The default exponential backoff BackoffPlugin was not giving when the request threshold was exceeded
* Bug fix: Guzzle now takes the first found value when grabbing Cache-Control directives

3.1.2 (2013-01-27)
------------------

* Refactored how operation responses are parsed. Visitors now include a before() method responsible for parsing the
  response body. For example, the XmlVisitor now parses the XML response into an array in the before() method.
* Fixed an issue where cURL would not automatically decompress responses when the Accept-Encoding header was sent
* CURLOPT_SSL_VERIFYHOST is never set to 1 because it is deprecated (see 5e0ff2ef20f839e19d1eeb298f90ba3598784444)
* Fixed a bug where redirect responses were not chained correctly using getPreviousResponse()
* Setting default headers on a client after setting the user-agent will not erase the user-agent setting

3.1.1 (2013-01-20)
------------------

* Adding wildcard support to Guzzle\Common\Collection::getPath()
* Adding alias support to ServiceBuilder configs
* Adding Guzzle\Service\Resource\CompositeResourceIteratorFactory and cleaning up factory interface

3.1.0 (2013-01-12)
------------------

* BC: CurlException now extends from RequestException rather than BadResponseException
* BC: Renamed Guzzle\Plugin\Cache\CanCacheStrategyInterface::canCache() to canCacheRequest() and added CanCacheResponse()
* Added getData to ServiceDescriptionInterface
* Added context array to RequestInterface::setState()
* Bug: Removing hard dependency on the BackoffPlugin from Guzzle\Http
* Bug: Adding required content-type when JSON request visitor adds JSON to a command
* Bug: Fixing the serialization of a service description with custom data
* Made it easier to deal with exceptions thrown when transferring commands or requests in parallel by providing
  an array of successful and failed responses
* Moved getPath from Guzzle\Service\Resource\Model to Guzzle\Common\Collection
* Added Guzzle\Http\IoEmittingEntityBody
* Moved command filtration from validators to location visitors
* Added `extends` attributes to service description parameters
* Added getModels to ServiceDescriptionInterface

3.0.7 (2012-12-19)
------------------

* Fixing phar detection when forcing a cacert to system if null or true
* Allowing filename to be passed to `Guzzle\Http\Message\Request::setResponseBody()`
* Cleaning up `Guzzle\Common\Collection::inject` method
* Adding a response_body location to service descriptions

3.0.6 (2012-12-09)
------------------

* CurlMulti performance improvements
* Adding setErrorResponses() to Operation
* composer.json tweaks

3.0.5 (2012-11-18)
------------------

* Bug: Fixing an infinite recursion bug caused from revalidating with the CachePlugin
* Bug: Response body can now be a string containing "0"
* Bug: Using Guzzle inside of a phar uses system by default but now allows for a custom cacert
* Bug: QueryString::fromString now properly parses query string parameters that contain equal signs
* Added support for XML attributes in service description responses
* DefaultRequestSerializer now supports array URI parameter values for URI template expansion
* Added better mimetype guessing to requests and post files

3.0.4 (2012-11-11)
------------------

* Bug: Fixed a bug when adding multiple cookies to a request to use the correct glue value
* Bug: Cookies can now be added that have a name, domain, or value set to "0"
* Bug: Using the system cacert bundle when using the Phar
* Added json and xml methods to Response to make it easier to parse JSON and XML response data into data structures
* Enhanced cookie jar de-duplication
* Added the ability to enable strict cookie jars that throw exceptions when invalid cookies are added
* Added setStream to StreamInterface to actually make it possible to implement custom rewind behavior for entity bodies
* Added the ability to create any sort of hash for a stream rather than just an MD5 hash

3.0.3 (2012-11-04)
------------------

* Implementing redirects in PHP rather than cURL
* Added PECL URI template extension and using as default parser if available
* Bug: Fixed Content-Length parsing of Response factory
* Adding rewind() method to entity bodies and streams. Allows for custom rewinding of non-repeatable streams.
* Adding ToArrayInterface throughout library
* Fixing OauthPlugin to create unique nonce values per request

3.0.2 (2012-10-25)
------------------

* Magic methods are enabled by default on clients
* Magic methods return the result of a command
* Service clients no longer require a base_url option in the factory
* Bug: Fixed an issue with URI templates where null template variables were being expanded

3.0.1 (2012-10-22)
------------------

* Models can now be used like regular collection objects by calling filter, map, etc
* Models no longer require a Parameter structure or initial data in the constructor
* Added a custom AppendIterator to get around a PHP bug with the `\AppendIterator`

3.0.0 (2012-10-15)
------------------

* Rewrote service description format to be based on Swagger
    * Now based on JSON schema
    * Added nested input structures and nested response models
    * Support for JSON and XML input and output models
    * Renamed `commands` to `operations`
    * Removed dot class notation
    * Removed custom types
* Broke the project into smaller top-level namespaces to be more component friendly
* Removed support for XML configs and descriptions. Use arrays or JSON files.
* Removed the Validation component and Inspector
* Moved all cookie code to Guzzle\Plugin\Cookie
* Magic methods on a Guzzle\Service\Client now return the command un-executed.
* Calling getResult() or getResponse() on a command will lazily execute the command if needed.
* Now shipping with cURL's CA certs and using it by default
* Added previousResponse() method to response objects
* No longer sending Accept and Accept-Encoding headers on every request
* Only sending an Expect header by default when a payload is greater than 1MB
* Added/moved client options:
    * curl.blacklist to curl.option.blacklist
    * Added ssl.certificate_authority
* Added a Guzzle\Iterator component
* Moved plugins from Guzzle\Http\Plugin to Guzzle\Plugin
* Added a more robust backoff retry strategy (replaced the ExponentialBackoffPlugin)
* Added a more robust caching plugin
* Added setBody to response objects
* Updating LogPlugin to use a more flexible MessageFormatter
* Added a completely revamped build process
* Cleaning up Collection class and removing default values from the get method
* Fixed ZF2 cache adapters

2.8.8 (2012-10-15)
------------------

* Bug: Fixed a cookie issue that caused dot prefixed domains to not match where popular browsers did

2.8.7 (2012-09-30)
------------------

* Bug: Fixed config file aliases for JSON includes
* Bug: Fixed cookie bug on a request object by using CookieParser to parse cookies on requests
* Bug: Removing the path to a file when sending a Content-Disposition header on a POST upload
* Bug: Hardening request and response parsing to account for missing parts
* Bug: Fixed PEAR packaging
* Bug: Fixed Request::getInfo
* Bug: Fixed cases where CURLM_CALL_MULTI_PERFORM return codes were causing curl transactions to fail
* Adding the ability for the namespace Iterator factory to look in multiple directories
* Added more getters/setters/removers from service descriptions
* Added the ability to remove POST fields from OAuth signatures
* OAuth plugin now supports 2-legged OAuth

2.8.6 (2012-09-05)
------------------

* Added the ability to modify and build service descriptions
* Added the use of visitors to apply parameters to locations in service descriptions using the dynamic command
* Added a `json` parameter location
* Now allowing dot notation for classes in the CacheAdapterFactory
* Using the union of two arrays rather than an array_merge when extending service builder services and service params
* Ensuring that a service is a string before doing strpos() checks on it when substituting services for references
  in service builder config files.
* Services defined in two different config files that include one another will by default replace the previously
  defined service, but you can now create services that extend themselves and merge their settings over the previous
* The JsonLoader now supports aliasing filenames with different filenames. This allows you to alias something like
  '_default' with a default JSON configuration file.

2.8.5 (2012-08-29)
------------------

* Bug: Suppressed empty arrays from URI templates
* Bug: Added the missing $options argument from ServiceDescription::factory to enable caching
* Added support for HTTP responses that do not contain a reason phrase in the start-line
* AbstractCommand commands are now invokable
* Added a way to get the data used when signing an Oauth request before a request is sent

2.8.4 (2012-08-15)
------------------

* Bug: Custom delay time calculations are no longer ignored in the ExponentialBackoffPlugin
* Added the ability to transfer entity bodies as a string rather than streamed. This gets around curl error 65. Set `body_as_string` in a request's curl options to enable.
* Added a StreamInterface, EntityBodyInterface, and added ftell() to Guzzle\Common\Stream
* Added an AbstractEntityBodyDecorator and a ReadLimitEntityBody decorator to transfer only a subset of a decorated stream
* Stream and EntityBody objects will now return the file position to the previous position after a read required operation (e.g. getContentMd5())
* Added additional response status codes
* Removed SSL information from the default User-Agent header
* DELETE requests can now send an entity body
* Added an EventDispatcher to the ExponentialBackoffPlugin and added an ExponentialBackoffLogger to log backoff retries
* Added the ability of the MockPlugin to consume mocked request bodies
* LogPlugin now exposes request and response objects in the extras array

2.8.3 (2012-07-30)
------------------

* Bug: Fixed a case where empty POST requests were sent as GET requests
* Bug: Fixed a bug in ExponentialBackoffPlugin that caused fatal errors when retrying an EntityEnclosingRequest that does not have a body
* Bug: Setting the response body of a request to null after completing a request, not when setting the state of a request to new
* Added multiple inheritance to service description commands
* Added an ApiCommandInterface and added ``getParamNames()`` and ``hasParam()``
* Removed the default 2mb size cutoff from the Md5ValidatorPlugin so that it now defaults to validating everything
* Changed CurlMulti::perform to pass a smaller timeout to CurlMulti::executeHandles

2.8.2 (2012-07-24)
------------------

* Bug: Query string values set to 0 are no longer dropped from the query string
* Bug: A Collection object is no longer created each time a call is made to ``Guzzle\Service\Command\AbstractCommand::getRequestHeaders()``
* Bug: ``+`` is now treated as an encoded space when parsing query strings
* QueryString and Collection performance improvements
* Allowing dot notation for class paths in filters attribute of a service descriptions

2.8.1 (2012-07-16)
------------------

* Loosening Event Dispatcher dependency
* POST redirects can now be customized using CURLOPT_POSTREDIR

2.8.0 (2012-07-15)
------------------

* BC: Guzzle\Http\Query
    * Query strings with empty variables will always show an equal sign unless the variable is set to QueryString::BLANK (e.g. ?acl= vs ?acl)
    * Changed isEncodingValues() and isEncodingFields() to isUrlEncoding()
    * Changed setEncodeValues(bool) and setEncodeFields(bool) to useUrlEncoding(bool)
    * Changed the aggregation functions of QueryString to be static methods
    * Can now use fromString() with querystrings that have a leading ?
* cURL configuration values can be specified in service descriptions using ``curl.`` prefixed parameters
* Content-Length is set to 0 before emitting the request.before_send event when sending an empty request body
* Cookies are no longer URL decoded by default
* Bug: URI template variables set to null are no longer expanded

2.7.2 (2012-07-02)
------------------

* BC: Moving things to get ready for subtree splits. Moving Inflection into Common. Moving Guzzle\Http\Parser to Guzzle\Parser.
* BC: Removing Guzzle\Common\Batch\Batch::count() and replacing it with isEmpty()
* CachePlugin now allows for a custom request parameter function to check if a request can be cached
* Bug fix: CachePlugin now only caches GET and HEAD requests by default
* Bug fix: Using header glue when transferring headers over the wire
* Allowing deeply nested arrays for composite variables in URI templates
* Batch divisors can now return iterators or arrays

2.7.1 (2012-06-26)
------------------

* Minor patch to update version number in UA string
* Updating build process

2.7.0 (2012-06-25)
------------------

* BC: Inflection classes moved to Guzzle\Inflection. No longer static methods. Can now inject custom inflectors into classes.
* BC: Removed magic setX methods from commands
* BC: Magic methods mapped to service description commands are now inflected in the command factory rather than the client __call() method
* Verbose cURL options are no longer enabled by default. Set curl.debug to true on a client to enable.
* Bug: Now allowing colons in a response start-line (e.g. HTTP/1.1 503 Service Unavailable: Back-end server is at capacity)
* Guzzle\Service\Resource\ResourceIteratorApplyBatched now internally uses the Guzzle\Common\Batch namespace
* Added Guzzle\Service\Plugin namespace and a PluginCollectionPlugin
* Added the ability to set POST fields and files in a service description
* Guzzle\Http\EntityBody::factory() now accepts objects with a __toString() method
* Adding a command.before_prepare event to clients
* Added BatchClosureTransfer and BatchClosureDivisor
* BatchTransferException now includes references to the batch divisor and transfer strategies
* Fixed some tests so that they pass more reliably
* Added Guzzle\Common\Log\ArrayLogAdapter

2.6.6 (2012-06-10)
------------------

* BC: Removing Guzzle\Http\Plugin\BatchQueuePlugin
* BC: Removing Guzzle\Service\Command\CommandSet
* Adding generic batching system (replaces the batch queue plugin and command set)
* Updating ZF cache and log adapters and now using ZF's composer repository
* Bug: Setting the name of each ApiParam when creating through an ApiCommand
* Adding result_type, result_doc, deprecated, and doc_url to service descriptions
* Bug: Changed the default cookie header casing back to 'Cookie'

2.6.5 (2012-06-03)
------------------

* BC: Renaming Guzzle\Http\Message\RequestInterface::getResourceUri() to getResource()
* BC: Removing unused AUTH_BASIC and AUTH_DIGEST constants from
* BC: Guzzle\Http\Cookie is now used to manage Set-Cookie data, not Cookie data
* BC: Renaming methods in the CookieJarInterface
* Moving almost all cookie logic out of the CookiePlugin and into the Cookie or CookieJar implementations
* Making the default glue for HTTP headers ';' instead of ','
* Adding a removeValue to Guzzle\Http\Message\Header
* Adding getCookies() to request interface.
* Making it easier to add event subscribers to HasDispatcherInterface classes. Can now directly call addSubscriber()

2.6.4 (2012-05-30)
------------------

* BC: Cleaning up how POST files are stored in EntityEnclosingRequest objects. Adding PostFile class.
* BC: Moving ApiCommand specific functionality from the Inspector and on to the ApiCommand
* Bug: Fixing magic method command calls on clients
* Bug: Email constraint only validates strings
* Bug: Aggregate POST fields when POST files are present in curl handle
* Bug: Fixing default User-Agent header
* Bug: Only appending or prepending parameters in commands if they are specified
* Bug: Not requiring response reason phrases or status codes to match a predefined list of codes
* Allowing the use of dot notation for class namespaces when using instance_of constraint
* Added any_match validation constraint
* Added an AsyncPlugin
* Passing request object to the calculateWait method of the ExponentialBackoffPlugin
* Allowing the result of a command object to be changed
* Parsing location and type sub values when instantiating a service description rather than over and over at runtime

2.6.3 (2012-05-23)
------------------

* [BC] Guzzle\Common\FromConfigInterface no longer requires any config options.
* [BC] Refactoring how POST files are stored on an EntityEnclosingRequest. They are now separate from POST fields.
* You can now use an array of data when creating PUT request bodies in the request factory.
* Removing the requirement that HTTPS requests needed a Cache-Control: public directive to be cacheable.
* [Http] Adding support for Content-Type in multipart POST uploads per upload
* [Http] Added support for uploading multiple files using the same name (foo[0], foo[1])
* Adding more POST data operations for easier manipulation of POST data.
* You can now set empty POST fields.
* The body of a request is only shown on EntityEnclosingRequest objects that do not use POST files.
* Split the Guzzle\Service\Inspector::validateConfig method into two methods. One to initialize when a command is created, and one to validate.
* CS updates

2.6.2 (2012-05-19)
------------------

* [Http] Better handling of nested scope requests in CurlMulti.  Requests are now always prepares in the send() method rather than the addRequest() method.

2.6.1 (2012-05-19)
------------------

* [BC] Removing 'path' support in service descriptions.  Use 'uri'.
* [BC] Guzzle\Service\Inspector::parseDocBlock is now protected. Adding getApiParamsForClass() with cache.
* [BC] Removing Guzzle\Common\NullObject.  Use https://github.com/mtdowling/NullObject if you need it.
* [BC] Removing Guzzle\Common\XmlElement.
* All commands, both dynamic and concrete, have ApiCommand objects.
* Adding a fix for CurlMulti so that if all of the connections encounter some sort of curl error, then the loop exits.
* Adding checks to EntityEnclosingRequest so that empty POST files and fields are ignored.
* Making the method signature of Guzzle\Service\Builder\ServiceBuilder::factory more flexible.

2.6.0 (2012-05-15)
------------------

* [BC] Moving Guzzle\Service\Builder to Guzzle\Service\Builder\ServiceBuilder
* [BC] Executing a Command returns the result of the command rather than the command
* [BC] Moving all HTTP parsing logic to Guzzle\Http\Parsers. Allows for faster C implementations if needed.
* [BC] Changing the Guzzle\Http\Message\Response::setProtocol() method to accept a protocol and version in separate args.
* [BC] Moving ResourceIterator* to Guzzle\Service\Resource
* [BC] Completely refactored ResourceIterators to iterate over a cloned command object
* [BC] Moved Guzzle\Http\UriTemplate to Guzzle\Http\Parser\UriTemplate\UriTemplate
* [BC] Guzzle\Guzzle is now deprecated
* Moving Guzzle\Common\Guzzle::inject to Guzzle\Common\Collection::inject
* Adding Guzzle\Version class to give version information about Guzzle
* Adding Guzzle\Http\Utils class to provide getDefaultUserAgent() and getHttpDate()
* Adding Guzzle\Curl\CurlVersion to manage caching curl_version() data
* ServiceDescription and ServiceBuilder are now cacheable using similar configs
* Changing the format of XML and JSON service builder configs.  Backwards compatible.
* Cleaned up Cookie parsing
* Trimming the default Guzzle User-Agent header
* Adding a setOnComplete() method to Commands that is called when a command completes
* Keeping track of requests that were mocked in the MockPlugin
* Fixed a caching bug in the CacheAdapterFactory
* Inspector objects can be injected into a Command object
* Refactoring a lot of code and tests to be case insensitive when dealing with headers
* Adding Guzzle\Http\Message\HeaderComparison for easy comparison of HTTP headers using a DSL
* Adding the ability to set global option overrides to service builder configs
* Adding the ability to include other service builder config files from within XML and JSON files
* Moving the parseQuery method out of Url and on to QueryString::fromString() as a static factory method.

2.5.0 (2012-05-08)
------------------

* Major performance improvements
* [BC] Simplifying Guzzle\Common\Collection.  Please check to see if you are using features that are now deprecated.
* [BC] Using a custom validation system that allows a flyweight implementation for much faster validation. No longer using Symfony2 Validation component.
* [BC] No longer supporting "{{ }}" for injecting into command or UriTemplates.  Use "{}"
* Added the ability to passed parameters to all requests created by a client
* Added callback functionality to the ExponentialBackoffPlugin
* Using microtime in ExponentialBackoffPlugin to allow more granular backoff strategies.
* Rewinding request stream bodies when retrying requests
* Exception is thrown when JSON response body cannot be decoded
* Added configurable magic method calls to clients and commands.  This is off by default.
* Fixed a defect that added a hash to every parsed URL part
* Fixed duplicate none generation for OauthPlugin.
* Emitting an event each time a client is generated by a ServiceBuilder
* Using an ApiParams object instead of a Collection for parameters of an ApiCommand
* cache.* request parameters should be renamed to params.cache.*
* Added the ability to set arbitrary curl options on requests (disable_wire, progress, etc). See CurlHandle.
* Added the ability to disable type validation of service descriptions
* ServiceDescriptions and ServiceBuilders are now Serializable

Guzzle, PHP HTTP client and webservice framework
================================================

Guzzle is a PHP HTTP client and framework for building RESTful web service clients.

- Extremely powerful API provides all the power of cURL with a simple interface.
- Truly take advantage of HTTP/1.1 with persistent connections, connection pooling, and parallel requests.
- Service description DSL allows you build awesome web service clients faster.
- Symfony2 event-based plugin system allows you to completely modify the behavior of a request.
- Includes a custom node.js webserver to test your clients.
- Unit-tested with PHPUnit with 100% code coverage.

Getting started
---------------

- [Download the phar](http://guzzlephp.org/guzzle.phar) and include it in your project ([minimal phar](http://guzzlephp.org/guzzle-min.phar))
- Docs: [www.guzzlephp.org](http://www.guzzlephp.org/)
- Forum: https://groups.google.com/forum/?hl=en#!forum/guzzle
- IRC: [#guzzlephp](irc://irc.freenode.net/#guzzlephp) channel on irc.freenode.net

### Installing via Composer

The recommended way to install Guzzle is through [Composer](http://getcomposer.org).

1. Add ``guzzle/guzzle`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/guzzle": "~3.1"
            }
        }

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

Features
--------

- Supports GET, HEAD, POST, DELETE, PUT, PATCH, OPTIONS, and any custom verbs
- Allows full access to request and response headers
- Persistent connections are implicitly managed by Guzzle, resulting in huge performance benefits
- [Send requests in parallel](http://guzzlephp.org/tour/http.html#send-http-requests-in-parallel)
- Cookie sessions can be maintained between requests using the [CookiePlugin](http://guzzlephp.org/tour/http.html#cookie-session-plugin)
- Allows custom [entity bodies](http://guzzlephp.org/tour/http.html#entity-bodies), including sending data from a PHP stream and downloading data to a PHP stream
- Responses can be cached and served from cache using the [caching forward proxy plugin](http://guzzlephp.org/tour/http.html#php-based-caching-forward-proxy)
- Failed requests can be retried using [truncated exponential backoff](http://guzzlephp.org/tour/http.html#truncated-exponential-backoff) with custom retry policies
- Entity bodies can be validated automatically using Content-MD5 headers and the [MD5 hash validator plugin](http://guzzlephp.org/tour/http.html#md5-hash-validator-plugin)
- All data sent over the wire can be logged using the [LogPlugin](http://guzzlephp.org/tour/http.html#over-the-wire-logging)
- Subject/Observer signal slot system for unobtrusively [modifying request behavior](http://guzzlephp.org/guide/http/creating_plugins.html)
- Supports all of the features of libcurl including authentication, compression, redirects, SSL, proxies, etc
- Web service client framework for building future-proof interfaces to web services
- Includes a [service description DSL](http://guzzlephp.org/guide/service/service_descriptions.html) for quickly building webservice clients
- Full support for [URI templates](http://tools.ietf.org/html/rfc6570)
- Advanced batching functionality to efficiently send requests or commands in parallel with customizable batch sizes and transfer strategies

HTTP basics
-----------

```php
<?php

use Guzzle\Http\Client;

$client = new Client('http://www.example.com/api/v1/key/{{key}}', array(
    'key' => '***'
));

// Issue a path using a relative URL to the client's base URL
// Sends to http://www.example.com/api/v1/key/***/users
$request = $client->get('users');
$response = $request->send();

// Relative URL that overwrites the path of the base URL
$request = $client->get('/test/123.php?a=b');

// Issue a head request on the base URL
$response = $client->head()->send();
// Delete user 123
$response = $client->delete('users/123')->send();

// Send a PUT request with custom headers
$response = $client->put('upload/text', array(
    'X-Header' => 'My Header'
), 'body of the request')->send();

// Send a PUT request using the contents of a PHP stream as the body
// Send using an absolute URL (overrides the base URL)
$response = $client->put('http://www.example.com/upload', array(
    'X-Header' => 'My Header'
), fopen('http://www.test.com/', 'r'));

// Create a POST request with a file upload (notice the @ symbol):
$request = $client->post('http://localhost:8983/solr/update', null, array (
    'custom_field' => 'my value',
    'file' => '@/path/to/documents.xml'
));

// Create a POST request and add the POST files manually
$request = $client->post('http://localhost:8983/solr/update')
    ->addPostFiles(array(
        'file' => '/path/to/documents.xml'
    ));

// Responses are objects
echo $response->getStatusCode() . ' ' . $response->getReasonPhrase() . "\n";

// Requests and responses can be cast to a string to show the raw HTTP message
echo $request . "\n\n" . $response;

// Create a request based on an HTTP message
$request = RequestFactory::fromMessage(
    "PUT / HTTP/1.1\r\n" .
    "Host: test.com:8081\r\n" .
    "Content-Type: text/plain" .
    "Transfer-Encoding: chunked\r\n" .
    "\r\n" .
    "this is the body"
);
```

Send requests in parallel
-------------------------

```php
<?php

try {
    $client = new Guzzle\Http\Client('http://www.myapi.com/api/v1');
    $responses = $client->send(array(
        $client->get('users'),
        $client->head('messages/123'),
        $client->delete('orders/123')
    ));
} catch (Guzzle\Common\Exception\ExceptionCollection $e) {
    echo "The following requests encountered an exception: \n";
    foreach ($e as $exception) {
        echo $exception->getRequest() . "\n" . $exception->getMessage() . "\n";
    }
}
```

URI templates
-------------

Guzzle supports the entire [URI templates RFC](http://tools.ietf.org/html/rfc6570).

```php
<?php

$client = new Guzzle\Http\Client('http://www.myapi.com/api/v1', array(
    'path' => '/path/to',
    'a'    => 'hi',
    'data' => array(
        'foo'  => 'bar',
        'mesa' => 'jarjar'
    )
));

$request = $client->get('http://www.test.com{+path}{?a,data*}');
```

The generated request URL would become: ``http://www.test.com/path/to?a=hi&foo=bar&mesa=jarajar``

You can specify URI templates and an array of additional template variables to use when creating requests:

```php
<?php

$client = new Guzzle\Http\Client('http://test.com', array(
    'a' => 'hi'
));

$request = $client->get(array('/{?a,b}', array(
    'b' => 'there'
));
```

The resulting URL would become ``http://test.com/?a=hi&b=there``

Unit testing
------------

[![Build Status](https://secure.travis-ci.org/guzzle/guzzle.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Guzzle uses PHPUnit for unit testing. In order to run the unit tests, you'll first need
to install the dependencies of the project using Composer: `php composer.phar install --dev`.
You can then run the tests using `vendor/bin/phpunit` or `phing test` (if you have phing installed).

Guzzle Iterator
===============

[![Build Status](https://secure.travis-ci.org/guzzle/iterator.png?branch=master)](http://travis-ci.org/guzzle/guzzle)

Component library that provides useful Iterators and Iterator decorators

- ChunkedIterator: Pulls out chunks from an inner iterator and yields the chunks as arrays
- FilterIterator: Used when PHP 5.4's CallbackFilterIterator is not available
- MapIterator: Maps values before yielding
- MethodProxyIterator: Proxies missing method calls to the innermost iterator

### Installing via Composer

The recommended way to install is through [Composer](http://getcomposer.org).

1. Add ``guzzle/iterator`` as a dependency in your project's ``composer.json`` file:

        {
            "require": {
                "guzzle/iterator": "*"
            }
        }

    Consider tightening your dependencies to a known version when deploying mission critical applications (e.g. ``2.7.*``).

2. Download and install Composer:

        curl -s http://getcomposer.org/installer | php

3. Install your dependencies:

        php composer.phar install

4. Require Composer's autoloader

    Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that it downloads. To use it, just add the following line to your code's bootstrap process:

        require 'vendor/autoload.php';

You can find out more on how to install Composer, configure autoloading, and other best-practices for defining dependencies at [getcomposer.org](http://getcomposer.org).

<?php

namespace Guzzle\Service\Command\Factory;

use Guzzle\Service\Description\ServiceDescriptionInterface;
use Guzzle\Inflection\InflectorInterface;

/**
 * Command factory used to create commands based on service descriptions
 */
class ServiceDescriptionFactory implements FactoryInterface
{
    /**
     * @var ServiceDescriptionInterface
     */
    protected $description;

    /**
     * @var InflectorInterface
     */
    protected $inflector;

    /**
     * @param ServiceDescriptionInterface $description Service description
     * @param InflectorInterface          $inflector   Optional inflector to use if the command is not at first found
     */
    public function __construct(ServiceDescriptionInterface $description, InflectorInterface $inflector = null)
    {
        $this->setServiceDescription($description);
        $this->inflector = $inflector;
    }

    /**
     * Change the service description used with the factory
     *
     * @param ServiceDescriptionInterface $description Service description to use
     *
     * @return FactoryInterface
     */
    public function setServiceDescription(ServiceDescriptionInterface $description)
    {
        $this->description = $description;

        return $this;
    }

    /**
     * Returns the service description
     *
     * @return ServiceDescriptionInterface
     */
    public function getServiceDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function factory($name, array $args = array())
    {
        $command = $this->description->getOperation($name);

        // If an inflector was passed, then attempt to get the command using snake_case inflection
        if (!$command && $this->inflector) {
            $command = $this->description->getOperation($this->inflector->snake($name));
        }

        if ($command) {
            $class = $command->getClass();
            return new $class($args, $command, $this->description);
        }
    }
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Common\Exception\InvalidArgumentException;

/**
 * A ServiceDescription stores service information based on a service document
 */
class ServiceDescription implements ServiceDescriptionInterface
{
    /**
     * @var array Array of {@see OperationInterface} objects
     */
    protected $operations = array();

    /**
     * @var array Array of API models
     */
    protected $models = array();

    /**
     * @var string Name of the API
     */
    protected $name;

    /**
     * @var string API version
     */
    protected $apiVersion;

    /**
     * @var string Summary of the API
     */
    protected $description;

    /**
     * @var array Any extra API data
     */
    protected $extraData = array();

    /**
     * @var ServiceDescriptionLoader Factory used in factory method
     */
    protected static $descriptionLoader;

    /**
     * @var string baseUrl/basePath
     */
    protected $baseUrl;

    /**
     * {@inheritdoc}
     * @param string|array $config  File to build or array of operation information
     * @param array        $options Service description factory options
     *
     * @return self
     */
    public static function factory($config, array $options = array())
    {
        // @codeCoverageIgnoreStart
        if (!self::$descriptionLoader) {
            self::$descriptionLoader = new ServiceDescriptionLoader();
        }
        // @codeCoverageIgnoreEnd

        return self::$descriptionLoader->load($config, $options);
    }

    /**
     * Create a new ServiceDescription
     *
     * @param array $config Array of configuration data
     */
    public function __construct(array $config = array())
    {
        $this->fromArray($config);
    }

    /**
     * Serialize the service description
     *
     * @return string
     */
    public function serialize()
    {
        $result = array(
            'name'        => $this->name,
            'apiVersion'  => $this->apiVersion,
            'baseUrl'     => $this->baseUrl,
            'description' => $this->description
        ) + $this->extraData;
        $result['operations'] = array();
        foreach ($this->getOperations() as $name => $operation) {
            $result['operations'][$operation->getName() ?: $name] = $operation->toArray();
        }
        if (!empty($this->models)) {
            $result['models'] = array();
            foreach ($this->models as $id => $model) {
                $result['models'][$id] = $model instanceof Parameter ? $model->toArray(): $model;
            }
        }

        return json_encode(array_filter($result));
    }

    /**
     * Unserialize the service description
     *
     * @param string|array $json JSON data
     */
    public function unserialize($json)
    {
        $this->operations = array();
        $this->fromArray(json_decode($json, true));
    }

    /**
     * {@inheritdoc}
     */
    public function getBaseUrl()
    {
        return $this->baseUrl;
    }

    /**
     * Set the baseUrl of the description
     *
     * @param string $baseUrl Base URL of each operation
     *
     * @return self
     */
    public function setBaseUrl($baseUrl)
    {
        $this->baseUrl = $baseUrl;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getOperations()
    {
        foreach (array_keys($this->operations) as $name) {
            $this->getOperation($name);
        }

        return $this->operations;
    }

    /**
     * {@inheritdoc}
     */
    public function hasOperation($name)
    {
        return isset($this->operations[$name]);
    }

    /**
     * {@inheritdoc}
     */
    public function getOperation($name)
    {
        // Lazily retrieve and build operations
        if (!isset($this->operations[$name])) {
            return null;
        }

        if (!($this->operations[$name] instanceof Operation)) {
            $this->operations[$name] = new Operation($this->operations[$name], $this);
        }

        return $this->operations[$name];
    }

    /**
     * Add a operation to the service description
     *
     * @param OperationInterface $operation Operation to add
     *
     * @return self
     */
    public function addOperation(OperationInterface $operation)
    {
        $this->operations[$operation->getName()] = $operation->setServiceDescription($this);

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getModel($id)
    {
        if (!isset($this->models[$id])) {
            return null;
        }

        if (!($this->models[$id] instanceof Parameter)) {
            $this->models[$id] = new Parameter($this->models[$id], $this);
        }

        return $this->models[$id];
    }

    /**
     * {@inheritdoc}
     */
    public function getModels()
    {
        // Ensure all models are converted into parameter objects
        foreach (array_keys($this->models) as $id) {
            $this->getModel($id);
        }

        return $this->models;
    }

    /**
     * {@inheritdoc}
     */
    public function hasModel($id)
    {
        return isset($this->models[$id]);
    }

    /**
     * Add a model to the service description
     *
     * @param Parameter $model Model to add
     *
     * @return self
     */
    public function addModel(Parameter $model)
    {
        $this->models[$model->getName()] = $model;

        return $this;
    }

    /**
     * {@inheritdoc}
     */
    public function getApiVersion()
    {
        return $this->apiVersion;
    }

    /**
     * {@inheritdoc}
     */
    public function getName()
    {
        return $this->name;
    }

    /**
     * {@inheritdoc}
     */
    public function getDescription()
    {
        return $this->description;
    }

    /**
     * {@inheritdoc}
     */
    public function getData($key)
    {
        return isset($this->extraData[$key]) ? $this->extraData[$key] : null;
    }

    /**
     * {@inheritdoc}
     */
    public function setData($key, $value)
    {
        $this->extraData[$key] = $value;

        return $this;
    }

    /**
     * Initialize the state from an array
     *
     * @param array $config Configuration data
     * @throws InvalidArgumentException
     */
    protected function fromArray(array $config)
    {
        // Keep a list of default keys used in service descriptions that is later used to determine extra data keys
        $defaultKeys = array('name', 'models', 'apiVersion', 'baseUrl', 'description');
        // Pull in the default configuration values
        foreach ($defaultKeys as $key) {
            if (isset($config[$key])) {
                $this->{$key} = $config[$key];
            }
        }

        // Account for the Swagger name for Guzzle's baseUrl
        if (isset($config['basePath'])) {
            $this->baseUrl = $config['basePath'];
        }

        // Ensure that the models and operations properties are always arrays
        $this->models = (array) $this->models;
        $this->operations = (array) $this->operations;

        // We want to add operations differently than adding the other properties
        $defaultKeys[] = 'operations';

        // Create operations for each operation
        if (isset($config['operations'])) {
            foreach ($config['operations'] as $name => $operation) {
                if (!($operation instanceof Operation) && !is_array($operation)) {
                    throw new InvalidArgumentException('Invalid operation in service description: '
                        . gettype($operation));
                }
                $this->operations[$name] = $operation;
            }
        }

        // Get all of the additional properties of the service description and store them in a data array
        foreach (array_diff(array_keys($config), $defaultKeys) as $key) {
            $this->extraData[$key] = $config[$key];
        }
    }
}

<?php

namespace Guzzle\Service\Description;

/**
 * A ServiceDescription stores service information based on a service document
 */
interface ServiceDescriptionInterface extends \Serializable
{
    /**
     * Get the basePath/baseUrl of the description
     *
     * @return string
     */
    public function getBaseUrl();

    /**
     * Get the API operations of the service
     *
     * @return array Returns an array of {@see OperationInterface} objects
     */
    public function getOperations();

    /**
     * Check if the service has an operation by name
     *
     * @param string $name Name of the operation to check
     *
     * @return bool
     */
    public function hasOperation($name);

    /**
     * Get an API operation by name
     *
     * @param string $name Name of the command
     *
     * @return OperationInterface|null
     */
    public function getOperation($name);

    /**
     * Get a specific model from the description
     *
     * @param string $id ID of the model
     *
     * @return Parameter|null
     */
    public function getModel($id);

    /**
     * Get all service description models
     *
     * @return array
     */
    public function getModels();

    /**
     * Check if the description has a specific model by name
     *
     * @param string $id ID of the model
     *
     * @return bool
     */
    public function hasModel($id);

    /**
     * Get the API version of the service
     *
     * @return string
     */
    public function getApiVersion();

    /**
     * Get the name of the API
     *
     * @return string
     */
    public function getName();

    /**
     * Get a summary of the purpose of the API
     *
     * @return string
     */
    public function getDescription();

    /**
     * Get arbitrary data from the service description that is not part of the Guzzle spec
     *
     * @param string $key Data key to retrieve
     *
     * @return null|mixed
     */
    public function getData($key);

    /**
     * Set arbitrary data on the service description
     *
     * @param string $key   Data key to set
     * @param mixed  $value Value to set
     *
     * @return self
     */
    public function setData($key, $value);
}

<?php

namespace Guzzle\Service\Description;

use Guzzle\Service\AbstractConfigLoader;
use Guzzle\Service\Exception\DescriptionBuilderException;

/**
 * Loader for service descriptions
 */
class ServiceDescriptionLoader extends AbstractConfigLoader
{
    /**
     * {@inheritdoc}
     */
    protected function build($config, array $options)
    {
        $operations = array();
        if (!empty($config['operations'])) {
            foreach ($config['operations'] as $name => $op) {
                $name = $op['name'] = isset($op['name']) ? $op['name'] : $name;
                // Extend other operations
                if (!empty($op['extends'])) {
                    $this->resolveExtension($name, $op, $operations);
                }
                $op['parameters'] = isset($op['parameters']) ? $op['parameters'] : array();
                $operations[$name] = $op;
            }
        }

        return new ServiceDescription(array(
            'apiVersion'  => isset($config['apiVersion']) ? $config['apiVersion'] : null,
            'baseUrl'     => isset($config['baseUrl']) ? $config['baseUrl'] : null,
            'description' => isset($config['description']) ? $config['description'] : null,
            'operations'  => $operations,
            'models'      => isset($config['models']) ? $config['models'] : null
        ) + $config);
    }

    /**
     * @param string $name       Name of the operation
     * @param array  $op         Operation value array
     * @param array  $operations Currently loaded operations
     * @throws DescriptionBuilderException when extending a non-existent operation
     */
    protected function resolveExtension($name, array &$op, array &$operations)
    {
        $resolved = array();
        $original = empty($op['parameters']) ? false: $op['parameters'];
        $hasClass = !empty($op['class']);
        foreach ((array) $op['extends'] as $extendedCommand) {
            if (empty($operations[$extendedCommand])) {
                throw new DescriptionBuilderException("{$name} extends missing operation {$extendedCommand}");
            }
            $toArray = $operations[$extendedCommand];
            $resolved = empty($resolved)
                ? $toArray['parameters']
                : array_merge($resolved, $toArray['parameters']);

            $op = $op + $toArray;
            if (!$hasClass && isset($toArray['class'])) {
                $op['class'] = $toArray['class'];
            }
        }
        $op['parameters'] = $original ? array_merge($resolved, $original) : $resolved;
    }
}

<?php

namespace Guzzle\Service\Exception;

use Guzzle\Common\Exception\RuntimeException;

class DescriptionBuilderException extends RuntimeException {}

<?php

namespace Guzzle\Tests\Service\Command;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Command\Factory\ServiceDescriptionFactory;
use Guzzle\Inflection\Inflector;

/**
 * @covers Guzzle\Service\Command\Factory\ServiceDescriptionFactory
 */
class ServiceDescriptionFactoryTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testProvider()
    {
        return array(
            array('foo', null),
            array('jar_jar', 'Guzzle\Tests\Service\Mock\Command\MockCommand'),
            array('binks', 'Guzzle\Tests\Service\Mock\Command\OtherCommand')
        );
    }

    /**
     * @dataProvider testProvider
     */
    public function testCreatesCommandsUsingServiceDescriptions($key, $result)
    {
        $d = $this->getDescription();

        $factory = new ServiceDescriptionFactory($d);
        $this->assertSame($d, $factory->getServiceDescription());

        if (is_null($result)) {
            $this->assertNull($factory->factory($key));
        } else {
            $this->assertInstanceof($result, $factory->factory($key));
        }
    }

    public function testUsesInflectionIfNoExactMatch()
    {
        $d = $this->getDescription();
        $factory = new ServiceDescriptionFactory($d, new Inflector());
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('Binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\OtherCommand', $factory->factory('binks'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('JarJar'));
        $this->assertInstanceof('Guzzle\Tests\Service\Mock\Command\MockCommand', $factory->factory('jar_jar'));
    }

    protected function getDescription()
    {
        return ServiceDescription::factory(array(
            'operations' => array(
                'jar_jar' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\MockCommand'
                ),
                'binks' => array(
                    'class' => 'Guzzle\Tests\Service\Mock\Command\OtherCommand'
                )
            )
        ));
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\ServiceDescriptionLoader;

/**
 * @covers Guzzle\Service\Description\ServiceDescriptionLoader
 */
class ServiceDescriptionLoaderTest extends \Guzzle\Tests\GuzzleTestCase
{
    public function testAllowsExtraData()
    {
        $d = ServiceDescription::factory(array(
            'foo' => true,
            'baz' => array('bar'),
            'apiVersion' => '123',
            'operations' => array()
        ));

        $this->assertEquals(true, $d->getData('foo'));
        $this->assertEquals(array('bar'), $d->getData('baz'));
        $this->assertEquals('123', $d->getApiVersion());
    }

    public function testAllowsDeepNestedInheritance()
    {
        $d = ServiceDescription::factory(array(
            'operations' => array(
                'abstract' => array(
                    'httpMethod' => 'HEAD',
                    'parameters' => array(
                        'test' => array('type' => 'string', 'required' => true)
                    )
                ),
                'abstract2' => array('uri' => '/test', 'extends' => 'abstract'),
                'concrete'  => array('extends' => 'abstract2'),
                'override'  => array('extends' => 'abstract', 'httpMethod' => 'PUT'),
                'override2'  => array('extends' => 'override', 'httpMethod' => 'POST', 'uri' => '/')
            )
        ));

        $c = $d->getOperation('concrete');
        $this->assertEquals('/test', $c->getUri());
        $this->assertEquals('HEAD', $c->getHttpMethod());
        $params = $c->getParams();
        $param = $params['test'];
        $this->assertEquals('string', $param->getType());
        $this->assertTrue($param->getRequired());

        // Ensure that merging HTTP method does not make an array
        $this->assertEquals('PUT', $d->getOperation('override')->getHttpMethod());
        $this->assertEquals('POST', $d->getOperation('override2')->getHttpMethod());
        $this->assertEquals('/', $d->getOperation('override2')->getUri());
    }

    /**
     * @expectedException RuntimeException
     */
    public function testThrowsExceptionWhenExtendingMissingCommand()
    {
        ServiceDescription::factory(array(
            'operations' => array(
                'concrete' => array(
                    'extends' => 'missing'
                )
            )
        ));
    }

    public function testAllowsMultipleInheritance()
    {
        $description = ServiceDescription::factory(array(
            'operations' => array(
                'a' => array(
                    'httpMethod' => 'GET',
                    'parameters' => array(
                        'a1' => array(
                            'default'  => 'foo',
                            'required' => true,
                            'prepend'  => 'hi'
                        )
                    )
                ),
                'b' => array(
                    'extends' => 'a',
                    'parameters' => array(
                        'b2' => array()
                    )
                ),
                'c' => array(
                    'parameters' => array(
                        'a1' => array(
                            'default'     => 'bar',
                            'required'    => true,
                            'description' => 'test'
                        ),
                        'c3' => array()
                    )
                ),
                'd' => array(
                    'httpMethod' => 'DELETE',
                    'extends'    => array('b', 'c'),
                    'parameters' => array(
                        'test' => array()
                    )
                )
            )
        ));

        $command = $description->getOperation('d');
        $this->assertEquals('DELETE', $command->getHttpMethod());
        $this->assertContains('a1', $command->getParamNames());
        $this->assertContains('b2', $command->getParamNames());
        $this->assertContains('c3', $command->getParamNames());
        $this->assertContains('test', $command->getParamNames());

        $this->assertTrue($command->getParam('a1')->getRequired());
        $this->assertEquals('bar', $command->getParam('a1')->getDefault());
        $this->assertEquals('test', $command->getParam('a1')->getDescription());
    }

    public function testAddsOtherFields()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(),
            'description' => 'Foo',
            'apiVersion'  => 'bar'
        ));
        $this->assertEquals('Foo', $description->getDescription());
        $this->assertEquals('bar', $description->getApiVersion());
    }

    public function testCanLoadNestedExtends()
    {
        $description = ServiceDescription::factory(array(
            'operations'  => array(
                'root' => array(
                    'class' => 'foo'
                ),
                'foo' => array(
                    'extends' => 'root',
                    'parameters' => array(
                        'baz' => array('type' => 'string')
                    )
                ),
                'foo_2' => array(
                    'extends' => 'foo',
                    'parameters' => array(
                        'bar' => array('type' => 'string')
                    )
                ),
                'foo_3' => array(
                    'class' => 'bar',
                    'parameters' => array(
                        'bar2' => array('type' => 'string')
                    )
                ),
                'foo_4' => array(
                    'extends' => array('foo_2', 'foo_3'),
                    'parameters' => array(
                        'bar3' => array('type' => 'string')
                    )
                )
            )
        ));

        $this->assertTrue($description->hasOperation('foo_4'));
        $foo4 = $description->getOperation('foo_4');
        $this->assertTrue($foo4->hasParam('baz'));
        $this->assertTrue($foo4->hasParam('bar'));
        $this->assertTrue($foo4->hasParam('bar2'));
        $this->assertTrue($foo4->hasParam('bar3'));
        $this->assertEquals('bar', $foo4->getClass());
    }
}

<?php

namespace Guzzle\Tests\Service\Description;

use Guzzle\Service\Description\ServiceDescription;
use Guzzle\Service\Description\Operation;
use Guzzle\Service\Description\Parameter;
use Guzzle\Service\Client;

/**
 * @covers Guzzle\Service\Description\ServiceDescription
 */
class ServiceDescriptionTest extends \Guzzle\Tests\GuzzleTestCase
{
    protected $serviceData;

    public function setup()
    {
        $this->serviceData = array(
            'test_command' => new Operation(array(
                'name'        => 'test_command',
                'description' => 'documentationForCommand',
                'httpMethod'  => 'DELETE',
                'class'       => 'Guzzle\\Tests\\Service\\Mock\\Command\\MockCommand',
                'parameters'  => array(
                    'bucket'  => array('required' => true),
                    'key'     => array('required' => true)
                )
            ))
        );
    }

    /**
     * @covers Guzzle\Service\Description\ServiceDescription::factory
     * @covers Guzzle\Service\Description\ServiceDescriptionLoader::build
     */
    public function testFactoryDelegatesToConcreteFactories()
    {
        $jsonFile = __DIR__ . '/../../TestData/test_service.json';
        $this->assertInstanceOf('Guzzle\Service\Description\ServiceDescription', ServiceDescription::factory($jsonFile));
    }

    public function testConstructor()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $this->assertEquals(1, count($service->getOperations()));
        $this->assertFalse($service->hasOperation('foobar'));
        $this->assertTrue($service->hasOperation('test_command'));
    }

    public function testIsSerializable()
    {
        $service = new ServiceDescription(array('operations' => $this->serviceData));
        $data = serialize($service);
        $d2 = unserialize($data);
        $this->assertEquals(serialize($service), serialize($d2));
    }

    public function testSerializesParameters()
    {
        $service = new ServiceDescription(array(
            'operations' => array(
                'foo' => new Operation(array('parameters' => array('foo' => array('type' => 'string'))))
            )
        ));
        $serialized = serialize($service);
        $this->assertContains('"parameters":{"foo":', $serialized);
        $service = unserialize($serialized);
        $this->assertTrue($service->getOperation('foo')->hasParam('foo'));
    }

    public function testAllowsForJsonBasedArrayParamsFunctionalTest()
    {
        $description = new ServiceDescription(array(
            'operations' => array(
                'test' => new Operation(array(
                    'httpMethod' => 'PUT',
                    'parameters' => array(
                        'data'   => array(
                            'required' => true,
                            'filters'  => 'json_encode',
                            'location' => 'body'
                        )
                    )
                ))
            )
        ));
        $client = new Client();
        $client->setDescription($description);
        $command = $client->getCommand('test', array(
            'data' => array(
                'foo' => 'bar'
            )
        ));

        $request = $command->prepare();
        $this->assertEquals('{"foo":"bar"}', (string) $request->getBody());
    }

    public function testContainsModels()
    {
        $d = new ServiceDescription(array(
            'operations' => array('foo' => array()),
            'models' => array(
                'Tag'    => array('type' => 'object'),
                'Person' => array('type' => 'object')
            )
        ));
        $this->assertTrue($d->hasModel('Tag'));
        $this->assertTrue($d->hasModel('Person'));
        $this->assertFalse($d->hasModel('Foo'));
        $this->assertInstanceOf('Guzzle\Service\Description\Parameter', $d->getModel('Tag'));
        $this->assertNull($d->getModel('Foo'));
        $this->assertContains('"models":{', serialize($d));
        $this->assertEquals(array('Tag', 'Person'), array_keys($d->getModels()));
    }

    public function testCanAddModels()
    {
        $d = new ServiceDescription(array());
        $this->assertFalse($d->hasModel('Foo'));
        $d->addModel(new Parameter(array('name' => 'Foo')));
        $this->assertTrue($d->hasModel('Foo'));
    }

    public function testHasAttributes()
    {
        $d = new ServiceDescription(array(
            'operations'  => array(),
            'name'        => 'Name',
            'description' => 'Description',
            'apiVersion'  => '1.24'
        ));

        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());

        $s = serialize($d);
        $this->assertContains('"name":"Name"', $s);
        $this->assertContains('"description":"Description"', $s);
        $this->assertContains('"apiVersion":"1.24"', $s);

        $d = unserialize($s);
        $this->assertEquals('Name', $d->getName());
        $this->assertEquals('Description', $d->getDescription());
        $this->assertEquals('1.24', $d->getApiVersion());
    }

    public function testPersistsCustomAttributes()
    {
        $data = array(
            'operations'  => array('foo' => array('class' => 'foo', 'parameters' => array())),
            'name'        => 'Name',
            'description' => 'Test',
            'apiVersion'  => '1.24',
            'auth'        => 'foo',
            'keyParam'    => 'bar'
        );
        $d = new ServiceDescription($data);
        $d->setData('hello', 'baz');
        $this->assertEquals('foo', $d->getData('auth'));
        $this->assertEquals('baz', $d->getData('hello'));
        $this->assertEquals('bar', $d->getData('keyParam'));
        // responseClass and responseType are added by default
        $data['operations']['foo']['responseClass'] = 'array';
        $data['operations']['foo']['responseType'] = 'primitive';
        $this->assertEquals($data + array('hello' => 'baz'), json_decode($d->serialize(), true));
    }

    public function testReturnsNullWhenRetrievingMissingOperation()
    {
        $s = new ServiceDescription(array());
        $this->assertNull($s->getOperation('foo'));
    }

    public function testCanAddOperations()
    {
        $s = new ServiceDescription(array());
        $this->assertFalse($s->hasOperation('Foo'));
        $s->addOperation(new Operation(array('name' => 'Foo')));
        $this->assertTrue($s->hasOperation('Foo'));
    }

    /**
     * @expectedException Guzzle\Common\Exception\InvalidArgumentException
     */
    public function testValidatesOperationTypes()
    {
        $s = new ServiceDescription(array(
            'operations' => array('foo' => new \stdClass())
        ));
    }

    public function testHasBaseUrl()
    {
        $description = new ServiceDescription(array('baseUrl' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
        $description->setBaseUrl('http://foobar.com');
        $this->assertEquals('http://foobar.com', $description->getBaseUrl());
    }

    public function testCanUseBasePath()
    {
        $description = new ServiceDescription(array('basePath' => 'http://foo.com'));
        $this->assertEquals('http://foo.com', $description->getBaseUrl());
    }
}

Guzzle Upgrade Guide
====================

3.2 to 3.3
----------

### Response::getEtag() quote stripping removed

`Guzzle\Http\Message\Response::getEtag()` no longer strips quotes around the ETag response header

### Removed `Guzzle\Http\Utils`

The `Guzzle\Http\Utils` class was removed. This class was only used for testing.

### Stream wrapper and type

`Guzzle\Stream\Stream::getWrapper()` and `Guzzle\Stream\Stream::getSteamType()` are no longer converted to lowercase.

### curl.emit_io became emit_io

Emitting IO events from a RequestMediator is now a parameter that must be set in a request's curl options using the
'emit_io' key. This was previously set under a request's parameters using 'curl.emit_io'

3.1 to 3.2
----------

### CurlMulti is no longer reused globally

Before 3.2, the same CurlMulti object was reused globally for each client. This can cause issue where plugins added
to a single client can pollute requests dispatched from other clients.

If you still wish to reuse the same CurlMulti object with each client, then you can add a listener to the
ServiceBuilder's `service_builder.create_client` event to inject a custom CurlMulti object into each client as it is
created.

```php
$multi = new Guzzle\Http\Curl\CurlMulti();
$builder = Guzzle\Service\Builder\ServiceBuilder::factory('/path/to/config.json');
$builder->addListener('service_builder.create_client', function ($event) use ($multi) {
    $event['client']->setCurlMulti($multi);
}
});
```

### No default path

URLs no longer have a default path value of '/' if no path was specified.

Before:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com/
```

After:

```php
$request = $client->get('http://www.foo.com');
echo $request->getUrl();
// >> http://www.foo.com
```

### Less verbose BadResponseException

The exception message for `Guzzle\Http\Exception\BadResponseException` no longer contains the full HTTP request and
response information. You can, however, get access to the request and response object by calling `getRequest()` or
`getResponse()` on the exception object.


### Query parameter aggregation

Multi-valued query parameters are no longer aggregated using a callback function. `Guzzle\Http\Query` now has a
setAggregator() method that accepts a `Guzzle\Http\QueryAggregator\QueryAggregatorInterface` object. This object is
responsible for handling the aggregation of multi-valued query string variables into a flattened hash.

2.8 to 3.x
----------

### Guzzle\Service\Inspector

Change `\Guzzle\Service\Inspector::fromConfig` to `\Guzzle\Common\Collection::fromConfig`

**Before**

```php
use Guzzle\Service\Inspector;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Inspector::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

**After**

```php
use Guzzle\Common\Collection;

class YourClient extends \Guzzle\Service\Client
{
    public static function factory($config = array())
    {
        $default = array();
        $required = array('base_url', 'username', 'api_key');
        $config = Collection::fromConfig($config, $default, $required);

        $client = new self(
            $config->get('base_url'),
            $config->get('username'),
            $config->get('api_key')
        );
        $client->setConfig($config);

        $client->setDescription(ServiceDescription::factory(__DIR__ . DIRECTORY_SEPARATOR . 'client.json'));

        return $client;
    }
```

### Convert XML Service Descriptions to JSON

**Before**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<client>
    <commands>
        <!-- Groups -->
        <command name="list_groups" method="GET" uri="groups.json">
            <doc>Get a list of groups</doc>
        </command>
        <command name="search_groups" method="GET" uri='search.json?query="{{query}} type:group"'>
            <doc>Uses a search query to get a list of groups</doc>
            <param name="query" type="string" required="true" />
        </command>
        <command name="create_group" method="POST" uri="groups.json">
            <doc>Create a group</doc>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
        <command name="delete_group" method="DELETE" uri="groups/{{id}}.json">
            <doc>Delete a group by ID</doc>
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="get_group" method="GET" uri="groups/{{id}}.json">
            <param name="id" type="integer" required="true"/>
        </command>
        <command name="update_group" method="PUT" uri="groups/{{id}}.json">
            <doc>Update a group</doc>
            <param name="id" type="integer" required="true"/>
            <param name="data" type="array" location="body" filters="json_encode" doc="Group JSON"/>
            <param name="Content-Type" location="header" static="application/json"/>
        </command>
    </commands>
</client>
```

**After**

```json
{
    "name":       "Zendesk REST API v2",
    "apiVersion": "2012-12-31",
    "description":"Provides access to Zendesk views, groups, tickets, ticket fields, and users",
    "operations": {
        "list_groups":  {
            "httpMethod":"GET",
            "uri":       "groups.json",
            "summary":   "Get a list of groups"
        },
        "search_groups":{
            "httpMethod":"GET",
            "uri":       "search.json?query=\"{query} type:group\"",
            "summary":   "Uses a search query to get a list of groups",
            "parameters":{
                "query":{
                    "location":   "uri",
                    "description":"Zendesk Search Query",
                    "type":       "string",
                    "required":   true
                }
            }
        },
        "create_group": {
            "httpMethod":"POST",
            "uri":       "groups.json",
            "summary":   "Create a group",
            "parameters":{
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        },
        "delete_group": {
            "httpMethod":"DELETE",
            "uri":       "groups/{id}.json",
            "summary":   "Delete a group",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to delete by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "get_group":    {
            "httpMethod":"GET",
            "uri":       "groups/{id}.json",
            "summary":   "Get a ticket",
            "parameters":{
                "id":{
                    "location":   "uri",
                    "description":"Group to get by ID",
                    "type":       "integer",
                    "required":   true
                }
            }
        },
        "update_group": {
            "httpMethod":"PUT",
            "uri":       "groups/{id}.json",
            "summary":   "Update a group",
            "parameters":{
                "id":          {
                    "location":   "uri",
                    "description":"Group to update by ID",
                    "type":       "integer",
                    "required":   true
                },
                "data":        {
                    "type":       "array",
                    "location":   "body",
                    "description":"Group JSON",
                    "filters":    "json_encode",
                    "required":   true
                },
                "Content-Type":{
                    "type":    "string",
                    "location":"header",
                    "static":  "application/json"
                }
            }
        }
}
```

### Guzzle\Service\Description\ServiceDescription

Commands are now called Operations

**Before**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getCommands();     // @returns ApiCommandInterface[]
$sd->hasCommand($name);
$sd->getCommand($name); // @returns ApiCommandInterface|null
$sd->addCommand($command); // @param ApiCommandInterface $command
```

**After**

```php
use Guzzle\Service\Description\ServiceDescription;

$sd = new ServiceDescription();
$sd->getOperations();           // @returns OperationInterface[]
$sd->hasOperation($name);
$sd->getOperation($name);       // @returns OperationInterface|null
$sd->addOperation($operation);  // @param OperationInterface $operation
```

### Guzzle\Common\Inflection\Inflector

Namespace is now `Guzzle\Inflection\Inflector`

### Guzzle\Http\Plugin

Namespace is now `Guzzle\Plugin`. Many other changes occur within this namespace and are detailed in their own sections below.

### Guzzle\Http\Plugin\LogPlugin and Guzzle\Common\Log

Now `Guzzle\Plugin\Log\LogPlugin` and `Guzzle\Log` respectively.

**Before**

```php
use Guzzle\Common\Log\ClosureLogAdapter;
use Guzzle\Http\Plugin\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $verbosity is an integer indicating desired message verbosity level
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $verbosity = LogPlugin::LOG_VERBOSE);
```

**After**

```php
use Guzzle\Log\ClosureLogAdapter;
use Guzzle\Log\MessageFormatter;
use Guzzle\Plugin\Log\LogPlugin;

/** @var \Guzzle\Http\Client */
$client;

// $format is a string indicating desired message format -- @see MessageFormatter
$client->addSubscriber(new LogPlugin(new ClosureLogAdapter(function($m) { echo $m; }, $format = MessageFormatter::DEBUG_FORMAT);
```

### Guzzle\Http\Plugin\CurlAuthPlugin

Now `Guzzle\Plugin\CurlAuth\CurlAuthPlugin`.

### Guzzle\Http\Plugin\ExponentialBackoffPlugin

Now `Guzzle\Plugin\Backoff\BackoffPlugin`, and other changes.

**Before**

```php
use Guzzle\Http\Plugin\ExponentialBackoffPlugin;

$backoffPlugin = new ExponentialBackoffPlugin($maxRetries, array_merge(
        ExponentialBackoffPlugin::getDefaultFailureCodes(), array(429)
    ));

$client->addSubscriber($backoffPlugin);
```

**After**

```php
use Guzzle\Plugin\Backoff\BackoffPlugin;
use Guzzle\Plugin\Backoff\HttpBackoffStrategy;

// Use convenient factory method instead -- see implementation for ideas of what
// you can do with chaining backoff strategies
$backoffPlugin = BackoffPlugin::getExponentialBackoff($maxRetries, array_merge(
        HttpBackoffStrategy::getDefaultFailureCodes(), array(429)
    ));
$client->addSubscriber($backoffPlugin);
```


### Known Issues

#### [BUG] Accept-Encoding header behavior changed unintentionally.

(See #217) (Fixed in 09daeb8c666fb44499a0646d655a8ae36456575e)

In version 2.8 setting the `Accept-Encoding` header would set the CURLOPT_ENCODING option, which permitted cURL to
properly handle gzip/deflate compressed responses from the server. In versions affected by this bug this does not happen.
See issue #217 for a workaround, or use a version containing the fix.

JSON Lint
=========

[![Build Status](https://secure.travis-ci.org/Seldaek/jsonlint.png)](http://travis-ci.org/Seldaek/jsonlint)

Usage
-----

```php
use Seld\JsonLint\JsonParser;

$parser = new JsonParser();
    
// returns null if it's valid json, or a ParsingException object.
$parser->lint($json);

// Call getMessage() on the exception object to get
// a well formatted error message error like this

// Parse error on line 2:
// ... "key": "value"    "numbers": [1, 2, 3]
// ----------------------^
// Expected one of: 'EOF', '}', ':', ',', ']'

// Call getDetails() on the exception to get more info.

// returns parsed json, like json_decode() does, but slower, throws
// exceptions on failure.
$parser->parse($json);
```

Installation
------------

JSON Lint can easily be used within another app if you have a PSR-0 autoloader, or
it can be installed through [Composer](http://packagist.org/) for use as a CLI util.
Once installed via Composer you can run the following command to lint a json file or URL:

    $ bin/jsonlint file.json

Requirements
------------

- PHP 5.3+
- [optional] PHPUnit 3.5+ to execute the test suite (phpunit --version)

Submitting bugs and feature requests
------------------------------------

Bugs and feature request are tracked on [GitHub](https://github.com/Seldaek/jsonlint/issues)

Author
------

Jordi Boggiano - <j.boggiano@seld.be> - <http://twitter.com/seldaek>

License
-------

JSON Lint is licensed under the MIT License - see the LICENSE file for details

Acknowledgements
----------------

This library is a port of the JavaScript [jsonlint](https://github.com/zaach/jsonlint) library.

# Alfred Workflow Builder

Alfred Workflow Builder is a PHP class for creating workflows with Alfred 2. This class provides functions for working
with plist settings files, reading and writing data to files, generating Alfred feedback results, and more.


## Installation

[Composer](http://getcomposer.org) is the recommended way to install is package. Composer is dependency management tool
for PHP that allows you to declare the dependencies your project needs and installs them into your project.

1. Add `skyzyx/alfred-workflow-builder` as a dependency in your project's `composer.json` file.

	```json
	{
	    "require": {
	        "skyzyx/alfred-workflow-builder": "1.0.*"
	    }
	}
	```

2. Download and install Composer.

	```bash
	curl -s "http://getcomposer.org/installer" | php
	```

3. Install your dependencies.

	```bash
	php composer.phar install --optimize-autoloader
	```

4. Require Composer's autoloader.
Composer also prepares an autoload file that's capable of autoloading all of the classes in any of the libraries that
it downloads. To use it, just add the following line to your code's bootstrap process.

	```php
	require 'vendor/autoload.php';
	```

The [original version of this class](https://github.com/jdfwarrior/Workflows) (written by [David Ferguson](http://dferg.us))
had methods for things like caching data to local files and fetching remote data over HTTP. Instead, we recommend you use
[Guzzle](http://guzzlephp.org), [Requests](http://requests.ryanmccue.info) or [Buzz](https://github.com/kriswallsmith/Buzz)
for HTTP requests and [Doctrine Cache](http://docs.doctrine-project.org/en/2.0.x/reference/caching.html) for local file
system caching. If you'd also like logging, we recommend [Monolog](https://github.com/Seldaek/monolog).

----

## `Alfred\Workflow`

```php
use Alfred\Workflow;

// Pass a Bundle ID
$w = new Workflow('com.ryanparman.my-workflow');
#=> <Alfred\Workflow>
```

### `string` toXML()
Accepts a properly formatted array or json object and converts it to XML for creating Alfred feedback results. If results
have been created using the `result()` function, then passing no arguments will use the array of results created using
the `result()` function.

#### Example using result function
```php
$w->result(array(
    'uid'          => 'itemuid',
    'arg'          => 'itemarg',
    'title'        => 'Some Item Title',
    'subtitle'     => 'Some item subtitle',
    'icon'         => 'icon.png',
    'valid'        => 'yes',
    'autocomplete' => 'autocomplete'
));
echo $w->toXML();
```

#### Example using array
```php
$results = array();
$temp = array(
    'uid'          => 'itemuid',
    'arg'          => 'itemarg',
    'title'        => 'Some Item Title',
    'subtitle'     => 'Some item subtitle',
    'icon'         => 'icon.png',
    'valid'        => 'yes',
    'autocomplete' => 'autocomplete'
);
array_push($results, $temp);
echo $w->toXML($results);
```

#### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="itemuid" arg="itemarg" autocomplete="autocomplete">
        <title>Some Item Title</title>
        <subtitle>Some item subtitle</subtitle>
        <icon>icon.png</icon>
    </item>
</items>
```

### `array` mdfind()
Executes an `mdfind` command and returns results as an array of matching files.

```php
$results = $w->mdfind('"kMDItemContentType == com.apple.mail.emlx"');
/* or */
$results = $w->mdfind('Alfred 2.app');
#=> (array) ['/Applications/Alfred 2.app']
```

You can learn more about querying the OS X metadata service by checking out:
* [Using Spotlight from the OS X Commandline](http://0xfe.blogspot.com/2006/03/using-spotlight-from-os-x-commandline.html)
* [File Metadata Query Expression Syntax](https://developer.apple.com/library/mac/#documentation/carbon/conceptual/spotlightquery/concepts/queryformat.html)
* [Spotlight Metadata Attributes](https://developer.apple.com/library/mac/#documentation/carbon/Reference/MetadataAttributesRef/Reference/CommonAttrs.html#//apple_ref/doc/uid/TP40001694-SW1)

### `array` result()
Creates a new result item that is cached within the class object. This set of results is available via the `results()`
functions, or, can be formatted and returned as XML via the `toXML()` function.

<table>
    <thead>
        <tr>
            <th>Key</th>
            <th>Usage</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>uid</code></td>
            <td><p>Unique ID for the search result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>arg</code></td>
            <td><p>Argument for this result. This will get fed into any downstream actions. (Required)</p></td>
        </tr>
        <tr>
            <td><code>title</code></td>
            <td><p>The main title for the result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>subtitle</code></td>
            <td><p>The subtitle for the result. (Required)</p></td>
        </tr>
        <tr>
            <td><code>icon</code></td>
            <td><p>The icon that this result should have. This should typically be <code>icon.png</code>. (Required)</p></td>
        </tr>
        <tr>
            <td><code>valid</code></td>
            <td><p>If you press enter with this result selected, should it trigger downstream actions? Valid values are
                <code>"yes"</code>, <code>"no"</code>, <code>true</code> and <code>false</code>. The default value is
                <code>"yes"</code>.</p></td>
        </tr>
        <tr>
            <td><code>autocomplete</code></td>
            <td><p>If you press enter with this result selected, what value should pop up as an autocomplete value?
                (<a href="http://simonbs.dk/post/41727742869/movies-workflow-for-alfred-2-0">Movies</a> is a good usage
                example.)</p></td>
        </tr>
    </tbody>
</table>

#### Example
```php
$w->result(array (
    'uid'          => 'alfred',
    'arg'          => 'alfredapp',
    'title'        => 'Alfred',
    'subtitle'     => '/Applications/Alfred.app',
    'icon'         => 'fileicon:/Applications/Alfred.app',
    'valid'        => 'yes',
    'autocomplete' => 'Alfredapp',
));
echo $w->toXML();
```

#### Result
```xml
<?xml version="1.0"?>
<items>
    <item uid="alfred" arg="alfredapp" autocomplete="Alfredapp">
        <title>Alfred</title>
        <subtitle>/Applications/Alfred.app</subtitle>
        <icon type="fileicon">/Applications/Alfred.app</icon>
    </item>
</items>
```

----

## `Alfred\Storage\Plist`

```php
use Alfred\Storage\Plist;

// Pass a Bundle ID and Plist name
$plist = new Plist('com.ryanparman.my-workflow', 'info');
#=> <Alfred\Storage\Plist>
```

### `string` setValue()
Stores a key-value pair.

```php
$plist->setValue('username', 'rparman');
```

### `string` setValues()
Stores a series of key-value pairs.

```php
$plist->setValues(array(
    'username' => 'rparman',
    'password' => 'abc123',
    'zipcode'  => '90210',
));
```

### `string` getValue()
Retrieves the value of a key.

```php
$username = $plist->getValue('username');
#=> (string) rparman
```

## More!
You can learn more about Alfred 2 Workflows by checking out <http://support.alfredapp.com/workflows>.

You can also deconstruct some workflows that are built with Alfred Workflow Builder.
* [Packagist](https://github.com/skyzyx/packagist.alfredworkflow)
* [Geolocation](https://github.com/skyzyx/geolocation.alfredworkflow)
* [Mimetypes](https://github.com/skyzyx/mimetypes.alfredworkflow)

CHANGELOG
=========

2.1.0
-----

 * added TraceableEventDispatcherInterface
 * added ContainerAwareEventDispatcher
 * added a reference to the EventDispatcher on the Event
 * added a reference to the Event name on the event
 * added fluid interface to the dispatch() method which now returns the Event
   object
 * added GenericEvent event class
 * added the possibility for subscribers to subscribe several times for the
   same event
 * added ImmutableEventDispatcher

EventDispatcher Component
=========================

EventDispatcher implements a lightweight version of the Observer design
pattern.

    use Symfony\Component\EventDispatcher\EventDispatcher;
    use Symfony\Component\EventDispatcher\Event;

    $dispatcher = new EventDispatcher();

    $dispatcher->addListener('event_name', function (Event $event) {
        // ...
    });

    $dispatcher->dispatch('event_name');

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/EventDispatcher/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.3.0
-----

 * added the dumpFile() method to atomically write files
 
2.2.0
-----

 * added a delete option for the mirror() method

2.1.0
-----

 * 24eb396 : BC Break : mkdir() function now throws exception in case of failure instead of returning Boolean value
 * created the component

Filesystem Component
====================

Filesystem provides basic utility to manipulate the file system:

```php
<?php

use Symfony\Component\Filesystem\Filesystem;

$filesystem = new Filesystem();

$filesystem->copy($originFile, $targetFile, $override = false);

$filesystem->mkdir($dirs, $mode = 0777);

$filesystem->touch($files, $time = null, $atime = null);

$filesystem->remove($files);

$filesystem->chmod($files, $mode, $umask = 0000, $recursive = false);

$filesystem->chown($files, $user, $recursive = false);

$filesystem->chgrp($files, $group, $recursive = false);

$filesystem->rename($origin, $target);

$filesystem->symlink($originDir, $targetDir, $copyOnWindows = false);

$filesystem->makePathRelative($endPath, $startPath);

$filesystem->mirror($originDir, $targetDir, \Traversable $iterator = null, $options = array());

$filesystem->isAbsolutePath($file);
```

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/Filesystem/
    $ composer.phar install --dev
    $ phpunit

CHANGELOG
=========

2.3.0
-----

 * added ProcessUtils::escapeArgument() to fix the bug in escapeshellarg() function on Windows
 * added Process::signal()
 * added Process::getPid()
 * added support for a TTY mode

2.2.0
-----

 * added ProcessBuilder::setArguments() to reset the arguments on a builder
 * added a way to retrieve the standard and error output incrementally
 * added Process:restart()

2.1.0
-----

 * added support for non-blocking processes (start(), wait(), isRunning(), stop())
 * enhanced Windows compatibility
 * added Process::getExitCodeText() that returns a string representation for
   the exit code returned by the process
 * added ProcessBuilder

Process Component
=================

Process executes commands in sub-processes.

In this example, we run a simple directory listing and get the result back:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->setTimeout(3600);
    $process->run();
    if (!$process->isSuccessful()) {
        throw new RuntimeException($process->getErrorOutput());
    }

    print $process->getOutput();

You can think that this is easy to achieve with plain PHP but it's not especially
if you want to take care of the subtle differences between the different platforms.

And if you want to be able to get some feedback in real-time, just pass an
anonymous function to the ``run()`` method and you will get the output buffer
as it becomes available:

    use Symfony\Component\Process\Process;

    $process = new Process('ls -lsa');
    $process->run(function ($type, $buffer) {
        if ('err' === $type) {
            echo 'ERR > '.$buffer;
        } else {
            echo 'OUT > '.$buffer;
        }
    });

That's great if you want to execute a long running command (like rsync-ing files to a
remote server) and give feedback to the user in real-time.

Resources
---------

You can run the unit tests with the following command:

    $ cd path/to/Symfony/Component/XXX/
    $ composer.phar install --dev
    $ phpunit

Alfred 2 Ruby Framework
======================

A framework for Alfred 2 workflow development in Ruby.

Main features:
- Shows exceptions and debug output in the Mac OS X Console
- Adds a ruby gems repository to the workflow bundle so you can package gems
  with your workflow.
- Provides access to the workflow bundle's info.plist data
- Provides sqlite3 gem

License
=======

CCBY - Creative Commons Attribution 2.0 Generic
http://creativecommons.org/licenses/by/2.0/

<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>File: README.rdoc</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



  <div id="fileHeader">
    <h1>README.rdoc</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>README.rdoc
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Thu Jan 31 19:03:07 -0700 2013</td>
    </tr>
    </table>
  </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="../classes/JSON.html">JSON</a> implementation for Ruby <a href="http://travis-ci.org/flori/json"><img src="https://secure.travis-ci.org/flori/json.png" /></a></h1>
<h2>Description</h2>
<p>
This is a implementation of the <a href="../classes/JSON.html">JSON</a>
specification according to RFC 4627 <a
href="http://www.ietf.org/rfc/rfc4627.txt">www.ietf.org/rfc/rfc4627.txt</a>
. Starting from version 1.0.0 on there will be two variants available:
</p>
<ul>
<li>A pure ruby variant, that relies on the iconv and the stringscan
extensions, which are both part of the ruby standard library.

</li>
<li>The quite a bit faster C extension variant, which is in parts implemented
in C and comes with its own unicode conversion functions and a parser
generated by the ragel state machine compiler <a
href="http://www.cs.queensu.ca/~thurston/ragel">www.cs.queensu.ca/~thurston/ragel</a>
.

</li>
</ul>
<p>
Both variants of the <a href="../classes/JSON.html">JSON</a> generator
generate UTF-8 character sequences by default. If an :ascii_only option
with a true value is given, they escape all non-ASCII and control
characters with \uXXXX escape sequences, and support UTF-16 surrogate pairs
in order to be able to generate the whole range of unicode code points.
</p>
<p>
All strings, that are to be encoded as <a
href="../classes/JSON.html">JSON</a> strings, should be UTF-8 byte
sequences on the Ruby side. To encode raw binary strings, that aren&#8216;t
UTF-8 encoded, please use the to_json_raw_object method of String (which
produces an object, that contains a byte array) and decode the result on
the receiving endpoint.
</p>
<p>
The <a href="../classes/JSON.html">JSON</a> parsers can parse UTF-8,
UTF-16BE, UTF-16LE, UTF-32BE, and UTF-32LE <a
href="../classes/JSON.html">JSON</a> documents under Ruby 1.8. Under Ruby
1.9 they take advantage of Ruby&#8216;s M17n features and can parse all
documents which have the correct String#encoding set. If a document string
has ASCII-8BIT as an encoding the parser attempts to figure out which of
the UTF encodings from above it is and trys to parse it.
</p>
<h2>Installation</h2>
<p>
It&#8216;s recommended to use the extension variant of <a
href="../classes/JSON.html">JSON</a>, because it&#8216;s faster than the
pure ruby variant. If you cannot build it on your system, you can settle
for the latter.
</p>
<p>
Just type into the command line as root:
</p>
<pre>
  # rake install
</pre>
<p>
The above command will build the extensions and install them on your
system.
</p>
<pre>
  # rake install_pure
</pre>
<p>
or
</p>
<pre>
  # ruby install.rb
</pre>
<p>
will just install the pure ruby implementation of <a
href="../classes/JSON.html">JSON</a>.
</p>
<p>
If you use Rubygems you can type
</p>
<pre>
  # gem install json
</pre>
<p>
instead, to install the newest <a href="../classes/JSON.html">JSON</a>
version.
</p>
<p>
There is also a pure ruby json only variant of the gem, that can be
installed with:
</p>
<pre>
  # gem install json_pure
</pre>
<h2>Compiling the extensions yourself</h2>
<p>
If you want to build the extensions yourself you need rake:
</p>
<pre>
  You can get it from rubyforge:
    http://rubyforge.org/projects/rake

  or just type

  # gem install rake

  for the installation via rubygems.
</pre>
<p>
If you want to create the parser.c file from its parser.rl file or draw
nice graphviz images of the state machines, you need ragel from: <a
href="http://www.cs.queensu.ca/~thurston/ragel">www.cs.queensu.ca/~thurston/ragel</a>
</p>
<h2>Usage</h2>
<p>
To use <a href="../classes/JSON.html">JSON</a> you can
</p>
<pre>
  require 'json'
</pre>
<p>
to load the installed variant (either the extension &#8216;json&#8217; or
the pure variant &#8216;json_pure&#8217;). If you have installed the
extension variant, you can pick either the extension variant or the pure
variant by typing
</p>
<pre>
  require 'json/ext'
</pre>
<p>
or
</p>
<pre>
  require 'json/pure'
</pre>
<p>
Now you can parse a <a href="../classes/JSON.html">JSON</a> document into a
ruby data structure by calling
</p>
<pre>
  JSON.parse(document)
</pre>
<p>
If you want to generate a <a href="../classes/JSON.html">JSON</a> document
from a ruby data structure call
</p>
<pre>
  JSON.generate(data)
</pre>
<p>
You can also use the pretty_generate method (which formats the output more
verbosely and nicely) or fast_generate (which doesn&#8216;t do any of the
security checks generate performs, e. g. nesting deepness checks).
</p>
<p>
To create a valid <a href="../classes/JSON.html">JSON</a> document you have
to make sure, that the output is embedded in either a <a
href="../classes/JSON.html">JSON</a> array [] or a <a
href="../classes/JSON.html">JSON</a> object {}. The easiest way to do this,
is by putting your values in a Ruby Array or Hash instance.
</p>
<p>
There are also the <a href="../classes/JSON.html">JSON</a> and <a
href="../classes/JSON.html">JSON</a>[] methods which use parse on a String
or generate a <a href="../classes/JSON.html">JSON</a> document from an
array or hash:
</p>
<pre>
  document = JSON 'test'  =&gt; 23 # =&gt; &quot;{\&quot;test\&quot;:23}&quot;
  document = JSON['test'] =&gt; 23 # =&gt; &quot;{\&quot;test\&quot;:23}&quot;
</pre>
<p>
and
</p>
<pre>
  data = JSON '{&quot;test&quot;:23}'  # =&gt; {&quot;test&quot;=&gt;23}
  data = JSON['{&quot;test&quot;:23}'] # =&gt; {&quot;test&quot;=&gt;23}
</pre>
<p>
You can choose to load a set of common additions to ruby core&#8216;s
objects if you
</p>
<pre>
  require 'json/add/core'
</pre>
<p>
After requiring this you can, e. g., serialise/deserialise Ruby ranges:
</p>
<pre>
  JSON JSON(1..10) # =&gt; 1..10
</pre>
<p>
To find out how to add <a href="../classes/JSON.html">JSON</a> support to
other or your own classes, read the section &quot;More Examples&quot;
below.
</p>
<p>
To get the best compatibility to rails&#8217; <a
href="../classes/JSON.html">JSON</a> implementation, you can
</p>
<pre>
  require 'json/add/rails'
</pre>
<p>
Both of the additions attempt to require &#8216;json&#8217; (like above)
first, if it has not been required yet.
</p>
<h2>More Examples</h2>
<p>
To create a <a href="../classes/JSON.html">JSON</a> document from a ruby
data structure, you can call <a
href="../classes/JSON.html#M000041">JSON.generate</a> like that:
</p>
<pre>
 json = JSON.generate [1, 2, {&quot;a&quot;=&gt;3.141}, false, true, nil, 4..10]
 # =&gt; &quot;[1,2,{\&quot;a\&quot;:3.141},false,true,null,\&quot;4..10\&quot;]&quot;
</pre>
<p>
To get back a ruby data structure from a <a
href="../classes/JSON.html">JSON</a> document, you have to call <a
href="../classes/JSON.html#M000039">JSON.parse</a> on it:
</p>
<pre>
 JSON.parse json
 # =&gt; [1, 2, {&quot;a&quot;=&gt;3.141}, false, true, nil, &quot;4..10&quot;]
</pre>
<p>
Note, that the range from the original data structure is a simple string
now. The reason for this is, that <a href="../classes/JSON.html">JSON</a>
doesn&#8216;t support ranges or arbitrary classes. In this case the json
library falls back to call Object#to_json, which is the same as
to_s.to_json.
</p>
<p>
It&#8216;s possible to add <a href="../classes/JSON.html">JSON</a> support
serialization to arbitrary classes by simply implementing a more
specialized version of the to_json method, that should return a <a
href="../classes/JSON.html">JSON</a> object (a hash converted to <a
href="../classes/JSON.html">JSON</a> with to_json) like this (don&#8216;t
forget the *a for all the arguments):
</p>
<pre>
 class Range
   def to_json(*a)
     {
       'json_class'   =&gt; self.class.name, # = 'Range'
       'data'         =&gt; [ first, last, exclude_end? ]
     }.to_json(*a)
   end
 end
</pre>
<p>
The hash key &#8216;json_class&#8217; is the class, that will be asked to
deserialise the <a href="../classes/JSON.html">JSON</a> representation
later. In this case it&#8216;s &#8216;<a
href="../classes/Range.html">Range</a>&#8217;, but any namespace of the
form &#8216;A::B&#8217; or &#8217;::A::B&#8217; will do. All other keys are
arbitrary and can be used to store the necessary data to configure the
object to be deserialised.
</p>
<p>
If a the key &#8216;json_class&#8217; is found in a <a
href="../classes/JSON.html">JSON</a> object, the <a
href="../classes/JSON.html">JSON</a> parser checks if the given class
responds to the json_create class method. If so, it is called with the <a
href="../classes/JSON.html">JSON</a> object converted to a Ruby hash. So a
range can be deserialised by implementing <a
href="../classes/Range.html#M000035">Range.json_create</a> like this:
</p>
<pre>
 class Range
   def self.json_create(o)
     new(*o['data'])
   end
 end
</pre>
<p>
Now it possible to serialise/deserialise ranges as well:
</p>
<pre>
 json = JSON.generate [1, 2, {&quot;a&quot;=&gt;3.141}, false, true, nil, 4..10]
 # =&gt; &quot;[1,2,{\&quot;a\&quot;:3.141},false,true,null,{\&quot;json_class\&quot;:\&quot;Range\&quot;,\&quot;data\&quot;:[4,10,false]}]&quot;
 JSON.parse json
 # =&gt; [1, 2, {&quot;a&quot;=&gt;3.141}, false, true, nil, 4..10]
</pre>
<p>
<a href="../classes/JSON.html#M000041">JSON.generate</a> always creates the
shortest possible string representation of a ruby data structure in one
line. This is good for data storage or network protocols, but not so good
for humans to read. Fortunately there&#8216;s also <a
href="../classes/JSON.html#M000043">JSON.pretty_generate</a> (or <a
href="../classes/JSON.html#M000043">JSON.pretty_generate</a>) that creates
a more readable output:
</p>
<pre>
 puts JSON.pretty_generate([1, 2, {&quot;a&quot;=&gt;3.141}, false, true, nil, 4..10])
 [
   1,
   2,
   {
     &quot;a&quot;: 3.141
   },
   false,
   true,
   null,
   {
     &quot;json_class&quot;: &quot;Range&quot;,
     &quot;data&quot;: [
       4,
       10,
       false
     ]
   }
 ]
</pre>
<p>
There are also the methods Kernel#j for generate, and Kernel#jj for
pretty_generate output to the console, that work analogous to Core
Ruby&#8216;s p and the pp library&#8216;s pp methods.
</p>
<p>
The script tools/server.rb contains a small example if you want to test,
how receiving a <a href="../classes/JSON.html">JSON</a> object from a
webrick server in your browser with the javasript prototype library <a
href="http://www.prototypejs.org">www.prototypejs.org</a> works.
</p>
<h2>Speed Comparisons</h2>
<p>
I have created some benchmark results (see the benchmarks/data-p4-3Ghz
subdir of the package) for the <a
href="../classes/JSON.html">JSON</a>-parser to estimate the speed up in the
C extension:
</p>
<pre>
 Comparing times (call_time_mean):
  1 ParserBenchmarkExt#parser   900 repeats:
        553.922304770 (  real) -&gt;   21.500x
          0.001805307
  2 ParserBenchmarkYAML#parser  1000 repeats:
        224.513358139 (  real) -&gt;    8.714x
          0.004454078
  3 ParserBenchmarkPure#parser  1000 repeats:
         26.755020642 (  real) -&gt;    1.038x
          0.037376163
  4 ParserBenchmarkRails#parser 1000 repeats:
         25.763381731 (  real) -&gt;    1.000x
          0.038814780
            calls/sec (  time) -&gt;    speed  covers
            secs/call
</pre>
<p>
In the table above 1 is JSON::Ext::Parser, 2 is YAML.load with YAML
compatbile <a href="../classes/JSON.html">JSON</a> document, 3 is is <a
href="../classes/JSON/Pure/Parser.html">JSON::Pure::Parser</a>, and 4 is
ActiveSupport::JSON.decode. The ActiveSupport <a
href="../classes/JSON.html">JSON</a>-decoder converts the input first to
YAML and then uses the YAML-parser, the conversion seems to slow it down so
much that it is only as fast as the <a
href="../classes/JSON/Pure/Parser.html">JSON::Pure::Parser</a>!
</p>
<p>
If you look at the benchmark data you can see that this is mostly caused by
the frequent high outliers - the median of the Rails-parser runs is still
overall smaller than the median of the <a
href="../classes/JSON/Pure/Parser.html">JSON::Pure::Parser</a> runs:
</p>
<pre>
 Comparing times (call_time_median):
  1 ParserBenchmarkExt#parser   900 repeats:
        800.592479481 (  real) -&gt;   26.936x
          0.001249075
  2 ParserBenchmarkYAML#parser  1000 repeats:
        271.002390644 (  real) -&gt;    9.118x
          0.003690004
  3 ParserBenchmarkRails#parser 1000 repeats:
         30.227910865 (  real) -&gt;    1.017x
          0.033082008
  4 ParserBenchmarkPure#parser  1000 repeats:
         29.722384421 (  real) -&gt;    1.000x
          0.033644676
            calls/sec (  time) -&gt;    speed  covers
            secs/call
</pre>
<p>
I have benchmarked the <a href="../classes/JSON.html">JSON</a>-Generator as
well. This generated a few more values, because there are different modes
that also influence the achieved speed:
</p>
<pre>
 Comparing times (call_time_mean):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        547.354332608 (  real) -&gt;   15.090x
          0.001826970
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        443.968212317 (  real) -&gt;   12.240x
          0.002252414
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        375.104545883 (  real) -&gt;   10.341x
          0.002665923
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         49.978706968 (  real) -&gt;    1.378x
          0.020008521
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         38.531868759 (  real) -&gt;    1.062x
          0.025952543
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         36.927649925 (  real) -&gt;    1.018x 7 (&gt;=3859)
          0.027079979
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         36.272134441 (  real) -&gt;    1.000x 6 (&gt;=3859)
          0.027569373
            calls/sec (  time) -&gt;    speed  covers
            secs/call
</pre>
<p>
In the table above 1-3 are JSON::Ext::Generator methods. 4, 6, and 7 are <a
href="../classes/JSON/Pure/Generator.html">JSON::Pure::Generator</a>
methods and 5 is the Rails <a href="../classes/JSON.html">JSON</a>
generator. It is now a bit faster than the generator_safe and
generator_pretty methods of the pure variant but slower than the others.
</p>
<p>
To achieve the fastest <a href="../classes/JSON.html">JSON</a> document
output, you can use the fast_generate method. Beware, that this will
disable the checking for circular Ruby data structures, which may cause <a
href="../classes/JSON.html">JSON</a> to go into an infinite loop.
</p>
<p>
Here are the median comparisons for completeness&#8217; sake:
</p>
<pre>
 Comparing times (call_time_median):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        708.258020939 (  real) -&gt;   16.547x
          0.001411915
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        569.105020353 (  real) -&gt;   13.296x
          0.001757145
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        482.825371244 (  real) -&gt;   11.280x
          0.002071142
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         62.717626652 (  real) -&gt;    1.465x
          0.015944481
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         43.965681162 (  real) -&gt;    1.027x
          0.022745013
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         43.929073409 (  real) -&gt;    1.026x 7 (&gt;=3859)
          0.022763968
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         42.802514491 (  real) -&gt;    1.000x 6 (&gt;=3859)
          0.023363113
            calls/sec (  time) -&gt;    speed  covers
            secs/call
</pre>
<h2>Author</h2>
<p>
Florian Frank &lt;<a href="mailto:flori@ping.de">flori@ping.de</a>&gt;
</p>
<h2>License</h2>
<p>
Ruby License, see the COPYING file included in the source distribution. The
Ruby License includes the GNU General Public License (GPL), Version 2, so
see the file GPL as well.
</p>
<h2>Download</h2>
<p>
The latest version of this library can be downloaded at
</p>
<ul>
<li><a
href="http://rubyforge.org/frs?group_id=953">rubyforge.org/frs?group_id=953</a>

</li>
</ul>
<p>
Online Documentation should be located at
</p>
<ul>
<li><a href="http://json.rubyforge.org">json.rubyforge.org</a>

</li>
</ul>

    </div>


   </div>


  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>
<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>File: README.rdoc</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



  <div id="fileHeader">
    <h1>README.rdoc</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>README.rdoc
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Thu Jan 31 11:57:40 -0700 2013</td>
    </tr>
    </table>
  </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="../classes/SQLite3.html">SQLite3</a>/Ruby Interface</h1>
<ul>
<li><a
href="http://github.com/luislavena/sqlite3-ruby">github.com/luislavena/sqlite3-ruby</a>

</li>
<li><a
href="http://groups.google.com/group/sqlite3-ruby">groups.google.com/group/sqlite3-ruby</a>

</li>
</ul>
<h2>DESCRIPTION</h2>
<p>
This module allows Ruby programs to interface with the <a
href="../classes/SQLite3.html">SQLite3</a> database engine (<a
href="http://www.sqlite.org">www.sqlite.org</a>). You must have the SQLite
engine installed in order to build this module.
</p>
<p>
Note that this module is only compatible with SQLite 3.6.16 or newer.
</p>
<h2>SYNOPSIS</h2>
<pre>
  require &quot;sqlite3&quot;

  # Open a database
  db = SQLite3::Database.new &quot;test.db&quot;

  # Create a database
  rows = db.execute &lt;&lt;-SQL
    create table numbers (
      name varchar(30),
      val int
    );
  SQL

  # Execute a few inserts
  {
    &quot;one&quot; =&gt; 1,
    &quot;two&quot; =&gt; 2,
  }.each do |pair|
    db.execute &quot;insert into numbers values ( ?, ? )&quot;, pair
  end

  # Find a few rows
  db.execute( &quot;select * from numbers&quot; ) do |row|
    p row
  end
</pre>
<h2>Compilation and Installation</h2>
<p>
Install <a href="../classes/SQLite3.html">SQLite3</a>, enabling the option
SQLITE_ENABLE_COLUMN_METADATA (see <a
href="http://www.sqlite.org/compile.html">www.sqlite.org/compile.html</a>
for details).
</p>
<p>
Then do the following:
</p>
<pre>
  ruby setup.rb config
  ruby setup.rb setup
  ruby setup.rb install
</pre>
<p>
Alternatively, you can download and install the RubyGem package for <a
href="../classes/SQLite3.html">SQLite3</a>/Ruby (you must have RubyGems and
<a href="../classes/SQLite3.html">SQLite3</a> installed, first):
</p>
<pre>
  gem install sqlite3
</pre>
<p>
If you have sqlite3 installed in a non-standard location, you can specify
the location of the include and lib files by doing:
</p>
<pre>
  gem install sqlite3 -- --with-sqlite3-include=/opt/local/include \
     --with-sqlite3-lib=/opt/local/lib
</pre>
<h1>SUPPORT!!!</h1>
<h2>OMG! Something has gone wrong! Where do I get help?</h2>
<p>
The best place to get help is from the <a
href="http://groups.google.com/group/sqlite3-ruby">sqlite3-ruby mailing
list</a> which can be found here:
</p>
<pre>
  * http://groups.google.com/group/sqlite3-ruby
</pre>
<h2>I&#8216;ve found a bug! Where do I file it?</h2>
<p>
Uh oh. After contacting the mailing list, you&#8216;ve found that
you&#8216;ve actually discovered a bug. You can file the bug at the <a
href="http://github.com/luislavena/sqlite3-ruby/issues">github issues
page</a> which can be found here:
</p>
<pre>
  * http://github.com/luislavena/sqlite3-ruby/issues
</pre>
<h2>Usage</h2>
<p>
For help figuring out the <a
href="../classes/SQLite3.html">SQLite3</a>/Ruby interface, check out the
SYNOPSIS as well as the RDoc. It includes examples of usage. If you have
any questions that you feel should be address in the FAQ, please send them
to <a href="http://groups.google.com/group/sqlite3-ruby">the mailing
list</a>
</p>
<h2>Source Code</h2>
<p>
The source repository is accessible via git:
</p>
<pre>
  git clone git://github.com/luislavena/sqlite3-ruby.git
</pre>

    </div>


   </div>


  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>

= Google Search

Fast, feature rich Google Search client. Search web results, images,
books, local, patents, blogs and news using an elegant Ruby API with
only a single dependency.

== Dependencies 

* json gem

== Features

* Fast
* Lazy Enumeration (requests more results from google, not all at once)
* Populates Google::Search::Item's blog, book, image, local, news, patent, video, and web
* Clean, well documented source code
* Full test coverage

== Classes

  - Google::Search                  | superclass of all other search classes. Is Enumerable
  - Google::Search::Web             | web search.
  - Google::Search::Blog            | blog search.
  - Google::Search::Book            | book search.
  - Google::Search::Image           | image search.
  - Google::Search::Local           | local search.
  - Google::Search::News            | news search.
  - Google::Search::Patent          | patent search.
  - Google::Search::Video           | video search.
  - Google::Search::Response        | single request response, containing items. Is Enumerable
  - Google::Search::Item            | single item, superclass of all other items.
  - Google::Search::Item::Web       | single item containing web specific data.
  - Google::Search::Item::Blog      | single item containing blog specific data.
  - Google::Search::Item::Book      | single item containing book specific data.
  - Google::Search::Item::Image     | single item containing image specific data.
  - Google::Search::Item::Local     | single item containing local specific data.
  - Google::Search::Item::News      | single item containing news specific data.
  - Google::Search::Item::Patent    | single item containing patent specific data.
  - Google::Search::Item::Video     | single item containing video specific data.

== Arbitrary Query String Support

Arbitrary key / value pairs may be passed to Google::Search.new, all options
passed that are not assigned (deleted) will pass on to be part of the query string. 

For argument reference visit: http://code.google.com/apis/ajaxsearch/documentation/reference.html#_fonje_web
  
== Items

Each item type (web, image, etc) is a subclass of Google::Search::Item,
whose constant is Google::Search::Item::{Web, Image, Blog, etc}. Every aspect
of google-search is well documented, so poke around to learn more or view
spec/item_spec.rb for item attributes.

== Image example

Below we simply create a new :image search, and pass a :query string.
Query strings are urlencoded when Search#get_uri is called, so there
is no reason to do so manually.

  File.open('path/to/images.html', 'w+') do |file|
    Google::Search::Image.new(:query => 'Cookies').each do |image|
      file.write %(<img src="#{image.uri}">)
    end
  end
  
== More Information

* View the source :) 

== License:

(The MIT License)

Copyright (c) 2009 TJ Holowaychuk <tj@vision-media.ca>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
'Software'), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, an d/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

JSON-JRuby
==========

JSON-JRuby is a port of Florian Frank's native
[`json` library](http://json.rubyforge.org/) to JRuby.
It aims to be a perfect drop-in replacement for `json_pure`.


Development version
===================

The latest version is available from the
[Git repository](http://github.com/mernen/json-jruby/tree):

    git clone git://github.com/mernen/json-jruby.git


Compiling
=========

You'll need JRuby version 1.2 or greater to build JSON-JRuby.
Its path must be set on the `jruby.dir` property of
`nbproject/project.properties` (defaults to `../jruby`).

Additionally, you'll need [Ant](http://ant.apache.org/), and
[Ragel](http://www.cs.queensu.ca/~thurston/ragel/) 6.4 or greater.

Then, from the folder where the sources are located, type:

    ant clean jar

to clean any leftovers from previous builds and generate the `.jar` files.
To generate a RubyGem, specify the `gem` action rather than `jar`.

= JSON implementation for Ruby {<img src="https://secure.travis-ci.org/flori/json.png" />}[http://travis-ci.org/flori/json]

== Description

This is a implementation of the JSON specification according to RFC 4627
http://www.ietf.org/rfc/rfc4627.txt . Starting from version 1.0.0 on there
will be two variants available:

* A pure ruby variant, that relies on the iconv and the stringscan
  extensions, which are both part of the ruby standard library.
* The quite a bit faster C extension variant, which is in parts implemented
  in C and comes with its own unicode conversion functions and a parser
  generated by the ragel state machine compiler
  http://www.cs.queensu.ca/~thurston/ragel .

Both variants of the JSON generator generate UTF-8 character sequences by
default. If an :ascii_only option with a true value is given, they escape all
non-ASCII and control characters with \uXXXX escape sequences, and support
UTF-16 surrogate pairs in order to be able to generate the whole range of
unicode code points.

All strings, that are to be encoded as JSON strings, should be UTF-8 byte
sequences on the Ruby side. To encode raw binary strings, that aren't UTF-8
encoded, please use the to_json_raw_object method of String (which produces
an object, that contains a byte array) and decode the result on the receiving
endpoint.

The JSON parsers can parse UTF-8, UTF-16BE, UTF-16LE, UTF-32BE, and UTF-32LE
JSON documents under Ruby 1.8. Under Ruby 1.9 they take advantage of Ruby's
M17n features and can parse all documents which have the correct
String#encoding set. If a document string has ASCII-8BIT as an encoding the
parser attempts to figure out which of the UTF encodings from above it is and
trys to parse it.

== Installation

It's recommended to use the extension variant of JSON, because it's faster than
the pure ruby variant. If you cannot build it on your system, you can settle
for the latter.

Just type into the command line as root:

  # rake install

The above command will build the extensions and install them on your system.

  # rake install_pure

or

  # ruby install.rb

will just install the pure ruby implementation of JSON.

If you use Rubygems you can type

  # gem install json

instead, to install the newest JSON version.

There is also a pure ruby json only variant of the gem, that can be installed
with:

  # gem install json_pure

== Compiling the extensions yourself

If you want to build the extensions yourself you need rake:

  You can get it from rubyforge:
    http://rubyforge.org/projects/rake

  or just type

  # gem install rake

  for the installation via rubygems.

If you want to create the parser.c file from its parser.rl file or draw nice
graphviz images of the state machines, you need ragel from: http://www.cs.queensu.ca/~thurston/ragel


== Usage

To use JSON you can
  require 'json'
to load the installed variant (either the extension 'json' or the pure
variant 'json_pure'). If you have installed the extension variant, you can
pick either the extension variant or the pure variant by typing
  require 'json/ext'
or
  require 'json/pure'

Now you can parse a JSON document into a ruby data structure by calling

  JSON.parse(document)

If you want to generate a JSON document from a ruby data structure call
  JSON.generate(data)

You can also use the pretty_generate method (which formats the output more
verbosely and nicely) or fast_generate (which doesn't do any of the security
checks generate performs, e. g. nesting deepness checks).

To create a valid JSON document you have to make sure, that the output is
embedded in either a JSON array [] or a JSON object {}. The easiest way to do
this, is by putting your values in a Ruby Array or Hash instance.

There are also the JSON and JSON[] methods which use parse on a String or
generate a JSON document from an array or hash:

  document = JSON 'test'  => 23 # => "{\"test\":23}"
  document = JSON['test'] => 23 # => "{\"test\":23}"

and

  data = JSON '{"test":23}'  # => {"test"=>23}
  data = JSON['{"test":23}'] # => {"test"=>23}

You can choose to load a set of common additions to ruby core's objects if
you
  require 'json/add/core'

After requiring this you can, e. g., serialise/deserialise Ruby ranges:

  JSON JSON(1..10) # => 1..10

To find out how to add JSON support to other or your own classes, read the
section "More Examples" below.

To get the best compatibility to rails' JSON implementation, you can
  require 'json/add/rails'

Both of the additions attempt to require 'json' (like above) first, if it has
not been required yet.

== More Examples

To create a JSON document from a ruby data structure, you can call
JSON.generate like that:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,\"4..10\"]"

To get back a ruby data structure from a JSON document, you have to call
JSON.parse on it:

 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, "4..10"]

Note, that the range from the original data structure is a simple
string now. The reason for this is, that JSON doesn't support ranges
or arbitrary classes. In this case the json library falls back to call
Object#to_json, which is the same as #to_s.to_json.

It's possible to add JSON support serialization to arbitrary classes by
simply implementing a more specialized version of the #to_json method, that
should return a JSON object (a hash converted to JSON with #to_json) like
this (don't forget the *a for all the arguments):

 class Range
   def to_json(*a)
     {
       'json_class'   => self.class.name, # = 'Range'
       'data'         => [ first, last, exclude_end? ]
     }.to_json(*a)
   end
 end

The hash key 'json_class' is the class, that will be asked to deserialise the
JSON representation later. In this case it's 'Range', but any namespace of
the form 'A::B' or '::A::B' will do. All other keys are arbitrary and can be
used to store the necessary data to configure the object to be deserialised.

If a the key 'json_class' is found in a JSON object, the JSON parser checks
if the given class responds to the json_create class method. If so, it is
called with the JSON object converted to a Ruby hash. So a range can
be deserialised by implementing Range.json_create like this:

 class Range
   def self.json_create(o)
     new(*o['data'])
   end
 end

Now it possible to serialise/deserialise ranges as well:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,{\"json_class\":\"Range\",\"data\":[4,10,false]}]"
 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, 4..10]

JSON.generate always creates the shortest possible string representation of a
ruby data structure in one line. This is good for data storage or network
protocols, but not so good for humans to read. Fortunately there's also
JSON.pretty_generate (or JSON.pretty_generate) that creates a more readable
output:

 puts JSON.pretty_generate([1, 2, {"a"=>3.141}, false, true, nil, 4..10])
 [
   1,
   2,
   {
     "a": 3.141
   },
   false,
   true,
   null,
   {
     "json_class": "Range",
     "data": [
       4,
       10,
       false
     ]
   }
 ]

There are also the methods Kernel#j for generate, and Kernel#jj for
pretty_generate output to the console, that work analogous to Core Ruby's p and
the pp library's pp methods.

The script tools/server.rb contains a small example if you want to test, how
receiving a JSON object from a webrick server in your browser with the
javasript prototype library http://www.prototypejs.org works.

== Speed Comparisons

I have created some benchmark results (see the benchmarks/data-p4-3Ghz
subdir of the package) for the JSON-parser to estimate the speed up in the C
extension:

 Comparing times (call_time_mean):
  1 ParserBenchmarkExt#parser   900 repeats:
        553.922304770 (  real) ->   21.500x 
          0.001805307
  2 ParserBenchmarkYAML#parser  1000 repeats:
        224.513358139 (  real) ->    8.714x 
          0.004454078
  3 ParserBenchmarkPure#parser  1000 repeats:
         26.755020642 (  real) ->    1.038x 
          0.037376163
  4 ParserBenchmarkRails#parser 1000 repeats:
         25.763381731 (  real) ->    1.000x 
          0.038814780
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1 is JSON::Ext::Parser, 2 is YAML.load with YAML
compatbile JSON document, 3 is is JSON::Pure::Parser, and 4 is
ActiveSupport::JSON.decode. The ActiveSupport JSON-decoder converts the
input first to YAML and then uses the YAML-parser, the conversion seems to
slow it down so much that it is only as fast as the JSON::Pure::Parser!

If you look at the benchmark data you can see that this is mostly caused by
the frequent high outliers - the median of the Rails-parser runs is still
overall smaller than the median of the JSON::Pure::Parser runs:

 Comparing times (call_time_median):
  1 ParserBenchmarkExt#parser   900 repeats:
        800.592479481 (  real) ->   26.936x 
          0.001249075
  2 ParserBenchmarkYAML#parser  1000 repeats:
        271.002390644 (  real) ->    9.118x 
          0.003690004
  3 ParserBenchmarkRails#parser 1000 repeats:
         30.227910865 (  real) ->    1.017x 
          0.033082008
  4 ParserBenchmarkPure#parser  1000 repeats:
         29.722384421 (  real) ->    1.000x 
          0.033644676
            calls/sec (  time) ->    speed  covers
            secs/call

I have benchmarked the JSON-Generator as well. This generated a few more
values, because there are different modes that also influence the achieved
speed:

 Comparing times (call_time_mean):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        547.354332608 (  real) ->   15.090x 
          0.001826970
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        443.968212317 (  real) ->   12.240x 
          0.002252414
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        375.104545883 (  real) ->   10.341x 
          0.002665923
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         49.978706968 (  real) ->    1.378x 
          0.020008521
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         38.531868759 (  real) ->    1.062x 
          0.025952543
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         36.927649925 (  real) ->    1.018x 7 (>=3859)
          0.027079979
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         36.272134441 (  real) ->    1.000x 6 (>=3859)
          0.027569373
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1-3 are JSON::Ext::Generator methods. 4, 6, and 7 are
JSON::Pure::Generator methods and 5 is the Rails JSON generator. It is now a
bit faster than the generator_safe and generator_pretty methods of the pure
variant but slower than the others.

To achieve the fastest JSON document output, you can use the fast_generate
method. Beware, that this will disable the checking for circular Ruby data
structures, which may cause JSON to go into an infinite loop.

Here are the median comparisons for completeness' sake:

 Comparing times (call_time_median):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        708.258020939 (  real) ->   16.547x 
          0.001411915
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        569.105020353 (  real) ->   13.296x 
          0.001757145
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        482.825371244 (  real) ->   11.280x 
          0.002071142
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         62.717626652 (  real) ->    1.465x 
          0.015944481
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         43.965681162 (  real) ->    1.027x 
          0.022745013
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         43.929073409 (  real) ->    1.026x 7 (>=3859)
          0.022763968
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         42.802514491 (  real) ->    1.000x 6 (>=3859)
          0.023363113
            calls/sec (  time) ->    speed  covers
            secs/call

== Author

Florian Frank <mailto:flori@ping.de>

== License

Ruby License, see the COPYING file included in the source distribution. The
Ruby License includes the GNU General Public License (GPL), Version 2, so see
the file GPL as well.

== Download

The latest version of this library can be downloaded at

* http://rubyforge.org/frs?group_id=953

Online Documentation should be located at

* http://json.rubyforge.org

JSON-JRuby
==========

JSON-JRuby is a port of Florian Frank's native
[`json` library](http://json.rubyforge.org/) to JRuby.
It aims to be a perfect drop-in replacement for `json_pure`.


Development version
===================

The latest version is available from the
[Git repository](http://github.com/mernen/json-jruby/tree):

    git clone git://github.com/mernen/json-jruby.git


Compiling
=========

You'll need JRuby version 1.2 or greater to build JSON-JRuby.
Its path must be set on the `jruby.dir` property of
`nbproject/project.properties` (defaults to `../jruby`).

Additionally, you'll need [Ant](http://ant.apache.org/), and
[Ragel](http://www.cs.queensu.ca/~thurston/ragel/) 6.4 or greater.

Then, from the folder where the sources are located, type:

    ant clean jar

to clean any leftovers from previous builds and generate the `.jar` files.
To generate a RubyGem, specify the `gem` action rather than `jar`.

= JSON implementation for Ruby {<img src="https://secure.travis-ci.org/flori/json.png" />}[http://travis-ci.org/flori/json]

== Description

This is a implementation of the JSON specification according to RFC 4627
http://www.ietf.org/rfc/rfc4627.txt . Starting from version 1.0.0 on there
will be two variants available:

* A pure ruby variant, that relies on the iconv and the stringscan
  extensions, which are both part of the ruby standard library.
* The quite a bit faster C extension variant, which is in parts implemented
  in C and comes with its own unicode conversion functions and a parser
  generated by the ragel state machine compiler
  http://www.cs.queensu.ca/~thurston/ragel .

Both variants of the JSON generator generate UTF-8 character sequences by
default. If an :ascii_only option with a true value is given, they escape all
non-ASCII and control characters with \uXXXX escape sequences, and support
UTF-16 surrogate pairs in order to be able to generate the whole range of
unicode code points.

All strings, that are to be encoded as JSON strings, should be UTF-8 byte
sequences on the Ruby side. To encode raw binary strings, that aren't UTF-8
encoded, please use the to_json_raw_object method of String (which produces
an object, that contains a byte array) and decode the result on the receiving
endpoint.

The JSON parsers can parse UTF-8, UTF-16BE, UTF-16LE, UTF-32BE, and UTF-32LE
JSON documents under Ruby 1.8. Under Ruby 1.9 they take advantage of Ruby's
M17n features and can parse all documents which have the correct
String#encoding set. If a document string has ASCII-8BIT as an encoding the
parser attempts to figure out which of the UTF encodings from above it is and
trys to parse it.

== Installation

It's recommended to use the extension variant of JSON, because it's faster than
the pure ruby variant. If you cannot build it on your system, you can settle
for the latter.

Just type into the command line as root:

  # rake install

The above command will build the extensions and install them on your system.

  # rake install_pure

or

  # ruby install.rb

will just install the pure ruby implementation of JSON.

If you use Rubygems you can type

  # gem install json

instead, to install the newest JSON version.

There is also a pure ruby json only variant of the gem, that can be installed
with:

  # gem install json_pure

== Compiling the extensions yourself

If you want to build the extensions yourself you need rake:

  You can get it from rubyforge:
    http://rubyforge.org/projects/rake

  or just type

  # gem install rake

  for the installation via rubygems.

If you want to create the parser.c file from its parser.rl file or draw nice
graphviz images of the state machines, you need ragel from: http://www.cs.queensu.ca/~thurston/ragel


== Usage

To use JSON you can
  require 'json'
to load the installed variant (either the extension 'json' or the pure
variant 'json_pure'). If you have installed the extension variant, you can
pick either the extension variant or the pure variant by typing
  require 'json/ext'
or
  require 'json/pure'

Now you can parse a JSON document into a ruby data structure by calling

  JSON.parse(document)

If you want to generate a JSON document from a ruby data structure call
  JSON.generate(data)

You can also use the pretty_generate method (which formats the output more
verbosely and nicely) or fast_generate (which doesn't do any of the security
checks generate performs, e. g. nesting deepness checks).

To create a valid JSON document you have to make sure, that the output is
embedded in either a JSON array [] or a JSON object {}. The easiest way to do
this, is by putting your values in a Ruby Array or Hash instance.

There are also the JSON and JSON[] methods which use parse on a String or
generate a JSON document from an array or hash:

  document = JSON 'test'  => 23 # => "{\"test\":23}"
  document = JSON['test'] => 23 # => "{\"test\":23}"

and

  data = JSON '{"test":23}'  # => {"test"=>23}
  data = JSON['{"test":23}'] # => {"test"=>23}

You can choose to load a set of common additions to ruby core's objects if
you
  require 'json/add/core'

After requiring this you can, e. g., serialise/deserialise Ruby ranges:

  JSON JSON(1..10) # => 1..10

To find out how to add JSON support to other or your own classes, read the
section "More Examples" below.

To get the best compatibility to rails' JSON implementation, you can
  require 'json/add/rails'

Both of the additions attempt to require 'json' (like above) first, if it has
not been required yet.

== More Examples

To create a JSON document from a ruby data structure, you can call
JSON.generate like that:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,\"4..10\"]"

To get back a ruby data structure from a JSON document, you have to call
JSON.parse on it:

 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, "4..10"]

Note, that the range from the original data structure is a simple
string now. The reason for this is, that JSON doesn't support ranges
or arbitrary classes. In this case the json library falls back to call
Object#to_json, which is the same as #to_s.to_json.

It's possible to add JSON support serialization to arbitrary classes by
simply implementing a more specialized version of the #to_json method, that
should return a JSON object (a hash converted to JSON with #to_json) like
this (don't forget the *a for all the arguments):

 class Range
   def to_json(*a)
     {
       'json_class'   => self.class.name, # = 'Range'
       'data'         => [ first, last, exclude_end? ]
     }.to_json(*a)
   end
 end

The hash key 'json_class' is the class, that will be asked to deserialise the
JSON representation later. In this case it's 'Range', but any namespace of
the form 'A::B' or '::A::B' will do. All other keys are arbitrary and can be
used to store the necessary data to configure the object to be deserialised.

If a the key 'json_class' is found in a JSON object, the JSON parser checks
if the given class responds to the json_create class method. If so, it is
called with the JSON object converted to a Ruby hash. So a range can
be deserialised by implementing Range.json_create like this:

 class Range
   def self.json_create(o)
     new(*o['data'])
   end
 end

Now it possible to serialise/deserialise ranges as well:

 json = JSON.generate [1, 2, {"a"=>3.141}, false, true, nil, 4..10]
 # => "[1,2,{\"a\":3.141},false,true,null,{\"json_class\":\"Range\",\"data\":[4,10,false]}]"
 JSON.parse json
 # => [1, 2, {"a"=>3.141}, false, true, nil, 4..10]

JSON.generate always creates the shortest possible string representation of a
ruby data structure in one line. This is good for data storage or network
protocols, but not so good for humans to read. Fortunately there's also
JSON.pretty_generate (or JSON.pretty_generate) that creates a more readable
output:

 puts JSON.pretty_generate([1, 2, {"a"=>3.141}, false, true, nil, 4..10])
 [
   1,
   2,
   {
     "a": 3.141
   },
   false,
   true,
   null,
   {
     "json_class": "Range",
     "data": [
       4,
       10,
       false
     ]
   }
 ]

There are also the methods Kernel#j for generate, and Kernel#jj for
pretty_generate output to the console, that work analogous to Core Ruby's p and
the pp library's pp methods.

The script tools/server.rb contains a small example if you want to test, how
receiving a JSON object from a webrick server in your browser with the
javasript prototype library http://www.prototypejs.org works.

== Speed Comparisons

I have created some benchmark results (see the benchmarks/data-p4-3Ghz
subdir of the package) for the JSON-parser to estimate the speed up in the C
extension:

 Comparing times (call_time_mean):
  1 ParserBenchmarkExt#parser   900 repeats:
        553.922304770 (  real) ->   21.500x 
          0.001805307
  2 ParserBenchmarkYAML#parser  1000 repeats:
        224.513358139 (  real) ->    8.714x 
          0.004454078
  3 ParserBenchmarkPure#parser  1000 repeats:
         26.755020642 (  real) ->    1.038x 
          0.037376163
  4 ParserBenchmarkRails#parser 1000 repeats:
         25.763381731 (  real) ->    1.000x 
          0.038814780
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1 is JSON::Ext::Parser, 2 is YAML.load with YAML
compatbile JSON document, 3 is is JSON::Pure::Parser, and 4 is
ActiveSupport::JSON.decode. The ActiveSupport JSON-decoder converts the
input first to YAML and then uses the YAML-parser, the conversion seems to
slow it down so much that it is only as fast as the JSON::Pure::Parser!

If you look at the benchmark data you can see that this is mostly caused by
the frequent high outliers - the median of the Rails-parser runs is still
overall smaller than the median of the JSON::Pure::Parser runs:

 Comparing times (call_time_median):
  1 ParserBenchmarkExt#parser   900 repeats:
        800.592479481 (  real) ->   26.936x 
          0.001249075
  2 ParserBenchmarkYAML#parser  1000 repeats:
        271.002390644 (  real) ->    9.118x 
          0.003690004
  3 ParserBenchmarkRails#parser 1000 repeats:
         30.227910865 (  real) ->    1.017x 
          0.033082008
  4 ParserBenchmarkPure#parser  1000 repeats:
         29.722384421 (  real) ->    1.000x 
          0.033644676
            calls/sec (  time) ->    speed  covers
            secs/call

I have benchmarked the JSON-Generator as well. This generated a few more
values, because there are different modes that also influence the achieved
speed:

 Comparing times (call_time_mean):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        547.354332608 (  real) ->   15.090x 
          0.001826970
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        443.968212317 (  real) ->   12.240x 
          0.002252414
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        375.104545883 (  real) ->   10.341x 
          0.002665923
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         49.978706968 (  real) ->    1.378x 
          0.020008521
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         38.531868759 (  real) ->    1.062x 
          0.025952543
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         36.927649925 (  real) ->    1.018x 7 (>=3859)
          0.027079979
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         36.272134441 (  real) ->    1.000x 6 (>=3859)
          0.027569373
            calls/sec (  time) ->    speed  covers
            secs/call

In the table above 1-3 are JSON::Ext::Generator methods. 4, 6, and 7 are
JSON::Pure::Generator methods and 5 is the Rails JSON generator. It is now a
bit faster than the generator_safe and generator_pretty methods of the pure
variant but slower than the others.

To achieve the fastest JSON document output, you can use the fast_generate
method. Beware, that this will disable the checking for circular Ruby data
structures, which may cause JSON to go into an infinite loop.

Here are the median comparisons for completeness' sake:

 Comparing times (call_time_median):
  1 GeneratorBenchmarkExt#generator_fast    1000 repeats:
        708.258020939 (  real) ->   16.547x 
          0.001411915
  2 GeneratorBenchmarkExt#generator_safe    1000 repeats:
        569.105020353 (  real) ->   13.296x 
          0.001757145
  3 GeneratorBenchmarkExt#generator_pretty  900 repeats:
        482.825371244 (  real) ->   11.280x 
          0.002071142
  4 GeneratorBenchmarkPure#generator_fast   1000 repeats:
         62.717626652 (  real) ->    1.465x 
          0.015944481
  5 GeneratorBenchmarkRails#generator       1000 repeats:
         43.965681162 (  real) ->    1.027x 
          0.022745013
  6 GeneratorBenchmarkPure#generator_safe   1000 repeats:
         43.929073409 (  real) ->    1.026x 7 (>=3859)
          0.022763968
  7 GeneratorBenchmarkPure#generator_pretty 1000 repeats:
         42.802514491 (  real) ->    1.000x 6 (>=3859)
          0.023363113
            calls/sec (  time) ->    speed  covers
            secs/call

== Author

Florian Frank <mailto:flori@ping.de>

== License

Ruby License, see the COPYING file included in the source distribution. The
Ruby License includes the GNU General Public License (GPL), Version 2, so see
the file GPL as well.

== Download

The latest version of this library can be downloaded at

* http://rubyforge.org/frs?group_id=953

Online Documentation should be located at

* http://json.rubyforge.org

= All-purpose Property List manipulation library

Plist is a library to manipulate Property List files, also known as plists.  It can parse plist files into native Ruby data structures as well as generating new plist files from your Ruby objects.

== Usage

=== Parsing

  result = Plist::parse_xml('path/to/example.plist')

  result.class
  => Hash

  "#{result['FirstName']} #{result['LastName']}"
  => "John Public"

  result['ZipPostal']
  => "12345"

==== Example Property List

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
          <key>FirstName</key>
          <string>John</string>

          <key>LastName</key>
          <string>Public</string>

          <key>StreetAddr1</key>
          <string>123 Anywhere St.</string>

          <key>StateProv</key>
          <string>CA</string>

          <key>City</key>
          <string>Some Town</string>

          <key>CountryName</key>
          <string>United States</string>

          <key>AreaCode</key>
          <string>555</string>

          <key>LocalPhoneNumber</key>
          <string>5551212</string>

          <key>ZipPostal</key>
          <string>12345</string>
  </dict>
  </plist>

=== Generation

plist also provides the ability to generate plists from Ruby objects.  The following Ruby classes are converted into native plist types:
  Array, Bignum, Date, DateTime, Fixnum, Float, Hash, Integer, String, Symbol, Time, true, false

* +Array+ and +Hash+ are both recursive; their elements will be converted into plist nodes inside the <array> and <dict> containers (respectively).
* +IO+ (and its descendants) and +StringIO+ objects are read from and their contents placed in a <data> element.
* User classes may implement +to_plist_node+ to dictate how they should be serialized; otherwise the object will be passed to <tt>Marshal.dump</tt> and the result placed in a <data> element.  See below for more details.

==== Creating a plist

There are two ways to generate complete plists.  Given an object:

  obj = [1, :two, {'c' => 0xd}]

If you've mixed in <tt>Plist::Emit</tt> (which is already done for +Array+ and +Hash+), you can simply call +to_plist+:

  obj.to_plist

This is equivalent to calling <tt>Plist::Emit.dump(obj)</tt>.  Either one will yield:

  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <array>
      <integer>1</integer>
      <string>two</string>
      <dict>
        <key>c</key>
        <integer>13</integer>
      </dict>
  </array>
  </plist>

You can also dump plist fragments by passing +false+ as the second parameter:

  Plist::Emit.dump('holy cow!', false)
  => "<string>holy cow!</string>"

==== Custom serialization

If your class can be safely coerced into a native plist datatype, you can implement +to_plist_node+.  Upon encountering an object of a class it doesn't recognize, the plist library will check to see if it responds to +to_plist_node+, and if so, insert the result of that call into the plist output.

An example:

  class MyFancyString
    ...

    def to_plist_node
      return "<string>#{self.defancify}</string>"
    end
  end

When you attempt to serialize a +MyFancyString+ object, the +to_plist_node+ method will be called and the object's contents will be defancified and placed in the plist.

If for whatever reason you can't add this method, your object will be serialized with <tt>Marshal.dump</tt> instead.

== Links

[Project Page]  http://plist.rubyforge.org
[GitHub]        http://github.com/bleything/plist
[RDoc]          http://plist.rubyforge.org

== Credits

plist is maintained by Ben Bleything <mailto:ben@bleything.net> and Patrick May <mailto:patrick@hexane.org>.  Patrick wrote most of the code; Ben is a recent addition to the project, having merged in his plist generation library.

Other folks who have helped along the way:

[<b>Martin Dittus</b>] who pointed out that +Time+ wasn't enough for plist <tt>Dates</tt>, especially those in <tt>~/Library/Cookies/Cookies.plist</tt>
[<b>Chuck Remes</b>] who pushed Patrick towards implementing <tt>#to_plist</tt>
[<b>Mat Schaffer</b>] who supplied code and test cases for <tt><data></tt> elements
[<b>Michael Granger</b>] for encouragement and help
[<b>Carsten Bormann, Chris Hoffman, Dana Contreras, Hongli Lai, Johan Srensen</b>] for contributing Ruby 1.9.x compatibility fixes

== License and Copyright

plist is released under the MIT License.

Portions of the code (notably the Rakefile) contain code pulled and/or adapted from other projects.  These files contain a comment at the top describing what was used.

=== MIT License

Copyright (c) 2006-2010, Ben Bleything <ben@bleything.net> and Patrick May <patrick@hexane.org>

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY
KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


= SQLite3/Ruby Interface

* http://github.com/luislavena/sqlite3-ruby
* http://groups.google.com/group/sqlite3-ruby

== DESCRIPTION

This module allows Ruby programs to interface with the SQLite3
database engine (http://www.sqlite.org).  You must have the
SQLite engine installed in order to build this module.

Note that this module is only compatible with SQLite 3.6.16 or newer.

== SYNOPSIS

  require "sqlite3"
  
  # Open a database
  db = SQLite3::Database.new "test.db"
  
  # Create a database
  rows = db.execute <<-SQL
    create table numbers (
      name varchar(30),
      val int
    );
  SQL
  
  # Execute a few inserts
  {
    "one" => 1,
    "two" => 2,
  }.each do |pair|
    db.execute "insert into numbers values ( ?, ? )", pair
  end
  
  # Find a few rows
  db.execute( "select * from numbers" ) do |row|
    p row
  end


== Compilation and Installation

Install SQLite3, enabling the option SQLITE_ENABLE_COLUMN_METADATA (see
www.sqlite.org/compile.html for details).

Then do the following:

  ruby setup.rb config
  ruby setup.rb setup
  ruby setup.rb install

Alternatively, you can download and install the RubyGem package for
SQLite3/Ruby (you must have RubyGems and SQLite3 installed, first):

  gem install sqlite3

If you have sqlite3 installed in a non-standard location, you can specify the location of the include and lib files by doing:

  gem install sqlite3 -- --with-sqlite3-include=/opt/local/include \
     --with-sqlite3-lib=/opt/local/lib

= SUPPORT!!!

== OMG!  Something has gone wrong!  Where do I get help?

The best place to get help is from the
{sqlite3-ruby mailing list}[http://groups.google.com/group/sqlite3-ruby] which
can be found here:

  * http://groups.google.com/group/sqlite3-ruby

== I've found a bug!  Where do I file it?

Uh oh.  After contacting the mailing list, you've found that you've actually
discovered a bug.  You can file the bug at the
{github issues page}[http://github.com/luislavena/sqlite3-ruby/issues]
which can be found here:

  * http://github.com/luislavena/sqlite3-ruby/issues

== Usage

For help figuring out the SQLite3/Ruby interface, check out the
SYNOPSIS as well as the RDoc. It includes examples of
usage. If you have any questions that you feel should be address in the
FAQ, please send them to {the mailing list}[http://groups.google.com/group/sqlite3-ruby]

== Source Code

The source repository is accessible via git:

  git clone git://github.com/luislavena/sqlite3-ruby.git


# Say - Speak Text

An [Alfred 2](http://alfredapp.com) workflow that **uses OS X's TTS (text-to-speech) feature to speak text aloud**.  
It is especially useful if you handle **many voices**, possibly in **multiple languages** - note that OS X allows on-demand download of voices in other languages.

Aside from speaking text with the default voice, offers the following features:

* Voice selection, optionally with voice-name and target-language filtering.
* Ability to speak text in sequence with multiple voices.
* Rich, dynamic feedback (name of default voice, voice languages, demo text).
* Have selected voices speak their demo text.
* Makes Alfred redisplay with the same query for interactive experimentation.
* Make a new voice the default voice directly from Alfred.
* Option to open System Preferences to manage voices and TTS options.
* Option to use a hotkey to speak the selected text in any application using the default voice (while OS X has such a feature built in, using Alfred is preferable in that it also works with non-native applications).

## Dependencies

* [Alfred 2](http://alfredapp.com) with the [Powerpack add-on](http://www.alfredapp.com/powerpack) - GPB 15 as of spring 2013.
* Developed and tested on `OS X 10.8.3`; *possibly* works on 10.7 and 10.6, too.

## Usage

Note: The workflow uses the set of **active** voices, as defined in `System Preferences`. Active voices are those selected for active use, and are typically a *subset* of the *installed* voices.
Thus, if you want to make an installed voice available to the workflow, make sure it is checked when you go to `System Preferences > Dictation & Speech`, anchor `Text to Speech`, list `System voice:`, and select list item `Customize...`.

*Omitting text always speaks the demo text for each voice.*

The workflow uses a single keyword, **`say`**:

### Speak text with the default voice

Simply specify the text to speak; e.g.

      say I speak, therefore I am.

* To speed things up, no voices are offered by default; type `@` or `#` before or after the text to speak to show the list of active voices (see below).
* Using single and double quotes, even unbalanced, is supported.
* After submitting a command, Alfred redisplays with the same query to facilitate experimentation.

### Speak text with voice selection / filtering

* Type `@` or `#` **before or after** the text to speak to see the list of active voices.
* Type `@{voiceNameOrPrefix}` to filter the list of active voices by name; e.g.:  
  `@alex`  
  Optionally, you can append the name directly to the keyword (no space); e.g.:  
  `sayAlex`  
  Matching is case-sensitive; omit spaces for voice names with embedded spaces.
* Type `#{langIdOrPrefix}` to filter the list of active voices by language ID; e.g.:  
  `#en`  
  If you just type `#`, you'll see the language identifier of each voice in parentheses.  
  Matching is case-sensitive; you can omit the `_` character, e.g., `enus` to match `en_US`.
* You can even use *multiple*, `,`-separated specifiers; e.g.:  
  `@alex,tom`

You only need to type as much of a name or language as is necessary to filter the list down to the desired result.
You can also auto-complete based on the selected result, but this only works for single-token specifiers.

**Whenever more than one voice matches**, the first result item offers to speak the specified (or demo) with **all matching voices**, in sequence.

### Examples:

    say @                                 # Show list of active voices on typing @; submit to speak demo text in all voices.
    say @alex I'm Alex                    # Speak "I'm Alex" with voice Alex.
    sayalex I'm Alex.                     # ditto
    say I'm Alex @alex                    # ditto
    say First Alex, then Jill @alex,jill  # Speak first as Alex, then as Jill.
    say y ahora en espaol #es            # Speak text with Spanish voice(s).
    say Pottery #enie,enza                # Speak text with Irish and South African voices.

### Make a voice the default voice

Whenever a specific voice is selected in the result list, **simply hold down `Option` while pressing `Return` to make that voice the default voice**.  
A notification will indicate success.

## Configuration

Typing just **`say`**, with no arguments, shows an additional command:

### `Manage Voices`

Opens the `System Preferences` application's `Dictation & Speech` pane where the set of active voices - including on-demand download of additional voices - and other TTS options can be managed.

## Bonus Track: CLI `voice`

The workflow folder contains a command-line utility named `voice`, which can be used stand-alone to provide much of the functionality the workflow offers, notably the ability to change the default voice and to speak text using multiple voices.  
Invoke it with `-h` for help.

## Installation

Download the `Say - Speak Text.alfredworkflow` file and open it (make sure that no dialog is open in Alfred's Preferences).

## Author

Michael Klement (<mklement0+gh@gmail.com>)

## License

MIT

## Changelog

* `0.1` (20 May 2013): initial release 
alfred-python
=============

Pythonic and lightweight access to the Alfred workflow API. If you need inspiration of how to use it, look at the following lines:

```python
import alfred

>>> import alfred
>>> print alfred.bundleid
nikipore.alfredpython
>>> print alfred.preferences['description']
Python library for Alfred workflow API
>>> alfred.bundleid
'nikipore.alfredpython'
>>> alfred.preferences['description'] # access to info.plist
'Python library for Alfred workflow API'
>>> alfred.work(volatile=True) # access to (and creation of) the recommended storage paths
'/Users/jan/Library/Caches/com.runningwithcrayons.Alfred-2/Workflow Data/nikipore.alfredpython'
>>> alfred.work(volatile=False)
'/Users/jan/Library/Application Support/Alfred 2/Workflow Data/nikipore.alfredpython'
>>> alfred.config()
'config'
>>> item = alfred.Item({'uid': 1, 'arg': 'some arg'}, 'some title', 'some subtitle')
>>> str(item)
'<item arg="some arg" uid="1"><title>some title</title><subtitle>some subtitle</subtitle></item>'
>>> item = alfred.Item({'uid': alfred.uid(1), 'arg': 'some arg', 'valid': 'no'}, 'some title', 'some subtitle', ('someicon.png', {'type': 'filetype'}))
>>> str(item)
'<item arg="some arg" uid="nikipore.alfredpython-1" valid="no"><title>some title</title><subtitle>some subtitle</subtitle><icon type="filetype">someicon.png</icon></item>'
```

The boilerplate for your Alfred workflow is reduced to something like this:

```python
# -*- coding: utf-8 -*-
(parameter, query) = alfred.args() # proper decoding and unescaping of command line arguments
results = [item(
    attributes= {'uid': alfred.uid(0), 'arg': u'https://www.google.de/q=%s' % query},
    title=parameter,
    subtitle=u'simple access to the Alfred workflow API'
)] # a single Alfred result
xml = alfred.xml(results) # compiles the XML answer
alfred.write(xml) # writes the XML back to Alfred
```

You are also invited to look at the workflows implemented with alfred-python:

* [Access to Firefox Bookmarks and User Input History](https://github.com/nikipore/alfred-firefoxbookmarks)
* [File Action Add to Archive](https://github.com/nikipore/alfred-fileaction-zip)
* [Call with Telephone App](https://github.com/nikipore/alfred-voipcall)

Please feel free to contribute more workflows implemented with alfred-python here, or add functionality to/fix bugs on alfred-python.

# StackOverflow Favorites Alfred Workflow

An easy way to filter through all your favorited questions on StackOverflow.

![Workflow GIF](http://f.cl.ly/items/0y2z37370U211r041P1F/sof.gif)

[Download the latest release](https://github.com/asimpson/stackoverflow-favorites-alfred-workflow/releases) to get started.

## Set StackOverflow ID

Get your ID by visiting [stackoverflow.com](http://stackoverflow.com/) and clicking on your profile. Once on your profile page, pull the 7 digit number out of the URL, this is your ID. e.g. `http://stackoverflow.com/users/xxxxxxx/username`
### Alfred App v2 workflow to retrieve stock quote

### 


Alfred 2 Workflow1.xMac OS X 10.8.3

 [](https://dl.dropboxusercontent.com/s/x9x4e5ipcnxdml9/switch-location-last.alfredworkflow)
<!-- [](http://www.guoyukun.cn/alfred-workflow)  -->

* locloc
 ![](http://www.guoyukun.cn/alfred-workflow/images/switch_list.png)

* 
 
* 
 ![](http://www.guoyukun.cn/alfred-workflow/images/notify.png)



Viscosity Workflow for Alfred
=============================

This is a workflow for [Alfred](http://www.alfredapp.com/) that
works with [Viscosity](http://www.sparklabs.com/viscosity/) to control
OpenVPN connections.

The configured keyword is `vpn`. That will show all of your configured
networks initially, and autocompletes (case-insensitively) on the
argument if one is provided.

The subtitle tells you if actioning the selection will connect or
disconnect from that network.

There are Connect All/Disconnect All operations that will act on
all VPN endpoints you've defined.

![Screenshot](viscosity.png)

Here's one way to import this workflow into Alfred:

    cd ~/Library/Application\ Support/Alfred\ 2/Alfred.alfredpreferences/workflows
    curl https://nodeload.github.com/andrewschleifer/viscosity-alfredworkflow/zip/master > \
        viscosity-alfredworkflow.zip
    unzip viscosity-alfredworkflow.zip
    rm viscosity-alfredworkflow.zip


xunlei-lixian
=============


### 


Quick start
-----------

	python lixian_cli.py login "Your Xunlei account" "Your password"
	python lixian_cli.py login "Your password"
	python lixian_cli.py login

	python lixian_cli.py config username "Your Xunlei account"
	python lixian_cli.py config password "Your password"

	python lixian_cli.py list
	python lixian_cli.py list --completed
	python lixian_cli.py list --completed --name --original-url --download-url --no-status --no-id
	python lixian_cli.py list id1 id2
	python lixian_cli.py list zip rar
	python lixian_cli.py list 2012.04.04 2012.04.05

	python lixian_cli.py download task-id
	python lixian_cli.py download ed2k-url
	python lixian_cli.py download --tool wget ed2k-url
	python lixian_cli.py download --tool asyn ed2k-url
	python lixian_cli.py download ed2k-url --output "file to save"
	python lixian_cli.py download id1 id2 id3
	python lixian_cli.py download url1 url2 url3
	python lixian_cli.py download --input download-urls-file
	python lixian_cli.py download --input download-urls-file --delete
	python lixian_cli.py download --input download-urls-file --ouput-dir root-dir-to-save-files
	python lixian_cli.py download bt://torrent-info-hash
	python lixian_cli.py download --bt 1.torrent
	python lixian_cli.py download --bt torrent-info-hash
	python lixian_cli.py download --bt http://xxx/xxx.torrent
	python lixian_cli.py download bt-task-id/file-id
	python lixian_cli.py download --all
	python lixian_cli.py download mkv
	python lixian_cli.py download 2012.04.04
	python lixian_cli.py download #0 #1 #2
	python lixian_cli.py download #0-2

	python lixian_cli.py add url
	python lixian_cli.py add --bt 1.torrent
	python lixian_cli.py add --bt torrent-info-hash
	python lixian_cli.py add --bt http://xxx/xxx.torrent

	python lixian_cli.py delete task-id
	python lixian_cli.py delete url
	python lixian_cli.py delete file-name-on-cloud-to-delete

	python lixian_cli.py pause id

	python lixian_cli.py restart id

	python lixian_cli.py rename id name

	python lixian_cli.py logout


--------

1. gitgithubDownload and Install Git

      http://help.github.com/set-up-git-redirect

2. Windowsgit-bash

        git clone git://github.com/iambus/xunlei-lixian.git

3. Python 2.x2.73.x

      http://www.python.org/getit/

4. 

        python lixian_cli.py

gitgithub"Download as zip""Download as tar.gz"

https://github.com/iambus/xunlei-lixian/downloads



--------

1. python lixian_cli.pylx

      Linux

        ln -s lixian_cli.py ~/bin/lx

      Windowslx.batPATH

        @echo off
        python lixian_cli.py %*

      lxpython lixian_cli.py

2. lx config

        lx config delete
        lx config tool asyn
        lx config username your-id
        lx config password your-password

      hash

3. lx downloadhashed2kbthashhttphash

      btbthash

4. hash

        lx download --no-hash ...

      lx config

        lx config no-hash

5. lixian_hash.pyhash



--------

lxpython lixian_cli.py



* lx login
* lx download
* lx list
* lx add
* lx delete
* lx pause
* lx restart
* lx rename
* lx config
* lx info
* lx help

### lx login
session~/.xunlei.lixian.cookieslx logoutcookiessessionsessionloginlx config password[lx config](#lx-config)

lx login

    lx login username password
    lx login password



    lx login

-

    lx login username -



--cookiessession-login

    lx login username password --cookies some-path
    lx login username password --cookies -

lx loginlxlx download--username--password--cookiessession

### lx download
httped2kbtthunder/flashget/qqbt3hash3

    lx download id
    lx download #n
    lx download http://somewhere
    lx download ed2k://somefile
    lx download bt://info-hash
    lx download link1 link2 link3 ...
    lx download --all
    lx download keywords
    lx download date

bt--bt--torrent.torrent.torrenthttp urltorrentinfo hashinfo hashbtlx download[](#)lixian_hash.py --info-hashbtinfo hash

    lx download --bt Community.S03E01.720p.HDTV.X264-DIMENSION.torrent
    lx download --bt http://tvu.org.ru/torrent.php?tid=64757
    lx download --bt 61AAA3C6FBB8B71EBE2F5A2A3481296B51D882F6
    lx download --bt bt://61AAA3C6FBB8B71EBE2F5A2A3481296B51D882F6

--btlx downloadbt://bt

--input

    lx download --input links.txt

--continuehash--input--mini-hash

--mini-hashhash

--no-hashhashhash

--delete

    lx download link --delete

--continue--overwrite

--toolwgetwgetcookie--tool asyn

    lx download --tool=wget link
    lx download --tool=asyn link

--output--output-dir



idlx listid

    lx download task-id

idurl

id0lx list -nlx listlx config n

    lx download #0



    lx download #0-2

#Shell#lx download 0lx download "#0"

bttask idid

    lx download bt-task-id/file-id bt-task-id/file-id2



    lx download bt-task-id/[1,3,5-7]

btid13567

bt

    lx download bt-task-id/.mkv



    lx download bt-task-id/[.mkv,.mp4]

--allid--all

    lx download --all



    lx download mkv



    lx download mkv mp4



    lx download 2012.04.04
    lx download 2012.04.04 2012.04.05

### lx list
id--original-url--download-url--completed

    lx list
    lx list --completed
    lx list --no-status --original-url --download-url

btid/

    lx list id/

lx help list

### lx add
lx download

    lx add url1 url2 url3
    lx add --input links.txt
    lx add --bt torrent-file
    lx add --bt torrent-url
    lx add --bt info-hash

### lx delete


    lx delete id1 id2
    lx delete ed2k://...
    lx delete mkv
    lx delete --all mkv
    lx delete --all mkv mp4

### lx pause


    lx pause id1 id2
    lx pause --all mkv

### lx restart


    lx restart id1 id2
    lx restart --all mkv

### lx rename


	lx rename task-id task-name

### lx logout
sessionlx logout

     lx logout
     lx logout --cookies your-cookies-file

### lx config

~/.xunlei.lixian.config

* username
* password
* tool
* continue
* delete
* output-dir
* hash
* mini-hash
* n
* format-size
* wget-opts
* aria2-opts
* axel-opts

openissue



    lx config

--print

	lx config --print password



    lx config username your-username
    lx config password your-password
    lx config delete
    lx config no-delete



    lx config --delete password

hash
lx config passwordlx config password -password

wget-opts/aria2-opts/axel-opts---

    lx config -- aria2-opts "-s10 -x10 -c"

### lx info
cookiesidIDIDgdriveid

gdriveidgdriveidcookielx list --download-urllx infogdriveidwget "--header=Cookie: gdriveid=your-gdriveid" download-url

### lx help


    lx help
    lx help examples
    lx help readme
    lx help download


--------------

* wgetLinuxminiwget
* asyn--tool asynCPURT-N16250K/sCPU10%~20%
* urllib2
* curl
* aria2aria2clx configlx config -- aria2-opts --event-poll=select
* axel: axelURL255bugissue #44.
* ProZillaissue



--------

* lixian_hash.pyhash

        python lixian_hash.py --ed2k filename
        python lixian_hash.py --info-hash torrent-file
        python lixian_hash.py --verify-sha1 filename sha1
        python lixian_hash.py --verify-bt filename torrent-file

* lixian_batch.py--input

        python lixian_batch.py folder1/links.txt folder2/links.txt ...


--------

1. --tool=asyn
2. idurllx download id urllx download mkvlx download mkv mp4
3. 
4. btbtbt


----




--------

RT-N16NTFSissue #18.


--------

xunlei-lixianMIT


--------------


xunlei-lixian
=============


### 


Quick start
-----------

	python lixian_cli.py login "Your Xunlei account" "Your password"
	python lixian_cli.py login "Your password"
	python lixian_cli.py login

	python lixian_cli.py config username "Your Xunlei account"
	python lixian_cli.py config password "Your password"

	python lixian_cli.py list
	python lixian_cli.py list --completed
	python lixian_cli.py list --completed --name --original-url --download-url --no-status --no-id
	python lixian_cli.py list --deleted
	python lixian_cli.py list --expired
	python lixian_cli.py list id1 id2
	python lixian_cli.py list zip rar
	python lixian_cli.py list 2012.04.04 2012.04.05

	python lixian_cli.py download task-id
	python lixian_cli.py download ed2k-url
	python lixian_cli.py download --tool=wget ed2k-url
	python lixian_cli.py download --tool=asyn ed2k-url
	python lixian_cli.py download ed2k-url --output "file to save"
	python lixian_cli.py download id1 id2 id3
	python lixian_cli.py download url1 url2 url3
	python lixian_cli.py download --input download-urls-file
	python lixian_cli.py download --input download-urls-file --delete
	python lixian_cli.py download --input download-urls-file --output-dir root-dir-to-save-files
	python lixian_cli.py download bt://torrent-info-hash
	python lixian_cli.py download 1.torrent
	python lixian_cli.py download torrent-info-hash
	python lixian_cli.py download --bt http://xxx/xxx.torrent
	python lixian_cli.py download bt-task-id/file-id
	python lixian_cli.py download --all
	python lixian_cli.py download mkv
	python lixian_cli.py download 2012.04.04
	python lixian_cli.py download 0 1 2
	python lixian_cli.py download 0-2

	python lixian_cli.py add url
	python lixian_cli.py add 1.torrent
	python lixian_cli.py add torrent-info-hash
	python lixian_cli.py add --bt http://xxx/xxx.torrent

	python lixian_cli.py delete task-id
	python lixian_cli.py delete url
	python lixian_cli.py delete file-name-on-cloud-to-delete

	python lixian_cli.py pause id

	python lixian_cli.py restart id

	python lixian_cli.py rename id name

	python lixian_cli.py logout


--------

1. gitgithubDownload and Install Git

      http://help.github.com/set-up-git-redirect

2. Windowsgit-bash

        git clone git://github.com/iambus/xunlei-lixian.git

3. Python 2.x2.7Python 3.x

      http://www.python.org/getit/

4. 

        python lixian_cli.py

gitgithub"Download as zip""Download as tar.gz"

https://github.com/iambus/xunlei-lixian/downloads



--------

1. python lixian_cli.pylx

      Linux

        ln -s lixian_cli.py ~/bin/lx

      Windowslx.batPATH

        @echo off
        python lixian_cli.py %*

      lxpython lixian_cli.py

2. lx config

        lx config delete
        lx config tool asyn
        lx config username your-id
        lx config password your-password

      hash

3. lx dlx downloadlx alx addlx llx listlx xlx listplugin apialias

4. lx downloadhashed2kbthashhttp

      btbthash

5. hash

        lx download --no-hash ...

      lx config

        lx config no-hash

6. lx hashhash



--------

lxpython lixian_cli.py



* lx login
* lx download
* lx list
* lx add
* lx delete
* lx pause
* lx restart
* lx rename
* lx readd
* lx config
* lx info
* lx help

### lx login
session~/.xunlei.lixian.cookieslx logoutcookiessessionsessionloginlx config password[lx config](#lx-config)

lx login

    lx login username password
    lx login password



    lx login

-

    lx login username -



--cookiessession-login

    lx login username password --cookies some-path
    lx login username password --cookies -

lx loginlxlx download--username--password--cookiessession

### lx download
httped2kbtthunder/flashget/qqbt3hash3

    lx download id
    lx download http://somewhere
    lx download ed2k://somefile
    lx download bt://info-hash
    lx download link1 link2 link3 ...
    lx download --all
    lx download keywords
    lx download date

bt.torrenttorrentinfo hashinfo hashbtlx download[](#)lx hash --info-hashbtinfo hash

    lx download Community.S03E01.720p.HDTV.X264-DIMENSION.torrent
    lx download 61AAA3C6FBB8B71EBE2F5A2A3481296B51D882F6
    lx download bt://61AAA3C6FBB8B71EBE2F5A2A3481296B51D882F6

url--btlx

    lx download --bt http://tvu.org.ru/torrent.php?tid=64757

--input

    lx download --input links.txt

--continuehash--input--mini-hash

--mini-hashhash

--no-hashhashhash

--delete

    lx download link --delete

--continue--overwrite

--toolwgetwgetcookie--tool=asyn

    lx download --tool=wget link
    lx download --tool=asyn link

--output--output-dir



idlx listid

    lx download task-id

idurl

id0lx list -nlx listlx config n

    lx download 0



    lx download 0-2

bttask idid

    lx download bt-task-id/file-id bt-task-id/file-id2



    lx download bt-task-id/[1,3,5-7]

btid13567

bt

    lx download bt-task-id/.mkv



    lx download bt-task-id/[.mkv,.mp4]

TODO

--allid--all

    lx download --all



    lx download mkv



    lx download mkv mp4



    lx download 2012.04.04
    lx download 2012.04.04 2012.04.05

### lx list
id--original-url--download-url--completed

    lx list
    lx list --completed
    lx list --no-status --original-url --download-url

btid/

    lx list id/

--deleted--expired

lx help list

### lx add


    lx add url1 url2 url3
    lx add --input links.txt
    lx add --bt torrent-file
    lx add --bt torrent-url
    lx add --bt info-hash

lx downloadlx add

### lx delete


    lx delete id1 id2
    lx delete ed2k://...
    lx delete mkv
    lx delete --all mkv
    lx delete --all mkv mp4

### lx pause


    lx pause id1 id2
    lx pause --all mkv

### lx restart


    lx restart id1 id2
    lx restart --all mkv

### lx rename


	lx rename task-id task-name

### lx logout
sessionlx logout

     lx logout
     lx logout --cookies your-cookies-file

### lx readd


    lx readd --deleted task-id
    lx readd --expired task-name

lx list --deletedlx list --expired

### lx config
~/.xunlei.lixian.config

* username
* password
* tool
* continue
* delete
* output-dir
* hash
* mini-hash
* id
* n
* size
* format-size
* colors
* wget-opts
* aria2-opts
* axel-opts
* watch-interval
* log-level
* log-path

openissue



    lx config

--print

	lx config --print password



    lx config username your-username
    lx config password your-password
    lx config delete
    lx config no-delete



    lx config --delete password

hash
lx config passwordlx config password -password

wget-opts/aria2-opts/axel-opts---

    lx config -- aria2-opts "-s10 -x10 -c"

### lx info
cookiesidIDIDgdriveid

gdriveidgdriveidcookielx list --download-urllx infogdriveidwget "--header=Cookie: gdriveid=your-gdriveid" download-url

-iID

    lx info -i

id

    lx info -i | clip

### lx help


    lx help
    lx help examples
    lx help readme
    lx help download


--------------

* wgetLinuxminiwget
* asyn--tool=asynCPURT-N16250K/sCPU10%~20%
* urllib2
* curl
* aria2aria2clx configlx config -- aria2-opts --event-poll=select
* axel: axelURL255bugissue #44.
* ProZillaissue



--------

* lx hashhash

        lx hash --ed2k filename
        lx hash --info-hash torrent-file
        lx hash --verify-sha1 filename sha1
        lx hash --verify-bt filename torrent-file

* lixian_batch.py--input

        python lixian_batch.py folder1/links.txt folder2/links.txt ...


--------

1. --tool=asyn
2. 
3. btbtbt
4. 


----




--------

RT-N16NTFSissue #18.


--------

xunlei-lixianMIT


--------------


